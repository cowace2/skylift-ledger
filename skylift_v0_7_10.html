<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Skylift Ledger v0.7.10</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --panel-hover: #1c2129;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #7d8590;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --radius: 6px;
      --radius-lg: 10px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    .currency, .mono {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95em;
    }
    
    header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Company Banner */
    .company-banner {
      background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 50%, #1a365d 100%);
      border-bottom: 1px solid var(--accent);
      padding: 8px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }
    
    .company-banner-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .company-banner-icon {
      font-size: 18px;
    }
    
    .company-banner-tagline {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }
    
    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    
    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(-100px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo svg {
      width: 32px;
      height: 32px;
      fill: var(--accent);
    }
    
    .logo h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-info {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .game-menu {
      position: relative;
    }
    
    .game-menu-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text);
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .game-menu-btn svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }
    
    .game-menu-btn:hover {
      border-color: var(--accent);
      background: var(--panel-hover);
    }
    
    /* Game Menu Modal */
    .game-menu-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .game-menu-modal.open {
      display: flex;
    }
    
    /* Generic Modal Overlay (for dynamically created modals) */
    .modal-overlay {
      display: flex;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .modal-dialog {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .modal-header h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--text);
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .game-menu-dialog {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .game-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .game-menu-header h2 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .game-menu-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
      line-height: 1;
    }
    
    .game-menu-close:hover {
      color: var(--text);
    }
    
    .game-menu-body {
      padding: 12px;
    }
    
    .game-menu-section {
      margin-bottom: 8px;
    }
    
    .game-menu-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px 4px;
    }
    
    .game-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .game-menu-item:hover {
      background: var(--panel-hover);
    }
    
    .game-menu-item.danger {
      color: var(--danger);
    }
    
    .game-menu-item svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
      opacity: 0.7;
    }
    
    .pill {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .pill strong { font-weight: 600; }
    
    .time-controls {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .time-controls-label {
      font-size: 13px;
      color: var(--muted);
      margin-right: 8px;
    }
    
    .time-btn {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .time-btn:hover { border-color: var(--accent); }
    .time-btn.danger { border-color: var(--danger); color: var(--danger); }
    
    nav {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
    }
    
    nav button {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    nav button:hover { border-color: var(--accent); }
    nav button.active { border-color: var(--accent); background: rgba(96, 165, 250, 0.1); }
    
    .nav-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .nav-dropdown-btn {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .nav-dropdown-btn:hover {
      border-color: var(--accent);
    }
    
    .nav-dropdown-content {
      display: none;
      position: absolute;
      background: var(--panel);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      min-width: 160px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      left: 0;
    }
    
    .nav-dropdown:last-child .nav-dropdown-content {
      left: auto;
      right: 0;
    }
    
    .nav-dropdown:hover .nav-dropdown-content {
      display: block;
    }
    
    .nav-dropdown-content button {
      display: block;
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
    }
    
    .nav-dropdown-content button:hover {
      background: rgba(96, 165, 250, 0.1);
    }
    
    main {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 2px 1fr;
      gap: 20px;
      align-items: start;
    }
    
    .left-column {
      /* Flight operations: Inbox, Calendar, Pre-Flight, Post-Flight */
    }
    
    .divider {
      background: var(--border);
      height: 100%;
      min-height: 400px;
    }
    
    .right-column {
      display: flex;
      gap: 0;
    }
    
    .right-sidebar {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px;
      background: var(--panel);
      border-radius: var(--radius-lg) 0 0 var(--radius-lg);
      border: 1px solid var(--border);
      border-right: none;
    }
    
    .right-sidebar-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 14px 10px;
      background: transparent;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      color: var(--muted);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.3px;
      transition: all 0.15s;
      min-width: 68px;
    }
    
    .right-sidebar-tab svg {
      width: 26px;
      height: 26px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }
    
    .right-sidebar-tab:hover {
      color: var(--text);
      background: var(--panel-hover);
    }
    
    .right-sidebar-tab.active {
      color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }
    
    .right-content {
      flex: 1;
      background: var(--panel);
      border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
      border: 1px solid var(--border);
      border-left: none;
      padding: 20px;
      min-height: 500px;
    }
    
    .right-tabs {
      display: none; /* Old horizontal tabs - hidden */
    }
    
    .right-tab {
      display: none; /* Old horizontal tabs - hidden */
    }
    
    .right-tab-content {
      display: none;
    }
    
    .right-tab-content.active {
      display: block;
    }
    
    .right-subtabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      padding: 4px;
      background: var(--bg);
      border-radius: 8px;
    }
    
    .right-subtab {
      flex: 1;
      background: transparent;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .right-subtab:hover {
      color: var(--text);
      background: rgba(88, 166, 255, 0.1);
    }
    
    .right-subtab.active {
      color: var(--bg);
      background: var(--accent);
    }
    
    .right-subtab-content {
      display: none;
    }
    
    .right-subtab-content.active {
      display: block;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .panel h2 {
      font-size: 18px;
      margin-bottom: 16px;
    }
    
    .btn {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover { 
      border-color: var(--accent);
      background: var(--panel-hover);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn.primary {
      background: linear-gradient(180deg, var(--accent) 0%, #4090e0 100%);
      color: #fff;
      border-color: transparent;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }
    
    .btn.primary:hover { 
      background: linear-gradient(180deg, var(--accent-hover) 0%, var(--accent) 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(88, 166, 255, 0.3);
    }
    
    .settings-section-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }
    
    #loadingScreen.hidden { display: none; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--muted);
    }
    
    .loading-content {
      max-width: 600px;
      text-align: center;
    }

    .file-picker-box {
      background: var(--panel);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      margin: 20px 0;
      text-align: center;
    }

    .file-picker-box h3 {
      margin-bottom: 12px;
      color: var(--accent);
    }

    .file-picker-box p {
      margin-bottom: 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .file-input-label {
      display: inline-block;
      background: var(--accent);
      color: var(--bg);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .file-input-label:hover {
      opacity: 0.9;
    }

    input[type="file"] {
      display: none;
    }

    .file-status {
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .file-status.success {
      color: var(--success);
    }

    /* Fleet & Pilot Management */
    .aircraft-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .aircraft-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .aircraft-card h3 {
      font-size: 16px;
      margin-bottom: 12px;
    }

    .aircraft-specs {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
    }

    .aircraft-specs div {
      margin-bottom: 4px;
    }

    .checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      cursor: pointer;
      font-size: 14px;
    }

    /* Contract List */
    .contract-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .contract-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .contract-item:hover {
      border-color: var(--accent);
    }

    .contract-item.selected {
      border-color: var(--accent);
      background: rgba(96, 165, 250, 0.05);
    }

    .contract-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .contract-title {
      font-size: 15px;
      font-weight: 600;
    }

    .contract-pay {
      font-size: 16px;
      color: var(--success);
      font-weight: 600;
    }

    .contract-details {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      background: var(--border);
      color: var(--text);
      margin-right: 6px;
    }

    .tag.owned { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .tag.contract { background: rgba(96, 165, 250, 0.2); color: var(--accent); }

    /* Email Inbox Styles */
    .email-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .email-item {
      background: var(--bg);
      padding: 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }
    
    .email-item:hover {
      background: var(--panel);
      border-left-color: var(--accent);
    }
    
    .email-item.unread {
      background: rgba(96, 165, 250, 0.05);
      font-weight: 600;
    }
    
    .email-item.selected {
      background: var(--panel);
      border-left-color: var(--accent);
    }
    
    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    
    .email-from {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    
    .email-time {
      font-size: 12px;
      color: var(--muted);
    }
    
    .email-subject {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .email-preview {
      font-size: 12px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .email-actions {
      display: flex;
      gap: 4px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .email-action-btn {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.15s;
    }
    
    .email-action-btn:hover {
      background: var(--panel-hover);
    }
    
    .email-action-btn.archive:hover {
      color: var(--accent);
    }
    
    .email-action-btn.delete {
      color: var(--danger);
    }
    
    .email-action-btn.delete:hover {
      color: #ff6b6b;
      background: rgba(248, 81, 73, 0.15);
    }
    
    .inbox-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .inbox-tab {
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--muted);
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }
    
    .inbox-tab:hover {
      background: var(--panel-hover);
    }
    
    .inbox-tab.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    
    .inbox-tab.archive-tab {
      font-size: 11px;
      padding: 4px 8px;
      opacity: 0.7;
    }
    
    .inbox-tab.archive-tab.active {
      opacity: 1;
    }
    
    .email-detail {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0;
      margin-top: 8px;
      line-height: 1.35;
    }
    
    .email-detail-header {
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      margin-bottom: 0;
    }
    
    .email-body {
      font-size: 13px;
      color: var(--text);
      padding: 10px 12px;
      margin-bottom: 0;
    }
    
    .email-body p {
      margin: 0 0 6px 0;
    }
    
    .email-body p:last-child {
      margin-bottom: 0;
    }
    
    .bid-form {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .bid-form h3 {
      font-size: 14px;
      margin-bottom: 12px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .detail-label {
      font-size: 13px;
      color: var(--muted);
    }

    .detail-value {
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type="number"], textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    input[type="number"]:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Calendar Styles */
    .calendar-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .calendar-item.active-now {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.05);
    }

    .calendar-item.upcoming {
      border-color: var(--warning);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .calendar-time {
      font-size: 14px;
      color: var(--accent);
      font-weight: 600;
    }

    .calendar-details {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
    }
    
    /* Certificate Cards */
    .cert-card {
      background: linear-gradient(135deg, #1c2129 0%, #161b22 100%);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .cert-card.earned {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, #161b22 100%);
    }
    .cert-card.available {
      border-color: var(--success);
      border-style: dashed;
    }
    .cert-card.locked {
      opacity: 0.5;
    }
    .cert-card .cert-seal {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent), var(--success));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3);
    }
    .cert-card.locked .cert-seal {
      background: var(--border);
      box-shadow: none;
    }
    .cert-card .cert-type {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }
    .cert-card .cert-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .cert-card .cert-desc {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .cert-card .cert-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .cert-card .cert-hours {
      color: var(--muted);
    }
    .cert-card.earned .cert-hours {
      color: var(--success);
    }
    .cert-card .cert-status {
      font-weight: 600;
    }
    .cert-card .cert-status.earned { color: var(--accent); }
    .cert-card .cert-status.available { color: var(--success); }
    .cert-card .cert-status.locked { color: var(--muted); }
    
    /* Certificate Display (earned) */
    .cert-display {
      background: linear-gradient(180deg, #1c2129 0%, #161b22 100%);
      border: 3px solid var(--accent);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      position: relative;
      margin-bottom: 16px;
    }
    .cert-display::before {
      content: '';
      position: absolute;
      inset: 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      pointer-events: none;
    }
    .cert-display .cert-header {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 2px;
      margin-bottom: 4px;
    }
    .cert-display .cert-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .cert-display .cert-pilot {
      font-family: 'Georgia', serif;
      font-size: 20px;
      color: var(--text);
      margin-bottom: 12px;
    }
    .cert-display .cert-date {
      font-size: 11px;
      color: var(--muted);
    }
    .cert-display .cert-examiner {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }
    
    /* Checkride Modal */
    .checkride-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .checkride-modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
    }
    
    /* Checkride Checklist Styles */
    .checkride-checklist {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin: 16px 0;
    }
    .checkride-phase {
      background: var(--accent);
      color: var(--bg);
      padding: 8px 14px;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .checkride-section {
      padding: 8px 14px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    .checkride-item {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .checkride-item:hover {
      background: rgba(255,255,255,0.02);
    }
    .checkride-item.checked {
      background: rgba(63, 185, 80, 0.1);
    }
    .checkride-item.critical {
      border-left: 3px solid var(--danger);
    }
    .checkride-item.critical.checked {
      border-left-color: var(--success);
    }
    .checkride-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 4px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .checkride-item.checked .checkride-checkbox {
      background: var(--success);
      border-color: var(--success);
    }
    .checkride-item.checked .checkride-checkbox::after {
      content: 'âœ“';
      color: var(--bg);
      font-weight: bold;
      font-size: 12px;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      min-width: 280px;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: auto;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast.toast-success { border-left: 3px solid var(--success); }
    .toast.toast-warning { border-left: 3px solid var(--warning); }
    .toast.toast-info { border-left: 3px solid var(--accent); }
    .toast.toast-error { border-left: 3px solid var(--danger); }
    .toast-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .toast-message {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }
    
    /* Post-Flight Summary Modal */
    .flight-summary-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .flight-summary-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .flight-summary {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .flight-summary-overlay.show .flight-summary {
      transform: scale(1);
    }
    .flight-summary-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .flight-summary-header-icon {
      font-size: 28px;
    }
    .flight-summary-header-text {
      flex: 1;
    }
    .flight-summary-header-title {
      font-size: 16px;
      font-weight: 600;
    }
    .flight-summary-header-subtitle {
      font-size: 12px;
      color: var(--muted);
    }
    .flight-summary-section {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
    }
    .flight-summary-section:last-of-type {
      border-bottom: none;
    }
    .flight-summary-section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .flight-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 3px 0;
    }
    .flight-summary-row.indent {
      padding-left: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .flight-summary-row.total {
      border-top: 1px solid var(--border);
      margin-top: 6px;
      padding-top: 8px;
      font-weight: 600;
    }
    .flight-summary-row .positive { color: var(--success); }
    .flight-summary-row .negative { color: var(--danger); }
    .flight-summary-row .neutral { color: var(--muted); }
    .flight-summary-hours {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
    }
    .flight-summary-hours .arrow {
      color: var(--muted);
    }
    .flight-summary-hours .delta {
      color: var(--success);
      font-size: 11px;
    }
    .flight-summary-assessment {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius);
      margin-top: 8px;
    }
    .flight-summary-stars {
      font-size: 20px;
      letter-spacing: 2px;
    }
    .flight-summary-footer {
      padding: 16px 20px;
      display: flex;
      justify-content: center;
    }
    .flight-summary-footer .btn {
      min-width: 120px;
    }
    
    /* === STAFF SYSTEM STYLES === */
    .staff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .staff-title h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    .staff-count {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }
    .staff-actions {
      display: flex;
      gap: 8px;
    }
    .staff-payroll-summary {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .payroll-label {
      font-size: 12px;
      color: var(--muted);
    }
    .payroll-amount {
      font-size: 16px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }
    .staff-roster {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: calc(100vh - 350px);
      overflow-y: auto;
    }
    .staff-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      transition: all 0.15s;
    }
    .staff-card:hover {
      border-color: var(--accent);
    }
    .staff-card.underpaid {
      border-left: 3px solid var(--warning);
    }
    .staff-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .staff-identity {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .staff-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--panel);
      border-radius: var(--radius);
    }
    .staff-name {
      font-weight: 600;
      font-size: 14px;
    }
    .staff-age {
      font-size: 12px;
      color: var(--muted);
    }
    .staff-role-exp {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .staff-role {
      color: var(--muted);
    }
    .staff-exp-badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .staff-exp-badge.junior { background: rgba(125, 133, 144, 0.2); color: var(--muted); }
    .staff-exp-badge.mid { background: rgba(230, 237, 243, 0.1); color: var(--text); }
    .staff-exp-badge.senior { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .staff-exp-badge.expert { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .staff-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .staff-status.available { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .staff-status.working { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
    .staff-status.flying { background: rgba(88, 166, 255, 0.25); color: var(--accent); font-weight: 600; }
    .staff-status.training { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
    .staff-skill-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }
    .staff-skill-label {
      font-size: 11px;
      color: var(--muted);
      width: 35px;
    }
    .staff-skill-bar {
      flex: 1;
      height: 6px;
      background: var(--panel);
      border-radius: 3px;
      overflow: hidden;
    }
    .staff-skill-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s;
    }
    .staff-skill-value {
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      width: 25px;
      text-align: right;
    }
    .staff-salary {
      font-size: 13px;
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
    }
    .staff-details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 12px;
    }
    .staff-background {
      color: var(--muted);
      font-style: italic;
      margin-bottom: 6px;
    }
    .staff-quirk {
      color: var(--text);
      opacity: 0.8;
    }
    .staff-pilot-info, .staff-mechanic-info {
      margin-top: 8px;
      padding: 8px;
      background: var(--panel);
      border-radius: var(--radius);
      font-size: 11px;
    }
    .staff-pilot-info div, .staff-mechanic-info div {
      margin-bottom: 4px;
    }
    .staff-pilot-info div:last-child, .staff-mechanic-info div:last-child {
      margin-bottom: 0;
    }
    .staff-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .staff-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .staff-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }
    
    /* Staff Marketplace Modal */
    .staff-marketplace-grid {
      display: grid;
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 8px;
    }
    .staff-marketplace-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .staff-marketplace-filters select {
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 12px;
    }
    .marketplace-candidate {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .marketplace-candidate:hover {
      border-color: var(--accent);
    }
    .candidate-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .candidate-salary {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      color: var(--warning);
    }
    
    /* === AIRCRAFT MARKET STYLES === */
    .market-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .market-title h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    .market-count {
      font-size: 12px;
      color: var(--muted);
    }
    .market-actions {
      display: flex;
      gap: 8px;
    }
    .market-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .market-filters select {
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 12px;
      flex: 1;
      min-width: 100px;
    }
    .market-listings {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: calc(100vh - 400px);
      overflow-y: auto;
    }
    .market-listing {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .market-listing:hover {
      border-color: var(--accent);
    }
    .market-listing.expanded {
      border-color: var(--accent);
    }
    .market-listing.broker-find {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.05);
    }
    .listing-main {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .listing-icon {
      font-size: 28px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--panel);
      border-radius: var(--radius);
      flex-shrink: 0;
    }
    .listing-info {
      flex: 1;
      min-width: 0;
    }
    .listing-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .listing-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .listing-badge.new { background: var(--success); color: #000; }
    .listing-badge.hot { background: var(--danger); color: #fff; }
    .listing-badge.reduced { background: var(--warning); color: #000; }
    .listing-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .listing-specs {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .listing-price {
      text-align: right;
      flex-shrink: 0;
    }
    .listing-price-current {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 600;
      color: var(--success);
    }
    .listing-price-original {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      text-decoration: line-through;
    }
    .listing-expires {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }
    .listing-details {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      display: none;
    }
    .market-listing.expanded .listing-details {
      display: block;
    }
    .listing-full-specs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 14px;
      font-size: 11px;
    }
    .listing-spec-item {
      background: var(--panel);
      padding: 8px;
      border-radius: 4px;
    }
    .listing-spec-label {
      color: var(--muted);
      margin-bottom: 2px;
    }
    .listing-spec-value {
      font-weight: 500;
    }
    .listing-acquisition {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .acquisition-option {
      flex: 1;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s;
    }
    .acquisition-option:hover {
      border-color: var(--accent);
    }
    .acquisition-option.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }
    .acquisition-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .acquisition-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .acquisition-desc {
      font-size: 11px;
      color: var(--muted);
    }
    .acquisition-terms {
      margin-top: 12px;
      padding: 12px;
      background: var(--panel);
      border-radius: var(--radius);
      display: none;
    }
    .acquisition-terms.visible {
      display: block;
    }
    .term-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .term-btn {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .term-btn:hover {
      border-color: var(--accent);
    }
    .term-btn.selected {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    .term-details {
      font-size: 12px;
    }
    .term-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }
    .term-row:last-child {
      border-bottom: none;
    }
    .term-label {
      color: var(--muted);
    }
    .term-value {
      font-family: 'JetBrains Mono', monospace;
    }
    .term-value.highlight {
      color: var(--success);
      font-weight: 600;
    }
    .term-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 8px;
      font-style: italic;
    }
    .confirm-purchase-btn {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: var(--success);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .confirm-purchase-btn:hover {
      filter: brightness(1.1);
    }
    .confirm-purchase-btn:disabled {
      background: var(--border);
      color: var(--muted);
      cursor: not-allowed;
    }
    
    /* Loan/Lease Cards */
    .finance-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 8px;
    }
    .finance-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .finance-card-aircraft {
      font-weight: 600;
      font-size: 13px;
    }
    .finance-card-type {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--accent);
      color: #000;
    }
    .finance-card-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      font-size: 11px;
    }
    .finance-detail {
      display: flex;
      justify-content: space-between;
    }
    .finance-detail-label {
      color: var(--muted);
    }
    .finance-detail-value {
      font-family: 'JetBrains Mono', monospace;
    }
    .finance-progress {
      margin-top: 8px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .finance-progress-bar {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s;
    }
    
    /* Custom Aircraft Modal */
    .custom-aircraft-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .custom-aircraft-modal.hidden {
      display: none;
    }
    .custom-aircraft-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .custom-aircraft-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .custom-aircraft-header h3 {
      font-size: 16px;
      margin: 0;
    }
    .custom-aircraft-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .custom-aircraft-body {
      padding: 20px;
    }
    .custom-form-section {
      margin-bottom: 20px;
    }
    .custom-form-section h4 {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .custom-form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .custom-form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .custom-form-field.full-width {
      grid-column: span 2;
    }
    .custom-form-field label {
      font-size: 11px;
      color: var(--muted);
    }
    .custom-form-field input,
    .custom-form-field select {
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 13px;
    }
    .custom-form-field input:focus,
    .custom-form-field select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .custom-form-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .custom-form-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .custom-aircraft-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    
    /* Broker Modal */
    .broker-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .broker-modal.hidden {
      display: none;
    }
    .broker-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .broker-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .broker-header h3 {
      font-size: 16px;
      margin: 0;
    }
    .broker-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
    }
    .broker-body {
      padding: 20px;
    }
    .broker-info {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 16px;
      font-size: 12px;
      color: var(--muted);
    }
    .broker-aircraft-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    .broker-aircraft-option {
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s;
    }
    .broker-aircraft-option:hover {
      border-color: var(--accent);
    }
    .broker-aircraft-option.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }
    .broker-aircraft-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .broker-aircraft-cat {
      color: var(--muted);
      font-size: 10px;
    }
    .broker-aircraft-price {
      color: var(--success);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      margin-top: 4px;
    }
    .broker-fee-preview {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 16px;
    }
    .broker-fee-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 4px 0;
    }
    .broker-fee-label {
      color: var(--muted);
    }
    .broker-fee-value {
      font-family: 'JetBrains Mono', monospace;
    }
    .broker-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .broker-request-banner {
      background: rgba(88, 166, 255, 0.1);
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .broker-request-banner .broker-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .broker-request-banner .broker-aircraft {
      font-weight: 600;
    }
    .broker-request-banner .broker-eta {
      color: var(--muted);
    }
    .broker-request-banner button {
      margin-top: 8px;
    }
    
    /* === LEDGER STYLES === */
    .ledger-dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    
    .ledger-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      height: fit-content;
    }
    
    .ledger-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .ledger-card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
    }
    
    .ledger-section {
      margin-bottom: 16px;
    }
    
    .ledger-section:last-child {
      margin-bottom: 0;
    }
    
    .ledger-section-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .ledger-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(48, 54, 61, 0.5);
    }
    
    .ledger-row:last-child {
      border-bottom: none;
    }
    
    .ledger-row.total {
      font-weight: 600;
      border-top: 1px solid var(--border);
      margin-top: 4px;
      padding-top: 10px;
    }
    
    .ledger-row .label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ledger-row .value {
      font-family: 'JetBrains Mono', monospace;
    }
    
    .ledger-row .value.positive { color: var(--success); }
    .ledger-row .value.negative { color: var(--danger); }
    
    .ledger-row.restricted {
      opacity: 0.7;
    }
    
    .ledger-condition-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(63, 185, 80, 0.15);
      color: var(--success);
    }
    
    .ledger-condition-badge.warning {
      background: rgba(210, 153, 34, 0.15);
      color: var(--warning);
    }
    
    .ledger-restricted-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(125, 133, 144, 0.2);
      color: var(--muted);
    }
    
    .ledger-period-tabs {
      display: flex;
      gap: 4px;
    }
    
    .ledger-period-tab {
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .ledger-period-tab.active {
      background: var(--panel);
      color: var(--text);
      border-color: var(--accent);
    }
    
    .ledger-summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .ledger-summary-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
    }
    
    .ledger-summary-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .ledger-summary-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 600;
    }
    
    .ledger-summary-delta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    
    .ledger-summary-delta .up { color: var(--success); }
    .ledger-summary-delta .down { color: var(--danger); }
    
    /* LOC & MX Reserve Widgets */
    .ledger-widget {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .ledger-widget:last-child {
      margin-bottom: 0;
    }
    
    .ledger-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ledger-widget-title {
      font-size: 12px;
      font-weight: 500;
    }
    
    .ledger-widget-rate {
      font-size: 11px;
      color: var(--muted);
    }
    
    .ledger-widget-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .ledger-widget-bar-fill {
      height: 100%;
      border-radius: 4px;
    }
    
    .ledger-widget-bar-fill.loc {
      background: linear-gradient(90deg, var(--success), var(--warning));
    }
    
    .ledger-widget-bar-fill.mx {
      background: var(--warning);
    }
    
    .ledger-widget-details {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }
    
    .ledger-widget-details .label { color: var(--muted); }
    .ledger-widget-details .value { font-family: 'JetBrains Mono', monospace; }
    
    .ledger-widget-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .ledger-widget-actions button {
      flex: 1;
      padding: 8px 12px;
      font-size: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
    }
    
    .ledger-widget-actions button:hover {
      border-color: var(--accent);
    }
    
    .ledger-widget-actions button.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    
    .ledger-widget-actions button.primary:hover {
      filter: brightness(1.1);
    }
    
    /* Transaction List */
    .ledger-tx-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .ledger-tx-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(48, 54, 61, 0.5);
      font-size: 12px;
    }
    
    .ledger-tx-item:last-child {
      border-bottom: none;
    }
    
    .ledger-tx-info {
      flex: 1;
    }
    
    .ledger-tx-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .ledger-tx-meta {
      font-size: 11px;
      color: var(--muted);
    }
    
    .ledger-tx-amount {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      text-align: right;
    }
    
    .ledger-tx-amount.income { color: var(--success); }
    .ledger-tx-amount.expense { color: var(--danger); }
    .ledger-tx-amount.reserve { color: var(--warning); }
    
    .ledger-tx-balance {
      font-size: 10px;
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* Owner Salary Section */
    .ledger-owner-section {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    
    .ledger-owner-salary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: var(--panel);
      border-radius: var(--radius);
    }
    
    .ledger-owner-info {
      font-size: 11px;
    }
    
    .ledger-owner-amount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 500;
    }
    
    .ledger-owner-edit {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
    }
    
    .ledger-owner-edit:hover {
      text-decoration: underline;
    }
    
    /* MX Breakdown */
    .ledger-mx-breakdown {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(48, 54, 61, 0.5);
    }
    
    .ledger-mx-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      padding: 4px 0;
      color: var(--muted);
    }
    
    .ledger-mx-row .value {
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* LOC Modal */
    .loc-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .loc-modal.open {
      display: flex;
    }
    
    .loc-modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 400px;
      padding: 20px;
    }
    
    .loc-modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .loc-modal-info {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    
    .loc-modal-input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      text-align: center;
      margin-bottom: 16px;
    }
    
    .loc-modal-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .loc-modal-actions {
      display: flex;
      gap: 8px;
    }
    
    .loc-modal-actions button {
      flex: 1;
    }
    
    /* Quote Calculator Modal */
    .bid-calculator-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1001;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      overflow-y: auto;
      padding: 20px;
    }
    
    .bid-calculator-modal.open {
      display: flex;
    }
    
    .bid-calculator-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 0;
    }
    
    @media (max-width: 800px) {
      .bid-calculator-content {
        grid-template-columns: 1fr;
        max-width: 100%;
      }
    }
    
    .bid-calc-main {
      padding: 20px;
      border-right: 1px solid var(--border);
    }
    
    .bid-calc-sidebar {
      padding: 20px;
      background: var(--bg);
    }
    
    .bid-calc-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .bid-calc-route {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .bid-calc-mission-type {
      font-size: 13px;
      color: var(--muted);
    }
    
    .bid-calc-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .bid-calc-close:hover {
      color: var(--text);
    }
    
    .bid-calc-section {
      margin-bottom: 20px;
    }
    
    .bid-calc-section-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .bid-calc-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 16px;
    }
    
    .bid-calc-detail {
      text-align: center;
    }
    
    .bid-calc-detail-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 600;
    }
    
    .bid-calc-detail-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
    }
    
    /* Flight Legs */
    .bid-calc-legs {
      margin-bottom: 16px;
    }
    
    .bid-calc-leg {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(48, 54, 61, 0.5);
      font-size: 12px;
    }
    
    .bid-calc-leg:last-child {
      border-bottom: none;
    }
    
    .bid-calc-leg-type {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }
    
    .bid-calc-leg-type.positioning {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }
    
    .bid-calc-leg-type.revenue {
      background: rgba(63, 185, 80, 0.2);
      color: var(--success);
    }
    
    .bid-calc-leg-type.return {
      background: rgba(210, 153, 34, 0.2);
      color: var(--warning);
    }
    
    .bid-calc-leg-route {
      flex: 1;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .bid-calc-leg-distance {
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* Client Card */
    .bid-calc-client {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 16px;
    }
    
    .bid-calc-client-avatar {
      width: 48px;
      height: 48px;
      background: var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .bid-calc-client-info {
      flex: 1;
    }
    
    .bid-calc-client-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    
    .bid-calc-client-company {
      font-size: 12px;
      color: var(--muted);
    }
    
    .bid-calc-client-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .bid-calc-tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 3px;
      font-weight: 500;
    }
    
    .bid-calc-tag.tier-corporate {
      background: rgba(136, 87, 255, 0.2);
      color: #a78bfa;
    }
    
    .bid-calc-tag.tier-regional {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }
    
    .bid-calc-tag.tier-budget {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }
    
    .bid-calc-tag.personality {
      background: rgba(75, 85, 99, 0.2);
      color: var(--muted);
    }
    
    /* Cost Calculator */
    .bid-calc-cost-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    .bid-calc-cost-label {
      flex: 1;
      font-size: 13px;
    }
    
    .bid-calc-cost-hint {
      font-size: 11px;
      color: var(--muted);
    }
    
    .bid-calc-cost-input-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .bid-calc-cost-input {
      width: 100px;
      padding: 8px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      text-align: right;
    }
    
    .bid-calc-cost-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .bid-calc-estimate-btn {
      padding: 8px 10px;
      font-size: 11px;
      background: var(--panel-hover);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--accent);
      cursor: pointer;
      white-space: nowrap;
    }
    
    .bid-calc-estimate-btn:hover {
      background: var(--border);
    }
    
    .bid-calc-cost-total {
      padding-top: 12px;
      margin-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .bid-calc-cost-total .bid-calc-cost-label {
      font-weight: 600;
    }
    
    .bid-calc-cost-total .bid-calc-cost-input {
      font-weight: 600;
      color: var(--danger);
    }
    
    /* Market Rate */
    .bid-calc-market-rate {
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius);
      border-left: 3px solid var(--accent);
      margin-bottom: 20px;
    }
    
    .bid-calc-market-rate-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .bid-calc-market-rate-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
    }
    
    .bid-calc-market-rate-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .bid-calc-market-rate-range {
      font-size: 11px;
      color: var(--muted);
    }
    
    /* Bid Input */
    .bid-calc-bid-section {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 16px;
    }
    
    .bid-calc-bid-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
    }
    
    .bid-calc-bid-input {
      width: 100%;
      padding: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      text-align: center;
      margin-bottom: 12px;
    }
    
    .bid-calc-bid-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .bid-calc-bid-margin {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 16px;
    }
    
    .bid-calc-bid-margin-value {
      font-weight: 600;
    }
    
    .bid-calc-bid-margin-value.positive {
      color: var(--success);
    }
    
    .bid-calc-bid-margin-value.negative {
      color: var(--danger);
    }
    
    .bid-calc-actions {
      display: flex;
      gap: 12px;
    }
    
    .bid-calc-actions button {
      flex: 1;
      padding: 12px;
    }
    
    /* Sidebar Summary */
    .bid-calc-summary-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .bid-calc-summary-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .bid-calc-summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 6px;
    }
    
    .bid-calc-summary-row:last-child {
      margin-bottom: 0;
    }
    
    .bid-calc-summary-row .label {
      color: var(--muted);
    }
    
    .bid-calc-summary-row .value {
      font-weight: 500;
    }
    
    .bid-calc-summary-row.highlight {
      font-size: 13px;
      font-weight: 600;
      padding-top: 8px;
      margin-top: 8px;
      border-top: 1px solid var(--border);
    }
    
    .bid-calc-summary-row.highlight .value.positive {
      color: var(--success);
    }
    
    .bid-calc-summary-row.highlight .value.negative {
      color: var(--danger);
    }
    
    /* Acceptance Meter */
    .bid-calc-probability {
      margin-top: 16px;
    }
    
    .bid-calc-probability-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
    }
    
    .bid-calc-probability-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .bid-calc-probability-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease, background 0.3s ease;
    }
    
    .bid-calc-probability-fill.low {
      background: var(--danger);
    }
    
    .bid-calc-probability-fill.medium {
      background: var(--warning);
    }
    
    .bid-calc-probability-fill.high {
      background: var(--success);
    }
    
    .bid-calc-probability-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 6px;
      font-style: italic;
    }
    
    /* Counter Offer Box */
    .counter-offer-box {
      background: rgba(210, 153, 34, 0.1);
      border: 1px solid var(--warning);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }
    
    .counter-offer-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 12px;
    }
    
    .counter-offer-amount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }
    
    .counter-offer-message {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    
    .counter-offer-actions {
      display: flex;
      gap: 8px;
    }
    
    .counter-offer-actions button {
      flex: 1;
      padding: 10px;
    }
      padding: 10px;
      font-size: 13px;
      border-radius: var(--radius);
      cursor: pointer;
      border: none;
    }
    
    .loc-modal-actions .cancel {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .loc-modal-actions .confirm {
      background: var(--accent);
      color: #000;
      font-weight: 500;
    }
    
    /* === SCENARIO SELECT STYLES === */
    .scenario-page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .scenario-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .scenario-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .scenario-header p {
      color: var(--muted);
      font-size: 14px;
    }
    
    .scenarios-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
      justify-content: center;
    }
    
    .scenario-card {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .scenario-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .scenario-card.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.05);
    }
    
    .scenario-card.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }
    
    .scenario-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }
    
    .scenario-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .scenario-difficulty {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .scenario-difficulty.easy { color: var(--success); }
    .scenario-difficulty.medium { color: var(--warning); }
    .scenario-difficulty.hard { color: var(--danger); }
    
    .scenario-description {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .scenario-stats {
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    
    .scenario-stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 4px 0;
    }
    
    .scenario-stat-row .label {
      color: var(--muted);
    }
    
    .scenario-stat-row .value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }
    
    .scenario-stat-row .value.positive { color: var(--success); }
    .scenario-stat-row .value.negative { color: var(--danger); }
    
    .aircraft-select {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .aircraft-select-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .aircraft-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .aircraft-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .aircraft-option:hover {
      border-color: var(--muted);
    }
    
    .aircraft-option.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.1);
    }
    
    .aircraft-radio {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }
    
    .aircraft-option.selected .aircraft-radio {
      border-color: var(--accent);
    }
    
    .aircraft-option.selected .aircraft-radio::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }
    
    .aircraft-name {
      flex: 1;
    }
    
    .aircraft-condition {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--warning);
    }
    
    .aircraft-debt {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--danger);
    }
    
    .no-aircraft-note {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg);
      border-radius: 6px;
      border: 1px dashed var(--border);
      text-align: center;
    }
    
    .no-aircraft-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .no-aircraft-text {
      font-size: 12px;
      color: var(--muted);
    }
    
    .no-aircraft-text strong {
      color: var(--text);
    }
    
    .section-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 32px 0;
    }
    
    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    .section-divider span {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Custom Scenario */
    .custom-scenario-card {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
    }
    
    .custom-intro {
      border-right: 1px solid var(--border);
      padding-right: 24px;
    }
    
    .custom-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .custom-option-group {
      margin-bottom: 16px;
    }
    
    .custom-option-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .custom-slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .custom-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      outline: none;
    }
    
    .custom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .custom-slider-input {
      width: 90px;
      padding: 6px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      text-align: right;
    }
    
    .custom-slider-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Custom scenario input-only layout */
    .custom-input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 24px;
    }
    
    .custom-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .custom-input-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .custom-input {
      padding: 10px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      text-align: right;
    }
    
    .custom-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .custom-input.error {
      border-color: var(--danger);
    }
    
    .custom-assessment {
      margin-top: 20px;
      padding: 16px;
      background: var(--bg);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .custom-assessment-header {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .custom-assessment-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 4px 0;
    }
    
    .custom-assessment-row .label {
      color: var(--muted);
    }
    
    .custom-assessment-row .value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }
    
    .custom-challenge-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 12px;
    }
    
    .custom-challenge-badge.comfortable {
      background: rgba(63, 185, 80, 0.15);
      color: var(--success);
    }
    
    .custom-challenge-badge.moderate {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
    }
    
    .custom-challenge-badge.challenging {
      background: rgba(210, 153, 34, 0.15);
      color: var(--warning);
    }
    
    .custom-challenge-badge.hard {
      background: rgba(248, 81, 73, 0.15);
      color: var(--danger);
    }
    
    .custom-challenge-badge.brutal {
      background: rgba(248, 81, 73, 0.3);
      color: #ff6b6b;
    }
    
    .scenario-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    .scenario-summary {
      font-size: 13px;
      color: var(--muted);
    }
    
    .scenario-summary strong {
      color: var(--text);
    }
    
    .scenario-actions {
      display: flex;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-content">
      <div class="loading-text" id="loadingText">Initializing...</div>
      <div id="filePickerContainer"></div>
    </div>
  </div>

  <header>
    <div class="logo">
      <svg viewBox="0 0 24 24">
        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
      </svg>
      <h1>Skylift Ledger <span style="font-size: 12px; color: var(--muted);">v0.7.10</span></h1>
    </div>
    <div class="header-info">
      <div class="pill"><strong>Time:</strong> <span id="timeDisplay">--</span></div>
      
      <div class="game-menu">
        <button class="game-menu-btn" onclick="openGameMenu()">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Menu
        </button>
      </div>
    </div>
  </header>
  
  <!-- Company Banner (shown after naming company) -->
  <div id="companyBanner" class="company-banner" style="display: none;">
    <span class="company-banner-icon">âœˆï¸</span>
    <span class="company-banner-name" id="companyBannerName"></span>
    <span class="company-banner-tagline">Aviation Services</span>
  </div>
  
  <!-- Game Menu Modal -->
  <div class="game-menu-modal" id="gameMenuModal">
    <div class="game-menu-dialog">
      <div class="game-menu-header">
        <h2>Game Menu</h2>
        <button class="game-menu-close" onclick="closeGameMenu()">&times;</button>
      </div>
      <div class="game-menu-body">
        <div class="game-menu-section">
          <div class="game-menu-section-title">Game</div>
          <button class="game-menu-item" onclick="toggleGameMode(); closeGameMenu();">
            <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
            <span id="gameModeLabel">Switch to Career Mode</span>
          </button>
        </div>
        <div class="game-menu-section">
          <div class="game-menu-section-title">Data</div>
          <button class="game-menu-item" onclick="exportSaveState(); closeGameMenu();">
            <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Save Game
          </button>
          <button class="game-menu-item" onclick="document.getElementById('importSaveInput').click();">
            <svg viewBox="0 0 24 24"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
            Load Game
          </button>
          <input type="file" id="importSaveInput" accept=".json" style="display: none;" onchange="importSaveState(event)">
          <button class="game-menu-item" onclick="showAutoSaveModal(); closeGameMenu();">
            <svg viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
            Restore Auto-Save
          </button>
          <button class="game-menu-item" onclick="forceRefresh()">
            <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Force Refresh (Get Latest Version)
          </button>
        </div>
        <div class="game-menu-section">
          <div class="game-menu-section-title">Reset</div>
          <button class="game-menu-item danger" onclick="clearCacheAndReload()">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Clear Game Data &amp; Reload
          </button>
          <button class="game-menu-item danger" onclick="resetGame()">
            <svg viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Reset Game
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Quote Calculator Modal -->
  <div id="bidCalculatorModal" class="bid-calculator-modal" onclick="if(event.target === this) closeBidCalculator()">
    <div class="bid-calculator-content" id="bidCalculatorContent">
      <!-- Content populated by openBidCalculator() -->
    </div>
  </div>
  
  <!-- Checkride Modal -->
  <div id="checkrideModal" class="checkride-modal" style="display: none;" onclick="if(event.target === this) closeCheckrideModal()">
    <div class="checkride-modal-content" onclick="event.stopPropagation()">
      <div id="checkrideContent"></div>
    </div>
  </div>
  
  <!-- Training Flight Modal -->
  <div id="trainingModal" class="checkride-modal" style="display: none;" onclick="if(event.target === this) closeTrainingModal()">
    <div class="checkride-modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
      <div id="trainingContent"></div>
    </div>
  </div>
  
  <!-- Debug Panel (hidden by default - uncomment display:block to show) -->
  <div id="debugPanel" style="position: fixed; bottom: 0; left: 0; right: 0; max-height: 300px; overflow-y: auto; background: #1a1a2e; border-top: 2px solid #f00; padding: 10px; font-family: monospace; font-size: 11px; color: #0f0; z-index: 9999; display: none;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
      <strong style="color: #ff0;">DEBUG PANEL</strong>
      <button onclick="document.getElementById('debugPanel').style.display='none'" style="background: #f00; color: #fff; border: none; padding: 2px 8px; cursor: pointer;">X Close</button>
    </div>
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px;">
      <div>
        <span style="color: #888;">XP:</span>
        <button onclick="debugAdjustXP(-50)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-50</button>
        <button onclick="debugAdjustXP(-10)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-10</button>
        <span id="debugXPDisplay" style="color: #0ff; padding: 0 8px;">0</span>
        <button onclick="debugAdjustXP(10)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+10</button>
        <button onclick="debugAdjustXP(50)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+50</button>
        <span id="debugTierDisplay" style="color: #ff0; padding-left: 8px;">rookie</span>
      </div>
      <div>
        <span style="color: #888;">Reviews:</span>
        <button onclick="debugGenerateReview(1)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">1â˜…</button>
        <button onclick="debugGenerateReview(3)" style="background: #333; color: #ff0; border: none; padding: 2px 6px; cursor: pointer;">3â˜…</button>
        <button onclick="debugGenerateReview(5)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">5â˜…</button>
        <span id="debugRatingDisplay" style="color: #ff0; padding-left: 8px;">--</span>
      </div>
    </div>
    <!-- MX Debug Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px; flex-wrap: wrap;">
      <div>
        <span style="color: #888;">MX Aircraft:</span>
        <select id="debugMxAircraft" onchange="debugUpdateMxDisplay()" style="background: #333; color: #0ff; border: 1px solid #555; padding: 2px 4px;"></select>
      </div>
      <div>
        <span style="color: #888;">Insp Hrs:</span>
        <button onclick="debugAdjustMxHours('inspection', -50)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-50</button>
        <button onclick="debugAdjustMxHours('inspection', -10)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-10</button>
        <span id="debugInspHours" style="color: #0ff; padding: 0 4px;">0</span>
        <button onclick="debugAdjustMxHours('inspection', 10)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+10</button>
        <button onclick="debugAdjustMxHours('inspection', 50)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+50</button>
      </div>
      <div>
        <span style="color: #888;">TBO Hrs:</span>
        <button onclick="debugAdjustMxHours('overhaul', -500)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-500</button>
        <button onclick="debugAdjustMxHours('overhaul', -100)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-100</button>
        <span id="debugOverhaulHours" style="color: #0ff; padding: 0 4px;">0</span>
        <button onclick="debugAdjustMxHours('overhaul', 100)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+100</button>
        <button onclick="debugAdjustMxHours('overhaul', 500)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+500</button>
      </div>
      <div>
        <span style="color: #888;">Cond:</span>
        <button onclick="debugAdjustCondition(-10)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-10</button>
        <span id="debugCondition" style="color: #0ff; padding: 0 4px;">100</span>
        <button onclick="debugAdjustCondition(10)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+10</button>
      </div>
      <div>
        <button onclick="debugAddSquawk()" style="background: #553; color: #ff0; border: 1px solid #ff0; padding: 2px 8px; cursor: pointer;">+ Squawk</button>
        <button onclick="debugClearMxWarnings()" style="background: #335; color: #0ff; border: 1px solid #0ff; padding: 2px 8px; cursor: pointer;">Clear Warnings</button>
      </div>
    </div>
    <!-- Staff Debug Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px; flex-wrap: wrap;">
      <div>
        <span style="color: #888;">Staff:</span>
        <select id="debugStaffRole" style="background: #333; color: #0ff; border: 1px solid #555; padding: 2px 4px;">
          <option value="pilot">Pilot</option>
          <option value="mechanic">Mechanic</option>
          <option value="opsOfficer">Ops Officer</option>
          <option value="marketing">Marketing</option>
          <option value="accountant">Accountant</option>
        </select>
        <select id="debugStaffExp" style="background: #333; color: #0ff; border: 1px solid #555; padding: 2px 4px;">
          <option value="junior">Junior</option>
          <option value="mid">Mid</option>
          <option value="senior">Senior</option>
          <option value="expert">Expert</option>
        </select>
        <button onclick="debugAddStaff()" style="background: #353; color: #0f0; border: 1px solid #0f0; padding: 2px 8px; cursor: pointer;">+ Add</button>
      </div>
      <div>
        <button onclick="debugClearStaff()" style="background: #533; color: #f00; border: 1px solid #f00; padding: 2px 8px; cursor: pointer;">Clear All Staff</button>
        <button onclick="debugProcessPayroll()" style="background: #335; color: #0ff; border: 1px solid #0ff; padding: 2px 8px; cursor: pointer;">Process Payroll</button>
        <button onclick="debugRefreshMarketplace()" style="background: #353; color: #ff0; border: 1px solid #ff0; padding: 2px 8px; cursor: pointer;">Refresh Marketplace</button>
      </div>
      <div>
        <span style="color: #888;">Staff Count:</span>
        <span id="debugStaffCount" style="color: #0ff; padding: 0 8px;">0</span>
        <span style="color: #888;">Payroll:</span>
        <span id="debugPayroll" style="color: #ff0;">$0</span>
      </div>
    </div>
    <!-- Staff XP Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px; flex-wrap: wrap;">
      <div>
        <span style="color: #888;">Staff XP:</span>
        <select id="debugStaffXpSelect" onchange="debugUpdateStaffXpDisplay()" style="background: #333; color: #0ff; border: 1px solid #555; padding: 2px 4px; min-width: 150px;">
          <option value="">-- Select Staff --</option>
        </select>
      </div>
      <div>
        <button onclick="debugAdjustStaffXP(-500)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-500</button>
        <button onclick="debugAdjustStaffXP(-100)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-100</button>
        <span id="debugStaffXpDisplay" style="color: #ff0; padding: 0 8px;">0 XP</span>
        <button onclick="debugAdjustStaffXP(100)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+100</button>
        <button onclick="debugAdjustStaffXP(500)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+500</button>
        <button onclick="debugAdjustStaffXP(2000)" style="background: #353; color: #0f0; border: 1px solid #0f0; padding: 2px 8px; cursor: pointer;">+2000</button>
      </div>
      <div>
        <span id="debugStaffLevelDisplay" style="color: #0ff;">--</span>
      </div>
    </div>
    <!-- Pilot Flight Hours Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px; flex-wrap: wrap;">
      <div>
        <span style="color: #888;">Pilot Hours:</span>
        <select id="debugPilotHoursSelect" onchange="debugUpdatePilotHoursDisplay()" style="background: #333; color: #0ff; border: 1px solid #555; padding: 2px 4px; min-width: 150px;">
          <option value="">-- Select Pilot --</option>
        </select>
      </div>
      <div>
        <button onclick="debugAdjustPilotHours(-50)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-50</button>
        <button onclick="debugAdjustPilotHours(-10)" style="background: #333; color: #f00; border: none; padding: 2px 6px; cursor: pointer;">-10</button>
        <span id="debugPilotHoursDisplay" style="color: #ff0; padding: 0 8px;">0 hrs</span>
        <button onclick="debugAdjustPilotHours(10)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+10</button>
        <button onclick="debugAdjustPilotHours(50)" style="background: #333; color: #0f0; border: none; padding: 2px 6px; cursor: pointer;">+50</button>
        <button onclick="debugAdjustPilotHours(100)" style="background: #353; color: #0f0; border: 1px solid #0f0; padding: 2px 8px; cursor: pointer;">+100</button>
      </div>
      <div>
        <span id="debugPilotCertsDisplay" style="color: #0ff;">--</span>
      </div>
    </div>
    <!-- Squawk Prevention Test Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 4px; flex-wrap: wrap;">
      <div>
        <span style="color: #888;">Squawk Prevention:</span>
        <button onclick="debugTestSquawkPrevention()" style="background: #353; color: #ff0; border: 1px solid #ff0; padding: 2px 8px; cursor: pointer;">Test 100 Flights</button>
        <button onclick="debugForceSquawkRoll()" style="background: #335; color: #0ff; border: 1px solid #0ff; padding: 2px 8px; cursor: pointer;">Force Squawk Roll</button>
      </div>
      <div>
        <span style="color: #888;">Prevention Chance:</span>
        <span id="debugPreventionChance" style="color: #0ff; padding: 0 8px;">--</span>
      </div>
    </div>
    <div id="debugLog" style="white-space: pre-wrap;"></div>
  </div>
  
  <div class="time-controls">
    <span class="time-controls-label">Time Controls:</span>
    <button class="time-btn" onclick="advanceToNextFlight()" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">â­ Next Flight</button>
    <button class="time-btn" onclick="advanceTime(60)">+1 hour</button>
    <button class="time-btn" onclick="advanceTime(180)">+3 hours</button>
    <button class="time-btn" onclick="advanceTime(360)">+6 hours</button>
    <button class="time-btn" onclick="advanceToNextDay()">+1 day</button>
  </div>
  
  <nav>
    <button data-tab="inbox" class="active">Inbox</button>
    <button data-tab="calendar">Calendar</button>
    <button data-tab="preflight">Pre-Flight</button>
    <button data-tab="postflight">Post-Flight</button>
  </nav>
  
  <main id="mainContent">
    <div class="left-column">
      <div id="inbox" class="tab-content active">
        <div class="panel">
          <h2>Inbox</h2>
          <div id="emailsList"></div>
        </div>
      </div>
      
      <div id="calendar" class="tab-content">
        <div class="panel">
          <h2>Your Schedule</h2>
          <div id="calendarContent"></div>
        </div>
      </div>
      
      <div id="preflight" class="tab-content">
        <div class="panel">
          <h2>Pre-Flight Briefing</h2>
          <div id="preflightContent"></div>
        </div>
      </div>
      
      <div id="postflight" class="tab-content">
        <div class="panel">
          <h2>Post-Flight Report</h2>
          <div id="postflightContent"></div>
        </div>
      </div>
    </div>
    
    <div class="divider"></div>
    
    <div class="right-column">
      <!-- Vertical Icon Sidebar -->
      <div class="right-sidebar">
        <button class="right-sidebar-tab active" data-right-tab="pilot" title="Pilot">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Pilot
        </button>
        <button class="right-sidebar-tab" data-right-tab="ledger" title="Ledger">
          <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="8" y1="7" x2="16" y2="7"/><line x1="8" y1="11" x2="16" y2="11"/></svg>
          Ledger
        </button>
        <button class="right-sidebar-tab" data-right-tab="fleet" title="Fleet">
          <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Fleet
        </button>
        <button class="right-sidebar-tab" data-right-tab="company" title="Company">
          <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Company
        </button>
        <button class="right-sidebar-tab" data-right-tab="staff" title="Staff">
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Staff
        </button>
        <button class="right-sidebar-tab" data-right-tab="market" title="Market">
          <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
          Market
        </button>
      </div>
      
      <!-- Tab Content -->
      <div class="right-content">
        <!-- Pilot Tab -->
        <div id="pilot-tab" class="right-tab-content active">
          <div class="right-subtabs">
            <button class="right-subtab active" data-right-subtab="information">Info</button>
            <button class="right-subtab" data-right-subtab="certifications">Certs & Ratings</button>
            <button class="right-subtab" data-right-subtab="log">Log</button>
            <button class="right-subtab" data-right-subtab="preferences">Preferences</button>
          </div>
          
          <div id="information-subtab" class="right-subtab-content active">
            <div id="pilotInfo"></div>
          </div>
          
          <div id="certifications-subtab" class="right-subtab-content">
            <div id="certificationsList"></div>
          </div>
          
          <div id="log-subtab" class="right-subtab-content">
            <div id="pilotLog"></div>
          </div>
          
          <div id="preferences-subtab" class="right-subtab-content">
            <div id="settingsContainer">
              <!-- Settings navigation -->
              <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                <button class="btn settings-section-btn active" data-section="game" onclick="switchSettingsSection('game')" style="font-size: 11px; padding: 6px 12px;">Game</button>
                <button class="btn settings-section-btn" data-section="finances" onclick="switchSettingsSection('finances')" style="font-size: 11px; padding: 6px 12px;">Finances</button>
                <button class="btn settings-section-btn" data-section="missions" onclick="switchSettingsSection('missions')" style="font-size: 11px; padding: 6px 12px;">Missions</button>
                <button class="btn settings-section-btn" data-section="maintenance" onclick="switchSettingsSection('maintenance')" style="font-size: 11px; padding: 6px 12px;">Maintenance</button>
                <button class="btn settings-section-btn" data-section="reputation" onclick="switchSettingsSection('reputation')" style="font-size: 11px; padding: 6px 12px;">Reputation</button>
              </div>
              
              <!-- Missions Section -->
              <div id="settings-missions" class="settings-section" style="display: none;">
                <p style="color: var(--muted); margin-bottom: 16px; font-size: 13px;">Select which mission types you want to receive offers for.</p>
                <div id="missionPreferences"></div>
              </div>
              
              <!-- Finances Section -->
              <div id="settings-finances" class="settings-section" style="display: none;">
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 13px; font-weight: 500;">Fixed Price Contracts</div>
                      <div style="font-size: 11px; color: var(--muted);">Simplified mode: accept or decline at market rate, no bid negotiation</div>
                    </div>
                    <label style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                      <input type="checkbox" id="fixedPriceModeToggle" onchange="toggleFixedPriceMode(this.checked)" style="opacity: 0; width: 0; height: 0;">
                      <span id="fixedPriceModeSlider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: 0.3s; border-radius: 24px;">
                        <span id="fixedPriceModeKnob" style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                      </span>
                    </label>
                  </div>
                  <div style="font-size: 10px; color: var(--muted); margin-top: 8px;">
                    When enabled, customer inquiries show a fixed market rate instead of opening the bid calculator.
                  </div>
                </div>
                
                <!-- Financial Difficulty Sliders -->
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
                  <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Financial Difficulty</div>
                  <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
                    Adjust multipliers to make the game easier or harder. Default is 1.0Ã— for all.
                  </div>
                  <div id="financialSlidersContent">
                    <!-- Sliders rendered by renderFinancesPreferences() -->
                  </div>
                </div>
              </div>
              
              <!-- Reputation Section -->
              <div id="settings-reputation" class="settings-section" style="display: none;">
                <div id="reputationSettingsContent">
                  <!-- Rendered by renderReputationSettings() -->
                </div>
              </div>
              
              <!-- Maintenance Section -->
              <div id="settings-maintenance" class="settings-section" style="display: none;">
                <div id="maintenanceSettingsContent">
                  <!-- Rendered by renderMaintenanceSettings() -->
                </div>
              </div>
              
              <!-- Game Section -->
              <div id="settings-game" class="settings-section active">
                <div id="gameSettingsContent"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ledger Tab -->
        <div id="ledger-tab" class="right-tab-content">
          <div id="financialsList"></div>
        </div>
        
        <!-- Fleet Tab -->
        <div id="fleet-tab" class="right-tab-content">
          <div class="right-subtabs">
            <button class="right-subtab active" data-right-subtab="fleet-aircraft">Aircraft</button>
            <button class="right-subtab" data-right-subtab="fleet-maintenance">Maintenance</button>
          </div>
          
          <div id="fleet-aircraft-subtab" class="right-subtab-content active">
            <div id="fleetList"></div>
          </div>
          
          <div id="fleet-maintenance-subtab" class="right-subtab-content">
            <div id="fleetMaintenance"></div>
          </div>
        </div>
        
        <!-- Company Tab -->
        <div id="company-tab" class="right-tab-content">
          <div class="right-subtabs">
            <button class="right-subtab active" data-right-subtab="company-overview">Overview</button>
            <button class="right-subtab" data-right-subtab="company-reviews">Reviews</button>
            <button class="right-subtab" data-right-subtab="company-insurance">Insurance</button>
            <button class="right-subtab" data-right-subtab="company-bases">Bases</button>
          </div>
          
          <div id="company-overview-subtab" class="right-subtab-content active">
            <div id="companyOverview"></div>
          </div>
          
          <div id="company-reviews-subtab" class="right-subtab-content">
            <div id="companyReviews"></div>
          </div>
          
          <div id="company-insurance-subtab" class="right-subtab-content">
            <div id="companyInsurance"></div>
          </div>
          
          <div id="company-bases-subtab" class="right-subtab-content">
            <div id="basesList"></div>
          </div>
        </div>
        
        <!-- Staff Tab -->
        <div id="staff-tab" class="right-tab-content">
          <div class="staff-header">
            <div class="staff-title">
              <h3>Staff Management</h3>
              <span class="staff-count" id="staffCount">0 employees</span>
            </div>
            <div class="staff-actions">
              <button class="btn btn-small" onclick="showStaffMarketplace()">+ Hire Staff</button>
            </div>
          </div>
          
          <div class="staff-payroll-summary" id="staffPayrollSummary">
            <!-- Rendered by renderStaffPayrollSummary() -->
          </div>
          
          <div id="staffMissionsContainer" style="display: none;">
            <!-- Rendered by renderStaffMissions() -->
          </div>
          
          <!-- Staff Filter -->
          <div style="margin-bottom: 12px; display: flex; gap: 10px; align-items: center;">
            <select id="staffRosterFilter" onchange="filterStaffRoster()" style="padding: 6px 10px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;">
              <option value="">All Roles</option>
              <option value="pilot">Pilots</option>
              <option value="mechanic">Mechanics</option>
              <option value="opsOfficer">Ops Officers</option>
              <option value="marketing">Marketing</option>
              <option value="accountant">Accountants</option>
            </select>
          </div>
          
          <div class="staff-roster" id="staffRoster">
            <!-- Rendered by renderStaffRoster() -->
          </div>
        </div>
        
        <!-- Market Tab -->
        <div id="market-tab" class="right-tab-content">
          <div class="market-header">
            <div class="market-title">
              <h3>Aircraft Market</h3>
              <span class="market-count">0 listings</span>
            </div>
            <div class="market-actions">
              <button class="btn btn-small" onclick="showBrokerModal()">ðŸ” Aircraft Broker</button>
              <button class="btn btn-small" onclick="showCustomAircraftModal()">+ Custom</button>
              <button class="btn btn-small" onclick="refreshMarketListings()">â†»</button>
            </div>
          </div>
          
          <div id="activeBrokerRequest" class="broker-request-banner" style="display: none;"></div>
          
          <div class="market-filters">
            <select id="marketCategoryFilter" onchange="filterMarketListings()">
              <option value="">All Categories</option>
              <option value="single_piston">Single Piston</option>
              <option value="multi_piston">Multi Piston</option>
              <option value="turboprop">Turboprop</option>
              <option value="light_jet">Light Jet</option>
              <option value="airliner">Airliner</option>
              <option value="helicopter">Helicopter</option>
              <option value="bush">Bush/Backcountry</option>
              <option value="amphibious">Amphibious</option>
              <option value="aerobatic">Aerobatic</option>
              <option value="warbird">Warbird</option>
            </select>
            <select id="marketPriceFilter" onchange="filterMarketListings()">
              <option value="">Any Price</option>
              <option value="0-100000">Under $100K</option>
              <option value="100000-500000">$100K - $500K</option>
              <option value="500000-2000000">$500K - $2M</option>
              <option value="2000000-99999999">Over $2M</option>
            </select>
            <select id="marketSortFilter" onchange="filterMarketListings()">
              <option value="newest">Newest Listed</option>
              <option value="price-low">Price: Low to High</option>
              <option value="price-high">Price: High to Low</option>
              <option value="year-new">Year: Newest</option>
              <option value="year-old">Year: Oldest</option>
              <option value="condition-high">Condition: Best</option>
              <option value="condition-low">Condition: Lowest</option>
              <option value="hours-low">Hours: Lowest</option>
              <option value="hours-high">Hours: Highest</option>
              <option value="expiring">Expiring Soon</option>
            </select>
          </div>
          
          <div id="marketListings" class="market-listings"></div>
          
          <div class="market-loans-section" id="activeLoansSection" style="display: none;">
            <h4 style="margin: 20px 0 12px 0; font-size: 13px; color: var(--muted);">ACTIVE FINANCING</h4>
            <div id="activeLoans"></div>
          </div>
          
          <div class="market-leases-section" id="activeLeasesSection" style="display: none;">
            <h4 style="margin: 20px 0 12px 0; font-size: 13px; color: var(--muted);">ACTIVE LEASES</h4>
            <div id="activeLeases"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  
  <!-- Confetti Container -->
  <div id="confettiContainer" class="confetti-container"></div>
  
  <!-- Flight Summary Modal -->
  <div id="flightSummaryOverlay" class="flight-summary-overlay"></div>

  <!-- Custom Aircraft Modal -->
  <div id="customAircraftModal" class="custom-aircraft-modal hidden">
    <div class="custom-aircraft-content">
      <div class="custom-aircraft-header">
        <h3>Add Custom Aircraft</h3>
        <button class="custom-aircraft-close" onclick="hideCustomAircraftModal()">&times;</button>
      </div>
      <div class="custom-aircraft-body">
        <div class="custom-form-section">
          <h4>Basic Information</h4>
          <div class="custom-form-grid">
            <div class="custom-form-field full-width">
              <label>Aircraft Name *</label>
              <input type="text" id="customName" placeholder="e.g., Piper Cherokee 140">
            </div>
            <div class="custom-form-field">
              <label>Category *</label>
              <select id="customCategory">
                <option value="single_piston">Single Piston</option>
                <option value="multi_piston">Multi Piston</option>
                <option value="turboprop">Turboprop</option>
                <option value="light_jet">Light Jet</option>
                <option value="airliner">Airliner</option>
                <option value="helicopter">Helicopter</option>
                <option value="bush">Bush/Backcountry</option>
                <option value="amphibious">Amphibious</option>
                <option value="aerobatic">Aerobatic</option>
                <option value="warbird">Warbird</option>
              </select>
            </div>
            <div class="custom-form-field">
              <label>Fuel Type</label>
              <select id="customFuelType">
                <option value="100LL">100LL (Avgas)</option>
                <option value="Jet-A">Jet-A</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="custom-form-section">
          <h4>Performance</h4>
          <div class="custom-form-grid">
            <div class="custom-form-field">
              <label>Cruise Speed (ktas)</label>
              <input type="number" id="customCruiseSpeed" placeholder="120">
            </div>
            <div class="custom-form-field">
              <label>Fuel Burn (gph)</label>
              <input type="number" id="customFuelBurn" placeholder="9" step="0.1">
            </div>
            <div class="custom-form-field">
              <label>Range (nm)</label>
              <input type="number" id="customRange" placeholder="600">
            </div>
            <div class="custom-form-field">
              <label>Fuel Capacity (gal)</label>
              <input type="number" id="customFuelCapacity" placeholder="50">
            </div>
            <div class="custom-form-field">
              <label>Runway Required (ft)</label>
              <input type="number" id="customRunway" placeholder="1500">
            </div>
            <div class="custom-form-field">
              <label>Avionics Level</label>
              <select id="customAvionics">
                <option value="VFR">VFR Basic</option>
                <option value="IFR">IFR Capable</option>
                <option value="GPS">GPS/Glass</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="custom-form-section">
          <h4>Capacity</h4>
          <div class="custom-form-grid">
            <div class="custom-form-field">
              <label>Passengers (max)</label>
              <input type="number" id="customPassengers" placeholder="3">
            </div>
            <div class="custom-form-field">
              <label>Cargo (lbs)</label>
              <input type="number" id="customCargo" placeholder="200">
            </div>
          </div>
        </div>
        
        <div class="custom-form-section">
          <h4>Surface Compatibility</h4>
          <div class="custom-form-checkboxes">
            <label class="custom-form-checkbox">
              <input type="checkbox" id="customSurfacePaved" checked> Paved
            </label>
            <label class="custom-form-checkbox">
              <input type="checkbox" id="customSurfaceGrass"> Grass
            </label>
            <label class="custom-form-checkbox">
              <input type="checkbox" id="customSurfaceGravel"> Gravel
            </label>
            <label class="custom-form-checkbox">
              <input type="checkbox" id="customSurfaceDirt"> Dirt
            </label>
            <label class="custom-form-checkbox">
              <input type="checkbox" id="customSurfaceWater"> Water
            </label>
          </div>
        </div>
        
        <div class="custom-form-section">
          <h4>Ownership Details (Optional)</h4>
          <div class="custom-form-grid">
            <div class="custom-form-field">
              <label>Year of Manufacture</label>
              <input type="number" id="customYear" placeholder="2020">
            </div>
            <div class="custom-form-field">
              <label>Condition (%)</label>
              <input type="number" id="customCondition" placeholder="100" min="60" max="100">
            </div>
            <div class="custom-form-field">
              <label>Purchase Price ($)</label>
              <input type="number" id="customPrice" placeholder="150000">
            </div>
            <div class="custom-form-field">
              <label>Hourly Operating Cost ($)</label>
              <input type="number" id="customOperatingCost" placeholder="Auto-calculated">
            </div>
          </div>
        </div>
      </div>
      <div class="custom-aircraft-footer">
        <button class="btn" onclick="hideCustomAircraftModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomAircraft()">Add to Fleet</button>
      </div>
    </div>
  </div>

  <!-- Broker Modal -->
  <div id="brokerModal" class="broker-modal hidden">
    <div class="broker-content">
      <div class="broker-header">
        <h3>ðŸ” Aircraft Broker</h3>
        <button class="broker-close" onclick="hideBrokerModal()">&times;</button>
      </div>
      <div class="broker-body">
        <div class="broker-info">
          Our broker network can locate specific aircraft for you. Select an aircraft type and we'll find one within 1-3 days. A 5% finder's fee applies.
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Filter by Category</label>
          <select id="brokerCategoryFilter" onchange="filterBrokerAircraft()" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text);">
            <option value="">All Categories</option>
            <option value="single_piston">Single Piston</option>
            <option value="multi_piston">Multi Piston</option>
            <option value="turboprop">Turboprop</option>
            <option value="light_jet">Light Jet</option>
            <option value="airliner">Airliner</option>
            <option value="helicopter">Helicopter</option>
            <option value="bush">Bush/Backcountry</option>
            <option value="amphibious">Amphibious</option>
            <option value="aerobatic">Aerobatic</option>
            <option value="warbird">Warbird</option>
            <option value="cargo">Cargo</option>
          </select>
        </div>
        
        <div id="brokerAircraftGrid" class="broker-aircraft-grid"></div>
        
        <div id="brokerFeePreview" class="broker-fee-preview" style="display: none;">
          <div class="broker-fee-row">
            <span class="broker-fee-label">Selected Aircraft</span>
            <span class="broker-fee-value" id="brokerSelectedName">-</span>
          </div>
          <div class="broker-fee-row">
            <span class="broker-fee-label">Est. Price Range</span>
            <span class="broker-fee-value" id="brokerPriceRange">-</span>
          </div>
          <div class="broker-fee-row">
            <span class="broker-fee-label">Broker Fee (5%)</span>
            <span class="broker-fee-value" id="brokerFee">-</span>
          </div>
          <div class="broker-fee-row">
            <span class="broker-fee-label">ETA</span>
            <span class="broker-fee-value">1-3 days</span>
          </div>
        </div>
      </div>
      <div class="broker-footer">
        <button class="btn" onclick="hideBrokerModal()">Cancel</button>
        <button class="btn btn-primary" id="brokerSubmitBtn" onclick="submitBrokerRequest()" disabled>Request Aircraft</button>
      </div>
    </div>
  </div>

  <script>
    // DEBUG LOGGING FUNCTION
    function debugLog(msg, data = null) {
      const panel = document.getElementById('debugLog');
      if (!panel) return;
      const time = new Date().toLocaleTimeString();
      let text = `[${time}] ${msg}`;
      if (data !== null) {
        try {
          text += ': ' + JSON.stringify(data, null, 2).substring(0, 500);
        } catch(e) {
          text += ': [object]';
        }
      }
      panel.innerHTML = text + '\n' + panel.innerHTML;
      // Keep only last 50 lines
      const lines = panel.innerHTML.split('\n');
      if (lines.length > 50) {
        panel.innerHTML = lines.slice(0, 50).join('\n');
      }
    }
    
    // Debug: Fix staff pilot hours based on experience level
    function debugFixStaffHours() {
      let fixed = 0;
      for (const member of S.staff) {
        if (member.role === 'pilot' && member.pilot) {
          const minHours = {
            junior: 250,
            mid: 750,
            senior: 2000,
            expert: 6000
          };
          const maxHours = {
            junior: 500,
            mid: 1500,
            senior: 5000,
            expert: 15000
          };
          const min = minHours[member.experienceLevel] || 250;
          const max = maxHours[member.experienceLevel] || 500;
          
          if (member.pilot.flightHours < min) {
            const newHours = randomInt(min, max);
            console.log(`Fixed ${member.name}: ${member.pilot.flightHours} -> ${newHours} hours`);
            member.pilot.flightHours = newHours;
            fixed++;
          }
        }
      }
      saveState();
      render();
      showToast('Debug', `Fixed ${fixed} pilot(s) with low hours`, 'info');
    }
    window.debugFixStaffHours = debugFixStaffHours;
    
    // Debug: Add XP to a staff member for testing promotions
    function debugAddStaffXP(staffName, amount = 1000) {
      const member = S.staff.find(s => s.name.toLowerCase().includes(staffName.toLowerCase()));
      if (!member) {
        console.log('Staff not found:', staffName);
        return;
      }
      const oldXP = member.xp;
      const oldLevel = member.experienceLevel;
      member.xp += amount;
      checkStaffPromotion(member);
      console.log(`${member.name}: XP ${oldXP} -> ${member.xp}, Level: ${oldLevel} -> ${member.experienceLevel}`);
      saveState();
      render();
    }
    window.debugAddStaffXP = debugAddStaffXP;
    
    // Debug functions for reputation system
    function debugAdjustXP(amount) {
      if (amount > 0) {
        awardExperiencePoints(amount, {});
      } else {
        deductExperiencePoints(Math.abs(amount), 'debug');
      }
      updateDebugDisplays();
      saveState();
      render();
    }
    window.debugAdjustXP = debugAdjustXP;
    
    function debugGenerateReview(stars) {
      const clients = ['Test Corp', 'Debug Airlines', 'Mockup Tours', 'Sample Freight'];
      const missions = ['Charter Flight', 'Sightseeing Tour', 'General Cargo', 'Medical Transfer'];
      
      const review = {
        id: 'REV-DEBUG-' + Date.now(),
        date: { ...S.gameTime },
        stars: stars,
        clientName: clients[Math.floor(Math.random() * clients.length)],
        clientTier: stars >= 4 ? 'corporate' : 'regional',
        missionType: missions[Math.floor(Math.random() * missions.length)],
        route: 'TEST â†’ DEBUG',
        comment: stars >= 4 ? 'Great service! Highly recommended.' : 
                 stars === 3 ? 'Adequate service. Nothing special.' : 
                 'Disappointing experience. Would not recommend.'
      };
      
      if (!S.reputation.reviewLog) S.reputation.reviewLog = [];
      S.reputation.reviewLog.unshift(review);
      
      if (!S.reputation.recentRatings) S.reputation.recentRatings = [];
      S.reputation.recentRatings.unshift(stars);
      if (S.reputation.recentRatings.length > 20) {
        S.reputation.recentRatings = S.reputation.recentRatings.slice(0, 20);
      }
      
      S.reputation.totalReviews = (S.reputation.totalReviews || 0) + 1;
      const sum = S.reputation.recentRatings.reduce((a, b) => a + b, 0);
      S.reputation.stars = Math.round((sum / S.reputation.recentRatings.length) * 10) / 10;
      
      updateDebugDisplays();
      saveState();
      render();
      debugLog(`Generated ${stars}-star review`, review);
    }
    window.debugGenerateReview = debugGenerateReview;
    
    // MX Debug Functions
    function debugUpdateMxDisplay() {
      const select = document.getElementById('debugMxAircraft');
      if (!select) return;
      
      // Populate aircraft dropdown if empty
      if (select.options.length === 0 && S.fleet.length > 0) {
        S.fleet.forEach(code => {
          const ac = getAircraft(code);
          const opt = document.createElement('option');
          opt.value = code;
          opt.textContent = ac?.name || code;
          select.appendChild(opt);
        });
      }
      
      const code = select.value;
      if (!code) return;
      
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const inspHours = document.getElementById('debugInspHours');
      const overhaulHours = document.getElementById('debugOverhaulHours');
      const condition = document.getElementById('debugCondition');
      
      if (inspHours) inspHours.textContent = (fleetInfo.hoursSinceInspection || 0).toFixed(0);
      if (overhaulHours) overhaulHours.textContent = (fleetInfo.hoursSinceOverhaul || 0).toFixed(0);
      if (condition) condition.textContent = (fleetInfo.condition || 100).toFixed(0);
    }
    window.debugUpdateMxDisplay = debugUpdateMxDisplay;
    
    function debugAdjustMxHours(type, amount) {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) return;
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      if (type === 'inspection') {
        fleetInfo.hoursSinceInspection = Math.max(0, (fleetInfo.hoursSinceInspection || 0) + amount);
      } else if (type === 'overhaul') {
        fleetInfo.hoursSinceOverhaul = Math.max(0, (fleetInfo.hoursSinceOverhaul || 0) + amount);
      }
      
      debugUpdateMxDisplay();
      saveState();
      debugLog(`Adjusted ${type} hours by ${amount} for ${code}`);
      // Check if this triggers any MX warnings (before render so new emails show)
      checkMxDueWarning(code);
      render();
    }
    window.debugAdjustMxHours = debugAdjustMxHours;
    
    function debugAdjustCondition(amount) {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) return;
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      fleetInfo.condition = Math.max(0, Math.min(100, (fleetInfo.condition || 100) + amount));
      fleetInfo.mxStatus = getMxStatus(code);
      
      debugUpdateMxDisplay();
      saveState();
      render();
      debugLog(`Adjusted condition by ${amount} for ${code}, now ${Math.round(fleetInfo.condition)}%`);
    }
    window.debugAdjustCondition = debugAdjustCondition;
    
    function debugAddSquawk() {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) {
        alert('Select an aircraft first');
        return;
      }
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const severities = ['minor', 'moderate', 'serious', 'critical'];
      const severity = severities[Math.floor(Math.random() * severities.length)];
      
      const squawk = generateSquawk(code);
      if (!fleetInfo.squawks) fleetInfo.squawks = [];
      fleetInfo.squawks.push(squawk);
      fleetInfo.mxStatus = getMxStatus(code);
      
      saveState();
      render();
      debugLog(`Added ${squawk.severity} squawk to ${code}: ${squawk.description}`);
      showToast('Debug Squawk Added', `${squawk.severity}: ${squawk.description}`, 'warning');
    }
    window.debugAddSquawk = debugAddSquawk;
    
    function debugClearMxWarnings() {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) {
        alert('Select an aircraft first');
        return;
      }
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      fleetInfo.mxWarningsSent = {};
      saveState();
      debugLog(`Cleared MX warning flags for ${code}`);
      showToast('Debug', 'MX warning flags cleared - will trigger again when in range', 'info');
    }
    window.debugClearMxWarnings = debugClearMxWarnings;
    
    // === SQUAWK PREVENTION TEST FUNCTIONS ===
    function debugTestSquawkPrevention() {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) {
        alert('Select an aircraft first');
        return;
      }
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const condition = Math.round(fleetInfo.condition || 100);
      const baseChance = getSquawkChanceForCondition(condition);
      const effectiveChance = getEffectiveSquawkChance(baseChance);
      const preventionChance = getSquawkPreventionChance(code);
      
      // Simulate 100 flights
      let squawksWithMechanic = 0;
      let squawksWithoutMechanic = 0;
      let prevented = 0;
      
      for (let i = 0; i < 100; i++) {
        // Would a squawk occur?
        if (Math.random() < effectiveChance) {
          squawksWithoutMechanic++;
          
          // Does mechanic prevent it?
          if (preventionChance > 0 && Math.random() < preventionChance) {
            prevented++;
          } else {
            squawksWithMechanic++;
          }
        }
      }
      
      // Find best mechanic for display
      const mechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.mechanic?.specializations?.includes('airframe')
      );
      const expOrder = { expert: 4, senior: 3, mid: 2, junior: 1 };
      mechanics.sort((a, b) => (expOrder[b.experienceLevel] || 0) - (expOrder[a.experienceLevel] || 0));
      const bestMechanic = mechanics[0];
      
      debugLog('=== SQUAWK PREVENTION TEST (100 Flights) ===');
      debugLog(`Aircraft: ${code} (Condition: ${condition}%)`);
      debugLog(`Base squawk chance: ${Math.round(baseChance * 100)}%`);
      debugLog(`Effective chance: ${Math.round(effectiveChance * 100)}%`);
      debugLog(`Prevention chance: ${Math.round(preventionChance * 100)}%${bestMechanic ? ` (${bestMechanic.name}, ${bestMechanic.experienceLevel})` : ' (No mechanic)'}`);
      debugLog('---');
      debugLog(`Squawks WITHOUT mechanic: ${squawksWithoutMechanic}`);
      debugLog(`Squawks WITH mechanic: ${squawksWithMechanic}`);
      debugLog(`Squawks PREVENTED: ${prevented}`);
      debugLog(`Prevention rate: ${squawksWithoutMechanic > 0 ? Math.round((prevented / squawksWithoutMechanic) * 100) : 0}%`);
      debugLog('========================================');
      
      showToast('Test Complete', `${prevented} squawks prevented out of ${squawksWithoutMechanic} potential`, 'info');
    }
    window.debugTestSquawkPrevention = debugTestSquawkPrevention;
    
    function debugForceSquawkRoll() {
      const select = document.getElementById('debugMxAircraft');
      if (!select || !select.value) {
        alert('Select an aircraft first');
        return;
      }
      
      const code = select.value;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const condition = Math.round(fleetInfo.condition || 100);
      const baseChance = getSquawkChanceForCondition(condition);
      let effectiveChance = getEffectiveSquawkChance(baseChance);
      
      // Calculate all modifiers
      const age = getAircraftAge(code);
      const ageBonus = Math.min(0.05, age * 0.001);
      const deferredSquawks = (fleetInfo.squawks || []).filter(s => s.canDefer);
      const deferredBonus = deferredSquawks.length * 0.05;
      const mxData = getMxData(code);
      const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
      const overdueBonus = hoursUntilInspection < 0 ? 0.10 : 0;
      const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
      const tboBonus = hoursUntilOverhaul < mxData.tbo * 0.1 ? 0.05 : 0;
      
      effectiveChance = baseChance + ageBonus + deferredBonus + overdueBonus + tboBonus;
      
      const preventionChance = getSquawkPreventionChance(code);
      
      // Find best mechanic
      const mechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.mechanic?.specializations?.includes('airframe')
      );
      const expOrder = { expert: 4, senior: 3, mid: 2, junior: 1 };
      mechanics.sort((a, b) => (expOrder[b.experienceLevel] || 0) - (expOrder[a.experienceLevel] || 0));
      const bestMechanic = mechanics[0];
      
      // Roll the dice
      const squawkRoll = Math.random();
      const squawkOccurs = squawkRoll < effectiveChance;
      const preventionRoll = Math.random();
      const squawkPrevented = squawkOccurs && preventionChance > 0 && preventionRoll < preventionChance;
      
      debugLog('=== FORCE SQUAWK ROLL ===');
      debugLog(`Aircraft: ${code}`);
      debugLog(`Condition: ${condition}%`);
      debugLog('');
      debugLog('CHANCE CALCULATION:');
      debugLog(`  Base chance (condition): ${Math.round(baseChance * 100)}%`);
      debugLog(`  + Age bonus (${age}yr): +${Math.round(ageBonus * 100)}%`);
      debugLog(`  + Deferred squawks (${deferredSquawks.length}): +${Math.round(deferredBonus * 100)}%`);
      debugLog(`  + Overdue inspection: +${Math.round(overdueBonus * 100)}%`);
      debugLog(`  + Near TBO: +${Math.round(tboBonus * 100)}%`);
      debugLog(`  = EFFECTIVE CHANCE: ${Math.round(effectiveChance * 100)}%`);
      debugLog('');
      debugLog('PREVENTION:');
      debugLog(`  Mechanic: ${bestMechanic ? `${bestMechanic.name} (${bestMechanic.experienceLevel})` : 'None'}`);
      debugLog(`  Prevention chance: ${Math.round(preventionChance * 100)}%`);
      debugLog('');
      debugLog('ROLL RESULTS:');
      debugLog(`  Squawk roll: ${squawkRoll.toFixed(3)} vs ${effectiveChance.toFixed(3)} â†’ ${squawkOccurs ? 'SQUAWK TRIGGERED' : 'No squawk'}`);
      if (squawkOccurs) {
        debugLog(`  Prevention roll: ${preventionRoll.toFixed(3)} vs ${preventionChance.toFixed(3)} â†’ ${squawkPrevented ? 'PREVENTED!' : 'Not prevented'}`);
      }
      debugLog('');
      debugLog(`FINAL RESULT: ${squawkOccurs ? (squawkPrevented ? 'âœ“ SQUAWK PREVENTED BY MECHANIC' : 'âœ— SQUAWK OCCURS') : 'âœ“ NO SQUAWK'}`);
      debugLog('=========================');
      
      // Update prevention chance display
      const prevDisplay = document.getElementById('debugPreventionChance');
      if (prevDisplay) {
        prevDisplay.textContent = `${Math.round(preventionChance * 100)}%`;
      }
      
      const resultMsg = squawkOccurs ? (squawkPrevented ? 'Squawk prevented!' : 'Squawk occurred') : 'No squawk';
      showToast('Squawk Roll', resultMsg, squawkOccurs && !squawkPrevented ? 'warning' : 'success');
    }
    window.debugForceSquawkRoll = debugForceSquawkRoll;
    
    // === STAFF DEBUG FUNCTIONS ===
    function debugAddStaff() {
      const role = document.getElementById('debugStaffRole')?.value || 'pilot';
      const expLevel = document.getElementById('debugStaffExp')?.value || 'junior';
      
      // Generate a candidate with specified experience level
      const candidate = generateStaffCandidate(role);
      candidate.experienceLevel = expLevel;
      
      // Update skill to match experience level
      const [minSkill, maxSkill] = STAFF_SKILL_RANGES[expLevel];
      candidate.skill = randomInt(minSkill, maxSkill);
      
      // Update salary to match
      candidate.salary = STAFF_SALARIES[role][expLevel];
      
      // Update XP
      candidate.xp = STAFF_XP_THRESHOLDS[expLevel] + randomInt(0, 500);
      
      // Add to staff directly
      candidate.hireDate = { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
      candidate.assignedBase = S.bases.primary;
      S.staff.push(candidate);
      
      updatePayrollTotal();
      saveState();
      render();
      updateDebugStaffDisplay();
      
      debugLog(`Added ${expLevel} ${role}: ${candidate.name}`);
      showToast('Debug Staff Added', `${candidate.name} (${role})`, 'success');
    }
    window.debugAddStaff = debugAddStaff;
    
    function debugClearStaff() {
      if (!confirm('Remove all staff?')) return;
      S.staff = [];
      updatePayrollTotal();
      saveState();
      render();
      updateDebugStaffDisplay();
      debugLog('Cleared all staff');
    }
    window.debugClearStaff = debugClearStaff;
    
    function debugProcessPayroll() {
      const payroll = processPayroll();
      saveState();
      render();
      updateDebugStaffDisplay();
      debugLog(`Processed payroll: $${payroll.toLocaleString()}`);
    }
    window.debugProcessPayroll = debugProcessPayroll;
    
    function debugRefreshMarketplace() {
      refreshStaffMarketplace();
      saveState();
      debugLog(`Refreshed staff marketplace: ${S.staffMarketplace.length} candidates`);
      showToast('Debug', `Marketplace refreshed with ${S.staffMarketplace.length} candidates`, 'info');
    }
    window.debugRefreshMarketplace = debugRefreshMarketplace;
    
    function updateDebugStaffDisplay() {
      const countEl = document.getElementById('debugStaffCount');
      const payrollEl = document.getElementById('debugPayroll');
      
      if (countEl) countEl.textContent = S.staff.length;
      if (payrollEl) {
        const total = S.staff.reduce((sum, s) => sum + s.salary, 0);
        payrollEl.textContent = '$' + total.toLocaleString();
      }
      
      // Update staff XP dropdown
      const staffSelect = document.getElementById('debugStaffXpSelect');
      if (staffSelect) {
        const currentValue = staffSelect.value;
        staffSelect.innerHTML = '<option value="">-- Select Staff --</option>';
        S.staff.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = `${s.name} (${s.role})`;
          staffSelect.appendChild(opt);
        });
        if (currentValue && S.staff.find(s => s.id === currentValue)) {
          staffSelect.value = currentValue;
        }
        debugUpdateStaffXpDisplay();
      }
    }
    
    function debugUpdateStaffXpDisplay() {
      const staffSelect = document.getElementById('debugStaffXpSelect');
      const xpDisplay = document.getElementById('debugStaffXpDisplay');
      const levelDisplay = document.getElementById('debugStaffLevelDisplay');
      
      if (!staffSelect || !xpDisplay || !levelDisplay) return;
      
      const staffId = staffSelect.value;
      const staff = S.staff.find(s => s.id === staffId);
      
      if (staff) {
        xpDisplay.textContent = `${staff.xp || 0} XP`;
        levelDisplay.textContent = `${staff.experienceLevel} (Skill: ${staff.skill})`;
      } else {
        xpDisplay.textContent = '0 XP';
        levelDisplay.textContent = '--';
      }
    }
    window.debugUpdateStaffXpDisplay = debugUpdateStaffXpDisplay;
    
    function debugAdjustStaffXP(amount) {
      const staffSelect = document.getElementById('debugStaffXpSelect');
      if (!staffSelect || !staffSelect.value) {
        showToast('Debug', 'Select a staff member first', 'warning');
        return;
      }
      
      const staffId = staffSelect.value;
      const staff = S.staff.find(s => s.id === staffId);
      
      if (staff) {
        staff.xp = Math.max(0, (staff.xp || 0) + amount);
        
        // Check for promotion
        checkStaffPromotion(staff);
        
        saveState();
        render();
        debugUpdateStaffXpDisplay();
        debugLog(`Adjusted ${staff.name} XP by ${amount}: now ${staff.xp} XP (${staff.experienceLevel})`);
      }
    }
    window.debugAdjustStaffXP = debugAdjustStaffXP;
    
    // Pilot flight hours debug functions
    function debugUpdatePilotHoursDisplay() {
      const select = document.getElementById('debugPilotHoursSelect');
      const hoursDisplay = document.getElementById('debugPilotHoursDisplay');
      const certsDisplay = document.getElementById('debugPilotCertsDisplay');
      
      if (!select || !hoursDisplay) return;
      
      // Populate dropdown with pilots
      const pilots = S.staff.filter(s => s.role === 'pilot');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="">-- Select Pilot --</option>' + 
        pilots.map(p => `<option value="${p.id}">${p.name} (${p.pilot?.flightHours || 0} hrs)</option>`).join('');
      
      // Restore selection if still valid
      if (currentValue && pilots.some(p => p.id === currentValue)) {
        select.value = currentValue;
      }
      
      // Update display
      if (select.value) {
        const pilot = S.staff.find(s => s.id === select.value);
        if (pilot?.pilot) {
          hoursDisplay.textContent = `${pilot.pilot.flightHours || 0} hrs`;
          const certs = pilot.pilot.certificates?.join(', ') || 'none';
          const ratings = pilot.pilot.ratings?.join(', ') || 'none';
          certsDisplay.textContent = `Certs: ${certs} | Ratings: ${ratings}`;
        }
      } else {
        hoursDisplay.textContent = '0 hrs';
        certsDisplay.textContent = '--';
      }
    }
    window.debugUpdatePilotHoursDisplay = debugUpdatePilotHoursDisplay;
    
    function debugAdjustPilotHours(amount) {
      const select = document.getElementById('debugPilotHoursSelect');
      if (!select || !select.value) {
        showToast('Debug', 'Select a pilot first', 'warning');
        return;
      }
      
      const pilot = S.staff.find(s => s.id === select.value);
      if (!pilot?.pilot) return;
      
      pilot.pilot.flightHours = Math.max(0, (pilot.pilot.flightHours || 0) + amount);
      
      // Check for certificate eligibility
      checkStaffPilotCertificates(pilot);
      
      saveState();
      render();
      debugUpdatePilotHoursDisplay();
      debugLog(`Adjusted ${pilot.name} hours by ${amount}: now ${pilot.pilot.flightHours} hrs`);
    }
    window.debugAdjustPilotHours = debugAdjustPilotHours;
    
    function updateDebugDisplays() {
      const xpDisplay = document.getElementById('debugXPDisplay');
      const tierDisplay = document.getElementById('debugTierDisplay');
      const ratingDisplay = document.getElementById('debugRatingDisplay');
      
      if (xpDisplay) xpDisplay.textContent = S.pilot.experiencePoints || 0;
      if (tierDisplay) tierDisplay.textContent = S.pilot.experienceTier || 'rookie';
      if (ratingDisplay) {
        const rep = S.reputation;
        ratingDisplay.textContent = rep.totalReviews > 0 ? 
          `${rep.stars.toFixed(1)}â˜… (${rep.totalReviews})` : '--';
      }
      
      // Update MX debug display
      debugUpdateMxDisplay();
      
      // Update staff debug display
      updateDebugStaffDisplay();
      
      // Update pilot hours debug display
      debugUpdatePilotHoursDisplay();
    }
    
    // === TOAST NOTIFICATIONS ===
    function showToast(title, message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-title">${title}</div>
        ${message ? `<div class="toast-message">${message}</div>` : ''}
      `;
      
      container.appendChild(toast);
      
      // Trigger animation
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });
      
      // Auto-remove
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // === CONFETTI ===
    function showConfetti(count = 50) {
      const container = document.getElementById('confettiContainer');
      if (!container) return;
      
      const colors = ['#3fb950', '#58a6ff', '#d29922', '#f85149', '#8b5cf6', '#ec4899'];
      const shapes = ['â– ', 'â—', 'â–²', 'â—†'];
      
      for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-20px';
        confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.fontSize = (Math.random() * 12 + 8) + 'px';
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
        
        container.appendChild(confetti);
        
        // Remove after animation
        setTimeout(() => confetti.remove(), 4000);
      }
    }
    
    // === POST-FLIGHT SUMMARY ===
    function showPostFlightSummary(data) {
      const overlay = document.getElementById('flightSummaryOverlay');
      if (!overlay) return;
      
      // Calculate month-to-date stats
      const currentMonth = S.gameTime.month;
      const currentYear = S.gameTime.year;
      const monthFlights = S.pilotLog.filter(f => 
        f.date.month === currentMonth && f.date.year === currentYear
      );
      const monthRevenue = monthFlights.reduce((sum, f) => sum + (f.revenue || 0), 0);
      const monthProfit = monthFlights.reduce((sum, f) => sum + (f.profit || 0), 0);
      
      // Build stars display
      const fullStars = Math.floor(data.assessment);
      const emptyStars = 5 - fullStars;
      const starsHtml = 'â˜…'.repeat(fullStars) + 'â˜†'.repeat(emptyStars);
      
      // Determine header icon and style based on flight type
      let headerIcon = 'âœˆï¸';
      let headerTitle = 'FLIGHT COMPLETE';
      if (data.isFreeTraining) {
        headerIcon = 'ðŸ“š';
        headerTitle = 'TRAINING COMPLETE';
      } else if (data.isProficiencyFlight) {
        headerIcon = 'ðŸŽ¯';
        headerTitle = 'PROFICIENCY FLIGHT';
      }
      
      // Build financials section
      let financialsHtml = '';
      if (!data.isFreeTraining) {
        if (data.contractType === 'contract') {
          // Contract pilot - simple flat fee
          financialsHtml = `
            <div class="flight-summary-section">
              <div class="flight-summary-section-title">Financials</div>
              <div class="flight-summary-row">
                <span>Contract Payment</span>
                <span class="positive">+${formatCurrency(data.revenue)}</span>
              </div>
            </div>
          `;
        } else if (data.isProficiencyFlight) {
          // Proficiency - costs only (direct ops + fuel)
          financialsHtml = `
            <div class="flight-summary-section">
              <div class="flight-summary-section-title">Costs</div>
              ${data.directOpsCost > 0 ? `
              <div class="flight-summary-row">
                <span>Direct Ops</span>
                <span class="negative">-${formatCurrency(data.directOpsCost)}</span>
              </div>
              ` : ''}
              ${data.fuelCosts > 0 ? `
              <div class="flight-summary-row">
                <span>Fuel</span>
                <span class="negative">-${formatCurrency(data.fuelCosts)}</span>
              </div>
              ` : ''}
              <div class="flight-summary-row total">
                <span>Total Cost</span>
                <span class="negative">-${formatCurrency(data.totalCosts)}</span>
              </div>
            </div>
          `;
        } else {
          // Regular mission - full breakdown
          financialsHtml = `
            <div class="flight-summary-section">
              <div class="flight-summary-section-title">Financials</div>
              <div class="flight-summary-row">
                <span>Revenue</span>
                <span class="positive">+${formatCurrency(data.revenue)}</span>
              </div>
              ${data.directOpsCost > 0 ? `
              <div class="flight-summary-row">
                <span>Direct Ops</span>
                <span class="negative">-${formatCurrency(data.directOpsCost)}</span>
              </div>
              ` : ''}
              ${data.maintenancePortion > 0 ? `
              <div class="flight-summary-row">
                <span>MX Reserve</span>
                <span class="negative">-${formatCurrency(data.maintenancePortion)}</span>
              </div>
              ` : ''}
              <div class="flight-summary-row total">
                <span>Net Profit</span>
                <span class="${data.netProfit >= 0 ? 'positive' : 'negative'}">${data.netProfit >= 0 ? '+' : ''}${formatCurrency(data.netProfit)}</span>
              </div>
            </div>
          `;
        }
      }
      
      // Build hours section
      let hoursHtml = `
        <div class="flight-summary-section">
          <div class="flight-summary-section-title">Hours Logged</div>
          <div class="flight-summary-row">
            <span>Total</span>
            <div class="flight-summary-hours">
              <span>${data.hoursBefore.toFixed(1)}</span>
              <span class="arrow">â†’</span>
              <span>${data.hoursAfter.toFixed(1)}</span>
              <span class="delta">(+${data.blockTime.toFixed(1)})</span>
            </div>
          </div>
      `;
      
      // Add category hours if applicable
      if (data.nightHours > 0) {
        hoursHtml += `
          <div class="flight-summary-row">
            <span>Night</span>
            <div class="flight-summary-hours">
              <span class="delta">+${data.nightHours.toFixed(1)}</span>
            </div>
          </div>
        `;
      }
      if (data.instrumentHours > 0) {
        hoursHtml += `
          <div class="flight-summary-row">
            <span>Instrument</span>
            <div class="flight-summary-hours">
              <span class="delta">+${data.instrumentHours.toFixed(1)}</span>
            </div>
          </div>
        `;
      }
      
      // PPL progress for training flights
      if (data.isFreeTraining) {
        const hoursRemaining = Math.max(0, CERT_REQUIREMENTS.private.hoursTotal - data.hoursAfter);
        if (hoursRemaining > 0) {
          hoursHtml += `
            <div class="flight-summary-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
              <span>Hours to PPL</span>
              <span style="color: var(--warning);">${hoursRemaining.toFixed(1)} remaining</span>
            </div>
          `;
        } else {
          hoursHtml += `
            <div class="flight-summary-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); color: var(--success);">
              <span>âœˆï¸ PPL requirement met!</span>
              <span>Check inbox</span>
            </div>
          `;
        }
      }
      
      hoursHtml += '</div>';
      
      // Month-to-date section (only for revenue flights)
      let mtdHtml = '';
      if (!data.isFreeTraining && !data.isProficiencyFlight) {
        const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        mtdHtml = `
          <div class="flight-summary-section" style="background: var(--bg); margin: 0 12px 12px; border-radius: var(--radius);">
            <div class="flight-summary-section-title">${monthNames[currentMonth]} ${currentYear} Summary</div>
            <div class="flight-summary-row">
              <span>Flights</span>
              <span>${monthFlights.length}</span>
            </div>
            <div class="flight-summary-row">
              <span>Revenue</span>
              <span class="positive">${formatCurrency(monthRevenue)}</span>
            </div>
            <div class="flight-summary-row">
              <span>Net Profit</span>
              <span class="${monthProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(monthProfit)}</span>
            </div>
          </div>
        `;
      }
      
      // Assessment section
      const assessmentLabel = data.assessment >= 4.5 ? 'Excellent!' : 
                              data.assessment >= 3.5 ? 'Good' : 
                              data.assessment >= 2.5 ? 'Fair' : 'Needs Improvement';
      
      overlay.innerHTML = `
        <div class="flight-summary">
          <div class="flight-summary-header">
            <div class="flight-summary-header-icon">${headerIcon}</div>
            <div class="flight-summary-header-text">
              <div class="flight-summary-header-title">${headerTitle}</div>
              <div class="flight-summary-header-subtitle">${data.route} â€¢ ${data.aircraft}</div>
            </div>
          </div>
          
          <div class="flight-summary-section">
            <div class="flight-summary-row">
              <span>Distance</span>
              <span>${data.distance} nm</span>
            </div>
            <div class="flight-summary-row">
              <span>Block Time</span>
              <span>${data.blockTime.toFixed(1)} hrs</span>
            </div>
            ${!data.isFreeTraining ? `
              <div class="flight-summary-row">
                <span>Fuel Used</span>
                <span>${data.fuelUsed.toFixed(1)} gal</span>
              </div>
            ` : ''}
            ${data.enrouteFuelPurchased > 0 && !data.isFreeTraining ? `
              <div class="flight-summary-row" style="color: var(--warning);">
                <span>â›½ Enroute Refuel</span>
                <span>${data.enrouteFuelPurchased.toFixed(1)} gal</span>
              </div>
            ` : ''}
            ${data.aircraftCondition !== undefined ? `
              <div class="flight-summary-row">
                <span>Aircraft Condition</span>
                <span>${data.aircraftCondition}%</span>
              </div>
            ` : ''}
          </div>
          
          ${financialsHtml}
          ${hoursHtml}
          ${mtdHtml}
          
          <div class="flight-summary-section">
            <div class="flight-summary-section-title">Assessment</div>
            <div class="flight-summary-assessment">
              <div class="flight-summary-stars" style="color: var(--warning);">${starsHtml}</div>
              <div style="font-size: 14px; font-weight: 500;">${assessmentLabel}</div>
            </div>
          </div>
          
          <div class="flight-summary-footer">
            <button class="btn" onclick="closeFlightSummary()" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">Continue</button>
          </div>
        </div>
      `;
      
      // Show overlay
      requestAnimationFrame(() => {
        overlay.classList.add('show');
      });
      
      // Trigger confetti for excellent flights
      if (data.assessment >= 4.5) {
        setTimeout(() => showConfetti(60), 300);
      }
    }
    
    function closeFlightSummary() {
      const overlay = document.getElementById('flightSummaryOverlay');
      if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
          overlay.innerHTML = '';
        }, 300);
      }
    }
    
    // Status: 20% complete, ~5 minutes remaining
    // Building IndexedDB system...

    // Global state
    let AIRPORTS = {};
    const AIRCRAFT = 
{
  "C152": {
    "direct_ops": 3,
    "name": "Cessna 152",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 26,
    "fuel_burn_rate": 6,
    "cruise_speed": 107,
    "range": 415,
    "operating_cost": 25,
    "max_passengers": 1,
    "max_cargo_lbs": 120,
    "runway_required": 1340,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "C152_AEROBAT": {
    "direct_ops": 3,
    "name": "Cessna 152 Aerobat",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 26,
    "fuel_burn_rate": 6,
    "cruise_speed": 107,
    "range": 415,
    "operating_cost": 28,
    "max_passengers": 1,
    "max_cargo_lbs": 120,
    "runway_required": 1340,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "C172_SKYHAWK": {
    "direct_ops": 4,
    "name": "Cessna 172 Skyhawk",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 53,
    "fuel_burn_rate": 9,
    "cruise_speed": 122,
    "range": 640,
    "operating_cost": 32,
    "max_passengers": 3,
    "max_cargo_lbs": 350,
    "runway_required": 1630,
    "surfaces": ["paved", "grass"],
    "avionics": "GPS"
  },
  "C172_G1000": {
    "direct_ops": 4,
    "name": "Cessna 172 Skyhawk G1000",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 53,
    "fuel_burn_rate": 9,
    "cruise_speed": 122,
    "range": 640,
    "operating_cost": 36,
    "max_passengers": 3,
    "max_cargo_lbs": 350,
    "runway_required": 1630,
    "surfaces": ["paved", "grass"],
    "avionics": "GPS"
  },
  "DA40_NG": {
    "direct_ops": 5,
    "name": "Diamond DA40 NG",
    "category": "single_piston",
    "fuel_type": "Jet-A",
    "fuel_capacity": 40,
    "fuel_burn_rate": 5,
    "cruise_speed": 147,
    "range": 720,
    "operating_cost": 40,
    "max_passengers": 3,
    "max_cargo_lbs": 250,
    "runway_required": 1936,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "DA40_TDI": {
    "direct_ops": 5,
    "name": "Diamond DA40 TDI",
    "category": "single_piston",
    "fuel_type": "Jet-A",
    "fuel_capacity": 40,
    "fuel_burn_rate": 5,
    "cruise_speed": 140,
    "range": 700,
    "operating_cost": 38,
    "max_passengers": 3,
    "max_cargo_lbs": 250,
    "runway_required": 1450,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "DV20": {
    "direct_ops": 3,
    "name": "Diamond DV20 Katana",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 24,
    "fuel_burn_rate": 5,
    "cruise_speed": 115,
    "range": 540,
    "operating_cost": 23,
    "max_passengers": 1,
    "max_cargo_lbs": 100,
    "runway_required": 1200,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "DR400": {
    "direct_ops": 4,
    "name": "Robin DR400-100 Cadet",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 29,
    "fuel_burn_rate": 7,
    "cruise_speed": 120,
    "range": 500,
    "operating_cost": 29,
    "max_passengers": 3,
    "max_cargo_lbs": 200,
    "runway_required": 1640,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "CTSL": {
    "direct_ops": 3,
    "name": "Flight Design CTSL",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 34,
    "fuel_burn_rate": 5,
    "cruise_speed": 115,
    "range": 750,
    "operating_cost": 21,
    "max_passengers": 1,
    "max_cargo_lbs": 100,
    "runway_required": 820,
    "surfaces": ["paved", "grass"],
    "avionics": "GPS"
  },
  "VL3": {
    "direct_ops": 3,
    "name": "JMB VL-3 Evolution",
    "category": "single_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 30,
    "fuel_burn_rate": 5,
    "cruise_speed": 155,
    "range": 900,
    "operating_cost": 23,
    "max_passengers": 1,
    "max_cargo_lbs": 100,
    "runway_required": 900,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "CORVALIS": {
    "direct_ops": 10,
    "name": "Cessna 400 Corvalis TT",
    "category": "single_piston_hp",
    "fuel_type": "100LL",
    "fuel_capacity": 106,
    "fuel_burn_rate": 18,
    "cruise_speed": 235,
    "range": 1300,
    "operating_cost": 75,
    "max_passengers": 3,
    "max_cargo_lbs": 450,
    "runway_required": 2350,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "BONANZA_G36": {
    "direct_ops": 8,
    "name": "Beechcraft Bonanza G36",
    "category": "single_piston_hp",
    "fuel_type": "100LL",
    "fuel_capacity": 74,
    "fuel_burn_rate": 14,
    "cruise_speed": 176,
    "range": 920,
    "operating_cost": 63,
    "max_passengers": 4,
    "max_cargo_lbs": 500,
    "runway_required": 1913,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "SR22": {
    "direct_ops": 8,
    "name": "Cirrus SR22",
    "category": "single_piston_hp",
    "fuel_type": "100LL",
    "fuel_capacity": 81,
    "fuel_burn_rate": 16,
    "cruise_speed": 183,
    "range": 1049,
    "operating_cost": 68,
    "max_passengers": 4,
    "max_cargo_lbs": 450,
    "runway_required": 1868,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "NX_CUB": {
    "direct_ops": 5,
    "name": "CubCrafters NX Cub",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 50,
    "fuel_burn_rate": 8,
    "cruise_speed": 112,
    "range": 695,
    "operating_cost": 35,
    "max_passengers": 1,
    "max_cargo_lbs": 350,
    "runway_required": 974,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "VFR"
  },
  "XCUB": {
    "direct_ops": 5,
    "name": "CubCrafters XCub",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 60,
    "fuel_burn_rate": 10,
    "cruise_speed": 130,
    "range": 780,
    "operating_cost": 40,
    "max_passengers": 1,
    "max_cargo_lbs": 400,
    "runway_required": 974,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "GPS"
  },
  "SAVAGE_CUB": {
    "direct_ops": 4,
    "name": "Zlin Savage Cub",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 30,
    "fuel_burn_rate": 5,
    "cruise_speed": 95,
    "range": 560,
    "operating_cost": 24,
    "max_passengers": 1,
    "max_cargo_lbs": 200,
    "runway_required": 500,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "VFR"
  },
  "SAVAGE_NORDEN": {
    "direct_ops": 5,
    "name": "Zlin Savage Norden",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 40,
    "fuel_burn_rate": 6,
    "cruise_speed": 100,
    "range": 650,
    "operating_cost": 30,
    "max_passengers": 1,
    "max_cargo_lbs": 250,
    "runway_required": 600,
    "surfaces": ["paved", "grass", "gravel", "dirt", "snow"],
    "avionics": "VFR"
  },
  "SHOCK_ULTRA": {
    "direct_ops": 4,
    "name": "Zlin Shock Ultra",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 30,
    "fuel_burn_rate": 5,
    "cruise_speed": 85,
    "range": 500,
    "operating_cost": 22,
    "max_passengers": 1,
    "max_cargo_lbs": 200,
    "runway_required": 400,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "VFR"
  },
  "HAWK_ARROW": {
    "direct_ops": 3,
    "name": "CGS Hawk Arrow II",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 20,
    "fuel_burn_rate": 4,
    "cruise_speed": 80,
    "range": 400,
    "operating_cost": 18,
    "max_passengers": 1,
    "max_cargo_lbs": 150,
    "runway_required": 350,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "VFR"
  },
  "DHC2_BEAVER": {
    "direct_ops": 15,
    "name": "De Havilland DHC-2 Beaver",
    "category": "bush",
    "fuel_type": "100LL",
    "fuel_capacity": 95,
    "fuel_burn_rate": 20,
    "cruise_speed": 130,
    "range": 460,
    "operating_cost": 135,
    "max_passengers": 6,
    "max_cargo_lbs": 800,
    "runway_required": 1250,
    "surfaces": ["paved", "grass", "gravel", "dirt", "water"],
    "avionics": "IFR"
  },
  "PC6": {
    "direct_ops": 20,
    "name": "Pilatus PC-6 Porter",
    "category": "bush",
    "fuel_type": "Jet-A",
    "fuel_capacity": 164,
    "fuel_burn_rate": 35,
    "cruise_speed": 130,
    "range": 560,
    "operating_cost": 200,
    "max_passengers": 9,
    "max_cargo_lbs": 1200,
    "runway_required": 656,
    "surfaces": ["paved", "grass", "gravel", "dirt", "snow"],
    "avionics": "GPS"
  },
  "DRACO": {
    "direct_ops": 25,
    "name": "Draco X",
    "category": "bush",
    "fuel_type": "Jet-A",
    "fuel_capacity": 150,
    "fuel_burn_rate": 45,
    "cruise_speed": 185,
    "range": 600,
    "operating_cost": 275,
    "max_passengers": 1,
    "max_cargo_lbs": 500,
    "runway_required": 500,
    "surfaces": ["paved", "grass", "gravel", "dirt"],
    "avionics": "GPS"
  },
  "BARON_G58": {
    "direct_ops": 15,
    "name": "Beechcraft Baron G58",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 142,
    "fuel_burn_rate": 28,
    "cruise_speed": 202,
    "range": 1020,
    "operating_cost": 125,
    "max_passengers": 5,
    "max_cargo_lbs": 600,
    "runway_required": 2380,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "BARON_B55": {
    "direct_ops": 14,
    "name": "Beechcraft Baron 55",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 136,
    "fuel_burn_rate": 26,
    "cruise_speed": 190,
    "range": 950,
    "operating_cost": 115,
    "max_passengers": 4,
    "max_cargo_lbs": 500,
    "runway_required": 2300,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "C310R": {
    "direct_ops": 14,
    "name": "Cessna 310R",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 163,
    "fuel_burn_rate": 27,
    "cruise_speed": 195,
    "range": 1050,
    "operating_cost": 120,
    "max_passengers": 5,
    "max_cargo_lbs": 600,
    "runway_required": 2200,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "C414": {
    "direct_ops": 18,
    "name": "Cessna 414 Chancellor",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 206,
    "fuel_burn_rate": 36,
    "cruise_speed": 230,
    "range": 1150,
    "operating_cost": 155,
    "max_passengers": 6,
    "max_cargo_lbs": 700,
    "runway_required": 2400,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "PA44_SEMINOLE": {
    "direct_ops": 10,
    "name": "Piper PA-44 Seminole",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 108,
    "fuel_burn_rate": 18,
    "cruise_speed": 168,
    "range": 820,
    "operating_cost": 85,
    "max_passengers": 3,
    "max_cargo_lbs": 300,
    "runway_required": 1800,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "AEROSTAR_600": {
    "direct_ops": 16,
    "name": "Piper Aerostar 600",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 174,
    "fuel_burn_rate": 33,
    "cruise_speed": 210,
    "range": 980,
    "operating_cost": 140,
    "max_passengers": 5,
    "max_cargo_lbs": 500,
    "runway_required": 2400,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "C404_TITAN": {
    "direct_ops": 20,
    "name": "Cessna 404 Titan",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 213,
    "fuel_burn_rate": 40,
    "cruise_speed": 195,
    "range": 1050,
    "operating_cost": 170,
    "max_passengers": 9,
    "max_cargo_lbs": 1500,
    "runway_required": 2700,
    "surfaces": ["paved"],
    "avionics": "IFR"
  },
  "DA62": {
    "direct_ops": 12,
    "name": "Diamond DA62",
    "category": "multi_piston",
    "fuel_type": "Jet-A",
    "fuel_capacity": 79,
    "fuel_burn_rate": 12,
    "cruise_speed": 192,
    "range": 1283,
    "operating_cost": 97,
    "max_passengers": 6,
    "max_cargo_lbs": 500,
    "runway_required": 2200,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "DC3": {
    "direct_ops": 40,
    "name": "Douglas DC-3",
    "category": "multi_piston",
    "fuel_type": "100LL",
    "fuel_capacity": 822,
    "fuel_burn_rate": 90,
    "cruise_speed": 180,
    "range": 1500,
    "operating_cost": 420,
    "max_passengers": 21,
    "max_cargo_lbs": 6000,
    "runway_required": 3000,
    "surfaces": ["paved", "grass"],
    "avionics": "IFR"
  },
  "TBM930": {
    "direct_ops": 40,
    "name": "Daher TBM 930",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 282,
    "fuel_burn_rate": 58,
    "cruise_speed": 330,
    "range": 1730,
    "operating_cost": 390,
    "max_passengers": 5,
    "max_cargo_lbs": 800,
    "runway_required": 2380,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "PC12": {
    "direct_ops": 50,
    "name": "Pilatus PC-12 NGX",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 402,
    "fuel_burn_rate": 65,
    "cruise_speed": 290,
    "range": 1845,
    "operating_cost": 500,
    "max_passengers": 9,
    "max_cargo_lbs": 2500,
    "runway_required": 2602,
    "surfaces": ["paved", "grass", "gravel"],
    "avionics": "GPS"
  },
  "DHC6_TWIN_OTTER": {
    "direct_ops": 45,
    "name": "De Havilland DHC-6 Twin Otter",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 378,
    "fuel_burn_rate": 75,
    "cruise_speed": 182,
    "range": 920,
    "operating_cost": 465,
    "max_passengers": 19,
    "max_cargo_lbs": 4000,
    "runway_required": 1500,
    "surfaces": ["paved", "grass", "gravel", "dirt", "water"],
    "avionics": "GPS"
  },
  "KING_AIR_350": {
    "direct_ops": 70,
    "name": "Beechcraft King Air 350",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 544,
    "fuel_burn_rate": 95,
    "cruise_speed": 312,
    "range": 1806,
    "operating_cost": 720,
    "max_passengers": 11,
    "max_cargo_lbs": 3000,
    "runway_required": 3300,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "KING_AIR_C90": {
    "direct_ops": 55,
    "name": "Beechcraft King Air C90GTx",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 384,
    "fuel_burn_rate": 65,
    "cruise_speed": 272,
    "range": 1260,
    "operating_cost": 535,
    "max_passengers": 7,
    "max_cargo_lbs": 1800,
    "runway_required": 2600,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "CARAVAN": {
    "direct_ops": 35,
    "name": "Cessna 208B Grand Caravan EX",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 332,
    "fuel_burn_rate": 53,
    "cruise_speed": 186,
    "range": 1070,
    "operating_cost": 355,
    "max_passengers": 13,
    "max_cargo_lbs": 3500,
    "runway_required": 2055,
    "surfaces": ["paved", "grass", "gravel"],
    "avionics": "GPS"
  },
  "SKYCOURIER": {
    "direct_ops": 55,
    "name": "Cessna 408 SkyCourier",
    "category": "turboprop",
    "fuel_type": "Jet-A",
    "fuel_capacity": 555,
    "fuel_burn_rate": 105,
    "cruise_speed": 200,
    "range": 920,
    "operating_cost": 575,
    "max_passengers": 19,
    "max_cargo_lbs": 6000,
    "runway_required": 3170,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "SAAB_340B": {
    "direct_ops": 80,
    "name": "Saab 340B",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 770,
    "fuel_burn_rate": 140,
    "cruise_speed": 282,
    "range": 1400,
    "operating_cost": 830,
    "max_passengers": 34,
    "max_cargo_lbs": 3500,
    "runway_required": 4100,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "CJ4": {
    "direct_ops": 100,
    "name": "Cessna Citation CJ4",
    "category": "light_jet",
    "fuel_type": "Jet-A",
    "fuel_capacity": 726,
    "fuel_burn_rate": 180,
    "cruise_speed": 451,
    "range": 2165,
    "operating_cost": 950,
    "max_passengers": 9,
    "max_cargo_lbs": 1000,
    "runway_required": 3410,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "LONGITUDE": {
    "direct_ops": 120,
    "name": "Cessna Citation Longitude",
    "category": "light_jet",
    "fuel_type": "Jet-A",
    "fuel_capacity": 1600,
    "fuel_burn_rate": 250,
    "cruise_speed": 483,
    "range": 3500,
    "operating_cost": 1220,
    "max_passengers": 12,
    "max_cargo_lbs": 1500,
    "runway_required": 4810,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "SF50": {
    "direct_ops": 45,
    "name": "Cirrus SF50 Vision Jet",
    "category": "light_jet",
    "fuel_type": "Jet-A",
    "fuel_capacity": 300,
    "fuel_burn_rate": 68,
    "cruise_speed": 311,
    "range": 1200,
    "operating_cost": 425,
    "max_passengers": 5,
    "max_cargo_lbs": 600,
    "runway_required": 3192,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "PC24": {
    "direct_ops": 90,
    "name": "Pilatus PC-24",
    "category": "light_jet",
    "fuel_type": "Jet-A",
    "fuel_capacity": 720,
    "fuel_burn_rate": 190,
    "cruise_speed": 440,
    "range": 2000,
    "operating_cost": 870,
    "max_passengers": 10,
    "max_cargo_lbs": 1500,
    "runway_required": 2930,
    "surfaces": ["paved", "grass", "gravel"],
    "avionics": "GPS"
  },
  "A310": {
    "direct_ops": 350,
    "name": "Airbus A310-300",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 16100,
    "fuel_burn_rate": 1300,
    "cruise_speed": 488,
    "range": 5150,
    "operating_cost": 3150,
    "max_passengers": 220,
    "max_cargo_lbs": 35000,
    "runway_required": 8200,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "A320NEO": {
    "direct_ops": 280,
    "name": "Airbus A320neo",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 6400,
    "fuel_burn_rate": 700,
    "cruise_speed": 450,
    "range": 3500,
    "operating_cost": 2480,
    "max_passengers": 180,
    "max_cargo_lbs": 20000,
    "runway_required": 6562,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "A321LR": {
    "direct_ops": 300,
    "name": "Airbus A321LR",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 8500,
    "fuel_burn_rate": 750,
    "cruise_speed": 450,
    "range": 4000,
    "operating_cost": 2700,
    "max_passengers": 220,
    "max_cargo_lbs": 24000,
    "runway_required": 7200,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "A330_200": {
    "direct_ops": 400,
    "name": "Airbus A330-200",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 36300,
    "fuel_burn_rate": 1600,
    "cruise_speed": 470,
    "range": 7250,
    "operating_cost": 3600,
    "max_passengers": 253,
    "max_cargo_lbs": 45000,
    "runway_required": 8850,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "A330_300": {
    "direct_ops": 420,
    "name": "Airbus A330-300",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 36300,
    "fuel_burn_rate": 1700,
    "cruise_speed": 470,
    "range": 6350,
    "operating_cost": 3920,
    "max_passengers": 295,
    "max_cargo_lbs": 50000,
    "runway_required": 9200,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "B737MAX8": {
    "direct_ops": 260,
    "name": "Boeing 737 MAX 8",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 6875,
    "fuel_burn_rate": 700,
    "cruise_speed": 450,
    "range": 3550,
    "operating_cost": 2360,
    "max_passengers": 189,
    "max_cargo_lbs": 22000,
    "runway_required": 7500,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "B747_8I": {
    "direct_ops": 750,
    "name": "Boeing 747-8 Intercontinental",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 63705,
    "fuel_burn_rate": 3200,
    "cruise_speed": 490,
    "range": 8000,
    "operating_cost": 7250,
    "max_passengers": 467,
    "max_cargo_lbs": 60000,
    "runway_required": 10200,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "B747_8F": {
    "direct_ops": 700,
    "name": "Boeing 747-8F Freighter",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 63705,
    "fuel_burn_rate": 3100,
    "cruise_speed": 490,
    "range": 4390,
    "operating_cost": 6900,
    "max_passengers": 0,
    "max_cargo_lbs": 295300,
    "runway_required": 10500,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "B787_10": {
    "direct_ops": 480,
    "name": "Boeing 787-10 Dreamliner",
    "category": "airliner",
    "fuel_type": "Jet-A",
    "fuel_capacity": 33528,
    "fuel_burn_rate": 1800,
    "cruise_speed": 490,
    "range": 6430,
    "operating_cost": 4480,
    "max_passengers": 330,
    "max_cargo_lbs": 55000,
    "runway_required": 9200,
    "surfaces": ["paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "C17": {
    "direct_ops": 600,
    "name": "Boeing C-17 Globemaster III",
    "category": "military_cargo",
    "fuel_type": "Jet-A",
    "fuel_capacity": 35546,
    "fuel_burn_rate": 2400,
    "cruise_speed": 450,
    "range": 2420,
    "operating_cost": 6100,
    "max_passengers": 134,
    "max_cargo_lbs": 170900,
    "runway_required": 7600,
    "surfaces": ["paved", "dirt"],
    "avionics": "GPS"
  },
  "A400M": {
    "direct_ops": 550,
    "name": "Airbus A400M Atlas",
    "category": "military_cargo",
    "fuel_type": "Jet-A",
    "fuel_capacity": 50500,
    "fuel_burn_rate": 2200,
    "cruise_speed": 480,
    "range": 4800,
    "operating_cost": 5350,
    "max_passengers": 116,
    "max_cargo_lbs": 81600,
    "runway_required": 3215,
    "surfaces": ["paved", "grass", "dirt"],
    "avionics": "GPS"
  },
  "FA18E": {
    "direct_ops": 400,
    "name": "Boeing F/A-18E Super Hornet",
    "category": "military_fighter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 4970,
    "fuel_burn_rate": 380,
    "cruise_speed": 570,
    "range": 1275,
    "operating_cost": 3900,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 4500,
    "surfaces": ["paved"],
    "avionics": "GPS"
  },
  "A10": {
    "direct_ops": 280,
    "name": "Fairchild Republic A-10 Thunderbolt II",
    "category": "military_fighter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 2550,
    "fuel_burn_rate": 280,
    "cruise_speed": 340,
    "range": 800,
    "operating_cost": 2480,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 4000,
    "surfaces": ["paved", "grass", "dirt"],
    "avionics": "IFR"
  },
  "L39": {
    "direct_ops": 70,
    "name": "Aero Vodochody L-39 Albatros",
    "category": "military_fighter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 356,
    "fuel_burn_rate": 95,
    "cruise_speed": 410,
    "range": 680,
    "operating_cost": 620,
    "max_passengers": 1,
    "max_cargo_lbs": 0,
    "runway_required": 2100,
    "surfaces": ["paved", "grass"],
    "avionics": "IFR"
  },
  "ICON_A5": {
    "direct_ops": 5,
    "name": "ICON A5",
    "category": "amphibious",
    "fuel_type": "100LL",
    "fuel_capacity": 20,
    "fuel_burn_rate": 5,
    "cruise_speed": 95,
    "range": 345,
    "operating_cost": 35,
    "max_passengers": 1,
    "max_cargo_lbs": 100,
    "runway_required": 750,
    "surfaces": ["paved", "grass", "water"],
    "avionics": "GPS"
  },
  "G21_GOOSE": {
    "direct_ops": 35,
    "name": "Grumman G-21A Goose",
    "category": "amphibious",
    "fuel_type": "100LL",
    "fuel_capacity": 220,
    "fuel_burn_rate": 50,
    "cruise_speed": 175,
    "range": 770,
    "operating_cost": 315,
    "max_passengers": 8,
    "max_cargo_lbs": 1200,
    "runway_required": 2500,
    "surfaces": ["paved", "grass", "water"],
    "avionics": "VFR"
  },
  "CL415": {
    "direct_ops": 100,
    "name": "De Havilland CL-415",
    "category": "amphibious",
    "fuel_type": "Jet-A",
    "fuel_capacity": 1376,
    "fuel_burn_rate": 190,
    "cruise_speed": 180,
    "range": 1518,
    "operating_cost": 950,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 2700,
    "surfaces": ["paved", "water"],
    "avionics": "GPS"
  },
  "SEASTAR": {
    "direct_ops": 40,
    "name": "Dornier Seastar",
    "category": "amphibious",
    "fuel_type": "Jet-A",
    "fuel_capacity": 290,
    "fuel_burn_rate": 65,
    "cruise_speed": 180,
    "range": 700,
    "operating_cost": 360,
    "max_passengers": 12,
    "max_cargo_lbs": 1500,
    "runway_required": 1640,
    "surfaces": ["paved", "grass", "water"],
    "avionics": "GPS"
  },
  "ALBATROSS": {
    "direct_ops": 65,
    "name": "Amphibian Aerospace Albatross",
    "category": "amphibious",
    "fuel_type": "100LL",
    "fuel_capacity": 600,
    "fuel_burn_rate": 130,
    "cruise_speed": 225,
    "range": 1050,
    "operating_cost": 615,
    "max_passengers": 28,
    "max_cargo_lbs": 5000,
    "runway_required": 3500,
    "surfaces": ["paved", "water"],
    "avionics": "GPS"
  },
  "PITTS_S1S": {
    "direct_ops": 6,
    "name": "Aviat Pitts S1S",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 19,
    "fuel_burn_rate": 9,
    "cruise_speed": 150,
    "range": 317,
    "operating_cost": 51,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 1200,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "PITTS_S2S": {
    "direct_ops": 7,
    "name": "Aviat Pitts S2S",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 29,
    "fuel_burn_rate": 11,
    "cruise_speed": 152,
    "range": 400,
    "operating_cost": 62,
    "max_passengers": 1,
    "max_cargo_lbs": 0,
    "runway_required": 1300,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "EXTRA_330LT": {
    "direct_ops": 8,
    "name": "Extra 330LT",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 42,
    "fuel_burn_rate": 13,
    "cruise_speed": 185,
    "range": 600,
    "operating_cost": 78,
    "max_passengers": 1,
    "max_cargo_lbs": 0,
    "runway_required": 1150,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "EDGE_540": {
    "direct_ops": 10,
    "name": "Zivko Edge 540",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 28,
    "fuel_burn_rate": 12,
    "cruise_speed": 200,
    "range": 466,
    "operating_cost": 90,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 1100,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "MXS_R": {
    "direct_ops": 9,
    "name": "MXS-R",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 24,
    "fuel_burn_rate": 10,
    "cruise_speed": 195,
    "range": 468,
    "operating_cost": 84,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 1000,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "CAP_10": {
    "direct_ops": 5,
    "name": "Robin CAP 10",
    "category": "aerobatic",
    "fuel_type": "100LL",
    "fuel_capacity": 28,
    "fuel_burn_rate": 8,
    "cruise_speed": 135,
    "range": 470,
    "operating_cost": 40,
    "max_passengers": 1,
    "max_cargo_lbs": 50,
    "runway_required": 1300,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "P51_MUSTANG": {
    "direct_ops": 75,
    "name": "North American P-51D Mustang",
    "category": "warbird",
    "fuel_type": "100LL",
    "fuel_capacity": 269,
    "fuel_burn_rate": 70,
    "cruise_speed": 362,
    "range": 1380,
    "operating_cost": 725,
    "max_passengers": 0,
    "max_cargo_lbs": 0,
    "runway_required": 2500,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "T6_TEXAN": {
    "direct_ops": 35,
    "name": "North American T-6 Texan",
    "category": "warbird",
    "fuel_type": "100LL",
    "fuel_capacity": 110,
    "fuel_burn_rate": 30,
    "cruise_speed": 145,
    "range": 530,
    "operating_cost": 315,
    "max_passengers": 1,
    "max_cargo_lbs": 0,
    "runway_required": 1800,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "JN4_JENNY": {
    "direct_ops": 15,
    "name": "Curtiss JN-4 Jenny",
    "category": "warbird",
    "fuel_type": "100LL",
    "fuel_capacity": 21,
    "fuel_burn_rate": 7,
    "cruise_speed": 60,
    "range": 175,
    "operating_cost": 135,
    "max_passengers": 1,
    "max_cargo_lbs": 0,
    "runway_required": 1000,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  },
  "R66": {
    "direct_ops": 25,
    "name": "Robinson R66 Turbine",
    "category": "helicopter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 73,
    "fuel_burn_rate": 24,
    "cruise_speed": 110,
    "range": 350,
    "operating_cost": 205,
    "max_passengers": 4,
    "max_cargo_lbs": 400,
    "runway_required": 0,
    "surfaces": ["helipad", "paved", "grass"],
    "avionics": "GPS"
  },
  "BELL_407": {
    "direct_ops": 45,
    "name": "Bell 407",
    "category": "helicopter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 131,
    "fuel_burn_rate": 42,
    "cruise_speed": 133,
    "range": 324,
    "operating_cost": 395,
    "max_passengers": 6,
    "max_cargo_lbs": 1200,
    "runway_required": 0,
    "surfaces": ["helipad", "paved", "grass"],
    "avionics": "GPS"
  },
  "CABRI_G2": {
    "direct_ops": 12,
    "name": "Guimbal Cabri G2",
    "category": "helicopter",
    "fuel_type": "100LL",
    "fuel_capacity": 45,
    "fuel_burn_rate": 10,
    "cruise_speed": 100,
    "range": 450,
    "operating_cost": 107,
    "max_passengers": 1,
    "max_cargo_lbs": 100,
    "runway_required": 0,
    "surfaces": ["helipad", "paved", "grass"],
    "avionics": "GPS"
  },
  "H125": {
    "direct_ops": 50,
    "name": "Airbus H125",
    "category": "helicopter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 143,
    "fuel_burn_rate": 52,
    "cruise_speed": 134,
    "range": 370,
    "operating_cost": 430,
    "max_passengers": 5,
    "max_cargo_lbs": 1400,
    "runway_required": 0,
    "surfaces": ["helipad", "paved", "grass"],
    "avionics": "GPS"
  },
  "H225": {
    "direct_ops": 140,
    "name": "Airbus H225 Super Puma",
    "category": "helicopter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 571,
    "fuel_burn_rate": 180,
    "cruise_speed": 150,
    "range": 476,
    "operating_cost": 1240,
    "max_passengers": 19,
    "max_cargo_lbs": 4500,
    "runway_required": 0,
    "surfaces": ["helipad", "paved"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "CH47_CHINOOK": {
    "direct_ops": 350,
    "name": "Boeing CH-47D Chinook",
    "category": "helicopter",
    "fuel_type": "Jet-A",
    "fuel_capacity": 1030,
    "fuel_burn_rate": 300,
    "cruise_speed": 150,
    "range": 400,
    "operating_cost": 3150,
    "max_passengers": 33,
    "max_cargo_lbs": 24000,
    "runway_required": 0,
    "surfaces": ["helipad", "paved", "grass", "dirt"],
    "avionics": "GPS",
    "crewRequired": 2
  },
  "AT802": {
    "direct_ops": 35,
    "name": "Air Tractor AT-802",
    "category": "specialty",
    "fuel_type": "Jet-A",
    "fuel_capacity": 254,
    "fuel_burn_rate": 65,
    "cruise_speed": 180,
    "range": 700,
    "operating_cost": 315,
    "max_passengers": 1,
    "max_cargo_lbs": 8000,
    "runway_required": 1200,
    "surfaces": ["paved", "grass", "dirt"],
    "avionics": "VFR"
  },
  "C188_AGTRUCK": {
    "direct_ops": 8,
    "name": "Cessna 188 AGTruck",
    "category": "specialty",
    "fuel_type": "100LL",
    "fuel_capacity": 50,
    "fuel_burn_rate": 15,
    "cruise_speed": 117,
    "range": 390,
    "operating_cost": 58,
    "max_passengers": 0,
    "max_cargo_lbs": 1500,
    "runway_required": 1000,
    "surfaces": ["paved", "grass", "dirt"],
    "avionics": "VFR"
  },
  "OPTICA": {
    "direct_ops": 5,
    "name": "Edgley Optica",
    "category": "specialty",
    "fuel_type": "100LL",
    "fuel_capacity": 59,
    "fuel_burn_rate": 9,
    "cruise_speed": 108,
    "range": 700,
    "operating_cost": 40,
    "max_passengers": 2,
    "max_cargo_lbs": 200,
    "runway_required": 1100,
    "surfaces": ["paved", "grass"],
    "avionics": "VFR"
  }
};

    // ========== MAINTENANCE SYSTEM ==========
    const MX_CONFIG = {
      // Condition limits
      minFlyableCondition: 30,
      
      // Age-based condition ceiling: max = 100 - (age * 0.5), min 75%
      getMaxCondition: (age) => Math.max(75, 100 - (age * 0.5)),
      
      // Age degradation
      baseDegradationPerHour: 0.05,
      ageMultiplierPerDecade: 0.15,
      
      // Squawk probability by condition tier (per flight)
      squawkChance: {
        90: 0, 80: 0.005, 70: 0.015, 60: 0.035,
        50: 0.06, 40: 0.10, 30: 0.15, below30: 0.25
      },
      
      // Squawk severity distribution
      severityDistribution: { minor: 0.55, moderate: 0.30, serious: 0.12, critical: 0.03 },
      
      // Squawk cost multipliers (Ã— base repair cost) [min, max]
      squawkCostMultiplier: {
        minor: [0.5, 2], moderate: [2, 6], serious: [6, 15], critical: [15, 40]
      },
      
      // Squawk condition impact by severity [min, max]
      squawkConditionImpact: {
        minor: [1, 3], moderate: [3, 6], serious: [6, 12], critical: [12, 25]
      },
      
      // Repair cost multiplier by current condition
      repairCostMultiplier: {
        70: 1.0, 60: 1.1, 50: 1.25, 40: 1.5, 30: 1.75, below30: 2.0
      },
      
      // Recommended reserve rates by aircraft age
      recommendedReserve: [
        { maxAge: 10, rate: 15 },
        { maxAge: 20, rate: 18 },
        { maxAge: 30, rate: 22 },
        { maxAge: 40, rate: 27 },
        { maxAge: Infinity, rate: 30 }
      ],
      
      // Mechanic labor rate per hour (for time calculations)
      laborHoursPerDay: 8
    };
    
    // MX data per aircraft type: tbo, inspectionInterval, costs
    // Categories: single_piston, single_piston_hp, multi_piston, turboprop, light_jet, 
    //             helicopter, bush, warbird, amphibious, aerobatic, airliner, specialty
    const MX_DATA = {
      // === SINGLE PISTON ===
      // Labor hours: inspectionHours, overhaulHours (randomized within range at scheduling time)
      C152: { tbo: 2400, inspectionInterval: 100, inspectionCost: 800, majorServiceCost: null, overhaulCost: 18000, repairCostPerPercent: 80, inspectionHoursRange: [12, 16], overhaulHoursRange: [30, 45] },
      C152_AEROBAT: { tbo: 2400, inspectionInterval: 100, inspectionCost: 850, majorServiceCost: null, overhaulCost: 18000, repairCostPerPercent: 85, inspectionHoursRange: [12, 16], overhaulHoursRange: [30, 45] },
      C172_SKYHAWK: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1000, majorServiceCost: null, overhaulCost: 22000, repairCostPerPercent: 80, inspectionHoursRange: [14, 18], overhaulHoursRange: [35, 50] },
      C172_G1000: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1200, majorServiceCost: null, overhaulCost: 24000, repairCostPerPercent: 100, inspectionHoursRange: [16, 20], overhaulHoursRange: [38, 52] },
      DA40_NG: { tbo: 2100, inspectionInterval: 100, inspectionCost: 1100, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 100, inspectionHoursRange: [14, 18], overhaulHoursRange: [40, 55] },
      DA40_TDI: { tbo: 2100, inspectionInterval: 100, inspectionCost: 1100, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 100, inspectionHoursRange: [14, 18], overhaulHoursRange: [40, 55] },
      DV20: { tbo: 2000, inspectionInterval: 100, inspectionCost: 800, majorServiceCost: null, overhaulCost: 18000, repairCostPerPercent: 70, inspectionHoursRange: [12, 15], overhaulHoursRange: [30, 42] },
      DR400: { tbo: 2000, inspectionInterval: 100, inspectionCost: 850, majorServiceCost: null, overhaulCost: 20000, repairCostPerPercent: 80, inspectionHoursRange: [12, 16], overhaulHoursRange: [32, 45] },
      CTSL: { tbo: 2000, inspectionInterval: 100, inspectionCost: 750, majorServiceCost: null, overhaulCost: 16000, repairCostPerPercent: 65, inspectionHoursRange: [10, 14], overhaulHoursRange: [28, 40] },
      VL3: { tbo: 2000, inspectionInterval: 100, inspectionCost: 750, majorServiceCost: null, overhaulCost: 16000, repairCostPerPercent: 65, inspectionHoursRange: [10, 14], overhaulHoursRange: [28, 40] },
      
      // === SINGLE PISTON HP ===
      CORVALIS: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1400, majorServiceCost: null, overhaulCost: 35000, repairCostPerPercent: 120, inspectionHoursRange: [18, 24], overhaulHoursRange: [45, 60] },
      BONANZA_G36: { tbo: 1700, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 38000, repairCostPerPercent: 120, inspectionHoursRange: [18, 24], overhaulHoursRange: [48, 65] },
      SR22: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 32000, repairCostPerPercent: 120, inspectionHoursRange: [18, 22], overhaulHoursRange: [42, 58] },
      
      // === BUSH ===
      NX_CUB: { tbo: 2000, inspectionInterval: 100, inspectionCost: 900, majorServiceCost: null, overhaulCost: 22000, repairCostPerPercent: 85, inspectionHoursRange: [12, 16], overhaulHoursRange: [35, 48] },
      XCUB: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1100, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 100, inspectionHoursRange: [14, 18], overhaulHoursRange: [38, 52] },
      SAVAGE_CUB: { tbo: 2000, inspectionInterval: 100, inspectionCost: 700, majorServiceCost: null, overhaulCost: 18000, repairCostPerPercent: 70, inspectionHoursRange: [10, 14], overhaulHoursRange: [30, 42] },
      SAVAGE_NORDEN: { tbo: 2000, inspectionInterval: 100, inspectionCost: 750, majorServiceCost: null, overhaulCost: 20000, repairCostPerPercent: 75, inspectionHoursRange: [11, 15], overhaulHoursRange: [32, 45] },
      SHOCK_ULTRA: { tbo: 2000, inspectionInterval: 100, inspectionCost: 650, majorServiceCost: null, overhaulCost: 15000, repairCostPerPercent: 60, inspectionHoursRange: [8, 12], overhaulHoursRange: [26, 38] },
      HAWK_ARROW: { tbo: 2000, inspectionInterval: 100, inspectionCost: 600, majorServiceCost: null, overhaulCost: 14000, repairCostPerPercent: 55, inspectionHoursRange: [8, 11], overhaulHoursRange: [24, 35] },
      DHC2_BEAVER: { tbo: 1500, inspectionInterval: 100, inspectionCost: 2500, majorServiceCost: null, overhaulCost: 50000, repairCostPerPercent: 180, inspectionHoursRange: [20, 28], overhaulHoursRange: [55, 75] },
      PC6: { tbo: 3500, inspectionInterval: 300, inspectionCost: 4500, majorServiceCost: 28000, overhaulCost: 220000, repairCostPerPercent: 300, inspectionHoursRange: [35, 50], majorServiceHoursRange: [70, 100], overhaulHoursRange: [90, 120] },
      DRACO: { tbo: 3500, inspectionInterval: 300, inspectionCost: 5000, majorServiceCost: 30000, overhaulCost: 250000, repairCostPerPercent: 350, inspectionHoursRange: [38, 55], majorServiceHoursRange: [75, 105], overhaulHoursRange: [95, 130] },
      
      // === MULTI PISTON ===
      BARON_G58: { tbo: 1700, inspectionInterval: 100, inspectionCost: 2800, majorServiceCost: null, overhaulCost: 55000, repairCostPerPercent: 180, inspectionHoursRange: [30, 42], overhaulHoursRange: [65, 85] },
      BARON_B55: { tbo: 1700, inspectionInterval: 100, inspectionCost: 2600, majorServiceCost: null, overhaulCost: 52000, repairCostPerPercent: 175, inspectionHoursRange: [28, 40], overhaulHoursRange: [62, 82] },
      C310R: { tbo: 1600, inspectionInterval: 100, inspectionCost: 2500, majorServiceCost: null, overhaulCost: 50000, repairCostPerPercent: 170, inspectionHoursRange: [28, 38], overhaulHoursRange: [60, 80] },
      C414: { tbo: 1800, inspectionInterval: 100, inspectionCost: 3200, majorServiceCost: null, overhaulCost: 65000, repairCostPerPercent: 195, inspectionHoursRange: [32, 45], overhaulHoursRange: [68, 90] },
      PA44_SEMINOLE: { tbo: 2000, inspectionInterval: 100, inspectionCost: 2000, majorServiceCost: null, overhaulCost: 40000, repairCostPerPercent: 140, inspectionHoursRange: [24, 34], overhaulHoursRange: [55, 72] },
      AEROSTAR_600: { tbo: 1800, inspectionInterval: 100, inspectionCost: 3000, majorServiceCost: null, overhaulCost: 58000, repairCostPerPercent: 185, inspectionHoursRange: [30, 42], overhaulHoursRange: [65, 85] },
      C310: { tbo: 1600, inspectionInterval: 100, inspectionCost: 2500, majorServiceCost: null, overhaulCost: 50000, repairCostPerPercent: 180, inspectionHoursRange: [28, 38], overhaulHoursRange: [60, 80] },
      C404_TITAN: { tbo: 1800, inspectionInterval: 100, inspectionCost: 3500, majorServiceCost: null, overhaulCost: 70000, repairCostPerPercent: 200, inspectionHoursRange: [35, 48], overhaulHoursRange: [70, 95] },
      DA62: { tbo: 2100, inspectionInterval: 100, inspectionCost: 3000, majorServiceCost: null, overhaulCost: 60000, repairCostPerPercent: 200, inspectionHoursRange: [32, 44], overhaulHoursRange: [65, 88] },
      DC3: { tbo: 1200, inspectionInterval: 100, inspectionCost: 6000, majorServiceCost: null, overhaulCost: 120000, repairCostPerPercent: 350, inspectionHoursRange: [45, 65], overhaulHoursRange: [100, 140] },
      
      // === TURBOPROP ===
      TBM930: { tbo: 3500, inspectionInterval: 300, inspectionCost: 6000, majorServiceCost: 35000, overhaulCost: 320000, repairCostPerPercent: 380, inspectionHoursRange: [40, 55], majorServiceHoursRange: [80, 110], overhaulHoursRange: [85, 115] },
      PC12: { tbo: 3500, inspectionInterval: 300, inspectionCost: 7000, majorServiceCost: 40000, overhaulCost: 350000, repairCostPerPercent: 400, inspectionHoursRange: [45, 60], majorServiceHoursRange: [85, 115], overhaulHoursRange: [90, 120] },
      KING_AIR_C90: { tbo: 3600, inspectionInterval: 300, inspectionCost: 9000, majorServiceCost: 45000, overhaulCost: 380000, repairCostPerPercent: 420, inspectionHoursRange: [50, 70], majorServiceHoursRange: [95, 130], overhaulHoursRange: [100, 135] },
      KING_AIR_350: { tbo: 3600, inspectionInterval: 300, inspectionCost: 12000, majorServiceCost: 55000, overhaulCost: 450000, repairCostPerPercent: 500, inspectionHoursRange: [55, 75], majorServiceHoursRange: [100, 140], overhaulHoursRange: [110, 150] },
      C208_CARAVAN: { tbo: 3600, inspectionInterval: 300, inspectionCost: 5000, majorServiceCost: 30000, overhaulCost: 250000, repairCostPerPercent: 350, inspectionHoursRange: [35, 50], majorServiceHoursRange: [70, 95], overhaulHoursRange: [80, 110] },
      DHC6_TWIN_OTTER: { tbo: 3600, inspectionInterval: 300, inspectionCost: 8000, majorServiceCost: 45000, overhaulCost: 400000, repairCostPerPercent: 420, inspectionHoursRange: [50, 70], majorServiceHoursRange: [95, 130], overhaulHoursRange: [100, 140] },
      SAAB_340B: { tbo: 4000, inspectionInterval: 300, inspectionCost: 15000, majorServiceCost: 80000, overhaulCost: 600000, repairCostPerPercent: 750, inspectionHoursRange: [65, 90], majorServiceHoursRange: [120, 160], overhaulHoursRange: [130, 175] },
      SKYCOURIER: { tbo: 4000, inspectionInterval: 300, inspectionCost: 7000, majorServiceCost: 40000, overhaulCost: 350000, repairCostPerPercent: 520, inspectionHoursRange: [42, 58], majorServiceHoursRange: [80, 110], overhaulHoursRange: [85, 115] },
      
      // === LIGHT JET ===
      SF50: { tbo: 4000, inspectionInterval: 200, inspectionCost: 9000, majorServiceCost: 50000, overhaulCost: 400000, repairCostPerPercent: 500, inspectionHoursRange: [50, 70], majorServiceHoursRange: [100, 140], overhaulHoursRange: [105, 145] },
      CJ4: { tbo: 4000, inspectionInterval: 200, inspectionCost: 15000, majorServiceCost: 75000, overhaulCost: 600000, repairCostPerPercent: 600, inspectionHoursRange: [60, 85], majorServiceHoursRange: [115, 155], overhaulHoursRange: [120, 160] },
      PC24: { tbo: 4000, inspectionInterval: 200, inspectionCost: 13000, majorServiceCost: 65000, overhaulCost: 550000, repairCostPerPercent: 550, inspectionHoursRange: [55, 78], majorServiceHoursRange: [108, 145], overhaulHoursRange: [112, 150] },
      LONGITUDE: { tbo: 4000, inspectionInterval: 200, inspectionCost: 18000, majorServiceCost: 90000, overhaulCost: 700000, repairCostPerPercent: 650, inspectionHoursRange: [65, 90], majorServiceHoursRange: [125, 170], overhaulHoursRange: [130, 175] },
      
      // === HELICOPTER ===
      R66: { tbo: 2200, inspectionInterval: 100, inspectionCost: 3000, majorServiceCost: 22000, overhaulCost: 150000, repairCostPerPercent: 400, inspectionHoursRange: [20, 30], majorServiceHoursRange: [50, 70], overhaulHoursRange: [70, 95] },
      BELL_407: { tbo: 3500, inspectionInterval: 100, inspectionCost: 7000, majorServiceCost: 40000, overhaulCost: 280000, repairCostPerPercent: 500, inspectionHoursRange: [35, 50], majorServiceHoursRange: [80, 110], overhaulHoursRange: [95, 130] },
      CABRI_G2: { tbo: 2000, inspectionInterval: 100, inspectionCost: 2500, majorServiceCost: 18000, overhaulCost: 120000, repairCostPerPercent: 350, inspectionHoursRange: [18, 26], majorServiceHoursRange: [45, 62], overhaulHoursRange: [60, 82] },
      H125: { tbo: 3000, inspectionInterval: 100, inspectionCost: 6000, majorServiceCost: 35000, overhaulCost: 260000, repairCostPerPercent: 480, inspectionHoursRange: [32, 45], majorServiceHoursRange: [72, 100], overhaulHoursRange: [88, 120] },
      H225: { tbo: 3500, inspectionInterval: 100, inspectionCost: 18000, majorServiceCost: 100000, overhaulCost: 800000, repairCostPerPercent: 1100, inspectionHoursRange: [55, 80], majorServiceHoursRange: [130, 180], overhaulHoursRange: [160, 220] },
      CH47_CHINOOK: { tbo: 4000, inspectionInterval: 100, inspectionCost: 35000, majorServiceCost: 200000, overhaulCost: 1500000, repairCostPerPercent: 2800, inspectionHoursRange: [80, 120], majorServiceHoursRange: [200, 280], overhaulHoursRange: [250, 350] },
      
      // === AMPHIBIOUS ===
      ICON_A5: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 35000, repairCostPerPercent: 150, inspectionHoursRange: [14, 20], overhaulHoursRange: [40, 55] },
      G21_GOOSE: { tbo: 1200, inspectionInterval: 100, inspectionCost: 4000, majorServiceCost: null, overhaulCost: 100000, repairCostPerPercent: 250, inspectionHoursRange: [35, 50], overhaulHoursRange: [75, 105] },
      CL415: { tbo: 4000, inspectionInterval: 300, inspectionCost: 20000, majorServiceCost: 100000, overhaulCost: 900000, repairCostPerPercent: 850, inspectionHoursRange: [70, 100], majorServiceHoursRange: [150, 210], overhaulHoursRange: [180, 250] },
      SEASTAR: { tbo: 3500, inspectionInterval: 300, inspectionCost: 8000, majorServiceCost: 45000, overhaulCost: 350000, repairCostPerPercent: 320, inspectionHoursRange: [45, 65], majorServiceHoursRange: [90, 125], overhaulHoursRange: [95, 130] },
      ALBATROSS: { tbo: 1500, inspectionInterval: 100, inspectionCost: 8000, majorServiceCost: null, overhaulCost: 180000, repairCostPerPercent: 550, inspectionHoursRange: [50, 72], overhaulHoursRange: [100, 140] },
      
      // === AEROBATIC ===
      PITTS_S1S: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1000, majorServiceCost: null, overhaulCost: 22000, repairCostPerPercent: 100, inspectionHoursRange: [10, 14], overhaulHoursRange: [32, 45] },
      PITTS_S2S: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1200, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 120, inspectionHoursRange: [12, 16], overhaulHoursRange: [35, 48] },
      EXTRA_330LT: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 30000, repairCostPerPercent: 150, inspectionHoursRange: [14, 19], overhaulHoursRange: [38, 52] },
      EDGE_540: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1400, majorServiceCost: null, overhaulCost: 28000, repairCostPerPercent: 140, inspectionHoursRange: [13, 18], overhaulHoursRange: [36, 50] },
      MXS_R: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1300, majorServiceCost: null, overhaulCost: 27000, repairCostPerPercent: 135, inspectionHoursRange: [12, 17], overhaulHoursRange: [35, 48] },
      CAP_10: { tbo: 2000, inspectionInterval: 100, inspectionCost: 900, majorServiceCost: null, overhaulCost: 20000, repairCostPerPercent: 90, inspectionHoursRange: [10, 14], overhaulHoursRange: [30, 42] },
      
      // === WARBIRD ===
      P51_MUSTANG: { tbo: 600, inspectionInterval: 100, inspectionCost: 8000, majorServiceCost: null, overhaulCost: 150000, repairCostPerPercent: 600, inspectionHoursRange: [45, 65], overhaulHoursRange: [120, 165] },
      T6_TEXAN: { tbo: 800, inspectionInterval: 100, inspectionCost: 5000, majorServiceCost: null, overhaulCost: 80000, repairCostPerPercent: 400, inspectionHoursRange: [32, 45], overhaulHoursRange: [80, 110] },
      JN4_JENNY: { tbo: 500, inspectionInterval: 50, inspectionCost: 3000, majorServiceCost: null, overhaulCost: 40000, repairCostPerPercent: 300, inspectionHoursRange: [25, 35], overhaulHoursRange: [55, 75] },
      
      // === AIRLINER ===
      A320: { tbo: 5000, inspectionInterval: 200, inspectionCost: 30000, majorServiceCost: 150000, overhaulCost: 2000000, repairCostPerPercent: 1200, inspectionHoursRange: [80, 120], majorServiceHoursRange: [200, 280], overhaulHoursRange: [250, 350] },
      B737_MAX8: { tbo: 5000, inspectionInterval: 200, inspectionCost: 30000, majorServiceCost: 150000, overhaulCost: 2000000, repairCostPerPercent: 1200, inspectionHoursRange: [80, 120], majorServiceHoursRange: [200, 280], overhaulHoursRange: [250, 350] },
      A330_900: { tbo: 6000, inspectionInterval: 200, inspectionCost: 50000, majorServiceCost: 250000, overhaulCost: 4000000, repairCostPerPercent: 2000, inspectionHoursRange: [100, 145], majorServiceHoursRange: [260, 360], overhaulHoursRange: [320, 440] },
      B787_10: { tbo: 6000, inspectionInterval: 200, inspectionCost: 55000, majorServiceCost: 280000, overhaulCost: 4500000, repairCostPerPercent: 2200, inspectionHoursRange: [105, 150], majorServiceHoursRange: [280, 390], overhaulHoursRange: [350, 480] },
      B747_8F: { tbo: 6000, inspectionInterval: 200, inspectionCost: 80000, majorServiceCost: 400000, overhaulCost: 7000000, repairCostPerPercent: 3500, inspectionHoursRange: [130, 190], majorServiceHoursRange: [380, 520], overhaulHoursRange: [480, 660] },
      AN225: { tbo: 5000, inspectionInterval: 200, inspectionCost: 120000, majorServiceCost: 600000, overhaulCost: 12000000, repairCostPerPercent: 6000, inspectionHoursRange: [180, 260], majorServiceHoursRange: [550, 760], overhaulHoursRange: [700, 960] },
      
      // === SPECIALTY / CARGO ===
      AT802: { tbo: 3600, inspectionInterval: 100, inspectionCost: 3500, majorServiceCost: 25000, overhaulCost: 180000, repairCostPerPercent: 280, inspectionHoursRange: [28, 40], majorServiceHoursRange: [65, 90], overhaulHoursRange: [75, 105] },
      C188_AGTRUCK: { tbo: 1800, inspectionInterval: 100, inspectionCost: 1200, majorServiceCost: null, overhaulCost: 28000, repairCostPerPercent: 100, inspectionHoursRange: [12, 17], overhaulHoursRange: [35, 50] },
      OPTICA: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1000, majorServiceCost: null, overhaulCost: 22000, repairCostPerPercent: 90, inspectionHoursRange: [11, 15], overhaulHoursRange: [32, 45] }
    };
    
    // Shop hours configuration
    const SHOP_HOURS = {
      startHour: 8,   // 8am
      endHour: 18,    // 6pm
      hoursPerDay: 10,
      overtimeMultiplier: 1.5
    };
    
    // Squawk labor hours by severity (base hours, multiplied by incident type)
    const SQUAWK_LABOR_HOURS = {
      minor: { min: 1, max: 3 },
      moderate: { min: 3, max: 8 },
      serious: { min: 8, max: 20 },
      critical: { min: 20, max: 50 }
    };
    
    // Incident type multipliers for labor hours
    const INCIDENT_LABOR_MULTIPLIERS = {
      hard_landing: 1.0,
      engine_overstress: 1.5,
      prop_strike: 2.0,
      gear_damage: 0.8,
      structural: 1.5,
      bird_strike: 1.2,
      lightning_strike: 1.3,
      turbulence_damage: 0.7,
      fod_damage: 0.8,
      other: 1.0
    };
    
    // Get MX data for an aircraft, with fallback defaults based on category
    function getMxData(code) {
      if (MX_DATA[code]) return MX_DATA[code];
      
      // Fallback based on category
      const aircraft = AIRCRAFT[code];
      if (!aircraft) return { tbo: 2000, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 30000, repairCostPerPercent: 100, inspectionHoursRange: [14, 18], overhaulHoursRange: [35, 50] };
      
      const categoryDefaults = {
        single_piston: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1000, majorServiceCost: null, overhaulCost: 22000, repairCostPerPercent: 80, inspectionHoursRange: [14, 18], overhaulHoursRange: [35, 50] },
        single_piston_hp: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 35000, repairCostPerPercent: 120, inspectionHoursRange: [18, 24], overhaulHoursRange: [45, 60] },
        bush: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1100, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 100, inspectionHoursRange: [14, 20], overhaulHoursRange: [38, 55] },
        multi_piston: { tbo: 1700, inspectionInterval: 100, inspectionCost: 3000, majorServiceCost: null, overhaulCost: 60000, repairCostPerPercent: 180, inspectionHoursRange: [30, 42], overhaulHoursRange: [65, 85] },
        turboprop: { tbo: 3500, inspectionInterval: 300, inspectionCost: 8000, majorServiceCost: 45000, overhaulCost: 350000, repairCostPerPercent: 400, inspectionHoursRange: [45, 65], majorServiceHoursRange: [90, 125], overhaulHoursRange: [90, 120] },
        light_jet: { tbo: 4000, inspectionInterval: 200, inspectionCost: 15000, majorServiceCost: 70000, overhaulCost: 550000, repairCostPerPercent: 550, inspectionHoursRange: [55, 80], majorServiceHoursRange: [110, 150], overhaulHoursRange: [115, 155] },
        helicopter: { tbo: 2500, inspectionInterval: 100, inspectionCost: 5000, majorServiceCost: 30000, overhaulCost: 200000, repairCostPerPercent: 450, inspectionHoursRange: [28, 40], majorServiceHoursRange: [65, 90], overhaulHoursRange: [80, 110] },
        amphibious: { tbo: 2000, inspectionInterval: 100, inspectionCost: 3000, majorServiceCost: null, overhaulCost: 80000, repairCostPerPercent: 200, inspectionHoursRange: [25, 38], overhaulHoursRange: [60, 85] },
        aerobatic: { tbo: 1500, inspectionInterval: 100, inspectionCost: 1200, majorServiceCost: null, overhaulCost: 25000, repairCostPerPercent: 120, inspectionHoursRange: [12, 17], overhaulHoursRange: [34, 48] },
        warbird: { tbo: 700, inspectionInterval: 100, inspectionCost: 6000, majorServiceCost: null, overhaulCost: 100000, repairCostPerPercent: 500, inspectionHoursRange: [38, 55], overhaulHoursRange: [95, 130] },
        airliner: { tbo: 5000, inspectionInterval: 200, inspectionCost: 40000, majorServiceCost: 200000, overhaulCost: 3000000, repairCostPerPercent: 1500, inspectionHoursRange: [90, 135], majorServiceHoursRange: [240, 340], overhaulHoursRange: [300, 420] },
        specialty: { tbo: 2000, inspectionInterval: 100, inspectionCost: 1500, majorServiceCost: null, overhaulCost: 30000, repairCostPerPercent: 100, inspectionHoursRange: [15, 22], overhaulHoursRange: [40, 58] }
      };
      
      return categoryDefaults[aircraft.category] || categoryDefaults.single_piston;
    }
    
    // Get randomized labor hours from a range
    function getRandomLaborHours(range) {
      if (!range || !Array.isArray(range) || range.length < 2) return 16; // Default
      const [min, max] = range;
      return Math.round(min + Math.random() * (max - min));
    }
    
    // Calculate labor hours for a squawk based on severity and incident type
    function getSquawkLaborHours(severity, incidentType) {
      const baseRange = SQUAWK_LABOR_HOURS[severity] || SQUAWK_LABOR_HOURS.moderate;
      const multiplier = INCIDENT_LABOR_MULTIPLIERS[incidentType] || 1.0;
      const baseHours = baseRange.min + Math.random() * (baseRange.max - baseRange.min);
      return Math.round(baseHours * multiplier);
    }
    
    // Calculate days needed for maintenance based on labor hours and overtime option
    function calculateMxDays(laborHours, use24HrOps = false) {
      const hoursPerDay = use24HrOps ? 24 : SHOP_HOURS.hoursPerDay;
      return Math.ceil(laborHours / hoursPerDay);
    }
    
    // Calculate completion date accounting for current time of day
    function calculateMxCompletionDate(laborHours, use24HrOps = false, startDate = null) {
      const start = startDate || { ...S.gameTime };
      const hoursPerDay = use24HrOps ? 24 : SHOP_HOURS.hoursPerDay;
      
      // Calculate how much work can be done today
      let hoursRemainingToday = 0;
      if (use24HrOps) {
        hoursRemainingToday = 24 - start.hour;
      } else {
        // Shop hours: 8am-6pm
        if (start.hour < SHOP_HOURS.startHour) {
          hoursRemainingToday = SHOP_HOURS.hoursPerDay;
        } else if (start.hour >= SHOP_HOURS.endHour) {
          hoursRemainingToday = 0; // Shop closed, work starts tomorrow
        } else {
          hoursRemainingToday = SHOP_HOURS.endHour - start.hour;
        }
      }
      
      // If we can finish today
      if (laborHours <= hoursRemainingToday) {
        return { ...start }; // Complete same day
      }
      
      // Need more days
      const hoursAfterToday = laborHours - hoursRemainingToday;
      const additionalDays = Math.ceil(hoursAfterToday / hoursPerDay);
      
      const completionDate = { ...start };
      completionDate.day += additionalDays;
      while (completionDate.day > 28) {
        completionDate.day -= 28;
        completionDate.month++;
        if (completionDate.month > 12) {
          completionDate.month = 1;
          completionDate.year++;
        }
      }
      
      return completionDate;
    }
    
    // Calculate cost with optional overtime
    function calculateMxCost(baseCost, laborHours, use24HrOps = false) {
      if (!use24HrOps) return baseCost;
      // For 24-hr ops, calculate how many hours are overtime
      const days = calculateMxDays(laborHours, false); // Normal days
      const normalHours = days * SHOP_HOURS.hoursPerDay;
      const overtimeHours = Math.max(0, laborHours - normalHours);
      // Estimate hourly rate from base cost
      const hourlyRate = baseCost / laborHours;
      // Add overtime premium for the extra hours needed to compress into fewer days
      const overtimePremium = (normalHours * hourlyRate * (SHOP_HOURS.overtimeMultiplier - 1)) * (use24HrOps ? 0.5 : 0);
      return Math.round(baseCost * SHOP_HOURS.overtimeMultiplier);
    }

    // ========== CHARTER RATE SYSTEM ==========
    // Base hourly rates by category (USD per flight hour)
    const CHARTER_BASE_RATES = {
      single_piston: 225,
      single_piston_hp: 375,
      bush: 275,
      multi_piston: 650,
      turboprop: 2200,
      light_jet: 3500,
      airliner: 8000,
      helicopter: 1800,
      amphibious: 1200,
      aerobatic: 300,
      warbird: 800,
      military_cargo: 15000,
      military_fighter: 5000,
      specialty: 400
    };
    
    // Charter premium by aircraft (luxury/capability factor)
    // Range: 0.75 (basic/trainer) to 1.30 (luxury/executive)
    const CHARTER_PREMIUMS = {
      // Single Piston
      C152: 0.80, C152_AEROBAT: 0.80,
      C172_SKYHAWK: 0.95, C172_G1000: 1.05,
      DA40_NG: 1.05, DA40_TDI: 1.00, DV20: 0.85, DR400: 0.85,
      CTSL: 0.80, VL3: 0.85,
      // Single Piston HP
      CORVALIS: 1.15, BONANZA_G36: 1.00, SR22: 1.10,
      // Bush
      NX_CUB: 0.90, XCUB: 1.00, SAVAGE_CUB: 0.85, SAVAGE_NORDEN: 0.90,
      SHOCK_ULTRA: 0.85, HAWK_ARROW: 0.75, DHC2_BEAVER: 1.10, PC6: 1.15, DRACO: 1.25,
      // Multi Piston
      BARON_G58: 0.95, BARON_B55: 0.90, C310R: 0.90, C414: 1.00, PA44_SEMINOLE: 0.80, AEROSTAR_600: 1.10, C404_TITAN: 0.95, DA62: 1.00, DC3: 1.00,
      // Turboprop
      TBM930: 1.10, PC12: 1.20, DHC6_TWIN_OTTER: 0.90,
      KING_AIR_350: 1.05, KING_AIR_C90: 0.90, CARAVAN: 0.70,
      SKYCOURIER: 0.80, SAAB_340B: 0.90,
      // Light Jet
      CJ4: 1.00, LONGITUDE: 1.30, SF50: 0.90, PC24: 1.10,
      // Helicopter
      R66: 0.85, BELL_407: 1.05, CABRI_G2: 0.75, H125: 1.10, H225: 1.25, CH47_CHINOOK: 1.00,
      // Amphibious
      ICON_A5: 1.00, G21_GOOSE: 1.10, SEASTAR: 1.05, ALBATROSS: 1.00,
      // Airliner
      A320NEO: 1.00, A321LR: 1.05, B737MAX8: 1.00, A310: 0.90,
      A330_200: 1.05, A330_300: 1.05, B747_8I: 1.15, B787_10: 1.15,
      // Aerobatic
      PITTS_S1S: 0.90, PITTS_S2S: 0.95, EXTRA_330LT: 1.10, EDGE_540: 1.15, MXS_R: 1.10, CAP_10: 0.90,
      // Warbird (vintage premium)
      P51_MUSTANG: 1.50, T6_TEXAN: 1.10, JN4_JENNY: 1.20
    };
    
    // Base rate overrides for specific aircraft that don't fit their category
    const CHARTER_RATE_OVERRIDES = {
      // Light helicopters (trainers/small tours) - much lower than standard heli
      CABRI_G2: { base: 600 },
      // Heavy helicopters (offshore/utility) - much higher than standard heli  
      H225: { base: 4500 },
      CH47_CHINOOK: { base: 4500 },
      // Vintage aircraft command premium rates
      DC3: { base: 2500 },
      DHC2_BEAVER: { base: 500 },
      G21_GOOSE: { base: 2000 },
      // Sport/novelty - lower base
      ICON_A5: { base: 400 },
      // Regional turboprop - higher than standard turboprop
      SAAB_340B: { base: 3500 },
      // Warbirds - vintage premium (rare, high demand)
      P51_MUSTANG: { base: 2000 },
      T6_TEXAN: { base: 1200 },
      JN4_JENNY: { base: 1500 },
      // Heavy cargo/freighter aircraft - specialized rates
      // B747-8F: Real rates $25,000-40,000/hr for ad-hoc cargo charters
      B747_8F: { base: 32000 },
      // Caravan/utility cargo - lower end cargo ops
      CARAVAN: { base: 1800 },
      SKYCOURIER: { base: 2800 },
      // Wide-body passenger (can do cargo charters)
      A330_200: { base: 12000 },
      A330_300: { base: 14000 },
      B787_10: { base: 15000 },
      B747_8I: { base: 18000 },
      // Narrow-body jets
      A320NEO: { base: 6500 },
      A321LR: { base: 7500 },
      B737MAX8: { base: 6500 },
      A310: { base: 8000 }
    };
    
    // Capacity factor - larger aircraft command higher rates (whole-plane charter)
    function getCapacityFactor(pax) {
      if (pax <= 4) return 1.00;
      if (pax <= 6) return 1.05;
      if (pax <= 9) return 1.10;
      if (pax <= 12) return 1.15;
      if (pax <= 19) return 1.25;
      if (pax <= 34) return 1.40;
      if (pax <= 99) return 1.60;
      if (pax <= 199) return 2.00;
      if (pax <= 299) return 2.50;
      return 3.00;
    }

    // ========== LANDMARKS DATABASE (1294 entries) ==========
    // Types: national_park, natural, waterfall, mountain, lake, geothermal, monument, dam, bridge, tower, building, skyline, landmark, stadium, lighthouse, theme_park
    // Regions: northeast, southeast, midwest, southwest, mountain, pacific, alaska, canada_east, canada_west, canada_central, canada_north
    const LANDMARKS = {
      "NP_ACADIA": { name: "Acadia National Park", lat: 44.3386, lon: -68.2733, type: "national_park", region: "northeast", alt: 1500, desc: "Cadillac Mountain summit" },
      "NP_ARCHES": { name: "Arches National Park", lat: 38.7331, lon: -109.5925, type: "national_park", region: "southwest", alt: 5500, desc: "Delicate Arch area" },
      "NP_BADLANDS": { name: "Badlands National Park", lat: 43.8554, lon: -102.3397, type: "national_park", region: "midwest", alt: 3500, desc: "Pinnacles overlook" },
      "NP_BIG_BEND": { name: "Big Bend National Park", lat: 29.2500, lon: -103.2500, type: "national_park", region: "southwest", alt: 4500, desc: "Chisos Basin" },
      "NP_BISCAYNE": { name: "Biscayne National Park", lat: 25.4824, lon: -80.2083, type: "national_park", region: "southeast", alt: 500, desc: "Biscayne Bay" },
      "NP_BLACK_CANYON": { name: "Black Canyon of the Gunnison", lat: 38.5754, lon: -107.7416, type: "national_park", region: "mountain", alt: 8500, desc: "Painted Wall overlook" },
      "NP_BRYCE": { name: "Bryce Canyon National Park", lat: 37.5930, lon: -112.1871, type: "national_park", region: "southwest", alt: 8500, desc: "Bryce Amphitheater" },
      "NP_CANYONLANDS": { name: "Canyonlands National Park", lat: 38.3269, lon: -109.8783, type: "national_park", region: "southwest", alt: 6000, desc: "Island in the Sky" },
      "NP_CAPITOL_REEF": { name: "Capitol Reef National Park", lat: 38.2000, lon: -111.1667, type: "national_park", region: "southwest", alt: 6000, desc: "Waterpocket Fold" },
      "NP_CARLSBAD": { name: "Carlsbad Caverns National Park", lat: 32.1479, lon: -104.5567, type: "national_park", region: "southwest", alt: 4500, desc: "Natural entrance" },
      "NP_CHANNEL_ISLANDS": { name: "Channel Islands National Park", lat: 34.0069, lon: -119.7785, type: "national_park", region: "pacific", alt: 1500, desc: "Santa Cruz Island" },
      "NP_CONGAREE": { name: "Congaree National Park", lat: 33.7948, lon: -80.7821, type: "national_park", region: "southeast", alt: 500, desc: "Old-growth floodplain" },
      "NP_CRATER_LAKE": { name: "Crater Lake National Park", lat: 42.9446, lon: -122.1090, type: "national_park", region: "pacific", alt: 8000, desc: "Crater Lake rim" },
      "NP_CUYAHOGA": { name: "Cuyahoga Valley National Park", lat: 41.2808, lon: -81.5678, type: "national_park", region: "midwest", alt: 1200, desc: "Brandywine Falls" },
      "NP_DEATH_VALLEY": { name: "Death Valley National Park", lat: 36.5054, lon: -117.0794, type: "national_park", region: "pacific", alt: 3000, desc: "Badwater Basin area" },
      "NP_DENALI": { name: "Denali National Park", lat: 63.1148, lon: -151.1926, type: "national_park", region: "alaska", alt: 12000, desc: "Denali summit view" },
      "NP_DRY_TORTUGAS": { name: "Dry Tortugas National Park", lat: 24.6285, lon: -82.8732, type: "national_park", region: "southeast", alt: 500, desc: "Fort Jefferson" },
      "NP_EVERGLADES": { name: "Everglades National Park", lat: 25.2866, lon: -80.8987, type: "national_park", region: "southeast", alt: 500, desc: "Shark Valley" },
      "NP_GATEWAY_ARCH": { name: "Gateway Arch National Park", lat: 38.6247, lon: -90.1848, type: "national_park", region: "midwest", alt: 800, desc: "Gateway Arch" },
      "NP_GLACIER": { name: "Glacier National Park", lat: 48.7596, lon: -113.7870, type: "national_park", region: "mountain", alt: 7000, desc: "Going-to-the-Sun Road" },
      "NP_GLACIER_BAY": { name: "Glacier Bay National Park", lat: 58.5000, lon: -137.0000, type: "national_park", region: "alaska", alt: 2000, desc: "Margerie Glacier" },
      "NP_GRAND_CANYON": { name: "Grand Canyon National Park", lat: 36.0544, lon: -112.1401, type: "national_park", region: "southwest", alt: 7500, desc: "South Rim Village" },
      "NP_GRAND_TETON": { name: "Grand Teton National Park", lat: 43.7904, lon: -110.6818, type: "national_park", region: "mountain", alt: 8000, desc: "Jenny Lake" },
      "NP_GREAT_BASIN": { name: "Great Basin National Park", lat: 38.9833, lon: -114.3000, type: "national_park", region: "mountain", alt: 8000, desc: "Wheeler Peak" },
      "NP_GREAT_SAND_DUNES": { name: "Great Sand Dunes National Park", lat: 37.7500, lon: -105.5117, type: "national_park", region: "mountain", alt: 8500, desc: "Star Dune" },
      "NP_GREAT_SMOKY": { name: "Great Smoky Mountains National Park", lat: 35.6532, lon: -83.5070, type: "national_park", region: "southeast", alt: 5500, desc: "Clingmans Dome" },
      "NP_GUADALUPE": { name: "Guadalupe Mountains National Park", lat: 31.8913, lon: -104.8606, type: "national_park", region: "southwest", alt: 6500, desc: "Guadalupe Peak" },
      "NP_HALEAKALA": { name: "Haleakala National Park", lat: 20.7097, lon: -156.1731, type: "national_park", region: "pacific", alt: 10000, desc: "Haleakala crater" },
      "NP_HAWAII_VOLCANOES": { name: "Hawaii Volcanoes National Park", lat: 19.4194, lon: -155.2885, type: "national_park", region: "pacific", alt: 4000, desc: "Kilauea Caldera" },
      "NP_HOT_SPRINGS": { name: "Hot Springs National Park", lat: 34.5217, lon: -93.0424, type: "national_park", region: "southeast", alt: 1200, desc: "Bathhouse Row" },
      "NP_INDIANA_DUNES": { name: "Indiana Dunes National Park", lat: 41.6533, lon: -87.0524, type: "national_park", region: "midwest", alt: 800, desc: "Lake Michigan shore" },
      "NP_ISLE_ROYALE": { name: "Isle Royale National Park", lat: 48.0000, lon: -88.8333, type: "national_park", region: "midwest", alt: 1500, desc: "Isle Royale" },
      "NP_JOSHUA_TREE": { name: "Joshua Tree National Park", lat: 33.8734, lon: -115.9010, type: "national_park", region: "pacific", alt: 4500, desc: "Hidden Valley" },
      "NP_KATMAI": { name: "Katmai National Park", lat: 58.5970, lon: -154.6939, type: "national_park", region: "alaska", alt: 2000, desc: "Brooks Falls" },
      "NP_KENAI_FJORDS": { name: "Kenai Fjords National Park", lat: 59.9225, lon: -149.6525, type: "national_park", region: "alaska", alt: 2000, desc: "Exit Glacier" },
      "NP_KINGS_CANYON": { name: "Kings Canyon National Park", lat: 36.8879, lon: -118.5551, type: "national_park", region: "pacific", alt: 7000, desc: "Kings Canyon" },
      "NP_KOBUK_VALLEY": { name: "Kobuk Valley National Park", lat: 67.3556, lon: -159.1289, type: "national_park", region: "alaska", alt: 500, desc: "Great Kobuk Sand Dunes" },
      "NP_LAKE_CLARK": { name: "Lake Clark National Park", lat: 60.4127, lon: -154.3235, type: "national_park", region: "alaska", alt: 3000, desc: "Lake Clark" },
      "NP_LASSEN": { name: "Lassen Volcanic National Park", lat: 40.4977, lon: -121.5080, type: "national_park", region: "pacific", alt: 8500, desc: "Lassen Peak" },
      "NP_MAMMOTH_CAVE": { name: "Mammoth Cave National Park", lat: 37.1870, lon: -86.1004, type: "national_park", region: "southeast", alt: 800, desc: "Cave entrance" },
      "NP_MESA_VERDE": { name: "Mesa Verde National Park", lat: 37.2309, lon: -108.4618, type: "national_park", region: "southwest", alt: 7500, desc: "Cliff Palace" },
      "NP_MOUNT_RAINIER": { name: "Mount Rainier National Park", lat: 46.8800, lon: -121.7269, type: "national_park", region: "pacific", alt: 10000, desc: "Paradise area" },
      "NP_NEW_RIVER_GORGE": { name: "New River Gorge National Park", lat: 38.0659, lon: -81.0837, type: "national_park", region: "southeast", alt: 2500, desc: "New River Gorge Bridge" },
      "NP_NORTH_CASCADES": { name: "North Cascades National Park", lat: 48.7718, lon: -121.2985, type: "national_park", region: "pacific", alt: 6000, desc: "Cascade Pass" },
      "NP_OLYMPIC": { name: "Olympic National Park", lat: 47.8021, lon: -123.6044, type: "national_park", region: "pacific", alt: 5000, desc: "Hurricane Ridge" },
      "NP_PETRIFIED_FOREST": { name: "Petrified Forest National Park", lat: 34.9100, lon: -109.8068, type: "national_park", region: "southwest", alt: 5800, desc: "Blue Mesa" },
      "NP_PINNACLES": { name: "Pinnacles National Park", lat: 36.4906, lon: -121.1825, type: "national_park", region: "pacific", alt: 2500, desc: "High Peaks" },
      "NP_REDWOOD": { name: "Redwood National Park", lat: 41.2132, lon: -124.0046, type: "national_park", region: "pacific", alt: 1500, desc: "Tall Trees Grove" },
      "NP_ROCKY_MOUNTAIN": { name: "Rocky Mountain National Park", lat: 40.3428, lon: -105.6836, type: "national_park", region: "mountain", alt: 12000, desc: "Trail Ridge Road" },
      "NP_SAGUARO": { name: "Saguaro National Park", lat: 32.2967, lon: -111.1666, type: "national_park", region: "southwest", alt: 4000, desc: "Saguaro forest" },
      "NP_SEQUOIA": { name: "Sequoia National Park", lat: 36.4864, lon: -118.5658, type: "national_park", region: "pacific", alt: 7000, desc: "General Sherman Tree" },
      "NP_SHENANDOAH": { name: "Shenandoah National Park", lat: 38.2928, lon: -78.6796, type: "national_park", region: "southeast", alt: 4000, desc: "Skyline Drive" },
      "NP_THEODORE_ROOSEVELT": { name: "Theodore Roosevelt National Park", lat: 46.9790, lon: -103.5387, type: "national_park", region: "midwest", alt: 2800, desc: "Painted Canyon" },
      "NP_VIRGIN_ISLANDS": { name: "Virgin Islands National Park", lat: 18.3358, lon: -64.7281, type: "national_park", region: "southeast", alt: 500, desc: "Trunk Bay" },
      "NP_VOYAGEURS": { name: "Voyageurs National Park", lat: 48.5000, lon: -92.8333, type: "national_park", region: "midwest", alt: 1500, desc: "Rainy Lake" },
      "NP_WHITE_SANDS": { name: "White Sands National Park", lat: 32.7872, lon: -106.3257, type: "national_park", region: "southwest", alt: 4500, desc: "Gypsum dunes" },
      "NP_WIND_CAVE": { name: "Wind Cave National Park", lat: 43.5724, lon: -103.4839, type: "national_park", region: "midwest", alt: 4500, desc: "Cave entrance" },
      "NP_WRANGELL": { name: "Wrangell-St. Elias National Park", lat: 61.4, lon: -142.0, type: "national_park", region: "alaska", alt: 8000, desc: "Kennicott Glacier" },
      "NP_YELLOWSTONE": { name: "Yellowstone National Park", lat: 44.4280, lon: -110.5885, type: "national_park", region: "mountain", alt: 8000, desc: "Old Faithful" },
      "NP_YOSEMITE": { name: "Yosemite National Park", lat: 37.8651, lon: -119.5383, type: "national_park", region: "pacific", alt: 7000, desc: "Yosemite Valley" },
      "NP_ZION": { name: "Zion National Park", lat: 37.2982, lon: -113.0263, type: "national_park", region: "southwest", alt: 6000, desc: "Zion Canyon" },
      "NP_CA_BANFF": { name: "Banff National Park", lat: 51.4968, lon: -115.9281, type: "national_park", region: "canada_west", alt: 6500, desc: "Lake Louise" },
      "NP_CA_JASPER": { name: "Jasper National Park", lat: 52.8734, lon: -117.9543, type: "national_park", region: "canada_west", alt: 5500, desc: "Columbia Icefield" },
      "NP_CA_YOHO": { name: "Yoho National Park", lat: 51.4667, lon: -116.5167, type: "national_park", region: "canada_west", alt: 5500, desc: "Emerald Lake" },
      "NP_CA_KOOTENAY": { name: "Kootenay National Park", lat: 50.8833, lon: -116.05, type: "national_park", region: "canada_west", alt: 5000, desc: "Radium Hot Springs" },
      "NP_CA_WATERTON": { name: "Waterton Lakes National Park", lat: 49.05, lon: -113.9, type: "national_park", region: "canada_west", alt: 5500, desc: "Prince of Wales Hotel" },
      "NP_CA_GLACIER": { name: "Glacier National Park (Canada)", lat: 51.3, lon: -117.5167, type: "national_park", region: "canada_west", alt: 5000, desc: "Rogers Pass" },
      "NP_CA_REVELSTOKE": { name: "Mount Revelstoke National Park", lat: 51.0833, lon: -118.05, type: "national_park", region: "canada_west", alt: 6000, desc: "Meadows in the Sky" },
      "NP_CA_PACIFIC_RIM": { name: "Pacific Rim National Park", lat: 49.0, lon: -125.7333, type: "national_park", region: "canada_west", alt: 500, desc: "Long Beach" },
      "NP_CA_GULF_ISLANDS": { name: "Gulf Islands National Park", lat: 48.8333, lon: -123.4167, type: "national_park", region: "canada_west", alt: 500, desc: "Sidney Island" },
      "NP_CA_GWAII_HAANAS": { name: "Gwaii Haanas National Park", lat: 52.3833, lon: -131.4667, type: "national_park", region: "canada_west", alt: 500, desc: "SGang Gwaay" },
      "NP_CA_ELK_ISLAND": { name: "Elk Island National Park", lat: 53.6167, lon: -112.8667, type: "national_park", region: "canada_west", alt: 2500, desc: "Bison plains" },
      "NP_CA_WOOD_BUFFALO": { name: "Wood Buffalo National Park", lat: 59.4, lon: -112.9167, type: "national_park", region: "canada_north", alt: 1000, desc: "Peace-Athabasca Delta" },
      "NP_CA_NAHANNI": { name: "Nahanni National Park", lat: 61.5, lon: -125.5, type: "national_park", region: "canada_north", alt: 3000, desc: "Virginia Falls" },
      "NP_CA_TUKTUT": { name: "Tuktut Nogait National Park", lat: 69.25, lon: -121.5, type: "national_park", region: "canada_north", alt: 1000, desc: "Hornaday River" },
      "NP_CA_AULAVIK": { name: "Aulavik National Park", lat: 73.7, lon: -119.9167, type: "national_park", region: "canada_north", alt: 500, desc: "Banks Island tundra" },
      "NP_CA_IVVAVIK": { name: "Ivvavik National Park", lat: 69.5, lon: -139.5, type: "national_park", region: "canada_north", alt: 2000, desc: "British Mountains" },
      "NP_CA_VUNTUT": { name: "Vuntut National Park", lat: 68.3333, lon: -139.8333, type: "national_park", region: "canada_north", alt: 1500, desc: "Old Crow Flats" },
      "NP_CA_KLUANE": { name: "Kluane National Park", lat: 60.75, lon: -138.5, type: "national_park", region: "canada_north", alt: 8000, desc: "Mount Logan area" },
      "NP_CA_PRINCE_ALBERT": { name: "Prince Albert National Park", lat: 53.9667, lon: -106.1, type: "national_park", region: "canada_central", alt: 1800, desc: "Grey Owl's cabin" },
      "NP_CA_GRASSLANDS": { name: "Grasslands National Park", lat: 49.1333, lon: -107.4167, type: "national_park", region: "canada_central", alt: 3000, desc: "Frenchman Valley" },
      "NP_CA_RIDING_MOUNTAIN": { name: "Riding Mountain National Park", lat: 50.8667, lon: -99.95, type: "national_park", region: "canada_central", alt: 2300, desc: "Clear Lake" },
      "NP_CA_WAPUSK": { name: "Wapusk National Park", lat: 57.2667, lon: -93.2833, type: "national_park", region: "canada_central", alt: 100, desc: "Polar bear habitat" },
      "NP_CA_PUKASKWA": { name: "Pukaskwa National Park", lat: 48.1, lon: -85.8833, type: "national_park", region: "canada_central", alt: 1000, desc: "Lake Superior shore" },
      "NP_CA_BRUCE_PENINSULA": { name: "Bruce Peninsula National Park", lat: 45.2333, lon: -81.5167, type: "national_park", region: "canada_central", alt: 800, desc: "Grotto" },
      "NP_CA_GEORGIAN_BAY": { name: "Georgian Bay Islands National Park", lat: 44.8833, lon: -79.8667, type: "national_park", region: "canada_central", alt: 700, desc: "Beausoleil Island" },
      "NP_CA_POINT_PELEE": { name: "Point Pelee National Park", lat: 41.9667, lon: -82.5167, type: "national_park", region: "canada_central", alt: 600, desc: "Southernmost point" },
      "NP_CA_THOUSAND_ISLANDS": { name: "Thousand Islands National Park", lat: 44.4, lon: -75.9333, type: "national_park", region: "canada_east", alt: 500, desc: "St. Lawrence Islands" },
      "NP_CA_LA_MAURICIE": { name: "La Mauricie National Park", lat: 46.8167, lon: -72.9833, type: "national_park", region: "canada_east", alt: 1200, desc: "Wapizagonke Lake" },
      "NP_CA_FORILLON": { name: "Forillon National Park", lat: 48.8333, lon: -64.35, type: "national_park", region: "canada_east", alt: 800, desc: "Cap Bon-Ami" },
      "NP_CA_MINGAN": { name: "Mingan Archipelago National Park", lat: 50.2667, lon: -63.5833, type: "national_park", region: "canada_east", alt: 200, desc: "Limestone monoliths" },
      "NP_CA_KOUCHIBOUGUAC": { name: "Kouchibouguac National Park", lat: 46.8333, lon: -64.9667, type: "national_park", region: "canada_east", alt: 100, desc: "Barrier islands" },
      "NP_CA_FUNDY": { name: "Fundy National Park", lat: 45.6, lon: -65.0333, type: "national_park", region: "canada_east", alt: 1000, desc: "Bay of Fundy tides" },
      "NP_CA_PEI": { name: "Prince Edward Island National Park", lat: 46.4167, lon: -63.0833, type: "national_park", region: "canada_east", alt: 100, desc: "Cavendish Beach" },
      "NP_CA_KEJIMKUJIK": { name: "Kejimkujik National Park", lat: 44.4, lon: -65.2167, type: "national_park", region: "canada_east", alt: 400, desc: "Mersey River" },
      "NP_CA_CAPE_BRETON": { name: "Cape Breton Highlands National Park", lat: 46.7333, lon: -60.8333, type: "national_park", region: "canada_east", alt: 1500, desc: "Cabot Trail" },
      "NP_CA_GROS_MORNE": { name: "Gros Morne National Park", lat: 49.6, lon: -57.8, type: "national_park", region: "canada_east", alt: 2600, desc: "Western Brook Pond" },
      "NP_CA_TERRA_NOVA": { name: "Terra Nova National Park", lat: 48.55, lon: -53.9667, type: "national_park", region: "canada_east", alt: 500, desc: "Newman Sound" },
      "NP_CA_TORNGAT": { name: "Torngat Mountains National Park", lat: 59.0, lon: -63.5, type: "national_park", region: "canada_east", alt: 5000, desc: "Mount Caubvick" },
      "NP_CA_AUYUITTUQ": { name: "Auyuittuq National Park", lat: 67.8833, lon: -65.0, type: "national_park", region: "canada_north", alt: 6000, desc: "Mount Thor" },
      "NP_CA_SIRMILIK": { name: "Sirmilik National Park", lat: 72.8333, lon: -80.0, type: "national_park", region: "canada_north", alt: 2000, desc: "Bylot Island" },
      "NP_CA_QUTTINIRPAAQ": { name: "Quttinirpaaq National Park", lat: 82.1167, lon: -69.3333, type: "national_park", region: "canada_north", alt: 3000, desc: "Lake Hazen" },
      "NP_CA_UKKUSIKSALIK": { name: "Ukkusiksalik National Park", lat: 65.5, lon: -87.0833, type: "national_park", region: "canada_north", alt: 500, desc: "Wager Bay" },
      "NAT_NIAGARA_FALLS": { name: "Niagara Falls", lat: 43.0962, lon: -79.0377, type: "waterfall", region: "northeast", alt: 800, desc: "Horseshoe Falls" },
      "NAT_GRAND_PRISMATIC": { name: "Grand Prismatic Spring", lat: 44.5251, lon: -110.8380, type: "geothermal", region: "mountain", alt: 7500, desc: "Largest hot spring in US" },
      "NAT_MONUMENT_VALLEY": { name: "Monument Valley", lat: 36.9980, lon: -110.0985, type: "natural", region: "southwest", alt: 5500, desc: "Mittens Buttes" },
      "NAT_DEVILS_TOWER": { name: "Devils Tower", lat: 44.5902, lon: -104.7146, type: "natural", region: "mountain", alt: 5200, desc: "Volcanic neck" },
      "NAT_METEOR_CRATER": { name: "Meteor Crater", lat: 35.0275, lon: -111.0228, type: "natural", region: "southwest", alt: 5700, desc: "Barringer Crater" },
      "NAT_OLD_FAITHFUL": { name: "Old Faithful Geyser", lat: 44.4605, lon: -110.8281, type: "geothermal", region: "mountain", alt: 7400, desc: "Famous geyser" },
      "NAT_HORSESHOE_BEND": { name: "Horseshoe Bend", lat: 36.8791, lon: -111.5104, type: "natural", region: "southwest", alt: 4500, desc: "Colorado River meander" },
      "NAT_ANTELOPE_CANYON": { name: "Antelope Canyon", lat: 36.8619, lon: -111.3743, type: "natural", region: "southwest", alt: 4200, desc: "Slot canyon" },
      "NAT_MULTNOMAH_FALLS": { name: "Multnomah Falls", lat: 45.5762, lon: -122.1158, type: "waterfall", region: "pacific", alt: 800, desc: "620-foot waterfall" },
      "NAT_RUBY_FALLS": { name: "Ruby Falls", lat: 35.0189, lon: -85.3394, type: "waterfall", region: "southeast", alt: 1500, desc: "Underground waterfall" },
      "NAT_MAMMOTH_HOT_SPRINGS": { name: "Mammoth Hot Springs", lat: 44.9631, lon: -110.7008, type: "geothermal", region: "mountain", alt: 6200, desc: "Travertine terraces" },
      "NAT_RAINBOW_BRIDGE": { name: "Rainbow Bridge", lat: 37.0778, lon: -110.9643, type: "natural", region: "southwest", alt: 3800, desc: "Natural bridge" },
      "NAT_NATURAL_BRIDGE_VA": { name: "Natural Bridge", lat: 37.6285, lon: -79.5438, type: "natural", region: "southeast", alt: 1200, desc: "215-foot natural arch" },
      "NAT_PIKES_PEAK": { name: "Pikes Peak", lat: 38.8409, lon: -105.0423, type: "mountain", region: "mountain", alt: 14115, desc: "Americas Mountain" },
      "NAT_MOUNT_WHITNEY": { name: "Mount Whitney", lat: 36.5785, lon: -118.2923, type: "mountain", region: "pacific", alt: 14505, desc: "Highest in lower 48" },
      "NAT_MOUNT_HOOD": { name: "Mount Hood", lat: 45.3735, lon: -121.6959, type: "mountain", region: "pacific", alt: 11249, desc: "Oregon's highest peak" },
      "NAT_MOUNT_SHASTA": { name: "Mount Shasta", lat: 41.4092, lon: -122.1949, type: "mountain", region: "pacific", alt: 14179, desc: "Volcanic peak" },
      "NAT_MOUNT_ST_HELENS": { name: "Mount St. Helens", lat: 46.1912, lon: -122.1944, type: "mountain", region: "pacific", alt: 8366, desc: "Active volcano" },
      "NAT_LAKE_TAHOE": { name: "Lake Tahoe", lat: 39.0968, lon: -120.0324, type: "lake", region: "pacific", alt: 6500, desc: "Alpine lake" },
      "NAT_MONO_LAKE": { name: "Mono Lake", lat: 37.9994, lon: -119.0128, type: "lake", region: "pacific", alt: 6500, desc: "Tufa towers" },
      "NAT_GREAT_SALT_LAKE": { name: "Great Salt Lake", lat: 41.0, lon: -112.5, type: "lake", region: "mountain", alt: 4200, desc: "Largest salt lake" },
      "NAT_FLATHEAD_LAKE": { name: "Flathead Lake", lat: 47.9, lon: -114.1167, type: "lake", region: "mountain", alt: 2900, desc: "Largest natural freshwater lake west of Mississippi" },
      "NAT_LAKE_POWELL": { name: "Lake Powell", lat: 37.0683, lon: -111.2433, type: "lake", region: "southwest", alt: 3700, desc: "Glen Canyon" },
      "NAT_LAKE_MEAD": { name: "Lake Mead", lat: 36.1456, lon: -114.3903, type: "lake", region: "southwest", alt: 1200, desc: "Hoover Dam reservoir" },
      "NAT_OKEFENOKEE": { name: "Okefenokee Swamp", lat: 30.7416, lon: -82.2810, type: "natural", region: "southeast", alt: 200, desc: "Blackwater swamp" },
      "NAT_BONNEVILLE_FLATS": { name: "Bonneville Salt Flats", lat: 40.7580, lon: -113.8786, type: "natural", region: "mountain", alt: 4200, desc: "Salt flats" },
      "NAT_PAINTED_DESERT": { name: "Painted Desert", lat: 35.0676, lon: -109.7817, type: "natural", region: "southwest", alt: 5500, desc: "Colorful badlands" },
      "NAT_BISTI_BADLANDS": { name: "Bisti Badlands", lat: 36.2403, lon: -108.2503, type: "natural", region: "southwest", alt: 5800, desc: "Hoodoo formations" },
      "NAT_WAVE_AZ": { name: "The Wave", lat: 36.9958, lon: -112.0064, type: "natural", region: "southwest", alt: 5200, desc: "Sandstone formation" },
      "NAT_CARLSBAD_BATS": { name: "Carlsbad Caverns Bat Flight", lat: 32.1757, lon: -104.4459, type: "natural", region: "southwest", alt: 4400, desc: "Evening bat emergence" },
      "NAT_CHIMNEY_ROCK": { name: "Chimney Rock", lat: 41.2261, lon: -103.3482, type: "natural", region: "midwest", alt: 4300, desc: "Nebraska landmark" },
      "NAT_SCOTTS_BLUFF": { name: "Scotts Bluff", lat: 41.8361, lon: -103.7083, type: "natural", region: "midwest", alt: 4600, desc: "Oregon Trail landmark" },
      "NAT_INDEPENDENCE_ROCK": { name: "Independence Rock", lat: 42.4930, lon: -107.1299, type: "natural", region: "mountain", alt: 5900, desc: "Oregon Trail register" },
      "NAT_SHIP_ROCK": { name: "Shiprock", lat: 36.6875, lon: -108.8367, type: "natural", region: "southwest", alt: 7200, desc: "Volcanic neck" },
      "NAT_ENCHANTED_ROCK": { name: "Enchanted Rock", lat: 30.5066, lon: -98.8200, type: "natural", region: "southwest", alt: 1900, desc: "Pink granite dome" },
      "NAT_DEVILS_POSTPILE": { name: "Devils Postpile", lat: 37.6244, lon: -119.0847, type: "natural", region: "pacific", alt: 7600, desc: "Columnar basalt" },
      "NAT_GIANT_SEQUOIA": { name: "Giant Forest", lat: 36.5649, lon: -118.7511, type: "natural", region: "pacific", alt: 6500, desc: "Giant sequoia grove" },
      "NAT_REDWOOD_GROVE": { name: "Avenue of the Giants", lat: 40.3551, lon: -123.9215, type: "natural", region: "pacific", alt: 300, desc: "Old-growth redwoods" },
      "NAT_BIG_SUR": { name: "Big Sur", lat: 36.2704, lon: -121.8081, type: "natural", region: "pacific", alt: 500, desc: "Coastal cliffs" },
      "NAT_POINT_REYES": { name: "Point Reyes", lat: 38.0422, lon: -122.9988, type: "natural", region: "pacific", alt: 500, desc: "Lighthouse peninsula" },
      "NAT_CAPE_FLATTERY": { name: "Cape Flattery", lat: 48.3833, lon: -124.7167, type: "natural", region: "pacific", alt: 200, desc: "Northwestern tip of US" },
      "NAT_OREGON_DUNES": { name: "Oregon Dunes", lat: 43.8387, lon: -124.1537, type: "natural", region: "pacific", alt: 200, desc: "Coastal sand dunes" },
      "NAT_COLUMBIA_GORGE": { name: "Columbia River Gorge", lat: 45.7117, lon: -121.5197, type: "natural", region: "pacific", alt: 800, desc: "Scenic gorge" },
      "NAT_HELLS_CANYON": { name: "Hells Canyon", lat: 45.3500, lon: -116.6833, type: "natural", region: "pacific", alt: 4000, desc: "Deepest river gorge" },
      "NAT_CRATERS_MOON": { name: "Craters of the Moon", lat: 43.4167, lon: -113.5167, type: "natural", region: "mountain", alt: 5900, desc: "Volcanic field" },
      "NAT_SAWTOOTH_RANGE": { name: "Sawtooth Mountains", lat: 44.1333, lon: -114.9333, type: "mountain", region: "mountain", alt: 10000, desc: "Jagged peaks" },
      "NAT_SNAKE_RIVER_CANYON": { name: "Snake River Canyon", lat: 42.5970, lon: -114.4578, type: "natural", region: "mountain", alt: 3600, desc: "Twin Falls" },
      "NAT_SHOSHONE_FALLS": { name: "Shoshone Falls", lat: 42.5936, lon: -114.4003, type: "waterfall", region: "mountain", alt: 3500, desc: "Niagara of the West" },
      "NAT_MESA_FALLS": { name: "Mesa Falls", lat: 44.1944, lon: -111.3175, type: "waterfall", region: "mountain", alt: 6200, desc: "Upper and Lower Falls" },
      "NAT_PALOUSE_FALLS": { name: "Palouse Falls", lat: 46.6639, lon: -118.2278, type: "waterfall", region: "pacific", alt: 1000, desc: "200-foot falls" },
      "NAT_SNOQUALMIE_FALLS": { name: "Snoqualmie Falls", lat: 47.5417, lon: -121.8378, type: "waterfall", region: "pacific", alt: 600, desc: "268-foot falls" },
      "NAT_HAVASU_FALLS": { name: "Havasu Falls", lat: 36.2552, lon: -112.6979, type: "waterfall", region: "southwest", alt: 3500, desc: "Blue-green falls" },
      "NAT_LOWER_FALLS_YNP": { name: "Lower Falls of Yellowstone", lat: 44.7177, lon: -110.4971, type: "waterfall", region: "mountain", alt: 7700, desc: "308-foot falls" },
      "NAT_TOWER_FALL": { name: "Tower Fall", lat: 44.8930, lon: -110.3882, type: "waterfall", region: "mountain", alt: 6600, desc: "132-foot falls" },
      "NAT_BURNEY_FALLS": { name: "Burney Falls", lat: 41.0128, lon: -121.6511, type: "waterfall", region: "pacific", alt: 3000, desc: "129-foot falls" },
      "NAT_YOSEMITE_FALLS": { name: "Yosemite Falls", lat: 37.7566, lon: -119.5969, type: "waterfall", region: "pacific", alt: 4000, desc: "2425-foot total drop" },
      "NAT_BRIDALVEIL_FALL": { name: "Bridalveil Fall", lat: 37.7166, lon: -119.6466, type: "waterfall", region: "pacific", alt: 4000, desc: "617-foot falls" },
      "NAT_HALF_DOME": { name: "Half Dome", lat: 37.7459, lon: -119.5332, type: "mountain", region: "pacific", alt: 8846, desc: "Iconic granite dome" },
      "NAT_EL_CAPITAN": { name: "El Capitan", lat: 37.7341, lon: -119.6377, type: "mountain", region: "pacific", alt: 7573, desc: "Granite monolith" },
      "NAT_MAROON_BELLS": { name: "Maroon Bells", lat: 39.0708, lon: -106.9891, type: "mountain", region: "mountain", alt: 14163, desc: "Iconic Colorado peaks" },
      "NAT_LONGS_PEAK": { name: "Longs Peak", lat: 40.2550, lon: -105.6151, type: "mountain", region: "mountain", alt: 14259, desc: "Colorado fourteener" },
      "NAT_MOUNT_EVANS": { name: "Mount Evans", lat: 39.5883, lon: -105.6438, type: "mountain", region: "mountain", alt: 14271, desc: "Highest paved road" },
      "NAT_MOUNT_ELBERT": { name: "Mount Elbert", lat: 39.1178, lon: -106.4453, type: "mountain", region: "mountain", alt: 14440, desc: "Highest in Colorado" },
      "NAT_SANGRE_DE_CRISTO": { name: "Sangre de Cristo Mountains", lat: 37.5833, lon: -105.5167, type: "mountain", region: "mountain", alt: 14000, desc: "Southern Rockies" },
      "NAT_WHEELER_PEAK_NM": { name: "Wheeler Peak NM", lat: 36.5567, lon: -105.4169, type: "mountain", region: "southwest", alt: 13167, desc: "Highest in New Mexico" },
      "NAT_SANDIA_PEAK": { name: "Sandia Peak", lat: 35.2103, lon: -106.4486, type: "mountain", region: "southwest", alt: 10678, desc: "Albuquerque backdrop" },
      "NAT_MOUNT_LEMMON": { name: "Mount Lemmon", lat: 32.4433, lon: -110.7881, type: "mountain", region: "southwest", alt: 9159, desc: "Sky Island" },
      "NAT_HUMPHREYS_PEAK": { name: "Humphreys Peak", lat: 35.3464, lon: -111.6781, type: "mountain", region: "southwest", alt: 12637, desc: "Highest in Arizona" },
      "NAT_SAN_FRANCISCO_PEAKS": { name: "San Francisco Peaks", lat: 35.35, lon: -111.6783, type: "mountain", region: "southwest", alt: 12000, desc: "Volcanic field" },
      "NAT_MOUNT_WASHINGTON": { name: "Mount Washington", lat: 44.2706, lon: -71.3033, type: "mountain", region: "northeast", alt: 6288, desc: "Highest in Northeast" },
      "NAT_MOUNT_KATAHDIN": { name: "Mount Katahdin", lat: 45.9044, lon: -68.9214, type: "mountain", region: "northeast", alt: 5269, desc: "Northern AT terminus" },
      "NAT_MOUNT_MANSFIELD": { name: "Mount Mansfield", lat: 44.5436, lon: -72.8144, type: "mountain", region: "northeast", alt: 4395, desc: "Highest in Vermont" },
      "NAT_MOUNT_MARCY": { name: "Mount Marcy", lat: 44.1128, lon: -73.9236, type: "mountain", region: "northeast", alt: 5344, desc: "Highest in New York" },
      "NAT_CLINGMANS_DOME": { name: "Clingmans Dome", lat: 35.5629, lon: -83.4985, type: "mountain", region: "southeast", alt: 6643, desc: "Highest in Smokies" },
      "NAT_MOUNT_MITCHELL": { name: "Mount Mitchell", lat: 35.7649, lon: -82.2651, type: "mountain", region: "southeast", alt: 6684, desc: "Highest east of Mississippi" },
      "NAT_LOOKING_GLASS_ROCK": { name: "Looking Glass Rock", lat: 35.2950, lon: -82.7853, type: "natural", region: "southeast", alt: 4000, desc: "Granite pluton" },
      "NAT_TABLE_ROCK": { name: "Table Rock", lat: 35.0303, lon: -82.5978, type: "mountain", region: "southeast", alt: 3157, desc: "Blue Ridge cliff" },
      "NAT_GRANDFATHER_MTN": { name: "Grandfather Mountain", lat: 36.1092, lon: -81.8328, type: "mountain", region: "southeast", alt: 5964, desc: "Mile High Swinging Bridge" },
      "NAT_STONE_MOUNTAIN": { name: "Stone Mountain", lat: 33.8053, lon: -84.1453, type: "natural", region: "southeast", alt: 1700, desc: "Granite monadnock" },
      "NAT_CADILLAC_MOUNTAIN": { name: "Cadillac Mountain", lat: 44.3525, lon: -68.2256, type: "mountain", region: "northeast", alt: 1530, desc: "First sunrise in US" },
      "NAT_CAPE_COD": { name: "Cape Cod", lat: 41.7003, lon: -70.0331, type: "natural", region: "northeast", alt: 100, desc: "Hook-shaped peninsula" },
      "NAT_BLOCK_ISLAND": { name: "Block Island", lat: 41.1733, lon: -71.5800, type: "natural", region: "northeast", alt: 200, desc: "Mohegan Bluffs" },
      "NAT_MONTAUK_POINT": { name: "Montauk Point", lat: 41.0708, lon: -71.8572, type: "natural", region: "northeast", alt: 100, desc: "Eastern tip Long Island" },
      "NAT_SLEEPING_BEAR": { name: "Sleeping Bear Dunes", lat: 44.8654, lon: -86.0559, type: "natural", region: "midwest", alt: 800, desc: "Perched dunes" },
      "NAT_PICTURED_ROCKS": { name: "Pictured Rocks", lat: 46.5667, lon: -86.3333, type: "natural", region: "midwest", alt: 700, desc: "Colorful cliffs" },
      "NAT_APOSTLE_ISLANDS": { name: "Apostle Islands", lat: 46.9667, lon: -90.6667, type: "natural", region: "midwest", alt: 700, desc: "Sea caves" },
      "NAT_DOOR_COUNTY": { name: "Door County Peninsula", lat: 45.0833, lon: -87.1667, type: "natural", region: "midwest", alt: 700, desc: "Wisconsin peninsula" },
      "NAT_STARVED_ROCK": { name: "Starved Rock", lat: 41.3200, lon: -88.9936, type: "natural", region: "midwest", alt: 700, desc: "Sandstone canyons" },
      "NAT_GARDEN_OF_GODS": { name: "Garden of the Gods", lat: 38.8792, lon: -104.8703, type: "natural", region: "mountain", alt: 6500, desc: "Red rock formations" },
      "NAT_FLORISSANT_FOSSILS": { name: "Florissant Fossil Beds", lat: 38.9142, lon: -105.2811, type: "natural", region: "mountain", alt: 8500, desc: "Petrified redwoods" },
      "NAT_BLACK_HILLS": { name: "Black Hills", lat: 43.8667, lon: -103.4500, type: "natural", region: "midwest", alt: 6000, desc: "Sacred mountains" },
      "NAT_NEEDLES_HWY": { name: "Needles Highway", lat: 43.7833, lon: -103.4833, type: "natural", region: "midwest", alt: 5500, desc: "Granite spires" },
      "NAT_SPEARFISH_CANYON": { name: "Spearfish Canyon", lat: 44.4000, lon: -103.8500, type: "natural", region: "midwest", alt: 4500, desc: "Limestone canyon" },
      "MON_STATUE_LIBERTY": { name: "Statue of Liberty", lat: 40.6892, lon: -74.0445, type: "monument", region: "northeast", alt: 500, desc: "Liberty Island" },
      "MON_WASHINGTON": { name: "Washington Monument", lat: 38.8895, lon: -77.0353, type: "monument", region: "northeast", alt: 600, desc: "National Mall" },
      "MON_LINCOLN": { name: "Lincoln Memorial", lat: 38.8893, lon: -77.0502, type: "monument", region: "northeast", alt: 500, desc: "Reflecting Pool" },
      "MON_JEFFERSON": { name: "Jefferson Memorial", lat: 38.8814, lon: -77.0365, type: "monument", region: "northeast", alt: 500, desc: "Tidal Basin" },
      "MON_MLK": { name: "Martin Luther King Jr Memorial", lat: 38.8862, lon: -77.0442, type: "monument", region: "northeast", alt: 500, desc: "Tidal Basin" },
      "MON_WWII": { name: "WWII Memorial", lat: 38.8894, lon: -77.0404, type: "monument", region: "northeast", alt: 500, desc: "National Mall" },
      "MON_VIETNAM": { name: "Vietnam Veterans Memorial", lat: 38.8912, lon: -77.0478, type: "monument", region: "northeast", alt: 500, desc: "The Wall" },
      "MON_KOREAN": { name: "Korean War Veterans Memorial", lat: 38.8877, lon: -77.0472, type: "monument", region: "northeast", alt: 500, desc: "National Mall" },
      "MON_IWO_JIMA": { name: "Marine Corps War Memorial", lat: 38.8904, lon: -77.0696, type: "monument", region: "northeast", alt: 500, desc: "Iwo Jima Memorial" },
      "MON_ARLINGTON": { name: "Arlington National Cemetery", lat: 38.8783, lon: -77.0687, type: "monument", region: "northeast", alt: 500, desc: "Tomb of Unknown Soldier" },
      "MON_MOUNT_RUSHMORE": { name: "Mount Rushmore", lat: 43.8791, lon: -103.4591, type: "monument", region: "midwest", alt: 5700, desc: "Presidential faces" },
      "MON_CRAZY_HORSE": { name: "Crazy Horse Memorial", lat: 43.8364, lon: -103.6253, type: "monument", region: "midwest", alt: 5800, desc: "Mountain carving in progress" },
      "MON_LIBERTY_BELL": { name: "Liberty Bell", lat: 39.9496, lon: -75.1503, type: "monument", region: "northeast", alt: 500, desc: "Independence Hall area" },
      "MON_INDEPENDENCE_HALL": { name: "Independence Hall", lat: 39.9489, lon: -75.1500, type: "monument", region: "northeast", alt: 500, desc: "Declaration signed here" },
      "MON_BUNKER_HILL": { name: "Bunker Hill Monument", lat: 42.3764, lon: -71.0609, type: "monument", region: "northeast", alt: 500, desc: "Revolutionary War" },
      "MON_USS_ARIZONA": { name: "USS Arizona Memorial", lat: 21.3649, lon: -157.9501, type: "monument", region: "pacific", alt: 100, desc: "Pearl Harbor" },
      "MON_USS_MISSOURI": { name: "USS Missouri", lat: 21.3638, lon: -157.9547, type: "monument", region: "pacific", alt: 100, desc: "Battleship Row" },
      "MON_PEARL_HARBOR": { name: "Pearl Harbor", lat: 21.3645, lon: -157.9389, type: "monument", region: "pacific", alt: 100, desc: "WWII memorial site" },
      "MON_GETTYSBURG": { name: "Gettysburg Battlefield", lat: 39.8107, lon: -77.2310, type: "monument", region: "northeast", alt: 600, desc: "Civil War battlefield" },
      "MON_ANTIETAM": { name: "Antietam Battlefield", lat: 39.4744, lon: -77.7414, type: "monument", region: "northeast", alt: 500, desc: "Civil War battlefield" },
      "MON_VICKSBURG": { name: "Vicksburg Battlefield", lat: 32.3463, lon: -90.8499, type: "monument", region: "southeast", alt: 300, desc: "Civil War siege site" },
      "MON_FORT_SUMTER": { name: "Fort Sumter", lat: 32.7524, lon: -79.8746, type: "monument", region: "southeast", alt: 100, desc: "Civil War start" },
      "MON_ALAMO": { name: "The Alamo", lat: 29.4260, lon: -98.4861, type: "monument", region: "southwest", alt: 700, desc: "Texas revolution" },
      "MON_SAN_JACINTO": { name: "San Jacinto Monument", lat: 29.7499, lon: -95.0801, type: "monument", region: "southwest", alt: 600, desc: "Texas independence" },
      "MON_LITTLE_BIGHORN": { name: "Little Bighorn Battlefield", lat: 45.5697, lon: -107.4284, type: "monument", region: "mountain", alt: 3400, desc: "Custer's Last Stand" },
      "MON_FORT_MCHENRY": { name: "Fort McHenry", lat: 39.2633, lon: -76.5797, type: "monument", region: "northeast", alt: 100, desc: "Star-Spangled Banner" },
      "MON_PLYMOUTH_ROCK": { name: "Plymouth Rock", lat: 41.9584, lon: -70.6620, type: "monument", region: "northeast", alt: 100, desc: "Pilgrim landing" },
      "MON_JAMESTOWN": { name: "Jamestown Settlement", lat: 37.2096, lon: -76.7744, type: "monument", region: "southeast", alt: 100, desc: "First English settlement" },
      "MON_WILLIAMSBURG": { name: "Colonial Williamsburg", lat: 37.2707, lon: -76.7075, type: "monument", region: "southeast", alt: 100, desc: "Colonial capital" },
      "MON_MONTICELLO": { name: "Monticello", lat: 38.0085, lon: -78.4534, type: "monument", region: "southeast", alt: 800, desc: "Jefferson's home" },
      "MON_MOUNT_VERNON": { name: "Mount Vernon", lat: 38.7080, lon: -77.0866, type: "monument", region: "northeast", alt: 200, desc: "Washington's home" },
      "MON_HEARST_CASTLE": { name: "Hearst Castle", lat: 35.6852, lon: -121.1682, type: "monument", region: "pacific", alt: 1600, desc: "Newspaper tycoon estate" },
      "MON_BILTMORE": { name: "Biltmore Estate", lat: 35.5408, lon: -82.5522, type: "monument", region: "southeast", alt: 2100, desc: "Vanderbilt mansion" },
      "MON_ALCATRAZ": { name: "Alcatraz Island", lat: 37.8270, lon: -122.4230, type: "monument", region: "pacific", alt: 200, desc: "Former federal prison" },
      "MON_ELLIS_ISLAND": { name: "Ellis Island", lat: 40.6995, lon: -74.0396, type: "monument", region: "northeast", alt: 100, desc: "Immigration station" },
      "MON_FORT_KNOX": { name: "Fort Knox", lat: 37.9160, lon: -85.9561, type: "monument", region: "southeast", alt: 800, desc: "US Gold Depository" },
      "MON_HOOVER_DAM": { name: "Hoover Dam", lat: 36.0161, lon: -114.7377, type: "dam", region: "southwest", alt: 1500, desc: "Colorado River dam" },
      "MON_GLEN_CANYON_DAM": { name: "Glen Canyon Dam", lat: 36.9375, lon: -111.4858, type: "dam", region: "southwest", alt: 4000, desc: "Lake Powell dam" },
      "MON_GRAND_COULEE": { name: "Grand Coulee Dam", lat: 47.9655, lon: -118.9816, type: "dam", region: "pacific", alt: 1600, desc: "Largest US dam" },
      "MON_SHASTA_DAM": { name: "Shasta Dam", lat: 40.7181, lon: -122.4178, type: "dam", region: "pacific", alt: 1100, desc: "Second tallest dam" },
      "MON_OROVILLE_DAM": { name: "Oroville Dam", lat: 39.5403, lon: -121.4847, type: "dam", region: "pacific", alt: 900, desc: "Tallest US dam" },
      "MON_BONNEVILLE_DAM": { name: "Bonneville Dam", lat: 45.6444, lon: -121.9406, type: "dam", region: "pacific", alt: 200, desc: "Columbia River dam" },
      "MON_KENTUCKY_DAM": { name: "Kentucky Dam", lat: 37.0136, lon: -88.2833, type: "dam", region: "southeast", alt: 400, desc: "TVA dam" },
      "MON_NORRIS_DAM": { name: "Norris Dam", lat: 36.2242, lon: -84.0922, type: "dam", region: "southeast", alt: 1100, desc: "First TVA dam" },
      "MON_FONTANA_DAM": { name: "Fontana Dam", lat: 35.4453, lon: -83.8119, type: "dam", region: "southeast", alt: 1800, desc: "Tallest dam east of Rockies" },
      "MON_SPACE_NEEDLE": { name: "Space Needle", lat: 47.6205, lon: -122.3493, type: "tower", region: "pacific", alt: 700, desc: "Seattle icon" },
      "MON_GATEWAY_ARCH": { name: "Gateway Arch", lat: 38.6247, lon: -90.1848, type: "monument", region: "midwest", alt: 800, desc: "Westward expansion" },
      "MON_COIT_TOWER": { name: "Coit Tower", lat: 37.8024, lon: -122.4058, type: "tower", region: "pacific", alt: 600, desc: "Telegraph Hill" },
      "MON_TRANSAMERICA": { name: "Transamerica Pyramid", lat: 37.7952, lon: -122.4028, type: "tower", region: "pacific", alt: 900, desc: "SF skyline icon" },
      "MON_GOLDEN_GATE": { name: "Golden Gate Bridge", lat: 37.8199, lon: -122.4783, type: "bridge", region: "pacific", alt: 500, desc: "Iconic suspension bridge" },
      "MON_BROOKLYN_BRIDGE": { name: "Brooklyn Bridge", lat: 40.7061, lon: -73.9969, type: "bridge", region: "northeast", alt: 400, desc: "Historic suspension bridge" },
      "MON_GEORGE_WASHINGTON": { name: "George Washington Bridge", lat: 40.8517, lon: -73.9527, type: "bridge", region: "northeast", alt: 600, desc: "Hudson River crossing" },
      "MON_VERRAZANO": { name: "Verrazano-Narrows Bridge", lat: 40.6066, lon: -74.0447, type: "bridge", region: "northeast", alt: 500, desc: "NYC harbor entrance" },
      "MON_MACKINAC": { name: "Mackinac Bridge", lat: 45.8174, lon: -84.7278, type: "bridge", region: "midwest", alt: 600, desc: "Mighty Mac" },
      "MON_CHESAPEAKE_BAY": { name: "Chesapeake Bay Bridge", lat: 38.9931, lon: -76.3803, type: "bridge", region: "northeast", alt: 400, desc: "Bay crossing" },
      "MON_SUNSHINE_SKYWAY": { name: "Sunshine Skyway Bridge", lat: 27.6206, lon: -82.6553, type: "bridge", region: "southeast", alt: 400, desc: "Tampa Bay" },
      "MON_SEVEN_MILE": { name: "Seven Mile Bridge", lat: 24.7083, lon: -81.1000, type: "bridge", region: "southeast", alt: 200, desc: "Florida Keys" },
      "MON_KEY_WEST": { name: "Southernmost Point", lat: 24.5465, lon: -81.7986, type: "monument", region: "southeast", alt: 100, desc: "Continental US southern tip" },
      "MON_ROYAL_GORGE": { name: "Royal Gorge Bridge", lat: 38.4628, lon: -105.3245, type: "bridge", region: "mountain", alt: 7000, desc: "Highest bridge in US" },
      "MON_NEW_RIVER_GORGE": { name: "New River Gorge Bridge", lat: 38.0701, lon: -81.0832, type: "bridge", region: "southeast", alt: 2500, desc: "Steel arch bridge" },
      "MON_DECEPTION_PASS": { name: "Deception Pass Bridge", lat: 48.4053, lon: -122.6456, type: "bridge", region: "pacific", alt: 300, desc: "Whidbey Island" },
      "MON_ASTORIA_MEGLER": { name: "Astoria-Megler Bridge", lat: 46.2375, lon: -123.8786, type: "bridge", region: "pacific", alt: 300, desc: "Columbia River mouth" },
      "MON_BIXBY_CREEK": { name: "Bixby Creek Bridge", lat: 36.3714, lon: -121.9014, type: "bridge", region: "pacific", alt: 300, desc: "Big Sur icon" },
      "MON_NAVAJO_BRIDGE": { name: "Navajo Bridge", lat: 36.8114, lon: -111.6328, type: "bridge", region: "southwest", alt: 4200, desc: "Marble Canyon" },
      "MON_MIKE_OCALLAGHAN": { name: "Mike O'Callaghan Bridge", lat: 36.0133, lon: -114.7381, type: "bridge", region: "southwest", alt: 1500, desc: "Hoover Dam bypass" },
      "MON_CONFEDERATION": { name: "Confederation Bridge", lat: 46.2333, lon: -63.7000, type: "bridge", region: "canada_east", alt: 200, desc: "PEI to mainland" },
      "MON_LIONS_GATE": { name: "Lions Gate Bridge", lat: 49.3136, lon: -123.1378, type: "bridge", region: "canada_west", alt: 400, desc: "Vancouver icon" },
      "CITY_NYC_SKYLINE": { name: "Manhattan Skyline", lat: 40.7484, lon: -73.9857, type: "skyline", region: "northeast", alt: 1500, desc: "Empire State Building" },
      "CITY_EMPIRE_STATE": { name: "Empire State Building", lat: 40.7484, lon: -73.9857, type: "building", region: "northeast", alt: 1700, desc: "Art Deco skyscraper" },
      "CITY_ONE_WTC": { name: "One World Trade Center", lat: 40.7127, lon: -74.0134, type: "building", region: "northeast", alt: 1800, desc: "Freedom Tower" },
      "CITY_CHRYSLER": { name: "Chrysler Building", lat: 40.7516, lon: -73.9755, type: "building", region: "northeast", alt: 1200, desc: "Art Deco icon" },
      "CITY_ROCKEFELLER": { name: "Rockefeller Center", lat: 40.7587, lon: -73.9787, type: "building", region: "northeast", alt: 1000, desc: "30 Rock" },
      "CITY_CENTRAL_PARK": { name: "Central Park", lat: 40.7829, lon: -73.9654, type: "landmark", region: "northeast", alt: 500, desc: "Urban oasis" },
      "CITY_TIMES_SQUARE": { name: "Times Square", lat: 40.7580, lon: -73.9855, type: "landmark", region: "northeast", alt: 500, desc: "Theater District" },
      "CITY_YANKEE_STADIUM": { name: "Yankee Stadium", lat: 40.8296, lon: -73.9262, type: "stadium", region: "northeast", alt: 500, desc: "The Bronx" },
      "CITY_LA_SKYLINE": { name: "Downtown LA Skyline", lat: 34.0522, lon: -118.2437, type: "skyline", region: "pacific", alt: 1200, desc: "LA skyline" },
      "CITY_HOLLYWOOD_SIGN": { name: "Hollywood Sign", lat: 34.1341, lon: -118.3217, type: "landmark", region: "pacific", alt: 1700, desc: "Mount Lee" },
      "CITY_GRIFFITH_OBS": { name: "Griffith Observatory", lat: 34.1184, lon: -118.3004, type: "landmark", region: "pacific", alt: 1200, desc: "LA views" },
      "CITY_SANTA_MONICA": { name: "Santa Monica Pier", lat: 34.0086, lon: -118.4985, type: "landmark", region: "pacific", alt: 200, desc: "Route 66 end" },
      "CITY_VENICE_BEACH": { name: "Venice Beach", lat: 33.9850, lon: -118.4695, type: "landmark", region: "pacific", alt: 100, desc: "Boardwalk" },
      "CITY_CHICAGO_SKYLINE": { name: "Chicago Skyline", lat: 41.8781, lon: -87.6298, type: "skyline", region: "midwest", alt: 1500, desc: "Lake Michigan shore" },
      "CITY_WILLIS_TOWER": { name: "Willis Tower", lat: 41.8789, lon: -87.6359, type: "building", region: "midwest", alt: 1800, desc: "Sears Tower" },
      "CITY_HANCOCK_CENTER": { name: "John Hancock Center", lat: 41.8988, lon: -87.6229, type: "building", region: "midwest", alt: 1500, desc: "Big John" },
      "CITY_CLOUD_GATE": { name: "Cloud Gate", lat: 41.8827, lon: -87.6233, type: "landmark", region: "midwest", alt: 600, desc: "The Bean" },
      "CITY_NAVY_PIER": { name: "Navy Pier", lat: 41.8917, lon: -87.6086, type: "landmark", region: "midwest", alt: 600, desc: "Chicago landmark" },
      "CITY_SF_SKYLINE": { name: "San Francisco Skyline", lat: 37.7749, lon: -122.4194, type: "skyline", region: "pacific", alt: 1000, desc: "Bay Area" },
      "CITY_FISHERMANS_WHARF": { name: "Fisherman's Wharf", lat: 37.8080, lon: -122.4177, type: "landmark", region: "pacific", alt: 100, desc: "Pier 39" },
      "CITY_LOMBARD_ST": { name: "Lombard Street", lat: 37.8021, lon: -122.4187, type: "landmark", region: "pacific", alt: 400, desc: "Crookedest street" },
      "CITY_SEATTLE_SKYLINE": { name: "Seattle Skyline", lat: 47.6062, lon: -122.3321, type: "skyline", region: "pacific", alt: 800, desc: "Emerald City" },
      "CITY_PIKE_PLACE": { name: "Pike Place Market", lat: 47.6097, lon: -122.3422, type: "landmark", region: "pacific", alt: 200, desc: "Public market" },
      "CITY_BOSTON_SKYLINE": { name: "Boston Skyline", lat: 42.3601, lon: -71.0589, type: "skyline", region: "northeast", alt: 800, desc: "Back Bay" },
      "CITY_FENWAY": { name: "Fenway Park", lat: 42.3467, lon: -71.0972, type: "stadium", region: "northeast", alt: 500, desc: "Green Monster" },
      "CITY_FANEUIL_HALL": { name: "Faneuil Hall", lat: 42.3600, lon: -71.0569, type: "landmark", region: "northeast", alt: 200, desc: "Cradle of Liberty" },
      "CITY_PHILLY_SKYLINE": { name: "Philadelphia Skyline", lat: 39.9526, lon: -75.1652, type: "skyline", region: "northeast", alt: 1000, desc: "Center City" },
      "CITY_DC_SKYLINE": { name: "Washington DC Skyline", lat: 38.9072, lon: -77.0369, type: "skyline", region: "northeast", alt: 600, desc: "National Mall" },
      "CITY_CAPITOL": { name: "US Capitol", lat: 38.8899, lon: -77.0091, type: "building", region: "northeast", alt: 500, desc: "Congress" },
      "CITY_WHITE_HOUSE": { name: "White House", lat: 38.8977, lon: -77.0365, type: "building", region: "northeast", alt: 500, desc: "Presidential residence" },
      "CITY_PENTAGON": { name: "The Pentagon", lat: 38.8719, lon: -77.0563, type: "building", region: "northeast", alt: 500, desc: "DoD headquarters" },
      "CITY_MIAMI_SKYLINE": { name: "Miami Skyline", lat: 25.7617, lon: -80.1918, type: "skyline", region: "southeast", alt: 800, desc: "Biscayne Bay" },
      "CITY_SOUTH_BEACH": { name: "South Beach", lat: 25.7826, lon: -80.1341, type: "landmark", region: "southeast", alt: 100, desc: "Art Deco district" },
      "CITY_ATLANTA_SKYLINE": { name: "Atlanta Skyline", lat: 33.7490, lon: -84.3880, type: "skyline", region: "southeast", alt: 1200, desc: "Peachtree" },
      "CITY_DALLAS_SKYLINE": { name: "Dallas Skyline", lat: 32.7767, lon: -96.7970, type: "skyline", region: "southwest", alt: 1000, desc: "Reunion Tower" },
      "CITY_REUNION_TOWER": { name: "Reunion Tower", lat: 32.7757, lon: -96.8089, type: "building", region: "southwest", alt: 800, desc: "Dallas icon" },
      "CITY_HOUSTON_SKYLINE": { name: "Houston Skyline", lat: 29.7604, lon: -95.3698, type: "skyline", region: "southwest", alt: 1000, desc: "Space City" },
      "CITY_SAN_ANTONIO": { name: "San Antonio River Walk", lat: 29.4241, lon: -98.4936, type: "landmark", region: "southwest", alt: 700, desc: "Paseo del Rio" },
      "CITY_AUSTIN_SKYLINE": { name: "Austin Skyline", lat: 30.2672, lon: -97.7431, type: "skyline", region: "southwest", alt: 800, desc: "Keep Austin Weird" },
      "CITY_DENVER_SKYLINE": { name: "Denver Skyline", lat: 39.7392, lon: -104.9903, type: "skyline", region: "mountain", alt: 5800, desc: "Mile High City" },
      "CITY_PHOENIX_SKYLINE": { name: "Phoenix Skyline", lat: 33.4484, lon: -112.0740, type: "skyline", region: "southwest", alt: 1500, desc: "Valley of the Sun" },
      "CITY_LAS_VEGAS_STRIP": { name: "Las Vegas Strip", lat: 36.1147, lon: -115.1728, type: "landmark", region: "southwest", alt: 2500, desc: "Casino row" },
      "CITY_VEGAS_SIGN": { name: "Welcome to Las Vegas Sign", lat: 36.0828, lon: -115.1728, type: "landmark", region: "southwest", alt: 2200, desc: "Iconic sign" },
      "CITY_FREMONT_ST": { name: "Fremont Street", lat: 36.1699, lon: -115.1398, type: "landmark", region: "southwest", alt: 2100, desc: "Downtown Vegas" },
      "CITY_SAN_DIEGO_SKYLINE": { name: "San Diego Skyline", lat: 32.7157, lon: -117.1611, type: "skyline", region: "pacific", alt: 600, desc: "Harbor view" },
      "CITY_CORONADO_BRIDGE": { name: "Coronado Bridge", lat: 32.6859, lon: -117.1505, type: "bridge", region: "pacific", alt: 400, desc: "San Diego Bay" },
      "CITY_BALBOA_PARK": { name: "Balboa Park", lat: 32.7341, lon: -117.1447, type: "landmark", region: "pacific", alt: 400, desc: "Museums and gardens" },
      "CITY_PORTLAND_SKYLINE": { name: "Portland Skyline", lat: 45.5152, lon: -122.6784, type: "skyline", region: "pacific", alt: 500, desc: "Willamette River" },
      "CITY_MINNEAPOLIS_SKY": { name: "Minneapolis Skyline", lat: 44.9778, lon: -93.2650, type: "skyline", region: "midwest", alt: 1000, desc: "Mill City" },
      "CITY_ST_LOUIS_SKYLINE": { name: "St. Louis Skyline", lat: 38.6270, lon: -90.1994, type: "skyline", region: "midwest", alt: 700, desc: "Gateway to the West" },
      "CITY_DETROIT_SKYLINE": { name: "Detroit Skyline", lat: 42.3314, lon: -83.0458, type: "skyline", region: "midwest", alt: 800, desc: "Motor City" },
      "CITY_CLEVELAND_SKYLINE": { name: "Cleveland Skyline", lat: 41.4993, lon: -81.6944, type: "skyline", region: "midwest", alt: 800, desc: "Rock and Roll City" },
      "CITY_PITTSBURGH_SKY": { name: "Pittsburgh Skyline", lat: 40.4406, lon: -79.9959, type: "skyline", region: "northeast", alt: 1000, desc: "Three Rivers" },
      "CITY_CINCINNATI_SKY": { name: "Cincinnati Skyline", lat: 39.1031, lon: -84.5120, type: "skyline", region: "midwest", alt: 800, desc: "Queen City" },
      "CITY_NEW_ORLEANS": { name: "New Orleans French Quarter", lat: 29.9584, lon: -90.0644, type: "landmark", region: "southeast", alt: 200, desc: "Bourbon Street" },
      "CITY_SUPERDOME": { name: "Superdome", lat: 29.9511, lon: -90.0812, type: "stadium", region: "southeast", alt: 300, desc: "New Orleans icon" },
      "CITY_NASHVILLE_SKY": { name: "Nashville Skyline", lat: 36.1627, lon: -86.7816, type: "skyline", region: "southeast", alt: 700, desc: "Music City" },
      "CITY_BROADWAY_NASH": { name: "Broadway Nashville", lat: 36.1581, lon: -86.7764, type: "landmark", region: "southeast", alt: 600, desc: "Honky Tonk Highway" },
      "CITY_CHARLOTTE_SKY": { name: "Charlotte Skyline", lat: 35.2271, lon: -80.8431, type: "skyline", region: "southeast", alt: 900, desc: "Queen City" },
      "CITY_INDIANAPOLIS_SKY": { name: "Indianapolis Skyline", lat: 39.7684, lon: -86.1581, type: "skyline", region: "midwest", alt: 800, desc: "Circle City" },
      "CITY_KANSAS_CITY_SKY": { name: "Kansas City Skyline", lat: 39.0997, lon: -94.5786, type: "skyline", region: "midwest", alt: 900, desc: "City of Fountains" },
      "CITY_COUNTRY_CLUB": { name: "Country Club Plaza", lat: 39.0428, lon: -94.5914, type: "landmark", region: "midwest", alt: 1000, desc: "KC landmark" },
      "CITY_SALT_LAKE_SKY": { name: "Salt Lake City Skyline", lat: 40.7608, lon: -111.8910, type: "skyline", region: "mountain", alt: 4500, desc: "Wasatch backdrop" },
      "CITY_TEMPLE_SQUARE": { name: "Temple Square", lat: 40.7703, lon: -111.8916, type: "landmark", region: "mountain", alt: 4400, desc: "LDS Church HQ" },
      "CITY_ALBUQUERQUE_SKY": { name: "Albuquerque Skyline", lat: 35.0844, lon: -106.6504, type: "skyline", region: "southwest", alt: 5300, desc: "Duke City" },
      "CITY_TUCSON_SKY": { name: "Tucson Skyline", lat: 32.2226, lon: -110.9747, type: "skyline", region: "southwest", alt: 2600, desc: "Old Pueblo" },
      "CITY_EL_PASO_SKY": { name: "El Paso Skyline", lat: 31.7619, lon: -106.4850, type: "skyline", region: "southwest", alt: 4000, desc: "Sun City" },
      "CITY_HONOLULU_SKY": { name: "Honolulu Skyline", lat: 21.3069, lon: -157.8583, type: "skyline", region: "pacific", alt: 500, desc: "Waikiki Beach" },
      "CITY_DIAMOND_HEAD": { name: "Diamond Head", lat: 21.2628, lon: -157.8054, type: "landmark", region: "pacific", alt: 800, desc: "Volcanic crater" },
      "CITY_WAIKIKI": { name: "Waikiki Beach", lat: 21.2793, lon: -157.8292, type: "landmark", region: "pacific", alt: 100, desc: "Famous beach" },
      "CITY_ANCHORAGE_SKY": { name: "Anchorage Skyline", lat: 61.2181, lon: -149.9003, type: "skyline", region: "alaska", alt: 200, desc: "Chugach backdrop" },
      "CITY_FAIRBANKS": { name: "Fairbanks", lat: 64.8378, lon: -147.7164, type: "landmark", region: "alaska", alt: 500, desc: "Golden Heart City" },
      "CITY_JUNEAU": { name: "Juneau", lat: 58.3019, lon: -134.4197, type: "landmark", region: "alaska", alt: 200, desc: "Alaska capital" },
      "CITY_TORONTO_SKY": { name: "Toronto Skyline", lat: 43.6532, lon: -79.3832, type: "skyline", region: "canada_east", alt: 800, desc: "CN Tower" },
      "CITY_CN_TOWER": { name: "CN Tower", lat: 43.6426, lon: -79.3871, type: "tower", region: "canada_east", alt: 1200, desc: "Toronto icon" },
      "CITY_MONTREAL_SKY": { name: "Montreal Skyline", lat: 45.5017, lon: -73.5673, type: "skyline", region: "canada_east", alt: 600, desc: "Mount Royal" },
      "CITY_VANCOUVER_SKY": { name: "Vancouver Skyline", lat: 49.2827, lon: -123.1207, type: "skyline", region: "canada_west", alt: 600, desc: "Mountain backdrop" },
      "CITY_STANLEY_PARK": { name: "Stanley Park", lat: 49.3017, lon: -123.1417, type: "landmark", region: "canada_west", alt: 200, desc: "Urban forest" },
      "CITY_CALGARY_SKY": { name: "Calgary Skyline", lat: 51.0447, lon: -114.0719, type: "skyline", region: "canada_west", alt: 3600, desc: "Stampede City" },
      "CITY_CALGARY_TOWER": { name: "Calgary Tower", lat: 51.0444, lon: -114.0631, type: "tower", region: "canada_west", alt: 3800, desc: "Calgary icon" },
      "CITY_EDMONTON_SKY": { name: "Edmonton Skyline", lat: 53.5461, lon: -113.4938, type: "skyline", region: "canada_west", alt: 2300, desc: "Festival City" },
      "CITY_OTTAWA_SKY": { name: "Ottawa Skyline", lat: 45.4215, lon: -75.6972, type: "skyline", region: "canada_east", alt: 400, desc: "Parliament Hill" },
      "CITY_PARLIAMENT_HILL": { name: "Parliament Hill", lat: 45.4236, lon: -75.7009, type: "building", region: "canada_east", alt: 400, desc: "Canadian Parliament" },
      "CITY_QUEBEC_CITY": { name: "Quebec City", lat: 46.8139, lon: -71.2080, type: "landmark", region: "canada_east", alt: 400, desc: "Old Quebec" },
      "CITY_CHATEAU_FRONTENAC": { name: "ChÃ¢teau Frontenac", lat: 46.8120, lon: -71.2037, type: "building", region: "canada_east", alt: 400, desc: "Iconic hotel" },
      "CITY_HALIFAX_SKY": { name: "Halifax Skyline", lat: 44.6488, lon: -63.5752, type: "skyline", region: "canada_east", alt: 200, desc: "Maritime city" },
      "CITY_WINNIPEG_SKY": { name: "Winnipeg Skyline", lat: 49.8951, lon: -97.1384, type: "skyline", region: "canada_central", alt: 800, desc: "Gateway to the West" },
      "CITY_VICTORIA_BC": { name: "Victoria Inner Harbour", lat: 48.4284, lon: -123.3656, type: "landmark", region: "canada_west", alt: 200, desc: "BC capital" },
      "STD_METLIFE": { name: "MetLife Stadium", lat: 40.8128, lon: -74.0742, type: "stadium", region: "northeast", alt: 200, desc: "Giants/Jets" },
      "STD_GILLETTE": { name: "Gillette Stadium", lat: 42.0909, lon: -71.2643, type: "stadium", region: "northeast", alt: 300, desc: "Patriots" },
      "STD_LINCOLN_FINANCIAL": { name: "Lincoln Financial Field", lat: 39.9008, lon: -75.1675, type: "stadium", region: "northeast", alt: 200, desc: "Eagles" },
      "STD_FEDEX": { name: "FedExField", lat: 38.9076, lon: -76.8645, type: "stadium", region: "northeast", alt: 300, desc: "Commanders" },
      "STD_BANK_OF_AMERICA": { name: "Bank of America Stadium", lat: 35.2258, lon: -80.8528, type: "stadium", region: "southeast", alt: 800, desc: "Panthers" },
      "STD_MERCEDES_ATL": { name: "Mercedes-Benz Stadium", lat: 33.7553, lon: -84.4006, type: "stadium", region: "southeast", alt: 1000, desc: "Falcons" },
      "STD_RAYMOND_JAMES": { name: "Raymond James Stadium", lat: 27.9759, lon: -82.5033, type: "stadium", region: "southeast", alt: 100, desc: "Buccaneers" },
      "STD_HARD_ROCK": { name: "Hard Rock Stadium", lat: 25.9580, lon: -80.2389, type: "stadium", region: "southeast", alt: 100, desc: "Dolphins" },
      "STD_CAESARS_NO": { name: "Caesars Superdome", lat: 29.9511, lon: -90.0812, type: "stadium", region: "southeast", alt: 10, desc: "Saints" },
      "STD_NISSAN": { name: "Nissan Stadium", lat: 36.1665, lon: -86.7713, type: "stadium", region: "southeast", alt: 500, desc: "Titans" },
      "STD_PAYCOR": { name: "Paycor Stadium", lat: 39.0955, lon: -84.5161, type: "stadium", region: "midwest", alt: 500, desc: "Bengals" },
      "STD_FIRSTENERGY": { name: "FirstEnergy Stadium", lat: 41.5061, lon: -81.6995, type: "stadium", region: "midwest", alt: 600, desc: "Browns" },
      "STD_HEINZ": { name: "Acrisure Stadium", lat: 40.4468, lon: -80.0158, type: "stadium", region: "northeast", alt: 800, desc: "Steelers" },
      "STD_MT_BANK": { name: "M&T Bank Stadium", lat: 39.2780, lon: -76.6227, type: "stadium", region: "northeast", alt: 100, desc: "Ravens" },
      "STD_FORD_FIELD": { name: "Ford Field", lat: 42.3400, lon: -83.0456, type: "stadium", region: "midwest", alt: 600, desc: "Lions" },
      "STD_LAMBEAU": { name: "Lambeau Field", lat: 44.5013, lon: -88.0622, type: "stadium", region: "midwest", alt: 700, desc: "Packers" },
      "STD_SOLDIER": { name: "Soldier Field", lat: 41.8623, lon: -87.6167, type: "stadium", region: "midwest", alt: 600, desc: "Bears" },
      "STD_US_BANK": { name: "U.S. Bank Stadium", lat: 44.9736, lon: -93.2575, type: "stadium", region: "midwest", alt: 900, desc: "Vikings" },
      "STD_ARROWHEAD": { name: "GEHA Field at Arrowhead", lat: 39.0489, lon: -94.4839, type: "stadium", region: "midwest", alt: 1000, desc: "Chiefs" },
      "STD_EMPOWER": { name: "Empower Field at Mile High", lat: 39.7439, lon: -105.0201, type: "stadium", region: "mountain", alt: 5280, desc: "Broncos" },
      "STD_ALLEGIANT": { name: "Allegiant Stadium", lat: 36.0909, lon: -115.1833, type: "stadium", region: "southwest", alt: 2000, desc: "Raiders" },
      "STD_SOFI": { name: "SoFi Stadium", lat: 33.9535, lon: -118.3392, type: "stadium", region: "pacific", alt: 200, desc: "Rams/Chargers" },
      "STD_STATE_FARM": { name: "State Farm Stadium", lat: 33.5276, lon: -112.2626, type: "stadium", region: "southwest", alt: 1100, desc: "Cardinals" },
      "STD_LEVIS": { name: "Levi's Stadium", lat: 37.4032, lon: -121.9698, type: "stadium", region: "pacific", alt: 100, desc: "49ers" },
      "STD_LUMEN": { name: "Lumen Field", lat: 47.5952, lon: -122.3316, type: "stadium", region: "pacific", alt: 100, desc: "Seahawks" },
      "STD_ATT_DALLAS": { name: "AT&T Stadium", lat: 32.7473, lon: -97.0945, type: "stadium", region: "southwest", alt: 600, desc: "Cowboys" },
      "STD_NRG": { name: "NRG Stadium", lat: 29.6847, lon: -95.4107, type: "stadium", region: "southwest", alt: 50, desc: "Texans" },
      "STD_TIAA_BANK": { name: "TIAA Bank Field", lat: 30.3239, lon: -81.6373, type: "stadium", region: "southeast", alt: 20, desc: "Jaguars" },
      "STD_LUCAS_OIL": { name: "Lucas Oil Stadium", lat: 39.7601, lon: -86.1639, type: "stadium", region: "midwest", alt: 800, desc: "Colts" },
      "STD_HIGHMARK": { name: "Highmark Stadium", lat: 42.7738, lon: -78.7870, type: "stadium", region: "northeast", alt: 700, desc: "Bills" },
      "STD_YANKEE": { name: "Yankee Stadium", lat: 40.8296, lon: -73.9262, type: "stadium", region: "northeast", alt: 100, desc: "Yankees" },
      "STD_CITI": { name: "Citi Field", lat: 40.7571, lon: -73.8458, type: "stadium", region: "northeast", alt: 100, desc: "Mets" },
      "STD_FENWAY": { name: "Fenway Park", lat: 42.3467, lon: -71.0972, type: "stadium", region: "northeast", alt: 100, desc: "Red Sox" },
      "STD_CAMDEN": { name: "Camden Yards", lat: 39.2838, lon: -76.6216, type: "stadium", region: "northeast", alt: 100, desc: "Orioles" },
      "STD_NATIONALS": { name: "Nationals Park", lat: 38.8730, lon: -77.0074, type: "stadium", region: "northeast", alt: 100, desc: "Nationals" },
      "STD_CITIZENS": { name: "Citizens Bank Park", lat: 39.9061, lon: -75.1665, type: "stadium", region: "northeast", alt: 100, desc: "Phillies" },
      "STD_PNC": { name: "PNC Park", lat: 40.4469, lon: -80.0057, type: "stadium", region: "northeast", alt: 800, desc: "Pirates" },
      "STD_PROGRESSIVE": { name: "Progressive Field", lat: 41.4962, lon: -81.6852, type: "stadium", region: "midwest", alt: 700, desc: "Guardians" },
      "STD_COMERICA": { name: "Comerica Park", lat: 42.3390, lon: -83.0485, type: "stadium", region: "midwest", alt: 600, desc: "Tigers" },
      "STD_WRIGLEY": { name: "Wrigley Field", lat: 41.9484, lon: -87.6553, type: "stadium", region: "midwest", alt: 600, desc: "Cubs" },
      "STD_GUARANTEED": { name: "Guaranteed Rate Field", lat: 41.8299, lon: -87.6338, type: "stadium", region: "midwest", alt: 600, desc: "White Sox" },
      "STD_AMERICAN_FAMILY": { name: "American Family Field", lat: 43.0280, lon: -87.9712, type: "stadium", region: "midwest", alt: 700, desc: "Brewers" },
      "STD_TARGET": { name: "Target Field", lat: 44.9817, lon: -93.2776, type: "stadium", region: "midwest", alt: 850, desc: "Twins" },
      "STD_KAUFFMAN": { name: "Kauffman Stadium", lat: 39.0517, lon: -94.4803, type: "stadium", region: "midwest", alt: 1000, desc: "Royals" },
      "STD_BUSCH": { name: "Busch Stadium", lat: 38.6226, lon: -90.1928, type: "stadium", region: "midwest", alt: 500, desc: "Cardinals" },
      "STD_GREAT_AMERICAN": { name: "Great American Ball Park", lat: 39.0979, lon: -84.5082, type: "stadium", region: "midwest", alt: 500, desc: "Reds" },
      "STD_TRUIST": { name: "Truist Park", lat: 33.8907, lon: -84.4677, type: "stadium", region: "southeast", alt: 1000, desc: "Braves" },
      "STD_LOANDEPORT": { name: "loanDepot park", lat: 25.7781, lon: -80.2196, type: "stadium", region: "southeast", alt: 20, desc: "Marlins" },
      "STD_TROPICANA": { name: "Tropicana Field", lat: 27.7682, lon: -82.6534, type: "stadium", region: "southeast", alt: 50, desc: "Rays" },
      "STD_MINUTE_MAID": { name: "Minute Maid Park", lat: 29.7573, lon: -95.3555, type: "stadium", region: "southwest", alt: 50, desc: "Astros" },
      "STD_GLOBE_LIFE": { name: "Globe Life Field", lat: 32.7473, lon: -97.0827, type: "stadium", region: "southwest", alt: 600, desc: "Rangers" },
      "STD_COORS": { name: "Coors Field", lat: 39.7559, lon: -104.9942, type: "stadium", region: "mountain", alt: 5200, desc: "Rockies" },
      "STD_CHASE": { name: "Chase Field", lat: 33.4455, lon: -112.0667, type: "stadium", region: "southwest", alt: 1100, desc: "Diamondbacks" },
      "STD_PETCO": { name: "Petco Park", lat: 32.7076, lon: -117.1570, type: "stadium", region: "pacific", alt: 50, desc: "Padres" },
      "STD_DODGER": { name: "Dodger Stadium", lat: 34.0739, lon: -118.2400, type: "stadium", region: "pacific", alt: 500, desc: "Dodgers" },
      "STD_ANGEL": { name: "Angel Stadium", lat: 33.8003, lon: -117.8827, type: "stadium", region: "pacific", alt: 200, desc: "Angels" },
      "STD_ORACLE": { name: "Oracle Park", lat: 37.7786, lon: -122.3893, type: "stadium", region: "pacific", alt: 50, desc: "Giants" },
      "STD_OAKLAND": { name: "Oakland Coliseum", lat: 37.7516, lon: -122.2005, type: "stadium", region: "pacific", alt: 50, desc: "Athletics" },
      "STD_T_MOBILE": { name: "T-Mobile Park", lat: 47.5914, lon: -122.3325, type: "stadium", region: "pacific", alt: 50, desc: "Mariners" },
      "STD_ROGERS_CENTRE": { name: "Rogers Centre", lat: 43.6414, lon: -79.3894, type: "stadium", region: "canada_east", alt: 300, desc: "Blue Jays" },
      "STD_MICHIGAN": { name: "Michigan Stadium", lat: 42.2658, lon: -83.7486, type: "stadium", region: "midwest", alt: 900, desc: "The Big House" },
      "STD_OHIO_STATE": { name: "Ohio Stadium", lat: 40.0017, lon: -83.0196, type: "stadium", region: "midwest", alt: 800, desc: "The Horseshoe" },
      "STD_NOTRE_DAME": { name: "Notre Dame Stadium", lat: 41.6984, lon: -86.2340, type: "stadium", region: "midwest", alt: 800, desc: "Fighting Irish" },
      "STD_PENN_STATE": { name: "Beaver Stadium", lat: 40.8122, lon: -77.8561, type: "stadium", region: "northeast", alt: 1200, desc: "Nittany Lions" },
      "STD_NEYLAND": { name: "Neyland Stadium", lat: 35.9550, lon: -83.9250, type: "stadium", region: "southeast", alt: 900, desc: "Tennessee" },
      "STD_TIGER": { name: "Tiger Stadium", lat: 30.4121, lon: -91.1837, type: "stadium", region: "southeast", alt: 50, desc: "LSU" },
      "STD_KYLE": { name: "Kyle Field", lat: 30.6101, lon: -96.3397, type: "stadium", region: "southwest", alt: 350, desc: "Texas A&M" },
      "STD_DARRELL_K": { name: "DKR-Texas Memorial", lat: 30.2836, lon: -97.7325, type: "stadium", region: "southwest", alt: 600, desc: "Texas Longhorns" },
      "STD_ROSE_BOWL": { name: "Rose Bowl", lat: 34.1613, lon: -118.1676, type: "stadium", region: "pacific", alt: 900, desc: "UCLA/Rose Bowl Game" },
      "STD_LA_COLISEUM": { name: "LA Memorial Coliseum", lat: 34.0141, lon: -118.2879, type: "stadium", region: "pacific", alt: 300, desc: "USC" },
      "STD_SANFORD": { name: "Sanford Stadium", lat: 33.9497, lon: -83.3733, type: "stadium", region: "southeast", alt: 700, desc: "Georgia Bulldogs" },
      "STD_JORDAN_HARE": { name: "Jordan-Hare Stadium", lat: 32.6021, lon: -85.4900, type: "stadium", region: "southeast", alt: 700, desc: "Auburn" },
      "STD_BRYANT_DENNY": { name: "Bryant-Denny Stadium", lat: 33.2085, lon: -87.5505, type: "stadium", region: "southeast", alt: 300, desc: "Alabama" },
      "STD_CAMP_RANDALL": { name: "Camp Randall Stadium", lat: 43.0700, lon: -89.4117, type: "stadium", region: "midwest", alt: 900, desc: "Wisconsin" },
      "STD_MEMORIAL_NEB": { name: "Memorial Stadium", lat: 40.8206, lon: -96.7058, type: "stadium", region: "midwest", alt: 1200, desc: "Nebraska" },
      "STD_AUTZEN": { name: "Autzen Stadium", lat: 44.0585, lon: -123.0688, type: "stadium", region: "pacific", alt: 500, desc: "Oregon" },
      "STD_HUSKY": { name: "Husky Stadium", lat: 47.6505, lon: -122.3017, type: "stadium", region: "pacific", alt: 100, desc: "Washington" },
      "STD_FOLSOM": { name: "Folsom Field", lat: 40.0094, lon: -105.2669, type: "stadium", region: "mountain", alt: 5400, desc: "Colorado" },
      "STD_RICE_ECCLES": { name: "Rice-Eccles Stadium", lat: 40.7600, lon: -111.8489, type: "stadium", region: "mountain", alt: 4700, desc: "Utah" },
      "STD_GAYLORD": { name: "Gaylord Family Stadium", lat: 35.2058, lon: -97.4425, type: "stadium", region: "southwest", alt: 1200, desc: "Oklahoma" },
      "STD_BOONE_PICKENS": { name: "Boone Pickens Stadium", lat: 36.1267, lon: -97.0675, type: "stadium", region: "southwest", alt: 900, desc: "Oklahoma State" },
      "STD_BEN_HILL": { name: "Ben Hill Griffin Stadium", lat: 29.6500, lon: -82.3486, type: "stadium", region: "southeast", alt: 150, desc: "Florida Gators" },
      "STD_DOAK_CAMPBELL": { name: "Doak Campbell Stadium", lat: 30.4383, lon: -84.3042, type: "stadium", region: "southeast", alt: 200, desc: "Florida State" },
      "STD_WILLIAMS_BRICE": { name: "Williams-Brice Stadium", lat: 33.9728, lon: -81.0197, type: "stadium", region: "southeast", alt: 300, desc: "South Carolina" },
      "STD_DEATH_VALLEY_CU": { name: "Memorial Stadium", lat: 34.6784, lon: -82.8429, type: "stadium", region: "southeast", alt: 900, desc: "Clemson" },
      "STD_LANE": { name: "Lane Stadium", lat: 37.2199, lon: -80.4180, type: "stadium", region: "southeast", alt: 2100, desc: "Virginia Tech" },
      "STD_SUN_DEVIL": { name: "Sun Devil Stadium", lat: 33.4265, lon: -111.9325, type: "stadium", region: "southwest", alt: 1200, desc: "Arizona State" },
      "STD_LAVELL": { name: "LaVell Edwards Stadium", lat: 40.2572, lon: -111.6546, type: "stadium", region: "mountain", alt: 4600, desc: "BYU" },
      "LH_PORTLAND_HEAD": { name: "Portland Head Light", lat: 43.6231, lon: -70.2078, type: "lighthouse", region: "northeast", alt: 200, desc: "Maine icon" },
      "LH_WEST_QUODDY": { name: "West Quoddy Head Light", lat: 44.8150, lon: -66.9508, type: "lighthouse", region: "northeast", alt: 200, desc: "Easternmost US" },
      "LH_BASS_HARBOR": { name: "Bass Harbor Head Light", lat: 44.2219, lon: -68.3375, type: "lighthouse", region: "northeast", alt: 100, desc: "Acadia NP" },
      "LH_CAPE_COD": { name: "Cape Cod Light", lat: 42.0372, lon: -70.0650, type: "lighthouse", region: "northeast", alt: 200, desc: "Highland Light" },
      "LH_NOBSKA": { name: "Nobska Light", lat: 41.5158, lon: -70.6553, type: "lighthouse", region: "northeast", alt: 100, desc: "Woods Hole" },
      "LH_BOSTON": { name: "Boston Light", lat: 42.3283, lon: -70.8903, type: "lighthouse", region: "northeast", alt: 100, desc: "Oldest US lighthouse" },
      "LH_MONTAUK": { name: "Montauk Point Light", lat: 41.0711, lon: -71.8572, type: "lighthouse", region: "northeast", alt: 100, desc: "Long Island tip" },
      "LH_CAPE_MAY": { name: "Cape May Light", lat: 38.9331, lon: -74.9597, type: "lighthouse", region: "northeast", alt: 200, desc: "NJ shore" },
      "LH_BARNEGAT": { name: "Barnegat Light", lat: 39.7644, lon: -74.1064, type: "lighthouse", region: "northeast", alt: 200, desc: "Old Barney" },
      "LH_ASSATEAGUE": { name: "Assateague Light", lat: 37.9108, lon: -75.3556, type: "lighthouse", region: "northeast", alt: 200, desc: "Wild ponies island" },
      "LH_CAPE_HATTERAS": { name: "Cape Hatteras Light", lat: 35.2506, lon: -75.5286, type: "lighthouse", region: "southeast", alt: 200, desc: "Tallest US brick lighthouse" },
      "LH_BODIE_ISLAND": { name: "Bodie Island Light", lat: 35.8186, lon: -75.5636, type: "lighthouse", region: "southeast", alt: 200, desc: "Outer Banks" },
      "LH_CURRITUCK": { name: "Currituck Beach Light", lat: 36.3772, lon: -75.8306, type: "lighthouse", region: "southeast", alt: 200, desc: "Corolla" },
      "LH_TYBEE": { name: "Tybee Island Light", lat: 32.0222, lon: -80.8456, type: "lighthouse", region: "southeast", alt: 200, desc: "Georgia coast" },
      "LH_ST_AUGUSTINE": { name: "St. Augustine Light", lat: 29.8856, lon: -81.2886, type: "lighthouse", region: "southeast", alt: 200, desc: "Florida oldest" },
      "LH_KEY_WEST": { name: "Key West Light", lat: 24.5500, lon: -81.8014, type: "lighthouse", region: "southeast", alt: 100, desc: "Southern tip" },
      "LH_SAND_KEY": { name: "Sand Key Light", lat: 24.4531, lon: -81.8775, type: "lighthouse", region: "southeast", alt: 100, desc: "Reef light" },
      "LH_BILOXI": { name: "Biloxi Light", lat: 30.3917, lon: -88.8856, type: "lighthouse", region: "southeast", alt: 100, desc: "Gulf Coast" },
      "LH_POINT_ISABEL": { name: "Point Isabel Light", lat: 26.0722, lon: -97.2133, type: "lighthouse", region: "southwest", alt: 100, desc: "Texas coast" },
      "LH_SPLIT_ROCK": { name: "Split Rock Lighthouse", lat: 47.2000, lon: -91.3667, type: "lighthouse", region: "midwest", alt: 200, desc: "Lake Superior" },
      "LH_POINT_BETSIE": { name: "Point Betsie Light", lat: 44.6908, lon: -86.2558, type: "lighthouse", region: "midwest", alt: 200, desc: "Lake Michigan" },
      "LH_BIG_SABLE": { name: "Big Sable Point Light", lat: 44.0556, lon: -86.5156, type: "lighthouse", region: "midwest", alt: 200, desc: "Ludington" },
      "LH_MACKINAC": { name: "Old Mackinac Point Light", lat: 45.7858, lon: -84.7278, type: "lighthouse", region: "midwest", alt: 200, desc: "Straits" },
      "LH_MARBLEHEAD": { name: "Marblehead Light", lat: 41.5369, lon: -82.7117, type: "lighthouse", region: "midwest", alt: 200, desc: "Lake Erie oldest" },
      "LH_POINT_LOMA": { name: "Point Loma Light", lat: 32.6733, lon: -117.2417, type: "lighthouse", region: "pacific", alt: 500, desc: "San Diego" },
      "LH_POINT_REYES": { name: "Point Reyes Light", lat: 37.9958, lon: -123.0228, type: "lighthouse", region: "pacific", alt: 400, desc: "Marin County" },
      "LH_PIGEON_POINT": { name: "Pigeon Point Light", lat: 37.1822, lon: -122.3939, type: "lighthouse", region: "pacific", alt: 200, desc: "Highway 1" },
      "LH_POINT_ARENA": { name: "Point Arena Light", lat: 38.9544, lon: -123.7406, type: "lighthouse", region: "pacific", alt: 200, desc: "Mendocino" },
      "LH_HECETA_HEAD": { name: "Heceta Head Light", lat: 44.1372, lon: -124.1286, type: "lighthouse", region: "pacific", alt: 300, desc: "Oregon Coast" },
      "LH_CAPE_MEARES": { name: "Cape Meares Light", lat: 45.4869, lon: -123.9783, type: "lighthouse", region: "pacific", alt: 300, desc: "Tillamook" },
      "LH_YAQUINA_HEAD": { name: "Yaquina Head Light", lat: 44.6761, lon: -124.0794, type: "lighthouse", region: "pacific", alt: 200, desc: "Tallest Oregon" },
      "LH_CAPE_DISAPPOINTMENT": { name: "Cape Disappointment Light", lat: 46.2758, lon: -124.0519, type: "lighthouse", region: "pacific", alt: 300, desc: "Columbia River" },
      "LH_NORTH_HEAD": { name: "North Head Light", lat: 46.2989, lon: -124.0783, type: "lighthouse", region: "pacific", alt: 300, desc: "Washington coast" },
      "LH_MUKILTEO": { name: "Mukilteo Light", lat: 47.9483, lon: -122.3053, type: "lighthouse", region: "pacific", alt: 100, desc: "Puget Sound" },
      "LH_ADMIRALTY_HEAD": { name: "Admiralty Head Light", lat: 48.1600, lon: -122.6783, type: "lighthouse", region: "pacific", alt: 200, desc: "Whidbey Island" },
      "LH_LIME_KILN": { name: "Lime Kiln Light", lat: 48.5158, lon: -123.1528, type: "lighthouse", region: "pacific", alt: 100, desc: "San Juan Islands" },
      "LH_DIAMOND_HEAD": { name: "Diamond Head Light", lat: 21.2556, lon: -157.8069, type: "lighthouse", region: "pacific", alt: 100, desc: "Oahu" },
      "LH_KILAUEA": { name: "Kilauea Light", lat: 22.2319, lon: -159.4011, type: "lighthouse", region: "pacific", alt: 200, desc: "Kauai" },
      "LH_PEGGY_COVE": { name: "Peggy's Point Light", lat: 44.4928, lon: -63.9181, type: "lighthouse", region: "canada_east", alt: 100, desc: "Nova Scotia icon" },
      "LH_FISGARD": { name: "Fisgard Light", lat: 48.4306, lon: -123.4478, type: "lighthouse", region: "canada_west", alt: 100, desc: "BC oldest" },
      "PARK_DISNEY_MK": { name: "Magic Kingdom", lat: 28.4177, lon: -81.5812, type: "theme_park", region: "southeast", alt: 200, desc: "Cinderella Castle" },
      "PARK_EPCOT": { name: "EPCOT", lat: 28.3747, lon: -81.5494, type: "theme_park", region: "southeast", alt: 200, desc: "Spaceship Earth" },
      "PARK_HOLLYWOOD_STUDIOS": { name: "Hollywood Studios", lat: 28.3575, lon: -81.5583, type: "theme_park", region: "southeast", alt: 200, desc: "Tower of Terror" },
      "PARK_ANIMAL_KINGDOM": { name: "Animal Kingdom", lat: 28.3553, lon: -81.5901, type: "theme_park", region: "southeast", alt: 200, desc: "Tree of Life" },
      "PARK_UNIVERSAL_FL": { name: "Universal Studios Florida", lat: 28.4794, lon: -81.4686, type: "theme_park", region: "southeast", alt: 200, desc: "Wizarding World" },
      "PARK_ISLANDS_ADVENTURE": { name: "Islands of Adventure", lat: 28.4722, lon: -81.4706, type: "theme_park", region: "southeast", alt: 200, desc: "Hogwarts Castle" },
      "PARK_SEAWORLD_FL": { name: "SeaWorld Orlando", lat: 28.4114, lon: -81.4611, type: "theme_park", region: "southeast", alt: 200, desc: "Marine park" },
      "PARK_BUSCH_GARDENS_FL": { name: "Busch Gardens Tampa", lat: 28.0372, lon: -82.4214, type: "theme_park", region: "southeast", alt: 100, desc: "SheiKra" },
      "PARK_DISNEYLAND": { name: "Disneyland", lat: 33.8121, lon: -117.9190, type: "theme_park", region: "pacific", alt: 200, desc: "Original Disney park" },
      "PARK_CALIFORNIA_ADV": { name: "California Adventure", lat: 33.8061, lon: -117.9228, type: "theme_park", region: "pacific", alt: 200, desc: "Pixar Pier" },
      "PARK_UNIVERSAL_HOLLYWOOD": { name: "Universal Studios Hollywood", lat: 34.1381, lon: -118.3534, type: "theme_park", region: "pacific", alt: 600, desc: "Studio Tour" },
      "PARK_KNOTT": { name: "Knott's Berry Farm", lat: 33.8442, lon: -117.9986, type: "theme_park", region: "pacific", alt: 100, desc: "First theme park" },
      "PARK_SEAWORLD_SD": { name: "SeaWorld San Diego", lat: 32.7648, lon: -117.2264, type: "theme_park", region: "pacific", alt: 100, desc: "Marine park" },
      "PARK_LEGOLAND_CA": { name: "Legoland California", lat: 33.1267, lon: -117.3117, type: "theme_park", region: "pacific", alt: 300, desc: "Carlsbad" },
      "PARK_SIX_FLAGS_MM": { name: "Six Flags Magic Mountain", lat: 34.4253, lon: -118.5972, type: "theme_park", region: "pacific", alt: 1500, desc: "Coaster capital" },
      "PARK_SIX_FLAGS_TX": { name: "Six Flags Over Texas", lat: 32.7549, lon: -97.0701, type: "theme_park", region: "southwest", alt: 600, desc: "Original Six Flags" },
      "PARK_SIX_FLAGS_GA": { name: "Six Flags Over Georgia", lat: 33.7678, lon: -84.5514, type: "theme_park", region: "southeast", alt: 1000, desc: "Atlanta area" },
      "PARK_SIX_FLAGS_NJ": { name: "Six Flags Great Adventure", lat: 40.1375, lon: -74.4414, type: "theme_park", region: "northeast", alt: 200, desc: "Kingda Ka" },
      "PARK_CEDAR_POINT": { name: "Cedar Point", lat: 41.4784, lon: -82.6793, type: "theme_park", region: "midwest", alt: 600, desc: "Roller coaster mecca" },
      "PARK_KINGS_ISLAND": { name: "Kings Island", lat: 39.3447, lon: -84.2694, type: "theme_park", region: "midwest", alt: 900, desc: "The Beast" },
      "PARK_DOLLYWOOD": { name: "Dollywood", lat: 35.7953, lon: -83.5308, type: "theme_park", region: "southeast", alt: 1200, desc: "Dolly Parton's park" },
      "PARK_SILVER_DOLLAR": { name: "Silver Dollar City", lat: 36.6681, lon: -93.3386, type: "theme_park", region: "midwest", alt: 1200, desc: "Branson" },
      "PARK_HERSHEY": { name: "Hersheypark", lat: 40.2878, lon: -76.6558, type: "theme_park", region: "northeast", alt: 400, desc: "Chocolate town" },
      "PARK_BUSCH_GARDENS_VA": { name: "Busch Gardens Williamsburg", lat: 37.2344, lon: -76.6450, type: "theme_park", region: "southeast", alt: 200, desc: "European themed" },
      "PARK_CAROWINDS": { name: "Carowinds", lat: 35.1047, lon: -80.9439, type: "theme_park", region: "southeast", alt: 700, desc: "NC/SC border" },
      "PARK_WONDERLAND": { name: "Canada's Wonderland", lat: 43.8430, lon: -79.5394, type: "theme_park", region: "canada_east", alt: 800, desc: "Toronto area" },
      "PARK_SAN_DIEGO_ZOO": { name: "San Diego Zoo", lat: 32.7353, lon: -117.1490, type: "theme_park", region: "pacific", alt: 400, desc: "World-famous zoo" },
      "PARK_BRONX_ZOO": { name: "Bronx Zoo", lat: 40.8506, lon: -73.8769, type: "theme_park", region: "northeast", alt: 200, desc: "Largest urban zoo" },
      "PARK_NATIONAL_ZOO": { name: "National Zoo", lat: 38.9296, lon: -77.0498, type: "theme_park", region: "northeast", alt: 400, desc: "Smithsonian" },
      "PARK_MONTEREY_BAY": { name: "Monterey Bay Aquarium", lat: 36.6183, lon: -121.9017, type: "theme_park", region: "pacific", alt: 100, desc: "Cannery Row" },
      "PARK_GEORGIA_AQUARIUM": { name: "Georgia Aquarium", lat: 33.7634, lon: -84.3951, type: "theme_park", region: "southeast", alt: 1000, desc: "Largest US aquarium" },
      "PARK_SHEDD": { name: "Shedd Aquarium", lat: 41.8676, lon: -87.6140, type: "theme_park", region: "midwest", alt: 600, desc: "Chicago lakefront" },
      "CA_NIAGARA_HORSESHOE": { name: "Horseshoe Falls", lat: 43.0799, lon: -79.0747, type: "waterfall", region: "canada_east", alt: 600, desc: "Canadian side of Niagara" },
      "CA_NIAGARA_AMERICAN": { name: "American Falls", lat: 43.0833, lon: -79.0708, type: "waterfall", region: "canada_east", alt: 600, desc: "US side visible from Canada" },
      "CA_LAKE_LOUISE": { name: "Lake Louise", lat: 51.4254, lon: -116.1773, type: "lake", region: "canada_west", alt: 5700, desc: "Turquoise glacial lake" },
      "CA_MORAINE_LAKE": { name: "Moraine Lake", lat: 51.3217, lon: -116.1860, type: "lake", region: "canada_west", alt: 6200, desc: "Valley of Ten Peaks" },
      "CA_PEYTO_LAKE": { name: "Peyto Lake", lat: 51.7250, lon: -116.5361, type: "lake", region: "canada_west", alt: 6500, desc: "Fox-shaped lake" },
      "CA_BOW_LAKE": { name: "Bow Lake", lat: 51.6767, lon: -116.4583, type: "lake", region: "canada_west", alt: 6400, desc: "Icefields Parkway" },
      "CA_SPIRIT_ISLAND": { name: "Spirit Island", lat: 52.4619, lon: -117.4108, type: "natural", region: "canada_west", alt: 3500, desc: "Maligne Lake" },
      "CA_ATHABASCA_FALLS": { name: "Athabasca Falls", lat: 52.6650, lon: -117.8833, type: "waterfall", region: "canada_west", alt: 4000, desc: "Jasper NP" },
      "CA_SUNWAPTA_FALLS": { name: "Sunwapta Falls", lat: 52.5333, lon: -117.6333, type: "waterfall", region: "canada_west", alt: 4500, desc: "Jasper NP" },
      "CA_COLUMBIA_ICEFIELD": { name: "Columbia Icefield", lat: 52.2167, lon: -117.2333, type: "natural", region: "canada_west", alt: 8000, desc: "Largest icefield in Rockies" },
      "CA_ATHABASCA_GLACIER": { name: "Athabasca Glacier", lat: 52.1956, lon: -117.2303, type: "natural", region: "canada_west", alt: 6500, desc: "Accessible glacier" },
      "CA_TAKAKKAW_FALLS": { name: "Takakkaw Falls", lat: 51.4978, lon: -116.4850, type: "waterfall", region: "canada_west", alt: 5500, desc: "Second tallest in Canada" },
      "CA_JOHNSTON_CANYON": { name: "Johnston Canyon", lat: 51.2450, lon: -115.8375, type: "natural", region: "canada_west", alt: 5000, desc: "Banff NP" },
      "CA_EMERALD_LAKE": { name: "Emerald Lake", lat: 51.4433, lon: -116.5292, type: "lake", region: "canada_west", alt: 4300, desc: "Yoho NP" },
      "CA_MOUNT_ROBSON": { name: "Mount Robson", lat: 53.1147, lon: -119.1553, type: "mountain", region: "canada_west", alt: 12972, desc: "Highest in Canadian Rockies" },
      "CA_WHISTLER_BLACKCOMB": { name: "Whistler Blackcomb", lat: 50.1163, lon: -122.9574, type: "mountain", region: "canada_west", alt: 7500, desc: "Ski resort" },
      "CA_MOUNT_WASHINGTON": { name: "Mount Washington BC", lat: 49.7383, lon: -125.2936, type: "mountain", region: "canada_west", alt: 5200, desc: "Vancouver Island ski" },
      "CA_STAWAMUS_CHIEF": { name: "Stawamus Chief", lat: 49.6833, lon: -123.1500, type: "mountain", region: "canada_west", alt: 2300, desc: "World's second largest granite monolith" },
      "CA_SHANNON_FALLS": { name: "Shannon Falls", lat: 49.6253, lon: -123.1539, type: "waterfall", region: "canada_west", alt: 500, desc: "Third tallest in BC" },
      "CA_BUTCHART_GARDENS": { name: "Butchart Gardens", lat: 48.5636, lon: -123.4686, type: "landmark", region: "canada_west", alt: 200, desc: "Victoria gardens" },
      "CA_CATHEDRAL_GROVE": { name: "Cathedral Grove", lat: 49.2833, lon: -124.6667, type: "natural", region: "canada_west", alt: 700, desc: "Old-growth Douglas fir" },
      "CA_LONG_BEACH_BC": { name: "Long Beach BC", lat: 49.0667, lon: -125.7500, type: "natural", region: "canada_west", alt: 50, desc: "Pacific Rim" },
      "CA_BAY_OF_FUNDY": { name: "Bay of Fundy", lat: 45.3167, lon: -64.8667, type: "natural", region: "canada_east", alt: 100, desc: "Highest tides in world" },
      "CA_HOPEWELL_ROCKS": { name: "Hopewell Rocks", lat: 45.8236, lon: -64.5822, type: "natural", region: "canada_east", alt: 50, desc: "Flowerpot rocks" },
      "CA_CABOT_TRAIL": { name: "Cabot Trail", lat: 46.8167, lon: -60.7500, type: "natural", region: "canada_east", alt: 1500, desc: "Cape Breton scenic drive" },
      "CA_TABLELANDS": { name: "Tablelands", lat: 49.4667, lon: -57.9667, type: "natural", region: "canada_east", alt: 2000, desc: "Earth's mantle exposed" },
      "CA_WESTERN_BROOK_POND": { name: "Western Brook Pond", lat: 49.7833, lon: -57.8500, type: "natural", region: "canada_east", alt: 1500, desc: "Fjord-like lake" },
      "CA_SIGNAL_HILL": { name: "Signal Hill", lat: 47.5706, lon: -52.6814, type: "natural", region: "canada_east", alt: 500, desc: "St. John's harbor view" },
      "CA_MOUNT_TREMBLANT": { name: "Mont Tremblant", lat: 46.2114, lon: -74.5850, type: "mountain", region: "canada_east", alt: 3000, desc: "Laurentian ski resort" },
      "CA_THOUSAND_ISLANDS": { name: "Thousand Islands", lat: 44.3500, lon: -75.9000, type: "natural", region: "canada_east", alt: 300, desc: "St. Lawrence archipelago" },
      "CA_ALGONQUIN": { name: "Algonquin Provincial Park", lat: 45.5500, lon: -78.5000, type: "natural", region: "canada_east", alt: 1500, desc: "Ontario wilderness" },
      "CA_MUSKOKA": { name: "Muskoka Lakes", lat: 45.0500, lon: -79.3833, type: "lake", region: "canada_east", alt: 800, desc: "Cottage country" },
      "CA_AGAWA_CANYON": { name: "Agawa Canyon", lat: 47.4667, lon: -84.4833, type: "natural", region: "canada_east", alt: 1000, desc: "Train tour destination" },
      "CA_WHITESHELL": { name: "Whiteshell Provincial Park", lat: 50.0833, lon: -95.3333, type: "natural", region: "canada_central", alt: 1100, desc: "Canadian Shield lakes" },
      "CA_CHURCHILL": { name: "Churchill", lat: 58.7667, lon: -94.1667, type: "landmark", region: "canada_central", alt: 100, desc: "Polar bear capital" },
      "MISC_ROSWELL": { name: "Roswell", lat: 33.3943, lon: -104.5230, type: "landmark", region: "southwest", alt: 3600, desc: "UFO incident site" },
      "MISC_FOUR_CORNERS": { name: "Four Corners Monument", lat: 36.9990, lon: -109.0452, type: "landmark", region: "southwest", alt: 5000, desc: "AZ/CO/NM/UT border" },
      "MISC_CONTINENTAL_DIVIDE": { name: "Continental Divide", lat: 39.7592, lon: -105.7053, type: "landmark", region: "mountain", alt: 11990, desc: "Loveland Pass" },
      "MISC_CADILLAC_RANCH": { name: "Cadillac Ranch", lat: 35.1872, lon: -101.9872, type: "landmark", region: "southwest", alt: 3600, desc: "Buried Cadillacs" },
      "MISC_CARHENGE": { name: "Carhenge", lat: 42.1419, lon: -102.8578, type: "landmark", region: "midwest", alt: 3800, desc: "Car Stonehenge replica" },
      "MISC_CORN_PALACE": { name: "Corn Palace", lat: 43.7119, lon: -98.0283, type: "landmark", region: "midwest", alt: 1300, desc: "Mitchell SD" },
      "MISC_WALL_DRUG": { name: "Wall Drug", lat: 43.9925, lon: -102.2414, type: "landmark", region: "midwest", alt: 2800, desc: "Tourist stop" },
      "MISC_SOUTH_OF_BORDER": { name: "South of the Border", lat: 34.5461, lon: -79.0964, type: "landmark", region: "southeast", alt: 200, desc: "I-95 landmark" },
      "MISC_LUCY_ELEPHANT": { name: "Lucy the Elephant", lat: 39.3219, lon: -74.5103, type: "landmark", region: "northeast", alt: 50, desc: "Margate NJ" },
      "MISC_WORLDS_LARGEST_BALL": { name: "World's Largest Ball of Twine", lat: 39.3906, lon: -98.1867, type: "landmark", region: "midwest", alt: 1600, desc: "Cawker City KS" },
      "MISC_WIGWAM_MOTEL": { name: "Wigwam Motel", lat: 35.2833, lon: -111.6417, type: "landmark", region: "southwest", alt: 6900, desc: "Holbrook AZ" },
      "MISC_SALVATION_MTN": { name: "Salvation Mountain", lat: 33.2547, lon: -115.4697, type: "landmark", region: "pacific", alt: -150, desc: "Desert art installation" },
      "MISC_SALTON_SEA": { name: "Salton Sea", lat: 33.2500, lon: -115.8333, type: "natural", region: "pacific", alt: -240, desc: "Accidental lake" },
      "MISC_DEATH_VALLEY_SIGN": { name: "Badwater Basin", lat: 36.2299, lon: -116.7677, type: "natural", region: "pacific", alt: -282, desc: "Lowest point in US" },
      "MISC_MT_MCKINLEY": { name: "Denali Base", lat: 63.0695, lon: -151.0074, type: "mountain", region: "alaska", alt: 20310, desc: "Highest in North America" },
      "MISC_BERING_STRAIT": { name: "Little Diomede Island", lat: 65.7583, lon: -168.9333, type: "landmark", region: "alaska", alt: 200, desc: "Russia visible" },
      "MISC_PRUDHOE_BAY": { name: "Prudhoe Bay", lat: 70.2553, lon: -148.3372, type: "landmark", region: "alaska", alt: 50, desc: "Alaska oil fields" },
      "MISC_PIPELINE": { name: "Trans-Alaska Pipeline", lat: 64.8500, lon: -147.7333, type: "landmark", region: "alaska", alt: 500, desc: "800-mile pipeline" },
      "MISC_KENNEDY_SPACE": { name: "Kennedy Space Center", lat: 28.5728, lon: -80.6490, type: "landmark", region: "southeast", alt: 20, desc: "NASA launch site" },
      "MISC_CAPE_CANAVERAL": { name: "Cape Canaveral", lat: 28.4889, lon: -80.5778, type: "landmark", region: "southeast", alt: 20, desc: "Space launch complex" },
      "MISC_JOHNSON_SPACE": { name: "Johnson Space Center", lat: 29.5594, lon: -95.0900, type: "landmark", region: "southwest", alt: 50, desc: "Houston mission control" },
      "MISC_JPL": { name: "Jet Propulsion Laboratory", lat: 34.2013, lon: -118.1714, type: "landmark", region: "pacific", alt: 1100, desc: "Pasadena NASA" },
      "MISC_VLA": { name: "Very Large Array", lat: 34.0784, lon: -107.6184, type: "landmark", region: "southwest", alt: 7000, desc: "Radio telescope array" },
      "MISC_ARECIBO": { name: "Arecibo Observatory Site", lat: 18.3464, lon: -66.7528, type: "landmark", region: "southeast", alt: 1000, desc: "Former radio telescope" },
      "MISC_KITT_PEAK": { name: "Kitt Peak Observatory", lat: 31.9633, lon: -111.6003, type: "landmark", region: "southwest", alt: 6880, desc: "Arizona telescopes" },
      "MISC_LOWELL_OBSERVATORY": { name: "Lowell Observatory", lat: 35.2028, lon: -111.6647, type: "landmark", region: "southwest", alt: 7200, desc: "Pluto discovery site" },
      "MISC_MOUNT_PALOMAR": { name: "Palomar Observatory", lat: 33.3564, lon: -116.8650, type: "landmark", region: "pacific", alt: 5600, desc: "200-inch telescope" },
      "MISC_BONNEVILLE_SPEEDWAY": { name: "Bonneville Speedway", lat: 40.7930, lon: -113.8483, type: "landmark", region: "mountain", alt: 4200, desc: "Land speed records" },
      "MISC_DAYTONA": { name: "Daytona International Speedway", lat: 29.1858, lon: -81.0706, type: "stadium", region: "southeast", alt: 30, desc: "NASCAR" },
      "MISC_CHARLOTTE_MOTOR": { name: "Charlotte Motor Speedway", lat: 35.3519, lon: -80.6831, type: "stadium", region: "southeast", alt: 800, desc: "NASCAR" },
      "MISC_TALLADEGA": { name: "Talladega Superspeedway", lat: 33.5667, lon: -86.0647, type: "stadium", region: "southeast", alt: 600, desc: "NASCAR" },
      "MISC_BRISTOL": { name: "Bristol Motor Speedway", lat: 36.5158, lon: -82.2569, type: "stadium", region: "southeast", alt: 1700, desc: "Thunder Valley" },
      "MISC_LAGUNA_SECA": { name: "Laguna Seca Raceway", lat: 36.5842, lon: -121.7536, type: "stadium", region: "pacific", alt: 1000, desc: "Corkscrew turn" },
      "MISC_PEBBLE_BEACH": { name: "Pebble Beach Golf Links", lat: 36.5683, lon: -121.9500, type: "landmark", region: "pacific", alt: 50, desc: "Famous golf course" },
      "MISC_AUGUSTA_NATIONAL": { name: "Augusta National Golf Club", lat: 33.5022, lon: -82.0231, type: "landmark", region: "southeast", alt: 400, desc: "The Masters" },
      "MISC_ST_ANDREWS": { name: "TPC Sawgrass", lat: 30.1972, lon: -81.3944, type: "landmark", region: "southeast", alt: 30, desc: "17th Island Green" },
      "MISC_BURNING_MAN": { name: "Black Rock Desert", lat: 40.7864, lon: -119.2065, type: "landmark", region: "mountain", alt: 4000, desc: "Burning Man location" },
      "MISC_COACHELLA": { name: "Empire Polo Club", lat: 33.6803, lon: -116.2378, type: "landmark", region: "pacific", alt: 100, desc: "Coachella venue" },
      "MISC_WOODSTOCK": { name: "Bethel Woods", lat: 41.7011, lon: -74.8783, type: "landmark", region: "northeast", alt: 1200, desc: "Woodstock 1969 site" },
      "MISC_GRACELAND": { name: "Graceland", lat: 35.0477, lon: -90.0261, type: "landmark", region: "southeast", alt: 300, desc: "Elvis Presley home" },
      "MISC_SUN_STUDIO": { name: "Sun Studio", lat: 35.1389, lon: -90.0297, type: "landmark", region: "southeast", alt: 300, desc: "Rock and roll birthplace" },
      "MISC_MOTOWN": { name: "Motown Museum", lat: 42.3644, lon: -83.0886, type: "landmark", region: "midwest", alt: 600, desc: "Hitsville USA" },
      "MISC_ROCK_HALL": { name: "Rock and Roll Hall of Fame", lat: 41.5085, lon: -81.6954, type: "landmark", region: "midwest", alt: 600, desc: "Cleveland" },
      "MISC_MALL_OF_AMERICA": { name: "Mall of America", lat: 44.8549, lon: -93.2422, type: "landmark", region: "midwest", alt: 900, desc: "Largest US mall" },
      "MISC_WEST_EDMONTON": { name: "West Edmonton Mall", lat: 53.5225, lon: -113.6242, type: "landmark", region: "canada_west", alt: 2300, desc: "Largest Canadian mall" },
      "MISC_SILICON_VALLEY": { name: "Apple Park", lat: 37.3349, lon: -122.0090, type: "landmark", region: "pacific", alt: 200, desc: "Apple headquarters" },
      "MISC_GOOGLEPLEX": { name: "Googleplex", lat: 37.4220, lon: -122.0841, type: "landmark", region: "pacific", alt: 100, desc: "Google headquarters" },
      "MISC_MICROSOFT": { name: "Microsoft Campus", lat: 47.6420, lon: -122.1307, type: "landmark", region: "pacific", alt: 200, desc: "Redmond headquarters" },
      "MISC_AMAZON_HQ": { name: "Amazon Spheres", lat: 47.6156, lon: -122.3394, type: "landmark", region: "pacific", alt: 200, desc: "Seattle headquarters" },
      "MISC_TESLA_FACTORY": { name: "Tesla Factory", lat: 37.4942, lon: -121.9447, type: "landmark", region: "pacific", alt: 50, desc: "Fremont factory" },
      "MISC_HOOVER_BLDG": { name: "FBI Building", lat: 38.8943, lon: -77.0246, type: "landmark", region: "northeast", alt: 100, desc: "J. Edgar Hoover Building" },
      "MISC_LANGLEY": { name: "CIA Headquarters", lat: 38.9510, lon: -77.1465, type: "landmark", region: "northeast", alt: 300, desc: "Langley" },
      "MISC_NSA": { name: "NSA Headquarters", lat: 39.1089, lon: -76.7715, type: "landmark", region: "northeast", alt: 300, desc: "Fort Meade" },
      "MISC_WEST_POINT": { name: "West Point", lat: 41.3915, lon: -73.9564, type: "landmark", region: "northeast", alt: 200, desc: "US Military Academy" },
      "MISC_ANNAPOLIS": { name: "US Naval Academy", lat: 38.9822, lon: -76.4889, type: "landmark", region: "northeast", alt: 50, desc: "Annapolis" },
      "MISC_AIR_FORCE_ACADEMY": { name: "Air Force Academy", lat: 38.9983, lon: -104.8614, type: "landmark", region: "mountain", alt: 7200, desc: "Chapel spires" },
      "MISC_NORFOLK_NAVAL": { name: "Norfolk Naval Base", lat: 36.9419, lon: -76.3072, type: "landmark", region: "southeast", alt: 50, desc: "Largest US naval base" },
      "MISC_SAN_DIEGO_NAVAL": { name: "Naval Base San Diego", lat: 32.6869, lon: -117.1292, type: "landmark", region: "pacific", alt: 50, desc: "Pacific Fleet" },
      "MISC_PEARL_HARBOR_BASE": { name: "Joint Base Pearl Harbor", lat: 21.3545, lon: -157.9429, type: "landmark", region: "pacific", alt: 50, desc: "Pacific headquarters" },
      "MISC_NELLIS_AFB": { name: "Nellis Air Force Base", lat: 36.2360, lon: -115.0340, type: "landmark", region: "southwest", alt: 2000, desc: "Fighter training" },
      "MISC_EDWARDS_AFB": { name: "Edwards Air Force Base", lat: 34.9054, lon: -117.8836, type: "landmark", region: "pacific", alt: 2300, desc: "Flight test center" },
      "MISC_WRIGHT_PATTERSON": { name: "Wright-Patterson AFB", lat: 39.8261, lon: -84.0486, type: "landmark", region: "midwest", alt: 800, desc: "Air Force museum" },
      "MISC_KITTY_HAWK": { name: "Wright Brothers Memorial", lat: 36.0145, lon: -75.6681, type: "landmark", region: "southeast", alt: 100, desc: "First flight site" },
      "MISC_SMITHSONIAN_AIR": { name: "Air and Space Museum", lat: 38.8882, lon: -77.0199, type: "landmark", region: "northeast", alt: 50, desc: "National Mall" },
      "MISC_UDVAR_HAZY": { name: "Udvar-Hazy Center", lat: 38.9114, lon: -77.4440, type: "landmark", region: "northeast", alt: 400, desc: "Space Shuttle Discovery" },
      "MISC_INTREPID": { name: "Intrepid Museum", lat: 40.7645, lon: -74.0003, type: "landmark", region: "northeast", alt: 50, desc: "Aircraft carrier museum" },
      "MISC_USS_MIDWAY": { name: "USS Midway Museum", lat: 32.7137, lon: -117.1751, type: "landmark", region: "pacific", alt: 50, desc: "San Diego carrier" },
      "MISC_BATTLESHIP_NJ": { name: "Battleship New Jersey", lat: 39.9406, lon: -75.1317, type: "landmark", region: "northeast", alt: 50, desc: "Camden waterfront" },
      "MISC_USS_ALABAMA": { name: "USS Alabama", lat: 30.6817, lon: -88.0147, type: "landmark", region: "southeast", alt: 50, desc: "Mobile Bay" },
      "NAT_FINGER_LAKES": { name: "Finger Lakes", lat: 42.6500, lon: -76.8500, type: "lake", region: "northeast", alt: 800, desc: "NY wine country" },
      "NAT_LAKE_CHAMPLAIN": { name: "Lake Champlain", lat: 44.5333, lon: -73.3333, type: "lake", region: "northeast", alt: 100, desc: "VT/NY border" },
      "NAT_LAKE_GEORGE": { name: "Lake George", lat: 43.4236, lon: -73.7118, type: "lake", region: "northeast", alt: 400, desc: "Queen of American Lakes" },
      "NAT_LAKE_PLACID": { name: "Lake Placid", lat: 44.2795, lon: -73.9799, type: "lake", region: "northeast", alt: 1900, desc: "Olympic site" },
      "NAT_AUSABLE_CHASM": { name: "Ausable Chasm", lat: 44.5131, lon: -73.4589, type: "natural", region: "northeast", alt: 400, desc: "Grand Canyon of the East" },
      "NAT_WATKINS_GLEN": { name: "Watkins Glen State Park", lat: 42.3733, lon: -76.8772, type: "natural", region: "northeast", alt: 600, desc: "Gorge trail" },
      "NAT_LETCHWORTH": { name: "Letchworth State Park", lat: 42.5706, lon: -77.9656, type: "natural", region: "northeast", alt: 1000, desc: "Grand Canyon of the East" },
      "NAT_DELAWARE_GAP": { name: "Delaware Water Gap", lat: 40.9667, lon: -75.1333, type: "natural", region: "northeast", alt: 1500, desc: "Appalachian gap" },
      "NAT_RICKETTS_GLEN": { name: "Ricketts Glen State Park", lat: 41.3247, lon: -76.2883, type: "waterfall", region: "northeast", alt: 2400, desc: "22 named waterfalls" },
      "NAT_BUSHKILL_FALLS": { name: "Bushkill Falls", lat: 41.1239, lon: -75.0078, type: "waterfall", region: "northeast", alt: 1000, desc: "Niagara of Pennsylvania" },
      "NAT_OHIOPYLE": { name: "Ohiopyle Falls", lat: 39.8686, lon: -79.4950, type: "waterfall", region: "northeast", alt: 1200, desc: "Youghiogheny River" },
      "NAT_BLACKWATER_FALLS": { name: "Blackwater Falls", lat: 39.1142, lon: -79.4886, type: "waterfall", region: "southeast", alt: 3100, desc: "West Virginia" },
      "NAT_TALLULAH_GORGE": { name: "Tallulah Gorge", lat: 34.7381, lon: -83.3908, type: "natural", region: "southeast", alt: 1600, desc: "Georgia canyon" },
      "NAT_AMICALOLA_FALLS": { name: "Amicalola Falls", lat: 34.5611, lon: -84.2469, type: "waterfall", region: "southeast", alt: 2000, desc: "Tallest in Georgia" },
      "NAT_TOCCOA_FALLS": { name: "Toccoa Falls", lat: 34.5831, lon: -83.3319, type: "waterfall", region: "southeast", alt: 1500, desc: "186-foot drop" },
      "NAT_FALL_CREEK_FALLS": { name: "Fall Creek Falls", lat: 35.6639, lon: -85.3514, type: "waterfall", region: "southeast", alt: 1800, desc: "Tallest in eastern US" },
      "NAT_CUMBERLAND_FALLS": { name: "Cumberland Falls", lat: 36.8397, lon: -84.3450, type: "waterfall", region: "southeast", alt: 1200, desc: "Moonbow falls" },
      "NAT_NATURAL_BRIDGE_KY": { name: "Natural Bridge KY", lat: 37.7753, lon: -83.6842, type: "natural", region: "southeast", alt: 1400, desc: "Red River Gorge" },
      "NAT_RED_RIVER_GORGE": { name: "Red River Gorge", lat: 37.8000, lon: -83.6500, type: "natural", region: "southeast", alt: 1400, desc: "Kentucky climbing" },
      "NAT_MAMMOTH_CAVE_ENT": { name: "Mammoth Cave Entrance", lat: 37.1862, lon: -86.1008, type: "natural", region: "southeast", alt: 800, desc: "World's longest cave" },
      "NAT_LAND_BETWEEN_LAKES": { name: "Land Between the Lakes", lat: 36.8500, lon: -88.0667, type: "natural", region: "southeast", alt: 500, desc: "KY/TN recreation" },
      "NAT_REELFOOT_LAKE": { name: "Reelfoot Lake", lat: 36.3500, lon: -89.4000, type: "lake", region: "southeast", alt: 300, desc: "Earthquake lake" },
      "NAT_PETIT_JEAN": { name: "Petit Jean State Park", lat: 35.1167, lon: -92.9333, type: "natural", region: "southeast", alt: 1100, desc: "Arkansas canyon" },
      "NAT_DEVIL_DEN": { name: "Devil's Den State Park", lat: 35.7833, lon: -94.2333, type: "natural", region: "southeast", alt: 1500, desc: "Arkansas Ozarks" },
      "NAT_BLANCHARD_SPRINGS": { name: "Blanchard Springs Caverns", lat: 35.9667, lon: -91.9833, type: "natural", region: "southeast", alt: 800, desc: "Living cave" },
      "NAT_BUFFALO_RIVER": { name: "Buffalo National River", lat: 36.0333, lon: -92.7500, type: "natural", region: "southeast", alt: 600, desc: "First national river" },
      "NAT_OZARK_HIGHLANDS": { name: "Ozark Highlands", lat: 36.0000, lon: -93.5000, type: "natural", region: "midwest", alt: 2000, desc: "Ozark Mountains" },
      "NAT_TABLE_ROCK_LAKE": { name: "Table Rock Lake", lat: 36.6000, lon: -93.3500, type: "lake", region: "midwest", alt: 900, desc: "Missouri Ozarks" },
      "NAT_LAKE_OF_OZARKS": { name: "Lake of the Ozarks", lat: 38.1167, lon: -92.6333, type: "lake", region: "midwest", alt: 700, desc: "Dragon lake" },
      "NAT_MARK_TWAIN_CAVE": { name: "Mark Twain Cave", lat: 39.7108, lon: -91.3669, type: "natural", region: "midwest", alt: 600, desc: "Tom Sawyer cave" },
      "NAT_ELEPHANT_ROCKS": { name: "Elephant Rocks", lat: 37.6500, lon: -90.6833, type: "natural", region: "midwest", alt: 1200, desc: "Granite boulders" },
      "NAT_JOHNSON_SHUT_INS": { name: "Johnson's Shut-Ins", lat: 37.5500, lon: -90.8500, type: "natural", region: "midwest", alt: 1000, desc: "Natural waterpark" },
      "NAT_HA_HA_TONKA": { name: "Ha Ha Tonka State Park", lat: 37.9750, lon: -92.7750, type: "natural", region: "midwest", alt: 900, desc: "Castle ruins" },
      "NAT_MAQUOKETA_CAVES": { name: "Maquoketa Caves", lat: 42.0833, lon: -90.8333, type: "natural", region: "midwest", alt: 900, desc: "Iowa caves" },
      "NAT_EFFIGY_MOUNDS": { name: "Effigy Mounds", lat: 43.0875, lon: -91.1875, type: "natural", region: "midwest", alt: 1200, desc: "Ancient mounds" },
      "NAT_PALISADES_KEPLER": { name: "Palisades-Kepler", lat: 41.9167, lon: -91.5000, type: "natural", region: "midwest", alt: 800, desc: "Iowa bluffs" },
      "NAT_LEDGES": { name: "Ledges State Park", lat: 42.0167, lon: -93.8833, type: "natural", region: "midwest", alt: 1000, desc: "Sandstone bluffs" },
      "NAT_DEVIL_LAKE_WI": { name: "Devil's Lake", lat: 43.4167, lon: -89.7333, type: "lake", region: "midwest", alt: 1000, desc: "Wisconsin bluffs" },
      "NAT_CAVE_OF_MOUNDS": { name: "Cave of the Mounds", lat: 43.0167, lon: -89.8333, type: "natural", region: "midwest", alt: 1100, desc: "Wisconsin cave" },
      "NAT_WISCONSIN_DELLS": { name: "Wisconsin Dells", lat: 43.6275, lon: -89.7708, type: "natural", region: "midwest", alt: 900, desc: "Sandstone gorge" },
      "NAT_GOOSEBERRY_FALLS": { name: "Gooseberry Falls", lat: 47.1333, lon: -91.4667, type: "waterfall", region: "midwest", alt: 700, desc: "North Shore" },
      "NAT_HIGH_FALLS_MN": { name: "High Falls MN", lat: 47.9833, lon: -89.9833, type: "waterfall", region: "midwest", alt: 1300, desc: "Grand Portage" },
      "NAT_TAYLORS_FALLS": { name: "Taylors Falls", lat: 45.4019, lon: -92.6536, type: "natural", region: "midwest", alt: 900, desc: "St. Croix Dalles" },
      "NAT_LAKE_ITASCA": { name: "Lake Itasca", lat: 47.2333, lon: -95.2000, type: "lake", region: "midwest", alt: 1500, desc: "Mississippi headwaters" },
      "NAT_BOUNDARY_WATERS": { name: "Boundary Waters", lat: 48.0000, lon: -91.0000, type: "natural", region: "midwest", alt: 1500, desc: "Canoe wilderness" },
      "NAT_PORCUPINE_MTNS": { name: "Porcupine Mountains", lat: 46.7833, lon: -89.8333, type: "mountain", region: "midwest", alt: 2000, desc: "Lake of the Clouds" },
      "NAT_TAHQUAMENON": { name: "Tahquamenon Falls", lat: 46.5833, lon: -85.2500, type: "waterfall", region: "midwest", alt: 800, desc: "Root beer falls" },
      "NAT_KITCH_ITI_KIPI": { name: "Kitch-iti-kipi", lat: 45.9167, lon: -86.4000, type: "natural", region: "midwest", alt: 700, desc: "Big Spring" },
      "NAT_MACKINAC_ISLAND": { name: "Mackinac Island", lat: 45.8492, lon: -84.6189, type: "natural", region: "midwest", alt: 700, desc: "No cars island" },
      "NAT_SCOTTS_BLUFF_SUMMIT": { name: "Scotts Bluff Summit", lat: 41.8331, lon: -103.7075, type: "natural", region: "midwest", alt: 4600, desc: "Oregon Trail view" },
      "NAT_TOADSTOOL_PARK": { name: "Toadstool Geologic Park", lat: 42.8500, lon: -103.5667, type: "natural", region: "midwest", alt: 4200, desc: "Badlands formations" },
      "NAT_SMITH_FALLS": { name: "Smith Falls", lat: 42.8833, lon: -100.3333, type: "waterfall", region: "midwest", alt: 2400, desc: "Nebraska's tallest" },
      "NAT_CATHEDRAL_SPIRES": { name: "Cathedral Spires", lat: 43.8333, lon: -103.5500, type: "natural", region: "midwest", alt: 5500, desc: "Custer SP" },
      "NAT_SYLVAN_LAKE": { name: "Sylvan Lake", lat: 43.8500, lon: -103.5667, type: "lake", region: "midwest", alt: 6200, desc: "Black Hills gem" },
      "NAT_HARNEY_PEAK": { name: "Black Elk Peak", lat: 43.8658, lon: -103.5319, type: "mountain", region: "midwest", alt: 7244, desc: "Highest east of Rockies" },
      "NAT_FLAMING_GORGE": { name: "Flaming Gorge", lat: 41.1000, lon: -109.5000, type: "natural", region: "mountain", alt: 6000, desc: "Red canyon" },
      "NAT_DINOSAUR_NM": { name: "Dinosaur National Monument", lat: 40.5333, lon: -108.9667, type: "natural", region: "mountain", alt: 5000, desc: "Fossil beds" },
      "NAT_COLORADO_NM": { name: "Colorado National Monument", lat: 39.0500, lon: -108.7333, type: "natural", region: "mountain", alt: 6500, desc: "Red rock canyons" },
      "NAT_BLACK_CANYON_VIEW": { name: "Black Canyon Overlook", lat: 38.5758, lon: -107.7269, type: "natural", region: "mountain", alt: 8000, desc: "2000-foot drop" },
      "NAT_GREAT_SAND_DUNES_HIGH": { name: "High Dune", lat: 37.7328, lon: -105.5119, type: "natural", region: "mountain", alt: 8900, desc: "Tallest dune" },
      "NAT_MESA_VERDE_CLIFF": { name: "Cliff Palace", lat: 37.1675, lon: -108.4728, type: "natural", region: "southwest", alt: 7000, desc: "Ancestral Puebloan" },
      "NAT_DURANGO_SILVERTON": { name: "Animas River Valley", lat: 37.5333, lon: -107.6500, type: "natural", region: "southwest", alt: 9000, desc: "Historic railroad" },
      "NAT_TELLURIDE": { name: "Telluride Box Canyon", lat: 37.9375, lon: -107.8117, type: "natural", region: "mountain", alt: 9500, desc: "Bridal Veil Falls" },
      "NAT_BRIDAL_VEIL_CO": { name: "Bridal Veil Falls CO", lat: 37.9264, lon: -107.7694, type: "waterfall", region: "mountain", alt: 10000, desc: "Tallest in Colorado" },
      "NAT_GLENWOOD_CANYON": { name: "Glenwood Canyon", lat: 39.5500, lon: -107.3333, type: "natural", region: "mountain", alt: 6000, desc: "I-70 engineering marvel" },
      "NAT_HANGING_LAKE": { name: "Hanging Lake", lat: 39.6014, lon: -107.1947, type: "lake", region: "mountain", alt: 7300, desc: "Travertine lake" },
      "NAT_INDEPENDENCE_PASS": { name: "Independence Pass", lat: 39.1075, lon: -106.5631, type: "natural", region: "mountain", alt: 12095, desc: "Continental Divide" },
      "NAT_LOVELAND_PASS": { name: "Loveland Pass", lat: 39.6636, lon: -105.8786, type: "natural", region: "mountain", alt: 11990, desc: "Continental Divide" },
      "NAT_BERTHOUD_PASS": { name: "Berthoud Pass", lat: 39.7981, lon: -105.7775, type: "natural", region: "mountain", alt: 11307, desc: "Winter Park access" },
      "NAT_LOGAN_PASS": { name: "Logan Pass", lat: 48.6967, lon: -113.7181, type: "natural", region: "mountain", alt: 6646, desc: "Going-to-the-Sun Road summit" },
      "NAT_BEARTOOTH_PASS": { name: "Beartooth Pass", lat: 44.9761, lon: -109.4428, type: "natural", region: "mountain", alt: 10947, desc: "Most scenic drive" },
      "NAT_CHIEF_JOSEPH": { name: "Chief Joseph Scenic Byway", lat: 44.8333, lon: -109.3333, type: "natural", region: "mountain", alt: 8000, desc: "Wyoming scenic" },
      "NAT_TETON_PASS": { name: "Teton Pass", lat: 43.4933, lon: -110.9539, type: "natural", region: "mountain", alt: 8432, desc: "Jackson Hole access" },
      "NAT_OXBOW_BEND": { name: "Oxbow Bend", lat: 43.8653, lon: -110.5458, type: "natural", region: "mountain", alt: 6800, desc: "Teton reflection" },
      "NAT_SCHWABACHER": { name: "Schwabacher Landing", lat: 43.7172, lon: -110.6736, type: "natural", region: "mountain", alt: 6600, desc: "Snake River view" },
      "NAT_LAMAR_VALLEY": { name: "Lamar Valley", lat: 44.8667, lon: -110.1833, type: "natural", region: "mountain", alt: 6700, desc: "American Serengeti" },
      "NAT_HAYDEN_VALLEY": { name: "Hayden Valley", lat: 44.6500, lon: -110.4667, type: "natural", region: "mountain", alt: 7700, desc: "Bison valley" },
      "NAT_NORRIS_GEYSER": { name: "Norris Geyser Basin", lat: 44.7261, lon: -110.7033, type: "geothermal", region: "mountain", alt: 7500, desc: "Hottest geyser basin" },
      "NAT_MIDWAY_GEYSER": { name: "Midway Geyser Basin", lat: 44.5253, lon: -110.8378, type: "geothermal", region: "mountain", alt: 7300, desc: "Grand Prismatic" },
      "NAT_WEST_THUMB": { name: "West Thumb Geyser Basin", lat: 44.4167, lon: -110.5667, type: "geothermal", region: "mountain", alt: 7800, desc: "Lakeside geysers" },
      "NAT_YELLOWSTONE_LAKE": { name: "Yellowstone Lake", lat: 44.5000, lon: -110.3333, type: "lake", region: "mountain", alt: 7733, desc: "Largest high-altitude lake" },
      "NAT_FIREHOLE_RIVER": { name: "Firehole River", lat: 44.5500, lon: -110.8333, type: "natural", region: "mountain", alt: 7200, desc: "Geothermal river" },
      "NAT_TOWER_FALLS": { name: "Tower Fall Yellowstone", lat: 44.8928, lon: -110.3881, type: "waterfall", region: "mountain", alt: 6600, desc: "132-foot drop" },
      "NAT_GIBBON_FALLS": { name: "Gibbon Falls", lat: 44.6631, lon: -110.7333, type: "waterfall", region: "mountain", alt: 7200, desc: "84-foot cascade" },
      "NAT_KEPLER_CASCADES": { name: "Kepler Cascades", lat: 44.4500, lon: -110.8167, type: "waterfall", region: "mountain", alt: 7300, desc: "150-foot cascade" },
      "NAT_LEWIS_FALLS": { name: "Lewis Falls", lat: 44.3369, lon: -110.6519, type: "waterfall", region: "mountain", alt: 7800, desc: "30-foot falls" },
      "NAT_VIRGINIA_FALLS": { name: "Virginia Cascade", lat: 44.7500, lon: -110.5833, type: "waterfall", region: "mountain", alt: 7500, desc: "60-foot falls" },
      "NAT_UNDINE_FALLS": { name: "Undine Falls", lat: 44.9333, lon: -110.4833, type: "waterfall", region: "mountain", alt: 6400, desc: "Three-tier falls" },
      "NAT_WRAITH_FALLS": { name: "Wraith Falls", lat: 44.9167, lon: -110.4833, type: "waterfall", region: "mountain", alt: 6500, desc: "79-foot falls" },
      "NAT_GRAND_CANYON_YNP": { name: "Grand Canyon of Yellowstone", lat: 44.7167, lon: -110.4833, type: "natural", region: "mountain", alt: 7700, desc: "Artist Point" },
      "NAT_INSPIRATION_POINT": { name: "Inspiration Point YNP", lat: 44.7203, lon: -110.4750, type: "natural", region: "mountain", alt: 7800, desc: "Canyon overlook" },
      "NAT_ARTIST_POINT": { name: "Artist Point", lat: 44.7167, lon: -110.4833, type: "natural", region: "mountain", alt: 7800, desc: "Classic view" },
      "NAT_LOOKOUT_POINT": { name: "Lookout Point", lat: 44.7194, lon: -110.4917, type: "natural", region: "mountain", alt: 7700, desc: "Lower Falls view" },
      "NAT_MOUNT_WASHBURN": { name: "Mount Washburn", lat: 44.7978, lon: -110.4344, type: "mountain", region: "mountain", alt: 10243, desc: "Yellowstone high point" },
      "NAT_ELECTRIC_PEAK": { name: "Electric Peak", lat: 45.0083, lon: -110.8472, type: "mountain", region: "mountain", alt: 10969, desc: "Gallatin Range" },
      "PNW_CRATER_LAKE_RIM": { name: "Crater Lake Rim Drive", lat: 42.9100, lon: -122.1000, type: "natural", region: "pacific", alt: 7100, desc: "Rim viewpoint" },
      "PNW_WIZARD_ISLAND": { name: "Wizard Island", lat: 42.9428, lon: -122.1469, type: "natural", region: "pacific", alt: 6940, desc: "Cinder cone island" },
      "PNW_PHANTOM_SHIP": { name: "Phantom Ship", lat: 42.9058, lon: -122.0700, type: "natural", region: "pacific", alt: 6200, desc: "Rock formation" },
      "PNW_NEWBERRY_VOLCANO": { name: "Newberry Volcanic Monument", lat: 43.7167, lon: -121.2333, type: "natural", region: "pacific", alt: 7000, desc: "Paulina Falls" },
      "PNW_SMITH_ROCK": { name: "Smith Rock", lat: 44.3683, lon: -121.1403, type: "natural", region: "pacific", alt: 3200, desc: "Climbing mecca" },
      "PNW_PAINTED_HILLS": { name: "Painted Hills", lat: 44.6614, lon: -120.2672, type: "natural", region: "pacific", alt: 2800, desc: "John Day Fossil Beds" },
      "PNW_JOHN_DAY_FOSSIL": { name: "John Day Fossil Beds", lat: 44.5500, lon: -119.6333, type: "natural", region: "pacific", alt: 2500, desc: "Sheep Rock Unit" },
      "PNW_SILVER_FALLS": { name: "Silver Falls State Park", lat: 44.8767, lon: -122.6533, type: "waterfall", region: "pacific", alt: 1500, desc: "Trail of Ten Falls" },
      "PNW_PROXY_FALLS": { name: "Proxy Falls", lat: 44.1667, lon: -121.9333, type: "waterfall", region: "pacific", alt: 4000, desc: "Cascades waterfall" },
      "PNW_SAHALIE_FALLS": { name: "Sahalie Falls", lat: 44.3489, lon: -121.9972, type: "waterfall", region: "pacific", alt: 3000, desc: "McKenzie River" },
      "PNW_KOOSAH_FALLS": { name: "Koosah Falls", lat: 44.3408, lon: -121.9972, type: "waterfall", region: "pacific", alt: 2900, desc: "McKenzie River" },
      "PNW_BLUE_POOL": { name: "Blue Pool (Tamolitch)", lat: 44.3117, lon: -122.0117, type: "natural", region: "pacific", alt: 2400, desc: "Crystal clear pool" },
      "PNW_THREE_SISTERS": { name: "Three Sisters Wilderness", lat: 44.1000, lon: -121.7667, type: "mountain", region: "pacific", alt: 10358, desc: "South Sister" },
      "PNW_BROKEN_TOP": { name: "Broken Top", lat: 44.0833, lon: -121.7000, type: "mountain", region: "pacific", alt: 9175, desc: "Eroded stratovolcano" },
      "PNW_MOUNT_BACHELOR": { name: "Mount Bachelor", lat: 43.9792, lon: -121.6886, type: "mountain", region: "pacific", alt: 9068, desc: "Ski resort" },
      "PNW_MOUNT_JEFFERSON": { name: "Mount Jefferson", lat: 44.6742, lon: -121.7997, type: "mountain", region: "pacific", alt: 10497, desc: "Second highest in Oregon" },
      "PNW_MOUNT_ADAMS": { name: "Mount Adams", lat: 46.2024, lon: -121.4909, type: "mountain", region: "pacific", alt: 12281, desc: "Washington volcano" },
      "PNW_MOUNT_BAKER": { name: "Mount Baker", lat: 48.7768, lon: -121.8145, type: "mountain", region: "pacific", alt: 10781, desc: "North Cascades volcano" },
      "PNW_GLACIER_PEAK": { name: "Glacier Peak", lat: 48.1117, lon: -121.1139, type: "mountain", region: "pacific", alt: 10541, desc: "Remote volcano" },
      "PNW_DIABLO_LAKE": { name: "Diablo Lake", lat: 48.7142, lon: -121.1075, type: "lake", region: "pacific", alt: 1200, desc: "Turquoise glacial lake" },
      "PNW_ROSS_LAKE": { name: "Ross Lake", lat: 48.8833, lon: -121.0667, type: "lake", region: "pacific", alt: 1600, desc: "North Cascades reservoir" },
      "PNW_LAKE_CHELAN": { name: "Lake Chelan", lat: 47.8667, lon: -120.2000, type: "lake", region: "pacific", alt: 1100, desc: "Third deepest US lake" },
      "PNW_DRY_FALLS": { name: "Dry Falls", lat: 47.6000, lon: -119.3667, type: "natural", region: "pacific", alt: 1500, desc: "Ice Age waterfall" },
      "PNW_GRAND_COULEE": { name: "Grand Coulee", lat: 47.6500, lon: -119.0000, type: "natural", region: "pacific", alt: 1800, desc: "Ice Age canyon" },
      "PNW_SPOKANE_FALLS": { name: "Spokane Falls", lat: 47.6597, lon: -117.4281, type: "waterfall", region: "pacific", alt: 1900, desc: "Urban waterfall" },
      "PNW_WALLACE_FALLS": { name: "Wallace Falls", lat: 47.8667, lon: -121.6833, type: "waterfall", region: "pacific", alt: 1500, desc: "265-foot falls" },
      "PNW_TWIN_FALLS_WA": { name: "Twin Falls WA", lat: 47.4500, lon: -121.7000, type: "waterfall", region: "pacific", alt: 1000, desc: "South Fork Snoqualmie" },
      "PNW_POINT_DEFIANCE": { name: "Point Defiance", lat: 47.3128, lon: -122.5283, type: "natural", region: "pacific", alt: 200, desc: "Tacoma park" },
      "PNW_OLYMPIC_HOT_SPRINGS": { name: "Olympic Hot Springs", lat: 47.9833, lon: -123.6833, type: "natural", region: "pacific", alt: 2000, desc: "Natural hot springs" },
      "PNW_SOL_DUC_FALLS": { name: "Sol Duc Falls", lat: 47.9500, lon: -123.8333, type: "waterfall", region: "pacific", alt: 2000, desc: "Olympic NP" },
      "PNW_MARYMERE_FALLS": { name: "Marymere Falls", lat: 48.0667, lon: -123.8000, type: "waterfall", region: "pacific", alt: 1000, desc: "Lake Crescent" },
      "PNW_HOH_RAINFOREST": { name: "Hoh Rain Forest", lat: 47.8600, lon: -123.9342, type: "natural", region: "pacific", alt: 500, desc: "Temperate rainforest" },
      "PNW_RIALTO_BEACH": { name: "Rialto Beach", lat: 47.9167, lon: -124.6333, type: "natural", region: "pacific", alt: 20, desc: "Sea stacks" },
      "PNW_RUBY_BEACH": { name: "Ruby Beach", lat: 47.7108, lon: -124.4133, type: "natural", region: "pacific", alt: 20, desc: "Olympic coast" },
      "PNW_KALALOCH": { name: "Kalaloch Beach", lat: 47.6133, lon: -124.3750, type: "natural", region: "pacific", alt: 20, desc: "Tree of Life" },
      "PNW_CAPE_PERPETUA": { name: "Cape Perpetua", lat: 44.2833, lon: -124.1000, type: "natural", region: "pacific", alt: 800, desc: "Oregon coast viewpoint" },
      "PNW_THORS_WELL": { name: "Thor's Well", lat: 44.2833, lon: -124.1167, type: "natural", region: "pacific", alt: 20, desc: "Draining sinkhole" },
      "PNW_DEVILS_CHURN": { name: "Devil's Churn", lat: 44.2833, lon: -124.1083, type: "natural", region: "pacific", alt: 50, desc: "Narrow inlet" },
      "PNW_HAYSTACK_ROCK": { name: "Haystack Rock", lat: 45.8847, lon: -123.9686, type: "natural", region: "pacific", alt: 235, desc: "Cannon Beach icon" },
      "PNW_ECOLA_STATE": { name: "Ecola State Park", lat: 45.9167, lon: -123.9667, type: "natural", region: "pacific", alt: 500, desc: "Goonies location" },
      "PNW_TILLAMOOK_HEAD": { name: "Tillamook Head", lat: 45.9500, lon: -123.9667, type: "natural", region: "pacific", alt: 1200, desc: "Lewis & Clark trail" },
      "PNW_MUIR_WOODS": { name: "Muir Woods", lat: 37.8970, lon: -122.5811, type: "natural", region: "pacific", alt: 300, desc: "Old-growth redwoods" },
      "PNW_STINSON_BEACH": { name: "Stinson Beach", lat: 37.9000, lon: -122.6333, type: "natural", region: "pacific", alt: 20, desc: "Marin coast" },
      "PNW_MARIN_HEADLANDS": { name: "Marin Headlands", lat: 37.8333, lon: -122.5000, type: "natural", region: "pacific", alt: 1000, desc: "Golden Gate view" },
      "PNW_DEVILS_SLIDE": { name: "Devil's Slide", lat: 37.5750, lon: -122.5167, type: "natural", region: "pacific", alt: 500, desc: "Coastal trail" },
      "PNW_ANO_NUEVO": { name: "AÃ±o Nuevo State Park", lat: 37.1083, lon: -122.3083, type: "natural", region: "pacific", alt: 100, desc: "Elephant seal rookery" },
      "PNW_NATURAL_BRIDGES": { name: "Natural Bridges State Beach", lat: 36.9500, lon: -122.0583, type: "natural", region: "pacific", alt: 50, desc: "Sea arch" },
      "PNW_CARMEL_MISSION": { name: "Carmel Mission", lat: 36.5431, lon: -121.9214, type: "landmark", region: "pacific", alt: 100, desc: "Historic mission" },
      "PNW_LONE_CYPRESS": { name: "Lone Cypress", lat: 36.5697, lon: -121.9656, type: "natural", region: "pacific", alt: 50, desc: "Iconic tree" },
      "PNW_MCWAY_FALLS": { name: "McWay Falls", lat: 36.1581, lon: -121.6722, type: "waterfall", region: "pacific", alt: 100, desc: "Beach waterfall" },
      "PNW_PFEIFFER_BEACH": { name: "Pfeiffer Beach", lat: 36.2389, lon: -121.8167, type: "natural", region: "pacific", alt: 20, desc: "Keyhole Arch" },
      "PNW_JULIA_PFEIFFER": { name: "Julia Pfeiffer Burns SP", lat: 36.1583, lon: -121.6667, type: "natural", region: "pacific", alt: 200, desc: "Big Sur park" },
      "PNW_NEPENTHE": { name: "Nepenthe Viewpoint", lat: 36.2000, lon: -121.7667, type: "natural", region: "pacific", alt: 800, desc: "Big Sur restaurant view" },
      "CA_JOSHUA_TREE_ARCH": { name: "Arch Rock", lat: 33.9953, lon: -116.0331, type: "natural", region: "pacific", alt: 4200, desc: "Joshua Tree NP" },
      "CA_SKULL_ROCK": { name: "Skull Rock", lat: 34.0139, lon: -116.0361, type: "natural", region: "pacific", alt: 4300, desc: "Joshua Tree NP" },
      "CA_CHOLLA_GARDEN": { name: "Cholla Cactus Garden", lat: 33.9256, lon: -115.9281, type: "natural", region: "pacific", alt: 3000, desc: "Joshua Tree NP" },
      "CA_KEYS_VIEW": { name: "Keys View", lat: 33.9192, lon: -116.1858, type: "natural", region: "pacific", alt: 5185, desc: "Coachella Valley view" },
      "CA_PALM_SPRINGS_TRAM": { name: "Palm Springs Aerial Tramway", lat: 33.8344, lon: -116.6142, type: "landmark", region: "pacific", alt: 8516, desc: "Mountain Station" },
      "CA_ANZA_BORREGO": { name: "Anza-Borrego Desert SP", lat: 33.0833, lon: -116.3000, type: "natural", region: "pacific", alt: 1500, desc: "Desert wildflowers" },
      "CA_FONT_POINT": { name: "Fonts Point", lat: 33.2167, lon: -116.2167, type: "natural", region: "pacific", alt: 1200, desc: "Badlands overlook" },
      "CA_SLOT_CANYON": { name: "Slot Canyon Anza-Borrego", lat: 33.2000, lon: -116.2333, type: "natural", region: "pacific", alt: 1000, desc: "Desert slot canyon" },
      "CA_TORREY_PINES": { name: "Torrey Pines State Reserve", lat: 32.9167, lon: -117.2500, type: "natural", region: "pacific", alt: 300, desc: "Rare pine trees" },
      "CA_LA_JOLLA_COVE": { name: "La Jolla Cove", lat: 32.8500, lon: -117.2722, type: "natural", region: "pacific", alt: 50, desc: "Sea caves" },
      "CA_SUNSET_CLIFFS": { name: "Sunset Cliffs", lat: 32.7167, lon: -117.2583, type: "natural", region: "pacific", alt: 100, desc: "Ocean Beach cliffs" },
      "CA_CABRILLO_NM": { name: "Cabrillo National Monument", lat: 32.6733, lon: -117.2417, type: "landmark", region: "pacific", alt: 400, desc: "Point Loma tidepools" },
      "CA_MISSION_BEACH": { name: "Mission Beach", lat: 32.7700, lon: -117.2528, type: "natural", region: "pacific", alt: 10, desc: "San Diego beach" },
      "CA_CHANNEL_ISLANDS_VIEW": { name: "Channel Islands View", lat: 34.0069, lon: -119.7785, type: "natural", region: "pacific", alt: 1000, desc: "Santa Cruz Island" },
      "CA_MORRO_ROCK": { name: "Morro Rock", lat: 35.3708, lon: -120.8694, type: "natural", region: "pacific", alt: 581, desc: "Volcanic plug" },
      "CA_HEARST_BEACH": { name: "Hearst San Simeon", lat: 35.6111, lon: -121.1917, type: "natural", region: "pacific", alt: 50, desc: "Elephant seal beach" },
      "CA_PIEDRAS_BLANCAS": { name: "Piedras Blancas", lat: 35.6650, lon: -121.2833, type: "natural", region: "pacific", alt: 50, desc: "Elephant seal rookery" },
      "CA_RAGGED_POINT": { name: "Ragged Point", lat: 35.7833, lon: -121.3333, type: "natural", region: "pacific", alt: 400, desc: "Big Sur gateway" },
      "CA_KINGS_BEACH": { name: "Kings Beach", lat: 39.2375, lon: -120.0264, type: "natural", region: "pacific", alt: 6230, desc: "North Lake Tahoe" },
      "CA_EMERALD_BAY": { name: "Emerald Bay", lat: 38.9500, lon: -120.1000, type: "natural", region: "pacific", alt: 6500, desc: "Lake Tahoe icon" },
      "CA_VIKINGSHOLM": { name: "Vikingsholm", lat: 38.9544, lon: -120.1058, type: "landmark", region: "pacific", alt: 6300, desc: "Scandinavian castle" },
      "CA_EAGLE_FALLS_TAHOE": { name: "Eagle Falls", lat: 38.9533, lon: -120.1117, type: "waterfall", region: "pacific", alt: 6600, desc: "Emerald Bay view" },
      "CA_SAND_HARBOR": { name: "Sand Harbor", lat: 39.1983, lon: -119.9297, type: "natural", region: "pacific", alt: 6230, desc: "Boulder beach" },
      "CA_DONNER_LAKE": { name: "Donner Lake", lat: 39.3233, lon: -120.2372, type: "lake", region: "pacific", alt: 5900, desc: "Historic pass" },
      "SW_GLEN_CANYON": { name: "Glen Canyon", lat: 37.0500, lon: -111.4833, type: "natural", region: "southwest", alt: 3800, desc: "Colorado River" },
      "SW_REFLECTION_CANYON": { name: "Reflection Canyon", lat: 37.4167, lon: -110.8500, type: "natural", region: "southwest", alt: 4200, desc: "Lake Powell" },
      "SW_ALSTROM_POINT": { name: "Alstrom Point", lat: 37.3333, lon: -111.0500, type: "natural", region: "southwest", alt: 4500, desc: "Lake Powell overlook" },
      "SW_WAHWEAP": { name: "Wahweap Marina", lat: 36.9833, lon: -111.4833, type: "natural", region: "southwest", alt: 3700, desc: "Lake Powell" },
      "SW_CATHEDRAL_ROCK": { name: "Cathedral Rock", lat: 34.8228, lon: -111.7897, type: "natural", region: "southwest", alt: 4900, desc: "Sedona icon" },
      "SW_BELL_ROCK": { name: "Bell Rock", lat: 34.8069, lon: -111.7628, type: "natural", region: "southwest", alt: 4900, desc: "Sedona vortex" },
      "SW_DEVIL_BRIDGE": { name: "Devil's Bridge", lat: 34.8989, lon: -111.8133, type: "natural", region: "southwest", alt: 4600, desc: "Sedona arch" },
      "SW_OAK_CREEK_CANYON": { name: "Oak Creek Canyon", lat: 34.9500, lon: -111.7333, type: "natural", region: "southwest", alt: 5500, desc: "Sedona scenic drive" },
      "SW_SLIDE_ROCK": { name: "Slide Rock State Park", lat: 34.9333, lon: -111.7500, type: "natural", region: "southwest", alt: 5000, desc: "Natural waterslide" },
      "SW_WEST_FORK": { name: "West Fork Trail", lat: 34.9861, lon: -111.7417, type: "natural", region: "southwest", alt: 5300, desc: "Oak Creek hike" },
      "SW_SNOOPY_ROCK": { name: "Snoopy Rock", lat: 34.8739, lon: -111.7650, type: "natural", region: "southwest", alt: 4600, desc: "Sedona formation" },
      "SW_COFFEE_POT_ROCK": { name: "Coffee Pot Rock", lat: 34.8819, lon: -111.7831, type: "natural", region: "southwest", alt: 5200, desc: "Sedona formation" },
      "SW_COURTHOUSE_BUTTE": { name: "Courthouse Butte", lat: 34.8033, lon: -111.7483, type: "natural", region: "southwest", alt: 5400, desc: "Sedona landmark" },
      "SW_CHAPEL_HOLY_CROSS": { name: "Chapel of the Holy Cross", lat: 34.8283, lon: -111.7731, type: "landmark", region: "southwest", alt: 4700, desc: "Sedona chapel" },
      "SW_TLAQUEPAQUE": { name: "Tlaquepaque", lat: 34.8611, lon: -111.7611, type: "landmark", region: "southwest", alt: 4300, desc: "Sedona arts village" },
      "SW_JEROME": { name: "Jerome Ghost Town", lat: 34.7489, lon: -112.1139, type: "landmark", region: "southwest", alt: 5200, desc: "Mining town" },
      "SW_MONTEZUMA_CASTLE": { name: "Montezuma Castle", lat: 34.6114, lon: -111.8375, type: "landmark", region: "southwest", alt: 3300, desc: "Cliff dwelling" },
      "SW_MONTEZUMA_WELL": { name: "Montezuma Well", lat: 34.6433, lon: -111.7567, type: "natural", region: "southwest", alt: 3600, desc: "Limestone sinkhole" },
      "SW_TUZIGOOT": { name: "Tuzigoot National Monument", lat: 34.7700, lon: -112.0283, type: "landmark", region: "southwest", alt: 3500, desc: "Sinagua ruins" },
      "SW_SUNSET_CRATER": { name: "Sunset Crater Volcano", lat: 35.3653, lon: -111.5008, type: "natural", region: "southwest", alt: 7000, desc: "Volcanic cone" },
      "SW_WUPATKI": { name: "Wupatki National Monument", lat: 35.5192, lon: -111.3667, type: "landmark", region: "southwest", alt: 4900, desc: "Puebloan ruins" },
      "SW_WALNUT_CANYON": { name: "Walnut Canyon", lat: 35.1717, lon: -111.5092, type: "natural", region: "southwest", alt: 6700, desc: "Cliff dwellings" },
      "SW_METEOR_CRATER_VIEW": { name: "Meteor Crater Rim", lat: 35.0275, lon: -111.0228, type: "natural", region: "southwest", alt: 5700, desc: "Impact crater" },
      "SW_PETRIFIED_FOREST": { name: "Petrified Forest", lat: 34.9100, lon: -109.8068, type: "natural", region: "southwest", alt: 5400, desc: "Ancient logs" },
      "SW_BLUE_MESA": { name: "Blue Mesa", lat: 34.8833, lon: -109.7833, type: "natural", region: "southwest", alt: 5500, desc: "Painted Desert" },
      "SW_NEWSPAPER_ROCK_AZ": { name: "Newspaper Rock AZ", lat: 34.9500, lon: -109.9500, type: "natural", region: "southwest", alt: 5400, desc: "Petroglyphs" },
      "SW_CANYON_DE_CHELLY": { name: "Canyon de Chelly", lat: 36.1333, lon: -109.4667, type: "natural", region: "southwest", alt: 5500, desc: "Navajo sacred site" },
      "SW_SPIDER_ROCK": { name: "Spider Rock", lat: 36.0833, lon: -109.3833, type: "natural", region: "southwest", alt: 5500, desc: "800-foot spire" },
      "SW_WHITE_HOUSE_RUINS": { name: "White House Ruins", lat: 36.1333, lon: -109.4833, type: "landmark", region: "southwest", alt: 5300, desc: "Cliff dwelling" },
      "SW_WINDOW_ROCK": { name: "Window Rock", lat: 35.6808, lon: -109.0525, type: "natural", region: "southwest", alt: 6700, desc: "Navajo capital" },
      "SW_MONUMENT_VALLEY_MITTENS": { name: "The Mittens", lat: 36.9900, lon: -110.1000, type: "natural", region: "southwest", alt: 5200, desc: "Iconic buttes" },
      "SW_JOHN_FORD_POINT": { name: "John Ford Point", lat: 36.9608, lon: -110.1000, type: "natural", region: "southwest", alt: 5200, desc: "Movie location" },
      "SW_TOTEM_POLE": { name: "Totem Pole", lat: 37.0069, lon: -110.1239, type: "natural", region: "southwest", alt: 5200, desc: "Monument Valley spire" },
      "SW_HUNTS_MESA": { name: "Hunt's Mesa", lat: 36.9500, lon: -110.1333, type: "natural", region: "southwest", alt: 5800, desc: "Monument Valley view" },
      "SW_GOOSENECKS": { name: "Goosenecks State Park", lat: 37.1756, lon: -109.9269, type: "natural", region: "southwest", alt: 5000, desc: "San Juan meanders" },
      "SW_VALLEY_OF_GODS": { name: "Valley of the Gods", lat: 37.2667, lon: -109.8833, type: "natural", region: "southwest", alt: 5000, desc: "Mini Monument Valley" },
      "SW_MOKI_DUGWAY": { name: "Moki Dugway", lat: 37.2750, lon: -109.9417, type: "natural", region: "southwest", alt: 6000, desc: "Switchback road" },
      "SW_NATURAL_BRIDGES": { name: "Natural Bridges NM", lat: 37.6000, lon: -110.0000, type: "natural", region: "southwest", alt: 6500, desc: "Three bridges" },
      "SW_SIPAPU_BRIDGE": { name: "Sipapu Bridge", lat: 37.5833, lon: -110.0167, type: "natural", region: "southwest", alt: 6400, desc: "Second largest natural bridge" },
      "SW_KACHINA_BRIDGE": { name: "Kachina Bridge", lat: 37.5917, lon: -109.9917, type: "natural", region: "southwest", alt: 6300, desc: "Natural bridge" },
      "SW_OWACHOMO_BRIDGE": { name: "Owachomo Bridge", lat: 37.6083, lon: -109.9833, type: "natural", region: "southwest", alt: 6200, desc: "Thinnest natural bridge" },
      "SW_GOBLIN_VALLEY": { name: "Goblin Valley", lat: 38.5700, lon: -110.7000, type: "natural", region: "southwest", alt: 5000, desc: "Hoodoo formations" },
      "SW_SAN_RAFAEL_SWELL": { name: "San Rafael Swell", lat: 38.8333, lon: -110.6667, type: "natural", region: "southwest", alt: 6000, desc: "Geologic uplift" },
      "SW_LITTLE_WILD_HORSE": { name: "Little Wild Horse Canyon", lat: 38.5833, lon: -110.7333, type: "natural", region: "southwest", alt: 5200, desc: "Slot canyon" },
      "SW_FACTORY_BUTTE": { name: "Factory Butte", lat: 38.4167, lon: -110.9833, type: "natural", region: "southwest", alt: 5500, desc: "Mars-like landscape" },
      "SW_CAPITOL_REEF_DOME": { name: "Capitol Dome", lat: 38.2833, lon: -111.2167, type: "natural", region: "southwest", alt: 6500, desc: "White sandstone dome" },
      "SW_HICKMAN_BRIDGE": { name: "Hickman Bridge", lat: 38.2889, lon: -111.2275, type: "natural", region: "southwest", alt: 5600, desc: "Capitol Reef arch" },
      "SW_CASSIDY_ARCH": { name: "Cassidy Arch", lat: 38.2833, lon: -111.2500, type: "natural", region: "southwest", alt: 6400, desc: "Capitol Reef" },
      "SW_GRAND_WASH": { name: "Grand Wash", lat: 38.2667, lon: -111.2333, type: "natural", region: "southwest", alt: 5400, desc: "Capitol Reef narrows" },
      "SW_CATHEDRAL_VALLEY": { name: "Cathedral Valley", lat: 38.4167, lon: -111.1000, type: "natural", region: "southwest", alt: 6000, desc: "Monoliths" },
      "SW_TEMPLE_SUN_MOON": { name: "Temple of the Sun and Moon", lat: 38.4000, lon: -111.1167, type: "natural", region: "southwest", alt: 6200, desc: "Capitol Reef monoliths" },
      "SW_ANGELS_LANDING": { name: "Angels Landing", lat: 37.2694, lon: -112.9481, type: "natural", region: "southwest", alt: 5785, desc: "Zion iconic hike" },
      "SW_THE_NARROWS": { name: "The Narrows", lat: 37.2917, lon: -112.9500, type: "natural", region: "southwest", alt: 4500, desc: "Zion slot canyon" },
      "SW_WEEPING_ROCK": { name: "Weeping Rock", lat: 37.2722, lon: -112.9403, type: "natural", region: "southwest", alt: 4400, desc: "Zion alcove" },
      "SW_EMERALD_POOLS": { name: "Emerald Pools", lat: 37.2597, lon: -112.9528, type: "natural", region: "southwest", alt: 4400, desc: "Zion waterfalls" },
      "SW_KOLOB_ARCH": { name: "Kolob Arch", lat: 37.4208, lon: -113.1778, type: "natural", region: "southwest", alt: 7000, desc: "Second largest arch" },
      "SW_KOLOB_CANYONS": { name: "Kolob Canyons", lat: 37.4333, lon: -113.1833, type: "natural", region: "southwest", alt: 6500, desc: "Zion finger canyons" },
      "SW_OBSERVATION_POINT": { name: "Observation Point", lat: 37.2833, lon: -112.9333, type: "natural", region: "southwest", alt: 6508, desc: "Zion viewpoint" },
      "SW_CHECKERBOARD_MESA": { name: "Checkerboard Mesa", lat: 37.2500, lon: -112.8833, type: "natural", region: "southwest", alt: 5800, desc: "Zion formation" },
      "SW_CANYON_OVERLOOK": { name: "Canyon Overlook", lat: 37.2417, lon: -112.9333, type: "natural", region: "southwest", alt: 5200, desc: "Zion viewpoint" },
      "SW_BRYCE_AMPHITHEATER": { name: "Bryce Amphitheater", lat: 37.5930, lon: -112.1871, type: "natural", region: "southwest", alt: 8000, desc: "Hoodoo forest" },
      "SW_SUNSET_POINT_BRYCE": { name: "Sunset Point", lat: 37.5917, lon: -112.1833, type: "natural", region: "southwest", alt: 8000, desc: "Bryce viewpoint" },
      "SW_SUNRISE_POINT_BRYCE": { name: "Sunrise Point", lat: 37.5983, lon: -112.1683, type: "natural", region: "southwest", alt: 8000, desc: "Bryce viewpoint" },
      "SW_INSPIRATION_POINT_BRYCE": { name: "Inspiration Point Bryce", lat: 37.5833, lon: -112.1917, type: "natural", region: "southwest", alt: 8100, desc: "Bryce viewpoint" },
      "SW_RAINBOW_POINT": { name: "Rainbow Point", lat: 37.4750, lon: -112.2417, type: "natural", region: "southwest", alt: 9115, desc: "Bryce highest point" },
      "SW_THORS_HAMMER": { name: "Thor's Hammer", lat: 37.5917, lon: -112.1833, type: "natural", region: "southwest", alt: 7900, desc: "Bryce hoodoo" },
      "SW_WALL_STREET_BRYCE": { name: "Wall Street", lat: 37.5917, lon: -112.1750, type: "natural", region: "southwest", alt: 7600, desc: "Bryce narrow canyon" },
      "SW_QUEENS_GARDEN": { name: "Queen's Garden", lat: 37.5917, lon: -112.1667, type: "natural", region: "southwest", alt: 7600, desc: "Bryce trail" },
      "SW_NAVAJO_LOOP": { name: "Navajo Loop", lat: 37.5917, lon: -112.1750, type: "natural", region: "southwest", alt: 7600, desc: "Bryce trail" },
      "SW_GRAND_STAIRCASE": { name: "Grand Staircase-Escalante", lat: 37.3333, lon: -111.5000, type: "natural", region: "southwest", alt: 5500, desc: "Vast wilderness" },
      "SW_CALF_CREEK_FALLS": { name: "Calf Creek Falls", lat: 37.8131, lon: -111.4139, type: "waterfall", region: "southwest", alt: 5300, desc: "126-foot falls" },
      "SW_DEVILS_GARDEN_UT": { name: "Devils Garden UT", lat: 37.8000, lon: -111.3833, type: "natural", region: "southwest", alt: 5300, desc: "Hole-in-the-Rock Road" },
      "SW_ZEBRA_SLOT": { name: "Zebra Slot Canyon", lat: 37.7333, lon: -111.4167, type: "natural", region: "southwest", alt: 5000, desc: "Striped slot canyon" },
      "SW_PEEK_A_BOO_SLOT": { name: "Peek-a-boo Slot Canyon", lat: 37.7500, lon: -111.4167, type: "natural", region: "southwest", alt: 5000, desc: "Escalante slot" },
      "SW_SPOOKY_SLOT": { name: "Spooky Slot Canyon", lat: 37.7500, lon: -111.4333, type: "natural", region: "southwest", alt: 5000, desc: "Narrow slot" },
      "SW_ESCALANTE_PETRIFIED": { name: "Escalante Petrified Forest", lat: 37.6500, lon: -111.4000, type: "natural", region: "southwest", alt: 5800, desc: "Petrified wood" },
      "SW_KODACHROME_BASIN": { name: "Kodachrome Basin", lat: 37.5000, lon: -111.9833, type: "natural", region: "southwest", alt: 5800, desc: "Sediment pipes" },
      "SW_RED_CANYON_UT": { name: "Red Canyon UT", lat: 37.7500, lon: -112.2833, type: "natural", region: "southwest", alt: 7500, desc: "Highway 12" },
      "SW_ISLAND_IN_SKY": { name: "Island in the Sky", lat: 38.4594, lon: -109.8214, type: "natural", region: "southwest", alt: 6000, desc: "Canyonlands district" },
      "SW_MESA_ARCH": { name: "Mesa Arch", lat: 38.3897, lon: -109.8678, type: "natural", region: "southwest", alt: 6000, desc: "Canyonlands sunrise spot" },
      "SW_GRAND_VIEW_POINT": { name: "Grand View Point", lat: 38.3100, lon: -109.8567, type: "natural", region: "southwest", alt: 6000, desc: "Canyonlands overlook" },
      "SW_GREEN_RIVER_OVERLOOK": { name: "Green River Overlook", lat: 38.3833, lon: -109.9333, type: "natural", region: "southwest", alt: 6200, desc: "Canyonlands view" },
      "SW_UPHEAVAL_DOME": { name: "Upheaval Dome", lat: 38.4333, lon: -109.9167, type: "natural", region: "southwest", alt: 5700, desc: "Impact crater" },
      "SW_NEEDLES_DISTRICT": { name: "Needles District", lat: 38.1333, lon: -109.7833, type: "natural", region: "southwest", alt: 5200, desc: "Canyonlands spires" },
      "SW_DRUID_ARCH": { name: "Druid Arch", lat: 38.0833, lon: -109.7167, type: "natural", region: "southwest", alt: 5800, desc: "Canyonlands arch" },
      "SW_CHESLER_PARK": { name: "Chesler Park", lat: 38.1167, lon: -109.7667, type: "natural", region: "southwest", alt: 5400, desc: "Canyonlands meadow" },
      "SW_THE_MAZE": { name: "The Maze", lat: 38.2000, lon: -110.1667, type: "natural", region: "southwest", alt: 5000, desc: "Remote Canyonlands" },
      "SW_DEAD_HORSE_POINT": { name: "Dead Horse Point", lat: 38.4833, lon: -109.7333, type: "natural", region: "southwest", alt: 6000, desc: "Colorado River overlook" },
      "SW_CORONA_ARCH": { name: "Corona Arch", lat: 38.5833, lon: -109.6167, type: "natural", region: "southwest", alt: 4600, desc: "Near Moab" },
      "SW_FISHER_TOWERS": { name: "Fisher Towers", lat: 38.7244, lon: -109.3075, type: "natural", region: "southwest", alt: 5000, desc: "Moab spires" },
      "SW_CASTLE_VALLEY": { name: "Castle Valley", lat: 38.6500, lon: -109.4000, type: "natural", region: "southwest", alt: 5000, desc: "Moab buttes" },
      "SW_DELICATE_ARCH": { name: "Delicate Arch", lat: 38.7436, lon: -109.4992, type: "natural", region: "southwest", alt: 4829, desc: "Utah icon" },
      "SW_LANDSCAPE_ARCH": { name: "Landscape Arch", lat: 38.7903, lon: -109.6069, type: "natural", region: "southwest", alt: 5200, desc: "Longest arch" },
      "SW_DOUBLE_ARCH": { name: "Double Arch", lat: 38.6886, lon: -109.5369, type: "natural", region: "southwest", alt: 4700, desc: "Twin arches" },
      "SW_WINDOWS_ARCHES": { name: "The Windows", lat: 38.6875, lon: -109.5375, type: "natural", region: "southwest", alt: 4800, desc: "North and South Window" },
      "SW_TURRET_ARCH": { name: "Turret Arch", lat: 38.6858, lon: -109.5364, type: "natural", region: "southwest", alt: 4800, desc: "Arches NP" },
      "SW_PARK_AVENUE": { name: "Park Avenue", lat: 38.6206, lon: -109.5933, type: "natural", region: "southwest", alt: 4400, desc: "Arches NP canyon" },
      "SW_BALANCED_ROCK": { name: "Balanced Rock", lat: 38.7014, lon: -109.5644, type: "natural", region: "southwest", alt: 5100, desc: "Arches NP icon" },
      "SW_FIERY_FURNACE": { name: "Fiery Furnace", lat: 38.7500, lon: -109.5667, type: "natural", region: "southwest", alt: 5000, desc: "Arches labyrinth" },
      "SW_DEVILS_GARDEN_ARCHES": { name: "Devils Garden Arches", lat: 38.7833, lon: -109.5833, type: "natural", region: "southwest", alt: 5200, desc: "8+ arches area" },
      "SW_PRIVATE_ARCH": { name: "Private Arch", lat: 38.8000, lon: -109.6000, type: "natural", region: "southwest", alt: 5300, desc: "Remote Arches arch" },
      "SW_NAVAJO_ARCH": { name: "Navajo Arch", lat: 38.7917, lon: -109.5917, type: "natural", region: "southwest", alt: 5200, desc: "Devils Garden" },
      "SW_PARTITION_ARCH": { name: "Partition Arch", lat: 38.7889, lon: -109.5917, type: "natural", region: "southwest", alt: 5200, desc: "Devils Garden" },
      "SW_DOUBLE_O_ARCH": { name: "Double O Arch", lat: 38.8000, lon: -109.6083, type: "natural", region: "southwest", alt: 5300, desc: "Devils Garden" },
      "SW_DARK_ANGEL": { name: "Dark Angel", lat: 38.8083, lon: -109.6083, type: "natural", region: "southwest", alt: 5400, desc: "Devils Garden spire" },
      "SW_WALL_ARCH_SITE": { name: "Wall Arch Site", lat: 38.7889, lon: -109.5889, type: "natural", region: "southwest", alt: 5200, desc: "Collapsed 2008" },
      "SW_TOWER_ARCH": { name: "Tower Arch", lat: 38.7917, lon: -109.6833, type: "natural", region: "southwest", alt: 5500, desc: "Remote Arches arch" },
      "SW_MARCHING_MEN": { name: "Marching Men", lat: 38.7833, lon: -109.6750, type: "natural", region: "southwest", alt: 5500, desc: "Klondike Bluffs" },
      "SW_SAND_DUNE_ARCH": { name: "Sand Dune Arch", lat: 38.7667, lon: -109.5667, type: "natural", region: "southwest", alt: 5000, desc: "Hidden arch" },
      "SW_BROKEN_ARCH": { name: "Broken Arch", lat: 38.7750, lon: -109.5583, type: "natural", region: "southwest", alt: 5100, desc: "Devils Garden area" },
      "SW_SKYLINE_ARCH": { name: "Skyline Arch", lat: 38.7708, lon: -109.5717, type: "natural", region: "southwest", alt: 5200, desc: "Devils Garden area" },
      "SW_TAPESTRY_ARCH": { name: "Tapestry Arch", lat: 38.7667, lon: -109.5667, type: "natural", region: "southwest", alt: 5100, desc: "Near Sand Dune" },
      "SW_PINE_TREE_ARCH": { name: "Pine Tree Arch", lat: 38.7333, lon: -109.5833, type: "natural", region: "southwest", alt: 4900, desc: "Devils Garden" },
      "SW_TUNNEL_ARCH": { name: "Tunnel Arch", lat: 38.7333, lon: -109.5917, type: "natural", region: "southwest", alt: 4900, desc: "Devils Garden" },
      "SW_COURTHOUSE_TOWERS": { name: "Courthouse Towers", lat: 38.6417, lon: -109.5750, type: "natural", region: "southwest", alt: 4500, desc: "Arches NP towers" },
      "SW_THREE_GOSSIPS": { name: "Three Gossips", lat: 38.6389, lon: -109.5861, type: "natural", region: "southwest", alt: 4500, desc: "Courthouse Towers" },
      "SW_SHEEP_ROCK": { name: "Sheep Rock", lat: 38.6361, lon: -109.5833, type: "natural", region: "southwest", alt: 4500, desc: "Courthouse Towers" },
      "SW_ORGAN": { name: "The Organ", lat: 38.6333, lon: -109.5806, type: "natural", region: "southwest", alt: 4600, desc: "Courthouse Towers" },
      "SW_TOWER_OF_BABEL": { name: "Tower of Babel", lat: 38.6278, lon: -109.5778, type: "natural", region: "southwest", alt: 4700, desc: "Courthouse Towers" },
      "SW_PETRIFIED_DUNES": { name: "Petrified Dunes", lat: 38.6667, lon: -109.5500, type: "natural", region: "southwest", alt: 4600, desc: "Arches viewpoint" },
      "SW_WOLFE_RANCH": { name: "Wolfe Ranch", lat: 38.7333, lon: -109.5083, type: "landmark", region: "southwest", alt: 4400, desc: "Historic cabin" },
      "SW_UTE_PETROGLYPHS": { name: "Ute Petroglyphs", lat: 38.7361, lon: -109.5056, type: "landmark", region: "southwest", alt: 4400, desc: "Rock art panel" },
      "SW_NEGRO_BILL_CANYON": { name: "Negro Bill Canyon", lat: 38.6167, lon: -109.5333, type: "natural", region: "southwest", alt: 4200, desc: "Morning Glory Bridge" },
      "SW_MORNING_GLORY": { name: "Morning Glory Natural Bridge", lat: 38.6000, lon: -109.4833, type: "natural", region: "southwest", alt: 4600, desc: "Sixth largest span" },
      "SW_MILL_CREEK": { name: "Mill Creek Canyon", lat: 38.5667, lon: -109.5333, type: "natural", region: "southwest", alt: 4800, desc: "Moab swimming hole" },
      "SW_HUNTER_CANYON": { name: "Hunter Canyon", lat: 38.5333, lon: -109.5167, type: "natural", region: "southwest", alt: 4200, desc: "Colorado River" },
      "SW_POTASH_ROAD": { name: "Potash Road Petroglyphs", lat: 38.5333, lon: -109.6333, type: "landmark", region: "southwest", alt: 4000, desc: "Dinosaur tracks" },
      "SW_JAILHOUSE_ARCH": { name: "Jailhouse Arch", lat: 38.5167, lon: -109.6500, type: "natural", region: "southwest", alt: 4000, desc: "Potash Road" },
      "SW_LONGBOW_ARCH": { name: "Longbow Arch", lat: 38.7333, lon: -109.4667, type: "natural", region: "southwest", alt: 4800, desc: "Near Moab" },
      "SW_WILSON_ARCH": { name: "Wilson Arch", lat: 38.2667, lon: -109.3833, type: "natural", region: "southwest", alt: 5700, desc: "Highway 191" },
      "SW_LOOKING_GLASS_ROCK_UT": { name: "Looking Glass Rock UT", lat: 38.2500, lon: -109.3667, type: "natural", region: "southwest", alt: 5600, desc: "Near Wilson Arch" },
      "SW_NEWSPAPER_ROCK_UT": { name: "Newspaper Rock UT", lat: 38.0333, lon: -109.5333, type: "landmark", region: "southwest", alt: 5200, desc: "Petroglyphs" },
      "SW_NEEDLES_OVERLOOK": { name: "Needles Overlook", lat: 38.1833, lon: -109.7167, type: "natural", region: "southwest", alt: 6000, desc: "Anticline Overlook Road" },
      "SW_ANTICLINE_OVERLOOK": { name: "Anticline Overlook", lat: 38.4333, lon: -109.6833, type: "natural", region: "southwest", alt: 5700, desc: "Kane Creek view" },
      "SE_SAVANNAH_SQUARES": { name: "Savannah Historic District", lat: 32.0809, lon: -81.0912, type: "landmark", region: "southeast", alt: 50, desc: "Historic squares" },
      "SE_FORSYTH_PARK": { name: "Forsyth Park", lat: 32.0678, lon: -81.0956, type: "landmark", region: "southeast", alt: 50, desc: "Savannah fountain" },
      "SE_BONAVENTURE": { name: "Bonaventure Cemetery", lat: 32.0500, lon: -81.0500, type: "landmark", region: "southeast", alt: 20, desc: "Historic cemetery" },
      "SE_CHARLESTON_BATTERY": { name: "The Battery Charleston", lat: 32.7694, lon: -79.9311, type: "landmark", region: "southeast", alt: 10, desc: "Charleston seawall" },
      "SE_RAINBOW_ROW": { name: "Rainbow Row", lat: 32.7750, lon: -79.9292, type: "landmark", region: "southeast", alt: 10, desc: "Colorful houses" },
      "SE_FOLLY_BEACH": { name: "Folly Beach", lat: 32.6553, lon: -79.9403, type: "natural", region: "southeast", alt: 10, desc: "Charleston beach" },
      "SE_KIAWAH_ISLAND": { name: "Kiawah Island", lat: 32.6083, lon: -80.0833, type: "natural", region: "southeast", alt: 10, desc: "Resort island" },
      "SE_HILTON_HEAD": { name: "Hilton Head Island", lat: 32.2163, lon: -80.7526, type: "natural", region: "southeast", alt: 10, desc: "Golf resort" },
      "SE_JEKYLL_ISLAND": { name: "Jekyll Island", lat: 31.0722, lon: -81.4183, type: "natural", region: "southeast", alt: 10, desc: "Georgia coast" },
      "SE_ST_SIMONS": { name: "St. Simons Island", lat: 31.1500, lon: -81.3833, type: "natural", region: "southeast", alt: 10, desc: "Golden Isles" },
      "SE_CUMBERLAND_ISLAND": { name: "Cumberland Island", lat: 30.8500, lon: -81.4500, type: "natural", region: "southeast", alt: 20, desc: "Wild horses" },
      "SE_AMELIA_ISLAND": { name: "Amelia Island", lat: 30.6167, lon: -81.4500, type: "natural", region: "southeast", alt: 10, desc: "Florida barrier" },
      "SE_FERNANDINA_BEACH": { name: "Fernandina Beach", lat: 30.6694, lon: -81.4625, type: "landmark", region: "southeast", alt: 10, desc: "Historic downtown" },
      "SE_ST_AUGUSTINE_FORT": { name: "Castillo de San Marcos", lat: 29.8978, lon: -81.3114, type: "landmark", region: "southeast", alt: 20, desc: "Spanish fort" },
      "SE_FLAGLER_COLLEGE": { name: "Flagler College", lat: 29.8911, lon: -81.3122, type: "landmark", region: "southeast", alt: 20, desc: "Spanish Renaissance" },
      "SE_DAYTONA_BEACH": { name: "Daytona Beach", lat: 29.2108, lon: -81.0228, type: "natural", region: "southeast", alt: 10, desc: "Beach driving" },
      "SE_COCOA_BEACH": { name: "Cocoa Beach", lat: 28.3200, lon: -80.6076, type: "natural", region: "southeast", alt: 10, desc: "Surfing capital" },
      "SE_CLEARWATER_BEACH": { name: "Clearwater Beach", lat: 27.9778, lon: -82.8269, type: "natural", region: "southeast", alt: 10, desc: "Gulf Coast" },
      "SE_SIESTA_KEY": { name: "Siesta Key Beach", lat: 27.2667, lon: -82.5500, type: "natural", region: "southeast", alt: 10, desc: "Quartz sand" },
      "SE_SANIBEL_ISLAND": { name: "Sanibel Island", lat: 26.4500, lon: -82.0833, type: "natural", region: "southeast", alt: 10, desc: "Shelling" },
      "SE_CAPTIVA_ISLAND": { name: "Captiva Island", lat: 26.5333, lon: -82.1833, type: "natural", region: "southeast", alt: 10, desc: "Gulf barrier" },
      "SE_NAPLES_PIER": { name: "Naples Pier", lat: 26.1411, lon: -81.8067, type: "landmark", region: "southeast", alt: 10, desc: "Gulf pier" },
      "SE_MARCO_ISLAND": { name: "Marco Island", lat: 25.9417, lon: -81.7250, type: "natural", region: "southeast", alt: 10, desc: "Ten Thousand Islands" },
      "SE_FLORIDA_KEYS_BRIDGE": { name: "Overseas Highway", lat: 24.6667, lon: -81.1500, type: "landmark", region: "southeast", alt: 20, desc: "Keys bridges" },
      "SE_BAHIA_HONDA": { name: "Bahia Honda State Park", lat: 24.6556, lon: -81.2667, type: "natural", region: "southeast", alt: 10, desc: "Keys beach" },
      "SE_KEY_LARGO": { name: "Key Largo", lat: 25.0864, lon: -80.4472, type: "natural", region: "southeast", alt: 10, desc: "Diving capital" },
      "SE_ISLAMORADA": { name: "Islamorada", lat: 24.9242, lon: -80.6278, type: "natural", region: "southeast", alt: 10, desc: "Sport fishing" },
      "SE_MARATHON_KEY": { name: "Marathon Key", lat: 24.7136, lon: -81.0903, type: "natural", region: "southeast", alt: 10, desc: "Middle Keys" },
      "SE_BIG_PINE_KEY": { name: "Big Pine Key", lat: 24.6694, lon: -81.3528, type: "natural", region: "southeast", alt: 10, desc: "Key deer" },
      "SE_MALLORY_SQUARE": { name: "Mallory Square", lat: 24.5600, lon: -81.8078, type: "landmark", region: "southeast", alt: 10, desc: "Key West sunsets" },
      "SE_HEMINGWAY_HOME": { name: "Hemingway Home", lat: 24.5514, lon: -81.8008, type: "landmark", region: "southeast", alt: 10, desc: "Key West museum" },
      "SE_FORT_JEFFERSON_DT": { name: "Fort Jefferson", lat: 24.6285, lon: -82.8732, type: "landmark", region: "southeast", alt: 10, desc: "Dry Tortugas" },
      "SE_OKEFENOKEE_SWAMP": { name: "Okefenokee Swamp Park", lat: 30.7500, lon: -82.3333, type: "natural", region: "southeast", alt: 120, desc: "Swamp boardwalks" },
      "SE_PROVIDENCE_CANYON": { name: "Providence Canyon", lat: 32.0667, lon: -84.9167, type: "natural", region: "southeast", alt: 700, desc: "Little Grand Canyon" },
      "SE_CLOUDLAND_CANYON": { name: "Cloudland Canyon", lat: 34.8333, lon: -85.4833, type: "natural", region: "southeast", alt: 1900, desc: "Georgia gorge" },
      "SE_TALLULAH_GORGE_VIEW": { name: "Tallulah Gorge Overlook", lat: 34.7381, lon: -83.3908, type: "natural", region: "southeast", alt: 1800, desc: "1000-foot gorge" },
      "SE_BRASSTOWN_BALD": { name: "Brasstown Bald", lat: 34.8742, lon: -83.8117, type: "mountain", region: "southeast", alt: 4784, desc: "Georgia highpoint" },
      "SE_BLOOD_MOUNTAIN": { name: "Blood Mountain", lat: 34.7408, lon: -83.9361, type: "mountain", region: "southeast", alt: 4458, desc: "AT peak" },
      "SE_SPRINGER_MOUNTAIN": { name: "Springer Mountain", lat: 34.6267, lon: -84.1939, type: "mountain", region: "southeast", alt: 3782, desc: "AT southern terminus" },
      "SE_CHIMNEY_ROCK_NC": { name: "Chimney Rock NC", lat: 35.4386, lon: -82.2464, type: "natural", region: "southeast", alt: 2280, desc: "Rock spire" },
      "SE_LINVILLE_FALLS": { name: "Linville Falls", lat: 35.9528, lon: -81.9283, type: "waterfall", region: "southeast", alt: 3200, desc: "Blue Ridge falls" },
      "SE_LINVILLE_GORGE": { name: "Linville Gorge", lat: 35.9167, lon: -81.9167, type: "natural", region: "southeast", alt: 3500, desc: "Grand Canyon of East" },
      "SE_WISEMANS_VIEW": { name: "Wiseman's View", lat: 35.8833, lon: -81.9000, type: "natural", region: "southeast", alt: 3400, desc: "Linville overlook" },
      "SE_TABLE_ROCK_NC": { name: "Table Rock NC", lat: 35.8833, lon: -81.8833, type: "mountain", region: "southeast", alt: 4100, desc: "Linville Gorge" },
      "SE_HAWKSBILL_MOUNTAIN": { name: "Hawksbill Mountain NC", lat: 35.9000, lon: -81.8833, type: "mountain", region: "southeast", alt: 4049, desc: "Linville Gorge" },
      "SE_BLOWING_ROCK": { name: "Blowing Rock", lat: 36.1350, lon: -81.6786, type: "natural", region: "southeast", alt: 4000, desc: "Johns River Gorge" },
      "SE_GRANDFATHER_VIEW": { name: "Grandfather Mountain View", lat: 36.1092, lon: -81.8328, type: "natural", region: "southeast", alt: 5280, desc: "Mile High Bridge" },
      "SE_MILE_HIGH_BRIDGE": { name: "Mile High Swinging Bridge", lat: 36.1092, lon: -81.8328, type: "landmark", region: "southeast", alt: 5280, desc: "Suspension bridge" },
      "SE_ROUGH_RIDGE": { name: "Rough Ridge", lat: 36.0833, lon: -81.8500, type: "natural", region: "southeast", alt: 4800, desc: "Blue Ridge Parkway" },
      "SE_LINN_COVE_VIADUCT": { name: "Linn Cove Viaduct", lat: 36.0833, lon: -81.8333, type: "landmark", region: "southeast", alt: 4100, desc: "Engineering marvel" },
      "SE_CRAGGY_GARDENS": { name: "Craggy Gardens", lat: 35.7000, lon: -82.3833, type: "natural", region: "southeast", alt: 5500, desc: "Rhododendron balds" },
      "SE_MOUNT_PISGAH": { name: "Mount Pisgah", lat: 35.4272, lon: -82.7567, type: "mountain", region: "southeast", alt: 5721, desc: "Blue Ridge Parkway" },
      "SE_GRAVEYARD_FIELDS": { name: "Graveyard Fields", lat: 35.3167, lon: -82.8500, type: "natural", region: "southeast", alt: 5100, desc: "Waterfalls area" },
      "SE_DEVIL_COURTHOUSE": { name: "Devil's Courthouse", lat: 35.2833, lon: -82.9000, type: "mountain", region: "southeast", alt: 5720, desc: "Bald summit" },
      "SE_RICHLAND_BALSAM": { name: "Richland Balsam", lat: 35.3583, lon: -82.9833, type: "mountain", region: "southeast", alt: 6053, desc: "BRP highest point" },
      "SE_WATERROCK_KNOB": { name: "Waterrock Knob", lat: 35.4617, lon: -83.2056, type: "mountain", region: "southeast", alt: 6292, desc: "360 degree view" },
      "SE_CHEROKEE_NC": { name: "Cherokee NC", lat: 35.4742, lon: -83.3150, type: "landmark", region: "southeast", alt: 2000, desc: "Eastern Cherokee" },
      "SE_OCONALUFTEE": { name: "Oconaluftee Visitor Center", lat: 35.5142, lon: -83.3047, type: "landmark", region: "southeast", alt: 2000, desc: "Smokies entrance" },
      "SE_NEWFOUND_GAP": { name: "Newfound Gap", lat: 35.6111, lon: -83.4253, type: "natural", region: "southeast", alt: 5048, desc: "Smokies pass" },
      "SE_CHARLES_BUNION": { name: "Charlie's Bunion", lat: 35.6333, lon: -83.3833, type: "natural", region: "southeast", alt: 5400, desc: "AT viewpoint" },
      "SE_ALUM_CAVE": { name: "Alum Cave Bluffs", lat: 35.6333, lon: -83.4500, type: "natural", region: "southeast", alt: 5000, desc: "Mount LeConte trail" },
      "SE_MOUNT_LECONTE": { name: "Mount LeConte", lat: 35.6536, lon: -83.4367, type: "mountain", region: "southeast", alt: 6593, desc: "Smokies peak" },
      "SE_CHIMNEY_TOPS": { name: "Chimney Tops", lat: 35.6333, lon: -83.4667, type: "mountain", region: "southeast", alt: 4724, desc: "Twin peaks" },
      "SE_LAUREL_FALLS": { name: "Laurel Falls", lat: 35.6750, lon: -83.5833, type: "waterfall", region: "southeast", alt: 2800, desc: "Popular Smokies" },
      "SE_CADES_COVE": { name: "Cades Cove", lat: 35.5833, lon: -83.8333, type: "natural", region: "southeast", alt: 1800, desc: "Historic valley" },
      "SE_GREGORY_BALD": { name: "Gregory Bald", lat: 35.5333, lon: -83.8667, type: "mountain", region: "southeast", alt: 4949, desc: "Flame azaleas" },
      "SE_ABRAMS_FALLS": { name: "Abrams Falls", lat: 35.6083, lon: -83.8583, type: "waterfall", region: "southeast", alt: 1700, desc: "Cades Cove" },
      "SE_ROARING_FORK": { name: "Roaring Fork Motor Trail", lat: 35.7000, lon: -83.4667, type: "natural", region: "southeast", alt: 2500, desc: "Scenic drive" },
      "SE_RAINBOW_FALLS_TN": { name: "Rainbow Falls TN", lat: 35.6583, lon: -83.4583, type: "waterfall", region: "southeast", alt: 4000, desc: "LeConte Creek" },
      "SE_GROTTO_FALLS": { name: "Grotto Falls", lat: 35.6667, lon: -83.4167, type: "waterfall", region: "southeast", alt: 3600, desc: "Walk behind falls" },
      "SE_RAMSEY_CASCADES": { name: "Ramsey Cascades", lat: 35.7167, lon: -83.3000, type: "waterfall", region: "southeast", alt: 4500, desc: "Tallest in Smokies" },
      "SE_HEN_WALLOW_FALLS": { name: "Hen Wallow Falls", lat: 35.7333, lon: -83.2333, type: "waterfall", region: "southeast", alt: 2500, desc: "Cosby area" },
      "NE_ADIRONDACK_HIGH": { name: "Adirondack High Peaks", lat: 44.1128, lon: -73.9236, type: "mountain", region: "northeast", alt: 5344, desc: "46ers region" },
      "NE_WHITEFACE": { name: "Whiteface Mountain", lat: 44.3656, lon: -73.9028, type: "mountain", region: "northeast", alt: 4867, desc: "Olympic ski" },
      "NE_ALGONQUIN_PEAK": { name: "Algonquin Peak", lat: 44.1436, lon: -73.9869, type: "mountain", region: "northeast", alt: 5114, desc: "Second highest ADK" },
      "NE_GIANT_MOUNTAIN": { name: "Giant Mountain", lat: 44.1617, lon: -73.7203, type: "mountain", region: "northeast", alt: 4627, desc: "Adirondacks" },
      "NE_CASCADE_MOUNTAIN": { name: "Cascade Mountain", lat: 44.2189, lon: -73.8603, type: "mountain", region: "northeast", alt: 4098, desc: "Popular 46er" },
      "NE_HEART_LAKE": { name: "Heart Lake", lat: 44.1833, lon: -73.9667, type: "lake", region: "northeast", alt: 2200, desc: "ADK Loj" },
      "NE_MIRROR_LAKE": { name: "Mirror Lake", lat: 44.2875, lon: -73.9833, type: "lake", region: "northeast", alt: 1900, desc: "Lake Placid village" },
      "NE_SARANAC_LAKE": { name: "Saranac Lake", lat: 44.3333, lon: -74.1333, type: "lake", region: "northeast", alt: 1600, desc: "Adirondack lake" },
      "NE_BLUE_MOUNTAIN_LAKE": { name: "Blue Mountain Lake", lat: 43.8667, lon: -74.4333, type: "lake", region: "northeast", alt: 1800, desc: "Central Adirondacks" },
      "NE_OLD_FORGE": { name: "Old Forge", lat: 43.7103, lon: -74.9733, type: "landmark", region: "northeast", alt: 1800, desc: "Adirondack gateway" },
      "NE_AUSABLE_RIVER": { name: "Ausable River", lat: 44.4167, lon: -73.4667, type: "natural", region: "northeast", alt: 400, desc: "Fly fishing" },
      "NE_HIGH_FALLS_GORGE": { name: "High Falls Gorge", lat: 44.3333, lon: -73.8500, type: "waterfall", region: "northeast", alt: 2000, desc: "Whiteface area" },
      "NE_TICONDEROGA": { name: "Fort Ticonderoga", lat: 43.8464, lon: -73.3892, type: "landmark", region: "northeast", alt: 300, desc: "Revolutionary War" },
      "NE_CROWN_POINT": { name: "Crown Point", lat: 43.9417, lon: -73.4333, type: "landmark", region: "northeast", alt: 200, desc: "Lake Champlain" },
      "NE_BOLDT_CASTLE": { name: "Boldt Castle", lat: 44.3417, lon: -75.9250, type: "landmark", region: "northeast", alt: 300, desc: "Heart Island" },
      "NE_SINGER_CASTLE": { name: "Singer Castle", lat: 44.3083, lon: -75.9583, type: "landmark", region: "northeast", alt: 300, desc: "Dark Island" },
      "NE_CATSKILL_MTNS": { name: "Catskill Mountains", lat: 42.1833, lon: -74.3667, type: "mountain", region: "northeast", alt: 4180, desc: "Slide Mountain" },
      "NE_SLIDE_MOUNTAIN": { name: "Slide Mountain", lat: 41.9989, lon: -74.3856, type: "mountain", region: "northeast", alt: 4180, desc: "Catskills highpoint" },
      "NE_KAATERSKILL_FALLS": { name: "Kaaterskill Falls", lat: 42.1903, lon: -74.0531, type: "waterfall", region: "northeast", alt: 2500, desc: "260-foot falls" },
      "NE_HUNTER_MOUNTAIN": { name: "Hunter Mountain", lat: 42.2000, lon: -74.2167, type: "mountain", region: "northeast", alt: 4025, desc: "Catskills ski" },
      "NE_HARRIMAN_STATE": { name: "Harriman State Park", lat: 41.2500, lon: -74.1000, type: "natural", region: "northeast", alt: 1400, desc: "NYC hiking" },
      "NE_BEAR_MOUNTAIN": { name: "Bear Mountain", lat: 41.3125, lon: -73.9886, type: "mountain", region: "northeast", alt: 1305, desc: "Hudson Valley" },
      "NE_STORM_KING": { name: "Storm King Mountain", lat: 41.4333, lon: -73.9833, type: "mountain", region: "northeast", alt: 1355, desc: "Hudson Highlands" },
      "NE_BREAKNECK_RIDGE": { name: "Breakneck Ridge", lat: 41.4500, lon: -73.9667, type: "mountain", region: "northeast", alt: 1250, desc: "Challenging hike" },
      "NE_WEST_POINT_VIEW": { name: "West Point View", lat: 41.3915, lon: -73.9564, type: "natural", region: "northeast", alt: 300, desc: "Hudson panorama" },
      "NE_MOHONK": { name: "Mohonk Preserve", lat: 41.7667, lon: -74.1500, type: "natural", region: "northeast", alt: 2200, desc: "Shawangunk Ridge" },
      "NE_MINNEWASKA": { name: "Minnewaska State Park", lat: 41.7333, lon: -74.2167, type: "natural", region: "northeast", alt: 2000, desc: "Gunks" },
      "NE_SAM_POINT": { name: "Sam's Point", lat: 41.6667, lon: -74.3500, type: "natural", region: "northeast", alt: 2200, desc: "Ice caves" },
      "NE_VERKEERDERKILL_FALLS": { name: "Verkeerderkill Falls", lat: 41.6833, lon: -74.3333, type: "waterfall", region: "northeast", alt: 2100, desc: "180-foot falls" },
      "NE_BUTTERMILK_FALLS_NY": { name: "Buttermilk Falls NY", lat: 42.4167, lon: -76.5167, type: "waterfall", region: "northeast", alt: 500, desc: "Ithaca gorge" },
      "NE_TAUGHANNOCK_FALLS": { name: "Taughannock Falls", lat: 42.5458, lon: -76.6017, type: "waterfall", region: "northeast", alt: 700, desc: "215-foot falls" },
      "NE_ITHACA_FALLS": { name: "Ithaca Falls", lat: 42.4539, lon: -76.4939, type: "waterfall", region: "northeast", alt: 600, desc: "Downtown Ithaca" },
      "NE_ROBERT_TREMAN": { name: "Robert H. Treman State Park", lat: 42.4000, lon: -76.5500, type: "waterfall", region: "northeast", alt: 600, desc: "Lucifer Falls" },
      "NE_CORNELL_CAMPUS": { name: "Cornell University", lat: 42.4534, lon: -76.4735, type: "landmark", region: "northeast", alt: 900, desc: "Gorges campus" },
      "NE_SENECA_FALLS": { name: "Seneca Falls", lat: 42.9097, lon: -76.7969, type: "landmark", region: "northeast", alt: 500, desc: "Women's rights" },
      "NE_SENECA_LAKE": { name: "Seneca Lake", lat: 42.6667, lon: -76.9167, type: "lake", region: "northeast", alt: 500, desc: "Deepest Finger Lake" },
      "NE_KEUKA_LAKE": { name: "Keuka Lake", lat: 42.5333, lon: -77.1167, type: "lake", region: "northeast", alt: 700, desc: "Y-shaped lake" },
      "NE_CANANDAIGUA_LAKE": { name: "Canandaigua Lake", lat: 42.7833, lon: -77.2833, type: "lake", region: "northeast", alt: 700, desc: "Finger Lakes" },
      "NE_SKANEATELES_LAKE": { name: "Skaneateles Lake", lat: 42.8667, lon: -76.3500, type: "lake", region: "northeast", alt: 900, desc: "Cleanest Finger Lake" },
      "NE_NIAGARA_GORGE": { name: "Niagara Gorge", lat: 43.1000, lon: -79.0667, type: "natural", region: "northeast", alt: 400, desc: "Whirlpool rapids" },
      "NE_WHIRLPOOL_STATE": { name: "Whirlpool State Park", lat: 43.1167, lon: -79.0667, type: "natural", region: "northeast", alt: 500, desc: "Giant whirlpool" },
      "NE_DEVILS_HOLE": { name: "Devil's Hole State Park", lat: 43.1333, lon: -79.0500, type: "natural", region: "northeast", alt: 400, desc: "Niagara Gorge" },
      "NE_THREE_SISTERS": { name: "Three Sisters Islands", lat: 43.0833, lon: -79.0667, type: "natural", region: "northeast", alt: 400, desc: "Niagara rapids" },
      "NE_GOAT_ISLAND": { name: "Goat Island", lat: 43.0833, lon: -79.0667, type: "natural", region: "northeast", alt: 400, desc: "Between falls" },
      "NE_PRESQUE_ISLE": { name: "Presque Isle State Park", lat: 42.1500, lon: -80.1167, type: "natural", region: "northeast", alt: 600, desc: "Erie PA peninsula" },
      "NE_KINZUA_BRIDGE": { name: "Kinzua Bridge", lat: 41.7583, lon: -78.5917, type: "landmark", region: "northeast", alt: 2000, desc: "Railroad remnant" },
      "NE_PINE_CREEK_GORGE": { name: "Pine Creek Gorge", lat: 41.6833, lon: -77.4500, type: "natural", region: "northeast", alt: 1500, desc: "PA Grand Canyon" },
      "NE_LEONARD_HARRISON": { name: "Leonard Harrison State Park", lat: 41.6833, lon: -77.4500, type: "natural", region: "northeast", alt: 1700, desc: "Canyon overlook" },
      "NE_COLTON_POINT": { name: "Colton Point State Park", lat: 41.6833, lon: -77.4667, type: "natural", region: "northeast", alt: 1700, desc: "Canyon west rim" },
      "NE_WORLDS_END": { name: "Worlds End State Park", lat: 41.4667, lon: -76.5833, type: "natural", region: "northeast", alt: 1500, desc: "Loyalsock Creek" },
      "NE_HYNER_VIEW": { name: "Hyner View State Park", lat: 41.3500, lon: -77.6333, type: "natural", region: "northeast", alt: 2100, desc: "Hang gliding launch" },
      "NE_POCONO_MTNS": { name: "Pocono Mountains", lat: 41.1000, lon: -75.3000, type: "mountain", region: "northeast", alt: 2500, desc: "Resort area" },
      "NE_DINGMANS_FALLS": { name: "Dingmans Falls", lat: 41.2333, lon: -74.8833, type: "waterfall", region: "northeast", alt: 700, desc: "130-foot falls" },
      "NE_RAYMOND_KILL": { name: "Raymondskill Falls", lat: 41.2833, lon: -74.8167, type: "waterfall", region: "northeast", alt: 800, desc: "Tallest in PA" },
      "NE_HAWK_MOUNTAIN": { name: "Hawk Mountain Sanctuary", lat: 40.6333, lon: -75.9833, type: "natural", region: "northeast", alt: 1500, desc: "Raptor migration" },
      "NE_GETTYSBURG_VIEW": { name: "Little Round Top", lat: 39.7917, lon: -77.2333, type: "landmark", region: "northeast", alt: 650, desc: "Battle site" },
      "NE_DEVILS_DEN_PA": { name: "Devil's Den Gettysburg", lat: 39.7833, lon: -77.2417, type: "landmark", region: "northeast", alt: 550, desc: "Boulder field" },
      "NE_EISENHOWER_TOWER": { name: "Observation Tower Gettysburg", lat: 39.8083, lon: -77.2500, type: "landmark", region: "northeast", alt: 800, desc: "Battlefield view" },
      "NE_HARPERS_FERRY": { name: "Harpers Ferry", lat: 39.3250, lon: -77.7292, type: "landmark", region: "northeast", alt: 400, desc: "Historic confluence" },
      "NE_MARYLAND_HEIGHTS": { name: "Maryland Heights", lat: 39.3250, lon: -77.7500, type: "natural", region: "northeast", alt: 1448, desc: "Harpers Ferry view" },
      "NE_GREAT_FALLS_MD": { name: "Great Falls MD", lat: 38.9917, lon: -77.2500, type: "waterfall", region: "northeast", alt: 200, desc: "Potomac rapids" },
      "NE_SUGARLOAF_MOUNTAIN": { name: "Sugarloaf Mountain", lat: 39.2528, lon: -77.3972, type: "mountain", region: "northeast", alt: 1282, desc: "Maryland monadnock" },
      "NE_CUNNINGHAM_FALLS": { name: "Cunningham Falls", lat: 39.6333, lon: -77.4667, type: "waterfall", region: "northeast", alt: 1000, desc: "Maryland's tallest" },
      "NE_ASSATEAGUE": { name: "Assateague Island", lat: 38.0833, lon: -75.2333, type: "natural", region: "northeast", alt: 10, desc: "Wild ponies" },
      "NE_CHINCOTEAGUE": { name: "Chincoteague Island", lat: 37.9333, lon: -75.3833, type: "natural", region: "northeast", alt: 10, desc: "Pony penning" },
      "NE_SKYLINE_DRIVE": { name: "Skyline Drive", lat: 38.6333, lon: -78.3500, type: "natural", region: "southeast", alt: 3500, desc: "Shenandoah NP" },
      "NE_MARYS_ROCK": { name: "Mary's Rock", lat: 38.7500, lon: -78.3000, type: "natural", region: "southeast", alt: 3514, desc: "Shenandoah view" },
      "NE_STONY_MAN": { name: "Stony Man", lat: 38.5833, lon: -78.3833, type: "mountain", region: "southeast", alt: 4011, desc: "Shenandoah summit" },
      "NE_OLD_RAG": { name: "Old Rag Mountain", lat: 38.5531, lon: -78.3164, type: "mountain", region: "southeast", alt: 3291, desc: "Rock scramble" },
      "NE_HAWKSBILL_VA": { name: "Hawksbill Summit VA", lat: 38.5583, lon: -78.3833, type: "mountain", region: "southeast", alt: 4051, desc: "Shenandoah highpoint" },
      "NE_DARK_HOLLOW_FALLS": { name: "Dark Hollow Falls", lat: 38.5167, lon: -78.4333, type: "waterfall", region: "southeast", alt: 3000, desc: "Shenandoah" },
      "NE_WHITEOAK_CANYON": { name: "Whiteoak Canyon", lat: 38.5333, lon: -78.3667, type: "waterfall", region: "southeast", alt: 2500, desc: "6 waterfalls" },
      "NE_LEWIS_FALLS_VA": { name: "Lewis Falls VA", lat: 38.5667, lon: -78.4667, type: "waterfall", region: "southeast", alt: 3200, desc: "81-foot falls" },
      "NE_BIG_MEADOWS": { name: "Big Meadows", lat: 38.5167, lon: -78.4333, type: "natural", region: "southeast", alt: 3500, desc: "Shenandoah meadow" },
      "NE_LURAY_CAVERNS": { name: "Luray Caverns", lat: 38.6500, lon: -78.4833, type: "natural", region: "southeast", alt: 1000, desc: "Stalactite organ" },
      "NE_NATURAL_BRIDGE_VA_VIEW": { name: "Natural Bridge VA View", lat: 37.6285, lon: -79.5438, type: "natural", region: "southeast", alt: 1000, desc: "Cedar Creek" },
      "NE_BLUE_RIDGE_PKWY_START": { name: "Blue Ridge Parkway Start", lat: 37.9333, lon: -78.9000, type: "natural", region: "southeast", alt: 2000, desc: "Mile 0" },
      "NE_PEAKS_OF_OTTER": { name: "Peaks of Otter", lat: 37.4500, lon: -79.5833, type: "mountain", region: "southeast", alt: 4001, desc: "Sharp Top" },
      "NE_MABRY_MILL": { name: "Mabry Mill", lat: 36.7500, lon: -80.4167, type: "landmark", region: "southeast", alt: 3000, desc: "Most photographed" },
      "NE_MOUNT_ROGERS": { name: "Mount Rogers", lat: 36.6597, lon: -81.5444, type: "mountain", region: "southeast", alt: 5729, desc: "Virginia highpoint" },
      "NE_WHITETOP_MOUNTAIN": { name: "Whitetop Mountain", lat: 36.6333, lon: -81.6000, type: "mountain", region: "southeast", alt: 5520, desc: "Wild ponies" },
      "NE_GRAYSON_HIGHLANDS": { name: "Grayson Highlands", lat: 36.6333, lon: -81.5167, type: "natural", region: "southeast", alt: 5000, desc: "Wild ponies" },
      "NE_BURKES_GARDEN": { name: "Burke's Garden", lat: 37.1000, lon: -81.3500, type: "natural", region: "southeast", alt: 3300, desc: "Gods Thumbprint" },
      "NE_BREAKS_INTERSTATE": { name: "Breaks Interstate Park", lat: 37.2833, lon: -82.2833, type: "natural", region: "southeast", alt: 1700, desc: "Grand Canyon of South" },
      "NE_NATURAL_TUNNEL": { name: "Natural Tunnel", lat: 36.7167, lon: -82.7500, type: "natural", region: "southeast", alt: 1400, desc: "Railroad tunnel" },
      "NE_CUMBERLAND_GAP": { name: "Cumberland Gap", lat: 36.6000, lon: -83.6667, type: "natural", region: "southeast", alt: 1650, desc: "Historic pass" },
      "NE_PINNACLE_OVERLOOK": { name: "Pinnacle Overlook", lat: 36.6167, lon: -83.6833, type: "natural", region: "southeast", alt: 2400, desc: "Three state view" },
      "NE_SENECA_ROCKS": { name: "Seneca Rocks", lat: 38.8333, lon: -79.3667, type: "natural", region: "southeast", alt: 2500, desc: "Climbing mecca" },
      "NE_SPRUCE_KNOB": { name: "Spruce Knob", lat: 38.7000, lon: -79.5333, type: "mountain", region: "southeast", alt: 4863, desc: "WV highpoint" },
      "NE_DOLLY_SODS": { name: "Dolly Sods Wilderness", lat: 38.9667, lon: -79.3333, type: "natural", region: "southeast", alt: 4000, desc: "Bog wilderness" },
      "NE_CANAAN_VALLEY": { name: "Canaan Valley", lat: 39.0500, lon: -79.4333, type: "natural", region: "southeast", alt: 3200, desc: "High valley" },
      "NE_HAWKS_NEST": { name: "Hawks Nest State Park", lat: 38.1167, lon: -81.1333, type: "natural", region: "southeast", alt: 1500, desc: "New River view" },
      "NE_GAULEY_RIVER": { name: "Gauley River", lat: 38.2167, lon: -80.9333, type: "natural", region: "southeast", alt: 1000, desc: "Whitewater" },
      "NE_SUMMERSVILLE_LAKE": { name: "Summersville Lake", lat: 38.2167, lon: -80.8667, type: "lake", region: "southeast", alt: 1700, desc: "Little Bahamas" },
      "NE_BABCOCK_STATE": { name: "Babcock State Park", lat: 38.0167, lon: -80.9500, type: "natural", region: "southeast", alt: 2000, desc: "Glade Creek Mill" },
      "NE_GLADE_CREEK_MILL": { name: "Glade Creek Grist Mill", lat: 38.0167, lon: -80.9500, type: "landmark", region: "southeast", alt: 2000, desc: "Most photographed" },
      "NAT_LAKE_CHAMPLAIN": { name: "Lake Champlain", lat: 44.5333, lon: -73.3333, type: "lake", region: "northeast", alt: 100, desc: "Vermont/NY border" },
      "NAT_FINGER_LAKES": { name: "Finger Lakes", lat: 42.6500, lon: -76.9167, type: "lake", region: "northeast", alt: 900, desc: "Seneca Lake" },
      "NAT_LAKE_PLACID": { name: "Lake Placid", lat: 44.2795, lon: -73.9799, type: "lake", region: "northeast", alt: 1900, desc: "Olympic village" },
      "NAT_LAKE_GEORGE": { name: "Lake George", lat: 43.4264, lon: -73.7118, type: "lake", region: "northeast", alt: 320, desc: "Queen of American Lakes" },
      "NAT_THOUSAND_ISLANDS_US": { name: "Thousand Islands US", lat: 44.3000, lon: -76.0000, type: "natural", region: "northeast", alt: 300, desc: "St. Lawrence River" },
      "NAT_DELAWARE_WATER_GAP": { name: "Delaware Water Gap", lat: 40.9667, lon: -75.1333, type: "natural", region: "northeast", alt: 1500, desc: "River gap" },
      "NAT_POTOMAC_FALLS": { name: "Great Falls of the Potomac", lat: 38.9981, lon: -77.2539, type: "waterfall", region: "northeast", alt: 200, desc: "DC area falls" },
      "NAT_SHENANDOAH_VALLEY": { name: "Shenandoah Valley", lat: 38.8000, lon: -78.8000, type: "natural", region: "southeast", alt: 1500, desc: "Blue Ridge valley" },
      "NAT_BLUE_RIDGE_PKWY": { name: "Blue Ridge Parkway", lat: 35.7796, lon: -82.0743, type: "natural", region: "southeast", alt: 5000, desc: "Scenic parkway" },
      "NAT_LINVILLE_GORGE": { name: "Linville Gorge", lat: 35.9167, lon: -81.9167, type: "natural", region: "southeast", alt: 3500, desc: "Grand Canyon of East" },
      "NAT_CHIMNEY_ROCK_NC": { name: "Chimney Rock NC", lat: 35.4392, lon: -82.2467, type: "natural", region: "southeast", alt: 2500, desc: "Blue Ridge spire" },
      "NAT_TALLULAH_GORGE": { name: "Tallulah Gorge", lat: 34.7378, lon: -83.3939, type: "natural", region: "southeast", alt: 1600, desc: "Georgia gorge" },
      "NAT_PROVIDENCE_CANYON": { name: "Providence Canyon", lat: 31.9728, lon: -84.9106, type: "natural", region: "southeast", alt: 500, desc: "Little Grand Canyon" },
      "NAT_MAMMOTH_SPRING": { name: "Mammoth Spring", lat: 36.4964, lon: -91.5336, type: "natural", region: "southeast", alt: 700, desc: "Arkansas spring" },
      "NAT_BLANCHARD_SPRINGS": { name: "Blanchard Springs Caverns", lat: 35.9581, lon: -92.1717, type: "natural", region: "southeast", alt: 800, desc: "Living cave" },
      "NAT_PETIT_JEAN": { name: "Petit Jean Mountain", lat: 35.1167, lon: -92.9333, type: "mountain", region: "southeast", alt: 1100, desc: "Arkansas canyon" },
      "NAT_DEVILS_DEN": { name: "Devils Den State Park", lat: 35.7833, lon: -94.2500, type: "natural", region: "southeast", alt: 1500, desc: "Ozark caves" },
      "NAT_TURNER_FALLS": { name: "Turner Falls", lat: 34.4261, lon: -97.1500, type: "waterfall", region: "southwest", alt: 1100, desc: "Oklahoma's tallest" },
      "NAT_WICHITA_MTNS": { name: "Wichita Mountains", lat: 34.7500, lon: -98.7167, type: "mountain", region: "southwest", alt: 2500, desc: "Oklahoma refuge" },
      "NAT_PALO_DURO": { name: "Palo Duro Canyon", lat: 34.9333, lon: -101.6667, type: "natural", region: "southwest", alt: 3500, desc: "Second largest US canyon" },
      "NAT_GUADALUPE_RIVER": { name: "Guadalupe River", lat: 29.8611, lon: -98.4250, type: "natural", region: "southwest", alt: 1000, desc: "Texas Hill Country" },
      "NAT_HAMILTON_POOL": { name: "Hamilton Pool", lat: 30.3422, lon: -98.1269, type: "natural", region: "southwest", alt: 900, desc: "Grotto waterfall" },
      "NAT_JACOB_WELL": { name: "Jacob's Well", lat: 30.0333, lon: -98.1250, type: "natural", region: "southwest", alt: 1000, desc: "Artesian spring" },
      "NAT_LOST_MAPLES": { name: "Lost Maples", lat: 29.8083, lon: -99.5750, type: "natural", region: "southwest", alt: 2100, desc: "Fall colors" },
      "NAT_BIG_THICKET": { name: "Big Thicket", lat: 30.4583, lon: -94.3583, type: "natural", region: "southwest", alt: 100, desc: "Biological crossroads" },
      "NAT_PADRE_ISLAND": { name: "Padre Island", lat: 27.0000, lon: -97.4000, type: "natural", region: "southwest", alt: 10, desc: "Longest barrier island" },
      "NAT_BOCA_CHICA": { name: "Boca Chica Beach", lat: 25.9972, lon: -97.1556, type: "natural", region: "southwest", alt: 10, desc: "SpaceX launch view" },
      "NAT_SANTA_ELENA": { name: "Santa Elena Canyon", lat: 29.1667, lon: -103.6000, type: "natural", region: "southwest", alt: 2500, desc: "Big Bend canyon" },
      "NAT_MARFA_LIGHTS": { name: "Marfa Lights Viewing", lat: 30.2861, lon: -104.0094, type: "natural", region: "southwest", alt: 4700, desc: "Mystery lights" },
      "NAT_GUADALUPE_MTNS": { name: "Guadalupe Mountains", lat: 31.9167, lon: -104.8500, type: "mountain", region: "southwest", alt: 8000, desc: "Texas highpoint" },
      "NAT_CAPULIN": { name: "Capulin Volcano", lat: 36.7817, lon: -103.9697, type: "natural", region: "southwest", alt: 8200, desc: "Cinder cone" },
      "NAT_TENT_ROCKS": { name: "Kasha-Katuwe Tent Rocks", lat: 35.6739, lon: -106.4217, type: "natural", region: "southwest", alt: 6300, desc: "Cone formations" },
      "NAT_BANDELIER": { name: "Bandelier National Monument", lat: 35.7792, lon: -106.2711, type: "natural", region: "southwest", alt: 6500, desc: "Cliff dwellings" },
      "NAT_GILA_CLIFF": { name: "Gila Cliff Dwellings", lat: 33.2272, lon: -108.2722, type: "natural", region: "southwest", alt: 5700, desc: "Ancient pueblo" },
      "NAT_WHITE_SANDS": { name: "White Sands Dunes", lat: 32.7872, lon: -106.3257, type: "natural", region: "southwest", alt: 4000, desc: "Gypsum dunes" },
      "NAT_VALLEY_OF_FIRE": { name: "Valley of Fire", lat: 36.4367, lon: -114.5131, type: "natural", region: "southwest", alt: 2500, desc: "Red sandstone" },
      "NAT_RED_ROCK_CANYON": { name: "Red Rock Canyon", lat: 36.1350, lon: -115.4275, type: "natural", region: "southwest", alt: 4000, desc: "Vegas backdrop" },
      "NAT_CATHEDRAL_ROCK": { name: "Cathedral Rock", lat: 34.8228, lon: -111.7897, type: "natural", region: "southwest", alt: 4900, desc: "Sedona vortex" },
      "NAT_BELL_ROCK": { name: "Bell Rock", lat: 34.8075, lon: -111.7633, type: "natural", region: "southwest", alt: 4500, desc: "Sedona landmark" },
      "NAT_DEVIL_BRIDGE": { name: "Devil's Bridge", lat: 34.9028, lon: -111.8133, type: "natural", region: "southwest", alt: 4600, desc: "Sedona arch" },
      "NAT_SLIDE_ROCK": { name: "Slide Rock", lat: 34.9444, lon: -111.7514, type: "natural", region: "southwest", alt: 4900, desc: "Oak Creek" },
      "NAT_VERMILION_CLIFFS": { name: "Vermilion Cliffs", lat: 36.8167, lon: -111.7500, type: "natural", region: "southwest", alt: 5000, desc: "Condor habitat" },
      "NAT_GRAND_STAIRCASE": { name: "Grand Staircase-Escalante", lat: 37.4000, lon: -111.5000, type: "natural", region: "southwest", alt: 5500, desc: "Slot canyons" },
      "NAT_GOBLIN_VALLEY": { name: "Goblin Valley", lat: 38.5647, lon: -110.7139, type: "natural", region: "southwest", alt: 5000, desc: "Hoodoo formations" },
      "NAT_DEAD_HORSE": { name: "Dead Horse Point", lat: 38.4828, lon: -109.7389, type: "natural", region: "southwest", alt: 6000, desc: "Colorado River overlook" },
      "NAT_CORONA_ARCH": { name: "Corona Arch", lat: 38.5794, lon: -109.6208, type: "natural", region: "southwest", alt: 4500, desc: "Moab arch" },
      "NAT_FISHER_TOWERS": { name: "Fisher Towers", lat: 38.7258, lon: -109.3086, type: "natural", region: "southwest", alt: 5000, desc: "Sandstone spires" },
      "NAT_CASTLE_VALLEY": { name: "Castle Valley", lat: 38.6333, lon: -109.4167, type: "natural", region: "southwest", alt: 5000, desc: "Buttes and mesas" },
      "NAT_MIRROR_LAKE": { name: "Mirror Lake", lat: 40.7000, lon: -110.8833, type: "lake", region: "mountain", alt: 10200, desc: "Uinta Mountains" },
      "NAT_FLAMING_GORGE": { name: "Flaming Gorge", lat: 41.1000, lon: -109.5000, type: "natural", region: "mountain", alt: 6000, desc: "Red canyon" },
      "NAT_DINOSAUR_NM": { name: "Dinosaur National Monument", lat: 40.4375, lon: -109.3042, type: "natural", region: "mountain", alt: 5000, desc: "Fossil quarry" },
      "NAT_BLACK_CANYON": { name: "Black Canyon Gunnison", lat: 38.5754, lon: -107.7416, type: "natural", region: "mountain", alt: 8000, desc: "Deep canyon" },
      "NAT_HANGING_LAKE": { name: "Hanging Lake", lat: 39.6017, lon: -107.1925, type: "natural", region: "mountain", alt: 7300, desc: "Travertine lake" },
      "NAT_TWIN_LAKES": { name: "Twin Lakes", lat: 39.0833, lon: -106.3833, type: "lake", region: "mountain", alt: 9200, desc: "Colorado reservoirs" },
      "NAT_MOUNT_MASSIVE": { name: "Mount Massive", lat: 39.1875, lon: -106.4756, type: "mountain", region: "mountain", alt: 14428, desc: "Second highest Colorado" },
      "NAT_MOUNT_SNEFFELS": { name: "Mount Sneffels", lat: 38.0036, lon: -107.7922, type: "mountain", region: "mountain", alt: 14158, desc: "San Juan peak" },
      "NAT_OURAY_BOX_CANYON": { name: "Box Canyon Falls", lat: 38.0178, lon: -107.6744, type: "waterfall", region: "mountain", alt: 8000, desc: "Ouray falls" },
      "NAT_TELLURIDE_FALLS": { name: "Bridal Veil Falls CO", lat: 37.9167, lon: -107.7667, type: "waterfall", region: "mountain", alt: 10000, desc: "Tallest Colorado falls" },
      "NAT_MILLION_DOLLAR": { name: "Million Dollar Highway", lat: 37.8333, lon: -107.7333, type: "natural", region: "mountain", alt: 10000, desc: "Scenic byway" },
      "NAT_DURANGO_SILVERTON": { name: "Durango-Silverton Railroad", lat: 37.5500, lon: -107.7833, type: "landmark", region: "mountain", alt: 9000, desc: "Historic train" },
      "NAT_MESA_VERDE_CLIFF": { name: "Cliff Palace", lat: 37.1678, lon: -108.4731, type: "natural", region: "southwest", alt: 7000, desc: "Ancestral Puebloan" },
      "NAT_SHIP_ROCK_NM": { name: "Shiprock Peak", lat: 36.6875, lon: -108.8367, type: "mountain", region: "southwest", alt: 7200, desc: "Volcanic neck" },
      "NAT_CHACO_CANYON": { name: "Chaco Culture", lat: 36.0603, lon: -107.9611, type: "natural", region: "southwest", alt: 6200, desc: "Ancient ruins" },
      "NAT_EL_MORRO": { name: "El Morro", lat: 35.0375, lon: -108.3458, type: "natural", region: "southwest", alt: 7200, desc: "Inscription Rock" },
      "NAT_PETRIFIED_LOGS": { name: "Crystal Forest", lat: 34.8833, lon: -109.7833, type: "natural", region: "southwest", alt: 5600, desc: "Petrified wood" },
      "NAT_SUNSET_CRATER": { name: "Sunset Crater", lat: 35.3650, lon: -111.5003, type: "natural", region: "southwest", alt: 7000, desc: "Volcanic cinder cone" },
      "NAT_WUPATKI": { name: "Wupatki Pueblo", lat: 35.5206, lon: -111.3669, type: "natural", region: "southwest", alt: 4900, desc: "Ancient pueblo" },
      "NAT_WALNUT_CANYON": { name: "Walnut Canyon", lat: 35.1717, lon: -111.5108, type: "natural", region: "southwest", alt: 6700, desc: "Cliff dwellings" },
      "NAT_MONTEZUMA_CASTLE": { name: "Montezuma Castle", lat: 34.6117, lon: -111.8350, type: "natural", region: "southwest", alt: 3200, desc: "Cliff dwelling" },
      "NAT_TONTO_BRIDGE": { name: "Tonto Natural Bridge", lat: 34.3214, lon: -111.4547, type: "natural", region: "southwest", alt: 4600, desc: "Largest travertine bridge" },
      "NAT_SUPERSTITION_MTNS": { name: "Superstition Mountains", lat: 33.4500, lon: -111.2833, type: "mountain", region: "southwest", alt: 5000, desc: "Lost Dutchman mine" },
      "NAT_ORGAN_PIPE": { name: "Organ Pipe Cactus", lat: 32.0333, lon: -112.8500, type: "natural", region: "southwest", alt: 2000, desc: "Sonoran desert" },
      "NAT_CHIRICAHUA": { name: "Chiricahua National Monument", lat: 32.0133, lon: -109.3417, type: "natural", region: "southwest", alt: 6800, desc: "Wonderland of Rocks" },
      "NAT_KARTCHNER": { name: "Kartchner Caverns", lat: 31.8375, lon: -110.3472, type: "natural", region: "southwest", alt: 4600, desc: "Living cave" },
      "NAT_COLOSSAL_CAVE": { name: "Colossal Cave", lat: 32.0683, lon: -110.6342, type: "natural", region: "southwest", alt: 3400, desc: "Dry cave" },
      "NAT_SABINO_CANYON": { name: "Sabino Canyon", lat: 32.3167, lon: -110.8167, type: "natural", region: "southwest", alt: 3000, desc: "Tucson canyon" },
      "NAT_GATES_PASS": { name: "Gates Pass", lat: 32.2208, lon: -111.1183, type: "natural", region: "southwest", alt: 3200, desc: "Tucson sunset spot" },
      "NAT_ANZA_BORREGO": { name: "Anza-Borrego Desert", lat: 33.1000, lon: -116.3000, type: "natural", region: "pacific", alt: 1500, desc: "Desert wildflowers" },
      "NAT_PALM_SPRINGS_TRAM": { name: "Palm Springs Aerial Tramway", lat: 33.8536, lon: -116.6142, type: "natural", region: "pacific", alt: 8500, desc: "Mountain summit" },
      "NAT_JOSHUA_TREE_ARCH": { name: "Arch Rock", lat: 33.9917, lon: -116.0375, type: "natural", region: "pacific", alt: 4200, desc: "Joshua Tree arch" },
      "NAT_SKULL_ROCK": { name: "Skull Rock", lat: 33.9981, lon: -116.0536, type: "natural", region: "pacific", alt: 4300, desc: "Joshua Tree formation" },
      "NAT_CARRIZO_PLAIN": { name: "Carrizo Plain", lat: 35.1500, lon: -119.8500, type: "natural", region: "pacific", alt: 2500, desc: "Wildflower bloom" },
      "NAT_PINNACLES_CAVES": { name: "Bear Gulch Cave", lat: 36.4833, lon: -121.1833, type: "natural", region: "pacific", alt: 2000, desc: "Talus cave" },
      "NAT_MORRO_ROCK": { name: "Morro Rock", lat: 35.3711, lon: -120.8683, type: "natural", region: "pacific", alt: 600, desc: "Volcanic plug" },
      "NAT_HEARST_BEACH": { name: "San Simeon Beach", lat: 35.6450, lon: -121.1897, type: "natural", region: "pacific", alt: 50, desc: "Elephant seals" },
      "NAT_MCWAY_FALLS": { name: "McWay Falls", lat: 36.1578, lon: -121.6722, type: "waterfall", region: "pacific", alt: 100, desc: "Tidefall" },
      "NAT_PFEIFFER_BEACH": { name: "Pfeiffer Beach", lat: 36.2383, lon: -121.8150, type: "natural", region: "pacific", alt: 50, desc: "Keyhole Arch" },
      "NAT_POINT_LOBOS": { name: "Point Lobos", lat: 36.5200, lon: -121.9400, type: "natural", region: "pacific", alt: 100, desc: "Crown jewel" },
      "NAT_CARMEL_MISSION": { name: "Carmel Mission", lat: 36.5428, lon: -121.9208, type: "landmark", region: "pacific", alt: 100, desc: "Historic mission" },
      "NAT_MUIR_WOODS": { name: "Muir Woods", lat: 37.8970, lon: -122.5811, type: "natural", region: "pacific", alt: 500, desc: "Coastal redwoods" },
      "NAT_STINSON_BEACH": { name: "Stinson Beach", lat: 37.9000, lon: -122.6500, type: "natural", region: "pacific", alt: 50, desc: "Marin beach" },
      "NAT_BODEGA_BAY": { name: "Bodega Bay", lat: 38.3333, lon: -123.0500, type: "natural", region: "pacific", alt: 50, desc: "Birds filming location" },
      "NAT_SONOMA_COAST": { name: "Sonoma Coast", lat: 38.4500, lon: -123.1000, type: "natural", region: "pacific", alt: 100, desc: "Rocky coastline" },
      "NAT_MENDOCINO": { name: "Mendocino Headlands", lat: 39.3083, lon: -123.8000, type: "natural", region: "pacific", alt: 100, desc: "Coastal bluffs" },
      "NAT_GLASS_BEACH": { name: "Glass Beach", lat: 39.4522, lon: -123.8108, type: "natural", region: "pacific", alt: 50, desc: "Sea glass beach" },
      "NAT_FERN_CANYON": { name: "Fern Canyon", lat: 41.4011, lon: -124.0650, type: "natural", region: "pacific", alt: 100, desc: "Jurassic Park location" },
      "PNW_CRATER_LAKE_ISLAND": { name: "Wizard Island", lat: 42.9467, lon: -122.1467, type: "natural", region: "pacific", alt: 6900, desc: "Crater Lake island" },
      "PNW_PAINTED_HILLS": { name: "Painted Hills", lat: 44.6625, lon: -120.2722, type: "natural", region: "pacific", alt: 3000, desc: "John Day Fossil Beds" },
      "PNW_SMITH_ROCK": { name: "Smith Rock", lat: 44.3683, lon: -121.1406, type: "natural", region: "pacific", alt: 3200, desc: "Climbing mecca" },
      "PNW_NEWBERRY_CRATER": { name: "Newberry Volcanic Monument", lat: 43.7167, lon: -121.2333, type: "natural", region: "pacific", alt: 6400, desc: "Obsidian flows" },
      "PNW_LAVA_RIVER_CAVE": { name: "Lava River Cave", lat: 43.8958, lon: -121.3683, type: "natural", region: "pacific", alt: 4500, desc: "Lava tube" },
      "PNW_THREE_SISTERS": { name: "Three Sisters Wilderness", lat: 44.1000, lon: -121.7667, type: "mountain", region: "pacific", alt: 10000, desc: "Cascade volcanoes" },
      "PNW_MOUNT_BACHELOR": { name: "Mount Bachelor", lat: 43.9792, lon: -121.6886, type: "mountain", region: "pacific", alt: 9068, desc: "Ski resort" },
      "PNW_PROXY_FALLS": { name: "Proxy Falls", lat: 44.1622, lon: -121.9306, type: "waterfall", region: "pacific", alt: 4500, desc: "Cascading falls" },
      "PNW_SAHALIE_FALLS": { name: "Sahalie Falls", lat: 44.3483, lon: -121.9961, type: "waterfall", region: "pacific", alt: 3000, desc: "McKenzie River" },
      "PNW_SILVER_FALLS": { name: "Silver Falls State Park", lat: 44.8775, lon: -122.6539, type: "waterfall", region: "pacific", alt: 1500, desc: "Trail of Ten Falls" },
      "PNW_THOR_WELL": { name: "Thor's Well", lat: 44.2786, lon: -124.1136, type: "natural", region: "pacific", alt: 50, desc: "Draining sinkhole" },
      "PNW_DEVILS_CHURN": { name: "Devil's Churn", lat: 44.2753, lon: -124.1122, type: "natural", region: "pacific", alt: 50, desc: "Sea cave" },
      "PNW_SEA_LION_CAVES": { name: "Sea Lion Caves", lat: 44.1219, lon: -124.1272, type: "natural", region: "pacific", alt: 50, desc: "Largest sea cave" },
      "PNW_HAYSTACK_ROCK": { name: "Haystack Rock", lat: 45.8842, lon: -123.9678, type: "natural", region: "pacific", alt: 200, desc: "Cannon Beach" },
      "PNW_ASTORIA_COLUMN": { name: "Astoria Column", lat: 46.1781, lon: -123.8156, type: "landmark", region: "pacific", alt: 700, desc: "Columbia view" },
      "PNW_CAPE_PERPETUA": { name: "Cape Perpetua", lat: 44.2833, lon: -124.1083, type: "natural", region: "pacific", alt: 800, desc: "Highest Oregon coast viewpoint" },
      "PNW_MOUNT_TABOR": { name: "Mount Tabor", lat: 45.5117, lon: -122.5942, type: "natural", region: "pacific", alt: 600, desc: "Urban volcano Portland" },
      "PNW_FOREST_PARK": { name: "Forest Park Portland", lat: 45.5500, lon: -122.7667, type: "natural", region: "pacific", alt: 1000, desc: "Urban forest" },
      "PNW_BONNEVILLE_FISH": { name: "Bonneville Fish Hatchery", lat: 45.6389, lon: -121.9433, type: "landmark", region: "pacific", alt: 100, desc: "Sturgeon viewing" },
      "PNW_BEACON_ROCK": { name: "Beacon Rock", lat: 45.6286, lon: -122.0225, type: "natural", region: "pacific", alt: 900, desc: "Volcanic core" },
      "PNW_DIABLO_LAKE": { name: "Diablo Lake", lat: 48.7167, lon: -121.1333, type: "lake", region: "pacific", alt: 1200, desc: "Turquoise glacial lake" },
      "PNW_ROSS_LAKE": { name: "Ross Lake", lat: 48.8833, lon: -121.0667, type: "lake", region: "pacific", alt: 1600, desc: "North Cascades" },
      "PNW_MOUNT_BAKER": { name: "Mount Baker", lat: 48.7768, lon: -121.8145, type: "mountain", region: "pacific", alt: 10781, desc: "Glacier Peak" },
      "PNW_ARTIST_POINT": { name: "Artist Point", lat: 48.8486, lon: -121.6928, type: "natural", region: "pacific", alt: 5100, desc: "Mount Baker view" },
      "PNW_SAN_JUAN_ISLANDS": { name: "San Juan Islands", lat: 48.5500, lon: -123.0000, type: "natural", region: "pacific", alt: 200, desc: "Puget Sound islands" },
      "PNW_ORCAS_ISLAND": { name: "Mount Constitution", lat: 48.6792, lon: -122.8333, type: "mountain", region: "pacific", alt: 2400, desc: "Highest San Juans" },
      "PNW_WHIDBEY_ISLAND": { name: "Whidbey Island", lat: 48.1500, lon: -122.6500, type: "natural", region: "pacific", alt: 200, desc: "Longest island" },
      "PNW_HURRICANE_RIDGE": { name: "Hurricane Ridge", lat: 47.9692, lon: -123.4992, type: "natural", region: "pacific", alt: 5200, desc: "Olympic views" },
      "PNW_HOH_RAINFOREST": { name: "Hoh Rain Forest", lat: 47.8600, lon: -123.9350, type: "natural", region: "pacific", alt: 600, desc: "Temperate rainforest" },
      "PNW_RIALTO_BEACH": { name: "Rialto Beach", lat: 47.9206, lon: -124.6375, type: "natural", region: "pacific", alt: 50, desc: "Sea stacks" },
      "PNW_RUBY_BEACH": { name: "Ruby Beach", lat: 47.7108, lon: -124.4158, type: "natural", region: "pacific", alt: 50, desc: "Olympic coast" },
      "PNW_LA_PUSH": { name: "La Push", lat: 47.9097, lon: -124.6356, type: "natural", region: "pacific", alt: 50, desc: "Twilight location" },
      "PNW_CAPE_FLATTERY": { name: "Cape Flattery", lat: 48.3833, lon: -124.7167, type: "natural", region: "pacific", alt: 100, desc: "Northwestern tip US" },
      "AK_MENDENHALL": { name: "Mendenhall Glacier", lat: 58.4303, lon: -134.5458, type: "natural", region: "alaska", alt: 1000, desc: "Juneau glacier" },
      "AK_TRACY_ARM": { name: "Tracy Arm Fjord", lat: 57.8500, lon: -133.6167, type: "natural", region: "alaska", alt: 500, desc: "Cruise destination" },
      "AK_HUBBARD_GLACIER": { name: "Hubbard Glacier", lat: 60.0167, lon: -139.4667, type: "natural", region: "alaska", alt: 500, desc: "Advancing glacier" },
      "AK_PORTAGE_GLACIER": { name: "Portage Glacier", lat: 60.7667, lon: -148.8333, type: "natural", region: "alaska", alt: 500, desc: "Anchorage day trip" },
      "AK_MATANUSKA": { name: "Matanuska Glacier", lat: 61.7833, lon: -147.7500, type: "natural", region: "alaska", alt: 2500, desc: "Accessible glacier" },
      "AK_WORTHINGTON": { name: "Worthington Glacier", lat: 61.1667, lon: -145.7833, type: "natural", region: "alaska", alt: 2800, desc: "Thompson Pass" },
      "AK_VALDEZ": { name: "Valdez", lat: 61.1308, lon: -146.3483, type: "landmark", region: "alaska", alt: 50, desc: "Pipeline terminus" },
      "AK_SEWARD": { name: "Seward", lat: 60.1042, lon: -149.4422, type: "landmark", region: "alaska", alt: 50, desc: "Kenai gateway" },
      "AK_HOMER": { name: "Homer Spit", lat: 59.6017, lon: -151.4083, type: "landmark", region: "alaska", alt: 50, desc: "Halibut fishing" },
      "AK_KODIAK": { name: "Kodiak Island", lat: 57.7900, lon: -152.4072, type: "natural", region: "alaska", alt: 500, desc: "Bear habitat" },
      "AK_SITKA": { name: "Sitka", lat: 57.0531, lon: -135.3300, type: "landmark", region: "alaska", alt: 50, desc: "Russian heritage" },
      "AK_KETCHIKAN": { name: "Ketchikan", lat: 55.3422, lon: -131.6461, type: "landmark", region: "alaska", alt: 50, desc: "Salmon capital" },
      "AK_SKAGWAY": { name: "Skagway", lat: 59.4583, lon: -135.3139, type: "landmark", region: "alaska", alt: 50, desc: "Gold rush town" },
      "AK_HAINES": { name: "Haines", lat: 59.2358, lon: -135.4450, type: "landmark", region: "alaska", alt: 50, desc: "Eagle preserve" },
      "AK_DALTON_HWY": { name: "Dalton Highway", lat: 66.5639, lon: -150.6875, type: "landmark", region: "alaska", alt: 1500, desc: "Arctic Circle crossing" },
      "AK_ARCTIC_CIRCLE": { name: "Arctic Circle Sign", lat: 66.5633, lon: -150.8083, type: "landmark", region: "alaska", alt: 1500, desc: "66.5Â° N" },
      "AK_DEADHORSE": { name: "Deadhorse", lat: 70.2006, lon: -148.4597, type: "landmark", region: "alaska", alt: 50, desc: "Prudhoe Bay town" },
      "AK_NOME": { name: "Nome", lat: 64.5011, lon: -165.4064, type: "landmark", region: "alaska", alt: 50, desc: "Iditarod finish" },
      "AK_BARROW": { name: "Utqiagvik (Barrow)", lat: 71.2906, lon: -156.7886, type: "landmark", region: "alaska", alt: 50, desc: "Northernmost US city" },
      "AK_BETHEL": { name: "Bethel", lat: 60.7922, lon: -161.7558, type: "landmark", region: "alaska", alt: 50, desc: "Yukon Delta gateway" },
      "AK_DUTCH_HARBOR": { name: "Dutch Harbor", lat: 53.8894, lon: -166.5422, type: "landmark", region: "alaska", alt: 50, desc: "Deadliest Catch port" },
      "AK_MOUNT_MCKINLEY_VIEW": { name: "Denali Viewpoint South", lat: 62.7833, lon: -150.0833, type: "natural", region: "alaska", alt: 2400, desc: "Clear day views" },
      "AK_TALKEETNA": { name: "Talkeetna", lat: 62.3239, lon: -150.1092, type: "landmark", region: "alaska", alt: 400, desc: "Denali flights base" },
      "AK_WONDER_LAKE": { name: "Wonder Lake", lat: 63.4583, lon: -150.8750, type: "lake", region: "alaska", alt: 2100, desc: "Denali reflection" },
      "AK_SAVAGE_RIVER": { name: "Savage River", lat: 63.7167, lon: -149.2333, type: "natural", region: "alaska", alt: 3000, desc: "Denali NP" },
      "AK_CHENA_HOT": { name: "Chena Hot Springs", lat: 65.0533, lon: -146.0556, type: "natural", region: "alaska", alt: 1200, desc: "Aurora viewing" },
      "MW_MACKINAC_ISLAND": { name: "Mackinac Island", lat: 45.8492, lon: -84.6189, type: "landmark", region: "midwest", alt: 700, desc: "Car-free island" },
      "MW_GRAND_HOTEL": { name: "Grand Hotel Mackinac", lat: 45.8519, lon: -84.6206, type: "landmark", region: "midwest", alt: 700, desc: "Longest porch" },
      "MW_TAHQUAMENON": { name: "Tahquamenon Falls", lat: 46.5750, lon: -85.2417, type: "waterfall", region: "midwest", alt: 900, desc: "Root beer falls" },
      "MW_PORCUPINE_MTNS": { name: "Porcupine Mountains", lat: 46.8000, lon: -89.7833, type: "mountain", region: "midwest", alt: 2000, desc: "Lake of the Clouds" },
      "MW_LAKE_OF_CLOUDS": { name: "Lake of the Clouds", lat: 46.8067, lon: -89.7908, type: "lake", region: "midwest", alt: 1400, desc: "Scenic overlook" },
      "MW_ISLE_ROYALE": { name: "Isle Royale", lat: 48.0000, lon: -88.8333, type: "natural", region: "midwest", alt: 800, desc: "Wolf-moose study" },
      "MW_KEWEENAW": { name: "Keweenaw Peninsula", lat: 47.3667, lon: -88.3500, type: "natural", region: "midwest", alt: 1200, desc: "Copper country" },
      "MW_COPPER_HARBOR": { name: "Copper Harbor", lat: 47.4683, lon: -87.8903, type: "landmark", region: "midwest", alt: 700, desc: "Northern Michigan" },
      "MW_BROCKWAY_MTN": { name: "Brockway Mountain Drive", lat: 47.4667, lon: -87.9333, type: "natural", region: "midwest", alt: 1300, desc: "Scenic drive" },
      "MW_KITCHI_GAMMI": { name: "Lake Superior Scenic Drive", lat: 47.0000, lon: -91.0000, type: "natural", region: "midwest", alt: 700, desc: "North Shore MN" },
      "MW_GOOSEBERRY_FALLS": { name: "Gooseberry Falls", lat: 47.1392, lon: -91.4678, type: "waterfall", region: "midwest", alt: 700, desc: "North Shore" },
      "MW_TETTEGOUCHE": { name: "Tettegouche State Park", lat: 47.3458, lon: -91.2000, type: "natural", region: "midwest", alt: 1000, desc: "High Falls" },
      "MW_PALISADE_HEAD": { name: "Palisade Head", lat: 47.3333, lon: -91.2167, type: "natural", region: "midwest", alt: 350, desc: "Cliff overlook" },
      "MW_GRAND_PORTAGE": { name: "Grand Portage", lat: 47.9631, lon: -89.6856, type: "landmark", region: "midwest", alt: 700, desc: "Fur trade post" },
      "MW_HIGH_FALLS_MN": { name: "High Falls Pigeon River", lat: 48.0000, lon: -89.5833, type: "waterfall", region: "midwest", alt: 1000, desc: "Minnesota's highest" },
      "MW_ITASCA": { name: "Lake Itasca", lat: 47.2358, lon: -95.2058, type: "lake", region: "midwest", alt: 1500, desc: "Mississippi headwaters" },
      "MW_HEADWATERS": { name: "Mississippi Headwaters", lat: 47.2392, lon: -95.2069, type: "natural", region: "midwest", alt: 1500, desc: "Mile 0" },
      "MW_BOUNDARY_WATERS": { name: "Boundary Waters", lat: 48.0000, lon: -91.0000, type: "natural", region: "midwest", alt: 1500, desc: "Canoe wilderness" },
      "MW_ELY": { name: "Ely", lat: 47.9033, lon: -91.8672, type: "landmark", region: "midwest", alt: 1500, desc: "BWCA gateway" },
      "MW_STONE_ARCH": { name: "Stone Arch Bridge", lat: 44.9803, lon: -93.2567, type: "bridge", region: "midwest", alt: 850, desc: "Minneapolis landmark" },
      "MW_MINNEHAHA": { name: "Minnehaha Falls", lat: 44.9153, lon: -93.2111, type: "waterfall", region: "midwest", alt: 850, desc: "Hiawatha" },
      "MW_COMO_PARK": { name: "Como Park Zoo", lat: 44.9817, lon: -93.1508, type: "landmark", region: "midwest", alt: 900, desc: "St. Paul zoo" },
      "MW_WISCONSIN_DELLS": { name: "Wisconsin Dells", lat: 43.6275, lon: -89.7710, type: "natural", region: "midwest", alt: 900, desc: "Sandstone gorge" },
      "MW_DEVILS_LAKE_WI": { name: "Devil's Lake", lat: 43.4258, lon: -89.7297, type: "lake", region: "midwest", alt: 1000, desc: "Quartzite bluffs" },
      "MW_CAVE_OF_MOUNDS": { name: "Cave of the Mounds", lat: 43.0089, lon: -89.8328, type: "natural", region: "midwest", alt: 1100, desc: "Show cave" },
      "MW_HOUSE_ROCK": { name: "House on the Rock", lat: 43.0903, lon: -90.1361, type: "landmark", region: "midwest", alt: 1100, desc: "Quirky attraction" },
      "MW_TALIESIN": { name: "Taliesin", lat: 43.1408, lon: -90.0703, type: "landmark", region: "midwest", alt: 1000, desc: "Frank Lloyd Wright" },
      "MW_GALENA": { name: "Galena", lat: 42.4169, lon: -90.4290, type: "landmark", region: "midwest", alt: 800, desc: "Historic downtown" },
      "MW_GARDEN_GODS_IL": { name: "Garden of the Gods IL", lat: 37.6028, lon: -88.3742, type: "natural", region: "midwest", alt: 900, desc: "Shawnee NF" },
      "MW_GIANT_CITY": { name: "Giant City State Park", lat: 37.6000, lon: -89.1833, type: "natural", region: "midwest", alt: 700, desc: "Sandstone bluffs" },
      "MW_CAHOKIA": { name: "Cahokia Mounds", lat: 38.6556, lon: -90.0619, type: "landmark", region: "midwest", alt: 500, desc: "Ancient city" },
      "MW_MAMMOTH_CAVE_KY": { name: "Mammoth Cave Entrance", lat: 37.1870, lon: -86.1004, type: "natural", region: "southeast", alt: 700, desc: "World's longest cave" },
      "MW_CUMBERLAND_FALLS": { name: "Cumberland Falls", lat: 36.8397, lon: -84.3456, type: "waterfall", region: "southeast", alt: 1200, desc: "Moonbow" },
      "MW_NATURAL_BRIDGE_KY": { name: "Natural Bridge KY", lat: 37.7750, lon: -83.6842, type: "natural", region: "southeast", alt: 1400, desc: "Red River Gorge" },
      "MW_RED_RIVER_GORGE": { name: "Red River Gorge", lat: 37.8000, lon: -83.6833, type: "natural", region: "southeast", alt: 1200, desc: "Climbing area" },
      "MW_BOURBON_TRAIL": { name: "Bourbon Trail Distilleries", lat: 38.0406, lon: -84.8089, type: "landmark", region: "southeast", alt: 900, desc: "Maker's Mark" },
      "MW_LOUISVILLE_SLUGGER": { name: "Louisville Slugger Museum", lat: 38.2578, lon: -85.7644, type: "landmark", region: "southeast", alt: 500, desc: "Giant bat" },
      "MW_CHURCHILL_DOWNS": { name: "Churchill Downs", lat: 38.2028, lon: -85.7706, type: "stadium", region: "southeast", alt: 500, desc: "Kentucky Derby" },
      "MW_KEENELAND": { name: "Keeneland", lat: 38.0417, lon: -84.5833, type: "stadium", region: "southeast", alt: 1000, desc: "Horse racing" },
      "MW_BOURBON_COUNTY": { name: "Bourbon County KY", lat: 38.2167, lon: -84.2167, type: "landmark", region: "southeast", alt: 900, desc: "Namesake bourbon" },
      "MW_MAMMOTH_SPRING": { name: "Big Spring MO", lat: 36.9500, lon: -90.9833, type: "natural", region: "midwest", alt: 500, desc: "Largest spring" },
      "MW_HA_HA_TONKA": { name: "Ha Ha Tonka", lat: 37.9750, lon: -92.7750, type: "natural", region: "midwest", alt: 900, desc: "Castle ruins" },
      "MW_ONONDAGA_CAVE": { name: "Onondaga Cave", lat: 38.0625, lon: -91.2275, type: "natural", region: "midwest", alt: 700, desc: "Show cave" },
      "MW_MERAMEC_CAVERNS": { name: "Meramec Caverns", lat: 38.2728, lon: -91.0842, type: "natural", region: "midwest", alt: 600, desc: "Route 66 cave" },
      "MW_ELEPHANT_ROCKS": { name: "Elephant Rocks", lat: 37.6542, lon: -90.6917, type: "natural", region: "midwest", alt: 1200, desc: "Granite boulders" },
      "MW_JOHNSON_SHUT_INS": { name: "Johnson's Shut-Ins", lat: 37.5500, lon: -90.8500, type: "natural", region: "midwest", alt: 1000, desc: "Natural waterpark" },
      "MW_TAUM_SAUK": { name: "Taum Sauk Mountain", lat: 37.5722, lon: -90.7292, type: "mountain", region: "midwest", alt: 1772, desc: "Missouri highpoint" },
      "MW_MINGO_SWAMP": { name: "Mingo National Wildlife Refuge", lat: 36.9667, lon: -90.1667, type: "natural", region: "midwest", alt: 350, desc: "Swamp boardwalk" },
      "MW_OZARK_TRAIL": { name: "Ozark Trail", lat: 37.5000, lon: -90.7500, type: "natural", region: "midwest", alt: 1200, desc: "Hiking trail" },
      "MW_CURRENT_RIVER": { name: "Current River", lat: 37.1333, lon: -91.3500, type: "natural", region: "midwest", alt: 600, desc: "Float trip" },
      "MW_ELEVEN_POINT": { name: "Eleven Point River", lat: 36.6333, lon: -91.3000, type: "natural", region: "midwest", alt: 500, desc: "Wild and Scenic" },
      "MW_OZARK_NSR": { name: "Ozark National Scenic Riverways", lat: 37.1500, lon: -91.3333, type: "natural", region: "midwest", alt: 600, desc: "First national river" },
      "MW_MARK_TWAIN_CAVE": { name: "Mark Twain Cave", lat: 39.6833, lon: -91.3833, type: "natural", region: "midwest", alt: 600, desc: "Tom Sawyer cave" },
      "MW_HANNIBAL": { name: "Hannibal", lat: 39.7083, lon: -91.3583, type: "landmark", region: "midwest", alt: 500, desc: "Mark Twain hometown" },
      "MW_PERE_MARQUETTE": { name: "Pere Marquette State Park", lat: 38.9667, lon: -90.5333, type: "natural", region: "midwest", alt: 600, desc: "River bluffs" },
      "MW_GRAFTON": { name: "Grafton", lat: 38.9686, lon: -90.4314, type: "landmark", region: "midwest", alt: 450, desc: "Great River Road" },
      "MW_PIASA_BIRD": { name: "Piasa Bird", lat: 38.9500, lon: -90.4167, type: "landmark", region: "midwest", alt: 500, desc: "Cliff painting" },
      "MW_LEWIS_CLARK": { name: "Lewis and Clark Confluence", lat: 38.8831, lon: -90.1206, type: "landmark", region: "midwest", alt: 430, desc: "Rivers meet" },
      "MW_SPRING_MILL": { name: "Spring Mill State Park", lat: 38.7333, lon: -86.4167, type: "natural", region: "midwest", alt: 700, desc: "Pioneer village" },
      "MW_TURKEY_RUN": { name: "Turkey Run State Park", lat: 39.8833, lon: -87.2167, type: "natural", region: "midwest", alt: 700, desc: "Sandstone canyons" },
      "MW_MCCORMICKS_CREEK": { name: "McCormick's Creek", lat: 39.2833, lon: -86.7333, type: "natural", region: "midwest", alt: 700, desc: "First IN state park" },
      "MW_BROWN_COUNTY": { name: "Brown County State Park", lat: 39.1167, lon: -86.2333, type: "natural", region: "midwest", alt: 1000, desc: "Fall colors" },
      "MW_CLIFTY_FALLS": { name: "Clifty Falls", lat: 38.7833, lon: -85.4333, type: "waterfall", region: "midwest", alt: 700, desc: "Indiana falls" },
      "MW_CATARACT_FALLS": { name: "Cataract Falls", lat: 39.4500, lon: -86.8167, type: "waterfall", region: "midwest", alt: 700, desc: "Largest IN waterfall" },
      "MW_CONNER_PRAIRIE": { name: "Conner Prairie", lat: 39.9833, lon: -86.0167, type: "landmark", region: "midwest", alt: 850, desc: "Living history" },
      "MW_AMISH_COUNTRY_IN": { name: "Shipshewana", lat: 41.6722, lon: -85.5772, type: "landmark", region: "midwest", alt: 900, desc: "Amish country" },
      "MW_AMANA_COLONIES": { name: "Amana Colonies", lat: 41.8000, lon: -91.8667, type: "landmark", region: "midwest", alt: 900, desc: "German heritage" },
      "MW_FIELD_OF_DREAMS": { name: "Field of Dreams", lat: 42.4750, lon: -91.0403, type: "landmark", region: "midwest", alt: 1000, desc: "Movie site" },
      "MW_EFFIGY_MOUNDS": { name: "Effigy Mounds", lat: 43.0861, lon: -91.1897, type: "natural", region: "midwest", alt: 1200, desc: "Ancient earthworks" },
      "MW_PIKES_PEAK_IA": { name: "Pikes Peak State Park", lat: 43.0167, lon: -91.1500, type: "natural", region: "midwest", alt: 1100, desc: "Mississippi view" },
      "MW_MAQUOKETA_CAVES": { name: "Maquoketa Caves", lat: 42.0833, lon: -90.8333, type: "natural", region: "midwest", alt: 1000, desc: "Iowa caves" },
      "MW_LOESS_HILLS": { name: "Loess Hills", lat: 41.5500, lon: -95.8500, type: "natural", region: "midwest", alt: 1300, desc: "Rare landform" },
      "MW_KANSAS_CITY_ZOO": { name: "Kansas City Zoo", lat: 39.0081, lon: -94.4719, type: "landmark", region: "midwest", alt: 900, desc: "Swope Park" },
      "MW_NELSON_ATKINS": { name: "Nelson-Atkins Museum", lat: 39.0453, lon: -94.5808, type: "landmark", region: "midwest", alt: 1000, desc: "Shuttlecocks" },
      "MW_UNION_STATION_KC": { name: "Union Station KC", lat: 39.0858, lon: -94.5867, type: "landmark", region: "midwest", alt: 850, desc: "Historic station" },
      "MW_LIBERTY_MEMORIAL": { name: "Liberty Memorial", lat: 39.0811, lon: -94.5856, type: "monument", region: "midwest", alt: 900, desc: "WWI Museum" },
      "MW_BRANSON": { name: "Branson", lat: 36.6436, lon: -93.2186, type: "landmark", region: "midwest", alt: 900, desc: "Entertainment" },
      "MW_TABLE_ROCK_LAKE": { name: "Table Rock Lake", lat: 36.5833, lon: -93.3167, type: "lake", region: "midwest", alt: 900, desc: "Ozark lake" }
    };

    // Contract pilot hourly rates by aircraft category
    const CONTRACT_PILOT_RATES = {
      single_piston: { min: 50, max: 75, typical: 60 },
      single_piston_hp: { min: 60, max: 90, typical: 75 },
      bush: { min: 65, max: 100, typical: 80 },
      multi_piston: { min: 75, max: 125, typical: 100 },
      turboprop: { min: 150, max: 250, typical: 200 },
      light_jet: { min: 250, max: 400, typical: 325 },
      airliner: { min: 400, max: 600, typical: 500 },
      helicopter: { min: 100, max: 200, typical: 150 },
      amphibious: { min: 80, max: 120, typical: 100 },
      aerobatic: { min: 75, max: 125, typical: 100 },
      warbird: { min: 150, max: 300, typical: 225 },
      military_cargo: { min: 400, max: 600, typical: 500 },
      military_fighter: { min: 500, max: 800, typical: 650 },
      specialty: { min: 60, max: 100, typical: 80 }
    };
    
    // Client personality traits - each client gets 1-3 non-contradicting traits
    const CLIENT_PERSONALITY_TRAITS = {
      // Price-focused traits (pick at most one)
      price: {
        'budget-conscious': { 
          label: 'Budget-conscious',
          description: 'Wants lowest price, rarely accepts above market',
          acceptanceModifier: -10,  // Percentage points off market rate tolerance
          counterChance: 0.6
        },
        'value-seeker': { 
          label: 'Value-seeker',
          description: 'Looks for good deals, will counter aggressively',
          acceptanceModifier: -5,
          counterChance: 0.8
        },
        'price-flexible': { 
          label: 'Price-flexible',
          description: 'Less concerned about cost, focuses on availability',
          acceptanceModifier: +10,
          counterChance: 0.3
        },
        'penny-pincher': { 
          label: 'Penny-pincher',
          description: 'Extremely cost-focused, will reject anything above market',
          acceptanceModifier: -15,
          counterChance: 0.4
        },
        'premium-payer': { 
          label: 'Premium-payer',
          description: 'Willing to pay above market for reliability/reputation',
          acceptanceModifier: +15,
          counterChance: 0.2
        }
      },
      // Negotiation style traits (pick at most one)
      negotiation: {
        'decisive': { 
          label: 'Decisive',
          description: 'Quick yes/no, rarely counters',
          counterChance: 0.1,
          responseDelay: 0  // Hours
        },
        'negotiator': { 
          label: 'Negotiator',
          description: 'Almost always counters first',
          counterChance: 0.9,
          responseDelay: 2
        },
        'deliberate': { 
          label: 'Deliberate',
          description: 'Takes time to respond, may counter once',
          counterChance: 0.5,
          responseDelay: 6
        },
        'haggler': { 
          label: 'Haggler',
          description: 'Will counter multiple times, pushes hard',
          counterChance: 0.95,
          counterRounds: 3,
          responseDelay: 1
        },
        'take-it-or-leave-it': { 
          label: 'Take-it-or-leave-it',
          description: 'Makes one offer, won\'t negotiate further',
          counterChance: 0,
          responseDelay: 0
        },
        'agreeable': { 
          label: 'Agreeable',
          description: 'Tends to accept reasonable bids without fuss',
          counterChance: 0.2,
          acceptanceModifier: +5,
          responseDelay: 1
        }
      },
      // Relationship traits (pick at most one)
      relationship: {
        'loyal': { 
          label: 'Loyal',
          description: 'Repeat customer bonus, prefers operators they\'ve used',
          repeatBonus: 0.1,  // 10% more likely to accept from repeat operator
          acceptanceModifier: +5
        },
        'new-client': { 
          label: 'New client',
          description: 'First time, no history to draw on',
          repeatBonus: 0,
          acceptanceModifier: 0
        },
        'demanding': { 
          label: 'Demanding',
          description: 'Expects premium service, complaints if anything goes wrong',
          reviewSensitivity: 1.5,  // More likely to leave negative review
          acceptanceModifier: -5
        },
        'easy-going': { 
          label: 'Easy-going',
          description: 'Flexible, forgiving of minor issues',
          reviewSensitivity: 0.5,
          acceptanceModifier: +5
        },
        'corporate': { 
          label: 'Corporate',
          description: 'Formal process, may have procurement rules',
          counterChance: 0.6,
          responseDelay: 4
        },
        'referral-driven': { 
          label: 'Referral-driven',
          description: 'Came via word of mouth, reputation matters more',
          reputationWeight: 1.5,
          acceptanceModifier: 0
        }
      }
    };
    
    // Generate random client traits (1-3, non-contradicting)
    function generateClientTraits() {
      const traits = [];
      const categories = ['price', 'negotiation', 'relationship'];
      
      // Randomly decide how many traits (1-3)
      const numTraits = Math.random() < 0.3 ? 1 : (Math.random() < 0.6 ? 2 : 3);
      
      // Shuffle categories and pick traits
      const shuffled = categories.sort(() => Math.random() - 0.5);
      
      for (let i = 0; i < numTraits && i < shuffled.length; i++) {
        const category = shuffled[i];
        const categoryTraits = Object.keys(CLIENT_PERSONALITY_TRAITS[category]);
        const trait = categoryTraits[Math.floor(Math.random() * categoryTraits.length)];
        traits.push(trait);
      }
      
      return traits;
    }
    
    // Get combined trait modifiers for a client
    function getTraitModifiers(traits) {
      const modifiers = {
        acceptanceModifier: 0,
        counterChance: 0.5,  // Default 50%
        responseDelay: 1,
        repeatBonus: 0,
        reviewSensitivity: 1,
        reputationWeight: 1
      };
      
      let counterChanceSet = false;
      
      for (const traitKey of traits) {
        // Find trait in categories
        for (const category of Object.values(CLIENT_PERSONALITY_TRAITS)) {
          if (category[traitKey]) {
            const trait = category[traitKey];
            if (trait.acceptanceModifier) modifiers.acceptanceModifier += trait.acceptanceModifier;
            if (trait.counterChance !== undefined && !counterChanceSet) {
              modifiers.counterChance = trait.counterChance;
              counterChanceSet = true;
            }
            if (trait.responseDelay !== undefined) modifiers.responseDelay = Math.max(modifiers.responseDelay, trait.responseDelay);
            if (trait.repeatBonus) modifiers.repeatBonus += trait.repeatBonus;
            if (trait.reviewSensitivity) modifiers.reviewSensitivity = trait.reviewSensitivity;
            if (trait.reputationWeight) modifiers.reputationWeight = trait.reputationWeight;
            break;
          }
        }
      }
      
      return modifiers;
    }
    
    // Get trait display info
    function getTraitDisplay(traitKey) {
      for (const category of Object.values(CLIENT_PERSONALITY_TRAITS)) {
        if (category[traitKey]) {
          return category[traitKey];
        }
      }
      return { label: traitKey, description: '' };
    }

    const CLIENTS = {
      companies: {
        "APEX_LOGISTICS": { name: "Apex Logistics", tier: "corporate", missions: ["General Cargo", "Freight Haul", "Part 135 On-Demand"], payModifier: 1.15 },
        "SUMMIT_MEDICAL": { name: "Summit Medical Transport", tier: "corporate", missions: ["Medical Transfer", "Organ Transport", "Air Ambulance", "CASEVAC"], payModifier: 1.25 },
        "COASTAL_AIR": { name: "Coastal Air Charters", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Island Hopping"], payModifier: 1.0 },
        "RIDGELINE_AVIATION": { name: "Ridgeline Aviation", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "Medical Transfer"], payModifier: 1.05 },
        "EXECUTIVE_WINGS": { name: "Executive Wings", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.3 },
        "HEARTLAND_CARGO": { name: "Heartland Cargo Services", tier: "regional", missions: ["General Cargo", "Mail Run", "Part 135 On-Demand"], payModifier: 0.95 },
        "PACIFIC_SEAPLANES": { name: "Pacific Seaplanes", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Island Hopping", "Bush Resupply"], payModifier: 1.1 },
        "MOUNTAIN_RESCUE": { name: "Mountain Rescue Operations", tier: "corporate", missions: ["Heli SAR", "Heli EMS", "Search Support", "CASEVAC"], payModifier: 1.2 },
        "SKYVIEW_SURVEYS": { name: "Skyview Aerial Surveys", tier: "regional", missions: ["Aerial Survey", "Aerial Photography"], payModifier: 1.0 },
        "NORTHERN_EXPRESS": { name: "Northern Express Air", tier: "regional", missions: ["Charter Flight", "General Cargo", "Mail Run", "Bush Resupply"], payModifier: 0.95 },
        "LIFEFLIGHT": { name: "LifeFlight Medical Services", tier: "corporate", missions: ["Heli EMS", "Air Ambulance", "Medical Transfer", "Organ Transport"], payModifier: 1.3 },
        "HORIZON_TOURS": { name: "Horizon Tours & Charters", tier: "regional", missions: ["Sightseeing Tour", "Discovery Flight", "Heli Tour"], payModifier: 0.9 },
        "SWIFT_FREIGHT": { name: "Swift Freight Solutions", tier: "corporate", missions: ["Freight Haul", "General Cargo", "Hazmat Transport"], payModifier: 1.15 },
        "ISLAND_HOPPERS": { name: "Island Hoppers Aviation", tier: "regional", missions: ["Island Hopping", "Charter Flight", "Sightseeing Tour"], payModifier: 1.0 },
        "PRECISION_AIR": { name: "Precision Air Surveys", tier: "corporate", missions: ["Aerial Survey", "Aerial Photography"], payModifier: 1.2 },
        "BACKCOUNTRY_FLIGHT": { name: "Backcountry Flight Services", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "Humanitarian"], payModifier: 1.0 },
        "CORPORATE_JET": { name: "Corporate Jet Services", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.35 },
        "MERCY_FLIGHTS": { name: "Mercy Flights International", tier: "corporate", missions: ["Humanitarian", "Medical Transfer", "CASEVAC"], payModifier: 1.1 },
        "AIRWAYS_EXPRESS": { name: "Airways Express Cargo", tier: "regional", missions: ["General Cargo", "Mail Run", "Part 135 On-Demand"], payModifier: 0.95 },
        "ROTORWING_OPS": { name: "Rotorwing Operations", tier: "regional", missions: ["Heli Charter", "Heli Tour"], payModifier: 1.05 },
        "BLUE_SKY_AVIATION": { name: "Blue Sky Aviation", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Training Flight"], payModifier: 0.9 },
        "PRIORITY_MEDICAL": { name: "Priority Medical Transport", tier: "corporate", missions: ["Medical Transfer", "Organ Transport", "Air Ambulance"], payModifier: 1.25 },
        "FRONTIER_AIR": { name: "Frontier Air Services", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "General Cargo"], payModifier: 1.0 },
        "AEROPHOTO_INC": { name: "AeroPhoto Inc", tier: "corporate", missions: ["Aerial Photography", "Aerial Survey"], payModifier: 1.15 },
        "LAKELAND_AIR": { name: "Lakeland Air Service", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Island Hopping"], payModifier: 0.95 },
        "JETSTREAM_EXEC": { name: "Jetstream Executive", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.4 },
        "WILDERNESS_WINGS": { name: "Wilderness Wings", tier: "regional", missions: ["Bush Resupply", "Humanitarian", "Search Support"], payModifier: 1.05 },
        "RAPID_RESPONSE": { name: "Rapid Response Aviation", tier: "corporate", missions: ["Heli EMS", "Heli SAR", "CASEVAC", "Medical Transfer"], payModifier: 1.25 },
        "TRADEWIND_CARGO": { name: "Tradewind Cargo", tier: "regional", missions: ["General Cargo", "Freight Haul", "Mail Run"], payModifier: 0.95 },
        "SCENIC_FLIGHTS": { name: "Scenic Flights Ltd", tier: "regional", missions: ["Sightseeing Tour", "Discovery Flight", "Heli Tour"], payModifier: 0.85 },
        "GLOBALMED_AIR": { name: "GlobalMed Air Transport", tier: "corporate", missions: ["Medical Transfer", "Organ Transport", "Air Ambulance", "Humanitarian"], payModifier: 1.3 },
        "TUNDRA_AIR": { name: "Tundra Air", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "General Cargo"], payModifier: 1.0 },
        "EXECUTIVE_FLIGHT": { name: "Executive Flight Group", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.35 },
        "NORTHWEST_CARGO": { name: "Northwest Cargo Lines", tier: "regional", missions: ["General Cargo", "Freight Haul", "Mail Run"], payModifier: 0.95 },
        "ALPINE_RESCUE": { name: "Alpine Rescue Aviation", tier: "corporate", missions: ["Heli SAR", "Heli EMS", "Search Support"], payModifier: 1.2 },
        "BAYSHORE_AIR": { name: "Bayshore Air", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Island Hopping"], payModifier: 0.95 },
        "EAGLE_EYE_SURVEYS": { name: "Eagle Eye Surveys", tier: "regional", missions: ["Aerial Survey", "Aerial Photography"], payModifier: 1.0 },
        "METRO_MEDEVAC": { name: "Metro Medevac", tier: "corporate", missions: ["Heli EMS", "Air Ambulance", "Medical Transfer"], payModifier: 1.25 },
        "PIONEER_AIR": { name: "Pioneer Air Services", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "Humanitarian"], payModifier: 1.0 },
        "SILVERLINE_JETS": { name: "Silverline Jets", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.4 },
        "VALLEY_CARGO": { name: "Valley Cargo Express", tier: "regional", missions: ["General Cargo", "Mail Run", "Part 135 On-Demand"], payModifier: 0.9 },
        "ADVENTURE_AIR": { name: "Adventure Air Tours", tier: "regional", missions: ["Sightseeing Tour", "Thrill Flight", "Discovery Flight"], payModifier: 0.9 },
        "MEDSTAR": { name: "MedStar Aviation", tier: "corporate", missions: ["Air Ambulance", "Medical Transfer", "Organ Transport"], payModifier: 1.25 },
        "OUTBACK_AIR": { name: "Outback Air", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "General Cargo"], payModifier: 1.0 },
        "PRESTIGE_AVIATION": { name: "Prestige Aviation", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.35 },
        "RANGE_LOGISTICS": { name: "Range Logistics", tier: "regional", missions: ["General Cargo", "Freight Haul"], payModifier: 0.95 },
        "SKY_SAFARI": { name: "Sky Safari Tours", tier: "regional", missions: ["Sightseeing Tour", "Heli Tour", "Discovery Flight"], payModifier: 0.9 },
        "TRAUMA_HAWK": { name: "Trauma Hawk EMS", tier: "corporate", missions: ["Heli EMS", "CASEVAC", "Medical Transfer"], payModifier: 1.3 },
        "BUSH_PILOTS": { name: "Bush Pilots Inc", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "Search Support"], payModifier: 1.05 },
        "CHARTER_ONE": { name: "Charter One Aviation", tier: "regional", missions: ["Charter Flight", "Executive Transport"], payModifier: 1.05 },
        "DELTA_CARGO": { name: "Delta Regional Cargo", tier: "regional", missions: ["General Cargo", "Mail Run", "Part 135 On-Demand"], payModifier: 0.9 },
        "EVERGREEN_HELI": { name: "Evergreen Helicopter Services", tier: "regional", missions: ["Heli Charter", "Heli Tour"], payModifier: 1.05 },
        "FLYING_DOCTORS": { name: "Flying Doctors Service", tier: "corporate", missions: ["Medical Transfer", "Air Ambulance", "Humanitarian"], payModifier: 1.2 },
        "GATEWAY_AIR": { name: "Gateway Air Services", tier: "regional", missions: ["Charter Flight", "General Cargo", "Mail Run"], payModifier: 0.95 },
        "HIGH_COUNTRY": { name: "High Country Aviation", tier: "regional", missions: ["Bush Resupply", "Charter Flight", "Sightseeing Tour"], payModifier: 1.0 },
        "INTERNATIONAL_EXEC": { name: "International Executive Air", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.4 },
        "JUNGLE_AIR": { name: "Jungle Air Logistics", tier: "regional", missions: ["Bush Resupply", "Humanitarian", "General Cargo"], payModifier: 1.05 },
        "KESTREL_SURVEYS": { name: "Kestrel Aerial Surveys", tier: "regional", missions: ["Aerial Survey", "Aerial Photography"], payModifier: 1.0 },
        "LIFEGUARD_AIR": { name: "Lifeguard Air Ambulance", tier: "corporate", missions: ["Air Ambulance", "Medical Transfer", "Heli EMS"], payModifier: 1.25 },
        "MAVERICK_CARGO": { name: "Maverick Cargo", tier: "regional", missions: ["General Cargo", "Freight Haul", "Part 135 On-Demand"], payModifier: 0.95 },
        "NOMAD_AIR": { name: "Nomad Air", tier: "regional", missions: ["Charter Flight", "Bush Resupply", "Island Hopping"], payModifier: 1.0 },
        "OMEGA_FLIGHT": { name: "Omega Flight Services", tier: "corporate", missions: ["Executive Transport", "Charter Flight", "Medical Transfer"], payModifier: 1.25 },
        "POLAR_EXPRESS": { name: "Polar Express Aviation", tier: "regional", missions: ["Bush Resupply", "General Cargo", "Humanitarian"], payModifier: 1.05 },
        "QUICKSILVER_AIR": { name: "Quicksilver Air", tier: "regional", missions: ["Charter Flight", "Part 135 On-Demand", "Mail Run"], payModifier: 1.0 },
        "RESCUE_ONE": { name: "Rescue One Aviation", tier: "corporate", missions: ["Heli SAR", "Heli EMS", "Search Support", "CASEVAC"], payModifier: 1.25 },
        "SUNBELT_CARGO": { name: "Sunbelt Cargo Services", tier: "regional", missions: ["General Cargo", "Freight Haul", "Mail Run"], payModifier: 0.9 },
        "THUNDERBIRD_AIR": { name: "Thunderbird Air", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Training Flight"], payModifier: 0.9 },
        "UNITED_MEDEVAC": { name: "United Medevac", tier: "corporate", missions: ["Medical Transfer", "Air Ambulance", "Organ Transport"], payModifier: 1.3 },
        "VANGUARD_AIR": { name: "Vanguard Air Charter", tier: "regional", missions: ["Charter Flight", "Executive Transport"], payModifier: 1.1 },
        "WESTWIND_CARGO": { name: "Westwind Cargo", tier: "regional", missions: ["General Cargo", "Freight Haul", "Mail Run"], payModifier: 0.95 },
        "XTREME_AIR": { name: "Xtreme Air Adventures", tier: "regional", missions: ["Thrill Flight", "Airshow Rides", "Discovery Flight"], payModifier: 0.95 },
        "YELLOWSTONE_AIR": { name: "Yellowstone Air Service", tier: "regional", missions: ["Charter Flight", "Sightseeing Tour", "Bush Resupply"], payModifier: 1.0 },
        "ZENITH_JETS": { name: "Zenith Private Jets", tier: "corporate", missions: ["Executive Transport", "Charter Flight"], payModifier: 1.45 },
        "AIRBORNE_IMAGING": { name: "Airborne Imaging Solutions", tier: "corporate", missions: ["Aerial Photography", "Aerial Survey"], payModifier: 1.2 },
        "BRISTOW_OFFSHORE": { name: "Bristow Offshore Services", tier: "corporate", missions: ["Heli Charter"], payModifier: 1.3 },
        "CAPE_AIR_CARGO": { name: "Cape Air Cargo", tier: "regional", missions: ["General Cargo", "Mail Run", "Island Hopping"], payModifier: 0.95 },
        "DISCOVERY_TOURS": { name: "Discovery Aviation Tours", tier: "regional", missions: ["Discovery Flight", "Sightseeing Tour", "Heli Tour"], payModifier: 0.85 },
        "ERA_HELICOPTERS": { name: "Era Helicopters", tier: "corporate", missions: ["Heli Charter", "Heli EMS"], payModifier: 1.2 },
        "FLIGHT_FOR_LIFE": { name: "Flight For Life", tier: "corporate", missions: ["Heli EMS", "Air Ambulance", "Medical Transfer"], payModifier: 1.3 },
        "GREAT_LAKES_AIR": { name: "Great Lakes Air", tier: "regional", missions: ["Charter Flight", "Island Hopping", "General Cargo"], payModifier: 0.95 },
        "HERITAGE_FLIGHTS": { name: "Heritage Flight Foundation", tier: "regional", missions: ["Historical Flight", "Airshow Aerobatics", "Airshow Rides"], payModifier: 1.1 },
        "INSIGHT_AERIAL": { name: "Insight Aerial Services", tier: "regional", missions: ["Aerial Survey", "Aerial Photography"], payModifier: 1.05 }
      },
      firstNames: [
        "James", "Michael", "Robert", "David", "William", "Richard", "Joseph", "Thomas", "Christopher", "Charles",
        "Daniel", "Matthew", "Anthony", "Mark", "Donald", "Steven", "Paul", "Andrew", "Joshua", "Kenneth",
        "Kevin", "Brian", "George", "Timothy", "Ronald", "Edward", "Jason", "Jeffrey", "Ryan", "Jacob",
        "Gary", "Nicholas", "Eric", "Jonathan", "Stephen", "Larry", "Justin", "Scott", "Brandon", "Benjamin",
        "Samuel", "Raymond", "Gregory", "Frank", "Alexander", "Patrick", "Jack", "Dennis", "Jerry", "Tyler",
        "Mary", "Patricia", "Jennifer", "Linda", "Barbara", "Elizabeth", "Susan", "Jessica", "Sarah", "Karen",
        "Lisa", "Nancy", "Betty", "Margaret", "Sandra", "Ashley", "Kimberly", "Emily", "Donna", "Michelle",
        "Dorothy", "Carol", "Amanda", "Melissa", "Deborah", "Stephanie", "Rebecca", "Sharon", "Laura", "Cynthia",
        "Kathleen", "Amy", "Angela", "Shirley", "Anna", "Brenda", "Pamela", "Emma", "Nicole", "Helen",
        "Samantha", "Katherine", "Christine", "Debra", "Rachel", "Carolyn", "Janet", "Catherine", "Maria", "Heather"
      ],
      lastNames: [
        "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez",
        "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin",
        "Lee", "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson",
        "Walker", "Young", "Allen", "King", "Wright", "Scott", "Torres", "Nguyen", "Hill", "Flores",
        "Green", "Adams", "Nelson", "Baker", "Hall", "Rivera", "Campbell", "Mitchell", "Carter", "Roberts",
        "Gomez", "Phillips", "Evans", "Turner", "Diaz", "Parker", "Cruz", "Edwards", "Collins", "Reyes",
        "Stewart", "Morris", "Morales", "Murphy", "Cook", "Rogers", "Gutierrez", "Ortiz", "Morgan", "Cooper",
        "Peterson", "Bailey", "Reed", "Kelly", "Howard", "Ramos", "Kim", "Cox", "Ward", "Richardson",
        "Watson", "Brooks", "Chavez", "Wood", "James", "Bennett", "Gray", "Mendoza", "Ruiz", "Hughes",
        "Price", "Alvarez", "Castillo", "Sanders", "Patel", "Myers", "Long", "Ross", "Foster", "Jimenez"
      ]
    };
    
    // Category to Mission mapping
    const CATEGORY_MISSIONS = {
      single_piston: ["Charter Flight", "Sightseeing Tour", "Discovery Flight", "Aerial Photography", "Aerial Survey", "Mail Run", "Training Flight", "Search Support", "Humanitarian", "Ferry Flight"],
      single_piston_hp: ["Charter Flight", "Executive Transport", "Sightseeing Tour", "Medical Transfer", "General Cargo", "Mail Run", "Aerial Photography", "Aerial Survey", "Search Support", "Humanitarian", "Ferry Flight"],
      bush: ["Bush Resupply", "Charter Flight", "Sightseeing Tour", "Medical Transfer", "Aerial Survey", "Island Hopping", "Search Support", "Humanitarian", "Ferry Flight"],
      multi_piston: ["Charter Flight", "Executive Transport", "Sightseeing Tour", "Medical Transfer", "General Cargo", "Mail Run", "Aerial Photography", "Training Flight", "Search Support", "Humanitarian", "Ferry Flight"],
      turboprop: ["Charter Flight", "Executive Transport", "Medical Transfer", "Air Ambulance", "CASEVAC", "General Cargo", "Freight Haul", "Part 135 On-Demand", "Search Support", "Humanitarian", "Ferry Flight"],
      light_jet: ["Charter Flight", "Executive Transport", "Medical Transfer", "Organ Transport", "Air Ambulance", "Part 135 On-Demand", "Ferry Flight"],
      airliner: ["Charter Flight", "Executive Transport", "General Cargo", "Freight Haul", "Hazmat Transport", "Humanitarian", "Ferry Flight"],
      military_cargo: ["General Cargo", "Freight Haul", "Humanitarian", "Ferry Flight"],
      military_fighter: ["Thrill Flight", "Airshow Aerobatics", "Airshow Rides", "Ferry Flight"],
      amphibious: ["Charter Flight", "Sightseeing Tour", "Island Hopping", "Bush Resupply", "Search Support", "Aerial Survey", "Humanitarian", "Ferry Flight"],
      aerobatic: ["Thrill Flight", "Airshow Aerobatics", "Airshow Rides", "Training Flight", "Ferry Flight"],
      warbird: ["Thrill Flight", "Airshow Aerobatics", "Airshow Rides", "Historical Flight", "Ferry Flight"],
      helicopter: ["Heli Tour", "Heli Charter", "Heli EMS", "Heli SAR", "Hospital Transfer", "Executive Shuttle", "Airport Connect", "Search Support", "Medical Transfer", "CASEVAC", "Aerial Photography", "Aerial Survey", "Ferry Flight"],
      specialty: ["Aerial Survey", "Aerial Photography", "Ferry Flight"]
    };
    
    // Get required rating for aircraft category
    // Check if pilot can certify on an aircraft (has required rating)
    function pilotCanCertifyAircraft(aircraftCode) {
      if (S.gameMode !== 'career') return true;
      
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return false;
      
      // Check category requirements
      const requirements = CATEGORY_REQUIREMENTS[aircraft.category];
      if (!requirements) return true;
      
      // Check required certificates (e.g., ATP for airliners)
      if (requirements.certificates && requirements.certificates.length > 0) {
        const hasRequiredCert = requirements.certificates.some(cert => 
          S.pilot.certificates.includes(cert)
        );
        if (!hasRequiredCert) return false;
      }
      
      // Check required ratings (e.g., turbine for jets)
      if (requirements.ratings && requirements.ratings.length > 0) {
        const hasRequiredRating = requirements.ratings.some(rating => 
          S.pilot.ratings.includes(rating)
        );
        if (!hasRequiredRating) return false;
      }
      
      return true;
    }
    
    // Get what the pilot is missing to certify on an aircraft
    function getMissingRequirements(aircraftCode) {
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return null;
      
      const requirements = CATEGORY_REQUIREMENTS[aircraft.category];
      if (!requirements) return null;
      
      const missing = { certificates: [], ratings: [] };
      
      if (requirements.certificates) {
        requirements.certificates.forEach(cert => {
          if (!S.pilot.certificates.includes(cert)) {
            missing.certificates.push(cert);
          }
        });
      }
      
      if (requirements.ratings) {
        requirements.ratings.forEach(rating => {
          if (!S.pilot.ratings.includes(rating)) {
            missing.ratings.push(rating);
          }
        });
      }
      
      return (missing.certificates.length > 0 || missing.ratings.length > 0) ? missing : null;
    }
    
    // Get the rating name for display
    function getRatingDisplayName(rating) {
      const names = {
        helicopter: 'Helicopter',
        turbine: 'Turbine',
        multiEngine: 'Multi-Engine',
        seaplane: 'Seaplane',
        instrument: 'Instrument',
        night: 'Night'
      };
      return names[rating] || rating;
    }
    
    // Get missions student pilots can do (only training)
    function getStudentMissions() {
      return ['Training Flight', 'Discovery Flight'];
    }
    
    // PPL holders without Commercial can only do expense-sharing missions
    function getPPLOnlyMissions() {
      return ['Discovery Flight', 'Sightseeing Tour', 'Aerial Photography', 'Ferry Flight'];
    }
    
    // Check if pilot has full commercial privileges
    function hasCommercialPrivileges() {
      if (S.gameMode !== 'career') return true;
      return S.pilot.certificates.includes('commercial') || S.pilot.certificates.includes('atp');
    }
    
    // Check if pilot can fly in given conditions
    const DEFAULT_STATE = {
      version: "0.5.07",
      
      // === GAME SETTINGS ===
      gameMode: "career", // "career" or "sandbox"
      tutorialComplete: false, // Tutorial flow: Welcome â†’ Discovery Flight â†’ PPL Checkride
      difficultySettings: {
        reviewFrequency: "normal",    // "low", "normal", "high"
        ratingSensitivity: "normal",  // "forgiving", "normal", "harsh"
        ratingRecovery: "normal",     // "slow", "normal", "fast"
        hourRequirements: "normal",   // "realistic", "normal", "reduced"
        missionThresholds: "normal",  // "high", "normal", "low"
        checkrideDifficulty: "normal", // "strict", "normal", "lenient"
        ownedMissionRatio: 0.6,       // 0.0 to 1.0, ratio of owned vs contract missions
        emailsPerDay: 3,              // 1-10, average emails per day
        fixedPriceMode: false,        // If true, inquiries show fixed market rate instead of bid calculator
        // Financial multipliers (0.25 to 2.0, default 1.0)
        ownedRevenueMultiplier: 1.0,      // Revenue from flights on your aircraft
        contractRevenueMultiplier: 1.0,   // Revenue from contract pilot jobs
        fuelCostMultiplier: 1.0,          // Fuel prices at pump
        operatingCostMultiplier: 1.0,     // Maintenance/operating costs
        interestRateMultiplier: 1.0,      // LOC and loan APR
        insuranceCostMultiplier: 1.0,     // Insurance premiums
        // Maintenance multipliers (0.25 to 2.0, default 1.0)
        mxCostMultiplier: 1.0,            // Inspection, overhaul, repair costs
        squawkFrequencyMultiplier: 1.0,   // Chance of pre-flight squawks
        conditionDegradationMultiplier: 1.0  // How fast condition drops
      },
      autoSaveFrequency: "weekly", // "off", "weekly", "monthly"
      lastAutoSave: null, // { year, month, day } of last auto-save
      
      // === TIME & LOCATION ===
      gameTime: { year: 2025, month: 5, day: 1, hour: 8, minute: 0 },
      bases: {
        primary: null,  // ICAO code of primary base
        list: []        // Array of base objects: { id, icao, name, established, hangars, mxFacility, fuelStorage }
      },
      
      // === FINANCES ===
      cash: 25000,
      maintenanceReserve: 0,
      mxReserveRate: 15, // Percentage of flight revenue going to MX reserve (0-30%)
      cashWarningsSent: { ten: false, five: false, one: false }, // Track which warnings sent
      lineOfCredit: {
        balance: 0,
        limit: 25000,
        apr: 0.06,              // 6% APR (0.5% monthly)
        minPaymentPct: 0.05,    // 5% minimum payment
        lastInterestDate: null,
        missedPayments: 0
      },
      ownerCompensation: {
        monthlySalary: 4000,
        nextDrawDate: null,     // Set on first month rollover
        ytdDraws: 0,
        allTimeDraws: 0         // Cumulative draws (never resets)
      },
      insurance: {
        currentPremium: 0,      // This month's premium (charged on 1st)
        lastPremiumDate: null,  // Last month premium was charged
        incidentFreeMonths: 0,  // Consecutive months without damage reports
        lastMonthHours: 0,      // Flight hours from previous month (for premium calc)
        lastMonthMissionRisk: 1.0  // Avg mission risk from previous month
      },
      transactions: [],         // { id, date, type, description, amount, balanceAfter, category }
      financials: {
        startingCapital: 0,     // Initial owner investment (set on game start)
        retainedEarnings: 0,    // Calculated: revenueAllTime - expensesAllTime
        basesPropertyValue: 0,  // Placeholder for future
        revenueThisMonth: 0,
        expensesThisMonth: 0,
        revenueYTD: 0,
        expensesYTD: 0,
        revenueAllTime: 0,
        expensesAllTime: 0,
        lastMonthReset: null
      },
      lenderAssessment: {
        tier: 'startup',        // startup, developing, established, strong, premier
        monthsInBusiness: 0,
        onTimePayments: 0,
        missedPayments: 0,
        lastCalculated: null,
        // Cached metrics (updated monthly)
        dscr: 0,                // Debt Service Coverage Ratio
        leverageRatio: 0,       // Total debt / total equity
        cashReserveMonths: 0    // Cash / monthly expenses
      },
      loans: [],                // Aircraft loans
      leases: [],               // Aircraft leases
      
      // === FLEET ===
      fleet: ["C172_SKYHAWK"],
      fleetData: {
        "C172_SKYHAWK": {
          direct_ops: 4, 
          currentFuel: 53, 
          condition: 100, 
          location: null,  // ICAO or null for home base
          hours: 0,
          year: 2020,
          bookValue: null,
          registration: null,
          // MX tracking fields
          hoursSinceInspection: 0,
          hoursSinceOverhaul: 0,
          hoursSinceMajorService: 0,
          lastInspectionDate: null,
          mxStatus: 'airworthy',  // 'airworthy', 'needs_attention', 'grounded'
          scheduledMx: null,      // { type, startDate, completionDate, cost }
          squawks: []             // Active squawks
        }
      },
      parkedAircraft: {}, // { aircraftCode: { location: 'ICAO', parkedSince: gameTime, dailyCost: 25 } }
      
      // === AIRCRAFT MARKET ===
      marketListings: [],           // Array of listing objects
      marketLastRefresh: null,      // ISO date of last refresh
      loans: [],                    // Active financing agreements
      leases: [],                   // Active lease agreements
      brokerRequest: null,          // { aircraftCode, requestedAt: gameTime, eta: gameTime, feePaid }
      
      // === MISSION PREFERENCES ===
      missionPreferences: {}, // { 'Sightseeing Tour': true, 'Charter Flight': false } - empty = all enabled
      gameSettings: {
        allowCustomMissions: true
      },
      
      // === AIRCRAFT SETTINGS ===
      hiddenAircraft: [], // Aircraft codes hidden from certifications/generation
      customAircraft: {}, // User-defined aircraft: { CODE: { name, category, ... } }
      
      // === PILOT PROFILE ===
      pilot: {
        name: "Pilot",
        certificates: ["student"],  // "student", "private", "commercial", "atp"
        ratings: [],  // "night", "instrument", "multiEngine", "helicopter", "seaplane", "turbine"
        aircraftCertifications: ["C172_SKYHAWK"],  // Aircraft player is certified to fly
        hoursByCategory: {
          night: 0,
          instrument: 0,
          multiEngine: 0,
          helicopter: 0,
          seaplane: 0,
          turbine: 0
        },
        missionsCompleted: 0,
        missionsPerfect: 0,
        experiencePoints: 0,         // Hidden XP for tier progression
        experienceTier: "rookie",    // "rookie", "novice", "journeyman", "professional", "veteran", "master"
        firstTimeCompletions: {
          missionTypes: [],          // Track first-time mission type bonuses
          aircraftTypes: []          // Track first-time aircraft bonuses
        }
      },
      
      // === COMPANY ===
      companyName: null,  // Set when player names their business after PPL
      
      // === PUBLIC REPUTATION ===
      reputation: {
        stars: 0,           // 0 means no reviews yet, otherwise 1.0-5.0
        totalReviews: 0,
        recentRatings: [],  // Last 20 ratings for weighted average
        reviewLog: []       // Array of {id, date, stars, clientName, clientTier, missionType, route, comment}
      },
      
      // === CHECKRIDES ===
      checkrides: {
        scheduled: [],   // Upcoming checkrides
        completed: [],   // Passed checkrides
        failed: []       // Failed attempts
      },
      
      // === MISSIONS & EMAILS ===
      emails: [],
      archivedEmails: [],
      pendingEmails: [],
      lastEmailDay: null,
      scheduledFlights: [],
      
      // === FLIGHT TOTALS ===
      pilotLog: [],
      totalHoursFlown: 0,
      totalMilesFlown: 0,
      
      // === UI STATE ===
      activeContractId: null,
      flightStarted: false,
      selectedEmailId: null,
      calendarViewDate: null,
      
      // === STAFF ===
      staff: [],                    // Array of staff member objects
      staffMarketplace: [],         // Array of available candidates
      staffMarketplaceLastRefresh: null,  // { year, month, day } of last refresh
      staffMissions: [],            // Array of in-progress staff-flown missions
      staffTraining: [],            // Array of pilots currently in training
      payroll: {
        lastProcessed: null,        // { year, month } when payroll last ran
        totalMonthly: 0             // Cached total for display
      },
      supportStaff: {
        marketing: null,            // { name, salary, hiredDate } or null
        accountant: null            // { name, salary, hiredDate } or null
      }
    };

    let S = null;
    let dbReady = false;

    // === CERTIFICATION REQUIREMENTS (hours) ===
    // Simplified requirements for gameplay (not FAA realistic)
    const CERT_REQUIREMENTS = {
      private: { hoursTotal: 40 },
      commercial: { hoursTotal: 80, requires: ['private'] },
      atp: { hoursTotal: 300, requires: ['commercial', 'instrument'] },
      night: { hoursNight: 2 },
      instrument: { hoursTotal: 25, hoursInstrument: 20 },
      multiEngine: { hoursMulti: 5 },
      helicopter: { hoursHelo: 20 },
      seaplane: { hoursSeaplane: 5 },
      turbine: { hoursTotal: 50 }
    };

    // === EXPERIENCE TIER THRESHOLDS ===
    // Points-based system (hidden from player)
    const EXPERIENCE_TIERS = {
      rookie: { minPoints: 0, payMultiplier: 0.85 },
      novice: { minPoints: 25, payMultiplier: 0.95 },
      journeyman: { minPoints: 75, payMultiplier: 1.00 },
      professional: { minPoints: 200, payMultiplier: 1.25 },
      veteran: { minPoints: 400, payMultiplier: 1.75 },
      master: { minPoints: 750, payMultiplier: 2.00 }
    };
    
    // Mission tier requirements (which experience tier unlocks each mission tier)
    const MISSION_TIER_REQUIREMENTS = {
      rookie: ['Sightseeing Tour', 'Discovery Flight', 'Heli Tour', 'Training Flight', 'Thrill Flight', 'Aerial Photography'],
      novice: ['Aerial Survey', 'General Cargo', 'Mail Run', 'Charter Flight', 'Bush Resupply', 'Heli Charter'],
      journeyman: ['Freight Haul', 'Island Hopping', 'Ferry Flight', 'Historical Flight'],
      professional: ['Executive Transport', 'Medical Transfer', 'Search Support', 'Airshow Aerobatics', 'Airshow Rides', 'Humanitarian'],
      veteran: ['Air Ambulance', 'Organ Transport', 'CASEVAC', 'Heli EMS', 'Heli SAR'],
      master: ['Hazmat Transport', 'Part 135 On-Demand']
    };

    // === AIRCRAFT CATEGORY REQUIREMENTS ===
    // What certificates/ratings unlock each aircraft category
    const CATEGORY_REQUIREMENTS = {
      single_piston: { certificates: ['private'] },
      single_piston_hp: { certificates: ['private'], ratings: ['instrument'] },
      bush: { certificates: ['private'] },
      multi_piston: { certificates: ['private'], ratings: ['multiEngine'] },
      turboprop: { certificates: ['commercial'], ratings: ['turbine'] },
      light_jet: { certificates: ['commercial'], ratings: ['turbine'] },
      airliner: { certificates: ['atp'], ratings: ['turbine'] },
      military_cargo: { certificates: ['atp'], ratings: ['turbine'] },
      military_fighter: { certificates: ['commercial'], ratings: ['turbine'] },
      amphibious: { certificates: ['private'], ratings: ['seaplane'] },
      aerobatic: { certificates: ['private'] },
      warbird: { certificates: ['private'] },
      helicopter: { certificates: ['private'], ratings: ['helicopter'] },
      specialty: { certificates: ['private'] }
    };

    // === BASE SYSTEM CONSTANTS ===
    const BASE_ESTABLISHMENT_COST = 25000;
    
    const AIRCRAFT_SIZES = {
      small: { units: 1, name: 'Small' },      // Single piston, light helicopters
      medium: { units: 2, name: 'Medium' },    // Twin piston, turboprops, medium helicopters
      large: { units: 4, name: 'Large' },      // Light jets, large turboprops
      xlarge: { units: 6, name: 'Extra Large' } // Heavy jets, airliners
    };
    
    // Map aircraft category to hangar size
    const CATEGORY_TO_SIZE = {
      single_piston: 'small',
      single_piston_hp: 'small',
      bush: 'small',
      aerobatic: 'small',
      helicopter: 'small',       // Light helicopters
      multi_piston: 'medium',
      turboprop: 'medium',
      amphibious: 'medium',
      warbird: 'medium',
      specialty: 'medium',
      light_jet: 'large',
      military_fighter: 'large',
      airliner: 'xlarge',
      military_cargo: 'xlarge'
    };
    
    // Get aircraft size (units) for hangar capacity
    function getAircraftSize(aircraftCode) {
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return 1;
      const sizeKey = CATEGORY_TO_SIZE[aircraft.category] || 'small';
      return AIRCRAFT_SIZES[sizeKey]?.units || 1;
    }
    
    function getAircraftSizeName(aircraftCode) {
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return 'Small';
      const sizeKey = CATEGORY_TO_SIZE[aircraft.category] || 'small';
      return AIRCRAFT_SIZES[sizeKey]?.name || 'Small';
    }
    
    const HANGARS = {
      small: {
        name: 'Small Hangar',
        capacity: 4,
        buildCost: 50000,
        buildDays: 14,
        monthly: 500
      },
      medium: {
        name: 'Medium Hangar',
        capacity: 8,
        buildCost: 150000,
        buildDays: 30,
        monthly: 1200
      },
      large: {
        name: 'Large Hangar',
        capacity: 16,
        buildCost: 400000,
        buildDays: 60,
        monthly: 3000
      }
    };
    
    const HANGAR_MAX_PER_BASE = 3;
    const RAMP_DEGRADATION_MULTIPLIER = 2.0;
    
    const MX_FACILITIES = {
      stand: {
        name: 'MX Stand',
        buildCost: 12500,
        buildDays: 7,
        capabilities: ['squawk']
      },
      shop: {
        name: 'MX Shop',
        buildCost: 37500,
        buildDays: 21,
        capabilities: ['squawk', 'inspection']
      },
      center: {
        name: 'MX Center',
        buildCost: 100000,
        buildDays: 45,
        capabilities: ['squawk', 'inspection', 'overhaul']
      }
    };
    
    const MX_PARTS_ROOM = {
      buildCost: 12500,
      buildDays: 7,
      timeReduction: 0.20
    };
    
    const FUEL_STORAGE = {
      '100LL': {
        name: 'Avgas (100LL)',
        tiers: {
          small: { name: 'Small 100LL Tank', capacity: 1000, buildCost: 15000, buildDays: 7, monthly: 300, discount: 0.10 },
          medium: { name: 'Medium 100LL Tank', capacity: 5000, buildCost: 40000, buildDays: 14, monthly: 600, discount: 0.20 },
          large: { name: 'Large 100LL Tank', capacity: 10000, buildCost: 80000, buildDays: 21, monthly: 1000, discount: 0.30 }
        }
      },
      'JetA': {
        name: 'Jet-A',
        tiers: {
          small: { name: 'Small Jet-A Tank', capacity: 1000, buildCost: 15000, buildDays: 7, monthly: 300, discount: 0.10 },
          medium: { name: 'Medium Jet-A Tank', capacity: 5000, buildCost: 40000, buildDays: 14, monthly: 600, discount: 0.20 },
          large: { name: 'Large Jet-A Tank', capacity: 10000, buildCost: 80000, buildDays: 21, monthly: 1000, discount: 0.30 }
        }
      }
    };
    
    const FUEL_TANKS_MAX_PER_TYPE = 3;

    // === BASE SYSTEM FUNCTIONS ===
    
    // Create the primary base (called during game setup)
    function createPrimaryBase(icao) {
      const airport = getAirport(icao);
      const baseName = airport ? `${airport.name} Operations` : `${icao} Operations`;
      
      const base = {
        id: 'base_primary',
        icao: icao,
        name: baseName,
        isPrimary: true,
        established: { ...S.gameTime },
        hangars: [],
        rampAircraft: [],
        mxFacility: null,
        partsRoom: false,
        fuelStorage: {
          '100LL': [],
          'JetA': []
        },
        construction: []
      };
      
      return base;
    }
    
    // Establish a new base at an airport
    function establishBase(icao) {
      // Check if already have a base there
      if (S.bases.list.some(b => b.icao === icao)) {
        showToast('Base Exists', `You already have a base at ${icao}`, 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < BASE_ESTABLISHMENT_COST) {
        showToast('Insufficient Funds', `Need ${formatCurrency(BASE_ESTABLISHMENT_COST)} to establish a base`, 'error');
        return false;
      }
      
      // Deduct cost
      S.cash -= BASE_ESTABLISHMENT_COST;
      recordTransaction(`Base Establishment â€” ${icao}`, -BASE_ESTABLISHMENT_COST, 'facility');
      
      const airport = getAirport(icao);
      const baseName = airport ? `${airport.name} Operations` : `${icao} Operations`;
      
      const base = {
        id: `base_${uuid()}`,
        icao: icao,
        name: baseName,
        isPrimary: false,
        established: { ...S.gameTime },
        hangars: [],
        rampAircraft: [],
        mxFacility: null,
        partsRoom: false,
        fuelStorage: {
          '100LL': [],
          'JetA': []
        },
        construction: []
      };
      
      S.bases.list.push(base);
      
      // Send notification email
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Operations',
        subject: `New Base Established â€” ${icao}`,
        body: `Your new base at ${baseName} is now operational.\n\n` +
              `You can now assign aircraft and staff to this location, and begin building facilities.\n\n` +
              `Note: Aircraft will need to be repositioned to the new base before they can operate from there.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Base Established', `New base at ${icao}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.establishBase = establishBase;
    
    // Get base by ID
    function getBase(baseId) {
      return S.bases.list.find(b => b.id === baseId);
    }
    
    // Get base by ICAO
    function getBaseByIcao(icao) {
      return S.bases.list.find(b => b.icao === icao);
    }
    
    // Get primary base
    function getPrimaryBase() {
      return S.bases.list.find(b => b.isPrimary);
    }
    
    // Get aircraft's home base
    function getAircraftBase(aircraftCode) {
      const fleetData = S.fleetData?.[aircraftCode];
      if (fleetData?.homeBase) {
        return getBase(fleetData.homeBase);
      }
      // Default to primary base
      return getPrimaryBase();
    }
    
    // Assign aircraft to a base
    function assignAircraftToBase(aircraftCode, baseId) {
      if (!S.fleetData[aircraftCode]) {
        S.fleetData[aircraftCode] = {};
      }
      S.fleetData[aircraftCode].homeBase = baseId;
      saveState();
    }
    
    // Get staff member's assigned base
    function getStaffBase(staffId) {
      const staff = S.staff.find(s => s.id === staffId);
      if (staff?.assignedBase) {
        // assignedBase is currently an ICAO, convert to base lookup
        return getBaseByIcao(staff.assignedBase);
      }
      return getPrimaryBase();
    }
    
    // Assign staff to a base
    function assignStaffToBase(staffId, baseId) {
      const staff = S.staff.find(s => s.id === staffId);
      if (!staff) return false;
      
      const base = getBase(baseId);
      if (!base) return false;
      
      staff.assignedBase = base.icao;
      saveState();
      return true;
    }
    
    // Get all aircraft at a base
    function getAircraftAtBase(baseId) {
      const base = getBase(baseId);
      if (!base) return [];
      
      return S.fleet.filter(code => {
        const fleetData = S.fleetData?.[code];
        const homeBaseId = fleetData?.homeBase;
        // If no home base set, default to primary
        if (!homeBaseId) return base.isPrimary;
        return homeBaseId === baseId;
      });
    }
    
    // Get all staff at a base
    function getStaffAtBase(baseId) {
      const base = getBase(baseId);
      if (!base) return [];
      
      return S.staff.filter(s => {
        const staffBase = getStaffBase(s.id);
        return staffBase?.id === baseId;
      });
    }
    
    // === HANGAR FUNCTIONS ===
    
    // Get total hangar capacity at a base
    function getHangarCapacity(baseId) {
      const base = getBase(baseId);
      if (!base) return 0;
      
      return base.hangars.reduce((sum, h) => {
        if (h.status === 'operational') {
          return sum + (HANGARS[h.type]?.capacity || 0);
        }
        return sum;
      }, 0);
    }
    
    // Get used hangar capacity at a base
    function getHangarUsed(baseId) {
      const base = getBase(baseId);
      if (!base) return 0;
      
      let used = 0;
      for (const hangar of base.hangars) {
        if (hangar.status === 'operational' && hangar.aircraft) {
          for (const code of hangar.aircraft) {
            used += getAircraftSize(code);
          }
        }
      }
      return used;
    }
    
    // Get aircraft on ramp (not in any hangar) at a base
    function getAircraftOnRamp(baseId) {
      const base = getBase(baseId);
      if (!base) return [];
      
      const aircraftAtBase = getAircraftAtBase(baseId);
      const hangaredAircraft = new Set();
      
      for (const hangar of base.hangars) {
        if (hangar.status === 'operational' && hangar.aircraft) {
          hangar.aircraft.forEach(code => hangaredAircraft.add(code));
        }
      }
      
      return aircraftAtBase.filter(code => !hangaredAircraft.has(code));
    }
    
    // Check if aircraft is hangared
    function isAircraftHangared(aircraftCode) {
      for (const base of S.bases.list) {
        for (const hangar of base.hangars) {
          if (hangar.status === 'operational' && hangar.aircraft?.includes(aircraftCode)) {
            return true;
          }
        }
      }
      return false;
    }
    
    // Build a new hangar
    function buildHangar(baseId, hangarType) {
      const base = getBase(baseId);
      if (!base) return false;
      
      const config = HANGARS[hangarType];
      if (!config) return false;
      
      // Check max hangars
      const existingHangars = base.hangars.length;
      if (existingHangars >= HANGAR_MAX_PER_BASE) {
        showToast('Limit Reached', `Maximum ${HANGAR_MAX_PER_BASE} hangars per base`, 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < config.buildCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(config.buildCost)}`, 'error');
        return false;
      }
      
      // Deduct cost
      S.cash -= config.buildCost;
      recordTransaction(`Hangar Construction â€” ${config.name} (${base.icao})`, -config.buildCost, 'facility');
      
      // Calculate completion date
      const completionDate = addDays(S.gameTime, config.buildDays);
      
      const hangar = {
        id: `hangar_${uuid()}`,
        type: hangarType,
        status: 'constructing',
        startDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
        completionDate: { year: completionDate.year, month: completionDate.month, day: completionDate.day },
        aircraft: []
      };
      
      base.hangars.push(hangar);
      
      // Send notification
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Facilities',
        subject: `Construction Started â€” ${config.name}`,
        body: `Construction has begun on a ${config.name} at ${base.icao}.\n\n` +
              `Capacity: ${config.capacity} units\n` +
              `Estimated completion: ${completionDate.month}/${completionDate.day}/${completionDate.year}\n\n` +
              `You will be notified when construction is complete.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Construction Started', `${config.name} at ${base.icao}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.buildHangar = buildHangar;
    
    // Check and complete construction projects
    function checkConstructionCompletion() {
      const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
      
      for (const base of S.bases.list) {
        for (const hangar of base.hangars) {
          if (hangar.status === 'constructing' && hangar.completionDate) {
            const completeDays = (hangar.completionDate.year * 336) + 
                                 ((hangar.completionDate.month - 1) * 28) + 
                                 hangar.completionDate.day;
            
            if (currentDays >= completeDays) {
              hangar.status = 'operational';
              const config = HANGARS[hangar.type];
              
              S.emails.unshift({
                id: uuid(),
                type: 'notification',
                from: 'Facilities',
                subject: `Construction Complete â€” ${config?.name || 'Hangar'}`,
                body: `Your ${config?.name || 'hangar'} at ${base.icao} is now operational!\n\n` +
                      `You can now assign aircraft to this hangar.`,
                status: 'unread',
                receivedAt: { ...S.gameTime }
              });
              
              showToast('Construction Complete', `${config?.name} at ${base.icao}`, 'success');
            }
          }
        }
      }
    }
    
    // Assign aircraft to a hangar
    function assignToHangar(aircraftCode, hangarId) {
      // Find the hangar
      let targetHangar = null;
      let targetBase = null;
      
      for (const base of S.bases.list) {
        const hangar = base.hangars.find(h => h.id === hangarId);
        if (hangar) {
          targetHangar = hangar;
          targetBase = base;
          break;
        }
      }
      
      if (!targetHangar || targetHangar.status !== 'operational') {
        showToast('Error', 'Hangar not available', 'error');
        return false;
      }
      
      // Check if aircraft is at this base
      const aircraftBase = getAircraftBase(aircraftCode);
      if (aircraftBase?.id !== targetBase.id) {
        showToast('Wrong Base', 'Aircraft must be at this base first', 'warning');
        return false;
      }
      
      // Remove from any current hangar first
      removeFromHangar(aircraftCode);
      
      // Check capacity
      const config = HANGARS[targetHangar.type];
      const currentUsed = (targetHangar.aircraft || []).reduce((sum, code) => sum + getAircraftSize(code), 0);
      const aircraftSize = getAircraftSize(aircraftCode);
      
      if (currentUsed + aircraftSize > config.capacity) {
        showToast('No Space', 'Not enough hangar capacity', 'warning');
        return false;
      }
      
      // Assign
      if (!targetHangar.aircraft) targetHangar.aircraft = [];
      targetHangar.aircraft.push(aircraftCode);
      
      saveState();
      return true;
    }
    window.assignToHangar = assignToHangar;
    
    // Remove aircraft from hangar (move to ramp)
    function removeFromHangar(aircraftCode) {
      for (const base of S.bases.list) {
        for (const hangar of base.hangars) {
          if (hangar.aircraft) {
            const idx = hangar.aircraft.indexOf(aircraftCode);
            if (idx !== -1) {
              hangar.aircraft.splice(idx, 1);
              saveState();
              return true;
            }
          }
        }
      }
      return false;
    }
    window.removeFromHangar = removeFromHangar;
    
    // Dismantle a hangar
    function dismantleHangar(baseId, hangarId) {
      const base = getBase(baseId);
      if (!base) return false;
      
      const hangarIndex = base.hangars.findIndex(h => h.id === hangarId);
      if (hangarIndex === -1) return false;
      
      const hangar = base.hangars[hangarIndex];
      const config = HANGARS[hangar.type];
      const demoCost = Math.round((config?.buildCost || 50000) * 0.10);
      
      // Check funds
      if (S.cash < demoCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(demoCost)} for demolition`, 'error');
        return false;
      }
      
      // Move aircraft to ramp
      if (hangar.aircraft && hangar.aircraft.length > 0) {
        hangar.aircraft = [];
      }
      
      // Deduct demolition cost
      S.cash -= demoCost;
      recordTransaction(`Hangar Demolition â€” ${config?.name || 'Hangar'} (${base.icao})`, -demoCost, 'facility');
      
      // Remove hangar
      base.hangars.splice(hangarIndex, 1);
      
      showToast('Hangar Dismantled', `${config?.name || 'Hangar'} at ${base.icao} demolished`, 'success');
      
      saveState();
      return true;
    }
    window.dismantleHangar = dismantleHangar;
    
    // === FUEL STORAGE FUNCTIONS ===
    
    // Build a new fuel tank
    function buildFuelTank(baseId, fuelType, tierKey) {
      const base = getBase(baseId);
      if (!base) return false;
      
      const fuelConfig = FUEL_STORAGE[fuelType];
      if (!fuelConfig) return false;
      
      const tierConfig = fuelConfig.tiers[tierKey];
      if (!tierConfig) return false;
      
      // Check max tanks per type
      const existingTanks = base.fuelStorage[fuelType]?.length || 0;
      if (existingTanks >= FUEL_TANKS_MAX_PER_TYPE) {
        showToast('Limit Reached', `Maximum ${FUEL_TANKS_MAX_PER_TYPE} ${fuelType} tanks per base`, 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < tierConfig.buildCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(tierConfig.buildCost)}`, 'error');
        return false;
      }
      
      // Deduct cost
      S.cash -= tierConfig.buildCost;
      recordTransaction(`Fuel Tank Construction â€” ${tierConfig.name} (${base.icao})`, -tierConfig.buildCost, 'facility');
      
      // Calculate completion date
      const completionDate = addDays(S.gameTime, tierConfig.buildDays);
      
      const tank = {
        id: `tank_${uuid()}`,
        fuelType: fuelType,
        tier: tierKey,
        status: 'constructing',
        startDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
        completionDate: { year: completionDate.year, month: completionDate.month, day: completionDate.day },
        level: 0,
        capacity: tierConfig.capacity
      };
      
      if (!base.fuelStorage[fuelType]) base.fuelStorage[fuelType] = [];
      base.fuelStorage[fuelType].push(tank);
      
      // Send notification
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Facilities',
        subject: `Construction Started â€” ${tierConfig.name}`,
        body: `Construction has begun on a ${tierConfig.name} at ${base.icao}.\n\n` +
              `Capacity: ${tierConfig.capacity.toLocaleString()} gallons\n` +
              `Estimated completion: ${completionDate.month}/${completionDate.day}/${completionDate.year}\n\n` +
              `You will be notified when construction is complete.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Construction Started', `${tierConfig.name} at ${base.icao}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.buildFuelTank = buildFuelTank;
    
    // Check fuel tank construction completion
    function checkFuelTankConstruction() {
      const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
      
      for (const base of S.bases.list) {
        for (const fuelType of ['100LL', 'JetA']) {
          if (!base.fuelStorage[fuelType]) continue;
          
          for (const tank of base.fuelStorage[fuelType]) {
            if (tank.status === 'constructing' && tank.completionDate) {
              const completeDays = (tank.completionDate.year * 336) + 
                                   ((tank.completionDate.month - 1) * 28) + 
                                   tank.completionDate.day;
              
              if (currentDays >= completeDays) {
                tank.status = 'operational';
                const fuelConfig = FUEL_STORAGE[fuelType];
                const tierConfig = fuelConfig?.tiers[tank.tier];
                
                S.emails.unshift({
                  id: uuid(),
                  type: 'notification',
                  from: 'Facilities',
                  subject: `Construction Complete â€” ${tierConfig?.name || 'Fuel Tank'}`,
                  body: `Your ${tierConfig?.name || 'fuel tank'} at ${base.icao} is now operational!\n\n` +
                        `You can now purchase bulk fuel to fill the tank.`,
                  status: 'unread',
                  receivedAt: { ...S.gameTime }
                });
                
                showToast('Construction Complete', `${tierConfig?.name} at ${base.icao}`, 'success');
              }
            }
          }
        }
      }
    }
    
    // Buy bulk fuel to fill a tank
    function buyBulkFuel(baseId, tankId, gallons) {
      const base = getBase(baseId);
      if (!base) return false;
      
      let tank = null;
      let fuelType = null;
      
      for (const ft of ['100LL', 'JetA']) {
        const found = base.fuelStorage[ft]?.find(t => t.id === tankId);
        if (found) {
          tank = found;
          fuelType = ft;
          break;
        }
      }
      
      if (!tank || tank.status !== 'operational') {
        showToast('Error', 'Tank not available', 'error');
        return false;
      }
      
      const fuelConfig = FUEL_STORAGE[fuelType];
      const tierConfig = fuelConfig?.tiers[tank.tier];
      
      // Calculate space available
      const spaceAvailable = tank.capacity - tank.level;
      const actualGallons = Math.min(gallons, spaceAvailable);
      
      if (actualGallons <= 0) {
        showToast('Tank Full', 'No space available in tank', 'warning');
        return false;
      }
      
      // Bulk discount only applies if buying at least 50% of tank capacity
      const basePrice = fuelType === '100LL' ? 6.50 : 6.00;
      const minForDiscount = tank.capacity * 0.5;
      const bulkDiscount = actualGallons >= minForDiscount ? (tierConfig?.discount || 0.10) : 0;
      const pricePerGallon = basePrice * (1 - bulkDiscount);
      const totalCost = Math.round(actualGallons * pricePerGallon);
      
      // Check funds
      if (S.cash < totalCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(totalCost)}`, 'error');
        return false;
      }
      
      // Deduct cost and add fuel
      S.cash -= totalCost;
      tank.level += actualGallons;
      const discountNote = bulkDiscount > 0 ? ` (${(bulkDiscount * 100)}% bulk discount)` : ' (no discount - min 50% fill)';
      recordTransaction(`Bulk Fuel â€” ${actualGallons.toLocaleString()} gal ${fuelType} (${base.icao})`, -totalCost, 'fuel');
      
      showToast('Fuel Purchased', `${actualGallons.toLocaleString()} gal at ${formatCurrency(pricePerGallon)}/gal${discountNote}`, 'success');
      
      saveState();
      return true;
    }
    window.buyBulkFuel = buyBulkFuel;
    
    // Get fuel discount for aircraft at home base
    function getFuelDiscount(aircraftCode) {
      const base = getAircraftBase(aircraftCode);
      if (!base) return 0;
      
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return 0;
      
      const fuelType = aircraft.fuel_type === '100LL' ? '100LL' : 'JetA';
      const tanks = base.fuelStorage[fuelType]?.filter(t => t.status === 'operational' && t.level > 0) || [];
      
      if (tanks.length === 0) return 0;
      
      // Get best discount from available tanks
      let bestDiscount = 0;
      for (const tank of tanks) {
        const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
        if (tierConfig?.discount > bestDiscount) {
          bestDiscount = tierConfig.discount;
        }
      }
      
      return bestDiscount;
    }
    
    // Draw fuel from tank (reduces level)
    function drawFuelFromTank(baseId, fuelType, gallons) {
      const base = getBase(baseId);
      if (!base) return 0;
      
      const tanks = base.fuelStorage[fuelType]?.filter(t => t.status === 'operational' && t.level > 0) || [];
      if (tanks.length === 0) return 0;
      
      let remaining = gallons;
      let drawn = 0;
      
      for (const tank of tanks) {
        if (remaining <= 0) break;
        
        const available = tank.level;
        const toDraw = Math.min(remaining, available);
        tank.level -= toDraw;
        drawn += toDraw;
        remaining -= toDraw;
      }
      
      if (drawn > 0) saveState();
      return drawn;
    }
    
    // Dismantle a fuel tank
    function dismantleFuelTank(baseId, tankId) {
      const base = getBase(baseId);
      if (!base) return false;
      
      let tankIndex = -1;
      let fuelType = null;
      let tank = null;
      
      for (const ft of ['100LL', 'JetA']) {
        const idx = base.fuelStorage[ft]?.findIndex(t => t.id === tankId);
        if (idx !== undefined && idx !== -1) {
          tankIndex = idx;
          fuelType = ft;
          tank = base.fuelStorage[ft][idx];
          break;
        }
      }
      
      if (tankIndex === -1 || !tank) return false;
      
      const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
      const demoCost = Math.round((tierConfig?.buildCost || 15000) * 0.10);
      
      // Check funds
      if (S.cash < demoCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(demoCost)} for demolition`, 'error');
        return false;
      }
      
      // Deduct demolition cost
      S.cash -= demoCost;
      recordTransaction(`Fuel Tank Demolition â€” ${tierConfig?.name || 'Tank'} (${base.icao})`, -demoCost, 'facility');
      
      // Remove tank
      base.fuelStorage[fuelType].splice(tankIndex, 1);
      
      showToast('Tank Dismantled', `${tierConfig?.name || 'Tank'} at ${base.icao} demolished`, 'success');
      
      saveState();
      return true;
    }
    window.dismantleFuelTank = dismantleFuelTank;
    
    // === MX FACILITY FUNCTIONS ===
    
    const MX_FACILITY_ORDER = ['stand', 'shop', 'center'];
    
    // Build or upgrade MX facility
    function buildMxFacility(baseId, facilityType) {
      const base = getBase(baseId);
      if (!base) return false;
      
      const config = MX_FACILITIES[facilityType];
      if (!config) return false;
      
      // Calculate cost (full if new, difference if upgrade)
      let cost = config.buildCost;
      let buildDays = config.buildDays;
      let isUpgrade = false;
      
      if (base.mxFacility && base.mxFacility.status === 'operational') {
        const currentType = base.mxFacility.type;
        const currentConfig = MX_FACILITIES[currentType];
        const currentIndex = MX_FACILITY_ORDER.indexOf(currentType);
        const newIndex = MX_FACILITY_ORDER.indexOf(facilityType);
        
        if (newIndex <= currentIndex) {
          showToast('Invalid Upgrade', 'Can only upgrade to a higher tier', 'warning');
          return false;
        }
        
        // Upgrade cost is difference
        cost = config.buildCost - currentConfig.buildCost;
        // Upgrade time is shorter
        buildDays = Math.ceil((config.buildDays - currentConfig.buildDays) * 0.75);
        isUpgrade = true;
      }
      
      // Check if already building/upgrading
      if (base.mxFacility && base.mxFacility.status === 'constructing') {
        showToast('Construction in Progress', 'Wait for current construction to complete', 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < cost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(cost)}`, 'error');
        return false;
      }
      
      // Deduct cost
      S.cash -= cost;
      const actionWord = isUpgrade ? 'Upgrade' : 'Construction';
      recordTransaction(`MX Facility ${actionWord} â€” ${config.name} (${base.icao})`, -cost, 'facility');
      
      // Calculate completion date
      const completionDate = addDays(S.gameTime, buildDays);
      
      base.mxFacility = {
        type: facilityType,
        status: 'constructing',
        startDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
        completionDate: { year: completionDate.year, month: completionDate.month, day: completionDate.day },
        partsRoom: base.mxFacility?.partsRoom || false
      };
      
      // Send notification
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Facilities',
        subject: `${actionWord} Started â€” ${config.name}`,
        body: `${actionWord} has begun on ${config.name} at ${base.icao}.\n\n` +
              `Capabilities: ${config.capabilities.join(', ')}\n` +
              `Estimated completion: ${completionDate.month}/${completionDate.day}/${completionDate.year}\n\n` +
              `You will be notified when ${actionWord.toLowerCase()} is complete.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast(`${actionWord} Started`, `${config.name} at ${base.icao}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.buildMxFacility = buildMxFacility;
    
    // Build parts room upgrade
    function buildPartsRoom(baseId) {
      const base = getBase(baseId);
      if (!base) return false;
      
      if (!base.mxFacility || base.mxFacility.status !== 'operational') {
        showToast('No MX Facility', 'Build an MX facility first', 'warning');
        return false;
      }
      
      if (base.mxFacility.partsRoom) {
        showToast('Already Built', 'Parts room already exists', 'warning');
        return false;
      }
      
      if (base.mxFacility.partsRoomConstructing) {
        showToast('Construction in Progress', 'Parts room already under construction', 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < MX_PARTS_ROOM.buildCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(MX_PARTS_ROOM.buildCost)}`, 'error');
        return false;
      }
      
      // Deduct cost
      S.cash -= MX_PARTS_ROOM.buildCost;
      recordTransaction(`Parts Room Construction (${base.icao})`, -MX_PARTS_ROOM.buildCost, 'facility');
      
      // Calculate completion date
      const completionDate = addDays(S.gameTime, MX_PARTS_ROOM.buildDays);
      
      base.mxFacility.partsRoomConstructing = {
        startDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
        completionDate: { year: completionDate.year, month: completionDate.month, day: completionDate.day }
      };
      
      // Send notification
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Facilities',
        subject: 'Construction Started â€” Parts Room',
        body: `Construction has begun on a Parts Room at ${base.icao}.\n\n` +
              `Benefit: ${(MX_PARTS_ROOM.timeReduction * 100)}% reduction in MX time\n` +
              `Estimated completion: ${completionDate.month}/${completionDate.day}/${completionDate.year}`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Construction Started', `Parts Room at ${base.icao}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.buildPartsRoom = buildPartsRoom;
    
    // Check MX facility construction completion
    function checkMxFacilityConstruction() {
      const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
      
      for (const base of S.bases.list) {
        // Check main facility
        if (base.mxFacility && base.mxFacility.status === 'constructing' && base.mxFacility.completionDate) {
          const completeDays = (base.mxFacility.completionDate.year * 336) + 
                               ((base.mxFacility.completionDate.month - 1) * 28) + 
                               base.mxFacility.completionDate.day;
          
          if (currentDays >= completeDays) {
            base.mxFacility.status = 'operational';
            const config = MX_FACILITIES[base.mxFacility.type];
            
            S.emails.unshift({
              id: uuid(),
              type: 'notification',
              from: 'Facilities',
              subject: `Construction Complete â€” ${config?.name || 'MX Facility'}`,
              body: `Your ${config?.name || 'MX facility'} at ${base.icao} is now operational!\n\n` +
                    `Your mechanics can now perform: ${config?.capabilities.join(', ')}`,
              status: 'unread',
              receivedAt: { ...S.gameTime }
            });
            
            showToast('Construction Complete', `${config?.name} at ${base.icao}`, 'success');
          }
        }
        
        // Check parts room
        if (base.mxFacility?.partsRoomConstructing) {
          const completeDays = (base.mxFacility.partsRoomConstructing.completionDate.year * 336) + 
                               ((base.mxFacility.partsRoomConstructing.completionDate.month - 1) * 28) + 
                               base.mxFacility.partsRoomConstructing.completionDate.day;
          
          if (currentDays >= completeDays) {
            base.mxFacility.partsRoom = true;
            delete base.mxFacility.partsRoomConstructing;
            
            S.emails.unshift({
              id: uuid(),
              type: 'notification',
              from: 'Facilities',
              subject: 'Construction Complete â€” Parts Room',
              body: `Your Parts Room at ${base.icao} is now operational!\n\n` +
                    `MX work time reduced by ${(MX_PARTS_ROOM.timeReduction * 100)}%`,
              status: 'unread',
              receivedAt: { ...S.gameTime }
            });
            
            showToast('Construction Complete', `Parts Room at ${base.icao}`, 'success');
          }
        }
      }
    }
    
    // Check if base can perform MX work type
    function canBasePerformMx(baseId, workType) {
      const base = getBase(baseId);
      if (!base || !base.mxFacility || base.mxFacility.status !== 'operational') {
        return false;
      }
      
      const config = MX_FACILITIES[base.mxFacility.type];
      return config?.capabilities.includes(workType) || false;
    }
    
    // Get MX time reduction from parts room
    function getPartsRoomReduction(baseId) {
      const base = getBase(baseId);
      if (!base?.mxFacility?.partsRoom) return 0;
      return MX_PARTS_ROOM.timeReduction;
    }
    
    // Dismantle MX facility
    function dismantleMxFacility(baseId) {
      const base = getBase(baseId);
      if (!base || !base.mxFacility) return false;
      
      const config = MX_FACILITIES[base.mxFacility.type];
      const demoCost = Math.round((config?.buildCost || 12500) * 0.10);
      
      // Check funds
      if (S.cash < demoCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(demoCost)} for demolition`, 'error');
        return false;
      }
      
      // Deduct demolition cost
      S.cash -= demoCost;
      recordTransaction(`MX Facility Demolition â€” ${config?.name || 'MX Facility'} (${base.icao})`, -demoCost, 'facility');
      
      // Remove facility
      base.mxFacility = null;
      
      showToast('Facility Dismantled', `${config?.name || 'MX Facility'} at ${base.icao} demolished`, 'success');
      
      saveState();
      return true;
    }
    window.dismantleMxFacility = dismantleMxFacility;
    
    // Process monthly facility upkeep costs
    function processFacilityUpkeep() {
      let totalUpkeep = 0;
      
      for (const base of S.bases.list) {
        // Hangar upkeep
        for (const hangar of base.hangars) {
          if (hangar.status === 'operational') {
            const config = HANGARS[hangar.type];
            if (config?.monthly) {
              totalUpkeep += config.monthly;
            }
          }
        }
        
        // Fuel tank upkeep
        for (const fuelType of ['100LL', 'JetA']) {
          for (const tank of (base.fuelStorage[fuelType] || [])) {
            if (tank.status === 'operational') {
              const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
              if (tierConfig?.monthly) {
                totalUpkeep += tierConfig.monthly;
              }
            }
          }
        }
        
        // Future: MX facility upkeep
      }
      
      if (totalUpkeep > 0) {
        S.cash -= totalUpkeep;
        recordTransaction('Facility Upkeep', -totalUpkeep, 'facility');
      }
      
      return totalUpkeep;
    }
    
    // Calculate monthly facility upkeep for display (doesn't deduct)
    function calculateMonthlyFacilityUpkeep() {
      let total = 0;
      let hangars = 0;
      let tanks = 0;
      
      for (const base of S.bases.list) {
        for (const hangar of base.hangars) {
          if (hangar.status === 'operational') {
            const config = HANGARS[hangar.type];
            if (config?.monthly) {
              total += config.monthly;
              hangars++;
            }
          }
        }
        
        for (const fuelType of ['100LL', 'JetA']) {
          for (const tank of (base.fuelStorage[fuelType] || [])) {
            if (tank.status === 'operational') {
              const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
              if (tierConfig?.monthly) {
                total += tierConfig.monthly;
                tanks++;
              }
            }
          }
        }
      }
      
      return { total, hangars, tanks };
    }

    // === STAFF SYSTEM CONSTANTS ===
    const STAFF_ROLES = ['pilot', 'mechanic', 'opsOfficer', 'marketing', 'accountant'];
    
    const STAFF_EXPERIENCE_LEVELS = ['junior', 'mid', 'senior', 'expert'];
    
    const STAFF_XP_THRESHOLDS = {
      junior: 0,
      mid: 1000,
      senior: 3000,
      expert: 7500
    };
    
    const STAFF_SALARIES = {
      pilot:      { junior: 3500, mid: 5000, senior: 7500, expert: 12000 },
      mechanic:   { junior: 1500, mid: 2000, senior: 2750, expert: 3500 },
      opsOfficer: { junior: 3000, mid: 4000, senior: 5500, expert: 8000 },
      marketing:  { junior: 2500, mid: 4000, senior: 6000, expert: 9000 },
      accountant: { junior: 2000, mid: 3000, senior: 4500, expert: 7000 }
    };
    
    const STAFF_EFFECTS = {
      mechanic: {
        laborDiscount: { junior: 0.40, mid: 0.50, senior: 0.60, expert: 0.70 },
        partsDiscount: { junior: 0.15, mid: 0.20, senior: 0.25, expert: 0.30 },
        squawkPrevention: { junior: 0.20, mid: 0.30, senior: 0.40, expert: 0.50 },
        degradationReduction: { junior: 0.15, mid: 0.22, senior: 0.30, expert: 0.40 }
      },
      // Support staff - flat bonuses, no experience levels
      marketing: {
        salary: 3000,
        repGainBonus: 0.15,        // +15% reputation XP
        contractValueBonus: 0.05   // +5% contract revenue
      },
      accountant: {
        salary: 3500,
        revenueBonus: 0.05,       // +5% contract revenue
        payrollDiscount: 0.05,    // 5% off payroll
        insuranceDiscount: 0.05,  // 5% off insurance
        locAprReduction: 0.02     // -2% off LOC APR (e.g., 8% -> 6%)
      }
    };
    
    const STAFF_SKILL_RANGES = {
      junior: [20, 40],
      mid: [40, 60],
      senior: [60, 80],
      expert: [80, 95]
    };
    
    const STAFF_AGE_RANGES = {
      junior: [22, 32],
      mid: [28, 42],
      senior: [35, 55],
      expert: [45, 65]
    };
    
    // Mechanic capability gates - what MX types each level can perform
    const MECHANIC_CAPABILITIES = {
      junior: ['squawk'],
      mid: ['squawk', 'inspection'],
      senior: ['squawk', 'inspection', 'major_service'],
      expert: ['squawk', 'inspection', 'major_service', 'overhaul']
    };
    
    // Mechanic XP rewards for completing jobs
    const MECHANIC_XP_REWARDS = {
      squawk_minor: 5,
      squawk_moderate: 10,
      squawk_serious: 18,
      squawk_critical: 25,
      inspection: 20,
      major_service: 38,
      overhaul: 75
    };
    
    // === HIRING & SEVERANCE ===
    const HIRING_FEE_PERCENT = 0.10;  // 10% of monthly salary
    const SEVERANCE_MONTHS = 2;       // 2 months salary on termination
    
    // === PILOT TRAINING CONFIG ===
    const PILOT_TRAINING = {
      instrument: {
        name: 'Instrument Rating (IFR)',
        cost: 8000,
        durationDays: 14,
        minHours: 50,
        failureRange: [0.03, 0.10]  // 3-10% based on skill
      },
      multiEngine: {
        name: 'Multi-Engine Rating',
        cost: 6000,
        durationDays: 10,
        minHours: 25,
        failureRange: [0.02, 0.08]
      },
      turbine: {
        name: 'Turbine Rating',
        cost: 15000,
        durationDays: 21,
        minHours: 200,
        failureRange: [0.04, 0.10]
      },
      helicopter: {
        name: 'Helicopter Rating',
        cost: 25000,
        durationDays: 28,
        minHours: 0,
        failureRange: [0.05, 0.10]
      },
      seaplane: {
        name: 'Seaplane Rating',
        cost: 4000,
        durationDays: 7,
        minHours: 25,
        failureRange: [0.02, 0.07]
      }
    };
    
    // === STAFF NAME GENERATION ===
    const FIRST_NAMES_MALE = [
      // Anglo/American
      'James', 'John', 'Robert', 'Michael', 'William', 'David', 'Joseph', 'Thomas',
      'Charles', 'Daniel', 'Matthew', 'Anthony', 'Mark', 'Steven', 'Paul', 'Andrew',
      'Joshua', 'Kenneth', 'Kevin', 'Brian', 'George', 'Timothy', 'Ronald', 'Edward',
      'Jason', 'Jeffrey', 'Ryan', 'Jacob', 'Gary', 'Nicholas', 'Eric', 'Jonathan',
      'Stephen', 'Larry', 'Justin', 'Scott', 'Brandon', 'Benjamin', 'Samuel', 'Raymond',
      // Hispanic/Latino
      'Carlos', 'Miguel', 'Luis', 'Diego', 'Antonio', 'Jose', 'Pedro', 'Juan',
      'Francisco', 'Alejandro', 'Ricardo', 'Fernando', 'Rafael', 'Manuel', 'Javier', 'Oscar',
      'Sergio', 'Raul', 'Eduardo', 'Arturo', 'Roberto', 'Hector', 'Victor', 'Mario',
      // African American
      'Marcus', 'Andre', 'Terrell', 'Dwayne', 'Malik', 'Jamal', 'DeShawn', 'Tyrone',
      'Isaiah', 'Darius', 'Xavier', 'Cedric', 'Lamar', 'Quincy', 'Dante', 'Reginald',
      // Asian
      'Wei', 'Jun', 'Hiro', 'Kenji', 'Raj', 'Amit', 'Sanjay', 'Takeshi',
      'Chen', 'Li', 'Yuki', 'Satoshi', 'Ravi', 'Vikram', 'Arjun', 'Deepak',
      'Jin', 'Min', 'Tao', 'Akira', 'Haruki', 'Prasad', 'Suresh', 'Bao',
      // Eastern European
      'Sergei', 'Dmitri', 'Andrei', 'Viktor', 'Alexei', 'Nikolai', 'Ivan', 'Boris',
      'Pavel', 'Oleg', 'Yuri', 'Mikhail', 'Stanislav', 'Grigory', 'Leonid', 'Konstantin',
      // Western/Northern European
      'Erik', 'Lars', 'Hans', 'Klaus', 'Heinrich', 'Gunther', 'Sven', 'Bjorn',
      'Nils', 'Magnus', 'Anders', 'Henrik', 'Gustav', 'Johan', 'Pieter', 'Willem',
      // Celtic/Irish
      'Patrick', 'Sean', 'Connor', 'Liam', 'Owen', 'Declan', 'Finn', 'Brendan',
      'Cormac', 'Rory', 'Kieran', 'Colin', 'Donovan', 'Shane', 'Niall', 'Callum'
    ];

    const FIRST_NAMES_FEMALE = [
      // Anglo/American
      'Mary', 'Patricia', 'Jennifer', 'Linda', 'Barbara', 'Susan', 'Jessica', 'Sarah',
      'Karen', 'Lisa', 'Nancy', 'Betty', 'Margaret', 'Sandra', 'Ashley', 'Kimberly',
      'Emily', 'Donna', 'Michelle', 'Dorothy', 'Carol', 'Amanda', 'Melissa', 'Deborah',
      'Stephanie', 'Rebecca', 'Sharon', 'Laura', 'Cynthia', 'Kathleen', 'Amy', 'Angela',
      'Shirley', 'Anna', 'Brenda', 'Pamela', 'Emma', 'Nicole', 'Helen', 'Samantha',
      // Hispanic/Latina
      'Maria', 'Carmen', 'Sofia', 'Isabella', 'Lucia', 'Elena', 'Rosa', 'Gabriela',
      'Ana', 'Valentina', 'Camila', 'Fernanda', 'Alejandra', 'Mariana', 'Daniela', 'Paula',
      'Adriana', 'Carolina', 'Diana', 'Beatriz', 'Silvia', 'Teresa', 'Raquel', 'Veronica',
      // African American
      'Aisha', 'Keisha', 'Tamika', 'Jasmine', 'Destiny', 'Ebony', 'Aaliyah', 'Imani',
      'Shaniqua', 'Latoya', 'Tasha', 'Monique', 'Alicia', 'Janelle', 'Nia', 'Zara',
      // Asian
      'Mei', 'Yuki', 'Aiko', 'Priya', 'Ananya', 'Deepa', 'Lin', 'Hua',
      'Sakura', 'Hana', 'Kimiko', 'Suki', 'Anjali', 'Lakshmi', 'Sunita', 'Kavita',
      'Xia', 'Ling', 'Jing', 'Yuna', 'Miko', 'Shreya', 'Neha', 'Pooja',
      // Eastern European
      'Natasha', 'Olga', 'Svetlana', 'Irina', 'Tatiana', 'Yelena', 'Katya', 'Anastasia',
      'Mila', 'Daria', 'Vera', 'Ludmila', 'Galina', 'Nadia', 'Oksana', 'Zoya',
      // Western/Northern European
      'Ingrid', 'Greta', 'Astrid', 'Helga', 'Freya', 'Sigrid', 'Britta', 'Elsa',
      'Heidi', 'Liesel', 'Annika', 'Katrin', 'Marlene', 'Sonja', 'Birgit', 'Anja',
      // Celtic/Irish
      'Siobhan', 'Aoife', 'Fiona', 'Maeve', 'Claire', 'Bridget', 'Erin', 'Shannon',
      'Colleen', 'Moira', 'Sinead', 'Niamh', 'Orla', 'Ciara', 'Roisin', 'Saoirse'
    ];

    const LAST_NAMES = [
      // Anglo/American common
      'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
      'Wilson', 'Moore', 'Taylor', 'Anderson', 'Thomas', 'Jackson', 'White', 'Harris',
      'Martin', 'Thompson', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Torres',
      'Hill', 'Adams', 'Nelson', 'Baker', 'Hall', 'Rivera', 'Campbell', 'Mitchell',
      'Carter', 'Roberts', 'Turner', 'Phillips', 'Evans', 'Parker', 'Edwards', 'Collins',
      // Hispanic/Latino
      'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Perez', 'Sanchez', 'Ramirez',
      'Flores', 'Gomez', 'Diaz', 'Reyes', 'Morales', 'Cruz', 'Ortiz',
      'Gutierrez', 'Chavez', 'Ramos', 'Vargas', 'Castillo', 'Mendoza', 'Ruiz', 'Alvarez',
      // African American / historical
      'Washington', 'Jefferson', 'Robinson', 'Freeman', 'Banks', 'Brooks',
      'Coleman', 'Hayes', 'Henderson', 'Howard', 'Jenkins', 'Perry', 'Powell', 'Russell',
      // Asian
      'Chen', 'Wang', 'Kim', 'Nguyen', 'Patel', 'Singh', 'Tanaka', 'Yamamoto',
      'Li', 'Zhang', 'Liu', 'Yang', 'Huang', 'Wu', 'Park', 'Choi',
      'Suzuki', 'Watanabe', 'Nakamura', 'Sato', 'Sharma', 'Gupta', 'Kumar', 'Shah',
      // Eastern European
      'Volkov', 'Petrov', 'Ivanov', 'Kozlov', 'Novak', 'Kowalski', 'Nowak', 'Horvat',
      'Popov', 'Sokolov', 'Morozov', 'Pavlov', 'Kovalenko', 'Bondarenko', 'Shevchenko', 'Polanski',
      // Western/Northern European
      'Johansson', 'Andersen', 'Mueller', 'Schmidt', 'Schneider', 'Fischer', 'Weber', 'Meyer',
      'Wagner', 'Becker', 'Hoffmann', 'Berg', 'Lindgren', 'Eriksson', 'Larsson', 'Olsen',
      'Nielsen', 'Hansen', 'Bakker', 'Visser', 'De Vries', 'Van Den Berg', 'Jansen', 'Smit',
      // Celtic/Irish
      "O'Brien", 'Murphy', 'Kelly', 'Sullivan', 'McCarthy', 'Walsh', "O'Connor", 'Byrne',
      'Ryan', "O'Neill", 'Doyle', 'Brennan', 'Kennedy', 'Gallagher', 'Flynn', 'Fitzgerald'
    ];

    // === STAFF BACKGROUNDS ===
    const PILOT_BACKGROUNDS = [
      'Former flight instructor ready to move into charter work',
      'Ex-military helicopter pilot transitioning to fixed-wing',
      'Regional airline furlough looking for steady work',
      'Retired corporate pilot who got bored after six months',
      'Bush pilot from Alaska seeking warmer weather',
      'Former aerial survey pilot wanting more variety',
      'CFI with 3,000 hours ready for the next step',
      'Cargo pilot tired of overnight runs',
      'Medevac veteran looking for slower pace',
      'Rich kid who flies for fun but actually pretty good',
      'Former banner tow pilot looking to upgrade',
      'Airline washout who found their calling in GA',
      'Part-time pilot looking for full-time opportunity',
      'Former military transport pilot',
      'Skydive pilot ready for a change'
    ];

    const MECHANIC_BACKGROUNDS = [
      'A&P from major airline maintenance base, downsized',
      'Former FBO line mechanic wanting shop work',
      'Military avionics specialist, recently separated',
      'Third-generation mechanic, family owned a repair shop',
      'Factory trained on Pratt & Whitney turbines',
      'Self-taught on pistons, learned on a farm airstrip',
      'Former race team mechanic switching to aviation',
      'Retired airline mech, bored of golf',
      'IA with 40 years experience and strong opinions',
      'Young graduate from aviation maintenance school',
      'Former helicopter mechanic branching out',
      'Specialty in vintage aircraft restoration',
      'Composite repair specialist',
      'Former military crew chief',
      'Engine overhaul shop veteran'
    ];

    const OPS_BACKGROUNDS = [
      'Former airline dispatcher seeking smaller operation',
      'Military logistics specialist, detail-oriented',
      'Charter company office manager looking to move up',
      'MBA grad who actually likes spreadsheets',
      'Former pilot grounded by medical, knows the business',
      'FBO front desk promoted from within',
      'Air traffic controller burnout, still loves aviation',
      'Freight company ops coordinator',
      'Travel agent who switched to the operational side',
      'Type-A personality who color-codes everything',
      'Former flight school scheduler',
      'Operations analyst from corporate aviation',
      'Ex-military operations center specialist',
      'Former 135 ops manager seeking new challenge',
      'Self-taught dispatcher with great instincts'
    ];

    const MARKETING_BACKGROUNDS = [
      'Former airline marketing, wants startup energy',
      'Real estate agent pivoting industries',
      'Social media manager who loves aviation',
      'PR specialist from hospitality sector',
      'Former travel writer with industry connections',
      'Sales rep from aircraft parts company',
      'Event planner who handled corporate jet clients',
      'Small business owner who sold and got restless',
      'Aviation journalist looking for steady paycheck',
      'Influencer with pilot license and 50K followers',
      'Former charter sales representative',
      'Marketing director from regional airport',
      'Tourism board veteran',
      'Former flight school enrollment specialist',
      'B2B sales professional new to aviation'
    ];

    const ACCOUNTANT_BACKGROUNDS = [
      'CPA from regional firm, likes smaller clients',
      'Former airline finance analyst',
      'Bookkeeper for three other small aviation businesses',
      'Tax specialist who knows aircraft depreciation cold',
      'FBO controller looking for change of scenery',
      'Recently retired bank auditor, part-time only',
      'Forensic accountant who wanted something calmer',
      'Family business background, understands cash flow',
      'Fresh CPA, eager and cheap',
      "Former IRS agent (don't worry, one of the nice ones)",
      'Controller from charter operation that closed',
      'QuickBooks wizard with aviation experience',
      'Former bank loan officer who reviewed aircraft deals',
      'Cost accountant from manufacturing',
      'Financial planner transitioning careers'
    ];

    const STAFF_QUIRKS = [
      // Positive
      'Always arrives 30 minutes early',
      'Keeps the break room coffee fresh',
      'Mentors junior staff without being asked',
      'Scarily organized',
      'Unflappable under pressure',
      'Knows everyone at every airport',
      'Sends thank-you notes to clients',
      'Whistles while working',
      "Remembers every passenger's name",
      'Brings donuts on Fridays',
      'Never misses a detail',
      'Surprisingly good at fixing the copier',
      'Always has a backup plan',
      'Great at defusing tense situations',
      'Encyclopedic knowledge of regulations',
      // Neutral/Colorful
      'Obsessed with weather patterns',
      'Talks to the aircraft',
      'Has strong opinions about coffee',
      'Collects vintage aviation posters',
      'Building an experimental in the garage',
      'Quotes Top Gun constantly',
      'Refuses to use digital checklists',
      'Has a lucky pen',
      'Eats the same lunch every day',
      'Listens to ATC feeds for fun',
      'Names all the aircraft',
      'Checks NOTAMs obsessively',
      'Always knows the wind direction',
      'Keeps a detailed weather journal',
      'Has flown to every state',
      // Slight negative (flavor, not gameplay impact)
      'Chronically five minutes late',
      'Leaves passive-aggressive sticky notes',
      'Talks too much on quiet mornings',
      'Overcomplicates simple tasks',
      'Hums tunelessly',
      'Replies-all to every email',
      'Microwaves fish in the break room',
      'Takes forever to make decisions',
      'Refuses to learn new software',
      "Corrects everyone's grammar"
    ];

    // === FINANCIAL RATES ===
    const RATES = {
      passengerMile: 0.45,        // $ per passenger per nm
      cargoMile: 0.0012,          // $ per lb per nm (so 100lbs * 100nm = $12)
      charterHourly: 250,         // Base $/hour for time-based missions
      ferryRate: 150,             // $/hour for ferry work
      positioningRate: 0.5,       // Positioning legs paid at 50%
      emergencyMultiplier: 1.5,   // Premium for urgent missions
      nightMultiplier: 1.2,       // Premium for night ops
      ifrMultiplier: 1.15,        // Premium for IFR conditions
      shortFieldMultiplier: 1.1,  // Premium for challenging strips
      bushMultiplier: 1.25        // Premium for unpaved/remote strips
    };

    const FUEL_PRICES = {
      "100LL": 6.44,
      "Jet-A": 6.28
    };
    
    // Helper functions to apply financial difficulty multipliers
    function getEffectiveFuelPrice(fuelType) {
      const basePrice = FUEL_PRICES[fuelType] || 6.44;
      const multiplier = S.difficultySettings?.fuelCostMultiplier || 1.0;
      return basePrice * multiplier;
    }
    
    // Returns direct ops cost with difficulty multiplier applied
    function getEffectiveDirectOps(aircraft) {
      const baseDirectOps = aircraft.direct_ops || 5;
      const multiplier = S.difficultySettings?.operatingCostMultiplier || 1.0;
      return Math.round(baseDirectOps * multiplier);
    }
    
    // Legacy function - returns total operating cost (direct ops + base MX portion)
    // Used for backward compatibility in displays
    function getEffectiveOperatingCost(aircraft) {
      const directOps = getEffectiveDirectOps(aircraft);
      const mxBase = aircraft.operating_cost || 50;
      return directOps + mxBase;
    }
    
    function getEffectiveInterestRate(baseRate) {
      const multiplier = S.difficultySettings?.interestRateMultiplier || 1.0;
      return baseRate * multiplier;
    }
    
    function getEffectiveInsuranceCost(baseCost) {
      const multiplier = S.difficultySettings?.insuranceCostMultiplier || 1.0;
      return Math.round(baseCost * multiplier);
    }
    
    // === MAINTENANCE SYSTEM FUNCTIONS ===
    
    function getEffectiveMxCost(baseCost) {
      const multiplier = S.difficultySettings?.mxCostMultiplier || 1.0;
      return Math.round(baseCost * multiplier);
    }
    
    function getEffectiveSquawkChance(baseChance) {
      const multiplier = S.difficultySettings?.squawkFrequencyMultiplier || 1.0;
      return baseChance * multiplier;
    }
    
    function getEffectiveDegradation(baseDegradation) {
      const multiplier = S.difficultySettings?.conditionDegradationMultiplier || 1.0;
      return baseDegradation * multiplier;
    }
    
    function getAircraftAge(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo || !fleetInfo.year) return 10; // Default assumption
      return S.gameTime.year - fleetInfo.year;
    }
    
    function getMaxCondition(age) {
      return Math.max(75, 100 - (age * 0.5));
    }
    
    function getAgeMultiplier(age) {
      const decades = Math.floor(age / 10);
      return 1 + (decades * MX_CONFIG.ageMultiplierPerDecade);
    }
    
    function getSquawkChanceForCondition(condition) {
      if (condition >= 90) return MX_CONFIG.squawkChance[90];
      if (condition >= 80) return MX_CONFIG.squawkChance[80];
      if (condition >= 70) return MX_CONFIG.squawkChance[70];
      if (condition >= 60) return MX_CONFIG.squawkChance[60];
      if (condition >= 50) return MX_CONFIG.squawkChance[50];
      if (condition >= 40) return MX_CONFIG.squawkChance[40];
      if (condition >= 30) return MX_CONFIG.squawkChance[30];
      return MX_CONFIG.squawkChance.below30;
    }
    
    function getRepairCostMultiplier(condition) {
      if (condition >= 70) return MX_CONFIG.repairCostMultiplier[70];
      if (condition >= 60) return MX_CONFIG.repairCostMultiplier[60];
      if (condition >= 50) return MX_CONFIG.repairCostMultiplier[50];
      if (condition >= 40) return MX_CONFIG.repairCostMultiplier[40];
      if (condition >= 30) return MX_CONFIG.repairCostMultiplier[30];
      return MX_CONFIG.repairCostMultiplier.below30;
    }
    
    function getRecommendedReserveRate(age) {
      for (const tier of MX_CONFIG.recommendedReserve) {
        if (age <= tier.maxAge) return tier.rate;
      }
      return 30;
    }
    
    function calculateConditionDegradation(code, flightHours) {
      const age = getAircraftAge(code);
      const ageMultiplier = getAgeMultiplier(age);
      let baseDegradation = flightHours * MX_CONFIG.baseDegradationPerHour * ageMultiplier;
      
      // Apply mechanic degradation reduction if available
      const reductionRate = getDegradationReduction(code);
      if (reductionRate > 0) {
        baseDegradation = baseDegradation * (1 - reductionRate);
      }
      
      // Aircraft on ramp (not hangared) degrade faster
      if (!isAircraftHangared(code)) {
        baseDegradation = baseDegradation * RAMP_DEGRADATION_MULTIPLIER;
      }
      
      return getEffectiveDegradation(baseDegradation);
    }
    
    function getMxStatus(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return 'airworthy';
      
      const mxData = getMxData(code);
      
      // Check if grounded
      if (fleetInfo.condition < MX_CONFIG.minFlyableCondition) return 'grounded';
      if (fleetInfo.scheduledMx && fleetInfo.scheduledMx.type !== 'pending') return 'grounded';
      
      // Check for grounding squawks
      if (fleetInfo.squawks?.some(s => s.severity === 'serious' || s.severity === 'critical')) {
        return 'grounded';
      }
      
      // Check if needs attention
      const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
      const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
      
      if (hoursUntilInspection <= 10 || hoursUntilOverhaul <= 50) return 'needs_attention';
      if (fleetInfo.condition < 50) return 'needs_attention';
      if (fleetInfo.squawks?.length > 0) return 'needs_attention';
      
      return 'airworthy';
    }
    
    // Get list of aircraft available for flight (not grounded)
    function getFlyableAircraft() {
      return S.fleet.filter(code => {
        const status = getMxStatus(code);
        return status !== 'grounded';
      });
    }
    
    function checkForSquawk(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return null;
      
      const condition = Math.round(fleetInfo.condition || 100);
      const baseChance = getSquawkChanceForCondition(condition);
      let effectiveChance = getEffectiveSquawkChance(baseChance);
      
      // Add small modifier for age
      const age = getAircraftAge(code);
      const ageBonus = Math.min(0.05, age * 0.001); // +0.1% per year, max +5%
      effectiveChance += ageBonus;
      
      // DEFERRED MAINTENANCE CONSEQUENCES
      // Each deferred squawk increases chance by 5%
      const deferredSquawks = (fleetInfo.squawks || []).filter(s => s.canDefer);
      const deferredBonus = deferredSquawks.length * 0.05;
      effectiveChance += deferredBonus;
      
      // Overdue inspection increases chance by 10%
      const mxData = getMxData(code);
      const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
      if (hoursUntilInspection < 0) {
        effectiveChance += 0.10;
      }
      
      // Approaching TBO increases chance by 5%
      const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
      if (hoursUntilOverhaul < mxData.tbo * 0.1) { // Within 10% of TBO
        effectiveChance += 0.05;
      }
      
      if (Math.random() < effectiveChance) {
        // Check for mechanic squawk prevention
        const preventionChance = getSquawkPreventionChance(code);
        if (preventionChance > 0 && Math.random() < preventionChance) {
          // Squawk prevented by mechanic - silently return null
          console.log(`Squawk prevented by mechanic (${Math.round(preventionChance * 100)}% chance)`);
          return null;
        }
        
        // Pass deferred count to shift severity distribution
        return generateSquawk(code, deferredSquawks.length);
      }
      return null;
    }
    
    function generateSquawk(code, deferredCount = 0) {
      const mxData = getMxData(code);
      const fleetInfo = S.fleetData[code];
      
      // Determine severity
      let severity = 'minor';
      const roll = Math.random();
      if (roll < MX_CONFIG.severityDistribution.minor) {
        severity = 'minor';
      } else if (roll < MX_CONFIG.severityDistribution.minor + MX_CONFIG.severityDistribution.moderate) {
        severity = 'moderate';
      } else if (roll < MX_CONFIG.severityDistribution.minor + MX_CONFIG.severityDistribution.moderate + MX_CONFIG.severityDistribution.serious) {
        severity = 'serious';
      } else {
        severity = 'critical';
      }
      
      // Worse condition shifts distribution toward worse outcomes
      if (fleetInfo.condition < 50) {
        if (severity === 'minor' && Math.random() < 0.3) severity = 'moderate';
        if (severity === 'moderate' && Math.random() < 0.2) severity = 'serious';
      }
      if (fleetInfo.condition < 35) {
        if (severity === 'serious' && Math.random() < 0.15) severity = 'critical';
      }
      
      // DEFERRED MAINTENANCE shifts severity worse
      // Each deferred squawk gives 10% chance to bump severity up
      for (let i = 0; i < deferredCount; i++) {
        if (Math.random() < 0.10) {
          if (severity === 'minor') severity = 'moderate';
          else if (severity === 'moderate') severity = 'serious';
          else if (severity === 'serious') severity = 'critical';
        }
      }
      
      // Calculate cost
      const costRange = MX_CONFIG.squawkCostMultiplier[severity];
      const costMultiplier = costRange[0] + Math.random() * (costRange[1] - costRange[0]);
      const baseCost = mxData.repairCostPerPercent * costMultiplier;
      const cost = getEffectiveMxCost(Math.round(baseCost));
      
      // Calculate condition impact
      const impactRange = MX_CONFIG.squawkConditionImpact[severity];
      const conditionImpact = impactRange[0] + Math.random() * (impactRange[1] - impactRange[0]);
      
      // Generate squawk type and description
      const squawkTypes = {
        engine: ['Magneto drop exceeds limits', 'Oil pressure fluctuation', 'Rough idle noted', 'Starter malfunction', 'Engine won\'t start'],
        electrical: ['Dead battery', 'Alternator fault', 'Avionics dark', 'Landing light inop', 'Electrical smell noted'],
        controls: ['Sticky control cable', 'Trim inoperative', 'Control stiffness', 'Flap asymmetry', 'Rudder binding'],
        gear: ['Flat tire', 'Brake issue', 'Strut low', 'Gear indication fault', 'Wheel bearing noise'],
        fuel: ['Fuel leak detected', 'Fuel selector stiff', 'Fuel gauge inop', 'Fuel cap seal worn', 'Fuel smell in cabin'],
        instruments: ['Vacuum pump failure', 'Gyro tumbling', 'Pitot blockage', 'Altimeter error', 'Airspeed indicator lag'],
        airframe: ['Door seal worn', 'Window crack found', 'Corrosion noted', 'Skin damage found', 'Antenna loose']
      };
      
      const categories = Object.keys(squawkTypes);
      const category = categories[Math.floor(Math.random() * categories.length)];
      const descriptions = squawkTypes[category];
      const description = descriptions[Math.floor(Math.random() * descriptions.length)];
      
      // Calculate labor hours based on severity
      const laborHours = getSquawkLaborHours(severity, 'other');
      
      return {
        id: 'squawk_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        category: category,
        severity: severity,
        description: description,
        cost: cost,
        laborHours: laborHours,
        conditionImpact: Math.round(conditionImpact * 10) / 10,
        discoveredDate: { ...S.gameTime },
        canDefer: severity === 'minor' || severity === 'moderate'
      };
    }
    
    function getRepairEstimate(code, targetCondition) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return { cost: 0, days: 0, laborHours: 0 };
      
      const mxData = getMxData(code);
      const currentCondition = fleetInfo.condition || 100;
      const age = getAircraftAge(code);
      const maxCond = getMaxCondition(age);
      
      // Cap target at max condition for age
      const actualTarget = Math.min(targetCondition, maxCond);
      const conditionToRestore = Math.max(0, actualTarget - currentCondition);
      
      if (conditionToRestore <= 0) return { cost: 0, days: 0, laborHours: 0 };
      
      // Calculate cost
      const repairMultiplier = getRepairCostMultiplier(currentCondition);
      const baseCost = conditionToRestore * mxData.repairCostPerPercent * repairMultiplier;
      const cost = getEffectiveMxCost(Math.round(baseCost));
      
      // Calculate labor hours (~0.8 hours per % improvement, scaled by aircraft complexity)
      const laborHours = Math.max(4, Math.round(conditionToRestore * 0.8 * repairMultiplier));
      const days = calculateMxDays(laborHours, false);
      
      return { cost, days, laborHours, conditionToRestore, actualTarget };
    }
    
    function getInspectionEstimate(code) {
      const mxData = getMxData(code);
      const cost = getEffectiveMxCost(mxData.inspectionCost);
      const days = mxData.inspectionInterval >= 200 ? 2 : 1; // Longer interval = more complex inspection
      return { cost, days, type: 'inspection', conditionBonus: 2 };
    }
    
    function getMajorServiceEstimate(code) {
      const mxData = getMxData(code);
      if (!mxData.majorServiceCost) return null;
      const cost = getEffectiveMxCost(mxData.majorServiceCost);
      const days = 5;
      return { cost, days, type: 'major_service', conditionBonus: 15 };
    }
    
    function getOverhaulEstimate(code) {
      const mxData = getMxData(code);
      const cost = getEffectiveMxCost(mxData.overhaulCost);
      const days = 14;
      return { cost, days, type: 'overhaul', resetsToMax: true };
    }
    
    function scheduleMaintenance(code, mxType, options = {}) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return false;
      
      // Check if base has required facility capability
      const aircraftBase = getAircraftBase(code);
      const baseId = aircraftBase?.id;
      
      const use24HrOps = options.use24HrOps || false;
      const mechanicId = options.mechanicId || null; // In-house mechanic
      const isInHouse = mechanicId !== null;
      
      // Map mxType to work type for facility check
      let workType = 'squawk'; // default
      if (mxType === 'inspection' || mxType === 'major_service') {
        workType = 'inspection';
      } else if (mxType === 'overhaul') {
        workType = 'overhaul';
      }
      
      // Only check facility requirements for IN-HOUSE work
      // Contract MX is outsourced and doesn't require your own facility
      if (isInHouse && !canBasePerformMx(baseId, workType)) {
        const facilityNeeded = workType === 'inspection' ? 'MX Shop' : (workType === 'overhaul' ? 'MX Center' : 'MX Stand');
        showToast('Facility Required', `Need ${facilityNeeded} for in-house ${mxType.replace('_', ' ')}`, 'warning');
        return false;
      }
      
      const mxData = getMxData(code);
      
      // Get mechanic if in-house
      const mechanic = mechanicId ? S.staff.find(s => s.id === mechanicId) : null;
      
      let estimate;
      let laborHours;
      let itemDescription;
      let squawkSeverity = null; // Track for XP rewards
      
      if (mxType === 'inspection') {
        estimate = getInspectionEstimate(code);
        laborHours = getRandomLaborHours(mxData.inspectionHoursRange);
        itemDescription = `${mxData.inspectionInterval}-hr Inspection`;
      } else if (mxType === 'major_service') {
        estimate = getMajorServiceEstimate(code);
        if (!estimate) return false;
        laborHours = getRandomLaborHours(mxData.majorServiceHoursRange);
        itemDescription = 'Major Service / HSI';
      } else if (mxType === 'overhaul') {
        estimate = getOverhaulEstimate(code);
        laborHours = getRandomLaborHours(mxData.overhaulHoursRange);
        itemDescription = 'Engine Overhaul';
      } else if (mxType === 'repair') {
        estimate = getRepairEstimate(code, options.targetCondition || 80);
        const condImprovement = (options.targetCondition || 80) - (fleetInfo.condition || 50);
        laborHours = Math.max(4, Math.round(condImprovement * 0.8));
        itemDescription = `Repair to ${options.targetCondition}%`;
      } else if (mxType === 'squawk') {
        const squawk = fleetInfo.squawks?.find(s => s.id === options.squawkId && !s.scheduled);
        if (!squawk) return false;
        laborHours = squawk.laborHours || getSquawkLaborHours(squawk.severity, squawk.incidentType || 'other');
        estimate = { cost: squawk.cost, days: calculateMxDays(laborHours, use24HrOps), type: 'squawk', squawkId: squawk.id };
        itemDescription = squawk.description;
        squawkSeverity = squawk.severity;
        // Mark squawk as scheduled so it won't show in the list
        squawk.scheduled = true;
      } else {
        return false;
      }
      
      // Apply in-house mechanic discounts if applicable
      let itemCost = estimate.cost;
      if (isInHouse) {
        // Estimate breakdown: roughly 60% labor, 40% parts
        const baseLaborCost = Math.round(estimate.cost * 0.6);
        const basePartsCost = estimate.cost - baseLaborCost;
        
        const discounted = calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic);
        itemCost = discounted.total;
        
        // Apply skill-based speed bonus
        laborHours = calculateMechanicLaborHours(laborHours, mechanic);
        
        itemDescription += ' (In-House)';
      }
      
      // Apply parts room time reduction if available
      const partsRoomReduction = getPartsRoomReduction(baseId);
      if (partsRoomReduction > 0) {
        laborHours = Math.round(laborHours * (1 - partsRoomReduction));
      }
      
      // Apply overtime cost multiplier if 24-hr ops (only for contract work)
      if (use24HrOps && !isInHouse) {
        itemCost = Math.round(itemCost * SHOP_HOURS.overtimeMultiplier);
      }
      
      // Check funds
      const totalFunds = S.maintenanceReserve + S.cash;
      if (totalFunds < itemCost) {
        addEmail({
          subject: `Insufficient Funds for Maintenance`,
          from: 'Skylift Operations',
          body: `You don't have enough funds to cover the ${mxType} on your ${getAircraft(code)?.name || code}. Estimated cost: ${formatCurrency(itemCost)}. Available: ${formatCurrency(totalFunds)}.`,
          type: 'alert'
        });
        return false;
      }
      
      // Deduct cost - MX reserve first, then cash
      let remaining = itemCost;
      const mxCategory = isInHouse ? 'mx_inhouse' : 'mx_reserve';
      if (S.maintenanceReserve >= remaining) {
        S.maintenanceReserve -= remaining;
        recordTransaction(`Maintenance â€” ${mxType.replace('_', ' ')} (${getAircraft(code)?.name || code})${isInHouse ? ' [In-House]' : ''}`, -remaining, mxCategory);
      } else {
        const fromReserve = S.maintenanceReserve;
        const fromCash = remaining - fromReserve;
        S.maintenanceReserve = 0;
        S.cash -= fromCash;
        if (fromReserve > 0) {
          recordTransaction(`Maintenance â€” ${mxType.replace('_', ' ')} (${getAircraft(code)?.name || code}) [reserve]${isInHouse ? ' [In-House]' : ''}`, -fromReserve, mxCategory);
        }
        recordTransaction(`Maintenance â€” ${mxType.replace('_', ' ')} (${getAircraft(code)?.name || code})${isInHouse ? ' [In-House]' : ''}`, -fromCash, 'expense');
      }
      
      // Create new MX item
      const newItem = {
        type: mxType,
        description: itemDescription,
        laborHours: laborHours,
        cost: itemCost,
        squawkId: options.squawkId || null,
        targetCondition: options.targetCondition || null,
        mechanicId: mechanicId,
        squawkSeverity: squawkSeverity
      };
      
      // Assign mechanic to job if in-house
      if (isInHouse) {
        const mxJobId = `mx_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        assignMechanicToJob(mechanicId, mxJobId, code);
        newItem.mxJobId = mxJobId;
      }
      
      // If already in maintenance, add to existing work order
      if (fleetInfo.scheduledMx) {
        fleetInfo.scheduledMx.items.push(newItem);
        fleetInfo.scheduledMx.laborHours += laborHours;
        fleetInfo.scheduledMx.cost += itemCost;
        
        // Recalculate completion date based on total hours from start
        const totalLaborHours = fleetInfo.scheduledMx.laborHours;
        fleetInfo.scheduledMx.completionDate = calculateMxCompletionDate(
          totalLaborHours, 
          fleetInfo.scheduledMx.use24HrOps, 
          fleetInfo.scheduledMx.startDate
        );
        
        showToast('Work Added', `Added ${itemDescription} to current maintenance`, 'success');
      } else {
        // Create new work order
        const startDate = { ...S.gameTime };
        const completionDate = calculateMxCompletionDate(laborHours, use24HrOps, startDate);
        
        fleetInfo.scheduledMx = {
          type: mxType, // Primary type for display
          items: [newItem],
          startDate: startDate,
          completionDate: completionDate,
          cost: itemCost,
          laborHours: laborHours,
          hoursCompleted: 0,
          use24HrOps: use24HrOps
        };
        fleetInfo.mxStatus = 'grounded';
        
        // Send confirmation email
        const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const completionDateStr = `${monthNames[completionDate.month]} ${completionDate.day}`;
        const opsMode = use24HrOps ? ' (24-hr operations)' : '';
        addEmail({
          subject: `Maintenance Scheduled: ${getAircraft(code)?.name || code}`,
          from: 'Maintenance Department',
          company: 'Skylift Maintenance',
          body: `Your ${getAircraft(code)?.name || code} has been scheduled for ${itemDescription}${opsMode}.\n\nCost: ${formatCurrency(itemCost)}\nLabor: ${laborHours} hours\nExpected completion: ${completionDateStr}\n\nThe aircraft is grounded until maintenance is complete.`,
          type: 'notification'
        });
      }
      
      saveState();
      return true;
    }
    
    function checkAndCompleteMaintenance() {
      // Called on time advance - update hours worked based on time passed during shop hours
      for (const code of S.fleet) {
        const fleetInfo = S.fleetData[code];
        if (!fleetInfo) continue;
        
        // Update hours worked on scheduled MX
        if (fleetInfo.scheduledMx) {
          const mx = fleetInfo.scheduledMx;
          const laborHours = mx.laborHours || 16;
          
          // Calculate hours completed based on game time elapsed since start
          // Shop hours: 8am-6pm (10 hrs/day) or 24-hr ops
          const startTime = mx.startDate;
          const hoursPerDay = mx.use24HrOps ? 24 : SHOP_HOURS.hoursPerDay;
          
          // Calculate full days elapsed
          const startDayNum = startTime.day + (startTime.month - 1) * 28 + (startTime.year - 2020) * 336;
          const currentDayNum = S.gameTime.day + (S.gameTime.month - 1) * 28 + (S.gameTime.year - 2020) * 336;
          const fullDaysElapsed = Math.max(0, currentDayNum - startDayNum);
          
          // Calculate hours worked today (only during shop hours if not 24-hr ops)
          let hoursToday = 0;
          if (mx.use24HrOps) {
            hoursToday = S.gameTime.hour; // All hours count
          } else {
            // Shop hours 8am-6pm
            if (S.gameTime.hour >= SHOP_HOURS.startHour && S.gameTime.hour < SHOP_HOURS.endHour) {
              hoursToday = Math.min(S.gameTime.hour - SHOP_HOURS.startHour, SHOP_HOURS.hoursPerDay);
            } else if (S.gameTime.hour >= SHOP_HOURS.endHour) {
              hoursToday = SHOP_HOURS.hoursPerDay; // Full day done
            }
          }
          
          // Total hours = full days * hours per day + hours today
          const totalHoursWorked = (fullDaysElapsed * hoursPerDay) + hoursToday;
          mx.hoursCompleted = Math.min(laborHours, totalHoursWorked);
          
          // Check if work is complete
          if (mx.hoursCompleted >= laborHours) {
            completeMaintenance(code);
          }
        }
        
        // Check for upcoming MX due warnings (only if not already in MX)
        if (!fleetInfo.scheduledMx) {
          checkMxDueWarning(code);
        }
      }
    }
    
    function checkMxDueWarning(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const mxData = getMxData(code);
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
      const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
      
      // Track which warnings we've already sent (to avoid spam)
      if (!fleetInfo.mxWarningsSent) fleetInfo.mxWarningsSent = {};
      
      // Warning thresholds: 20 hours for inspection, 100 hours for overhaul
      const inspectionWarningThreshold = 20;
      const overhaulWarningThreshold = 100;
      
      debugLog(`MX Warning Check: ${code} - hoursUntilInsp=${hoursUntilInspection.toFixed(1)}, threshold=${inspectionWarningThreshold}, warningSent=${!!fleetInfo.mxWarningsSent['inspection_warning_sent']}`);
      
      // Inspection warning - reset flag when leaving danger zone
      if (hoursUntilInspection > inspectionWarningThreshold) {
        // Not in warning zone - reset the flag so it can trigger again next time
        if (fleetInfo.mxWarningsSent['inspection_warning_sent']) {
          debugLog(`Resetting inspection warning flag for ${code}`);
          delete fleetInfo.mxWarningsSent['inspection_warning_sent'];
        }
      } else if (hoursUntilInspection <= inspectionWarningThreshold && hoursUntilInspection > 0) {
        // In warning zone
        if (!fleetInfo.mxWarningsSent['inspection_warning_sent']) {
          debugLog(`SENDING inspection warning for ${code}`);
          addEmail({
            subject: `âš ï¸ Maintenance Due Soon: ${aircraft.name}`,
            from: 'Maintenance Department',
            company: 'Skylift Maintenance',
            body: `Your ${aircraft.name} will require a ${mxData.inspectionInterval}-hour inspection within approximately ${hoursUntilInspection.toFixed(0)} flight hours.\n\nCurrent hours since last inspection: ${(fleetInfo.hoursSinceInspection || 0).toFixed(0)}\nInspection interval: ${mxData.inspectionInterval} hours\n\nPlease schedule maintenance soon to avoid grounding the aircraft.`,
            type: 'alert'
          });
          fleetInfo.mxWarningsSent['inspection_warning_sent'] = true;
          showToast('âš ï¸ MX Warning', `${aircraft.name} inspection due in ${hoursUntilInspection.toFixed(0)} hrs`, 'warning');
        } else {
          debugLog(`Inspection warning already sent for ${code}`);
        }
      }
      
      // Overhaul warning - same pattern
      if (hoursUntilOverhaul > overhaulWarningThreshold) {
        if (fleetInfo.mxWarningsSent['overhaul_warning_sent']) {
          delete fleetInfo.mxWarningsSent['overhaul_warning_sent'];
        }
      } else if (hoursUntilOverhaul <= overhaulWarningThreshold && hoursUntilOverhaul > 0) {
        if (!fleetInfo.mxWarningsSent['overhaul_warning_sent']) {
          debugLog(`SENDING overhaul warning for ${code}`);
          addEmail({
            subject: `âš ï¸ Engine Overhaul Due Soon: ${aircraft.name}`,
            from: 'Maintenance Department',
            company: 'Skylift Maintenance',
            body: `Your ${aircraft.name} will require an engine overhaul within approximately ${hoursUntilOverhaul.toFixed(0)} flight hours.\n\nCurrent hours since last overhaul: ${(fleetInfo.hoursSinceOverhaul || 0).toFixed(0)}\nTBO (Time Between Overhauls): ${mxData.tbo} hours\nEstimated cost: ${formatCurrency(mxData.overhaulCost)}\n\nThis is a major expense - ensure your maintenance reserve is funded.`,
            type: 'alert'
          });
          fleetInfo.mxWarningsSent['overhaul_warning_sent'] = true;
          showToast('âš ï¸ MX Warning', `${aircraft.name} overhaul due in ${hoursUntilOverhaul.toFixed(0)} hrs`, 'warning');
        }
      }
    }
    
    function completeMaintenance(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo?.scheduledMx) return;
      
      const mx = fleetInfo.scheduledMx;
      const mxData = getMxData(code);
      const age = getAircraftAge(code);
      const maxCond = getMaxCondition(age);
      
      // Process all items in the work order
      const items = mx.items || [{ type: mx.type, squawkId: mx.details?.squawkId, targetCondition: mx.details?.actualTarget }];
      const completedDescriptions = [];
      const mechanicsToRelease = new Set(); // Track mechanics to release
      
      for (const item of items) {
        if (item.type === 'inspection') {
          fleetInfo.hoursSinceInspection = 0;
          fleetInfo.lastInspectionDate = { ...S.gameTime };
          fleetInfo.condition = Math.min(maxCond, (fleetInfo.condition || 100) + 2);
          completedDescriptions.push('Inspection');
        } else if (item.type === 'major_service') {
          fleetInfo.hoursSinceMajorService = 0;
          fleetInfo.condition = Math.min(maxCond, (fleetInfo.condition || 100) + 15);
          completedDescriptions.push('Major Service');
        } else if (item.type === 'overhaul') {
          fleetInfo.hoursSinceOverhaul = 0;
          fleetInfo.hoursSinceMajorService = 0;
          fleetInfo.condition = maxCond;
          completedDescriptions.push('Engine Overhaul');
        } else if (item.type === 'repair') {
          fleetInfo.condition = item.targetCondition || Math.min(maxCond, (fleetInfo.condition || 50) + 20);
          completedDescriptions.push('Repair');
        } else if (item.type === 'squawk') {
          if (item.squawkId) {
            fleetInfo.squawks = (fleetInfo.squawks || []).filter(s => s.id !== item.squawkId);
          }
          completedDescriptions.push(item.description || 'Squawk Repair');
        }
        
        // Handle mechanic XP and release
        if (item.mechanicId) {
          const mechanic = S.staff.find(s => s.id === item.mechanicId);
          if (mechanic) {
            awardMechanicXP(mechanic, item.type, item.squawkSeverity);
            mechanicsToRelease.add(item.mechanicId);
          }
        }
      }
      
      // Release all mechanics from this job
      for (const mechanicId of mechanicsToRelease) {
        releaseMechanicFromJob(mechanicId);
      }
      
      // Also handle legacy squawks_all type
      if (mx.type === 'squawks_all' && mx.details?.squawkIds) {
        fleetInfo.squawks = (fleetInfo.squawks || []).filter(s => !mx.details.squawkIds.includes(s.id));
      }
      
      // LOG TO MX HISTORY
      if (!fleetInfo.mxHistory) fleetInfo.mxHistory = [];
      const wasInHouse = items.some(i => i.mechanicId);
      fleetInfo.mxHistory.push({
        date: { ...S.gameTime },
        type: mx.type,
        items: items.map(i => ({ type: i.type, description: i.description })),
        cost: mx.cost,
        laborHours: mx.laborHours,
        use24HrOps: mx.use24HrOps || false,
        inHouse: wasInHouse,
        conditionAfter: Math.round(fleetInfo.condition)
      });
      
      // Update book value based on new condition
      const aircraft = getAircraft(code);
      if (aircraft) {
        fleetInfo.bookValue = calculateListingPrice(code, fleetInfo.year || S.gameTime.year - 5, fleetInfo.condition, fleetInfo.hours || 0, aircraft);
      }
      
      // Clear scheduled MX and update status
      fleetInfo.scheduledMx = null;
      fleetInfo.mxStatus = getMxStatus(code);
      
      // Send completion email
      const itemList = completedDescriptions.length > 1 
        ? completedDescriptions.map(d => 'â€¢ ' + d).join('\n')
        : completedDescriptions[0] || mx.type.replace(/_/g, ' ');
      
      const inHouseNote = wasInHouse ? '\n\nCompleted by in-house mechanic.' : '';
      
      addEmail({
        subject: `Maintenance Complete: ${getAircraft(code)?.name || code}`,
        from: 'Maintenance Department',
        company: 'Skylift Maintenance',
        body: `Your ${getAircraft(code)?.name || code} has completed maintenance.\n\n${completedDescriptions.length > 1 ? 'Completed work:\n' + itemList : 'Completed: ' + itemList}\n\nCurrent condition: ${Math.round(fleetInfo.condition)}%\nThe aircraft is now available for flight.${inHouseNote}`,
        type: 'notification'
      });
      
      saveState();
    }
    
    function applyFlightMxEffects(code, flightHours) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      // Apply condition degradation
      const degradation = calculateConditionDegradation(code, flightHours);
      fleetInfo.condition = Math.max(0, (fleetInfo.condition || 100) - degradation);
      
      // Increment hours counters
      fleetInfo.hoursSinceInspection = (fleetInfo.hoursSinceInspection || 0) + flightHours;
      fleetInfo.hoursSinceOverhaul = (fleetInfo.hoursSinceOverhaul || 0) + flightHours;
      if (getMxData(code).majorServiceCost) {
        fleetInfo.hoursSinceMajorService = (fleetInfo.hoursSinceMajorService || 0) + flightHours;
      }
      
      // Update MX status
      fleetInfo.mxStatus = getMxStatus(code);
      
      // Check if approaching inspection
      const mxData = getMxData(code);
      const hoursUntilInspection = mxData.inspectionInterval - fleetInfo.hoursSinceInspection;
      if (hoursUntilInspection <= 10 && hoursUntilInspection > 0) {
        addEmail({
          subject: `Inspection Due Soon: ${getAircraft(code)?.name || code}`,
          from: 'Maintenance Department',
          body: `Your ${getAircraft(code)?.name || code} requires inspection in ${hoursUntilInspection.toFixed(1)} flight hours.\n\nSchedule maintenance soon to avoid grounding.`,
          type: 'warning'
        });
      }
      
      // Check if inspection overdue
      if (hoursUntilInspection <= 0) {
        fleetInfo.mxStatus = 'grounded';
        addEmail({
          subject: `GROUNDED: Inspection Overdue`,
          from: 'Maintenance Department',
          body: `Your ${getAircraft(code)?.name || code} is GROUNDED due to overdue inspection.\n\nSchedule an inspection immediately to return this aircraft to service.`,
          type: 'alert'
        });
      }
      
      // Update book value
      const aircraft = getAircraft(code);
      if (aircraft) {
        fleetInfo.bookValue = calculateListingPrice(code, fleetInfo.year || S.gameTime.year - 5, fleetInfo.condition, fleetInfo.hours || 0, aircraft);
      }
    }
    
    function getUpcomingMx() {
      const upcoming = [];
      
      for (const code of S.fleet) {
        const fleetInfo = S.fleetData[code];
        if (!fleetInfo) continue;
        
        const mxData = getMxData(code);
        const aircraft = getAircraft(code);
        const name = aircraft?.name || code;
        
        // Currently scheduled
        if (fleetInfo.scheduledMx) {
          upcoming.push({
            code,
            name,
            type: 'scheduled',
            description: fleetInfo.scheduledMx.type.replace('_', ' '),
            dueIn: 'In progress',
            urgency: 'active'
          });
          continue;
        }
        
        // Inspection
        const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
        if (hoursUntilInspection <= 25) {
          upcoming.push({
            code,
            name,
            type: 'inspection',
            description: `${mxData.inspectionInterval}-hour Inspection`,
            dueIn: hoursUntilInspection <= 0 ? 'OVERDUE' : `${hoursUntilInspection.toFixed(0)} hrs`,
            urgency: hoursUntilInspection <= 0 ? 'overdue' : hoursUntilInspection <= 10 ? 'urgent' : 'soon',
            cost: getEffectiveMxCost(mxData.inspectionCost)
          });
        }
        
        // Overhaul
        const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
        if (hoursUntilOverhaul <= 100) {
          upcoming.push({
            code,
            name,
            type: 'overhaul',
            description: 'Engine Overhaul',
            dueIn: hoursUntilOverhaul <= 0 ? 'OVERDUE' : `${hoursUntilOverhaul.toFixed(0)} hrs`,
            urgency: hoursUntilOverhaul <= 0 ? 'overdue' : hoursUntilOverhaul <= 25 ? 'urgent' : 'soon',
            cost: getEffectiveMxCost(mxData.overhaulCost)
          });
        }
        
        // Major service (if applicable)
        if (mxData.majorServiceCost) {
          const majorServiceInterval = mxData.tbo * 0.5;
          const hoursUntilMajor = majorServiceInterval - (fleetInfo.hoursSinceMajorService || 0);
          if (hoursUntilMajor <= 50 && hoursUntilMajor > 0) {
            upcoming.push({
              code,
              name,
              type: 'major_service',
              description: 'Major Service / HSI',
              dueIn: `${hoursUntilMajor.toFixed(0)} hrs`,
              urgency: hoursUntilMajor <= 25 ? 'urgent' : 'soon',
              cost: getEffectiveMxCost(mxData.majorServiceCost)
            });
          }
        }
        
        // Squawks
        for (const squawk of (fleetInfo.squawks || [])) {
          upcoming.push({
            code,
            name,
            type: 'squawk',
            description: squawk.description,
            dueIn: squawk.canDefer ? 'Can defer' : 'GROUNDING',
            urgency: squawk.canDefer ? 'deferred' : 'overdue',
            cost: squawk.cost,
            squawkId: squawk.id
          });
        }
      }
      
      // Sort by urgency
      const urgencyOrder = { overdue: 0, active: 1, urgent: 2, soon: 3, deferred: 4 };
      upcoming.sort((a, b) => (urgencyOrder[a.urgency] || 5) - (urgencyOrder[b.urgency] || 5));
      
      return upcoming;
    }
    
    function initializeFleetMxData(code, options = {}) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const mxData = getMxData(code);
      
      // Set defaults if not present
      if (fleetInfo.hoursSinceInspection === undefined) {
        fleetInfo.hoursSinceInspection = options.hoursSinceInspection || 0;
      }
      if (fleetInfo.hoursSinceOverhaul === undefined) {
        // For purchased aircraft, randomize based on TBO
        if (options.hoursSinceOverhaul !== undefined) {
          fleetInfo.hoursSinceOverhaul = options.hoursSinceOverhaul;
        } else {
          // Random 20-80% through TBO
          fleetInfo.hoursSinceOverhaul = Math.floor(mxData.tbo * (0.2 + Math.random() * 0.6));
        }
      }
      if (fleetInfo.hoursSinceMajorService === undefined) {
        fleetInfo.hoursSinceMajorService = 0;
      }
      if (fleetInfo.mxStatus === undefined) {
        fleetInfo.mxStatus = getMxStatus(code);
      }
      if (fleetInfo.squawks === undefined) {
        fleetInfo.squawks = [];
      }
    }

    function applyRevenueMultiplier(amount, isContract) {
      const multiplier = isContract 
        ? (S.difficultySettings?.contractRevenueMultiplier || 1.0)
        : (S.difficultySettings?.ownedRevenueMultiplier || 1.0);
      return Math.round(amount * multiplier);
    }

    // === LENDER ASSESSMENT TIERS ===
    const LENDER_TIERS = {
      startup: {
        name: 'Startup',
        locLimit: 10000,
        loanApr: 0.12,
        downPayment: 0.30,
        maxFinance: 150000,
        requirements: { monthsInBusiness: 0 }
      },
      developing: {
        name: 'Developing',
        locLimit: 50000,
        loanApr: 0.10,
        downPayment: 0.25,
        maxFinance: 500000,
        requirements: { monthsInBusiness: 6, dscr: 1.0, missedPaymentsMax: 2 }
      },
      established: {
        name: 'Established',
        locLimit: 150000,
        loanApr: 0.08,
        downPayment: 0.20,
        maxFinance: 2000000,
        requirements: { monthsInBusiness: 12, dscr: 1.25, leverageMax: 3.0 }
      },
      strong: {
        name: 'Strong',
        locLimit: 500000,
        loanApr: 0.06,
        downPayment: 0.15,
        maxFinance: 5000000,
        requirements: { monthsInBusiness: 24, dscr: 1.5, leverageMax: 2.0 }
      },
      premier: {
        name: 'Premier',
        locLimit: 1000000,
        loanApr: 0.05,
        downPayment: 0.10,
        maxFinance: 10000000,
        requirements: { monthsInBusiness: 36, dscr: 1.75, leverageMax: 1.5, missedPaymentsMax: 0 }
      }
    };

    // === STARTING SCENARIOS ===
    const STARTING_SCENARIOS = {
      inheritance: {
        name: "The Inheritance",
        icon: "ðŸ”§",
        difficulty: "easy",
        difficultyLabel: "Scrappy Start",
        description: "Your uncle left you his plane and a little cash. Time to see if you can turn this into something.",
        cash: 5000,
        locLimit: 25000,  // Has unencumbered collateral
        locBalance: 0,
        locApr: 0.12,     // Startup rate
        ownerSalary: 4000,
        aircraftOptions: [
          { code: "C172_SKYHAWK", name: "1978 Cessna 172 Skyhawk", condition: 65, year: 1978, hours: 3500 },
          { code: "DV20", name: "2002 Diamond Katana", condition: 65, year: 2002, hours: 2800 },
          { code: "CTSL", name: "2012 Flight Design CTLS", condition: 88, year: 2012, hours: 1200 }
        ],
        hasAircraft: true,
        hasLoan: false
      },
      rotorhead: {
        name: "The Rotorhead",
        icon: "ðŸš",
        difficulty: "medium",
        difficultyLabel: "Helicopter Start",
        description: "Eight years on Blackhawks. Now you're out with a used R66 and a plan.",
        cash: 15000,
        locLimit: 10000,
        locBalance: 0,
        locApr: 0.12,
        ownerSalary: 4000,
        aircraftOptions: [
          { code: "R66", name: "2018 Robinson R66 Turbine", condition: 78, year: 2018, hours: 920 }
        ],
        hasAircraft: true,
        hasLoan: false,
        startingHours: 1500,
        startingRatings: ['helicopter'],
        startingCertifications: ['private', 'commercial']
      },
      bootstrap: {
        name: "The Bootstrap",
        icon: "ðŸ’¼",
        difficulty: "medium",
        difficultyLabel: "Balanced",
        description: "You've saved up, done your research, and you're ready to buy your first aircraft. Choices matter here.",
        cash: 35000,
        locLimit: 10000,  // No collateral - limited credit
        locBalance: 0,
        locApr: 0.12,     // Startup rate
        ownerSalary: 4000,
        aircraftOptions: [],
        hasAircraft: false,
        hasLoan: false
      },
      leveraged: {
        name: "The Leveraged Launch",
        icon: "ðŸ“ˆ",
        difficulty: "hard",
        difficultyLabel: "Growth Pressure",
        description: "Angel investors believe in you. You've got a newer plane, connections, and debt. Time to perform.",
        cash: 20000,
        locLimit: 15000,  // Already heavily leveraged
        locBalance: 0,
        locApr: 0.12,     // Startup rate
        ownerSalary: 4000,
        aircraftOptions: [
          { code: "DA40_NG", name: "2016 Diamond DA40 NG", condition: 76, year: 2016, hours: 1400, loanAmount: 452000 },
          { code: "SR22", name: "2010 Cirrus SR22", condition: 58, year: 2010, hours: 2200, loanAmount: 453000 },
          { code: "CORVALIS", name: "2014 Cessna Corvalis TTx", condition: 73, year: 2014, hours: 1800, loanAmount: 450000 }
        ],
        hasAircraft: true,
        hasLoan: true
      },
      custom: {
        name: "Custom Scenario",
        icon: "âš™ï¸",
        difficulty: "custom",
        difficultyLabel: "Your Rules",
        description: "Set every parameter yourself. Build the exact challenge you want.",
        cash: 25000,
        locLimit: 25000,
        locBalance: 0,
        locApr: 0.06,
        ownerSalary: 4000,
        aircraftOptions: [],
        hasAircraft: false,
        hasLoan: false
      }
    };

    // === TIME PERIODS ===
    const TIME_PERIODS = {
      dawn: { start: 5, end: 7 },
      day: { start: 7, end: 18 },
      dusk: { start: 18, end: 20 },
      night: { start: 20, end: 5 }  // Wraps around midnight
    };

    // === WEATHER CATEGORIES ===
    const WEATHER_CATEGORIES = {
      VFR: ["Clear Skies", "Few Clouds", "Fair Weather", "Scattered Clouds"],
      MVFR: ["Broken Clouds", "Haze"],
      IFR: ["Overcast", "Light Rain", "Light Snow"],
      LIFR: ["Rain Showers", "Thunderstorms", "Heavy Snow", "Fog"]
    };

    // All weather presets combined
    const ALL_WEATHER = [
      ...WEATHER_CATEGORIES.VFR,
      ...WEATHER_CATEGORIES.MVFR,
      ...WEATHER_CATEGORIES.IFR,
      ...WEATHER_CATEGORIES.LIFR
    ];

    // === REGIONAL WEATHER PROFILES ===
    // Maps states to weather regions
    const STATE_TO_REGION = {
      // Pacific Northwest
      WA: 'pacific_nw', OR: 'pacific_nw',
      // California
      CA: 'california',
      // Southwest
      AZ: 'southwest', NM: 'southwest', NV: 'southwest', UT: 'southwest',
      // Mountain
      CO: 'mountain', WY: 'mountain', MT: 'mountain', ID: 'mountain',
      // Great Plains
      TX: 'great_plains', OK: 'great_plains', KS: 'great_plains', NE: 'great_plains', 
      SD: 'great_plains', ND: 'great_plains',
      // Midwest
      MN: 'midwest', WI: 'midwest', IL: 'midwest', MI: 'midwest', IN: 'midwest',
      OH: 'midwest', IA: 'midwest', MO: 'midwest',
      // Southeast
      FL: 'southeast', GA: 'southeast', AL: 'southeast', MS: 'southeast', LA: 'southeast',
      SC: 'southeast', NC: 'southeast', TN: 'southeast', AR: 'southeast', KY: 'southeast',
      // Northeast
      ME: 'northeast', NH: 'northeast', VT: 'northeast', MA: 'northeast', RI: 'northeast',
      CT: 'northeast', NY: 'northeast', NJ: 'northeast', PA: 'northeast', DE: 'northeast',
      MD: 'northeast', VA: 'northeast', WV: 'northeast', DC: 'northeast',
      // Alaska
      AK: 'alaska',
      // Hawaii
      HI: 'hawaii'
    };
    
    // Weather weights by region and month (1-12)
    // Format: { VFR: weight, MVFR: weight, IFR: weight, LIFR: weight }
    // Higher weight = more likely. IFR mission probability scales with IFR+LIFR weight.
    const REGIONAL_WEATHER = {
      pacific_nw: {
        // Rainy winters, dry summers
        1:  { VFR: 15, MVFR: 30, IFR: 40, LIFR: 15 },  // Jan - very wet
        2:  { VFR: 20, MVFR: 30, IFR: 35, LIFR: 15 },
        3:  { VFR: 30, MVFR: 30, IFR: 30, LIFR: 10 },
        4:  { VFR: 40, MVFR: 30, IFR: 20, LIFR: 10 },
        5:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        6:  { VFR: 65, MVFR: 20, IFR: 12, LIFR: 3 },
        7:  { VFR: 80, MVFR: 12, IFR: 6, LIFR: 2 },   // Jul - dry
        8:  { VFR: 80, MVFR: 12, IFR: 6, LIFR: 2 },
        9:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        10: { VFR: 35, MVFR: 30, IFR: 25, LIFR: 10 },
        11: { VFR: 20, MVFR: 30, IFR: 35, LIFR: 15 },
        12: { VFR: 15, MVFR: 30, IFR: 40, LIFR: 15 }
      },
      california: {
        // Mediterranean - coastal fog, dry inland
        1:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        2:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        3:  { VFR: 55, MVFR: 25, IFR: 15, LIFR: 5 },
        4:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        5:  { VFR: 60, MVFR: 25, IFR: 10, LIFR: 5 },  // May gray
        6:  { VFR: 55, MVFR: 30, IFR: 10, LIFR: 5 },  // June gloom
        7:  { VFR: 75, MVFR: 15, IFR: 7, LIFR: 3 },
        8:  { VFR: 80, MVFR: 12, IFR: 5, LIFR: 3 },
        9:  { VFR: 85, MVFR: 10, IFR: 3, LIFR: 2 },
        10: { VFR: 80, MVFR: 12, IFR: 5, LIFR: 3 },
        11: { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        12: { VFR: 55, MVFR: 25, IFR: 15, LIFR: 5 }
      },
      southwest: {
        // Hot and dry, summer monsoons
        1:  { VFR: 75, MVFR: 15, IFR: 7, LIFR: 3 },
        2:  { VFR: 75, MVFR: 15, IFR: 7, LIFR: 3 },
        3:  { VFR: 80, MVFR: 12, IFR: 5, LIFR: 3 },
        4:  { VFR: 85, MVFR: 10, IFR: 3, LIFR: 2 },
        5:  { VFR: 90, MVFR: 7, IFR: 2, LIFR: 1 },
        6:  { VFR: 85, MVFR: 10, IFR: 3, LIFR: 2 },
        7:  { VFR: 60, MVFR: 20, IFR: 12, LIFR: 8 },  // Monsoon
        8:  { VFR: 60, MVFR: 20, IFR: 12, LIFR: 8 },  // Monsoon
        9:  { VFR: 75, MVFR: 15, IFR: 7, LIFR: 3 },
        10: { VFR: 85, MVFR: 10, IFR: 3, LIFR: 2 },
        11: { VFR: 80, MVFR: 12, IFR: 5, LIFR: 3 },
        12: { VFR: 75, MVFR: 15, IFR: 7, LIFR: 3 }
      },
      mountain: {
        // Snow in winter, afternoon thunderstorms in summer
        1:  { VFR: 40, MVFR: 25, IFR: 25, LIFR: 10 },
        2:  { VFR: 40, MVFR: 25, IFR: 25, LIFR: 10 },
        3:  { VFR: 45, MVFR: 25, IFR: 22, LIFR: 8 },
        4:  { VFR: 55, MVFR: 25, IFR: 15, LIFR: 5 },
        5:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        6:  { VFR: 65, MVFR: 18, IFR: 12, LIFR: 5 },  // PM storms
        7:  { VFR: 60, MVFR: 20, IFR: 14, LIFR: 6 },  // PM storms
        8:  { VFR: 60, MVFR: 20, IFR: 14, LIFR: 6 },
        9:  { VFR: 70, MVFR: 18, IFR: 9, LIFR: 3 },
        10: { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        11: { VFR: 45, MVFR: 25, IFR: 22, LIFR: 8 },
        12: { VFR: 40, MVFR: 25, IFR: 25, LIFR: 10 }
      },
      great_plains: {
        // Severe spring storms, temperature extremes
        1:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        2:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        3:  { VFR: 45, MVFR: 25, IFR: 20, LIFR: 10 },
        4:  { VFR: 40, MVFR: 25, IFR: 22, LIFR: 13 },  // Storm season
        5:  { VFR: 40, MVFR: 25, IFR: 22, LIFR: 13 },  // Storm season
        6:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        7:  { VFR: 70, MVFR: 18, IFR: 9, LIFR: 3 },
        8:  { VFR: 70, MVFR: 18, IFR: 9, LIFR: 3 },
        9:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        10: { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 },
        11: { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        12: { VFR: 45, MVFR: 27, IFR: 20, LIFR: 8 }
      },
      midwest: {
        // Four seasons, lake effect, cold winters
        1:  { VFR: 30, MVFR: 30, IFR: 28, LIFR: 12 },
        2:  { VFR: 30, MVFR: 30, IFR: 28, LIFR: 12 },
        3:  { VFR: 40, MVFR: 28, IFR: 22, LIFR: 10 },
        4:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        5:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        6:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        7:  { VFR: 70, MVFR: 18, IFR: 9, LIFR: 3 },
        8:  { VFR: 70, MVFR: 18, IFR: 9, LIFR: 3 },
        9:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        10: { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        11: { VFR: 35, MVFR: 28, IFR: 25, LIFR: 12 },
        12: { VFR: 30, MVFR: 30, IFR: 28, LIFR: 12 }
      },
      southeast: {
        // Humid, afternoon storms, hurricanes
        1:  { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 },
        2:  { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 },
        3:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        4:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        5:  { VFR: 60, MVFR: 22, IFR: 12, LIFR: 6 },
        6:  { VFR: 55, MVFR: 22, IFR: 15, LIFR: 8 },  // Storms
        7:  { VFR: 50, MVFR: 25, IFR: 17, LIFR: 8 },  // Storms
        8:  { VFR: 50, MVFR: 25, IFR: 17, LIFR: 8 },  // Hurricane season
        9:  { VFR: 50, MVFR: 25, IFR: 17, LIFR: 8 },  // Hurricane season
        10: { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        11: { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        12: { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 }
      },
      northeast: {
        // Nor'easters, cold winters, variable
        1:  { VFR: 25, MVFR: 30, IFR: 30, LIFR: 15 },
        2:  { VFR: 25, MVFR: 30, IFR: 30, LIFR: 15 },
        3:  { VFR: 35, MVFR: 28, IFR: 25, LIFR: 12 },
        4:  { VFR: 45, MVFR: 28, IFR: 20, LIFR: 7 },
        5:  { VFR: 55, MVFR: 25, IFR: 15, LIFR: 5 },
        6:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        7:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        8:  { VFR: 65, MVFR: 20, IFR: 10, LIFR: 5 },
        9:  { VFR: 60, MVFR: 22, IFR: 13, LIFR: 5 },
        10: { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        11: { VFR: 35, MVFR: 28, IFR: 25, LIFR: 12 },
        12: { VFR: 25, MVFR: 30, IFR: 30, LIFR: 15 }
      },
      alaska: {
        // Extreme cold, challenging conditions
        1:  { VFR: 20, MVFR: 25, IFR: 35, LIFR: 20 },
        2:  { VFR: 25, MVFR: 25, IFR: 32, LIFR: 18 },
        3:  { VFR: 30, MVFR: 28, IFR: 28, LIFR: 14 },
        4:  { VFR: 40, MVFR: 28, IFR: 22, LIFR: 10 },
        5:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        6:  { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 },
        7:  { VFR: 55, MVFR: 25, IFR: 14, LIFR: 6 },
        8:  { VFR: 50, MVFR: 25, IFR: 18, LIFR: 7 },
        9:  { VFR: 40, MVFR: 28, IFR: 22, LIFR: 10 },
        10: { VFR: 30, MVFR: 28, IFR: 28, LIFR: 14 },
        11: { VFR: 22, MVFR: 26, IFR: 34, LIFR: 18 },
        12: { VFR: 20, MVFR: 25, IFR: 35, LIFR: 20 }
      },
      hawaii: {
        // Tropical, trade winds, consistent
        1:  { VFR: 60, MVFR: 25, IFR: 10, LIFR: 5 },
        2:  { VFR: 60, MVFR: 25, IFR: 10, LIFR: 5 },
        3:  { VFR: 65, MVFR: 22, IFR: 9, LIFR: 4 },
        4:  { VFR: 70, MVFR: 20, IFR: 7, LIFR: 3 },
        5:  { VFR: 75, MVFR: 17, IFR: 5, LIFR: 3 },
        6:  { VFR: 80, MVFR: 14, IFR: 4, LIFR: 2 },
        7:  { VFR: 80, MVFR: 14, IFR: 4, LIFR: 2 },
        8:  { VFR: 80, MVFR: 14, IFR: 4, LIFR: 2 },
        9:  { VFR: 75, MVFR: 17, IFR: 5, LIFR: 3 },
        10: { VFR: 70, MVFR: 20, IFR: 7, LIFR: 3 },
        11: { VFR: 65, MVFR: 22, IFR: 9, LIFR: 4 },
        12: { VFR: 60, MVFR: 25, IFR: 10, LIFR: 5 }
      }
    };
    
    // Get region for an airport
    function getAirportRegion(icao) {
      const airport = AIRPORTS[icao];
      if (!airport) return 'midwest'; // Default
      const state = airport.state || airport.region;
      return STATE_TO_REGION[state] || 'midwest';
    }
    
    // Get weighted random weather for a region and month
    function getRegionalWeather(region, month, latitude = null) {
      const profile = REGIONAL_WEATHER[region]?.[month] || REGIONAL_WEATHER.midwest[month];
      
      // Latitude-based snow check for global airports
      // Snow is rare below 30Â° latitude (tropical/subtropical)
      // Exception: Southern hemisphere has reversed seasons
      const absLatitude = Math.abs(latitude || 45); // Default to mid-latitude if not provided
      const isSouthernHemisphere = latitude !== null && latitude < 0;
      
      // Adjust month for southern hemisphere (opposite seasons)
      const effectiveMonth = isSouthernHemisphere ? ((month + 5) % 12) + 1 : month;
      
      // No snow below 30Â° latitude (tropics never get snow at sea level)
      const latitudeAllowsSnow = absLatitude >= 30;
      
      // Seasonal restrictions - filter out inappropriate weather
      const seasonalExclusions = {
        // Snow only in cold months (Nov-Mar for most regions, Oct-Apr for mountain/alaska)
        snowMonths: {
          pacific_nw: [11, 12, 1, 2, 3],
          california: [12, 1, 2],  // Only high elevations
          southwest: [],  // Almost never
          mountain: [10, 11, 12, 1, 2, 3, 4],
          great_plains: [11, 12, 1, 2, 3],
          midwest: [11, 12, 1, 2, 3],
          southeast: [12, 1, 2],  // Rare
          northeast: [11, 12, 1, 2, 3, 4],
          alaska: [9, 10, 11, 12, 1, 2, 3, 4, 5],  // Long winter
          hawaii: []  // Never
        },
        // Thunderstorms more common in warm months
        thunderstormMonths: {
          pacific_nw: [5, 6, 7, 8, 9],
          california: [7, 8, 9],  // Monsoon spillover
          southwest: [6, 7, 8, 9],  // Monsoon season
          mountain: [5, 6, 7, 8, 9],
          great_plains: [3, 4, 5, 6, 7, 8, 9, 10],  // Long storm season
          midwest: [4, 5, 6, 7, 8, 9],
          southeast: [3, 4, 5, 6, 7, 8, 9, 10],  // Long season
          northeast: [5, 6, 7, 8, 9],
          alaska: [6, 7, 8],
          hawaii: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]  // Year-round possible
        }
      };
      
      // Snow requires both: latitude >= 30Â° AND appropriate season for region
      const seasonalSnowAllowed = seasonalExclusions.snowMonths[region]?.includes(effectiveMonth) ?? 
        // For unknown regions, allow snow in winter months at high latitudes
        (absLatitude >= 35 && [11, 12, 1, 2, 3].includes(effectiveMonth));
      const snowAllowed = latitudeAllowsSnow && seasonalSnowAllowed;
      const thunderstormsAllowed = seasonalExclusions.thunderstormMonths[region]?.includes(month) ?? true;
      
      // Build weighted array with seasonal filtering
      const weighted = [];
      Object.entries(profile).forEach(([category, weight]) => {
        const conditions = WEATHER_CATEGORIES[category] || [];
        conditions.forEach(condition => {
          // Skip snow if not snow season
          if (!snowAllowed && (condition === 'Light Snow' || condition === 'Heavy Snow')) {
            return;
          }
          // Skip thunderstorms if not storm season
          if (!thunderstormsAllowed && condition === 'Thunderstorms') {
            return;
          }
          for (let i = 0; i < weight; i++) {
            weighted.push(condition);
          }
        });
      });
      
      return weighted[Math.floor(Math.random() * weighted.length)] || "Fair Weather";
    }
    
    // Get IFR mission probability for a region and month (0-1)
    function getRegionalIfrProbability(region, month) {
      const profile = REGIONAL_WEATHER[region]?.[month] || REGIONAL_WEATHER.midwest[month];
      const totalWeight = profile.VFR + profile.MVFR + profile.IFR + profile.LIFR;
      const ifrWeight = profile.IFR + profile.LIFR;
      // Base IFR mission probability scales with weather, capped at 40%
      return Math.min(0.40, (ifrWeight / totalWeight) * 0.8);
    }

    // === PROGRESSION GATES ===
    // Hours required to unlock each certificate/rating checkride
    const PROGRESSION_GATES = {
      // Certificates - require hours
      student:    { hours: 0,   type: 'certificate', name: 'Student Pilot', description: 'Training flights only' },
      private:    { hours: 40,  type: 'certificate', name: 'Private Pilot', description: 'Passengers, VFR, expense-sharing flights' },
      commercial: { hours: 80,  type: 'certificate', name: 'Commercial Pilot', description: 'Full commercial operations' },
      atp:        { hours: 300, type: 'certificate', name: 'Airline Transport Pilot', description: 'Airline and heavy aircraft' },
      // Ratings - require Private Pilot (except turbine requires Commercial)
      night:      { hours: 0, requires: 'private', type: 'rating', name: 'Night Rating', description: 'Flight between sunset and sunrise' },
      instrument: { hours: 0, requires: 'private', type: 'rating', name: 'Instrument Rating', description: 'IFR conditions' },
      multiEngine:{ hours: 0, requires: 'private', type: 'rating', name: 'Multi-Engine Rating', description: 'Twin-engine aircraft' },
      seaplane:   { hours: 0, requires: 'private', type: 'rating', name: 'Seaplane Rating', description: 'Water operations' },
      helicopter: { hours: 0, requires: 'private', type: 'rating', name: 'Helicopter Rating', description: 'Rotorcraft operations' },
      turbine:    { hours: 0, requires: 'commercial', type: 'rating', name: 'Turbine Rating', description: 'Turboprop and jet aircraft' }
    };
    
    // DPE (Designated Pilot Examiner) names for checkride emails
    const EXAMINERS = [
      { name: 'Robert Chen', id: 'DPE-2847561' },
      { name: 'Patricia Morrison', id: 'DPE-3291847' },
      { name: 'James Whitfield', id: 'DPE-1958274' },
      { name: 'Maria Santos', id: 'DPE-4782910' },
      { name: 'David Kowalski', id: 'DPE-2019384' }
    ];
    
    // Company name suggestions for new businesses
    const COMPANY_NAME_PREFIXES = [
      'Blue Sky', 'Horizon', 'Summit', 'Trailwind', 'Ridgeline', 'Clearwater', 'Northstar',
      'Ironwood', 'Redtail', 'Tailwind', 'Windward', 'Skybridge', 'Aero', 'Crosswind',
      'Highpoint', 'Lakeview', 'Valley', 'Prairie', 'Coastal', 'Mountain', 'River',
      'Eagle', 'Falcon', 'Hawk', 'Cardinal', 'Osprey', 'Kingfisher'
    ];
    
    const COMPANY_NAME_SUFFIXES = [
      'Aviation', 'Air', 'Air Services', 'Flight Services', 'Aero', 'Airways',
      'Air Charter', 'Flying Service', 'Aviation Services'
    ];
    
    function generateCompanyName() {
      const prefix = COMPANY_NAME_PREFIXES[Math.floor(Math.random() * COMPANY_NAME_PREFIXES.length)];
      const suffix = COMPANY_NAME_SUFFIXES[Math.floor(Math.random() * COMPANY_NAME_SUFFIXES.length)];
      return `${prefix} ${suffix}`;
    }

    // === MISSION TYPE DEFINITIONS ===
    // structure: "round_trip" | "out_and_back" | "point_to_point" | "waypoint" | "ferry"
    // time: "day" | "day_dusk" | "any"
    // weather: "VFR" | "MVFR" | "BY_AVIONICS" | "ANY"
    // payload: "passengers" | "cargo" | "both" | "none"
    // tier: "starter" | "intermediate" | "advanced"
    // destType: "airport" | "waypoint" | "water" | "short_field" | "any"
    const MISSION_TYPES = {
      "Sightseeing Tour": {
        structure: "waypoint",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "waypoint",
        baseMinutes: 60,
        onSiteMinutes: 15,
        description: "Scenic flight to landmark destination",
        waypointProfile: {
          altitudeAGL: 1500,
          speedMin: 80,
          speedMax: 120,
          pattern: "orbit",
          durationMinutes: 15
        }
      },
      "Discovery Flight": {
        structure: "waypoint",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "waypoint",
        baseMinutes: 90,
        onSiteMinutes: 10,
        description: "Introductory flight to scenic destination",
        waypointProfile: {
          altitudeAGL: 2000,
          speedMin: 80,
          speedMax: 100,
          pattern: "orbit",
          durationMinutes: 10
        }
      },
      "Heli Tour": {
        structure: "waypoint",
        category: "helicopter",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "waypoint",
        baseMinutes: 30,
        onSiteMinutes: 10,
        distanceRange: [5, 25],
        description: "Helicopter tour to landmark",
        waypointProfile: {
          altitudeAGL: 1000,
          speedMin: 60,
          speedMax: 100,
          pattern: "orbit",
          durationMinutes: 10
        }
      },
      "Training Flight": {
        structure: "round_trip",
        time: "day_dusk",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "airport",
        baseMinutes: 90,
        description: "Flight training with student pilot"
      },
      "Aerial Photography": {
        structure: "waypoint",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "waypoint",
        baseMinutes: 60,
        onSiteMinutes: 15,
        description: "Fly to location and photograph target",
        waypointProfile: {
          altitudeAGL: 1500,
          speedMin: 80,
          speedMax: 100,
          pattern: "orbit",
          durationMinutes: 10
        }
      },
      "Aerial Survey": {
        structure: "waypoint",
        time: "day",
        weather: "MVFR",
        payload: "passengers",
        tier: "starter",
        destType: "waypoint",
        baseMinutes: 90,
        onSiteMinutes: 20,
        description: "Systematic survey of target area",
        waypointProfile: {
          altitudeAGL: 500,
          speedMin: 70,
          speedMax: 90,
          pattern: "grid",
          durationMinutes: 15
        }
      },
      "Thrill Flight": {
        structure: "round_trip",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "starter",
        destType: "airport",
        baseMinutes: 45,
        description: "Aerobatic experience flight"
      },
      "General Cargo": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "cargo",
        tier: "starter",
        destType: "airport",
        distanceRange: [75, 800],
        description: "Standard cargo transport"
      },
      "Mail Run": {
        structure: "out_and_back",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "cargo",
        tier: "starter",
        destType: "airport",
        maxCargoLbs: 200,
        distanceRange: [30, 200],
        description: "Mail and small package delivery"
      },
      "Charter Flight": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "passengers",
        tier: "starter",
        destType: "airport",
        distanceRange: [100, 600],
        description: "On-demand passenger transport"
      },
      "Heli Charter": {
        structure: "point_to_point",
        category: "helicopter",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "passengers",
        tier: "starter",
        destType: "airport",
        distanceRange: [10, 60],
        description: "Helicopter passenger transport"
      },
      "Bush Resupply": {
        structure: "point_to_point",
        time: "day",
        weather: "MVFR",
        payload: "cargo",
        tier: "starter",
        destType: "short_field",
        description: "Cargo delivery to remote strip"
      },
      "Executive Transport": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "passengers",
        tier: "intermediate",
        destType: "airport",
        minRunway: 4000,
        distanceRange: [150, 1200],
        description: "VIP passenger transport"
      },
      "Freight Haul": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "cargo",
        tier: "intermediate",
        destType: "airport",
        distanceRange: [100, 1000],
        description: "Heavy cargo transport"
      },
      "Island Hopping": {
        structure: "point_to_point",
        time: "day",
        weather: "MVFR",
        payload: "both",
        tier: "intermediate",
        destType: "water",
        description: "Coastal and island transport"
      },
      "Medical Transfer": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "passengers",
        tier: "intermediate",
        destType: "airport",
        distanceRange: [50, 400],
        description: "Non-emergency patient transport"
      },
      "Search Support": {
        structure: "waypoint",
        time: "day_dusk",
        weather: "MVFR",
        payload: "passengers",
        tier: "intermediate",
        destType: "waypoint",
        baseMinutes: 120,
        onSiteMinutes: 60,
        description: "Aerial search assistance",
        waypointProfile: {
          altitudeAGL: 500,
          speedMin: 60,
          speedMax: 80,
          pattern: "grid",
          durationMinutes: 45
        }
      },
      "Airshow Aerobatics": {
        structure: "round_trip",
        time: "day",
        weather: "VFR",
        payload: "none",
        tier: "intermediate",
        destType: "airport",
        minRunway: 3000,
        baseMinutes: 45,
        description: "Solo aerobatic demonstration"
      },
      "Airshow Rides": {
        structure: "round_trip",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "intermediate",
        destType: "airport",
        minRunway: 3000,
        baseMinutes: 30,
        description: "Aerobatic passenger rides at airshow"
      },
      "Historical Flight": {
        structure: "round_trip",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "intermediate",
        destType: "airport",
        baseMinutes: 60,
        description: "Warbird experience flight"
      },
      "Humanitarian": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "cargo",
        tier: "intermediate",
        destType: "any",
        description: "Aid and relief supply delivery"
      },
      "Ferry Flight": {
        structure: "ferry",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "none",
        tier: "intermediate",
        destType: "airport",
        maxPickupDistance: 200,
        description: "Aircraft repositioning flight"
      },
      "Air Ambulance": {
        structure: "point_to_point",
        time: "any",
        weather: "ANY",
        payload: "passengers",
        tier: "advanced",
        destType: "airport",
        isEmergency: true,
        description: "Emergency patient transport"
      },
      "Organ Transport": {
        structure: "point_to_point",
        time: "any",
        weather: "ANY",
        payload: "cargo",
        tier: "advanced",
        destType: "airport",
        isEmergency: true,
        maxCargoLbs: 50,
        description: "Time-critical organ delivery"
      },
      "CASEVAC": {
        structure: "point_to_point",
        time: "any",
        weather: "ANY",
        payload: "passengers",
        tier: "advanced",
        destType: "short_field",
        isEmergency: true,
        description: "Casualty evacuation from remote location"
      },
      "Heli EMS": {
        structure: "heli_scene",
        category: "helicopter",
        time: "any",
        weather: "ANY",
        payload: "passengers",
        tier: "professional",
        destType: "heliport_medical",
        isEmergency: true,
        distanceRange: [5, 40],
        onSceneMinutes: 8,
        description: "Emergency medical scene response",
        briefingTemplates: [
          "Respond to scene coordinates. Land at pilot's discretion, then transport to {destination}.",
          "MVA reported at coordinates. Assess scene, transport patient to trauma center.",
          "Medical emergency at remote location. Secure landing zone, transport to {destination}."
        ]
      },
      "Heli SAR": {
        structure: "waypoint",
        category: "helicopter",
        time: "any",
        weather: "ANY",
        payload: "passengers",
        tier: "advanced",
        destType: "waypoint",
        isEmergency: true,
        baseMinutes: 90,
        onSiteMinutes: 30,
        distanceRange: [10, 40],
        description: "Search and rescue operation",
        waypointProfile: {
          altitudeAGL: 200,
          speedMin: 40,
          speedMax: 60,
          pattern: "expanding_square",
          durationMinutes: 20,
          action: "Search 2nm radius. If target located, land within 0.25nm for extraction"
        }
      },
      "Hospital Transfer": {
        structure: "heli_transfer",
        category: "helicopter",
        time: "any",
        weather: "VFR",
        payload: "passengers",
        tier: "professional",
        destType: "heliport_medical",
        distanceRange: [15, 60],
        description: "Inter-facility patient transfer",
        briefingTemplates: [
          "Patient transfer to {destination}. Stable patient, routine transport.",
          "Medical transfer required. Patient ready for transport upon arrival.",
          "Inter-hospital transfer. Coordinate with medical staff on arrival."
        ]
      },
      "Executive Shuttle": {
        structure: "heli_transfer",
        category: "helicopter",
        time: "day",
        weather: "VFR",
        payload: "passengers",
        tier: "corporate",
        destType: "heliport_corporate",
        distanceRange: [10, 50],
        description: "VIP transport between facilities",
        briefingTemplates: [
          "Executive transport to {destination}. Passenger prefers smooth flight.",
          "VIP shuttle service. Client meeting scheduled, on-time arrival critical.",
          "Corporate transport request. Discretion appreciated."
        ]
      },
      "Airport Connect": {
        structure: "heli_connect",
        category: "helicopter",
        time: "any",
        weather: "VFR",
        payload: "passengers",
        tier: "regional",
        destType: "heliport",
        distanceRange: [5, 30],
        description: "Last-mile connection from airport to destination",
        briefingTemplates: [
          "Airport connection service. Passenger arriving on commercial flight.",
          "Transfer from {origin} to downtown helipad. Business traveler.",
          "Airport pickup requested. Transport to {destination}."
        ]
      },
      "Hazmat Transport": {
        structure: "point_to_point",
        time: "day",
        weather: "MVFR",
        payload: "cargo",
        tier: "advanced",
        destType: "airport",
        minRunway: 4000,
        description: "Hazardous materials transport"
      },
      "Part 135 On-Demand": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "passengers",
        tier: "advanced",
        destType: "airport",
        description: "Scheduled charter service"
      },
      "Custom Flight": {
        structure: "point_to_point",
        time: "any",
        weather: "BY_AVIONICS",
        payload: "both",
        tier: "starter",
        destType: "airport",
        description: "Player-created custom flight"
      }
    };

    // === SURFACE NORMALIZATION ===
    // Maps airport surface codes to aircraft-compatible surface types
    function normalizeSurface(airportSurface) {
      if (!airportSurface) return 'unknown';
      const s = airportSurface.toLowerCase();
      
      // Paved surfaces
      if (s.includes('asp') || s.includes('asphalt') || s.includes('con') || 
          s.includes('pem') || s.includes('bit') || s.includes('tar') ||
          s === 'paved' || s.includes('blacktop')) {
        return 'paved';
      }
      
      // Grass/turf surfaces
      if (s.includes('turf') || s.includes('grass') || s.includes('grs') || 
          s.includes('sod') || s.includes('lawn')) {
        return 'grass';
      }
      
      // Gravel surfaces
      if (s.includes('gravel') || s.includes('grvl') || s.includes('gvl') || 
          s.includes('gre') || s.includes('stone')) {
        return 'gravel';
      }
      
      // Dirt surfaces
      if (s.includes('dirt') || s.includes('earth') || s.includes('clay') ||
          s.includes('sand') || s.includes('soil')) {
        return 'dirt';
      }
      
      // Water
      if (s.includes('water') || s.includes('sea') || s.includes('lake')) {
        return 'water';
      }
      
      // Snow/ice
      if (s.includes('snow') || s.includes('ice')) {
        return 'snow';
      }
      
      // Default to paved if unrecognized (safe assumption for most airports)
      return 'paved';
    }

    // === HELPER FUNCTIONS FOR MISSION GENERATION ===
    
    // Check if airport is suitable for aircraft
    function isAirportSuitable(airport, aircraft, missionType) {
      // Get runway info (use first/longest runway)
      const runway = airport.runways && airport.runways[0];
      if (!runway) return false;
      
      // Check runway length
      const requiredLength = aircraft.runway_required || 0;
      const missionMinRunway = MISSION_TYPES[missionType]?.minRunway || 0;
      const minRequired = Math.max(requiredLength, missionMinRunway);
      if (runway.length < minRequired) return false;
      
      // Check surface compatibility
      const normalizedSurface = normalizeSurface(runway.surface);
      const aircraftSurfaces = aircraft.surfaces || ['paved'];
      if (!aircraftSurfaces.includes(normalizedSurface)) return false;
      
      return true;
    }
    
    // Get weather options based on mission and aircraft
    function getWeatherOptions(missionType, aircraft) {
      const mission = MISSION_TYPES[missionType];
      if (!mission) return WEATHER_CATEGORIES.VFR;
      
      const weatherRestriction = mission.weather;
      const avionics = aircraft.avionics || 'VFR';
      
      if (weatherRestriction === 'VFR') {
        return WEATHER_CATEGORIES.VFR;
      }
      
      if (weatherRestriction === 'MVFR') {
        // Weight toward MVFR conditions for variety
        return [...WEATHER_CATEGORIES.VFR, ...WEATHER_CATEGORIES.MVFR, ...WEATHER_CATEGORIES.MVFR];
      }
      
      if (weatherRestriction === 'BY_AVIONICS') {
        if (avionics === 'VFR') {
          return WEATHER_CATEGORIES.VFR;
        } else if (avionics === 'IFR' || avionics === 'GPS') {
          // Weight toward varied weather - double MVFR and IFR options
          return [
            ...WEATHER_CATEGORIES.VFR,
            ...WEATHER_CATEGORIES.MVFR, ...WEATHER_CATEGORIES.MVFR,
            ...WEATHER_CATEGORIES.IFR, ...WEATHER_CATEGORIES.IFR
          ];
        }
      }
      
      if (weatherRestriction === 'ANY') {
        // Critical missions - only GPS aircraft should get bad weather
        if (avionics === 'GPS') {
          // Weight toward challenging weather for critical missions
          return [
            ...WEATHER_CATEGORIES.VFR,
            ...WEATHER_CATEGORIES.MVFR, ...WEATHER_CATEGORIES.MVFR,
            ...WEATHER_CATEGORIES.IFR, ...WEATHER_CATEGORIES.IFR,
            ...WEATHER_CATEGORIES.LIFR
          ];
        } else if (avionics === 'IFR') {
          return [...WEATHER_CATEGORIES.VFR, ...WEATHER_CATEGORIES.MVFR, ...WEATHER_CATEGORIES.IFR];
        } else {
          return WEATHER_CATEGORIES.VFR;
        }
      }
      
      return WEATHER_CATEGORIES.VFR;
    }
    
    // Get valid start time based on mission time restriction
    function generateMissionStartTime(missionType, baseTime, hoursAhead) {
      const mission = MISSION_TYPES[missionType];
      if (!mission) return roundToHour(addMinutes(baseTime, hoursAhead * 60));
      
      const timeRestriction = mission.time;
      let startTime = addMinutes(baseTime, hoursAhead * 60);
      
      if (timeRestriction === 'day') {
        // Force to daytime hours (7:00 - 16:00 to ensure completion before dusk)
        if (startTime.hour < 7) startTime.hour = 7 + randomInt(0, 4);
        else if (startTime.hour >= 16) {
          // Push to next day morning
          startTime = addMinutes(startTime, (24 - startTime.hour + 7 + randomInt(0, 4)) * 60);
        }
      } else if (timeRestriction === 'day_dusk') {
        // Allow up to 18:00
        if (startTime.hour < 7) startTime.hour = 7 + randomInt(0, 5);
        else if (startTime.hour >= 18) {
          startTime = addMinutes(startTime, (24 - startTime.hour + 7 + randomInt(0, 5)) * 60);
        }
      } else if (timeRestriction === 'any') {
        // 25% chance of forcing night/early morning time for variety
        if (Math.random() < 0.25) {
          // Pick a night hour: 20-23 or 5-6
          const nightHours = [20, 21, 22, 23, 5, 6];
          startTime.hour = randomItem(nightHours);
        }
      }
      
      return roundToHour(startTime);
    }
    
    // Check if pilot can accept mission based on time
    // Get missions available for pilot's tier
    function getMissionsForTier(experienceTier) {
      // Use the new MISSION_TIER_REQUIREMENTS constant
      const tierOrder = ['rookie', 'novice', 'journeyman', 'professional', 'veteran', 'master'];
      const tierIndex = tierOrder.indexOf(experienceTier || 'rookie');
      
      let available = [];
      for (let i = 0; i <= tierIndex; i++) {
        const tierMissions = MISSION_TIER_REQUIREMENTS[tierOrder[i]] || [];
        available = available.concat(tierMissions);
      }
      return available;
    }
    
    // Generate waypoint coordinates within range
    function generateWaypoint(homeLat, homeLon, minDist, maxDist) {
      const bearing = Math.random() * 360;
      const distance = randomInt(minDist, maxDist);
      
      // Convert to radians
      const lat1 = homeLat * Math.PI / 180;
      const lon1 = homeLon * Math.PI / 180;
      const bearingRad = bearing * Math.PI / 180;
      const distRad = distance / 3440.065; // nm to radians
      
      const lat2 = Math.asin(
        Math.sin(lat1) * Math.cos(distRad) +
        Math.cos(lat1) * Math.sin(distRad) * Math.cos(bearingRad)
      );
      
      const lon2 = lon1 + Math.atan2(
        Math.sin(bearingRad) * Math.sin(distRad) * Math.cos(lat1),
        Math.cos(distRad) - Math.sin(lat1) * Math.sin(lat2)
      );
      
      return {
        lat: (lat2 * 180 / Math.PI).toFixed(4),
        lon: (lon2 * 180 / Math.PI).toFixed(4),
        distance: distance,
        bearing: Math.round(bearing)
      };
    }
    
    // Generate waypoint action description
    function generateWaypointDescription(missionType) {
      const descriptions = {
        "Aerial Photography": [
          "Construction site documentation",
          "Real estate aerial photography",
          "Agricultural field assessment",
          "Industrial facility inspection",
          "Event coverage photography"
        ],
        "Aerial Survey": [
          "Pipeline inspection corridor",
          "Wildlife population count",
          "Geological survey zone",
          "Power line inspection",
          "Environmental assessment area"
        ],
        "Search Support": [
          "Grid search assignment",
          "Shoreline patrol sector",
          "Highway corridor search",
          "Wilderness area sweep",
          "River valley search"
        ],
        "Heli SAR": [
          "Last known position of overdue hiker",
          "Distress signal location",
          "Capsized vessel report",
          "Stranded climber location",
          "Missing aircraft search area"
        ],
        "Heli EMS": [
          "Vehicle accident scene",
          "Industrial accident location",
          "Remote medical emergency",
          "Wilderness injury location",
          "Water rescue incident"
        ]
      };
      
      const options = descriptions[missionType] || ["Target location"];
      return randomItem(options);
    }
    
    // Calculate suggested bid for a mission
    function calculateSuggestedBid(mission, aircraft) {
      const operatingCost = aircraft.operating_cost || 100;
      const cruiseSpeed = aircraft.cruise_speed || 120;
      const fuelBurn = aircraft.fuel_burn_rate || 10;
      const fuelType = aircraft.fuel_type || "100LL";
      const fuelPrice = FUEL_PRICES[fuelType] || 6.44;
      
      // Calculate flight time
      let totalDistance = mission.distance || 0;
      let revenueDistance = mission.revenueDistance || totalDistance;
      
      const flightHours = totalDistance / cruiseSpeed;
      
      // Calculate costs
      const operatingCosts = flightHours * operatingCost;
      const fuelCosts = flightHours * fuelBurn * fuelPrice;
      const totalCosts = operatingCosts + fuelCosts;
      
      // Calculate revenue based on payload
      let baseRevenue = 0;
      
      if (mission.passengers && mission.passengers > 0) {
        baseRevenue = revenueDistance * mission.passengers * RATES.passengerMile;
      } else if (mission.cargoLbs && mission.cargoLbs > 0) {
        baseRevenue = revenueDistance * mission.cargoLbs * RATES.cargoMile;
      } else {
        // Time-based for non-payload missions
        baseRevenue = flightHours * RATES.charterHourly;
      }
      
      // Apply multipliers
      const missionDef = MISSION_TYPES[mission.missionType];
      let multiplier = 1.0;
      
      if (missionDef?.isEmergency) multiplier *= RATES.emergencyMultiplier;
      if (mission.isNight) multiplier *= RATES.nightMultiplier;
      if (WEATHER_CATEGORIES.IFR.includes(mission.weather) || 
          WEATHER_CATEGORIES.LIFR.includes(mission.weather)) {
        multiplier *= RATES.ifrMultiplier;
      }
      if (missionDef?.destType === 'short_field') multiplier *= RATES.bushMultiplier;
      
      const suggestedRevenue = baseRevenue * multiplier;
      
      // Add positioning compensation (50% of positioning leg costs)
      const positioningCosts = mission.positioningDistance ? 
        (mission.positioningDistance / cruiseSpeed) * (operatingCost + fuelBurn * fuelPrice) * RATES.positioningRate : 0;
      
      return {
        suggested: Math.round(suggestedRevenue + positioningCosts),
        minimum: Math.round(totalCosts * 1.1), // 10% margin minimum
        operatingCosts: Math.round(operatingCosts),
        fuelCosts: Math.round(fuelCosts),
        positioningCompensation: Math.round(positioningCosts),
        breakdown: {
          flightHours: flightHours.toFixed(1),
          totalDistance,
          revenueDistance,
          multiplier: multiplier.toFixed(2)
        }
      };
    }
    
    // Calculate market rate for a mission (what typical operators charge)
    // Applies difficulty revenue multiplier for accurate player-facing estimates
    function calculateMarketRate(mission, aircraft) {
      const cruiseSpeed = aircraft.cruise_speed || 120;
      const category = aircraft.category || 'single_piston';
      const aircraftCode = Object.keys(AIRCRAFT).find(code => AIRCRAFT[code] === aircraft) || '';
      const pax = aircraft.max_passengers || 1;
      
      // Determine if this is a contract pilot job or owned aircraft
      const isContract = mission.type === 'contract';
      
      // Calculate flight time
      const totalDistance = mission.distance || 100;
      const flightHours = totalDistance / cruiseSpeed;
      
      // Get base hourly rate - check overrides first, then category default
      let baseHourlyRate;
      if (CHARTER_RATE_OVERRIDES[aircraftCode]?.base) {
        baseHourlyRate = CHARTER_RATE_OVERRIDES[aircraftCode].base;
      } else {
        baseHourlyRate = CHARTER_BASE_RATES[category] || 500;
      }
      
      // Get charter premium (luxury/capability factor)
      const charterPremium = CHARTER_PREMIUMS[aircraftCode] || 1.00;
      
      // Get capacity factor
      const capacityFactor = getCapacityFactor(pax);
      
      // Calculate effective hourly rate
      const effectiveHourlyRate = baseHourlyRate * charterPremium * capacityFactor;
      
      // Base market rate = hourly rate Ã— flight hours
      let baseRate = effectiveHourlyRate * flightHours;
      
      // Minimum charges (1-2 hour minimum depending on category)
      const minimumHours = category.includes('jet') || category === 'turboprop' || category === 'airliner' ? 2.0 : 1.0;
      const minimumCost = effectiveHourlyRate * minimumHours;
      baseRate = Math.max(baseRate, minimumCost);
      
      // Apply multipliers for conditions
      let multiplier = 1.0;
      const missionDef = MISSION_TYPES[mission.missionType];
      
      if (missionDef?.isEmergency) multiplier *= 1.25;
      if (mission.isNight) multiplier *= 1.10;
      if (WEATHER_CATEGORIES.IFR?.includes(mission.weather) || 
          WEATHER_CATEGORIES.LIFR?.includes(mission.weather)) {
        multiplier *= 1.15;
      }
      if (missionDef?.destType === 'short_field') multiplier *= 1.10;
      
      // Premium for executive/VIP/medical missions
      if (['Executive Transport', 'Organ Transport', 'Air Ambulance', 'Medical Transfer'].includes(mission.missionType)) {
        multiplier *= 1.15;
      }
      
      // Apply mission tier pay multiplier based on pilot's experience
      const tierPayMultiplier = getTierPayMultiplier();
      multiplier *= tierPayMultiplier;
      
      let marketRate = Math.round(baseRate * multiplier);
      
      // Apply difficulty revenue multiplier so displayed rate matches what player will receive
      const revenueMultiplier = isContract 
        ? (S.difficultySettings?.contractRevenueMultiplier || 1.0)
        : (S.difficultySettings?.ownedRevenueMultiplier || 1.0);
      marketRate = Math.round(marketRate * revenueMultiplier);
      
      // Apply marketing specialist bonus (if hired)
      const marketingBonus = getMarketingContractBonus();
      if (marketingBonus > 0) {
        marketRate = Math.round(marketRate * (1 + marketingBonus));
      }
      
      // Apply accountant revenue bonus (if hired)
      const accountantBonus = getAccountantRevenueBonus();
      if (accountantBonus > 0) {
        marketRate = Math.round(marketRate * (1 + accountantBonus));
      }
      
      // Calculate typical range (Â±15%)
      const lowRange = Math.round(marketRate * 0.85);
      const highRange = Math.round(marketRate * 1.15);
      
      return {
        rate: marketRate,
        low: lowRange,
        high: highRange,
        breakdown: {
          baseHourlyRate: baseHourlyRate,
          charterPremium: charterPremium,
          capacityFactor: capacityFactor,
          effectiveHourlyRate: Math.round(effectiveHourlyRate),
          flightHours: flightHours.toFixed(1),
          multiplier: multiplier.toFixed(2),
          revenueMultiplier: revenueMultiplier.toFixed(2),
          category: category
        }
      };
    }
    
    // Calculate cost breakdown for bid calculator
    function calculateCostBreakdown(email, aircraft) {
      const cruiseSpeed = aircraft.cruise_speed || 120;
      const fuelBurn = aircraft.fuel_burn_rate || 10;
      const fuelType = aircraft.fuel_type || '100LL';
      // Apply fuel cost multiplier
      const fuelPrice = getEffectiveFuelPrice(fuelType);
      // Get direct ops (with multiplier)
      const directOpsRate = getEffectiveDirectOps(aircraft);
      // For cost-per-nm calculation, use direct ops only (MX is % of revenue, calculated separately)
      const costPerNm = (fuelBurn * fuelPrice + directOpsRate) / cruiseSpeed;
      
      // Get player's MX reserve rate setting
      const mxReserveRate = (S.mxReserveRate ?? 15) / 100;
      
      // Find leg distances
      let positioningDist = 0;
      let revenueDist = 0;
      let returnDist = 0;
      
      // Check if this is a round-trip style mission (passengers on both legs)
      // These don't have deadhead return - the whole trip is revenue
      // Includes: round_trip, out_and_back, and waypoint (scenic tours, discovery flights)
      const isRoundTrip = email.missionStructure === 'round_trip' || 
                          email.missionStructure === 'out_and_back' ||
                          email.missionStructure === 'waypoint';
      
      if (email.legs && email.legs.length > 0) {
        const posLeg = email.legs.find(l => l.type === 'positioning');
        const revLeg = email.legs.find(l => l.type === 'revenue' || l.type === 'outbound' || l.type === 'activity');
        const retLeg = email.legs.find(l => l.type === 'return' || l.type === 'deadhead');
        
        positioningDist = posLeg?.distance || 0;
        
        if (isRoundTrip) {
          // For round trips, both outbound and return are revenue (passengers on both)
          revenueDist = email.distance || 0; // Total distance is all revenue
          returnDist = 0; // No separate deadhead return
        } else {
          // For point-to-point, only the revenue leg is paid by customer
          revenueDist = revLeg?.distance || email.revenueDistance || email.distance || 0;
          returnDist = retLeg?.distance || 0;
        }
      } else {
        // No legs defined - assume simple point-to-point (all revenue)
        revenueDist = email.distance || 0;
      }
      
      // Calculate costs for each segment
      // For waypoint missions (sightseeing, aerial photo, etc.), minimum 1 hour flight time
      let revenueHours = revenueDist / cruiseSpeed;
      if (isRoundTrip && email.missionStructure === 'waypoint') {
        revenueHours = Math.max(1.0, revenueHours);
      }
      const revenueFuelGal = revenueHours * fuelBurn;
      const revenueFuelCost = revenueFuelGal * fuelPrice;
      const revenueDirectOps = revenueHours * directOpsRate;
      
      // MX Reserve is % of revenue - estimate based on market rate
      // We'll calculate this after we have market rate, for now use placeholder
      // The actual value will be set when openBidCalculator calls this with market rate context
      
      const positioningCost = positioningDist * costPerNm;
      const returnCost = returnDist * costPerNm;
      
      // Pilot time - only a cost if hiring contract pilot
      // For owner-operator (flying own aircraft), this is NOT a cost - it's your earnings
      const isContractPilot = email.type === 'contract';
      const pilotHourlyRate = 50;
      const totalHours = (positioningDist + revenueDist + returnDist) / cruiseSpeed;
      const pilotTimeCost = isContractPilot ? totalHours * pilotHourlyRate : 0;
      
      // Total cost (MX reserve added later based on actual revenue/bid)
      const totalCost = revenueFuelCost + revenueDirectOps + positioningCost + returnCost + pilotTimeCost;
      
      return {
        fuel: {
          gallons: revenueFuelGal.toFixed(1),
          pricePerGal: fuelPrice.toFixed(2),
          total: Math.round(revenueFuelCost),
          hint: `~${revenueFuelGal.toFixed(0)} gal @ $${fuelPrice.toFixed(2)}/gal`,
          isRevenueLeg: true
        },
        directOps: {
          hours: revenueHours.toFixed(1),
          ratePerHour: directOpsRate,
          total: Math.round(revenueDirectOps),
          hint: `${revenueHours.toFixed(1)} hrs Ã— $${directOpsRate}/hr`
        },
        mxReserve: {
          rate: mxReserveRate,
          ratePercent: Math.round(mxReserveRate * 100),
          // Total will be calculated based on bid amount
          total: 0,
          hint: `${Math.round(mxReserveRate * 100)}% of revenue`
        },
        positioning: {
          distance: positioningDist,
          total: Math.round(positioningCost),
          hint: positioningDist > 0 ? `${positioningDist} nm deadhead to pickup` : 'N/A'
        },
        return: {
          distance: returnDist,
          total: Math.round(returnCost),
          hint: returnDist > 0 ? `${returnDist} nm return to base` : 'N/A'
        },
        pilotTime: isContractPilot ? {
          hours: totalHours.toFixed(1),
          rate: pilotHourlyRate,
          total: Math.round(pilotTimeCost),
          hint: `${totalHours.toFixed(1)} hrs Ã— $${pilotHourlyRate}/hr`
        } : null,
        totalCost: Math.round(totalCost)
      };
    }
    
    // Open bid calculator modal
    function openBidCalculator(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const aircraft = getAircraft(email.aircraftCode);
      if (!aircraft) return;
      
      // Check for schedule conflicts before opening calculator
      const conflict = checkScheduleConflict(email.startTime, email.distance, aircraft?.cruise_speed || 120);
      if (conflict) {
        if (!confirm(`âš ï¸ Schedule Conflict Detected\n\nThis flight would overlap with:\n${conflict.missionType}\nScheduled: ${formatGameTime(conflict.startTime)}\n\nContinue to quote calculator anyway?`)) {
          return;
        }
      }
      
      const costs = calculateCostBreakdown(email, aircraft);
      const marketRate = calculateMarketRate(email, aircraft);
      
      // Get client traits display
      const traits = email.clientTraits || [];
      const traitBadges = traits.map(t => {
        const info = getTraitDisplay(t);
        return `<span class="bid-calc-tag personality" title="${info.description}">${info.label}</span>`;
      }).join('');
      
      // Tier badge
      const tierClass = `tier-${email.companyTier || 'regional'}`;
      const tierLabel = (email.companyTier || 'regional').charAt(0).toUpperCase() + (email.companyTier || 'regional').slice(1);
      
      // Build legs display
      let legsHtml = '';
      if (email.legs && email.legs.length > 0) {
        legsHtml = email.legs.map(leg => `
          <div class="bid-calc-leg">
            <span class="bid-calc-leg-type ${leg.type}">${leg.type.toUpperCase()}</span>
            <span class="bid-calc-leg-route">${leg.from || 'â€”'} â†’ ${leg.to || 'â€”'}</span>
            <span class="bid-calc-leg-distance">${leg.distance || 0} nm</span>
          </div>
        `).join('');
      } else {
        // Simple point-to-point
        legsHtml = `
          <div class="bid-calc-leg">
            <span class="bid-calc-leg-type revenue">REVENUE</span>
            <span class="bid-calc-leg-route">${email.fromIcao} â†’ ${email.toIcao}</span>
            <span class="bid-calc-leg-distance">${email.distance} nm</span>
          </div>
        `;
      }
      
      // Estimated flight time (minimum 1 hour for short flights)
      const cruiseSpeed = aircraft.cruise_speed || 120;
      const flightHours = Math.max(1.0, email.distance / cruiseSpeed).toFixed(1);
      
      // Payload display
      let payloadDisplay = '';
      if (email.passengers) payloadDisplay = `${email.passengers} pax`;
      else if (email.cargoLbs) payloadDisplay = `${email.cargoLbs} lbs`;
      else payloadDisplay = 'None';
      
      // Client avatar emoji based on tier
      const avatarEmojis = { corporate: 'ðŸ‘”', regional: 'ðŸ§‘â€âœˆï¸', budget: 'ðŸ‘¤' };
      const avatar = avatarEmojis[email.companyTier] || 'ðŸ‘¤';
      
      // Suggested bid (market rate as starting point)
      const suggestedBid = marketRate.rate;
      
      // Calculate initial MX reserve based on suggested bid
      const initialMxReserve = Math.round(suggestedBid * costs.mxReserve.rate);
      const totalCostWithMx = costs.totalCost + initialMxReserve;
      const initialProfit = suggestedBid - totalCostWithMx;
      
      const content = `
        <div class="bid-calc-main">
          <div class="bid-calc-header">
            <div>
              <div class="bid-calc-route">${email.fromIcao} â†’ ${email.toIcao}</div>
              <div class="bid-calc-mission-type">${email.missionType} â€¢ ${payloadDisplay}</div>
            </div>
            <button class="bid-calc-close" onclick="closeBidCalculator()">&times;</button>
          </div>
          
          <div class="bid-calc-details">
            <div class="bid-calc-detail">
              <div class="bid-calc-detail-value">${email.distance} nm</div>
              <div class="bid-calc-detail-label">Total Distance</div>
            </div>
            <div class="bid-calc-detail">
              <div class="bid-calc-detail-value">~${flightHours} hrs</div>
              <div class="bid-calc-detail-label">Block Time</div>
            </div>
            <div class="bid-calc-detail">
              <div class="bid-calc-detail-value">${payloadDisplay}</div>
              <div class="bid-calc-detail-label">Payload</div>
            </div>
          </div>
          
          <div class="bid-calc-section">
            <div class="bid-calc-section-header">Flight Legs</div>
            <div class="bid-calc-legs">
              ${legsHtml}
            </div>
          </div>
          
          <div class="bid-calc-section">
            <div class="bid-calc-section-header">Client</div>
            <div class="bid-calc-client">
              <div class="bid-calc-client-avatar">${avatar}</div>
              <div class="bid-calc-client-info">
                <div class="bid-calc-client-name">${email.from}</div>
                <div class="bid-calc-client-company">${email.company}</div>
              </div>
              <div class="bid-calc-client-tags">
                <span class="bid-calc-tag ${tierClass}">${tierLabel}</span>
                ${traitBadges}
              </div>
            </div>
          </div>
          
          <div class="bid-calc-section">
            <div class="bid-calc-section-header">Cost Estimate</div>
            
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                Fuel <span style="font-weight: 400; color: var(--muted);">(revenue leg)</span>
                <div class="bid-calc-cost-hint">${costs.fuel.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costFuel" value="" placeholder="$0">
                <button class="bid-calc-estimate-btn" onclick="estimateCost('fuel', ${costs.fuel.total})">Estimate</button>
              </div>
            </div>
            
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                Direct Ops <span style="font-weight: 400; color: var(--muted);">(revenue leg)</span>
                <div class="bid-calc-cost-hint">${costs.directOps.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costDirectOps" value="" placeholder="$0">
                <button class="bid-calc-estimate-btn" onclick="estimateCost('directOps', ${costs.directOps.total})">Estimate</button>
              </div>
            </div>
            
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                MX Reserve <span style="font-weight: 400; color: var(--muted);">(${costs.mxReserve.ratePercent}% of bid)</span>
                <div class="bid-calc-cost-hint" id="mxReserveHint">${costs.mxReserve.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costMxReserve" value="" placeholder="$0" readonly style="background: var(--bg);">
                <span style="font-size: 10px; color: var(--muted); padding: 0 8px;">Auto</span>
              </div>
            </div>
            
            ${costs.positioning.total > 0 ? `
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                Positioning <span style="font-weight: 400; color: var(--muted);">(deadhead)</span>
                <div class="bid-calc-cost-hint">${costs.positioning.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costPositioning" value="" placeholder="$0">
                <button class="bid-calc-estimate-btn" onclick="estimateCost('positioning', ${costs.positioning.total})">Estimate</button>
              </div>
            </div>
            ` : ''}
            
            ${costs.return.total > 0 ? `
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                Return <span style="font-weight: 400; color: var(--muted);">(deadhead)</span>
                <div class="bid-calc-cost-hint">${costs.return.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costReturn" value="" placeholder="$0">
                <button class="bid-calc-estimate-btn" onclick="estimateCost('return', ${costs.return.total})">Estimate</button>
              </div>
            </div>
            ` : ''}
            
            ${costs.pilotTime ? `
            <div class="bid-calc-cost-row">
              <div class="bid-calc-cost-label">
                Contract Pilot
                <div class="bid-calc-cost-hint">${costs.pilotTime.hint}</div>
              </div>
              <div class="bid-calc-cost-input-group">
                <input type="number" class="bid-calc-cost-input" id="costPilotTime" value="" placeholder="$0">
                <button class="bid-calc-estimate-btn" onclick="estimateCost('pilotTime', ${costs.pilotTime.total})">Estimate</button>
              </div>
            </div>
            ` : ''}
            
            <div class="bid-calc-cost-row bid-calc-cost-total">
              <div class="bid-calc-cost-label">Total Estimated Cost</div>
              <input type="text" class="bid-calc-cost-input" id="costTotal" value="$0" readonly style="width: 120px;">
            </div>
          </div>
          
          <div class="bid-calc-market-rate">
            <div class="bid-calc-market-rate-header">
              <span class="bid-calc-market-rate-label">Market Rate</span>
            </div>
            <div class="bid-calc-market-rate-value">${formatCurrency(marketRate.rate)}</div>
            <div class="bid-calc-market-rate-range">Typical range: ${formatCurrency(marketRate.low)} â€“ ${formatCurrency(marketRate.high)} for this route</div>
          </div>
          
          <div class="bid-calc-bid-section">
            <div class="bid-calc-bid-label">Your Quote</div>
            <input type="number" class="bid-calc-bid-input" id="bidAmount" value="${suggestedBid}" step="50" min="0" oninput="updateBidSummary('${emailId}')">
            <div class="bid-calc-bid-margin">
              <span>Profit Margin</span>
              <span class="bid-calc-bid-margin-value ${initialProfit >= 0 ? 'positive' : 'negative'}" id="bidMargin">${initialProfit >= 0 ? '+' : ''}${formatCurrency(initialProfit)} (${Math.round(initialProfit / suggestedBid * 100)}%)</span>
            </div>
            <div class="bid-calc-actions">
              <button class="btn" onclick="closeBidCalculator()" style="border-color: var(--muted);">Cancel</button>
              <button class="btn primary" onclick="submitBidFromCalculator('${emailId}')">Submit Quote</button>
            </div>
          </div>
        </div>
        
        <div class="bid-calc-sidebar">
          <div class="bid-calc-section-header">Bid Summary</div>
          
          <div class="bid-calc-summary-section">
            <div class="bid-calc-summary-row">
              <span class="label">Aircraft</span>
              <span class="value">${aircraft.name}</span>
            </div>
            <div class="bid-calc-summary-row">
              <span class="label">Departure</span>
              <span class="value">${formatGameTime(email.startTime)}</span>
            </div>
            <div class="bid-calc-summary-row">
              <span class="label">Schedule By</span>
              <span class="value">${formatGameTime(email.scheduleBy)}</span>
            </div>
          </div>
          
          <div class="bid-calc-summary-section">
            <div class="bid-calc-summary-row">
              <span class="label">Your Quote</span>
              <span class="value" id="summaryBid">${formatCurrency(suggestedBid)}</span>
            </div>
            <div class="bid-calc-summary-row">
              <span class="label">Estimated Cost</span>
              <span class="value" id="summaryCost">${formatCurrency(totalCostWithMx)}</span>
            </div>
            <div class="bid-calc-summary-row highlight">
              <span class="label">Projected Profit</span>
              <span class="value ${initialProfit >= 0 ? 'positive' : 'negative'}" id="summaryProfit">${initialProfit >= 0 ? '+' : ''}${formatCurrency(initialProfit)}</span>
            </div>
          </div>
          
          <div class="bid-calc-summary-section">
            <div class="bid-calc-summary-row">
              <span class="label">vs. Market Rate</span>
              <span class="value" id="summaryVsMarket">0%</span>
            </div>
            <div class="bid-calc-summary-row">
              <span class="label">Client Tier</span>
              <span class="value">${tierLabel}</span>
            </div>
            
            <div class="bid-calc-probability">
              <div class="bid-calc-probability-label">
                <span>Acceptance Likelihood</span>
                <span id="acceptanceLikelihood" style="font-weight: 600;">â€”</span>
              </div>
              <div class="bid-calc-probability-bar">
                <div class="bid-calc-probability-fill high" id="acceptanceBar" style="width: 70%;"></div>
              </div>
              <div class="bid-calc-probability-note" id="acceptanceNote">${tierLabel} clients typically accept within 10% of market rate</div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('bidCalculatorContent').innerHTML = content;
      document.getElementById('bidCalculatorModal').classList.add('open');
      
      // Store data for later use
      window.currentBidData = {
        emailId,
        marketRate: marketRate.rate,
        totalCost: totalCostWithMx,
        baseCost: costs.totalCost, // Cost without MX reserve
        clientTier: email.companyTier,
        clientTraits: email.clientTraits || [],
        mxReserveRate: costs.mxReserve.rate
      };
      
      // Initial summary update
      updateBidSummary(emailId);
    }
    
    function closeBidCalculator() {
      document.getElementById('bidCalculatorModal').classList.remove('open');
      window.currentBidData = null;
    }
    
    // Estimate button fills in a cost field
    function estimateCost(field, value) {
      const fieldMap = {
        fuel: 'costFuel',
        directOps: 'costDirectOps',
        mxReserve: 'costMxReserve',
        positioning: 'costPositioning',
        return: 'costReturn',
        pilotTime: 'costPilotTime'
      };
      
      const input = document.getElementById(fieldMap[field]);
      if (input) {
        input.value = value;
        updateTotalCost();
      }
    }
    
    // Update total cost when individual costs change
    function updateTotalCost() {
      const fuel = parseInt(document.getElementById('costFuel')?.value) || 0;
      const directOps = parseInt(document.getElementById('costDirectOps')?.value) || 0;
      const mxReserve = parseInt(document.getElementById('costMxReserve')?.value) || 0;
      const positioning = parseInt(document.getElementById('costPositioning')?.value) || 0;
      const returnCost = parseInt(document.getElementById('costReturn')?.value) || 0;
      const pilotTime = parseInt(document.getElementById('costPilotTime')?.value) || 0;
      
      const total = fuel + directOps + mxReserve + positioning + returnCost + pilotTime;
      document.getElementById('costTotal').value = formatCurrency(total);
      
      if (window.currentBidData && !window._updatingBid) {
        window.currentBidData.totalCost = total;
        window._updatingBid = true;
        updateBidSummary(window.currentBidData.emailId);
        window._updatingBid = false;
      }
    }
    
    // Update bid summary sidebar
    function updateBidSummary(emailId) {
      const bidInput = document.getElementById('bidAmount');
      const bid = parseInt(bidInput?.value) || 0;
      
      if (!window.currentBidData) return;
      
      const { marketRate, clientTier, clientTraits, mxReserveRate } = window.currentBidData;
      
      // Calculate MX reserve based on bid amount
      const mxReserve = Math.round(bid * (mxReserveRate ?? 0.15));
      const mxReserveInput = document.getElementById('costMxReserve');
      if (mxReserveInput) {
        mxReserveInput.value = mxReserve;
      }
      const mxReserveHint = document.getElementById('mxReserveHint');
      if (mxReserveHint) {
        mxReserveHint.textContent = `${Math.round((mxReserveRate ?? 0.15) * 100)}% of $${bid.toLocaleString()} = $${mxReserve.toLocaleString()}`;
      }
      
      // Recalculate total cost including MX reserve (but avoid recursion)
      if (!window._updatingBid) {
        window._updatingBid = true;
        updateTotalCost();
        window._updatingBid = false;
      }
      const totalCost = window.currentBidData.totalCost || 0;
      
      const profit = bid - totalCost;
      const marginPct = bid > 0 ? Math.round((profit / bid) * 100) : 0;
      const vsMarket = marketRate > 0 ? ((bid - marketRate) / marketRate * 100).toFixed(1) : 0;
      
      // Update displays
      document.getElementById('summaryBid').textContent = formatCurrency(bid);
      document.getElementById('summaryCost').textContent = formatCurrency(totalCost);
      document.getElementById('summaryProfit').textContent = (profit >= 0 ? '+' : '') + formatCurrency(profit);
      document.getElementById('summaryProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
      
      document.getElementById('summaryVsMarket').textContent = (vsMarket >= 0 ? '+' : '') + vsMarket + '%';
      
      // Update margin display
      const marginEl = document.getElementById('bidMargin');
      marginEl.textContent = (profit >= 0 ? '+' : '') + formatCurrency(profit) + ` (${marginPct}%)`;
      marginEl.className = 'bid-calc-bid-margin-value ' + (profit >= 0 ? 'positive' : 'negative');
      
      // Calculate acceptance probability
      const acceptance = calculateAcceptanceProbability(bid, marketRate, clientTier, clientTraits);
      
      const likelihoodEl = document.getElementById('acceptanceLikelihood');
      const barEl = document.getElementById('acceptanceBar');
      const noteEl = document.getElementById('acceptanceNote');
      
      likelihoodEl.textContent = acceptance.label;
      likelihoodEl.style.color = acceptance.color;
      barEl.style.width = acceptance.probability + '%';
      barEl.className = 'bid-calc-probability-fill ' + acceptance.level;
      noteEl.textContent = acceptance.note;
    }
    
    // Calculate acceptance probability based on bid vs market, tier, and traits
    function calculateAcceptanceProbability(bid, marketRate, tier, traits) {
      const vsMarket = ((bid - marketRate) / marketRate) * 100;
      
      // Base acceptance thresholds by tier
      const tierThresholds = {
        budget: { accept: -5, counter: 0, reject: 5 },      // Budget: wants below market
        regional: { accept: 5, counter: 15, reject: 20 },   // Regional: some flexibility
        corporate: { accept: 15, counter: 25, reject: 30 }  // Corporate: pays premium
      };
      
      const thresholds = tierThresholds[tier] || tierThresholds.regional;
      
      // Apply trait modifiers
      const traitMods = getTraitModifiers(traits);
      const adjustedAccept = thresholds.accept + traitMods.acceptanceModifier;
      const adjustedReject = thresholds.reject + traitMods.acceptanceModifier;
      
      // Calculate probability
      let probability, label, level, note;
      
      if (vsMarket <= adjustedAccept) {
        // High acceptance zone
        probability = Math.min(95, 80 + (adjustedAccept - vsMarket) * 2);
        label = 'High';
        level = 'high';
        note = `${tier.charAt(0).toUpperCase() + tier.slice(1)} clients typically accept at or below market rate`;
      } else if (vsMarket <= thresholds.counter) {
        // Counter-offer zone
        probability = 60 - (vsMarket - adjustedAccept) * 2;
        label = 'Moderate';
        level = 'medium';
        note = 'Client may counter-offer at this price point';
      } else if (vsMarket <= adjustedReject) {
        // Low acceptance zone
        probability = 30 - (vsMarket - thresholds.counter) * 2;
        label = 'Low';
        level = 'low';
        note = 'Price is above typical range for this client tier';
      } else {
        // Rejection zone
        probability = Math.max(5, 15 - (vsMarket - adjustedReject));
        label = 'Very Low';
        level = 'low';
        note = 'Price significantly exceeds client expectations';
      }
      
      probability = Math.max(5, Math.min(95, probability));
      
      const colors = { high: 'var(--success)', medium: 'var(--warning)', low: 'var(--danger)' };
      
      return { probability, label, level, color: colors[level], note };
    }
    
    // Submit bid from calculator
    function submitBidFromCalculator(emailId) {
      const bidInput = document.getElementById('bidAmount');
      const bid = parseInt(bidInput?.value) || 0;
      
      if (bid <= 0) {
        showToast('Please enter a valid quote amount', 'error');
        return;
      }
      
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const aircraft = getAircraft(email.aircraftCode);
      const costs = calculateCostBreakdown(email, aircraft);
      const estimatedCost = costs.totalCost;
      
      // Confirm if quoting below estimated cost
      if (bid < estimatedCost) {
        const loss = estimatedCost - bid;
        const confirmed = confirm(
          `âš ï¸ Quote Below Cost\n\n` +
          `Your quote: ${formatCurrency(bid)}\n` +
          `Estimated costs: ${formatCurrency(estimatedCost)}\n` +
          `Projected loss: ${formatCurrency(loss)}\n\n` +
          `Submit this quote anyway?`
        );
        if (!confirmed) return;
      }
      
      email.playerBid = bid;
      email.status = 'bid_sent';
      
      // Process client response based on bid
      processClientResponse(email);
      
      closeBidCalculator();
      saveState();
      render();
    }
    
    // Process client response to bid
    function processClientResponse(email) {
      const aircraft = getAircraft(email.aircraftCode);
      const marketRate = calculateMarketRate(email, aircraft);
      const bid = email.playerBid;
      const vsMarket = ((bid - marketRate.rate) / marketRate.rate) * 100;
      
      const tier = email.companyTier || 'regional';
      const traits = email.clientTraits || [];
      const traitMods = getTraitModifiers(traits);
      
      // Tier acceptance thresholds
      const tierThresholds = {
        budget: { accept: -5, counterLow: -15, counterHigh: 0, reject: 5 },
        regional: { accept: 5, counterLow: -5, counterHigh: 15, reject: 20 },
        corporate: { accept: 15, counterLow: 5, counterHigh: 25, reject: 30 }
      };
      
      const thresholds = tierThresholds[tier] || tierThresholds.regional;
      const adjustedAccept = thresholds.accept + traitMods.acceptanceModifier;
      const adjustedReject = thresholds.reject + traitMods.acceptanceModifier;
      
      // Determine response
      if (vsMarket <= adjustedAccept) {
        // Accept
        email.status = 'accepted';
        email.customerResponse = "We're pleased to accept your proposal. Looking forward to working with you.";
      } else if (vsMarket > adjustedReject) {
        // Reject
        email.status = 'declined';
        email.customerResponse = "Thank you for your quote, but it exceeds our budget. We've decided to go with another provider.";
      } else {
        // Potential counter-offer
        const willCounter = Math.random() < traitMods.counterChance;
        
        if (willCounter) {
          // Calculate counter-offer (midpoint between their threshold and bid, leaning toward their preference)
          const counterTarget = marketRate.rate * (1 + (adjustedAccept / 100));
          const counterAmount = Math.round((counterTarget + bid) / 2);
          
          email.status = 'counter_offer';
          email.counterOffer = Math.max(counterAmount, Math.round(marketRate.rate * 0.9)); // Don't go below 90% of market
          email.customerResponse = `Your quote is a bit higher than we expected. Would you consider ${formatCurrency(email.counterOffer)}?`;
        } else {
          // Decline without counter
          email.status = 'declined';
          email.customerResponse = "Thank you for your quote. We've decided to pursue other options at this time.";
        }
      }
    }

    // === INDEXEDDB MANAGEMENT ===
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('SkyliftLedger', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('databases')) {
            db.createObjectStore('databases', { keyPath: 'name' });
          }
        };
      });
    }

    async function saveToIndexedDB(name, data) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['databases'], 'readwrite');
        const store = transaction.objectStore('databases');
        const request = store.put({ name, data, timestamp: Date.now() });
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function loadFromIndexedDB(name) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['databases'], 'readonly');
        const store = transaction.objectStore('databases');
        const request = store.get(name);
        request.onsuccess = () => resolve(request.result?.data || null);
        request.onerror = () => reject(request.error);
      });
    }
    
    async function clearDatabaseCache() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['databases'], 'readwrite');
        const store = transaction.objectStore('databases');
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // === FILE LOADING ===
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    }

    async function handleAirportsFile(file) {
      try {
        const content = await readFileAsText(file);
        const airportsData = JSON.parse(content);
        
        if (!airportsData || typeof airportsData !== 'object') {
          throw new Error('Invalid airports database format');
        }
        
        await saveToIndexedDB('airports', airportsData);
        return airportsData;
      } catch (error) {
        throw new Error(`Failed to load airports database: ${error.message}`);
      }
    }

    // Status: 40% complete, ~3.5 minutes remaining
    // Building file picker UI...

    function showFilePicker() {
      const container = document.getElementById('filePickerContainer');
      const loadingText = document.getElementById('loadingText');
      
      loadingText.textContent = 'First Time Setup';
      
      container.innerHTML = `
        <div class="file-picker-box">
          <h3>Load Airports Database</h3>
          <p>Select <strong>airports.json</strong></p>
          <label class="file-input-label" for="airportsFileInput">Choose Airports File</label>
          <input type="file" id="airportsFileInput" accept=".json">
          <div id="airportsStatus" class="file-status"></div>
        </div>
        
        <button id="continueBtn" class="btn primary" style="margin-top: 20px;" disabled>Continue to Game</button>
        <div style="margin-top: 16px; font-size: 13px; color: var(--muted);">
          Airports will be cached in your browser. You only need to do this once.
        </div>
        
        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
          <div style="font-size: 14px; color: var(--text); margin-bottom: 12px;">Returning pilot?</div>
          <label class="file-input-label" for="importSaveStartup" style="background: var(--panel); border: 1px solid var(--border);">Load Game</label>
          <input type="file" id="importSaveStartup" accept=".json" style="display: none;">
          <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Load a previously exported save file to continue your career.</div>
        </div>
      `;

      document.getElementById('airportsFileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const status = document.getElementById('airportsStatus');
        status.textContent = 'Loading... (this may take a moment for large files)';
        status.className = 'file-status';
        
        try {
          AIRPORTS = await handleAirportsFile(file);
          normalizeAllAirports();
          status.textContent = `âœ“ Loaded ${Object.keys(AIRPORTS).length} airports`;
          status.className = 'file-status success';
          
          // Enable continue button
          const btn = document.getElementById('continueBtn');
          btn.disabled = false;
          btn.onclick = startGame;
        } catch (error) {
          status.textContent = `âœ— ${error.message}`;
          status.style.color = 'var(--danger)';
        }
      });
      
      document.getElementById('importSaveStartup').addEventListener('change', importSaveState);
    }

    // Status: 60% complete, ~2.5 minutes remaining
    // Building game logic (same as v0.1.00)...

    // === UTILITY FUNCTIONS ===
    function uuid() {
      return crypto.randomUUID();
    }

    function randomItem(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Get aircraft from built-in or custom database
    function getAircraft(code) {
      return AIRCRAFT[code] || S.customAircraft[code] || null;
    }
    
    // Aircraft emoji icons by category
    const AIRCRAFT_EMOJI = {
      // Single Piston
      C152: 'ðŸ›©ï¸', C152_AEROBAT: 'ðŸ›©ï¸', C172_SKYHAWK: 'ðŸ›©ï¸', C172_G1000: 'ðŸ›©ï¸',
      DA40_NG: 'ðŸ›©ï¸', DA40_TDI: 'ðŸ›©ï¸', DV20: 'ðŸ›©ï¸', DR400: 'ðŸ›©ï¸', CTSL: 'ðŸ›©ï¸', VL3: 'ðŸ›©ï¸',
      CORVALIS: 'ðŸ›©ï¸', BONANZA_G36: 'ðŸ›©ï¸', SR22: 'ðŸ›©ï¸',
      // Bush
      NX_CUB: 'ðŸ›©ï¸', XCUB: 'ðŸ›©ï¸', SAVAGE_CUB: 'ðŸ›©ï¸', SAVAGE_NORDEN: 'ðŸ›©ï¸',
      SHOCK_ULTRA: 'ðŸ›©ï¸', HAWK_ARROW: 'ðŸ›©ï¸', DHC2_BEAVER: 'ðŸ›©ï¸', PC6: 'ðŸ›©ï¸', DRACO: 'ðŸ›©ï¸',
      // Multi Piston
      BARON_G58: 'ðŸ›©ï¸', BARON_B55: 'ðŸ›©ï¸', C310R: 'ðŸ›©ï¸', C414: 'ðŸ›©ï¸', PA44_SEMINOLE: 'ðŸ›©ï¸', AEROSTAR_600: 'ðŸ›©ï¸', C404_TITAN: 'ðŸ›©ï¸', DA62: 'ðŸ›©ï¸', DC3: 'ðŸ›©ï¸',
      // Turboprop
      TBM930: 'ðŸ›©ï¸', PC12: 'ðŸ›©ï¸', DHC6_TWIN_OTTER: 'ðŸ›©ï¸', KING_AIR_350: 'ðŸ›©ï¸',
      KING_AIR_C90: 'ðŸ›©ï¸', CARAVAN: 'ðŸ›©ï¸', SKYCOURIER: 'ðŸ›©ï¸', SAAB_340B: 'ðŸ›©ï¸',
      // Jets
      CJ4: 'âœˆï¸', LONGITUDE: 'âœˆï¸', SF50: 'âœˆï¸', PC24: 'âœˆï¸',
      A320NEO: 'âœˆï¸', B737MAX8: 'âœˆï¸', A310: 'âœˆï¸', A330_300: 'âœˆï¸',
      B747_8I: 'âœˆï¸', B787_10: 'âœˆï¸', B747_8F: 'ðŸ“¦',
      C17: 'âœˆï¸', A400M: 'âœˆï¸',
      // Helicopter
      R66: 'ðŸš', BELL_407: 'ðŸš', CABRI_G2: 'ðŸš', H125: 'ðŸš',
      H225: 'ðŸš', CH47_CHINOOK: 'ðŸš',
      // Amphibious
      ICON_A5: 'ðŸ›©ï¸', G21_GOOSE: 'ðŸ›©ï¸', CL415: 'ðŸš’', SEASTAR: 'ðŸ›©ï¸', ALBATROSS: 'ðŸ›©ï¸',
      // Aerobatic / Warbird
      PITTS_S1S: 'ðŸ›©ï¸', PITTS_S2S: 'ðŸ›©ï¸', EXTRA_330LT: 'ðŸ›©ï¸', EDGE_540: 'ðŸ›©ï¸',
      MXS_R: 'ðŸ›©ï¸', CAP_10: 'ðŸ›©ï¸', P51_MUSTANG: 'ðŸ›©ï¸', T6_TEXAN: 'ðŸ›©ï¸', JN4_JENNY: 'ðŸ›©ï¸',
      // Specialty
      AT802: 'ðŸŒ¾', C188_AGTRUCK: 'ðŸŒ¾', OPTICA: 'ðŸ›©ï¸',
      // Military
      FA18E: 'ðŸŽ–ï¸', A10: 'ðŸŽ–ï¸', L39: 'ðŸŽ–ï¸',
    };
    
    function getAircraftEmoji(code) {
      return AIRCRAFT_EMOJI[code] || 'ðŸ›©ï¸';
    }
    
    // Aircraft base prices - 2025 market values
    // For in-production: new MSRP
    // For out-of-production/classics: current market value for typical example
    const AIRCRAFT_BASE_PRICES = {
      // Single Piston - Training
      C152: 82000,              // Out of production - current market for flyable
      C152_AEROBAT: 90000,      // Out of production - current market
      C172_SKYHAWK: 200000,     // Steam gauge era - realistic for older models
      C172_G1000: 650000,       // G1000 NXi premium - high demand, waitlists
      DA40_NG: 700000,          // Fuel efficient, multi-year backlogs
      DA40_TDI: 600000,         // Diesel variant - strong European demand
      DV20: 185000,             // Out of production - market value
      DR400: 240000,            // Current market
      CTSL: 150000,             // LSA market - faster depreciation
      VL3: 260000,              // Light sport
      // Single Piston - High Performance
      CORVALIS: 725000,         // Out of production - market value
      BONANZA_G36: 1100000,     // New MSRP - very strong market
      SR22: 920000,             // New G7 MSRP - Cirrus holds value extremely well
      // Bush / Backcountry (modern)
      NX_CUB: 420000,           // CubCrafters new
      XCUB: 400000,             // CubCrafters new
      SAVAGE_CUB: 195000,       // Zlin
      SAVAGE_NORDEN: 235000,    // Zlin
      SHOCK_ULTRA: 185000,      // Zlin
      HAWK_ARROW: 105000,       // Ultralight market
      // Multi Engine Piston
      BARON_G58: 1650000,       // New MSRP - strong demand
      BARON_B55: 850000,        // Out of production - clean examples command premium
      C310R: 650000,            // Out of production - well-maintained examples
      C414: 950000,             // Out of production - pressurized twin premium
      PA44_SEMINOLE: 750000,    // New MSRP - training market demand
      AEROSTAR_600: 800000,     // Out of production - speed premium, cult following
      C404_TITAN: 425000,       // Out of production - market value
      DA62: 1650000,            // New MSRP - very popular
      // Turboprop (very stable values)
      TBM930: 4800000,          // New MSRP
      PC12: 5950000,            // PC-12 NGX new
      DHC6_TWIN_OTTER: 7800000, // Viking production
      KING_AIR_350: 8500000,    // New MSRP
      KING_AIR_C90: 4400000,    // GTx variant
      CARAVAN: 3100000,         // Grand Caravan EX
      SKYCOURIER: 8200000,      // New 408
      SAAB_340B: 3200000,       // Out of production - market value
      // Light Jet (stable values)
      CJ4: 12200000,            // New MSRP
      LONGITUDE: 29500000,      // New MSRP
      SF50: 3600000,            // Vision Jet G2+
      PC24: 13500000,           // New MSRP
      // Airliner - Narrowbody
      A320NEO: 58000000,        // Realistic transaction price
      A321LR: 65000000,         // Long range variant
      B737MAX8: 62000000,       // Post-grounding market
      // Airliner - Widebody  
      A310: 12000000,            // Base set so 20% floor = ~$2.4M flyable freighter
      A330_200: 72000000,       // Widebody - prime for freighter conversion
      A330_300: 80000000,       // Widebody - strong mid-life value
      B747_8I: 125000000,       // Limited market
      B787_10: 165000000,       // Strong demand
      // Cargo
      B747_8F: 195000000,       // Last 747s ever built - irreplaceable
      
      // Military Cargo
      C17: 320000000,           // Military market
      A400M: 185000000,         // Military market
      // Amphibious
      ICON_A5: 415000,          // New MSRP
      SEASTAR: 4800000,         // Limited production
      CL415: 45000000,          // Firefighting premium
      // Aerobatic
      PITTS_S1S: 175000,        // Current market
      PITTS_S2S: 320000,        // Current market
      EXTRA_330LT: 785000,      // New MSRP
      EDGE_540: 650000,         // Competition aircraft
      MXS_R: 565000,            // Competition aircraft
      CAP_10: 310000,           // Current market
      // Helicopter - Turbine (stable like turboprops)
      R66: 1250000,             // New MSRP
      BELL_407: 4500000,        // New MSRP
      H125: 4100000,            // New MSRP
      // Helicopter - Piston
      CABRI_G2: 620000,         // New MSRP
      // Helicopter - Heavy (big plane pricing)
      H225: 26000000,           // Super Puma
      CH47_CHINOOK: 18000000,   // Civilian surplus market
      // Specialty
      AT802: 3600000,           // Air Tractor new
      C188_AGTRUCK: 285000,     // Out of production - market
      OPTICA: 520000,           // Rare aircraft
      // === CLASSICS (current market for mid-condition flyable) ===
      // Warbirds
      P51_MUSTANG: 3800000,     // Strong collector demand
      T6_TEXAN: 425000,         // Trainer warbird
      JN4_JENNY: 165000,        // Antique
      // Vintage Transport
      DC3: 400000,              // Flyable but high operating costs
      // Classic Bush (legendary status = premium)
      DHC2_BEAVER: 850000,      // Iconic collectible utility - only appreciates
      PC6: 850000,              // Out of production - market value
      DRACO: 3500000,           // One-off custom
      // Vintage Amphibians
      G21_GOOSE: 750000,        // Collector amphibian
      ALBATROSS: 1800000,       // Large amphibian
      // Military jets (not for sale, but keeping for reference)
      FA18E: 75000000, A10: 25000000, L39: 950000,
    };
    
    // Pricing segment classification
    const PRICING_SEGMENTS = {
      // SMALL: Standard GA depreciation with 55% floor
      small: [
        'C152', 'C152_AEROBAT', 'C172_SKYHAWK', 'C172_G1000',
        'DA40_NG', 'DA40_TDI', 'DV20', 'DR400', 'CTSL', 'VL3',
        'CORVALIS', 'BONANZA_G36', 'SR22',
        'NX_CUB', 'XCUB', 'SAVAGE_CUB', 'SAVAGE_NORDEN', 'SHOCK_ULTRA', 'HAWK_ARROW',
        'BARON_G58', 'C404_TITAN', 'DA62',
        'PITTS_S1S', 'PITTS_S2S', 'EXTRA_330LT', 'EDGE_540', 'MXS_R', 'CAP_10',
        'ICON_A5', 'SEASTAR',
        'CABRI_G2',
        'C188_AGTRUCK', 'OPTICA'
      ],
      // TURBINE: Very stable values, 40% floor
      turbine: [
        'TBM930', 'PC12', 'DHC6_TWIN_OTTER', 'KING_AIR_350', 'KING_AIR_C90',
        'CARAVAN', 'SKYCOURIER', 'SAAB_340B',
        'CJ4', 'LONGITUDE', 'SF50', 'PC24',
        'R66', 'BELL_407', 'H125',
        'AT802'
      ],
      // BIG: Heavy depreciation, 20% floor
      big: [
        'A310', 'A320NEO', 'A321LR', 'A330_200', 'A330_300',
        'B737MAX8', 'B747_8I', 'B747_8F', 'B787_10',
        'C17', 'A400M',
        'H225', 'CH47_CHINOOK',
        'CL415'
      ],
      // CLASSIC: No depreciation, condition is everything
      classic: [
        'P51_MUSTANG', 'T6_TEXAN', 'JN4_JENNY',
        'DC3',
        'DHC2_BEAVER', 'PC6', 'DRACO',
        'G21_GOOSE', 'ALBATROSS'
      ]
    };
    
    function getPricingSegment(aircraftCode) {
      for (const [segment, codes] of Object.entries(PRICING_SEGMENTS)) {
        if (codes.includes(aircraftCode)) return segment;
      }
      return 'small'; // Default
    }
    
    // Aircraft production year ranges
    const AIRCRAFT_PRODUCTION_YEARS = {
      C152: [1977, 1985], C152_AEROBAT: [1977, 1985], C172_SKYHAWK: [1956, 2004], C172_G1000: [2005, 2024],
      DA40_NG: [2012, 2024], DA40_TDI: [2002, 2024], DV20: [1994, 2010], DR400: [1972, 2020], CTSL: [2006, 2023], VL3: [2010, 2024],
      CORVALIS: [2004, 2018], BONANZA_G36: [2006, 2024], SR22: [2001, 2024],
      NX_CUB: [2019, 2024], XCUB: [2016, 2024], SAVAGE_CUB: [2012, 2024], SAVAGE_NORDEN: [2018, 2024],
      SHOCK_ULTRA: [2015, 2024], HAWK_ARROW: [2000, 2015], DHC2_BEAVER: [1948, 1967], PC6: [1959, 2019], DRACO: [2018, 2018],
      BARON_G58: [2005, 2024], C404_TITAN: [1976, 1982], DA62: [2015, 2024], DC3: [1936, 1946],
      TBM930: [2016, 2019], PC12: [1994, 2024], DHC6_TWIN_OTTER: [2010, 2024], KING_AIR_350: [1990, 2024],
      KING_AIR_C90: [1971, 2024], CARAVAN: [1984, 2024], SKYCOURIER: [2022, 2024], SAAB_340B: [1987, 1999],
      CJ4: [2010, 2024], LONGITUDE: [2019, 2024], SF50: [2016, 2024], PC24: [2018, 2024],
      A320NEO: [2016, 2024], B737MAX8: [2017, 2024], A310: [1983, 1998], A330_300: [1994, 2024],
      B747_8I: [2012, 2023], B787_10: [2018, 2024], B747_8F: [2011, 2023],
      C17: [1993, 2015], A400M: [2013, 2024],
      ICON_A5: [2015, 2024], G21_GOOSE: [1937, 1945], CL415: [1994, 2015], SEASTAR: [1987, 1990], ALBATROSS: [1949, 1961],
      PITTS_S1S: [1973, 2010], PITTS_S2S: [1973, 2010], EXTRA_330LT: [2003, 2024], EDGE_540: [1993, 2024],
      MXS_R: [2010, 2024], CAP_10: [1970, 2020], P51_MUSTANG: [1942, 1945], T6_TEXAN: [1938, 1954], JN4_JENNY: [1916, 1927],
      R66: [2010, 2024], BELL_407: [1996, 2024], CABRI_G2: [2008, 2024], H125: [2014, 2024],
      H225: [2004, 2024], CH47_CHINOOK: [1962, 2024],
      AT802: [1990, 2024], C188_AGTRUCK: [1966, 1983], OPTICA: [1983, 1990],
      FA18E: [1999, 2024], A10: [1977, 1984], L39: [1971, 1999],
    };
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function gameTimeToMinutes(t) {
      // Month and day are 1-indexed, convert to 0-indexed for calculation
      return t.year * 525600 + (t.month - 1) * 43200 + (t.day - 1) * 1440 + t.hour * 60 + t.minute;
    }

    function minutesToGameTime(totalMinutes) {
      let year = Math.floor(totalMinutes / 525600);
      totalMinutes %= 525600;
      let month = Math.floor(totalMinutes / 43200) + 1; // 1-indexed
      totalMinutes %= 43200;
      const day = Math.floor(totalMinutes / 1440) + 1; // 1-indexed
      totalMinutes %= 1440;
      const hour = Math.floor(totalMinutes / 60);
      const minute = Math.floor(totalMinutes % 60);
      
      // Handle month overflow (month > 12)
      while (month > 12) {
        month -= 12;
        year += 1;
      }
      
      return { year, month, day, hour, minute };
    }

    // Client helper functions
    function getRandomClient(tier = null, aircraftCategory = null) {
      // tier: 'budget' (individuals), 'regional', 'corporate', or null (any)
      // aircraftCategory: filter out clients that only do helicopter missions if not helicopter
      if (CLIENTS && CLIENTS.companies) {
        const companies = Object.values(CLIENTS.companies);
        
        if (tier === 'budget') {
          // Generate individual client from name lists
          return generateIndividualClient();
        }
        
        let filtered = companies;
        if (tier) {
          filtered = companies.filter(c => c.tier === tier);
        }
        
        // Filter out helicopter-only clients if aircraft isn't a helicopter
        if (aircraftCategory && aircraftCategory !== 'helicopter') {
          filtered = filtered.filter(c => {
            // Check if ALL missions are helicopter-only
            const heliOnly = c.missions && c.missions.every(m => 
              m.toLowerCase().includes('heli') || m === 'CASEVAC'
            );
            return !heliOnly;
          });
        }
        
        // Filter out non-helicopter clients if aircraft IS a helicopter
        if (aircraftCategory === 'helicopter') {
          // Prefer helicopter-capable clients, but don't exclude all others
          const heliClients = filtered.filter(c => 
            c.missions && c.missions.some(m => 
              m.toLowerCase().includes('heli') || m === 'CASEVAC' || m === 'Medical Transfer'
            )
          );
          if (heliClients.length > 0) {
            filtered = heliClients;
          }
        }
        
        if (filtered.length > 0) {
          return randomItem(filtered);
        }
      }
      
      // Fallback if no clients database
      return {
        name: 'General Aviation Services',
        tier: 'regional',
        missions: ['Charter Flight'],
        payModifier: 1.0
      };
    }
    
    function generateIndividualClient() {
      if (CLIENTS && CLIENTS.firstNames && CLIENTS.lastNames) {
        const firstName = randomItem(CLIENTS.firstNames);
        const lastName = randomItem(CLIENTS.lastNames);
        return {
          name: `${firstName} ${lastName}`,
          tier: 'budget',
          missions: ['Charter Flight', 'Sightseeing Tour', 'Discovery Flight'],
          payModifier: 0.85
        };
      }
      return {
        name: 'John Smith',
        tier: 'budget',
        missions: ['Charter Flight'],
        payModifier: 0.85
      };
    }
    
    function generateContactName() {
      if (CLIENTS && CLIENTS.firstNames && CLIENTS.lastNames) {
        const firstName = randomItem(CLIENTS.firstNames);
        const lastName = randomItem(CLIENTS.lastNames);
        return `${firstName} ${lastName}`;
      }
      return 'Contact Person';
    }

    function addMinutes(t, minutes) {
      return minutesToGameTime(gameTimeToMinutes(t) + minutes);
    }

    function roundToHour(t) {
      // Round minutes to nearest hour (0 or 60)
      const rounded = t.minute >= 30 ? 60 : 0;
      if (rounded === 60) {
        return addMinutes({ ...t, minute: 0 }, 60);
      }
      return { ...t, minute: 0 };
    }

    function formatGameTime(t) {
      if (!t) return '--';
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const mo = monthNames[(t.month || 1) - 1] || 'Jan';
      const h = (t.hour || 0).toString().padStart(2, '0');
      const min = (t.minute || 0).toString().padStart(2, '0');
      return `${mo} ${t.day || 1}, ${t.year || 2025} ${h}:${min}`;
    }
    
    function formatGameDate(t) {
      if (!t) return '--';
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const mo = monthNames[(t.month || 1) - 1] || 'Jan';
      return `${mo} ${t.day || 1}, ${t.year || 2025}`;
    }

    function compareGameTime(a, b) {
      return gameTimeToMinutes(a) - gameTimeToMinutes(b);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3440.065;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    
    // Normalize airport data to handle different coordinate property names
    // Provides both latitude/longitude AND lat/lon for compatibility
    function getAirport(icao) {
      const apt = AIRPORTS[icao];
      if (!apt) return null;
      
      // Normalize coordinates - check all possible property names
      const latitude = apt.latitude || apt.lat;
      const longitude = apt.longitude || apt.lon || apt.lng;
      
      return {
        ...apt,
        icao: apt.icao || icao,
        name: apt.name || icao,
        // Provide BOTH naming conventions for full compatibility
        latitude: latitude,
        longitude: longitude,
        lat: latitude,
        lon: longitude
      };
    }
    
    function getLandmark(code) {
      const lm = LANDMARKS[code];
      if (!lm) return null;
      return { ...lm, code };
    }
    
    function getLandmarksNear(lat, lon, maxDistNm = 150, limit = 10) {
      // Find landmarks within maxDistNm of given coordinates
      const results = [];
      for (const [code, lm] of Object.entries(LANDMARKS)) {
        const dist = calculateDistance(lat, lon, lm.lat, lm.lon);
        if (dist <= maxDistNm) {
          results.push({ ...lm, code, distance: Math.round(dist) });
        }
      }
      // Sort by distance and limit
      results.sort((a, b) => a.distance - b.distance);
      return results.slice(0, limit);
    }
    
    // Normalize ALL airports in the database after loading
    // This ensures consistent property names throughout the app
    function normalizeAllAirports() {
      const icaos = Object.keys(AIRPORTS);
      let normalized = 0;
      
      for (const icao of icaos) {
        const apt = AIRPORTS[icao];
        if (!apt) continue;
        
        // Get coordinates from any property name
        const latitude = apt.latitude || apt.lat;
        const longitude = apt.longitude || apt.lon || apt.lng;
        
        // Add both naming conventions
        if (latitude !== undefined) {
          apt.latitude = latitude;
          apt.lat = latitude;
        }
        if (longitude !== undefined) {
          apt.longitude = longitude;
          apt.lon = longitude;
        }
        
        // Ensure icao is set
        if (!apt.icao) apt.icao = icao;
        
        normalized++;
      }
      
      debugLog('Normalized ' + normalized + ' airports with coordinate aliases');
    }

    function saveState() {
      // Validate gameTime before saving - prevent day: 0 bug
      if (S.gameTime && S.gameTime.day < 1) {
        S.gameTime.day = 1;
      }
      localStorage.setItem('skylift_ledger', JSON.stringify(S));
    }

    function loadState() {
      const saved = localStorage.getItem('skylift_ledger');
      console.log('loadState - raw localStorage:', saved);
      
      if (saved) {
        const loaded = JSON.parse(saved);
        console.log('loadState - parsed, version:', loaded.version);
        
        // === LEGACY MIGRATIONS (pre-0.1.28) ===
        if (!loaded.fleet) loaded.fleet = ["C172_SKYHAWK"];
        if (!loaded.certifications) loaded.certifications = ["C172_SKYHAWK"];
        if (!loaded.contracts) loaded.contracts = [];
        if (!loaded.scheduledFlights) loaded.scheduledFlights = [];
        
        if (!loaded.fleetData) {
          loaded.fleetData = {};
          loaded.fleet.forEach(code => {
            const aircraft = AIRCRAFT[code];
            if (aircraft) {
              loaded.fleetData[code] = {
                currentFuel: aircraft.fuel_capacity,
                condition: 100
              };
            }
          });
        }
        if (!loaded.pilotLog) loaded.pilotLog = [];
        if (!loaded.totalHoursFlown) loaded.totalHoursFlown = 0;
        if (!loaded.totalMilesFlown) loaded.totalMilesFlown = 0;
        if (!loaded.maintenanceReserve) loaded.maintenanceReserve = 0;
        if (loaded.mxReserveRate === undefined) loaded.mxReserveRate = 15;
        if (!loaded.cashWarningsSent) loaded.cashWarningsSent = { ten: false, five: false, one: false };
        
        // === v0.1.28 MIGRATIONS ===
        
        // Migrate homeBase to bases.primary
        if (!loaded.bases) {
          loaded.bases = { primary: loaded.homeBase || null };
        }
        
        // Migrate to sandbox mode with full access for existing players
        if (!loaded.gameMode) {
          loaded.gameMode = "sandbox";
        }
        
        // Initialize difficulty settings
        if (!loaded.difficultySettings) {
          loaded.difficultySettings = {
            reviewFrequency: "normal",
            ratingSensitivity: "normal",
            ratingRecovery: "normal",
            hourRequirements: "normal",
            missionThresholds: "normal",
            checkrideDifficulty: "normal",
            ownedMissionRatio: 0.6,
            emailsPerDay: 3
          };
        }
        
        // Migrate missing emailsPerDay (v0.1.59)
        if (loaded.difficultySettings && !loaded.difficultySettings.emailsPerDay) {
          loaded.difficultySettings.emailsPerDay = 3;
        }
        
        // Migrate missing fixedPriceMode (v0.2.28)
        if (loaded.difficultySettings && loaded.difficultySettings.fixedPriceMode === undefined) {
          loaded.difficultySettings.fixedPriceMode = false;
        }
        
        // Migrate financial multipliers (v0.2.47)
        if (loaded.difficultySettings) {
          if (loaded.difficultySettings.ownedRevenueMultiplier === undefined) {
            loaded.difficultySettings.ownedRevenueMultiplier = 1.0;
          }
          if (loaded.difficultySettings.contractRevenueMultiplier === undefined) {
            loaded.difficultySettings.contractRevenueMultiplier = 1.0;
          }
          if (loaded.difficultySettings.fuelCostMultiplier === undefined) {
            loaded.difficultySettings.fuelCostMultiplier = 1.0;
          }
          if (loaded.difficultySettings.operatingCostMultiplier === undefined) {
            loaded.difficultySettings.operatingCostMultiplier = 1.0;
          }
          if (loaded.difficultySettings.interestRateMultiplier === undefined) {
            loaded.difficultySettings.interestRateMultiplier = 1.0;
          }
          if (loaded.difficultySettings.insuranceCostMultiplier === undefined) {
            loaded.difficultySettings.insuranceCostMultiplier = 1.0;
          }
          // v0.4 MX difficulty multipliers
          if (loaded.difficultySettings.mxCostMultiplier === undefined) {
            loaded.difficultySettings.mxCostMultiplier = 1.0;
          }
          if (loaded.difficultySettings.squawkFrequencyMultiplier === undefined) {
            loaded.difficultySettings.squawkFrequencyMultiplier = 1.0;
          }
          if (loaded.difficultySettings.conditionDegradationMultiplier === undefined) {
            loaded.difficultySettings.conditionDegradationMultiplier = 1.0;
          }
        }
        
        // v0.4 - Initialize MX tracking fields for existing fleet
        if (loaded.fleetData) {
          for (const code of Object.keys(loaded.fleetData)) {
            const fd = loaded.fleetData[code];
            if (fd.hoursSinceInspection === undefined) fd.hoursSinceInspection = 0;
            if (fd.hoursSinceOverhaul === undefined) {
              // Estimate based on total hours if available
              fd.hoursSinceOverhaul = Math.min(fd.hours || 0, 1000);
            }
            if (fd.hoursSinceMajorService === undefined) fd.hoursSinceMajorService = 0;
            if (fd.mxStatus === undefined) fd.mxStatus = 'airworthy';
            if (fd.squawks === undefined) fd.squawks = [];
            if (fd.scheduledMx === undefined) fd.scheduledMx = null;
          }
        }
        
        // Fix future-dated emails in existing saves (v0.2.43)
        // Emails should never have receivedAt in the future relative to when they were generated
        if (loaded.emails && loaded.emails.length > 0) {
          loaded.emails.forEach(email => {
            if (email.receivedAt && email.generatedDay !== undefined) {
              // Check if receivedAt is on a day after generatedDay or has future hour
              const receivedDay = email.receivedAt.day;
              const receivedMonth = email.receivedAt.month;
              const receivedYear = email.receivedAt.year;
              const genDay = email.generatedDay;
              const genMonth = email.generatedMonth || email.receivedAt.month;
              const genYear = email.generatedYear || email.receivedAt.year;
              
              // If received date is in the future relative to game time, clamp it
              if (loaded.gameTime) {
                const gtMinutes = loaded.gameTime.year * 525600 + (loaded.gameTime.month - 1) * 43200 + 
                                  (loaded.gameTime.day - 1) * 1440 + loaded.gameTime.hour * 60;
                const recMinutes = receivedYear * 525600 + (receivedMonth - 1) * 43200 + 
                                   (receivedDay - 1) * 1440 + email.receivedAt.hour * 60;
                
                if (recMinutes > gtMinutes) {
                  // Email is in the future - set to 1 hour before current game time
                  const fixedHour = Math.max(8, loaded.gameTime.hour - 1);
                  email.receivedAt = {
                    year: loaded.gameTime.year,
                    month: loaded.gameTime.month,
                    day: loaded.gameTime.day,
                    hour: fixedHour,
                    minute: 0
                  };
                  console.log('Fixed future-dated email:', email.subject);
                }
              }
            }
          });
        }
        
        // Initialize auto-save settings (v0.2.27)
        if (loaded.autoSaveFrequency === undefined) {
          loaded.autoSaveFrequency = "weekly";
        }
        if (loaded.lastAutoSave === undefined) {
          loaded.lastAutoSave = null;
        }
        
        // Migrate companyName (v0.1.59)
        if (loaded.companyName === undefined) {
          loaded.companyName = null;
        }
        
        // Initialize pilot profile
        if (!loaded.pilot) {
          // Existing players get full access in sandbox mode
          loaded.pilot = {
            name: "Pilot",
            certificates: ["student", "private", "commercial", "atp"],
            ratings: ["night", "instrument", "multiEngine", "helicopter", "seaplane", "turbine"],
            aircraftCertifications: loaded.certifications || ["C172_SKYHAWK"],
            hoursByCategory: {
              night: 0,
              instrument: 0,
              multiEngine: 0,
              helicopter: 0,
              seaplane: 0,
              turbine: 0
            },
            missionsCompleted: loaded.pilotLog ? loaded.pilotLog.length : 0,
            missionsPerfect: 0,
            experiencePoints: 0,
            experienceTier: 'rookie',
            firstTimeCompletions: {
              missionTypes: [],
              aircraftTypes: []
            }
          };
        }
        
        // Migrate pilot to new XP system (v0.3)
        if (loaded.pilot && loaded.pilot.experiencePoints === undefined) {
          // Estimate XP from existing missions: ~3 points per completed flight
          const estimatedXP = (loaded.pilotLog?.length || 0) * 3;
          loaded.pilot.experiencePoints = estimatedXP;
          loaded.pilot.experienceTier = calculateExperienceTier(estimatedXP);
          loaded.pilot.firstTimeCompletions = {
            missionTypes: [],
            aircraftTypes: loaded.pilot.aircraftCertifications || []
          };
        }
        
        // Migrate existing pilot profiles to include ATP if missing (v0.1.59)
        if (loaded.pilot && !loaded.pilot.certificates.includes('atp') && loaded.gameMode === 'sandbox') {
          loaded.pilot.certificates.push('atp');
        }
        
        // Initialize reputation
        if (!loaded.reputation) {
          loaded.reputation = {
            stars: 0,
            totalReviews: 0,
            recentRatings: [],
            reviewLog: []
          };
        }
        
        // Initialize insurance (v0.3.11)
        if (!loaded.insurance) {
          loaded.insurance = {
            currentPremium: 0,
            lastPremiumDate: null,
            incidentFreeMonths: 0,
            lastMonthHours: 0,
            lastMonthMissionRisk: 1.0
          };
        }
        
        // Initialize checkrides
        if (!loaded.checkrides) {
          loaded.checkrides = {
            scheduled: [],
            completed: [],
            failed: []
          };
        }
        
        // Initialize mission preferences (v0.1.59)
        if (!loaded.missionPreferences) {
          loaded.missionPreferences = {};
        }
        
        // Initialize game settings (v0.1.60)
        if (!loaded.gameSettings) {
          loaded.gameSettings = { allowCustomMissions: true };
        }
        
        // Fix gameTime if day is 0 (v0.1.61)
        if (loaded.gameTime && loaded.gameTime.day === 0) {
          loaded.gameTime.day = 1;
        }
        
        // Initialize parked aircraft (v0.1.59)
        if (!loaded.parkedAircraft) {
          loaded.parkedAircraft = {};
        }
        
        // Initialize aircraft settings (v0.1.59)
        if (!loaded.hiddenAircraft) {
          loaded.hiddenAircraft = [];
        }
        if (!loaded.customAircraft) {
          loaded.customAircraft = {};
        }
        
        // Initialize tutorial flag (v0.1.59)
        // Existing saves with PPL already earned count as tutorial complete
        if (loaded.tutorialComplete === undefined) {
          loaded.tutorialComplete = loaded.pilot?.certificates?.includes('private') || loaded.gameMode === 'sandbox';
        }
        
        // === v0.1.87 Market System Migrations ===
        if (!loaded.marketListings) {
          loaded.marketListings = [];
        }
        if (!loaded.marketLastRefresh) {
          loaded.marketLastRefresh = null;
        }
        if (!loaded.loans) {
          loaded.loans = [];
        }
        if (!loaded.leases) {
          loaded.leases = [];
        }
        
        // v0.2.04: Small plane pricing - raised floor 55%â†’65%, reduced hours penalty 15%â†’10%
        if (!loaded.version || loaded.version < "0.2.04") {
          loaded.marketListings = [];
          loaded.marketLastRefresh = null;
          loaded.brokerRequest = null;
          console.log('v0.2.04 migration: Small plane pricing boost (trainer scarcity premium)');
        }
        
        // ALWAYS validate existing listings - remove any with impossible hours
        if (loaded.marketListings && loaded.marketListings.length > 0) {
          const currentYear = loaded.gameTime?.year || 2025;
          const validListings = loaded.marketListings.filter(listing => {
            const age = Math.max(1, currentYear - listing.year);
            const maxPossibleHours = age * 4500; // Absolute physical max
            if (listing.totalHours > maxPossibleHours) {
              console.log(`Removing invalid listing: ${listing.year} ${listing.aircraftCode} with ${listing.totalHours} hrs (max possible: ${maxPossibleHours})`);
              return false;
            }
            return true;
          });
          if (validListings.length !== loaded.marketListings.length) {
            console.log(`Removed ${loaded.marketListings.length - validListings.length} listings with impossible hours`);
            loaded.marketListings = validListings;
          }
        }
        
        // Ensure brokerRequest exists
        if (loaded.brokerRequest === undefined) {
          loaded.brokerRequest = null;
        }
        
        // === v0.2.05 LEDGER SYSTEM MIGRATIONS ===
        if (!loaded.lineOfCredit) {
          loaded.lineOfCredit = {
            balance: 0,
            limit: 25000,
            apr: 0.06,
            minPaymentPct: 0.05,
            lastInterestDate: null,
            missedPayments: 0
          };
        }
        if (!loaded.ownerCompensation) {
          loaded.ownerCompensation = {
            monthlySalary: 4000,
            nextDrawDate: null,
            ytdDraws: 0,
            allTimeDraws: 0
          };
        }
        // Migrate allTimeDraws for existing saves (v0.2.27)
        if (loaded.ownerCompensation && loaded.ownerCompensation.allTimeDraws === undefined) {
          // Estimate from ytdDraws - not perfect but reasonable
          loaded.ownerCompensation.allTimeDraws = loaded.ownerCompensation.ytdDraws || 0;
        }
        if (!loaded.transactions) {
          loaded.transactions = [];
        }
        if (!loaded.financials) {
          loaded.financials = {
            startingCapital: 0,
            retainedEarnings: 0,
            basesPropertyValue: 0,
            revenueThisMonth: 0,
            expensesThisMonth: 0,
            revenueYTD: 0,
            expensesYTD: 0,
            revenueAllTime: 0,
            expensesAllTime: 0,
            lastMonthReset: null
          };
        }
        // Migrate startingCapital for existing saves (v0.2.27)
        if (loaded.financials && loaded.financials.startingCapital === undefined) {
          // For existing players, estimate starting capital as 25000 (default) or calculate from current state
          // Since we don't know actual starting capital, use the default
          loaded.financials.startingCapital = 25000;
        }
        
        // Migrate pendingEmails for existing saves (v0.2.18+)
        if (!loaded.pendingEmails) {
          loaded.pendingEmails = [];
        }
        
        // Migrate lenderAssessment for existing saves (v0.2.27)
        if (!loaded.lenderAssessment) {
          loaded.lenderAssessment = {
            tier: 'startup',
            monthsInBusiness: 0,
            onTimePayments: 0,
            missedPayments: 0,
            lastCalculated: null,
            dscr: 0,
            leverageRatio: 0,
            cashReserveMonths: 0
          };
        } else if (!loaded.lenderAssessment.lastCalculated) {
          // Fix v0.2.22-24 saves that had wrong estimated monthsInBusiness
          loaded.lenderAssessment.monthsInBusiness = 0;
        }
        
        // Ensure loans and leases arrays exist
        if (!loaded.loans) loaded.loans = [];
        if (!loaded.leases) loaded.leases = [];
        
        // === v0.5 STAFF SYSTEM MIGRATIONS ===
        if (!loaded.staff) {
          loaded.staff = [];
        }
        if (!loaded.staffMarketplace) {
          loaded.staffMarketplace = [];
        }
        if (!loaded.staffMarketplaceLastRefresh) {
          loaded.staffMarketplaceLastRefresh = null;
        }
        if (!loaded.payroll) {
          loaded.payroll = {
            lastProcessed: null,
            totalMonthly: 0
          };
        }
        if (!loaded.staffMissions) {
          loaded.staffMissions = [];
        }
        
        // Initialize support staff if not present
        if (!loaded.supportStaff) {
          loaded.supportStaff = { marketing: null, accountant: null };
        }
        
        // v0.5.09 migration: Clear marketplace to regenerate with correct support staff salaries
        if (loaded.version && loaded.version < "0.5.09") {
          loaded.staffMarketplace = [];
          loaded.staffMarketplaceLastRefresh = null;
        }
        
        // v0.5.10 migration: Initialize staffTraining array
        if (!loaded.staffTraining) {
          loaded.staffTraining = [];
        }
        
        // v0.7.10 migration: Convert to multi-base structure
        if (!loaded.bases.list) {
          const primaryIcao = loaded.bases.primary;
          const primaryBase = {
            id: 'base_primary',
            icao: primaryIcao,
            name: primaryIcao ? `${primaryIcao} Operations` : 'Primary Operations',
            isPrimary: true,
            established: { year: 2025, month: 1, day: 1 },
            hangars: [],
            rampAircraft: [],
            mxFacility: null,
            partsRoom: false,
            fuelStorage: {
              '100LL': [],
              'JetA': []
            },
            construction: []
          };
          
          loaded.bases = {
            primary: primaryIcao,
            list: [primaryBase]
          };
          
          // Assign all existing aircraft to primary base
          if (loaded.fleetData) {
            for (const code of Object.keys(loaded.fleetData)) {
              loaded.fleetData[code].homeBase = 'base_primary';
            }
          }
          
          // Ensure all staff have assignedBase set to primary ICAO
          if (loaded.staff) {
            loaded.staff.forEach(s => {
              if (!s.assignedBase) {
                s.assignedBase = primaryIcao;
              }
            });
          }
        }
        
        // Update version
        loaded.version = "0.7.10";
        
        return loaded;
      }
      console.log('loadState - no saved state, returning DEFAULT_STATE');
      return structuredClone(DEFAULT_STATE);
    }
    
    // Helper function to calculate experience tier based on hours and missions
    function calculateExperienceTier(points) {
      if (points >= 750) return "master";
      if (points >= 400) return "veteran";
      if (points >= 200) return "professional";
      if (points >= 75) return "journeyman";
      if (points >= 25) return "novice";
      return "rookie";
    }
    
    // Get pay multiplier for current tier
    function getTierPayMultiplier() {
      const tier = S.pilot.experienceTier || 'rookie';
      return EXPERIENCE_TIERS[tier]?.payMultiplier || 1.0;
    }
    
    // Get missions available for player's current tier
    function getAvailableMissionTypes() {
      const tierOrder = ['rookie', 'novice', 'journeyman', 'professional', 'veteran', 'master'];
      const currentTierIndex = tierOrder.indexOf(S.pilot.experienceTier || 'rookie');
      
      let available = [];
      for (let i = 0; i <= currentTierIndex; i++) {
        const tierMissions = MISSION_TIER_REQUIREMENTS[tierOrder[i]] || [];
        available = available.concat(tierMissions);
      }
      return available;
    }
    
    // Award experience points and check for tier-up
    function awardExperiencePoints(basePoints, context = {}) {
      const { isContract, isNight, isIFR, missionType, aircraftCode, isEmergency } = context;
      
      let points = basePoints;
      
      // Contract bonus (slider-controlled, default +3)
      if (isContract) {
        const contractBonus = S.difficultySettings?.contractBonus ?? 3;
        points += contractBonus;
      }
      
      // Condition bonuses
      if (isNight) points += 1;
      if (isIFR) points += 2;
      if (isEmergency) points += 3;
      
      // First-time bonuses
      if (missionType && !S.pilot.firstTimeCompletions.missionTypes.includes(missionType)) {
        S.pilot.firstTimeCompletions.missionTypes.push(missionType);
        points += 10;
      }
      if (aircraftCode && !S.pilot.firstTimeCompletions.aircraftTypes.includes(aircraftCode)) {
        S.pilot.firstTimeCompletions.aircraftTypes.push(aircraftCode);
        points += 5;
      }
      
      // Apply XP rate multiplier (slider-controlled, default 1.0)
      const xpMultiplier = S.difficultySettings?.xpMultiplier ?? 1.0;
      points = Math.round(points * xpMultiplier);
      
      // Apply marketing specialist rep bonus (if hired)
      const marketingRepBonus = getMarketingRepBonus();
      if (marketingRepBonus > 0) {
        points = Math.round(points * (1 + marketingRepBonus));
      }
      
      S.pilot.experiencePoints = (S.pilot.experiencePoints || 0) + points;
      
      // Check for tier-up
      const oldTier = S.pilot.experienceTier;
      const newTier = calculateExperienceTier(S.pilot.experiencePoints);
      if (newTier !== oldTier) {
        S.pilot.experienceTier = newTier;
        // Generate tier-up email (except for rookie which is starting tier)
        if (newTier !== 'rookie') {
          const tierEmail = generateTierUpEmail(newTier);
          if (tierEmail) {
            S.emails.push(tierEmail);
          }
        }
      }
      
      return points;
    }
    
    // Generate tier-up email based on new tier
    function generateTierUpEmail(tier) {
      const emails = {
        novice: {
          subject: 'Your Reputation is Growing',
          body: `Captain,\n\n` +
                `You're starting to make a name for yourself. A few successful flights under your belt, and people are beginning to take notice.\n\n` +
                `You'll now have access to some new contract opportunities â€” nothing too demanding yet, but a step up from where you started. Keep building that track record.\n\n` +
                `Blue skies,\n` +
                `Skylift Operations`
        },
        journeyman: {
          subject: 'Clients Are Asking for You',
          body: `Captain,\n\n` +
                `Word is getting around. Dispatchers are starting to mention your name when clients ask for reliable pilots, and operators are more willing to hand you their keys.\n\n` +
                `This opens doors to more interesting work â€” longer routes, better aircraft, clients who expect more but pay accordingly.\n\n` +
                `Keep it up.\n\n` +
                `Blue skies,\n` +
                `Skylift Operations`
        },
        professional: {
          subject: "You've Earned Their Trust",
          body: `Captain,\n\n` +
                `You've crossed a threshold. The operators who once watched you carefully now recommend you without hesitation. Corporate clients and medical teams are adding you to their preferred lists.\n\n` +
                `The jobs coming your way will reflect that trust â€” and so will the compensation.\n\n` +
                `Blue skies,\n` +
                `Skylift Operations`
        },
        veteran: {
          subject: 'A Reputation That Precedes You',
          body: `Captain,\n\n` +
                `Your name carries weight now. When the difficult jobs come in â€” the ones that require experience and steady hands â€” you're on the short list.\n\n` +
                `Emergency services, critical cargo, high-value clients: they're all within reach. You've earned this.\n\n` +
                `Blue skies,\n` +
                `Skylift Operations`
        },
        master: {
          subject: 'Among the Best',
          body: `Captain,\n\n` +
                `There's not much left to prove. You've built the kind of reputation that most pilots only dream about. The most demanding clients, the most sensitive cargo, the flights where failure isn't an option â€” they come to you now.\n\n` +
                `Command the rates you deserve. You've earned every penny.\n\n` +
                `Blue skies,\n` +
                `Skylift Operations`
        }
      };
      
      const emailContent = emails[tier];
      if (!emailContent) return null;
      
      return {
        id: uuid(),
        type: 'notification',
        from: 'Skylift Operations',
        company: 'Business Advisory',
        subject: emailContent.subject,
        body: emailContent.body,
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year
      };
    }
    window.generateTierUpEmail = generateTierUpEmail;
    
    // Deduct experience points (for penalties)
    function deductExperiencePoints(points, reason) {
      S.pilot.experiencePoints = Math.max(0, (S.pilot.experiencePoints || 0) - points);
      
      // Check for tier-down
      const oldTier = S.pilot.experienceTier;
      const newTier = calculateExperienceTier(S.pilot.experiencePoints);
      if (newTier !== oldTier) {
        S.pilot.experienceTier = newTier;
      }
    }
    
    // === REVIEW GENERATION SYSTEM ===
    const REVIEW_TEMPLATES = {
      corporate: {
        timing: {
          early: ['Arrived ahead of schedule.', 'Earlier than expected â€” appreciated.', 'Wheels down before our meeting prep even started.', 'Time to spare. Exactly what we needed.', 'Early arrival gave us breathing room.'],
          ontime: ['Punctual service.', 'On schedule.', 'Timely arrival.', 'Precise timing.', 'Arrived exactly as planned.'],
          late: ['Took longer than expected.', 'Flight ran over time.', 'We were watching the clock.', 'Arrival pushed our schedule.', 'Later than quoted.'],
          verylate: ['Unacceptable delays.', 'Significantly late. Unprofessional.', 'Time is money â€” this cost us.', 'Missed our window entirely.', 'We had to reschedule because of this.']
        },
        comfort: {
          5: ['Smooth, professional flight.', 'Excellent service.', 'Flawless execution.', 'First-class experience.', "Couldn't ask for better."],
          4: ['Comfortable flight.', 'Good service.', 'Met expectations.', 'Solid experience.', 'Professional handling.'],
          3: ['Adequate.', 'Acceptable service.', 'Nothing special.', 'Got the job done.', 'Met minimum expectations.'],
          2: ['Below expectations.', 'Rougher than acceptable.', 'Room for improvement.', 'Not up to our standards.', 'Disappointing experience.'],
          1: ['Completely unacceptable.', 'Will not use again.', 'Unprofessional service.', 'Far below standards.', 'A serious disappointment.']
        },
        damage: ['Noticed a rough landing.', 'Landing was concerning.', 'Some issues on arrival.', 'The landing gave us pause.', 'Rougher than expected on touchdown.'],
        closers: {
          positive: ['Will use again.', 'Recommended.', 'Reliable operator.', 'Added to our preferred list.', 'Looking forward to next time.'],
          negative: ['Will be looking elsewhere.', 'Cannot recommend.', 'Reconsidering our options.', "Won't be calling back.", 'Removed from our list.']
        }
      },
      tourism: {
        timing: {
          early: ['Got there early!', 'Quick flight!', 'Landed with time to explore!', 'Faster than we expected!', 'Early arrival was a nice surprise.'],
          ontime: ['Right on time.', 'Perfect timing.', 'Exactly as scheduled.', 'No waiting around.', 'Started and ended on the dot.'],
          late: ['Ran a bit over time.', 'Took a little longer than expected.', 'Cut into our afternoon plans.', 'Longer than advertised.', 'Could have been quicker.'],
          verylate: ['Way longer than promised!', 'Almost missed our plans!', 'Felt like forever!', 'Totally threw off our day.', 'We were so late to dinner!']
        },
        comfort: {
          5: ['So smooth! Loved it!', 'Amazing experience!', 'Best flight ever!', 'Absolutely incredible!', "My family couldn't stop smiling!"],
          4: ['Nice and easy ride.', 'Really enjoyed it.', 'Fun flight!', 'Great views, smooth ride.', 'Kids loved it!'],
          3: ['It was okay.', 'Fine, I guess.', 'Pretty average.', 'Nothing to write home about.', 'Decent enough.'],
          2: ['Pretty bumpy ride.', 'Not super comfortable.', 'Expected better.', 'A bit rough for my taste.', "My stomach didn't love it."],
          1: ['Scary experience!', 'Never again!', 'Terrifying!', 'I was gripping my seat the whole time.', 'Kids were crying.']
        },
        damage: ['Landing was a bit hard.', 'That landing was scary!', 'Rough ending to the flight.', 'The landing made everyone gasp.', 'Bounced pretty hard on touchdown.'],
        closers: {
          positive: ['Would definitely recommend!', "Can't wait to do it again!", '10/10!', 'Already told all our friends!', 'Highlight of our trip!'],
          negative: ['Would not recommend.', 'Save your money.', "Don't bother.", "Wish we'd gone with someone else.", 'Total letdown.']
        }
      },
      cargo: {
        timing: {
          early: ['Delivery ahead of schedule.', 'Arrived early.', 'Beat the deadline.', 'Early delivery â€” client was impressed.', 'Ahead of the window.'],
          ontime: ['Shipment arrived as scheduled.', 'On-time delivery.', 'Hit our window.', 'Right on schedule.', 'Delivered as promised.'],
          late: ['Slight delay on delivery.', 'Missed window by a bit.', 'Cutting it close.', 'Later than planned.', 'Had to explain the delay to our client.'],
          verylate: ['Missed delivery window.', 'Significant delays. Unacceptable.', 'Cost us a client.', 'Completely missed the deadline.', 'We lost money on this one.']
        },
        comfort: {
          5: ['No issues.', 'Perfect handling.', 'Cargo pristine.', 'Everything arrived in perfect condition.', 'Exactly what we expect from a pro.'],
          4: ['Handled well.', 'Good condition on arrival.', 'Minor scuffs but nothing serious.', 'Cargo looked good.', 'Acceptable handling.'],
          3: ['Got the job done.', 'Acceptable.', 'Could have been more careful.', "Nothing broke, at least.", 'Adequate.'],
          2: ['Concerning handling.', 'Some issues noted.', 'Found damage on inspection.', 'Not impressed with the care taken.', 'Packaging was beat up.'],
          1: ['Unacceptable.', 'Will not use again.', 'Cargo damaged.', 'Filing a claim.', 'Complete disaster.']
        },
        damage: ['Minor concerns on arrival.', 'Some wear noted.', 'Package showed signs of rough handling.', 'Visible damage to packaging.', 'Contents shifted during transport.'],
        closers: {
          positive: ['Will use again.', 'Reliable service.', 'Added to our rotation.', 'Solid operator.', 'Our go-to from now on.'],
          negative: ['Looking for alternatives.', "Won't be calling back.", 'Removed from our vendor list.', 'Not worth the risk.', 'Find someone else.']
        }
      },
      medical: {
        timing: {
          early: ['Fast response time.', 'Ahead of schedule â€” critical in our work.', 'Every minute counts. They delivered.', 'Arrival time exceeded expectations.', 'The team was ready and waiting.'],
          ontime: ['Timely transport.', 'Met timeline.', 'On schedule.', 'Arrived as coordinated.', 'No delays.'],
          late: ['Slower than ideal.', 'Time-sensitive â€” delays are concerning.', 'Every minute matters in our field.', 'Later than we needed.', 'Cutting it too close.'],
          verylate: ['Critical time lost.', 'In our line of work, minutes matter.', 'Unacceptable for medical transport.', 'This delay had consequences.', 'We cannot afford this.']
        },
        comfort: {
          5: ['Patient transported comfortably.', 'Excellent care in transit.', 'Smooth, professional.', 'Patient arrived in stable condition.', 'Textbook transport.'],
          4: ['Good transport.', 'Patient comfortable.', 'Handled appropriately.', 'No complaints from medical staff.', 'Satisfactory.'],
          3: ['Acceptable.', 'Transport completed.', 'Met basic requirements.', 'Adequate handling.', 'Room for improvement.'],
          2: ['Bumpy transport.', 'Patient uncomfortable.', 'Rougher than acceptable for medical.', 'Staff had concerns.', 'Not ideal conditions.'],
          1: ['Patient distressed.', 'Unsafe handling.', 'Will not use for medical transport.', 'Unacceptable conditions.', 'Never again.']
        },
        damage: ['Rough landing noted.', 'Landing concerns for patient care.', 'Not smooth enough for medical.', 'The landing jarred the patient.', 'Medical staff were not pleased with the landing.'],
        closers: {
          positive: ['Will request again.', 'Added to our approved list.', 'Trusted operator.', 'The kind of service we need.', 'Highly recommended for medical.'],
          negative: ['Will not use again.', 'Removed from our approved list.', 'Not suitable for medical transport.', 'Cannot recommend.', 'Finding alternatives.']
        }
      }
    };
    
    // Get client type category from client tier
    function getClientReviewType(clientTier, missionType) {
      // Medical missions always use medical voice
      if (['Air Ambulance', 'Medical Transfer', 'Organ Transport', 'Heli EMS', 'CASEVAC'].includes(missionType)) {
        return 'medical';
      }
      // Cargo missions
      if (['General Cargo', 'Freight Haul', 'Mail Run', 'Hazmat Transport', 'Bush Resupply'].includes(missionType)) {
        return 'cargo';
      }
      // Tourism missions
      if (['Sightseeing Tour', 'Discovery Flight', 'Heli Tour', 'Thrill Flight'].includes(missionType)) {
        return 'tourism';
      }
      // Corporate based on client tier
      if (clientTier === 'corporate') return 'corporate';
      // Default to tourism for regional
      return 'tourism';
    }
    
    // Determine timing category from actual vs expected
    function getTimingCategory(actualMinutes, expectedMinutes) {
      const diff = actualMinutes - expectedMinutes;
      const pct = diff / expectedMinutes;
      
      if (pct <= -0.05) return 'early';      // 5%+ early
      if (pct <= 0.05) return 'ontime';      // Within 5%
      if (pct <= 0.15) return 'late';        // 5-15% over
      return 'verylate';                      // 15%+ over
    }
    
    // Calculate star rating from flight factors
    function calculateReviewRating(timing, selfAssessment, hasDamage) {
      // Start with self-assessment as base (more weight on actual performance)
      let rating = selfAssessment;
      
      // Timing factor - adjust from base
      if (timing === 'early') rating += 0.3;
      else if (timing === 'ontime') rating += 0;  // No bonus, no penalty
      else if (timing === 'late') rating -= 0.5;
      else if (timing === 'verylate') rating -= 1.0;
      
      // Damage penalty
      if (hasDamage) rating -= 1.5;
      
      // Apply sensitivity setting
      const sensitivity = S.difficultySettings?.ratingSensitivity || 'normal';
      if (sensitivity === 'harsh') {
        rating -= 0.3;
      } else if (sensitivity === 'generous') {
        rating += 0.3;
      }
      
      // Clamp to 1-5
      return Math.round(Math.max(1, Math.min(5, rating)));
    }
    
    // Check if review should be generated (probability based)
    function shouldGenerateReview(rating, clientTier, isEmergency) {
      const freqSetting = S.difficultySettings?.reviewFrequency || 'normal';
      let baseProbability = freqSetting === 'low' ? 0.15 : freqSetting === 'high' ? 0.45 : 0.30;
      
      // Modifiers
      if (isEmergency) baseProbability += 0.30;
      if (rating >= 5) baseProbability += 0.20;
      if (rating <= 2) baseProbability += 0.40;
      if (clientTier === 'corporate') baseProbability += 0.15;
      if (clientTier === 'regional') baseProbability -= 0.10;
      
      return Math.random() < Math.min(baseProbability, 0.95);
    }
    
    // Generate review text from fragments
    function generateReviewText(reviewType, timing, rating, hasDamage, conditions = {}) {
      const template = REVIEW_TEMPLATES[reviewType] || REVIEW_TEMPLATES.tourism;
      
      const parts = [];
      
      // Timing fragment
      const timingOptions = template.timing[timing] || template.timing.ontime;
      parts.push(timingOptions[Math.floor(Math.random() * timingOptions.length)]);
      
      // Comfort fragment
      const comfortOptions = template.comfort[rating] || template.comfort[3];
      parts.push(comfortOptions[Math.floor(Math.random() * comfortOptions.length)]);
      
      // Damage fragment (if applicable)
      if (hasDamage && template.damage) {
        parts.push(template.damage[Math.floor(Math.random() * template.damage.length)]);
      }
      
      // Weather/condition bonus (only for good flights)
      if (rating >= 4 && conditions.night) {
        parts.push('Handled night conditions well.');
      } else if (rating >= 4 && conditions.ifr) {
        parts.push('Navigated poor weather professionally.');
      }
      
      // Closer (30% chance)
      if (Math.random() < 0.3 && template.closers) {
        const closerType = rating >= 4 ? 'positive' : 'negative';
        const closerOptions = template.closers[closerType];
        if (closerOptions && closerOptions.length > 0) {
          parts.push(closerOptions[Math.floor(Math.random() * closerOptions.length)]);
        }
      }
      
      return parts.join(' ');
    }
    
    // Main review generation function (called after flight completion)
    function maybeGenerateReview(flightData) {
      const { 
        clientName, clientTier, missionType, 
        actualMinutes, expectedMinutes, 
        selfAssessment, hasDamage, 
        isNight, isIFR, isEmergency,
        origin, destination 
      } = flightData;
      
      const timing = getTimingCategory(actualMinutes, expectedMinutes);
      const rating = calculateReviewRating(timing, selfAssessment, hasDamage);
      
      // Check if review is generated
      if (!shouldGenerateReview(rating, clientTier, isEmergency)) {
        return null;
      }
      
      const reviewType = getClientReviewType(clientTier, missionType);
      const reviewText = generateReviewText(reviewType, timing, rating, hasDamage, { night: isNight, ifr: isIFR });
      
      const review = {
        id: 'REV-' + Date.now(),
        date: { ...S.gameTime },
        stars: rating,
        clientName: clientName,
        clientTier: clientTier,
        missionType: missionType,
        route: `${origin} â†’ ${destination}`,
        comment: reviewText
      };
      
      // Add to review log
      if (!S.reputation.reviewLog) S.reputation.reviewLog = [];
      S.reputation.reviewLog.unshift(review);
      
      // Keep only last 100 reviews in log
      if (S.reputation.reviewLog.length > 100) {
        S.reputation.reviewLog = S.reputation.reviewLog.slice(0, 100);
      }
      
      // Update recent ratings (last 20 for weighted average)
      if (!S.reputation.recentRatings) S.reputation.recentRatings = [];
      S.reputation.recentRatings.unshift(rating);
      if (S.reputation.recentRatings.length > 20) {
        S.reputation.recentRatings = S.reputation.recentRatings.slice(0, 20);
      }
      
      // Recalculate average
      S.reputation.totalReviews = (S.reputation.totalReviews || 0) + 1;
      const sum = S.reputation.recentRatings.reduce((a, b) => a + b, 0);
      S.reputation.stars = Math.round((sum / S.reputation.recentRatings.length) * 10) / 10;
      
      // Penalty for 1-star review
      if (rating === 1) {
        deductExperiencePoints(2, '1-star review');
      }
      
      return review;
    }
    
    // Generate tip based on customer satisfaction
    function maybeGenerateTip(review, assessmentOverall, baseRevenue, clientTier) {
      // Base tip chance depends on satisfaction
      let tipChance = 0;
      let tipPercent = 0;
      
      if (review) {
        // If review was generated, use star rating
        if (review.stars === 5) {
          tipChance = 0.40;  // 40% chance for 5-star
          tipPercent = 0.12 + Math.random() * 0.08;  // 12-20%
        } else if (review.stars === 4) {
          tipChance = 0.20;  // 20% chance for 4-star
          tipPercent = 0.08 + Math.random() * 0.07;  // 8-15%
        }
      } else {
        // No review - use assessment
        if (assessmentOverall === 'excellent') {
          tipChance = 0.25;  // 25% chance
          tipPercent = 0.10 + Math.random() * 0.05;  // 10-15%
        } else if (assessmentOverall === 'good') {
          tipChance = 0.10;  // 10% chance
          tipPercent = 0.05 + Math.random() * 0.05;  // 5-10%
        }
      }
      
      // Client tier affects tip likelihood and amount
      const tierMultipliers = {
        budget: { chance: 0.5, amount: 0.7 },      // Budget clients tip less often, smaller amounts
        regional: { chance: 1.0, amount: 1.0 },    // Baseline
        corporate: { chance: 1.3, amount: 1.5 },   // Corporate tips more often, larger amounts
        vip: { chance: 1.5, amount: 2.0 }          // VIPs generous with tips
      };
      
      const tierMod = tierMultipliers[clientTier] || tierMultipliers.regional;
      tipChance *= tierMod.chance;
      tipPercent *= tierMod.amount;
      
      // Overall reputation bonus - high stars means more tips
      const stars = S.reputation?.stars || 0;
      if (stars >= 4.5) {
        tipChance *= 1.2;  // 20% more likely if highly rated
      } else if (stars >= 4.0) {
        tipChance *= 1.1;  // 10% more likely
      }
      
      // Roll for tip
      if (Math.random() > tipChance) {
        return null;  // No tip
      }
      
      // Calculate tip amount
      const tipAmount = Math.round(baseRevenue * tipPercent);
      
      // Minimum tip of $20, max of $500
      if (tipAmount < 20) return null;
      const finalAmount = Math.min(tipAmount, 500);
      
      return {
        amount: finalAmount,
        percent: tipPercent
      };
    }
    
    // Get reputation badge based on star rating and review count
    function getReputationBadge(stars, reviewCount) {
      // Need minimum reviews to earn a badge
      if (reviewCount < 5) return '';
      
      let badge = '';
      let badgeColor = '';
      let badgeIcon = '';
      
      if (stars >= 4.8 && reviewCount >= 20) {
        badge = 'Elite Charter Service';
        badgeColor = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
        badgeIcon = 'ðŸ‘‘';
      } else if (stars >= 4.5 && reviewCount >= 15) {
        badge = 'Top Rated Operator';
        badgeColor = 'linear-gradient(135deg, #22c55e, #16a34a)';
        badgeIcon = 'ðŸ†';
      } else if (stars >= 4.0 && reviewCount >= 10) {
        badge = 'Highly Recommended';
        badgeColor = 'linear-gradient(135deg, #3b82f6, #2563eb)';
        badgeIcon = 'â­';
      } else if (stars >= 3.5 && reviewCount >= 5) {
        badge = 'Trusted Charter';
        badgeColor = 'linear-gradient(135deg, #64748b, #475569)';
        badgeIcon = 'âœ“';
      } else if (stars < 3.0 && reviewCount >= 5) {
        badge = 'Needs Improvement';
        badgeColor = 'linear-gradient(135deg, #ef4444, #dc2626)';
        badgeIcon = 'âš ';
      } else {
        return '';  // No badge for average ratings
      }
      
      return `
        <div style="margin-top: 12px; display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: ${badgeColor}; border-radius: 16px; font-size: 12px; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
          <span>${badgeIcon}</span>
          <span>${badge}</span>
        </div>
      `;
    }

    function resetGame() {
      if (confirm('Reset game? This will delete ALL progress, cached data, and return to the start screen.')) {
        // Clear all localStorage
        localStorage.removeItem('skylift_ledger');
        // Clear IndexedDB
        clearDatabaseCache().then(() => {
          location.reload();
        }).catch(() => {
          location.reload();
        });
      }
    }
    
    async function clearCacheAndReload() {
      if (confirm('Clear ALL game data? This will delete your game progress, aircraft database, and airports. You will need to reload everything.\n\n(Your save file will be lost!)')) {
        try {
          // Clear IndexedDB (aircraft/airports)
          await clearDatabaseCache();
          // Clear localStorage (game state)
          localStorage.removeItem('skylift_ledger');
          // Clear any other potential storage
          localStorage.clear();
          alert('All game data cleared! The page will now reload.');
          forceRefresh();
        } catch (error) {
          // Still try to clear localStorage even if IndexedDB fails
          localStorage.clear();
          alert('Cache cleared (with some errors). The page will now reload.');
          forceRefresh();
        }
      }
    }
    
    function forceRefresh() {
      // Clear any service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(reg => reg.unregister());
        });
      }
      
      // Clear caches if available
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => caches.delete(name));
        });
      }
      
      // Force reload bypassing cache by adding timestamp
      const url = new URL(window.location.href);
      url.searchParams.set('v', Date.now());
      window.location.href = url.toString();
    }
    window.forceRefresh = forceRefresh;
    
    // Export save state to JSON file
    async function exportSaveState() {
      const saveData = {
        version: S.version,
        exportedAt: new Date().toISOString(),
        gameState: S
      };
      
      const jsonString = JSON.stringify(saveData, null, 2);
      const pilotName = (S.pilot?.name || 'Pilot').replace(/[^a-zA-Z0-9]/g, '_');
      const dateStr = new Date().toISOString().split('T')[0];
      const filename = `skylift_save_${pilotName}_${dateStr}.json`;
      
      // Try File System Access API first (lets user pick save location)
      if ('showSaveFilePicker' in window) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{
              description: 'Skylift Save File',
              accept: { 'application/json': ['.json'] }
            }]
          });
          const writable = await handle.createWritable();
          await writable.write(jsonString);
          await writable.close();
          alert('Save file exported successfully!\n\nThe file has been saved to your chosen location.');
          return;
        } catch (err) {
          // User cancelled or API failed - fall back to download
          if (err.name === 'AbortError') return; // User cancelled
          console.log('File System Access API failed, using fallback:', err);
        }
      }
      
      // Fallback: Standard download (goes to Downloads folder)
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('Save file exported to your Downloads folder!\n\nNote: To save to a specific location, use Chrome or Edge browser which support choosing the save location.');
    }
    window.exportSaveState = exportSaveState;
    
    // Import save state from JSON file
    function importSaveState(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate save file
          if (!data.gameState || !data.gameState.version) {
            alert('Invalid save file format.');
            return;
          }
          
          // Confirm import
          const pilotName = data.gameState.pilot?.name || 'Unknown';
          const hours = data.gameState.totalHoursFlown?.toFixed(1) || '0';
          const cash = data.gameState.cash || 0;
          const exportDate = data.exportedAt ? new Date(data.exportedAt).toLocaleDateString() : 'Unknown';
          
          if (confirm(`Import this save file?\n\nPilot: ${pilotName}\nHours: ${hours}\nCash: $${cash.toLocaleString()}\nExported: ${exportDate}\n\nThis will REPLACE your current game progress!`)) {
            // Replace current state
            Object.assign(S, data.gameState);
            saveState();
            alert('Save file imported successfully! The page will reload.');
            location.reload();
          }
        } catch (error) {
          console.error('Import error:', error);
          alert('Failed to import save file. The file may be corrupted or in the wrong format.');
        }
      };
      reader.readAsText(file);
      
      // Reset file input so same file can be selected again
      event.target.value = '';
    }
    window.importSaveState = importSaveState;
    
    // === INSURANCE SYSTEM ===
    const INSURANCE_CONFIG = {
      // Tiered base rates - decreasing percentage for more expensive aircraft (matches real world)
      baseRateTiers: [
        { maxValue: 100000, rate: 0.0012 },    // 1.44% annual for aircraft under $100k
        { maxValue: 500000, rate: 0.0007 },    // 0.84% annual for $100k-$500k
        { maxValue: 2000000, rate: 0.0004 },   // 0.48% annual for $500k-$2M
        { maxValue: 10000000, rate: 0.00025 }, // 0.30% annual for $2M-$10M
        { maxValue: Infinity, rate: 0.00015 }  // 0.18% annual for $10M+
      ],
      // Category multipliers - some aircraft types are inherently more expensive to insure
      categoryMultipliers: {
        single_piston: 1.0,
        single_piston_hp: 1.1,
        multi_piston: 1.15,
        turboprop: 1.0,
        light_jet: 1.0,
        bush: 1.2,              // Remote ops, rough fields
        amphibious: 1.3,        // Water ops add risk
        helicopter: 1.4,        // Rotorcraft higher risk
        aerobatic: 1.5,         // High-risk maneuvers
        warbird: 4.0,           // Vintage, irreplaceable, high risk (~$50k/yr for P-51)
        airliner: 1.8,          // Commercial passenger ops, high liability
        cargo_heavy: 1.3,       // Heavy cargo ops
        specialty: 1.2          // Agricultural, survey, etc.
      },
      seatRate: 10,               // $10 per seat per month
      seatRateAirliner: 3,        // $3 per seat for airliners (bulk discount)
      hourRate: 1.5,              // $1.50 per flight hour last month
      missionRiskMultipliers: {
        cargo: 1.0,
        sightseeing: 1.0,
        charter: 1.1,
        passenger: 1.1,
        executive: 1.2,
        medical: 1.3,
        emergency: 1.5,
        hazmat: 1.6
      },
      experienceMultipliers: {
        rookie: 1.20,
        novice: 1.10,
        journeyman: 1.00,
        professional: 0.95,
        veteran: 0.85,
        master: 0.80
      },
      cleanRecordDiscountPerMonth: 0.02,  // 2% per incident-free month
      maxCleanRecordDiscount: 0.20        // Max 20% discount
    };
    
    // Get base rate for hull value (tiered)
    function getInsuranceBaseRate(hullValue) {
      for (const tier of INSURANCE_CONFIG.baseRateTiers) {
        if (hullValue <= tier.maxValue) {
          return tier.rate;
        }
      }
      return 0.0002; // fallback
    }
    
    // Get category multiplier for aircraft type
    function getInsuranceCategoryMultiplier(aircraftCode) {
      const aircraft = AIRCRAFT[aircraftCode];
      if (!aircraft) return 1.0;
      
      const category = aircraft.category || 'single_piston';
      return INSURANCE_CONFIG.categoryMultipliers[category] || 1.0;
    }
    
    // Get mission risk category for insurance
    function getMissionRiskCategory(missionType) {
      const hazmat = ['Hazmat Transport'];
      const emergency = ['Air Ambulance', 'Organ Transport', 'CASEVAC', 'Heli EMS', 'Heli SAR'];
      const medical = ['Medical Transfer'];
      const executive = ['Executive Transport'];
      const passenger = ['Charter Flight', 'Island Hopping', 'Airshow Rides', 'Historical Flight'];
      const cargo = ['General Cargo', 'Freight Haul', 'Mail Run', 'Bush Resupply', 'Ferry Flight', 'Humanitarian'];
      const sightseeing = ['Sightseeing Tour', 'Discovery Flight', 'Heli Tour', 'Thrill Flight', 'Aerial Photography', 'Aerial Survey'];
      
      if (hazmat.includes(missionType)) return 'hazmat';
      if (emergency.includes(missionType)) return 'emergency';
      if (medical.includes(missionType)) return 'medical';
      if (executive.includes(missionType)) return 'executive';
      if (passenger.includes(missionType)) return 'passenger';
      if (cargo.includes(missionType)) return 'cargo';
      return 'sightseeing';
    }
    
    // Calculate insurance premium for a single aircraft
    function calculateAircraftInsurancePremium(aircraftCode, fleetData) {
      const aircraft = AIRCRAFT[aircraftCode];
      if (!aircraft) return 0;
      
      const data = fleetData?.[aircraftCode] || {};
      const hullValue = data.bookValue || aircraft.price || 100000;
      const seats = aircraft.max_passengers || aircraft.passengers || 1;
      const category = aircraft.category || 'single_piston';
      
      // Base premium from hull value (tiered rate)
      const baseRate = getInsuranceBaseRate(hullValue);
      let premium = hullValue * baseRate;
      
      // Seat charge (airliners get bulk discount due to high seat counts)
      const isAirliner = category === 'airliner';
      const seatRate = isAirliner ? INSURANCE_CONFIG.seatRateAirliner : INSURANCE_CONFIG.seatRate;
      premium += seats * seatRate;
      
      // Apply category multiplier
      const categoryMult = INSURANCE_CONFIG.categoryMultipliers[category] || 1.0;
      premium *= categoryMult;
      
      return premium;
    }
    
    // Calculate total monthly insurance premium
    function calculateInsurancePremium() {
      const ownedAircraft = S.fleet.filter(code => {
        // Exclude leased aircraft
        const lease = S.leases?.find(l => l.aircraftCode === code);
        return !lease;
      });
      
      if (ownedAircraft.length === 0) return 0;
      
      // Base premium for all owned aircraft
      let basePremium = 0;
      let totalSeats = 0;
      
      ownedAircraft.forEach(code => {
        basePremium += calculateAircraftInsurancePremium(code, S.fleetData);
        const aircraft = AIRCRAFT[code];
        totalSeats += aircraft?.passengers || 1;
      });
      
      // Hours factor (from last month)
      const hoursPremium = (S.insurance?.lastMonthHours || 0) * INSURANCE_CONFIG.hourRate;
      
      // Mission risk factor (average from last month, default 1.0)
      const missionRiskMultiplier = S.insurance?.lastMonthMissionRisk || 1.0;
      
      // Experience multiplier
      const tier = S.pilot?.experienceTier || 'rookie';
      const experienceMultiplier = INSURANCE_CONFIG.experienceMultipliers[tier] || 1.0;
      
      // Clean record discount
      const incidentFreeMonths = S.insurance?.incidentFreeMonths || 0;
      const cleanDiscount = Math.min(
        incidentFreeMonths * INSURANCE_CONFIG.cleanRecordDiscountPerMonth,
        INSURANCE_CONFIG.maxCleanRecordDiscount
      );
      const cleanMultiplier = 1 - cleanDiscount;
      
      // Calculate total
      let totalPremium = (basePremium + hoursPremium) * missionRiskMultiplier * experienceMultiplier * cleanMultiplier;
      
      // Apply difficulty multiplier
      totalPremium = getEffectiveInsuranceCost(totalPremium);
      
      return Math.round(totalPremium);
    }
    
    // Project next month's premium based on current month's activity
    function projectNextMonthPremium() {
      const ownedAircraft = S.fleet.filter(code => {
        const lease = S.leases?.find(l => l.aircraftCode === code);
        return !lease;
      });
      
      if (ownedAircraft.length === 0) return 0;
      
      // Base premium for all owned aircraft
      let basePremium = 0;
      ownedAircraft.forEach(code => {
        basePremium += calculateAircraftInsurancePremium(code, S.fleetData);
      });
      
      // Current month hours so far (estimate full month)
      const currentDay = S.gameTime?.day || 1;
      const daysInMonth = 30;
      const monthlyHoursEstimate = currentDay > 0 
        ? (S.flightTotals?.hoursThisMonth || 0) * (daysInMonth / currentDay)
        : 0;
      const hoursPremium = monthlyHoursEstimate * INSURANCE_CONFIG.hourRate;
      
      // Use current mission risk average or estimate from recent flights
      const missionRiskMultiplier = S.insurance?.lastMonthMissionRisk || 1.0;
      
      // Experience multiplier
      const tier = S.pilot?.experienceTier || 'rookie';
      const experienceMultiplier = INSURANCE_CONFIG.experienceMultipliers[tier] || 1.0;
      
      // Clean record (assume stays clean)
      const incidentFreeMonths = (S.insurance?.incidentFreeMonths || 0) + 1;
      const cleanDiscount = Math.min(
        incidentFreeMonths * INSURANCE_CONFIG.cleanRecordDiscountPerMonth,
        INSURANCE_CONFIG.maxCleanRecordDiscount
      );
      const cleanMultiplier = 1 - cleanDiscount;
      
      let totalPremium = (basePremium + hoursPremium) * missionRiskMultiplier * experienceMultiplier * cleanMultiplier;
      
      // Apply difficulty multiplier
      totalPremium = getEffectiveInsuranceCost(totalPremium);
      
      // Apply accountant insurance discount
      const insuranceDiscount = getAccountantInsuranceDiscount();
      if (insuranceDiscount > 0) {
        totalPremium = Math.round(totalPremium * (1 - insuranceDiscount));
      }
      
      return Math.round(totalPremium);
    }
    
    // Get current premium estimate with accountant discount applied
    function getEstimatedPremium() {
      const base = calculateInsurancePremium();
      const discount = getAccountantInsuranceDiscount();
      return discount > 0 ? Math.round(base * (1 - discount)) : base;
    }
    
    // Get detailed breakdown for insurance page
    function getInsuranceBreakdown() {
      const ownedAircraft = S.fleet.filter(code => {
        const lease = S.leases?.find(l => l.aircraftCode === code);
        return !lease;
      });
      
      const aircraftBreakdown = ownedAircraft.map(code => {
        const aircraft = AIRCRAFT[code];
        const data = S.fleetData?.[code] || {};
        const hullValue = data.bookValue || aircraft?.price || 100000;
        const premium = calculateAircraftInsurancePremium(code, S.fleetData);
        return {
          code,
          name: aircraft?.name || code,
          tail: data.tailNumber || code,
          seats: aircraft?.max_passengers || aircraft?.passengers || 1,
          hullValue,
          premium
        };
      });
      
      const tier = S.pilot?.experienceTier || 'rookie';
      const experienceMultiplier = INSURANCE_CONFIG.experienceMultipliers[tier] || 1.0;
      const experienceDiscount = experienceMultiplier < 1 ? (1 - experienceMultiplier) : 0;
      const experiencePenalty = experienceMultiplier > 1 ? (experienceMultiplier - 1) : 0;
      
      const incidentFreeMonths = S.insurance?.incidentFreeMonths || 0;
      const cleanDiscount = Math.min(
        incidentFreeMonths * INSURANCE_CONFIG.cleanRecordDiscountPerMonth,
        INSURANCE_CONFIG.maxCleanRecordDiscount
      );
      
      return {
        aircraft: aircraftBreakdown,
        totalAircraftPremium: aircraftBreakdown.reduce((sum, a) => sum + a.premium, 0),
        lastMonthHours: S.insurance?.lastMonthHours || 0,
        hoursPremium: (S.insurance?.lastMonthHours || 0) * INSURANCE_CONFIG.hourRate,
        missionRiskMultiplier: S.insurance?.lastMonthMissionRisk || 1.0,
        experienceTier: tier,
        experienceMultiplier,
        experienceDiscount,
        experiencePenalty,
        incidentFreeMonths,
        cleanDiscount,
        accountantDiscount: getAccountantInsuranceDiscount(),
        currentPremium: S.insurance?.currentPremium || getEstimatedPremium(),
        projectedPremium: projectNextMonthPremium()
      };
    }
    window.getInsuranceBreakdown = getInsuranceBreakdown;
    
    // Process monthly insurance charge (called on month rollover)
    function processMonthlyInsurance() {
      const basePremium = calculateInsurancePremium();
      const discount = getAccountantInsuranceDiscount();
      const premium = discount > 0 ? Math.round(basePremium * (1 - discount)) : basePremium;
      
      if (premium > 0) {
        S.cash -= premium;
        recordTransaction('Liability Insurance', -premium, 'insurance');
        
        // Update insurance state for next month
        S.insurance.currentPremium = premium;
        S.insurance.lastPremiumDate = { ...S.gameTime };
        S.insurance.lastMonthHours = S.flightTotals?.hoursThisMonth || 0;
        
        // Increment incident-free months (reset happens elsewhere if damage occurs)
        S.insurance.incidentFreeMonths = (S.insurance.incidentFreeMonths || 0) + 1;
      }
    }
    window.processMonthlyInsurance = processMonthlyInsurance;
    
    // Reset incident-free streak (call when damage is reported)
    function reportInsuranceIncident() {
      S.insurance.incidentFreeMonths = 0;
    }
    window.reportInsuranceIncident = reportInsuranceIncident;
    
    // ========== STAFF SYSTEM ==========
    
    // Generate a random staff name
    function generateStaffName() {
      const gender = Math.random() > 0.5 ? 'male' : 'female';
      const firstNames = gender === 'male' ? FIRST_NAMES_MALE : FIRST_NAMES_FEMALE;
      return {
        name: `${randomItem(firstNames)} ${randomItem(LAST_NAMES)}`,
        gender: gender
      };
    }
    
    // Get background snippets by role
    function getBackgroundsForRole(role) {
      switch(role) {
        case 'pilot': return PILOT_BACKGROUNDS;
        case 'mechanic': return MECHANIC_BACKGROUNDS;
        case 'opsOfficer': return OPS_BACKGROUNDS;
        case 'marketing': return MARKETING_BACKGROUNDS;
        case 'accountant': return ACCOUNTANT_BACKGROUNDS;
        default: return ['Experienced professional seeking new opportunities'];
      }
    }
    
    // Generate a staff candidate for the marketplace
    function generateStaffCandidate(role, forcedExperienceLevel = null) {
      // Support staff (marketing/accountant) have flat salaries, no experience levels
      const isSupportStaff = ['marketing', 'accountant'].includes(role);
      
      // Weighted random for experience level: junior 40%, mid 35%, senior 20%, expert 5%
      let experienceLevel;
      if (isSupportStaff) {
        experienceLevel = 'mid'; // Default level for display purposes
      } else if (forcedExperienceLevel) {
        experienceLevel = forcedExperienceLevel;
      } else {
        const roll = Math.random();
        if (roll < 0.40) experienceLevel = 'junior';
        else if (roll < 0.75) experienceLevel = 'mid';
        else if (roll < 0.95) experienceLevel = 'senior';
        else experienceLevel = 'expert';
      }
      
      const identity = generateStaffName();
      const [minAge, maxAge] = isSupportStaff ? [25, 55] : STAFF_AGE_RANGES[experienceLevel];
      const [minSkill, maxSkill] = isSupportStaff ? [50, 80] : STAFF_SKILL_RANGES[experienceLevel];
      
      // Support staff use flat salary from STAFF_EFFECTS
      // External hire salary: 95-115% of base (market rate premium)
      let salary;
      if (isSupportStaff) {
        salary = STAFF_EFFECTS[role].salary;
      } else {
        const baseSalary = STAFF_SALARIES[role][experienceLevel];
        const marketMultiplier = 0.95 + (Math.random() * 0.20); // 95-115%
        salary = Math.round((baseSalary * marketMultiplier) / 100) * 100;
      }
      
      const candidate = {
        id: uuid(),
        name: identity.name,
        gender: identity.gender,
        age: randomInt(minAge, maxAge),
        role: role,
        experienceLevel: experienceLevel,
        skill: randomInt(minSkill, maxSkill),
        xp: isSupportStaff ? 0 : (STAFF_XP_THRESHOLDS[experienceLevel] + randomInt(0, 500)),
        salary: salary,
        background: randomItem(getBackgroundsForRole(role)),
        quirk: randomItem(STAFF_QUIRKS),
        status: 'available'
      };
      
      // Add role-specific attributes
      if (role === 'pilot') {
        candidate.pilot = generatePilotAttributes(experienceLevel);
      } else if (role === 'mechanic') {
        candidate.mechanic = generateMechanicAttributes(experienceLevel);
      }
      
      return candidate;
    }
    
    // Generate pilot-specific attributes
    function generatePilotAttributes(experienceLevel) {
      const attrs = {
        certificates: ['private'],
        ratings: [],
        flightHours: 0,
        hoursToday: 0,
        assignedAircraft: null
      };
      
      // Build up certificates and ratings based on experience
      // These are career pilots looking for jobs, so they have relevant qualifications
      if (experienceLevel === 'junior') {
        // Fresh commercial pilots - piston only, building hours
        attrs.certificates = ['private', 'commercial'];
        attrs.flightHours = randomInt(250, 500);
        attrs.ratings.push('instrument');
        // 30% chance of multi-engine
        if (Math.random() < 0.3) attrs.ratings.push('multiEngine');
      } else if (experienceLevel === 'mid') {
        // Mid-career - some got turbine jobs, most still piston
        attrs.certificates = ['private', 'commercial'];
        attrs.flightHours = randomInt(800, 2000);
        attrs.ratings = ['instrument', 'multiEngine'];
        // 40% chance of turbine
        if (Math.random() < 0.4) attrs.ratings.push('turbine');
        // 15% chance of helicopter
        if (Math.random() < 0.15) attrs.ratings.push('helicopter');
      } else if (experienceLevel === 'senior') {
        // Experienced pros - 80% have turbine, 50% have ATP
        // 50% chance of ATP
        if (Math.random() < 0.5) {
          attrs.certificates = ['private', 'commercial', 'atp'];
        } else {
          attrs.certificates = ['private', 'commercial'];
        }
        attrs.flightHours = randomInt(2500, 6000);
        attrs.ratings = ['instrument', 'multiEngine'];
        // 80% chance of turbine
        if (Math.random() < 0.8) attrs.ratings.push('turbine');
        // 25% chance of helicopter
        if (Math.random() < 0.25) attrs.ratings.push('helicopter');
        // 15% chance of seaplane
        if (Math.random() < 0.15) attrs.ratings.push('seaplane');
      } else { // expert
        // Veterans - all have ATP and turbine
        attrs.certificates = ['private', 'commercial', 'atp'];
        attrs.flightHours = randomInt(6000, 15000);
        attrs.ratings = ['instrument', 'multiEngine', 'turbine'];
        // 50% chance of helicopter
        if (Math.random() < 0.5) attrs.ratings.push('helicopter');
        // 40% chance of seaplane
        if (Math.random() < 0.4) attrs.ratings.push('seaplane');
      }
      
      return attrs;
    }
    
    // Generate mechanic-specific attributes
    function generateMechanicAttributes(experienceLevel) {
      const attrs = {
        specializations: ['piston', 'airframe'], // All mechanics can do piston and airframe
        currentJob: null
      };
      
      if (experienceLevel === 'junior') {
        // Junior: piston + airframe only
        // Nothing to add
      } else if (experienceLevel === 'mid') {
        // Mid: 50% chance to add turboprop
        if (Math.random() < 0.5) attrs.specializations.push('turboprop');
      } else if (experienceLevel === 'senior') {
        // Senior: turboprop + 50% chance of jet
        attrs.specializations.push('turboprop');
        if (Math.random() < 0.5) attrs.specializations.push('jet');
      } else if (experienceLevel === 'expert') {
        // Expert: all specializations
        attrs.specializations = ['piston', 'turboprop', 'jet', 'airframe'];
      }
      
      return attrs;
    }
    
    // Get the required specialization for an aircraft type
    function getRequiredSpecialization(aircraftCode) {
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return 'piston';
      
      const category = aircraft.category;
      if (['light_jet', 'midsize_jet', 'heavy_jet', 'airliner'].includes(category)) {
        return 'jet';
      } else if (category === 'turboprop') {
        return 'turboprop';
      } else {
        return 'piston'; // single_piston, multi_piston, helicopter, etc.
      }
    }
    
    // Check if mechanic can work on a specific aircraft
    function canMechanicWorkOnAircraft(mechanic, aircraftCode) {
      if (!mechanic || !mechanic.mechanic) return false;
      const required = getRequiredSpecialization(aircraftCode);
      return mechanic.mechanic.specializations.includes(required);
    }
    
    // Check if mechanic can perform a specific MX type
    function canMechanicPerformMxType(mechanic, mxType) {
      if (!mechanic || !mechanic.mechanic) return false;
      const capabilities = MECHANIC_CAPABILITIES[mechanic.experienceLevel] || [];
      return capabilities.includes(mxType);
    }
    
    // Get available mechanics for a specific aircraft and MX type
    function getAvailableMechanics(aircraftCode, mxType) {
      return S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.status === 'available' &&
        canMechanicWorkOnAircraft(s, aircraftCode) &&
        canMechanicPerformMxType(s, mxType)
      );
    }
    
    // Get the best available mechanic (highest experience level, then skill)
    function getBestAvailableMechanic(aircraftCode, mxType) {
      const available = getAvailableMechanics(aircraftCode, mxType);
      if (available.length === 0) return null;
      
      const expOrder = { expert: 4, senior: 3, mid: 2, junior: 1 };
      available.sort((a, b) => {
        const expDiff = (expOrder[b.experienceLevel] || 0) - (expOrder[a.experienceLevel] || 0);
        if (expDiff !== 0) return expDiff;
        return (b.skill || 0) - (a.skill || 0);
      });
      
      return available[0];
    }
    
    // Calculate in-house MX cost with mechanic discounts
    function calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic) {
      if (!mechanic) return { laborCost: baseLaborCost, partsCost: basePartsCost, total: baseLaborCost + basePartsCost };
      
      const effects = STAFF_EFFECTS.mechanic;
      const laborDiscount = effects.laborDiscount[mechanic.experienceLevel] || 0;
      const partsDiscount = effects.partsDiscount[mechanic.experienceLevel] || 0;
      
      const discountedLabor = Math.round(baseLaborCost * (1 - laborDiscount));
      const discountedParts = Math.round(basePartsCost * (1 - partsDiscount));
      
      return {
        laborCost: discountedLabor,
        partsCost: discountedParts,
        total: discountedLabor + discountedParts,
        laborDiscount: laborDiscount,
        partsDiscount: partsDiscount
      };
    }
    
    // Calculate labor hours with skill speed bonus
    function calculateMechanicLaborHours(baseLaborHours, mechanic) {
      if (!mechanic) return baseLaborHours;
      
      // Skill reduces hours: skill/200 reduction (e.g., skill 80 = 40% faster)
      const speedBonus = (mechanic.skill || 50) / 200;
      const adjustedHours = baseLaborHours * (1 - speedBonus);
      
      return Math.max(1, Math.round(adjustedHours * 10) / 10); // Minimum 1 hour, round to 1 decimal
    }
    
    // Award XP to mechanic for completing a job
    function awardMechanicXP(mechanic, mxType, squawkSeverity = null) {
      if (!mechanic) return;
      
      let xpKey;
      if (mxType === 'squawk' && squawkSeverity) {
        xpKey = `squawk_${squawkSeverity}`;
      } else if (mxType === 'inspection') {
        xpKey = 'inspection';
      } else if (mxType === 'major_service') {
        xpKey = 'major_service';
      } else if (mxType === 'overhaul') {
        xpKey = 'overhaul';
      } else {
        xpKey = 'squawk_minor'; // Default fallback
      }
      
      const xpGain = MECHANIC_XP_REWARDS[xpKey] || 5;
      mechanic.xp = (mechanic.xp || 0) + xpGain;
      
      // Check for promotion
      checkStaffPromotion(mechanic);
    }
    
    // Get squawk prevention chance from best available mechanic
    function getSquawkPreventionChance(aircraftCode) {
      // Find mechanics with airframe specialization
      const mechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.mechanic?.specializations?.includes('airframe')
      );
      
      if (mechanics.length === 0) return 0;
      
      // Use the best mechanic's prevention rate
      const expOrder = { expert: 4, senior: 3, mid: 2, junior: 1 };
      mechanics.sort((a, b) => (expOrder[b.experienceLevel] || 0) - (expOrder[a.experienceLevel] || 0));
      
      const bestMechanic = mechanics[0];
      return STAFF_EFFECTS.mechanic.squawkPrevention[bestMechanic.experienceLevel] || 0;
    }
    
    // Get degradation reduction from mechanic for an aircraft
    function getDegradationReduction(aircraftCode) {
      const requiredSpec = getRequiredSpecialization(aircraftCode);
      
      // Find mechanics with matching specialization
      const mechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.mechanic?.specializations?.includes(requiredSpec)
      );
      
      if (mechanics.length === 0) return 0;
      
      // Use the best mechanic's reduction rate
      const expOrder = { expert: 4, senior: 3, mid: 2, junior: 1 };
      mechanics.sort((a, b) => (expOrder[b.experienceLevel] || 0) - (expOrder[a.experienceLevel] || 0));
      
      const bestMechanic = mechanics[0];
      return STAFF_EFFECTS.mechanic.degradationReduction[bestMechanic.experienceLevel] || 0;
    }
    
    // Assign mechanic to MX job
    function assignMechanicToJob(mechanicId, mxJobId, aircraftCode) {
      const mechanic = S.staff.find(s => s.id === mechanicId);
      if (!mechanic || mechanic.role !== 'mechanic') return false;
      
      mechanic.status = 'working';
      mechanic.mechanic.currentJob = {
        mxJobId: mxJobId,
        aircraftCode: aircraftCode,
        startTime: { ...S.gameTime }
      };
      
      return true;
    }
    
    // Release mechanic from completed job
    function releaseMechanicFromJob(mechanicId) {
      const mechanic = S.staff.find(s => s.id === mechanicId);
      if (!mechanic || mechanic.role !== 'mechanic') return;
      
      mechanic.status = 'available';
      mechanic.mechanic.currentJob = null;
    }

    // Populate the staff marketplace
    function refreshStaffMarketplace() {
      S.staffMarketplace = [];
      
      // Generate 20-28 candidates total - larger pool for more variety
      const totalCandidates = randomInt(20, 28);
      
      // Ensure at least one of each role at each experience level for key roles
      const roles = [...STAFF_ROLES];
      roles.forEach(role => {
        S.staffMarketplace.push(generateStaffCandidate(role));
      });
      
      // Add extra pilots (4-6 more) since they're most needed
      const extraPilots = randomInt(4, 6);
      for (let i = 0; i < extraPilots; i++) {
        S.staffMarketplace.push(generateStaffCandidate('pilot'));
      }
      
      // Add extra mechanics (3-5 more) with varied experience levels
      const extraMechanics = randomInt(3, 5);
      const mechanicLevels = ['junior', 'junior', 'mid', 'mid', 'senior', 'expert'];
      for (let i = 0; i < extraMechanics; i++) {
        const forcedLevel = mechanicLevels[i % mechanicLevels.length];
        S.staffMarketplace.push(generateStaffCandidate('mechanic', forcedLevel));
      }
      
      // Fill remaining slots with weighted random
      const currentCount = S.staffMarketplace.length;
      const remaining = Math.max(0, totalCandidates - currentCount);
      const weightedRoles = ['pilot', 'pilot', 'pilot', 'mechanic', 'mechanic', 'opsOfficer', 'marketing', 'accountant'];
      for (let i = 0; i < remaining; i++) {
        const role = randomItem(weightedRoles);
        S.staffMarketplace.push(generateStaffCandidate(role));
      }
      
      // Shuffle the marketplace
      S.staffMarketplace.sort(() => Math.random() - 0.5);
      
      S.staffMarketplaceLastRefresh = { 
        year: S.gameTime.year, 
        month: S.gameTime.month, 
        day: S.gameTime.day 
      };
    }
    
    // Check if marketplace needs weekly refresh
    function checkMarketplaceRefresh() {
      if (!S.staffMarketplaceLastRefresh) {
        refreshStaffMarketplace();
        return;
      }
      
      // Calculate days since last refresh (28-day months)
      const lastRefresh = S.staffMarketplaceLastRefresh;
      const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
      const lastDays = (lastRefresh.year * 336) + ((lastRefresh.month - 1) * 28) + lastRefresh.day;
      
      if (currentDays - lastDays >= 7) {
        refreshStaffMarketplace();
      }
    }
    
    // Hire a staff member from the marketplace
    function hireStaff(candidateId) {
      const candidateIndex = S.staffMarketplace.findIndex(c => c.id === candidateId);
      if (candidateIndex === -1) {
        showToast('Error', 'Candidate no longer available', 'danger');
        return false;
      }
      
      const candidate = S.staffMarketplace[candidateIndex];
      
      // Handle support staff (marketing/accountant) differently
      const isSupportStaff = ['marketing', 'accountant'].includes(candidate.role);
      
      // Calculate hiring fee (10% of monthly salary)
      const monthlySalary = isSupportStaff ? STAFF_EFFECTS[candidate.role].salary : candidate.salary;
      const hiringFee = Math.round(monthlySalary * HIRING_FEE_PERCENT);
      
      // Check if can afford hiring fee
      if (S.cash < hiringFee) {
        showToast('Insufficient Funds', `Need ${formatCurrency(hiringFee)} hiring fee`, 'error');
        return false;
      }
      
      // Deduct hiring fee
      S.cash -= hiringFee;
      recordTransaction(`Hiring Fee â€” ${candidate.name}`, -hiringFee, 'expense');
      
      if (isSupportStaff) {
        // Check if already have one
        if (S.supportStaff?.[candidate.role]) {
          showToast('Already Hired', `You already have a ${getRoleDisplayName(candidate.role)}`, 'warning');
          S.cash += hiringFee; // Refund
          return false;
        }
        
        // Initialize supportStaff if needed
        if (!S.supportStaff) {
          S.supportStaff = { marketing: null, accountant: null };
        }
        
        // Hire as support staff (simpler structure)
        S.supportStaff[candidate.role] = {
          id: candidate.id,
          name: candidate.name,
          salary: STAFF_EFFECTS[candidate.role].salary,
          hireDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
          background: candidate.background
        };
      } else {
        // Add to regular staff roster
        const staffMember = {
          ...candidate,
          hireDate: { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day },
          assignedBase: S.bases.primary,
          status: 'available'
        };
        
        S.staff.push(staffMember);
      }
      
      // Remove from marketplace
      S.staffMarketplace.splice(candidateIndex, 1);
      
      // Update payroll cache
      updatePayrollTotal();
      
      // Log the hire
      const roleNames = {
        pilot: 'Pilot',
        mechanic: 'Mechanic',
        opsOfficer: 'Operations Officer',
        marketing: 'Marketing Specialist',
        accountant: 'Accountant'
      };
      
      showToast('Staff Hired', `Welcome ${candidate.name}!`, 'success');
      
      // Send welcome email from the new hire
      const excitedPhrases = [
        "I'm thrilled to be joining the team!",
        "Looking forward to contributing to the operation!",
        "Excited to get started!",
        "Can't wait to hit the ground running!",
        "Happy to be part of the crew!"
      ];
      
      // Support staff get special welcome messages
      let welcomeBody;
      if (candidate.role === 'marketing') {
        welcomeBody = `Hi!\n\n${randomItem(excitedPhrases)}\n\n` +
              `I'll be starting as your Marketing Specialist. My salary is $${STAFF_EFFECTS.marketing.salary.toLocaleString()}/month.\n\n` +
              `With me on board, you'll see:\n` +
              `â€¢ +15% boost to reputation/experience gains\n` +
              `â€¢ +5% increase in contract values\n\n` +
              `A bit about me: ${candidate.background}\n\n` +
              `Looking forward to growing your brand!`;
      } else if (candidate.role === 'accountant') {
        welcomeBody = `Hi!\n\n${randomItem(excitedPhrases)}\n\n` +
              `I'll be starting as your Accountant. My salary is $${STAFF_EFFECTS.accountant.salary.toLocaleString()}/month.\n\n` +
              `With me managing the books, you'll see:\n` +
              `â€¢ +5% contract revenue\n` +
              `â€¢ 5% reduction in payroll costs\n` +
              `â€¢ 5% reduction in insurance premiums\n` +
              `â€¢ 2% reduction in LOC interest rate\n\n` +
              `A bit about me: ${candidate.background}\n\n` +
              `Looking forward to saving you money!`;
      } else {
        welcomeBody = `Hi!\n\n${randomItem(excitedPhrases)}\n\n` +
              `I'll be starting as your new ${roleNames[candidate.role]}. ` +
              `My agreed salary is $${candidate.salary.toLocaleString()}/month.\n\n` +
              `A bit about me: ${candidate.background}\n\n` +
              `Looking forward to working with you!`;
      }
      
      const welcomeEmail = {
        id: uuid(),
        type: 'notification',
        from: candidate.name,
        subject: `Excited to Join!`,
        body: welcomeBody,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      };
      S.emails.unshift(welcomeEmail);
      
      // Check if newly hired pilot qualifies for certificate upgrades
      if (candidate.role === 'pilot') {
        const newHire = isSupportStaff ? null : S.staff.find(s => s.id === candidate.id);
        if (newHire) {
          checkStaffPilotCertificates(newHire);
        }
      }
      
      saveState();
      render();
      return true;
    }
    window.hireStaff = hireStaff;
    
    // Terminate a staff member (pilots/mechanics get severance)
    function terminateStaff(staffId) {
      const staffIndex = S.staff.findIndex(s => s.id === staffId);
      if (staffIndex === -1) return false;
      
      const staffMember = S.staff[staffIndex];
      
      // Calculate and pay severance (2 months salary)
      const severance = staffMember.salary * SEVERANCE_MONTHS;
      S.cash -= severance;
      recordTransaction(`Severance â€” ${staffMember.name}`, -severance, 'expense');
      
      // Remove from roster
      S.staff.splice(staffIndex, 1);
      
      // Update payroll cache
      updatePayrollTotal();
      
      showToast('Staff Terminated', `${staffMember.name} has left (${formatCurrency(severance)} severance paid)`, 'info');
      
      saveState();
      render();
      return true;
    }
    window.terminateStaff = terminateStaff;
    
    // === PILOT TRAINING SYSTEM ===
    
    // Get available training options for a pilot
    function getAvailableTraining(pilotId) {
      const pilot = S.staff.find(s => s.id === pilotId && s.role === 'pilot');
      if (!pilot || !pilot.pilot) return [];
      
      const available = [];
      const currentRatings = pilot.pilot.ratings || [];
      const hours = pilot.pilot.flightHours || 0;
      
      for (const [ratingKey, config] of Object.entries(PILOT_TRAINING)) {
        // Skip if already has rating
        if (currentRatings.includes(ratingKey)) continue;
        
        // Check hours requirement
        const meetsHours = hours >= config.minHours;
        
        // Calculate failure chance based on skill
        const skill = pilot.skill || 50;
        const [minFail, maxFail] = config.failureRange;
        // Higher skill = lower failure (linear interpolation)
        const skillFactor = 1 - ((skill - 20) / 80); // 0 at skill 100, 1 at skill 20
        const failureChance = minFail + (maxFail - minFail) * Math.max(0, Math.min(1, skillFactor));
        
        available.push({
          type: 'rating',
          key: ratingKey,
          name: config.name,
          cost: config.cost,
          durationDays: config.durationDays,
          minHours: config.minHours,
          meetsHours,
          failureChance: Math.round(failureChance * 100),
          successChance: Math.round((1 - failureChance) * 100)
        });
      }
      
      return available;
    }
    
    // Get available certificate checkrides for a pilot
    function getAvailableCertCheckrides(pilotId) {
      const pilot = S.staff.find(s => s.id === pilotId && s.role === 'pilot');
      if (!pilot || !pilot.pilot) return [];
      
      const available = [];
      const certs = pilot.pilot.certificates || [];
      const ratings = pilot.pilot.ratings || [];
      const hours = pilot.pilot.flightHours || 0;
      const cooldowns = pilot.pilot.certCooldowns || {};
      
      for (const [certKey, config] of Object.entries(STAFF_CERT_REQUIREMENTS)) {
        // Skip if already has cert
        if (certs.includes(certKey)) continue;
        
        // Check hour requirement
        const meetsHours = hours >= config.minHours;
        
        // Check prerequisites
        const hasPrereqs = config.requires.every(req => 
          certs.includes(req) || ratings.includes(req)
        );
        
        // Check cooldown
        let cooldownActive = false;
        let cooldownDays = 0;
        if (cooldowns[certKey]) {
          const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
          const cooldownEndDays = (cooldowns[certKey].year * 336) + ((cooldowns[certKey].month - 1) * 28) + cooldowns[certKey].day;
          if (currentDays < cooldownEndDays) {
            cooldownActive = true;
            cooldownDays = cooldownEndDays - currentDays;
          }
        }
        
        // Calculate failure chance based on skill
        const skill = pilot.skill || 50;
        const [minFail, maxFail] = config.failureRange;
        const skillFactor = 1 - ((skill - 20) / 80);
        const failureChance = minFail + (maxFail - minFail) * Math.max(0, Math.min(1, skillFactor));
        
        available.push({
          type: 'certificate',
          key: certKey,
          name: config.name,
          cost: config.fee,
          minHours: config.minHours,
          meetsHours,
          hasPrereqs,
          requires: config.requires,
          cooldownActive,
          cooldownDays,
          failureChance: Math.round(failureChance * 100),
          successChance: Math.round((1 - failureChance) * 100)
        });
      }
      
      return available;
    }
    
    // Start training for a pilot
    function startPilotTraining(pilotId, ratingKey) {
      const pilot = S.staff.find(s => s.id === pilotId && s.role === 'pilot');
      if (!pilot || !pilot.pilot) return false;
      
      const config = PILOT_TRAINING[ratingKey];
      if (!config) return false;
      
      // Check if already has rating
      if (pilot.pilot.ratings?.includes(ratingKey)) {
        showToast('Already Certified', `${pilot.name} already has this rating`, 'warning');
        return false;
      }
      
      // Check hours requirement
      if (pilot.pilot.flightHours < config.minHours) {
        showToast('Insufficient Hours', `Need ${config.minHours} flight hours`, 'warning');
        return false;
      }
      
      // Check funds
      if (S.cash < config.cost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(config.cost)}`, 'error');
        return false;
      }
      
      // Check if pilot is available
      if (pilot.status !== 'available') {
        showToast('Pilot Unavailable', `${pilot.name} is currently ${pilot.status}`, 'warning');
        return false;
      }
      
      // Deduct cost
      S.cash -= config.cost;
      recordTransaction(`Training â€” ${config.name} (${pilot.name})`, -config.cost, 'training');
      
      // Calculate completion date
      const completionDate = { ...S.gameTime };
      completionDate.day += config.durationDays;
      while (completionDate.day > 28) {
        completionDate.day -= 28;
        completionDate.month++;
        if (completionDate.month > 12) {
          completionDate.month = 1;
          completionDate.year++;
        }
      }
      
      // Calculate failure chance
      const skill = pilot.skill || 50;
      const [minFail, maxFail] = config.failureRange;
      const skillFactor = 1 - ((skill - 20) / 80);
      const failureChance = minFail + (maxFail - minFail) * Math.max(0, Math.min(1, skillFactor));
      
      // Add to training queue
      if (!S.staffTraining) S.staffTraining = [];
      S.staffTraining.push({
        id: uuid(),
        pilotId: pilotId,
        pilotName: pilot.name,
        ratingKey: ratingKey,
        ratingName: config.name,
        startDate: { ...S.gameTime },
        completionDate: completionDate,
        cost: config.cost,
        failureChance: failureChance
      });
      
      // Set pilot status
      pilot.status = 'training';
      
      // Send email
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Flight School',
        subject: `Training Started â€” ${config.name}`,
        body: `${pilot.name} has begun training for their ${config.name}.\n\n` +
              `Duration: ${config.durationDays} days\n` +
              `Expected completion: Month ${completionDate.month}, Day ${completionDate.day}\n` +
              `Cost: ${formatCurrency(config.cost)}\n\n` +
              `${pilot.name} will be unavailable for missions until training is complete.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Training Started', `${pilot.name} is now training for ${config.name}`, 'success');
      
      saveState();
      render();
      return true;
    }
    window.startPilotTraining = startPilotTraining;
    
    // Check for completed training (called on day advance)
    function checkTrainingCompletion() {
      if (!S.staffTraining || S.staffTraining.length === 0) return;
      
      const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
      const completed = [];
      
      S.staffTraining = S.staffTraining.filter(training => {
        const completionDays = (training.completionDate.year * 336) + 
                               ((training.completionDate.month - 1) * 28) + 
                               training.completionDate.day;
        
        if (currentDays >= completionDays) {
          completed.push(training);
          return false;
        }
        return true;
      });
      
      // Process completed training
      completed.forEach(training => {
        const pilot = S.staff.find(s => s.id === training.pilotId);
        if (!pilot) return;
        
        // Roll for success/failure
        const roll = Math.random();
        const passed = roll >= training.failureChance;
        
        if (passed) {
          // Add rating
          if (!pilot.pilot.ratings) pilot.pilot.ratings = [];
          pilot.pilot.ratings.push(training.ratingKey);
          
          // Small XP bonus
          pilot.xp = (pilot.xp || 0) + 50;
          checkStaffPromotion(pilot);
          
          // Success email
          S.emails.unshift({
            id: uuid(),
            type: 'notification',
            from: 'Flight School',
            subject: `âœ“ Training Complete â€” ${training.ratingName}`,
            body: `Congratulations! ${pilot.name} has successfully completed their ${training.ratingName} training!\n\n` +
                  `They are now certified and available for missions requiring this rating.\n\n` +
                  `+50 XP awarded.`,
            status: 'unread',
            receivedAt: { ...S.gameTime }
          });
          
          showToast('Training Complete', `${pilot.name} earned ${training.ratingName}!`, 'success');
        } else {
          // Failure email
          S.emails.unshift({
            id: uuid(),
            type: 'alert',
            from: 'Flight School',
            subject: `âœ— Training Failed â€” ${training.ratingName}`,
            body: `Unfortunately, ${pilot.name} did not pass their ${training.ratingName} checkride.\n\n` +
                  `They can attempt the training again if you choose to re-enroll them. The training fee is non-refundable.\n\n` +
                  `Better luck next time!`,
            status: 'unread',
            receivedAt: { ...S.gameTime }
          });
          
          showToast('Training Failed', `${pilot.name} did not pass ${training.ratingName}`, 'warning');
        }
        
        // Return pilot to available status
        pilot.status = 'available';
      });
      
      if (completed.length > 0) {
        saveState();
      }
    }
    
    // === STAFF PILOT CERTIFICATE ELIGIBILITY ===
    // Staff pilots get email notifications when eligible for certificate upgrades
    const STAFF_CERT_REQUIREMENTS = {
      commercial: {
        name: 'Commercial Certificate',
        fee: 1000,
        minHours: 80,
        requires: ['private'],
        failureRange: [0.02, 0.08]  // 2-8% based on skill
      },
      atp: {
        name: 'ATP Certificate',
        fee: 1500,
        minHours: 300,
        requires: ['commercial', 'instrument'],
        failureRange: [0.03, 0.10]  // 3-10% based on skill
      }
    };
    
    function checkStaffPilotCertificates(staffMember) {
      if (!staffMember.pilot) return;
      
      const hours = staffMember.pilot.flightHours || 0;
      const certs = staffMember.pilot.certificates || [];
      const ratings = staffMember.pilot.ratings || [];
      
      // Track which certs we've already notified about
      if (!staffMember.pilot.certNotified) staffMember.pilot.certNotified = {};
      
      for (const [certKey, config] of Object.entries(STAFF_CERT_REQUIREMENTS)) {
        // Skip if already has cert
        if (certs.includes(certKey)) continue;
        
        // Skip if already notified
        if (staffMember.pilot.certNotified[certKey]) continue;
        
        // Check hour requirement
        if (hours < config.minHours) continue;
        
        // Check prerequisites
        const hasPrereqs = config.requires.every(req => 
          certs.includes(req) || ratings.includes(req)
        );
        if (!hasPrereqs) continue;
        
        // Eligible! Send notification email
        staffMember.pilot.certNotified[certKey] = true;
        
        S.emails.unshift({
          id: uuid(),
          type: 'staff_checkride',
          staffId: staffMember.id,
          staffName: staffMember.name,
          certKey: certKey,
          certName: config.name,
          fee: config.fee,
          from: 'Flight Training',
          subject: `ðŸŽ“ Checkride Eligible â€” ${staffMember.name}`,
          body: `${staffMember.name} has reached ${hours.toLocaleString()} flight hours and is now eligible to take their ${config.name} checkride.\n\n` +
                `Examiner fee: ${formatCurrency(config.fee)}\n\n` +
                `Schedule their checkride when ready.`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Checkride Available', `${staffMember.name} eligible for ${config.name}`, 'info');
      }
    }
    
    // Schedule staff pilot checkride from email
    function scheduleStaffCheckride(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email || email.type !== 'staff_checkride') return;
      
      const staffMember = S.staff.find(s => s.id === email.staffId);
      if (!staffMember) {
        showToast('Error', 'Staff member no longer employed', 'error');
        return;
      }
      
      const config = STAFF_CERT_REQUIREMENTS[email.certKey];
      if (!config) return;
      
      // Check for 7-day cooldown from failed attempt
      const cooldown = staffMember.pilot.certCooldowns?.[email.certKey];
      if (cooldown) {
        const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
        const cooldownDays = (cooldown.year * 336) + ((cooldown.month - 1) * 28) + cooldown.day;
        if (currentDays < cooldownDays) {
          const daysRemaining = cooldownDays - currentDays;
          showToast('Cooldown Active', `${staffMember.name} must wait ${daysRemaining} more day(s)`, 'warning');
          return;
        }
      }
      
      // Check funds
      if (S.cash < config.fee) {
        showToast('Insufficient Funds', `Need ${formatCurrency(config.fee)} for checkride fee`, 'error');
        return;
      }
      
      // Confirm
      const msg = `Schedule ${staffMember.name} for ${config.name} checkride?\n\n` +
                  `Fee: ${formatCurrency(config.fee)}\n\n` +
                  `The checkride will be completed immediately.`;
      
      if (!confirm(msg)) return;
      
      // Deduct fee
      S.cash -= config.fee;
      recordTransaction(`Checkride Fee â€” ${config.name} (${staffMember.name})`, -config.fee, 'training');
      
      // Calculate failure chance based on skill
      const skill = staffMember.skill || 50;
      const [minFail, maxFail] = config.failureRange;
      const skillFactor = 1 - ((skill - 20) / 80);
      const failureChance = minFail + (maxFail - minFail) * Math.max(0, Math.min(1, skillFactor));
      const successChance = Math.round((1 - failureChance) * 100);
      
      // Roll for pass/fail
      const roll = Math.random();
      const passed = roll >= failureChance;
      
      // Mark email as handled
      email.status = 'archived';
      
      if (passed) {
        // Add certificate
        if (!staffMember.pilot.certificates) staffMember.pilot.certificates = [];
        staffMember.pilot.certificates.push(email.certKey);
        
        // Success email
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'FAA Examiner',
          subject: `âœ“ Checkride Passed â€” ${config.name}`,
          body: `Congratulations! ${staffMember.name} has passed their ${config.name} checkride!\n\n` +
                `They are now certified to fly missions requiring this certificate.`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Checkride Passed', `${staffMember.name} earned ${config.name}!`, 'success');
      } else {
        // 7-day cooldown
        const cooldownDate = { ...S.gameTime };
        cooldownDate.day += 7;
        while (cooldownDate.day > 28) {
          cooldownDate.day -= 28;
          cooldownDate.month++;
          if (cooldownDate.month > 12) {
            cooldownDate.month = 1;
            cooldownDate.year++;
          }
        }
        
        if (!staffMember.pilot.certCooldowns) staffMember.pilot.certCooldowns = {};
        staffMember.pilot.certCooldowns[email.certKey] = cooldownDate;
        
        // Reset notification so they get another email after cooldown
        staffMember.pilot.certNotified[email.certKey] = false;
        
        // Failure email
        S.emails.unshift({
          id: uuid(),
          type: 'alert',
          from: 'FAA Examiner',
          subject: `âœ— Checkride Failed â€” ${config.name}`,
          body: `Unfortunately, ${staffMember.name} did not pass their ${config.name} checkride.\n\n` +
                `They may reattempt after a 7-day waiting period.\n\n` +
                `Retry available: Month ${cooldownDate.month}, Day ${cooldownDate.day}`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Checkride Failed', `${staffMember.name} must wait 7 days to retry`, 'warning');
      }
      
      saveState();
      render();
    }
    window.scheduleStaffCheckride = scheduleStaffCheckride;
    
    // Update cached payroll total
    function updatePayrollTotal() {
      let total = S.staff.reduce((sum, member) => sum + member.salary, 0);
      // Add support staff salaries
      if (S.supportStaff?.marketing) total += S.supportStaff.marketing.salary;
      if (S.supportStaff?.accountant) total += S.supportStaff.accountant.salary;
      S.payroll.totalMonthly = total;
    }
    
    // Process monthly payroll
    function processPayroll() {
      const regularStaffTotal = S.staff.reduce((sum, member) => sum + member.salary, 0);
      
      // Support staff salaries
      let supportStaffTotal = 0;
      const supportStaffLines = [];
      if (S.supportStaff?.marketing) {
        supportStaffTotal += S.supportStaff.marketing.salary;
        supportStaffLines.push(`â€¢ ${S.supportStaff.marketing.name} (Marketing): $${S.supportStaff.marketing.salary.toLocaleString()}`);
      }
      if (S.supportStaff?.accountant) {
        supportStaffTotal += S.supportStaff.accountant.salary;
        supportStaffLines.push(`â€¢ ${S.supportStaff.accountant.name} (Accountant): $${S.supportStaff.accountant.salary.toLocaleString()}`);
      }
      
      let totalPayroll = regularStaffTotal + supportStaffTotal;
      const totalStaffCount = S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0);
      
      if (totalStaffCount === 0) return 0;
      
      // Apply accountant payroll discount
      const payrollDiscount = getAccountantPayrollDiscount();
      if (payrollDiscount > 0) {
        totalPayroll = Math.round(totalPayroll * (1 - payrollDiscount));
      }
      
      if (totalPayroll > 0) {
        S.cash -= totalPayroll;
        
        recordTransaction(`Monthly Payroll (${totalStaffCount} staff)`, -totalPayroll, 'payroll');
        
        // Build staff list for email
        const regularStaffLines = S.staff.map(s => `â€¢ ${s.name} (${getRoleDisplayName(s.role)}): $${s.salary.toLocaleString()}`);
        const allStaffLines = [...regularStaffLines, ...supportStaffLines];
        
        // Send notification email
        const payrollEmail = {
          id: uuid(),
          type: 'notification',
          from: 'Accounting',
          subject: 'Monthly Payroll Processed',
          body: `Payroll for ${totalStaffCount} employee${totalStaffCount > 1 ? 's' : ''} has been processed.\n\n` +
                `Total: $${totalPayroll.toLocaleString()}\n\n` +
                allStaffLines.join('\n'),
          status: 'unread',
          receivedAt: { ...S.gameTime }
        };
        S.emails.unshift(payrollEmail);
      }
      
      S.payroll.lastProcessed = { year: S.gameTime.year, month: S.gameTime.month };
      S.payroll.totalMonthly = totalPayroll;
      
      return totalPayroll;
    }
    
    // Check for payroll warning (sent a few days before month end)
    function checkPayrollWarning() {
      if (S.staff.length === 0) return;
      if (S.gameTime.day < 25) return; // Only warn in last few days of month
      
      const totalPayroll = S.staff.reduce((sum, member) => sum + member.salary, 0);
      
      if (totalPayroll > S.cash && !S.payrollWarningSent) {
        const warningEmail = {
          id: uuid(),
          type: 'alert',
          from: 'Accounting',
          subject: 'âš ï¸ Payroll Warning',
          body: `Monthly payroll of $${totalPayroll.toLocaleString()} is due at the start of next month.\n\n` +
                `Current cash: $${S.cash.toLocaleString()}\n` +
                `Shortfall: $${(totalPayroll - S.cash).toLocaleString()}\n\n` +
                `Please ensure adequate funds are available.`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        };
        S.emails.unshift(warningEmail);
        S.payrollWarningSent = true;
      }
    }
    
    // Get display name for role
    function getRoleDisplayName(role) {
      const names = {
        pilot: 'Pilot',
        mechanic: 'Mechanic',
        opsOfficer: 'Ops Officer',
        marketing: 'Marketing',
        accountant: 'Accountant'
      };
      return names[role] || role;
    }
    
    // Get role icon
    function getRoleIcon(role) {
      const icons = {
        pilot: 'âœˆï¸',
        mechanic: 'ðŸ”§',
        opsOfficer: 'ðŸ“‹',
        marketing: 'ðŸ“¢',
        accountant: 'ðŸ“Š'
      };
      return icons[role] || 'ðŸ‘¤';
    }
    
    // Get experience level display
    function getExperienceLevelDisplay(level) {
      const displays = {
        junior: { name: 'Junior', color: 'var(--muted)' },
        mid: { name: 'Mid-Level', color: 'var(--text)' },
        senior: { name: 'Senior', color: 'var(--warning)' },
        expert: { name: 'Expert', color: 'var(--success)' }
      };
      return displays[level] || { name: level, color: 'var(--text)' };
    }
    
    // Check if staff member should be promoted and request raise
    function checkStaffPromotion(staffMember) {
      const currentLevel = staffMember.experienceLevel;
      const xp = staffMember.xp;
      
      // Determine what level they SHOULD be based on XP
      let targetLevel = 'junior';
      if (xp >= STAFF_XP_THRESHOLDS.expert) targetLevel = 'expert';
      else if (xp >= STAFF_XP_THRESHOLDS.senior) targetLevel = 'senior';
      else if (xp >= STAFF_XP_THRESHOLDS.mid) targetLevel = 'mid';
      
      // Only promote one level at a time (prevents skipping levels)
      const levelOrder = ['junior', 'mid', 'senior', 'expert'];
      const currentIndex = levelOrder.indexOf(currentLevel);
      const targetIndex = levelOrder.indexOf(targetLevel);
      
      // If they should be higher, promote just one level
      if (targetIndex > currentIndex) {
        const newLevel = levelOrder[currentIndex + 1];
        
        // Calculate skill growth - preserve relative position within tier
        const oldFloor = STAFF_SKILL_RANGES[currentLevel][0];
        const oldCeiling = STAFF_SKILL_RANGES[currentLevel][1];
        const newFloor = STAFF_SKILL_RANGES[newLevel][0];
        const newCeiling = STAFF_SKILL_RANGES[newLevel][1];
        
        // How far above floor were they? (0.0 to 1.0+)
        const relativePosition = (staffMember.skill - oldFloor) / (oldCeiling - oldFloor);
        
        // Apply to new range, with slight compression to prevent everyone hitting 100
        const compressionFactor = 0.85; // Talented people stay talented but don't all max out
        const newSkill = Math.round(newFloor + relativePosition * (newCeiling - newFloor) * compressionFactor);
        
        // Ensure within bounds and always at least small improvement
        staffMember.skill = Math.max(staffMember.skill + 1, Math.min(newCeiling, newSkill));
        
        // Update mechanic specializations on promotion
        if (staffMember.role === 'mechanic' && staffMember.mechanic) {
          updateMechanicSpecializations(staffMember, newLevel);
        }
        
        // Staff member has leveled up - generate raise request
        staffMember.experienceLevel = newLevel;
        generateRaiseRequest(staffMember);
        
        // If they still have enough XP for another promotion, it will trigger on next check
        // (This prevents multiple raise requests at once)
      }
    }
    
    // Update mechanic specializations when they level up
    function updateMechanicSpecializations(staffMember, newLevel) {
      const specs = staffMember.mechanic.specializations;
      
      if (newLevel === 'mid') {
        // Mid: gain turboprop (guaranteed on promotion, reward for developing them)
        if (!specs.includes('turboprop')) {
          specs.push('turboprop');
        }
      } else if (newLevel === 'senior') {
        // Senior: ensure turboprop, gain jet
        if (!specs.includes('turboprop')) {
          specs.push('turboprop');
        }
        if (!specs.includes('jet')) {
          specs.push('jet');
        }
      } else if (newLevel === 'expert') {
        // Expert: all specializations
        if (!specs.includes('turboprop')) specs.push('turboprop');
        if (!specs.includes('jet')) specs.push('jet');
      }
    }
    
    // Convert numeric skill to qualitative assessment
    function getSkillAssessment(skill) {
      if (skill >= 90) return { label: 'Outstanding', color: 'var(--success)' };
      if (skill >= 75) return { label: 'Strong', color: '#22c55e' };
      if (skill >= 60) return { label: 'Solid', color: 'var(--accent)' };
      if (skill >= 45) return { label: 'Average', color: 'var(--muted)' };
      if (skill >= 30) return { label: 'Developing', color: 'var(--warning)' };
      return { label: 'Novice', color: 'var(--danger)' };
    }
    
    // Check if staff member is an outlier for their experience level
    function getSkillOutlierNote(skill, experienceLevel) {
      const [floor, ceiling] = STAFF_SKILL_RANGES[experienceLevel];
      const midpoint = (floor + ceiling) / 2;
      const range = ceiling - floor;
      
      // How far from midpoint as percentage of range
      const deviation = (skill - midpoint) / range;
      
      if (deviation > 0.4) {
        return { note: 'Unusually talented for experience level', positive: true };
      } else if (deviation < -0.4) {
        return { note: 'Still developing fundamentals', positive: false };
      }
      return null;
    }
    
    // Generate raise request email
    // Internal promotions request ~80% of market rate (loyalty discount)
    function generateRaiseRequest(staffMember) {
      const currentSalary = staffMember.salary;
      const baseSalary = STAFF_SALARIES[staffMember.role][staffMember.experienceLevel];
      // Loyalty discount: internal promotions request 80-90% of market rate
      const loyaltyDiscount = 0.80 + (Math.random() * 0.10); // 80-90%
      let requestedSalary = Math.round((baseSalary * loyaltyDiscount) / 100) * 100;
      
      // Ensure the raise is at least 15% above current salary (minimum meaningful raise)
      // Use ceiling to ensure we always round UP for the minimum
      const minimumRaise = Math.ceil((currentSalary * 1.15) / 100) * 100;
      if (requestedSalary <= currentSalary) {
        requestedSalary = minimumRaise;
      } else if (requestedSalary < minimumRaise) {
        // If loyalty rate is too close to current, bump up to minimum
        requestedSalary = Math.max(requestedSalary, minimumRaise);
      }
      
      const raiseEmail = {
        id: uuid(),
        type: 'staff_raise',
        from: staffMember.name,
        subject: 'Raise Request',
        body: `I've grown a lot in my role here and believe my contributions warrant a salary adjustment.\n\n` +
              `Current salary: $${currentSalary.toLocaleString()}/month\n` +
              `Requested salary: $${requestedSalary.toLocaleString()}/month\n\n` +
              `I've taken on more responsibility and improved my skills significantly. I appreciate the opportunity to develop here and hope you'll consider my request.`,
        staffId: staffMember.id,
        currentSalary: currentSalary,
        requestedSalary: requestedSalary,
        status: 'pending',
        receivedAt: { ...S.gameTime }
      };
      
      S.emails.unshift(raiseEmail);
      staffMember.pendingRaiseRequest = raiseEmail.id;
    }
    
    // Accept a raise request
    function acceptRaise(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email || email.type !== 'staff_raise') return;
      
      const staffMember = S.staff.find(s => s.id === email.staffId);
      if (!staffMember) return;
      
      staffMember.salary = email.requestedSalary;
      delete staffMember.pendingRaiseRequest;
      email.status = 'accepted';
      
      updatePayrollTotal();
      
      showToast('Raise Approved', `${staffMember.name}'s salary updated to $${email.requestedSalary.toLocaleString()}/month`, 'success');
      
      saveState();
      render();
    }
    window.acceptRaise = acceptRaise;
    
    // Decline a raise request
    function declineRaise(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email || email.type !== 'staff_raise') return;
      
      const staffMember = S.staff.find(s => s.id === email.staffId);
      if (!staffMember) return;
      
      delete staffMember.pendingRaiseRequest;
      email.status = 'declined';
      staffMember.raiseDeclinedDate = { ...S.gameTime };
      staffMember.underpaid = true;
      
      showToast('Raise Declined', `${staffMember.name}'s request was declined`, 'warning');
      
      saveState();
      render();
    }
    window.declineRaise = declineRaise;
    
    // Check if underpaid staff might quit (called periodically)
    function checkStaffQuits() {
      const quitCandidates = S.staff.filter(s => s.underpaid && s.raiseDeclinedDate);
      
      quitCandidates.forEach(staffMember => {
        // Calculate days since decline
        const declineDate = staffMember.raiseDeclinedDate;
        const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
        const declineDays = (declineDate.year * 336) + ((declineDate.month - 1) * 28) + declineDate.day;
        const daysSinceDecline = currentDays - declineDays;
        
        // 30% chance to quit between 7-14 days after decline
        if (daysSinceDecline >= 7 && daysSinceDecline <= 14 && !staffMember.quitCheckDone) {
          staffMember.quitCheckDone = true;
          
          if (Math.random() < 0.30) {
            // Staff quits
            const quitEmail = {
              id: uuid(),
              type: 'notification',
              from: staffMember.name,
              subject: 'Resignation Notice',
              body: `After careful consideration, I've decided to pursue other opportunities.\n\n` +
                    `I appreciate my time here, but feel my contributions aren't being fairly recognized.\n\n` +
                    `My last day will be effective immediately. Best wishes for the company's future.`,
              status: 'unread',
              receivedAt: { ...S.gameTime }
            };
            S.emails.unshift(quitEmail);
            
            // Remove from staff
            const staffIndex = S.staff.findIndex(s => s.id === staffMember.id);
            if (staffIndex !== -1) {
              S.staff.splice(staffIndex, 1);
              updatePayrollTotal();
              showToast('Staff Quit', `${staffMember.name} has resigned`, 'warning');
            }
          }
        }
      });
    }
    
    // Get staff by role
    function getStaffByRole(role) {
      return S.staff.filter(s => s.role === role);
    }
    
    // Check if we have a staff member of a specific role
    function hasStaffRole(role) {
      return S.staff.some(s => s.role === role);
    }
    
    // Get the best staff member of a role (highest skill)
    function getBestStaff(role) {
      const roleStaff = getStaffByRole(role);
      if (roleStaff.length === 0) return null;
      return roleStaff.reduce((best, current) => current.skill > best.skill ? current : best);
    }
    
    // Get marketing bonus multiplier (if marketing staff exists)
    function getMarketingContractBonus() {
      if (!S.supportStaff?.marketing) return 0;
      return STAFF_EFFECTS.marketing.contractValueBonus;
    }
    
    // Get marketing reputation bonus
    function getMarketingRepBonus() {
      if (!S.supportStaff?.marketing) return 0;
      return STAFF_EFFECTS.marketing.repGainBonus;
    }
    
    // Get accountant revenue bonus
    function getAccountantRevenueBonus() {
      if (!S.supportStaff?.accountant) return 0;
      return STAFF_EFFECTS.accountant.revenueBonus;
    }
    
    // Get accountant payroll discount
    function getAccountantPayrollDiscount() {
      if (!S.supportStaff?.accountant) return 0;
      return STAFF_EFFECTS.accountant.payrollDiscount;
    }
    
    // Get accountant insurance discount
    function getAccountantInsuranceDiscount() {
      if (!S.supportStaff?.accountant) return 0;
      return STAFF_EFFECTS.accountant.insuranceDiscount;
    }
    
    // Get accountant LOC APR reduction
    function getAccountantLocReduction() {
      if (!S.supportStaff?.accountant) return 0;
      return STAFF_EFFECTS.accountant.locAprReduction;
    }
    
    // Get mechanic labor discount
    function getMechanicLaborDiscount() {
      const mechanic = getBestStaff('mechanic');
      if (!mechanic) return 0;
      return STAFF_EFFECTS.mechanic.laborDiscount[mechanic.experienceLevel] || 0;
    }

    // ========== STAFF PILOT SYSTEM ==========
    
    // Get crew requirement for an aircraft
    function getCrewRequired(aircraftCode) {
      const aircraft = AIRCRAFT[aircraftCode];
      return aircraft?.crewRequired || 1;
    }
    
    // Get available pilots (not currently flying)
    function getAvailablePilots() {
      return S.staff.filter(s => 
        s.role === 'pilot' && 
        s.status !== 'flying' &&  // Can be 'available' or 'assigned' (to future flight)
        (s.pilot?.hoursToday || 0) < 8
      );
    }
    
    // Get pilots available for a specific departure time (checks for conflicts)
    function getAvailablePilotsForTime(departureTime, flightHours) {
      const depMinutes = gameTimeToMinutes(departureTime);
      const endMinutes = depMinutes + Math.ceil(flightHours * 60) + 30; // +30 for ground ops
      
      return S.staff.filter(s => {
        if (s.role !== 'pilot') return false;
        if (s.status === 'flying') return false;
        if ((s.pilot?.hoursToday || 0) >= 8) return false;
        
        // Check if pilot has a conflicting assignment
        if (s.status === 'assigned' && s.currentMission) {
          const assignedMission = S.staffMissions.find(m => m.id === s.currentMission);
          if (assignedMission) {
            const assignedDep = gameTimeToMinutes(assignedMission.departureTime);
            const assignedEnd = gameTimeToMinutes(assignedMission.estimatedCompletion);
            
            // Check for overlap
            if (depMinutes < assignedEnd && endMinutes > assignedDep) {
              return false; // Conflict
            }
          }
        }
        
        return true;
      });
    }
    
    // Check if pilot can be PIC for a specific aircraft (full requirements)
    function canPilotBePIC(pilot, aircraftCode) {
      const aircraft = AIRCRAFT[aircraftCode];
      if (!aircraft) return false;
      
      const category = aircraft.category;
      const req = CATEGORY_REQUIREMENTS[category];
      if (!req) return true; // No requirements
      
      // Check certificates
      if (req.certificates) {
        for (const cert of req.certificates) {
          if (!pilot.pilot?.certificates?.includes(cert)) return false;
        }
      }
      
      // Check ratings
      if (req.ratings) {
        for (const rating of req.ratings) {
          if (!pilot.pilot?.ratings?.includes(rating)) return false;
        }
      }
      
      return true;
    }
    
    // Check if pilot can be SIC (lower requirements - just commercial + IFR)
    function canPilotBeSIC(pilot, aircraftCode) {
      // SIC just needs commercial certificate and instrument rating
      const certs = pilot.pilot?.certificates || [];
      const ratings = pilot.pilot?.ratings || [];
      
      // Must have commercial (or higher)
      const hasCommercial = certs.includes('commercial') || certs.includes('atp');
      // Must have instrument
      const hasInstrument = ratings.includes('instrument');
      
      return hasCommercial && hasInstrument;
    }
    
    // Legacy function name for compatibility
    function canPilotFlyAircraft(pilot, aircraftCode) {
      return canPilotBePIC(pilot, aircraftCode);
    }
    
    // Get pilots qualified as PIC for a specific aircraft
    function getQualifiedPilots(aircraftCode, departureTime = null, flightHours = null) {
      const basePilots = (departureTime && flightHours) 
        ? getAvailablePilotsForTime(departureTime, flightHours)
        : getAvailablePilots();
      return basePilots.filter(p => canPilotBePIC(p, aircraftCode));
    }
    
    // Get pilots qualified as SIC for a specific aircraft
    function getQualifiedSICPilots(aircraftCode, departureTime = null, flightHours = null) {
      const basePilots = (departureTime && flightHours) 
        ? getAvailablePilotsForTime(departureTime, flightHours)
        : getAvailablePilots();
      return basePilots.filter(p => canPilotBeSIC(p, aircraftCode));
    }
    
    // Check if we have enough crew for a mission
    function checkCrewAvailability(aircraftCode, isPlayerFlying = false, departureTime = null, flightHours = null) {
      const crewRequired = getCrewRequired(aircraftCode);
      
      // Debug: Show all pilots first
      console.log('All staff pilots:', S.staff.filter(s => s.role === 'pilot').map(p => 
        p.name + ' (status: ' + p.status + ', turbine: ' + (p.pilot?.ratings?.includes('turbine') || false) + ')'
      ));
      
      const picPilots = getQualifiedPilots(aircraftCode, departureTime, flightHours);
      const sicPilots = getQualifiedSICPilots(aircraftCode, departureTime, flightHours);
      
      console.log('checkCrewAvailability for', aircraftCode, '- crewRequired:', crewRequired, 'isPlayerFlying:', isPlayerFlying, 'departureTime:', departureTime ? formatGameTime(departureTime) : 'none');
      console.log('  PIC-qualified pilots:', picPilots.length, picPilots.map(p => p.name + ' (' + p.status + ', certs: ' + (p.pilot?.certificates || []).join('/') + ', ratings: ' + (p.pilot?.ratings || []).join('/') + ')'));
      console.log('  SIC-qualified pilots:', sicPilots.length, sicPilots.map(p => p.name + ' (' + p.status + ')'));
      
      if (isPlayerFlying) {
        // Player is PIC, just need SIC(s)
        const staffNeeded = crewRequired - 1;
        return {
          canFly: sicPilots.length >= staffNeeded,
          staffNeeded: staffNeeded,
          availableCount: sicPilots.length,
          availablePilots: sicPilots  // For SIC selection
        };
      } else {
        // All staff flight - need 1 PIC + rest can be SIC
        if (crewRequired === 1) {
          return {
            canFly: picPilots.length >= 1,
            staffNeeded: 1,
            availableCount: picPilots.length,
            availablePilots: picPilots
          };
        } else {
          // Need at least 1 PIC, plus SICs for the rest
          // SIC pool excludes whoever we pick as PIC, so we need (crewRequired - 1) SICs available
          // But a PIC-qualified pilot can also serve as SIC
          const hasPIC = picPilots.length >= 1;
          const hasSICs = sicPilots.length >= crewRequired; // Total pool must cover all seats
          return {
            canFly: hasPIC && hasSICs,
            staffNeeded: crewRequired,
            availableCount: picPilots.length,
            availablePICCount: picPilots.length,
            availableSICCount: sicPilots.length,
            availablePilots: picPilots,
            availableSICPilots: sicPilots
          };
        }
      }
    }
    
    // Auto-assign best available pilot(s) for a mission
    function autoAssignCrew(aircraftCode, isPlayerFlying = false) {
      const crewRequired = getCrewRequired(aircraftCode);
      
      if (isPlayerFlying) {
        // Player is PIC, just need SIC(s)
        const sicPilots = getQualifiedSICPilots(aircraftCode);
        sicPilots.sort((a, b) => b.skill - a.skill);
        const sic = sicPilots[0] || null;
        return {
          pic: null,  // Player
          sic: sic,
          crew: sic ? [sic] : []
        };
      } else {
        // Staff flight - need PIC + SIC(s)
        const picPilots = getQualifiedPilots(aircraftCode);
        const sicPilots = getQualifiedSICPilots(aircraftCode);
        
        // Sort by skill (best first)
        picPilots.sort((a, b) => b.skill - a.skill);
        sicPilots.sort((a, b) => b.skill - a.skill);
        
        const pic = picPilots[0] || null;
        // SIC should be different from PIC
        const sic = crewRequired > 1 ? sicPilots.find(p => p.id !== pic?.id) || null : null;
        
        const crew = [];
        if (pic) crew.push(pic);
        if (sic) crew.push(sic);
        
        return {
          pic: pic,
          sic: sic,
          crew: crew
        };
      }
    }
    
    // Dispatch a mission to staff pilots
    function dispatchStaffMission(emailId, assignedCrew) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return { success: false, error: 'Mission not found' };
      
      const aircraft = getAircraft(email.aircraftCode);
      if (!aircraft) return { success: false, error: 'Aircraft not found' };
      
      const crewRequired = getCrewRequired(email.aircraftCode);
      if (assignedCrew.length < crewRequired) {
        return { success: false, error: `Need ${crewRequired} pilot(s), only ${assignedCrew.length} assigned` };
      }
      
      // Calculate flight time
      const flightHours = email.distance / (aircraft.cruise_speed || 120);
      
      // Check duty limits
      for (const pilot of assignedCrew) {
        if ((pilot.pilot?.hoursToday || 0) + flightHours > 8) {
          return { success: false, error: `${pilot.name} would exceed daily duty limit` };
        }
      }
      
      // Use email's scheduled start time, or current time if not set
      const departureTime = email.startTime ? { ...email.startTime } : { ...S.gameTime };
      
      // Calculate completion time from scheduled departure
      const completionTime = addMinutes({ ...departureTime }, Math.ceil(flightHours * 60) + 30); // +30 min for ground ops
      
      // Create staff mission object
      const staffMission = {
        id: uuid(),
        emailId: emailId,
        aircraftCode: email.aircraftCode,
        crew: assignedCrew.map(p => ({ id: p.id, name: p.name, role: p === assignedCrew[0] ? 'PIC' : 'SIC' })),
        departureTime: departureTime,
        estimatedCompletion: completionTime,
        flightHours: flightHours,
        status: 'scheduled',
        route: `${email.fromIcao} â†’ ${email.toIcao}`,
        missionType: email.missionType,
        revenue: email.playerBid || email.payment || email.acceptedBid || 0
      };
      
      // Mark pilots as assigned to this mission (not flying yet - that happens at departure time)
      for (const pilot of assignedCrew) {
        const staffMember = S.staff.find(s => s.id === pilot.id);
        if (staffMember) {
          staffMember.status = 'assigned';
          staffMember.currentMission = staffMission.id;
          staffMember.assignedDepartureTime = departureTime;
        }
      }
      
      // Mark email as dispatched
      email.status = 'staff_dispatched';
      email.staffMissionId = staffMission.id;
      
      // Add to active staff missions (status will be 'scheduled' until departure)
      staffMission.status = 'scheduled';
      S.staffMissions.push(staffMission);
      
      // Remove from scheduled flights if present
      S.scheduledFlights = S.scheduledFlights.filter(f => f.emailId !== emailId);
      
      saveState();
      
      return { success: true, mission: staffMission };
    }
    
    // Check and complete staff missions (called during time advance)
    function processStaffMissions() {
      if (!S.staffMissions || S.staffMissions.length === 0) return;
      
      const currentMinutes = gameTimeToMinutes(S.gameTime);
      console.log('processStaffMissions - currentMinutes:', currentMinutes, 'missions:', S.staffMissions.length);
      
      const completedMissions = [];
      const startingMissions = [];
      
      for (const mission of S.staffMissions) {
        const departureMinutes = gameTimeToMinutes(mission.departureTime);
        const completionMinutes = gameTimeToMinutes(mission.estimatedCompletion);
        
        console.log('  Mission:', mission.route, 'status:', mission.status, 'dep:', departureMinutes, 'comp:', completionMinutes, 'current:', currentMinutes);
        
        // Check if mission should start
        if (mission.status === 'scheduled' && currentMinutes >= departureMinutes) {
          console.log('    -> Should START');
          startingMissions.push(mission);
        }
        
        // Check if mission should complete
        if (mission.status === 'in_progress' && currentMinutes >= completionMinutes) {
          console.log('    -> Should COMPLETE');
          completedMissions.push(mission);
        }
      }
      
      // Start missions that have reached departure time
      for (const mission of startingMissions) {
        console.log('Starting mission:', mission.route);
        mission.status = 'in_progress';
        // Mark crew as flying
        for (const crewMember of mission.crew) {
          const staffMember = S.staff.find(s => s.id === crewMember.id);
          if (staffMember) {
            staffMember.status = 'flying';
          }
        }
      }
      
      // Complete missions that have finished
      for (const mission of completedMissions) {
        console.log('Completing mission:', mission.route);
        completeStaffMission(mission);
      }
    }
    
    // Fix pilot/mission statuses - corrects issues from old code
    function fixStaffMissionStatuses() {
      if (!S.staffMissions || S.staffMissions.length === 0) return;
      
      const currentMinutes = gameTimeToMinutes(S.gameTime);
      let fixed = false;
      
      for (const mission of S.staffMissions) {
        const departureMinutes = gameTimeToMinutes(mission.departureTime);
        
        // If mission says in_progress but departure hasn't happened yet, fix it
        if (mission.status === 'in_progress' && currentMinutes < departureMinutes) {
          console.log('Fixing mission status: was in_progress before departure time, changing to scheduled');
          mission.status = 'scheduled';
          fixed = true;
        }
        
        // Fix crew status based on mission status and time
        for (const crewMember of mission.crew) {
          const staffMember = S.staff.find(s => s.id === crewMember.id);
          if (!staffMember) continue;
          
          if (currentMinutes < departureMinutes) {
            // Before departure - should be 'assigned'
            if (staffMember.status === 'flying') {
              console.log('Fixing pilot status:', staffMember.name, 'was flying before departure, changing to assigned');
              staffMember.status = 'assigned';
              fixed = true;
            }
          } else if (mission.status === 'in_progress' || mission.status === 'scheduled') {
            // After departure but mission active - should be 'flying'
            if (staffMember.status === 'assigned') {
              staffMember.status = 'flying';
              fixed = true;
            }
          }
        }
      }
      
      if (fixed) {
        saveState();
      }
    }
    
    // Complete a staff mission and process results
    function completeStaffMission(mission) {
      try {
        console.log('completeStaffMission called for:', mission.route, 'revenue:', mission.revenue);
        
        const email = S.emails.find(e => e.id === mission.emailId);
        const aircraft = getAircraft(mission.aircraftCode);
        
        // Get PIC for outcome calculation
        const picId = mission.crew.find(c => c.role === 'PIC')?.id;
        const pic = S.staff.find(s => s.id === picId);
        const picSkill = pic?.skill || 50;
        
        // Determine outcome based on pilot skill
        const outcome = calculateStaffMissionOutcome(picSkill);
        
        // Process financial - ensure revenue is a valid number
        const revenue = Number(mission.revenue) || 0;
        console.log('Adding revenue to cash:', revenue, 'cash before:', S.cash);
        S.cash += revenue;
        console.log('Cash after:', S.cash);
        
        recordTransaction(
          `${mission.missionType || 'Staff Flight'}: ${mission.route || 'Unknown'} (Staff: ${mission.crew?.map(c => c.name).join(', ') || 'Unknown'})`,
          revenue,
          'flight_revenue'
        );
      
      // Update crew
      for (const crewMember of mission.crew) {
        const staffMember = S.staff.find(s => s.id === crewMember.id);
        if (staffMember) {
          staffMember.status = 'available';
          staffMember.currentMission = null;
          
          // Add flight hours
          if (staffMember.pilot) {
            staffMember.pilot.flightHours += mission.flightHours;
            staffMember.pilot.hoursToday += mission.flightHours;
            
            // Check for certificate eligibility (auto-unlock)
            checkStaffPilotCertificates(staffMember);
          }
          
          // Add XP (PIC gets more)
          const xpGain = crewMember.role === 'PIC' ? 15 : 8;
          staffMember.xp += xpGain;
          
          // Check for promotion
          checkStaffPromotion(staffMember);
        }
      }
      
      // Update aircraft condition
      console.log('Updating aircraft condition for:', mission.aircraftCode, 'in fleet:', S.fleet.includes(mission.aircraftCode));
      if (aircraft && S.fleet.includes(mission.aircraftCode)) {
        const fleetInfo = S.fleetData[mission.aircraftCode];
        console.log('  fleetInfo:', fleetInfo ? 'found' : 'NOT FOUND', 'flightHours:', mission.flightHours);
        if (fleetInfo) {
          const degradation = calculateConditionDegradation(mission.aircraftCode, mission.flightHours);
          console.log('  condition before:', fleetInfo.condition, 'degradation:', degradation);
          fleetInfo.condition = Math.max(0, (fleetInfo.condition || 100) - degradation);
          fleetInfo.hoursSinceInspection = (fleetInfo.hoursSinceInspection || 0) + mission.flightHours;
          fleetInfo.totalHoursSinceOverhaul = (fleetInfo.totalHoursSinceOverhaul || 0) + mission.flightHours;
          console.log('  condition after:', fleetInfo.condition);
        }
      }
      
      // Generate review based on outcome (adds to reputation system directly)
      if (email) {
        generateStaffMissionReview(email, outcome, mission);
      }
      
      // Mark mission complete
      mission.status = 'completed';
      mission.completedAt = { ...S.gameTime };
      mission.outcome = outcome;
      
      // Update email status
      if (email) {
        email.status = 'completed';
        email.completedAt = { ...S.gameTime };
      }
      
      // Send completion notification
      const outcomeText = outcome.type === 'excellent' ? 'excellent performance' : 
                          outcome.type === 'acceptable' ? 'completed successfully' : 
                          'completed with minor issues';
      
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: mission.crew[0]?.name || 'Flight Crew',
        subject: `Flight Complete: ${mission.route}`,
        body: `Mission ${outcomeText}.\n\nRoute: ${mission.route}\nFlight Time: ${mission.flightHours.toFixed(1)} hours\nRevenue: ${formatCurrency(revenue)}\n\n${outcome.comment || ''}`,
        receivedAt: { ...S.gameTime },
        read: false
      });
      
      // Remove from active missions
      S.staffMissions = S.staffMissions.filter(m => m.id !== mission.id);
      
      // Update totals
      S.totalHoursFlown += mission.flightHours;
      S.totalMilesFlown += (email?.distance || 0);
      
      saveState();
      } catch (error) {
        console.error('Error completing staff mission:', error);
        // Still try to remove the mission so it doesn't loop forever
        S.staffMissions = S.staffMissions.filter(m => m.id !== mission.id);
        saveState();
      }
    }
    
    // Cancel a staff mission (for debugging/stuck missions)
    function cancelStaffMission(missionId) {
      if (!confirm('Cancel this staff mission? The crew will return to available status and no revenue will be earned.')) {
        return;
      }
      
      const mission = S.staffMissions.find(m => m.id === missionId);
      if (mission) {
        // Return crew to available status
        for (const crewMember of mission.crew) {
          const staffMember = S.staff.find(s => s.id === crewMember.id);
          if (staffMember) {
            staffMember.status = 'available';
            staffMember.currentMission = null;
          }
        }
        
        // Remove from staff missions
        S.staffMissions = S.staffMissions.filter(m => m.id !== missionId);
        
        // Update associated email if exists
        const email = S.emails.find(e => e.staffMissionId === missionId);
        if (email) {
          email.status = 'cancelled';
        }
        
        saveState();
        render();
        showToast('Mission Cancelled', 'Staff mission has been cancelled', 'warning');
      }
    }
    window.cancelStaffMission = cancelStaffMission;
    
    // Calculate mission outcome based on pilot skill
    function calculateStaffMissionOutcome(skill) {
      // Outcome probabilities by skill range
      let excellentChance, acceptableChance;
      
      if (skill >= 80) {
        excellentChance = 0.90;
        acceptableChance = 0.09;
      } else if (skill >= 60) {
        excellentChance = 0.85;
        acceptableChance = 0.13;
      } else if (skill >= 40) {
        excellentChance = 0.80;
        acceptableChance = 0.17;
      } else {
        excellentChance = 0.75;
        acceptableChance = 0.21;
      }
      
      const roll = Math.random();
      
      if (roll < excellentChance) {
        return { 
          type: 'excellent', 
          stars: 4 + Math.random(), // 4.0-5.0
          comment: 'The flight crew was professional and the flight was smooth.'
        };
      } else if (roll < excellentChance + acceptableChance) {
        return { 
          type: 'acceptable', 
          stars: 3 + Math.random(), // 3.0-4.0
          comment: 'Flight completed as expected.'
        };
      } else {
        // Minor complaint
        const complaints = [
          'Departure was delayed.',
          'Landing was a bit rough.',
          'Communication could have been better.',
          'Flight took longer than expected.',
          'Cabin temperature was uncomfortable.'
        ];
        return { 
          type: 'complaint', 
          stars: 2 + Math.random(), // 2.0-3.0
          comment: randomItem(complaints)
        };
      }
    }
    
    // Generate and add review from staff mission
    function generateStaffMissionReview(email, outcome, mission) {
      const review = {
        id: 'REV-' + Date.now(),
        date: { ...S.gameTime },
        stars: Math.round(outcome.stars * 10) / 10,
        clientName: email.clientName || 'Client',
        clientTier: email.companyTier || 'regional',
        missionType: email.missionType,
        route: `${email.fromIcao} â†’ ${email.toIcao}`,
        comment: outcome.comment,
        staffFlown: true,
        crewNames: mission.crew.map(c => c.name)
      };
      
      // Add to review log
      if (!S.reputation.reviewLog) S.reputation.reviewLog = [];
      S.reputation.reviewLog.unshift(review);
      
      // Keep only last 100 reviews
      if (S.reputation.reviewLog.length > 100) {
        S.reputation.reviewLog = S.reputation.reviewLog.slice(0, 100);
      }
      
      // Update recent ratings
      if (!S.reputation.recentRatings) S.reputation.recentRatings = [];
      S.reputation.recentRatings.unshift(review.stars);
      if (S.reputation.recentRatings.length > 20) {
        S.reputation.recentRatings = S.reputation.recentRatings.slice(0, 20);
      }
      
      // Recalculate average
      S.reputation.totalReviews = (S.reputation.totalReviews || 0) + 1;
      const sum = S.reputation.recentRatings.reduce((a, b) => a + b, 0);
      S.reputation.stars = Math.round((sum / S.reputation.recentRatings.length) * 10) / 10;
      
      return review;
    }
    
    // Reset daily duty hours (called at midnight)
    function resetDailyDutyHours() {
      for (const staff of S.staff) {
        if (staff.role === 'pilot' && staff.pilot) {
          staff.pilot.hoursToday = 0;
        }
      }
    }

    // ========== AUTO-SAVE SYSTEM ==========
    const AUTO_SAVE_SLOTS = 5;
    const AUTO_SAVE_PREFIX = 'skylift_autosave_';
    
    function createAutoSave() {
      const saveData = {
        version: S.version,
        savedAt: new Date().toISOString(),
        gameTime: { ...S.gameTime },
        pilotName: S.pilot?.name || 'Pilot',
        totalHours: S.totalHoursFlown,
        cash: S.cash,
        gameState: S
      };
      
      // Rotate saves: shift existing saves up, drop oldest
      for (let i = AUTO_SAVE_SLOTS - 1; i > 0; i--) {
        const prev = localStorage.getItem(AUTO_SAVE_PREFIX + (i - 1));
        if (prev) {
          localStorage.setItem(AUTO_SAVE_PREFIX + i, prev);
        } else {
          localStorage.removeItem(AUTO_SAVE_PREFIX + i);
        }
      }
      
      // Save new backup to slot 0
      localStorage.setItem(AUTO_SAVE_PREFIX + '0', JSON.stringify(saveData));
      S.lastAutoSave = { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
      
      console.log('Auto-save created:', formatGameTime(S.gameTime));
      showToast('Auto-Save', `Backup saved (${formatGameTime(S.gameTime)})`, 'info');
    }
    
    function getAutoSaves() {
      const saves = [];
      for (let i = 0; i < AUTO_SAVE_SLOTS; i++) {
        const data = localStorage.getItem(AUTO_SAVE_PREFIX + i);
        if (data) {
          try {
            const parsed = JSON.parse(data);
            saves.push({
              slot: i,
              savedAt: parsed.savedAt,
              gameTime: parsed.gameTime,
              pilotName: parsed.pilotName,
              totalHours: parsed.totalHours,
              cash: parsed.cash
            });
          } catch (e) {
            console.error('Failed to parse auto-save slot', i, e);
          }
        }
      }
      return saves;
    }
    
    function restoreAutoSave(slot) {
      const data = localStorage.getItem(AUTO_SAVE_PREFIX + slot);
      if (!data) {
        alert('Auto-save not found.');
        return;
      }
      
      try {
        const parsed = JSON.parse(data);
        const gameTime = parsed.gameTime;
        const pilotName = parsed.pilotName || 'Unknown';
        const hours = parsed.totalHours?.toFixed(1) || '0';
        const cash = parsed.cash || 0;
        
        if (confirm(`Restore this auto-save?\n\nPilot: ${pilotName}\nGame Date: ${formatGameTime(gameTime)}\nHours: ${hours}\nCash: ${formatCurrency(cash)}\n\nThis will REPLACE your current game progress!`)) {
          Object.assign(S, parsed.gameState);
          saveState();
          alert('Auto-save restored! The page will reload.');
          location.reload();
        }
      } catch (e) {
        console.error('Failed to restore auto-save:', e);
        alert('Failed to restore auto-save. The data may be corrupted.');
      }
    }
    window.restoreAutoSave = restoreAutoSave;
    
    function showAutoSaveModal() {
      const saves = getAutoSaves();
      
      const overlay = document.createElement('div');
      overlay.id = 'autoSaveOverlay';
      overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s;
      `;
      
      let savesHtml = '';
      if (saves.length === 0) {
        savesHtml = '<div style="text-align: center; color: var(--muted); padding: 20px;">No auto-saves found yet.</div>';
      } else {
        savesHtml = saves.map(save => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 6px; margin-bottom: 8px;">
            <div>
              <div style="font-weight: 600;">${save.pilotName}</div>
              <div style="font-size: 12px; color: var(--muted);">
                ${formatGameTime(save.gameTime)} â€¢ ${save.totalHours?.toFixed(1) || 0} hrs â€¢ ${formatCurrency(save.cash || 0)}
              </div>
            </div>
            <button class="btn" onclick="restoreAutoSave(${save.slot}); closeAutoSaveModal();" style="padding: 6px 12px;">Restore</button>
          </div>
        `).join('');
      }
      
      overlay.innerHTML = `
        <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 450px; width: 90%; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; font-size: 18px;">ðŸ“ Auto-Saves</h2>
            <button onclick="closeAutoSaveModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--muted);">Ã—</button>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 16px;">
            Auto-saves are created ${S.autoSaveFrequency === 'weekly' ? 'every Sunday' : S.autoSaveFrequency === 'monthly' ? 'on the 1st of each month' : 'when enabled'}. Last ${AUTO_SAVE_SLOTS} backups are kept.
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            ${savesHtml}
          </div>
          <div style="margin-top: 16px;">
            <button onclick="closeAutoSaveModal()" class="btn" style="width: 100%; padding: 10px;">Close</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      requestAnimationFrame(() => overlay.style.opacity = '1');
    }
    window.showAutoSaveModal = showAutoSaveModal;
    
    function closeAutoSaveModal() {
      const overlay = document.getElementById('autoSaveOverlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 200);
      }
    }
    window.closeAutoSaveModal = closeAutoSaveModal;
    
    function checkAutoSave(oldTime, newTime) {
      if (S.autoSaveFrequency === 'off') return;
      
      const oldDate = new Date(oldTime.year, oldTime.month - 1, oldTime.day);
      const newDate = new Date(newTime.year, newTime.month - 1, newTime.day);
      
      let shouldSave = false;
      
      if (S.autoSaveFrequency === 'weekly') {
        // Save on Sundays (day 0)
        // Check if we crossed a Sunday
        const daysCrossed = Math.floor((newDate - oldDate) / (1000 * 60 * 60 * 24));
        if (daysCrossed > 0) {
          // Check each day we crossed
          for (let d = 1; d <= daysCrossed; d++) {
            const checkDate = new Date(oldDate);
            checkDate.setDate(checkDate.getDate() + d);
            if (checkDate.getDay() === 0) { // Sunday
              shouldSave = true;
              break;
            }
          }
        }
      } else if (S.autoSaveFrequency === 'monthly') {
        // Save on 1st of month
        if (newTime.month !== oldTime.month || newTime.year !== oldTime.year) {
          shouldSave = true;
        }
      }
      
      if (shouldSave) {
        // Avoid duplicate saves on same game day
        if (S.lastAutoSave && 
            S.lastAutoSave.year === newTime.year && 
            S.lastAutoSave.month === newTime.month && 
            S.lastAutoSave.day === newTime.day) {
          return;
        }
        createAutoSave();
      }
    }
    
    function setAutoSaveFrequency(freq) {
      S.autoSaveFrequency = freq;
      saveState();
      showToast('Auto-Save', `Auto-save set to ${freq === 'off' ? 'disabled' : freq}`, 'info');
    }
    window.setAutoSaveFrequency = setAutoSaveFrequency;

    function advanceTime(minutes) {
      const oldMonth = S.gameTime.month;
      const oldYear = S.gameTime.year;
      const oldTime = { ...S.gameTime };
      const newTime = addMinutes(S.gameTime, minutes);
      
      // Check if we're skipping any scheduled flight start times
      console.log('advanceTime called:', {
        currentTime: `${S.gameTime.year}-${S.gameTime.month}-${S.gameTime.day} ${S.gameTime.hour}:${S.gameTime.minute}`,
        newTime: `${newTime.year}-${newTime.month}-${newTime.day} ${newTime.hour}:${newTime.minute}`,
        minutes: minutes,
        scheduledFlightsCount: S.scheduledFlights.length
      });
      
      if (S.scheduledFlights.length > 0) {
        console.log('Scheduled flights:', S.scheduledFlights.map(sf => ({
          id: sf.contractId,
          startTime: sf.contract?.startTime ? `${sf.contract.startTime.year}-${sf.contract.startTime.month}-${sf.contract.startTime.day} ${sf.contract.startTime.hour}:${sf.contract.startTime.minute}` : 'NO START TIME',
          missionType: sf.contract?.missionType
        })));
      }
      
      const skippedFlights = S.scheduledFlights.filter(sf => {
        const flight = sf.contract;
        if (!flight || !flight.startTime) {
          console.log('Flight missing contract or startTime:', sf);
          return false;
        }
        const currentMinutes = S.gameTime.year * 525600 + (S.gameTime.month - 1) * 43200 + (S.gameTime.day - 1) * 1440 + S.gameTime.hour * 60 + S.gameTime.minute;
        const flightMinutes = flight.startTime.year * 525600 + (flight.startTime.month - 1) * 43200 + (flight.startTime.day - 1) * 1440 + flight.startTime.hour * 60 + flight.startTime.minute;
        const newMinutes = newTime.year * 525600 + (newTime.month - 1) * 43200 + (newTime.day - 1) * 1440 + newTime.hour * 60 + newTime.minute;
        
        const beforeStart = currentMinutes < flightMinutes;
        const afterStart = newMinutes >= flightMinutes;  // >= so landing exactly on start time counts as skipping
        
        console.log('Checking flight:', {
          missionType: flight.missionType,
          startTime: `${flight.startTime.year}-${flight.startTime.month}-${flight.startTime.day} ${flight.startTime.hour}:${flight.startTime.minute}`,
          currentMinutes,
          flightMinutes,
          newMinutes,
          beforeStart,
          afterStart,
          wouldSkip: beforeStart && afterStart
        });
        
        return beforeStart && afterStart;
      });
      
      console.log('Skipped flights count:', skippedFlights.length);
      
      if (skippedFlights.length > 0) {
        const flight = skippedFlights[0].contract;
        const warning = `Warning: This will skip past your scheduled flight start time!\n\n` +
          `${flight.missionType}\n` +
          `${flight.from} (${flight.fromName}) â†’ ${flight.to} (${flight.toName})\n` +
          `Start Time: ${formatGameTime(flight.startTime)}\n\n` +
          `Click OK to MISS the flight (customer will be notified).\n` +
          `Click Cancel to ADVANCE TO the flight start time instead.`;
        
        if (!confirm(warning)) {
          // User clicked Cancel - advance to flight start time instead
          const flightStart = flight.startTime;
          S.gameTime = { ...flightStart };
          
          // Still process any time-based updates for the time we did advance
          checkAutoSave(oldTime, S.gameTime);
          
          if (S.gameTime.month !== oldMonth || S.gameTime.year !== oldYear) {
            const paymentEmails = processMonthlyFinancing();
            if (paymentEmails > 0) {
              showToast('Payments Due', `${paymentEmails} payment${paymentEmails > 1 ? 's' : ''} due - check your inbox`, 'warning');
            }
            const locInterest = processLOCInterest();
            if (locInterest > 0) {
              showToast('LOC Interest', `${formatCurrency(locInterest)} interest accrued`, 'info');
            }
            processOwnerSalary();
            processMonthlyInsurance();
          }
          
          // Process staff missions even on early return
          processStaffMissions();
          
          // Reset daily duty hours if day changed
          if (oldTime.day !== S.gameTime.day) {
            resetDailyDutyHours();
          }
          
          cleanupExpiredEmails();
          ensureEmails();
          saveState();
          render();
          showToast('Time Advanced', `Jumped to flight start: ${formatGameTime(S.gameTime)}`, 'info');
          return;
        }
        
        // Mark flights as failed and remove them
        skippedFlights.forEach(sf => {
          // Generate angry email from customer
          const angryEmail = {
            id: uuid(),
            type: "complaint",
            from: sf.contract.contractType === 'owned' ? "Dissatisfied Customer" : sf.contract.aircraftName + " Charter",
            company: "Contract Violation",
            subject: `MISSED FLIGHT - ${sf.contract.from} â†’ ${sf.contract.to}`,
            body: `We are extremely disappointed that you failed to start the scheduled flight on time.\n\nContract: ${sf.contract.missionType}\nScheduled Start: ${formatGameTime(sf.contract.startTime)}\n\nThis is unacceptable and has caused significant disruption to our operations. We will not be working with you again.`,
            status: "complaint",
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          };
          S.emails.push(angryEmail);
          S.scheduledFlights = S.scheduledFlights.filter(x => x.contractId !== sf.contractId);
        });
        
        // Reset active contract if it was skipped
        if (skippedFlights.some(sf => sf.contractId === S.activeContractId)) {
          S.activeContractId = null;
          S.flightStarted = false;
        }
      }
      
      S.gameTime = newTime;
      
      // Check for auto-save trigger
      checkAutoSave(oldTime, newTime);
      
      // Check for new month - process monthly financials
      if (newTime.month !== oldMonth || newTime.year !== oldYear) {
        // Process loan/lease payments
        const paymentEmails = processMonthlyFinancing();
        if (paymentEmails > 0) {
          showToast('Payments Due', `${paymentEmails} payment${paymentEmails > 1 ? 's' : ''} due - check your inbox`, 'warning');
        }
        
        // Process LOC interest
        const locInterest = processLOCInterest();
        if (locInterest > 0) {
          showToast('LOC Interest', `${formatCurrency(locInterest)} interest accrued`, 'info');
        }
        
        // Process owner salary
        const salary = processOwnerSalary();
        if (salary > 0) {
          showToast('Owner Salary', `${formatCurrency(salary)} monthly draw`, 'info');
        }
        
        // Process insurance premium
        const basePremium = calculateInsurancePremium();
        if (basePremium > 0) {
          processMonthlyInsurance();
          const insuranceDiscount = getAccountantInsuranceDiscount();
          const discountedPremium = insuranceDiscount > 0 ? Math.round(basePremium * (1 - insuranceDiscount)) : basePremium;
          showToast('Insurance', `${formatCurrency(discountedPremium)} liability premium`, 'info');
        }
        
        // Process staff payroll
        const payroll = processPayroll();
        if (payroll > 0) {
          showToast('Payroll', `${formatCurrency(payroll)} staff payroll`, 'info');
        }
        
        // Process facility upkeep
        const facilityUpkeep = processFacilityUpkeep();
        if (facilityUpkeep > 0) {
          showToast('Facility Upkeep', `${formatCurrency(facilityUpkeep)} maintenance`, 'info');
        }
        
        // Reset payroll warning flag for next month
        S.payrollWarningSent = false;
        
        // Check for staff quits (underpaid staff)
        checkStaffQuits();
        
        // Reset monthly P&L tracking
        if (S.financials) {
          S.financials.revenueThisMonth = 0;
          S.financials.expensesThisMonth = 0;
          S.financials.lastMonthReset = { ...newTime };
          
          // Reset YTD on new year
          if (newTime.year !== oldYear) {
            S.financials.revenueYTD = 0;
            S.financials.expensesYTD = 0;
            if (S.ownerCompensation) {
              S.ownerCompensation.ytdDraws = 0;
            }
          }
        }
        
        // Also refresh market on first of month
        if (newTime.day <= 3) {
          refreshMarketListings();
        }
        
        // Increment months in business and recalculate lender assessment
        if (!S.lenderAssessment) {
          S.lenderAssessment = { tier: 'startup', monthsInBusiness: 0, onTimePayments: 0, missedPayments: 0 };
        }
        S.lenderAssessment.monthsInBusiness++;
        calculateLenderAssessment();
        
        // Daily market micro-refresh: AI buyers purchase + some new listings trickle in
        // This spreads hot deal emails throughout the month
        if (oldTime.day !== newTime.day) {
          microRefreshMarket();
        }
      }
      
      // Check for weekly staff marketplace refresh
      checkMarketplaceRefresh();
      
      // Check for payroll warning near month end
      checkPayrollWarning();
      
      // Check for completed pilot training
      checkTrainingCompletion();
      
      // Check for completed facility construction
      checkConstructionCompletion();
      
      // Check for completed fuel tank construction
      checkFuelTankConstruction();
      
      // Check for completed MX facility construction
      checkMxFacilityConstruction();
      
      // Process broker requests
      processBrokerRequest();
      
      // Check for completed maintenance
      checkAndCompleteMaintenance();
      
      // Process staff missions (check for completions)
      processStaffMissions();
      
      // Reset daily duty hours at midnight
      if (oldTime.day !== newTime.day) {
        resetDailyDutyHours();
      }
      
      cleanupExpiredEmails();
      ensureEmails();
      saveState();
      render();
    }

    function advanceToNextFlight() {
      // Gather all scheduled events (flights and checkrides)
      const flightEvents = S.scheduledFlights.map(sf => ({
        type: 'flight',
        time: sf.contract.startTime,
        data: sf
      }));
      
      const checkrideEvents = (S.checkrides.scheduled || []).map(cr => ({
        type: 'checkride',
        time: cr.scheduledTime,
        data: cr
      }));
      
      const allEvents = [...flightEvents, ...checkrideEvents];
      
      if (allEvents.length === 0) {
        alert('No scheduled flights or checkrides. Accept a contract first.');
        return;
      }
      
      // Sort by time
      const sorted = allEvents.sort((a, b) => compareGameTime(a.time, b.time));
      
      // FIRST: Check if any event is at current time (ready to start)
      const atStartTime = sorted.find(e => compareGameTime(S.gameTime, e.time) === 0);
      if (atStartTime) {
        if (atStartTime.type === 'checkride') {
          alert('Checkride is ready! Click it on the Calendar to begin.');
        } else {
          alert('Flight is ready to start! Start your pre-flight from the Calendar.');
        }
        switchTab('calendar');
        render();
        return;
      }
      
      // SECOND: Find the EARLIEST event that we haven't passed yet
      // This includes events at current time (>=) not just future events (>)
      const nextEvent = sorted.find(e => compareGameTime(S.gameTime, e.time) <= 0);
      
      if (!nextEvent) {
        // All events are in the past
        alert('All scheduled events have passed. Accept new contracts.');
        return;
      }
      
      // Advance to start time of next event
      S.gameTime = { ...nextEvent.time };
      cleanupExpiredEmails();
      ensureEmails();
      saveState();
      render();
      switchTab('calendar');
      
      if (nextEvent.type === 'checkride') {
        alert(`Advanced to ${formatGameTime(S.gameTime)}\n\nYour checkride is ready! Click it on the Calendar to begin.`);
      } else {
        alert(`Advanced to ${formatGameTime(S.gameTime)}\n\nYour flight is ready! Click it on the Calendar to start.`);
      }
    }
    
    function advanceToNextDay() {
      // Advance to 06:00 the next day
      const tomorrow = addDays(S.gameTime, 1);
      const nextMorning = {
        year: tomorrow.year,
        month: tomorrow.month,
        day: tomorrow.day,
        hour: 6,
        minute: 0
      };
      
      advanceTime(compareGameTime(nextMorning, S.gameTime));
    }

    // Calculate email volume based on company size/reputation
    function calculateEmailVolume() {
      // Base email count starts at 1-2 for new operations
      let baseEmails = 1;
      
      // Factor 1: Company reputation (0-5 stars) - more reputation = more inquiries
      const avgReputation = S.reputation?.stars || 3; // Default to 3 stars
      const repMultiplier = 0.5 + (avgReputation / 5) * 1.0; // 0.5x to 1.5x
      
      // Factor 2: Fleet size - more aircraft = more capacity = more inquiries
      const fleetSize = Object.keys(S.fleetData || {}).length;
      const fleetBonus = Math.min(fleetSize * 0.5, 2); // +0.5 per aircraft, max +2
      
      // Factor 3: Total revenue this month indicates market presence
      const monthlyRevenue = S.financials?.revenueThisMonth || 0;
      let revenueBonus = 0;
      if (monthlyRevenue > 50000) revenueBonus = 2;
      else if (monthlyRevenue > 20000) revenueBonus = 1.5;
      else if (monthlyRevenue > 10000) revenueBonus = 1;
      else if (monthlyRevenue > 5000) revenueBonus = 0.5;
      
      // Factor 4: Certificates held - more certs = access to more markets
      const certCount = (S.pilot.certificates?.length || 0) + (S.pilot.ratings?.length || 0);
      const certBonus = Math.min(certCount * 0.25, 1.5); // +0.25 per cert/rating, max +1.5
      
      // Calculate final email count
      baseEmails = Math.round((baseEmails + fleetBonus + revenueBonus + certBonus) * repMultiplier);
      
      // Clamp to reasonable range: 1-8 emails per day
      return Math.max(1, Math.min(8, baseEmails));
    }
    
    // Helper to add system emails (notifications, alerts, etc)
    function addEmail(options) {
      const email = {
        id: uuid(),
        type: options.type || 'notification',
        subject: options.subject || 'Notification',
        from: options.from || 'Skylift Operations',
        company: options.company || 'Skylift Aviation',
        body: options.body || '',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        ...options // Allow overrides
      };
      S.emails.push(email);
      debugLog(`addEmail: "${email.subject}" type=${email.type}, total emails=${S.emails.length}`);
      saveState();
      return email;
    }
    
    function ensureEmails() {
      debugLog('ensureEmails called', { 
        gameMode: S.gameMode, 
        tutorialComplete: S.tutorialComplete,
        fleet: S.fleet,
        certifications: S.pilot?.aircraftCertifications,
        homeBase: S.bases?.primary,
        airportsLoaded: Object.keys(AIRPORTS).length
      });
      
      cleanupExpiredEmails();
      
      // Ensure pendingEmails exists
      if (!S.pendingEmails) S.pendingEmails = [];
      
      // Move pending emails to inbox when their timestamp arrives
      const arrivedEmails = S.pendingEmails.filter(email => 
        compareGameTime(S.gameTime, email.receivedAt) >= 0
      );
      
      arrivedEmails.forEach(email => {
        S.emails.push(email);
      });
      
      S.pendingEmails = S.pendingEmails.filter(email => 
        compareGameTime(S.gameTime, email.receivedAt) < 0
      );
      
      // In career mode, handle tutorial flow first
      if (S.gameMode === 'career' && !S.tutorialComplete) {
        ensureTutorialEmails();
        return; // Don't generate regular mission emails until tutorial is done
      }
      
      // Ensure finance intro email for players with PPL (including existing saves)
      if (S.pilot.certificates.includes('private')) {
        const hasFinanceEmail = S.emails.some(e => 
          e.from === 'First Sky Bank' && e.subject === 'Your Line of Credit is Ready'
        );
        if (!hasFinanceEmail && !S.financeIntroSent) {
          S.emails.push(generateFinanceIntroEmail());
          S.financeIntroSent = true;
        }
      }
      
      // Track which days we've generated emails for
      if (!S.lastEmailDay) {
        S.lastEmailDay = { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
      }
      
      // Generate emails for any days we've skipped
      const currentDate = new Date(S.gameTime.year, S.gameTime.month - 1, S.gameTime.day);
      const lastDate = new Date(S.lastEmailDay.year, S.lastEmailDay.month - 1, S.lastEmailDay.day);
      
      // Calculate days between last email generation and now
      const daysDiff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
      
      debugLog('Email generation check', {
        currentDate: `${S.gameTime.year}-${S.gameTime.month}-${S.gameTime.day}`,
        lastEmailDay: `${S.lastEmailDay.year}-${S.lastEmailDay.month}-${S.lastEmailDay.day}`,
        daysDiff: daysDiff,
        currentHour: S.gameTime.hour
      });
      
      if (daysDiff > 0) {
        // Generate emails for each skipped day
        debugLog('Generating emails for skipped days', { daysDiff });
        for (let d = 1; d <= daysDiff; d++) {
          const emailDate = new Date(lastDate);
          emailDate.setDate(emailDate.getDate() + d);
          
          const emailDay = {
            year: emailDate.getFullYear(),
            month: emailDate.getMonth() + 1,
            day: emailDate.getDate()
          };
          
          // Generate emails for this day based on company size (with some variance)
          const baseEmails = calculateEmailVolume();
          const emailCount = randomInt(Math.max(1, baseEmails - 1), baseEmails + 1);
          debugLog(`Generating ${emailCount} emails for day ${emailDay.month}/${emailDay.day}`);
          for (let i = 0; i < emailCount; i++) {
            const email = generateEmailForDay(emailDay);
            if (email) {
              // Deliver immediately if time has passed, otherwise pending
              if (compareGameTime(S.gameTime, email.receivedAt) >= 0) {
                S.emails.push(email);
              } else {
                S.pendingEmails.push(email);
              }
              debugLog('Generated email:', email.subject);
            } else {
              debugLog('generateEmailForDay returned null');
            }
          }
        }
        
        // Update last email day
        S.lastEmailDay = { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
      }
      
      // Also generate for today if in business hours and haven't yet
      const hasGeneratedToday = S.emails.some(e => 
        e.generatedDay === S.gameTime.day && 
        e.generatedMonth === S.gameTime.month && 
        e.generatedYear === S.gameTime.year
      );
      
      if (!hasGeneratedToday && S.gameTime.hour >= 8 && S.gameTime.hour < 18) {
        const baseEmails = calculateEmailVolume();
        const emailCount = randomInt(Math.max(1, baseEmails - 1), baseEmails + 1);
        for (let i = 0; i < emailCount; i++) {
          const email = generateEmail();
          if (email) {
            // Deliver immediately if time has passed, otherwise pending
            if (compareGameTime(S.gameTime, email.receivedAt) >= 0) {
              S.emails.push(email);
            } else {
              S.pendingEmails.push(email);
            }
          }
        }
      }
      
      // Check for special military mission opportunities
      maybeGenerateSpecialMilitaryMission();
    }
    
    // Generate rare special missions for certified military aircraft
    function maybeGenerateSpecialMilitaryMission() {
      // Only 5% chance per email check
      if (Math.random() > 0.05) return;
      
      // Check which special military aircraft the pilot is certified for
      const specialMilitary = ['FA18E', 'A10'];
      const certifiedMilitary = specialMilitary.filter(code => 
        S.pilot.certifications?.includes(code) || S.certifications?.includes(code)
      );
      
      if (certifiedMilitary.length === 0) return;
      
      // Don't spam - check if we already have a pending special military email
      const hasExisting = S.emails.some(e => e.isSpecialMilitary && e.status === 'pending');
      if (hasExisting) return;
      
      // Pick a random certified military aircraft
      const aircraftCode = randomItem(certifiedMilitary);
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return;
      
      // Generate a special mission
      const missionTypes = ['Thrill Flight', 'Airshow Aerobatics', 'Airshow Rides'];
      const missionType = randomItem(missionTypes);
      
      const operators = [
        { name: 'Heritage Flight Foundation', desc: 'preserving aviation history through flight demonstrations' },
        { name: 'Patriots Jet Team', desc: 'professional airshow performers' },
        { name: 'Warbird Adventures', desc: 'offering once-in-a-lifetime flight experiences' },
        { name: 'Fighter Pilot Experience', desc: 'providing authentic military aviation experiences' }
      ];
      const operator = randomItem(operators);
      
      // Contract pilot rate for military jets is premium
      const contractRate = Math.round((aircraft.operating_cost || 2000) * 2.5);
      const flightHours = missionType === 'Airshow Aerobatics' ? 0.5 : randomInt(1, 2);
      const payment = Math.round(contractRate * flightHours);
      
      const email = {
        id: uuid(),
        type: 'contract',
        isSpecialMilitary: true,
        aircraftCode: aircraftCode,
        aircraftName: aircraft.name,
        missionType: missionType,
        missionStructure: 'round_trip',
        from: operator.name,
        company: operator.name,
        companyTier: 'corporate',
        subject: `ðŸ”¥ Unique Opportunity: ${aircraft.name}`,
        weather: 'Clear',
        passengers: missionType === 'Airshow Rides' ? 1 : 0,
        cargoLbs: 0,
        startTime: roundToHour(addMinutes(S.gameTime, randomInt(24, 72) * 60)),
        scheduleBy: roundToHour(addMinutes(S.gameTime, randomInt(12, 48) * 60)),
        isNight: false,
        isEmergency: false,
        status: 'pending',
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        receivedAt: { ...S.gameTime },
        originIcao: S.bases?.primary || 'KJFK',
        originName: 'Local Airport',
        destinationIcao: S.bases?.primary || 'KJFK',
        destinationName: 'Local Airport',
        fromIcao: S.bases?.primary || 'KJFK',
        fromName: 'Local Airport',
        toIcao: S.bases?.primary || 'KJFK',
        toName: 'Local Airport',
        distance: 50,
        revenueDistance: 50,
        estimatedMinutes: Math.round(flightHours * 60),
        payment: payment,
        contractRate: contractRate,
        specialBody: `We're ${operator.desc} and have a rare opportunity for a qualified pilot.\n\nWe need someone certified to fly the ${aircraft.name} for an upcoming ${missionType.toLowerCase()} event. This is a contract position - we provide the aircraft, fuel, and insurance. You provide the skills.\n\nCompensation: ${formatCurrency(payment)} for approximately ${flightHours} hour(s) of flight time.\n\nThis is a unique chance to fly one of aviation's most iconic aircraft. Interested pilots should respond promptly as these opportunities are rare.`
      };
      
      S.emails.unshift(email);
    }
    
    // Tutorial email flow for new career mode players
    function ensureTutorialEmails() {
      try {
        const hasWelcomeEmail = S.emails.some(e => e.type === 'tutorial-welcome');
        const hasTrainingFlight = S.emails.some(e => e.type === 'training-flight');
        const hasScheduledTutorial = S.scheduledFlights.some(f => f.isTutorial);
        const hasPPLCheckride = S.emails.some(e => e.type === 'checkride' && e.gateKey === 'private');
        const hasPPLScheduled = S.checkrides?.scheduled?.some(c => c.gateKey === 'private') || false;
        const hasPPL = S.pilot.certificates.includes('private');
        
        // Step 1: Welcome email for brand new players
        if (!hasWelcomeEmail && !hasTrainingFlight && !hasScheduledTutorial && !hasPPLCheckride && !hasPPLScheduled && !hasPPL && S.pilotLog.length === 0) {
          S.emails.push(generateTutorialWelcomeEmail());
          return;
        }
        
        // Step 2: Check if player has reached required hours and needs PPL checkride
        if (S.totalHoursFlown >= CERT_REQUIREMENTS.private.hoursTotal && !hasPPLCheckride && !hasPPLScheduled && !hasPPL) {
          const pplEmail = generateCheckrideEmail('private');
          if (pplEmail) {
            S.emails.push(pplEmail);
          }
          return;
        }
        
        // Step 3: After PPL earned, mark tutorial complete
        if (hasPPL && !S.tutorialComplete) {
          S.tutorialComplete = true;
          saveState();
        }
      } catch (err) {
        console.error('Error in ensureTutorialEmails:', err);
        // Don't let tutorial errors block the game
        S.tutorialComplete = true;
      }
    }
    
    // === TRAINING FLIGHT SYSTEM ===
    
    function openTrainingModal() {
      const hasScheduledTraining = S.scheduledFlights.some(f => f.isTutorial);
      if (hasScheduledTraining) {
        alert('You have a training flight scheduled. Complete it first, then schedule another.');
        switchTab('calendar');
        return;
      }
      
      const modal = document.getElementById('trainingModal');
      const content = document.getElementById('trainingContent');
      
      const currentHours = S.totalHoursFlown.toFixed(1);
      const hasPPL = S.pilot.certificates.includes('private');
      const hasCommercial = S.pilot.certificates.includes('commercial');
      
      // Dynamic status based on certification
      let statusRight;
      if (!hasPPL) {
        const hoursNeeded = Math.max(0, CERT_REQUIREMENTS.private.hoursTotal - S.totalHoursFlown).toFixed(1);
        statusRight = `Hours to PPL: <strong style="color: var(--warning);">${hoursNeeded}</strong>`;
      } else if (!hasCommercial) {
        const hoursNeeded = Math.max(0, CERT_REQUIREMENTS.commercial.hoursTotal - S.totalHoursFlown).toFixed(1);
        statusRight = `Hours to Commercial: <strong style="color: var(--warning);">${hoursNeeded}</strong>`;
      } else {
        const hoursNeeded = Math.max(0, CERT_REQUIREMENTS.atp.hoursTotal - S.totalHoursFlown).toFixed(1);
        statusRight = `Hours to ATP: <strong style="color: var(--warning);">${hoursNeeded}</strong>`;
      }
      
      // Build aircraft selector if multiple aircraft (exclude grounded)
      let aircraftOptions = '';
      const flyable = getFlyableAircraft();
      flyable.forEach(code => {
        const ac = AIRCRAFT[code];
        if (ac) {
          aircraftOptions += `<option value="${code}">${ac.name}</option>`;
        }
      });
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h2 style="margin: 0; font-size: 16px;">${hasPPL ? 'Schedule Proficiency Flight' : 'Schedule Training Flight'}</h2>
          <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 12px;">
          <div style="display: flex; justify-content: space-between;">
            <span>Hours logged: <strong>${currentHours}</strong></span>
            <span>${statusRight}</span>
          </div>
          <div style="margin-top: 6px; font-size: 10px; color: var(--muted);">
            Home: ${S.bases.primary} | AIRPORTS loaded: ${Object.keys(AIRPORTS).length}
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
          <button onclick="showCustomTraining()" class="btn" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
            <span style="font-size: 20px;">ðŸ“</span>
            <span style="font-weight: 600;">Custom Route</span>
            <span style="font-size: 11px; color: var(--muted);">Plan your own flight</span>
          </button>
          <button onclick="showGenerateTraining()" class="btn" style="padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
            <span style="font-size: 20px;">ðŸŽ²</span>
            <span style="font-weight: 600;">Auto-Generate</span>
            <span style="font-size: 11px; color: var(--muted);">Build a route for me</span>
          </button>
        </div>
      `;
      
      modal.style.display = 'flex';
    }
    window.openTrainingModal = openTrainingModal;
    window.scheduleTrainingFlight = openTrainingModal; // Alias for calendar button
    
    function closeTrainingModal() {
      document.getElementById('trainingModal').style.display = 'none';
    }
    window.closeTrainingModal = closeTrainingModal;
    
    function showCustomTraining() {
      const content = document.getElementById('trainingContent');
      const homeIcao = S.bases.primary;
      const hasPPL = S.pilot.certificates.includes('private');
      
      // Build aircraft selector
      // Before PPL: Use flight school aircraft (C172 Skyhawk)
      // After PPL: Use player's fleet for proficiency flights
      let aircraftOptions = '';
      if (!hasPPL) {
        // Pre-PPL: Flight school provides aircraft
        aircraftOptions = '<option value="C172_SKYHAWK">Cessna 172 Skyhawk (140 kts) â€” Flight School</option>';
      } else {
        // Post-PPL with fleet: Use owned aircraft (not grounded)
        const flyable = getFlyableAircraft();
        if (flyable.length > 0) {
          flyable.forEach(code => {
            const ac = AIRCRAFT[code];
            if (ac) {
              aircraftOptions += `<option value="${code}">${ac.name} (${ac.cruise_speed || 120} kts)</option>`;
            }
          });
        } else if (S.fleet.length > 0) {
          // Has aircraft but all grounded
          content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
                <h2 style="margin: 0; font-size: 16px;">Custom Proficiency Flight</h2>
              </div>
              <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 16px; text-align: center;">
              <div style="font-size: 14px; margin-bottom: 8px;">All Aircraft Grounded</div>
              <div style="font-size: 12px; color: var(--muted);">All your aircraft are currently in maintenance or grounded. Check Fleet â†’ Maintenance.</div>
            </div>
          `;
          return;
        } else {
          // Post-PPL but no fleet: Can't do proficiency flights
          content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
                <h2 style="margin: 0; font-size: 16px;">Custom Proficiency Flight</h2>
              </div>
              <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 16px; text-align: center;">
              <div style="font-size: 14px; margin-bottom: 8px;">No Aircraft Available</div>
              <div style="font-size: 12px; color: var(--muted);">You need to own or lease an aircraft to schedule proficiency flights.</div>
            </div>
          `;
          return;
        }
      }
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
            <h2 style="margin: 0; font-size: 16px;">Custom Training Flight</h2>
          </div>
          <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Aircraft</label>
          <select id="customAircraft" onchange="calculateCustomRoute(); updateIfrAvailability('custom')" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px;">
            ${aircraftOptions}
          </select>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Flight Plan (space-separated ICAO codes)</label>
          <input type="text" id="customRoute" placeholder="${homeIcao} KABC KDEF ${homeIcao}" 
                 value="${homeIcao} " 
                 oninput="calculateCustomRoute()"
                 style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-family: monospace;">
          <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">Enter airport codes. Route should start and end at ${homeIcao}.</div>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Training Conditions</label>
          <div style="display: flex; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
              <input type="checkbox" id="customNight" style="cursor: pointer;">
              <span>ðŸŒ™ Night Flight</span>
            </label>
            <label id="customIfrLabel" style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
              <input type="checkbox" id="customIfr" style="cursor: pointer;">
              <span>â˜ï¸ IFR Conditions</span>
            </label>
          </div>
          <div id="customIfrNote" style="font-size: 10px; color: var(--muted); margin-top: 4px; display: none;">IFR requires GPS or IFR-equipped aircraft</div>
        </div>
        
        <div id="customEstimates" style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">FLIGHT ESTIMATES</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px;">
            <div>Distance: <strong id="customDistance">--</strong> nm</div>
            <div>Est. Time: <strong id="customTime">--</strong> hrs</div>
            <div>Fuel Required: <strong id="customFuel">--</strong> gal</div>
            <div>Status: <span id="customStatus" style="color: var(--muted);">Enter route...</span></div>
          </div>
        </div>
        
        <div id="customRoutePreview" style="display: none; background: rgba(63, 185, 80, 0.1); border: 1px solid var(--success); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="font-size: 11px; color: var(--success); margin-bottom: 4px;">âœ“ ROUTE VALIDATED</div>
          <div id="customRouteText" style="font-family: monospace; font-size: 12px;"></div>
        </div>
        
        <button id="customScheduleBtn" onclick="scheduleCustomTraining()" class="btn" disabled 
                style="width: 100%; background: var(--success); color: var(--bg); border-color: var(--success); padding: 10px;">
          Schedule Training Flight
        </button>
      `;
      
      calculateCustomRoute();
      updateIfrAvailability('custom');
    }
    window.showCustomTraining = showCustomTraining;
    
    function calculateCustomRoute() {
      const routeInput = document.getElementById('customRoute').value.trim().toUpperCase();
      const aircraftCode = document.getElementById('customAircraft').value;
      const aircraft = getAircraft(aircraftCode);
      const cruiseSpeed = aircraft?.cruise_speed || 120;
      const fuelBurn = aircraft?.fuel_burn_rate || 10;
      
      const icaos = routeInput.split(/\s+/).filter(s => s.length >= 3 && s.length <= 4);
      
      if (icaos.length < 2) {
        document.getElementById('customDistance').textContent = '--';
        document.getElementById('customTime').textContent = '--';
        document.getElementById('customFuel').textContent = '--';
        document.getElementById('customStatus').innerHTML = '<span style="color: var(--muted);">Need at least 2 airports</span>';
        document.getElementById('customRoutePreview').style.display = 'none';
        document.getElementById('customScheduleBtn').disabled = true;
        return;
      }
      
      // Calculate distances and check airport suitability
      let totalDist = 0;
      let validRoute = true;
      let routeDetails = [];
      let warnings = [];
      
      for (let i = 0; i < icaos.length - 1; i++) {
        const from = getAirport(icaos[i]);
        const to = getAirport(icaos[i + 1]);
        
        if (!from || !to || !from.latitude || !from.longitude || !to.latitude || !to.longitude) {
          validRoute = false;
          break;
        }
        
        const legDist = Math.round(calculateDistance(from.latitude, from.longitude, to.latitude, to.longitude));
        totalDist += legDist;
        routeDetails.push(`${icaos[i]} â†’ ${icaos[i + 1]} (${legDist} nm)`);
      }
      
      // Check each airport for warnings
      if (validRoute) {
        icaos.forEach(icao => {
          const apt = getAirport(icao);
          if (apt) {
            if (apt.type === 'heliport') {
              warnings.push(`${icao} is a heliport`);
            } else if (apt.type === 'closed') {
              warnings.push(`${icao} is closed`);
            } else {
              const runway = apt.runways && apt.runways[0];
              if (runway) {
                const surface = normalizeSurface(runway.surface);
                const length = runway.length || runway.lengthFt || 0;
                if (surface !== 'paved') {
                  warnings.push(`${icao} has unpaved surface`);
                }
                if (length < 2500 && length > 0) {
                  warnings.push(`${icao} has short runway (${length}ft)`);
                }
              }
            }
          }
        });
      }
      
      if (!validRoute) {
        const invalidCodes = icaos.filter(c => !AIRPORTS[c]);
        document.getElementById('customDistance').textContent = '--';
        document.getElementById('customTime').textContent = '--';
        document.getElementById('customFuel').textContent = '--';
        document.getElementById('customStatus').innerHTML = `<span style="color: var(--danger);">Unknown: ${invalidCodes.join(', ')}</span>`;
        document.getElementById('customRoutePreview').style.display = 'none';
        document.getElementById('customScheduleBtn').disabled = true;
        return;
      }
      
      const estTime = (totalDist / cruiseSpeed).toFixed(1);
      const estFuel = Math.ceil(estTime * fuelBurn * 1.2); // 20% reserve
      
      document.getElementById('customDistance').textContent = totalDist;
      document.getElementById('customTime').textContent = estTime;
      document.getElementById('customFuel').textContent = estFuel;
      
      let statusHtml = '<span style="color: var(--success);">âœ“ Valid route</span>';
      if (warnings.length > 0) {
        statusHtml += `<br><span style="color: var(--warning); font-size: 11px;">âš  ${warnings.join(', ')}</span>`;
      }
      document.getElementById('customStatus').innerHTML = statusHtml;
      
      document.getElementById('customRoutePreview').style.display = 'block';
      document.getElementById('customRouteText').innerHTML = routeDetails.join('<br>');
      document.getElementById('customScheduleBtn').disabled = false;
      
      // Store for scheduling
      window._customTrainingRoute = {
        icaos: icaos,
        distance: totalDist,
        time: parseFloat(estTime),
        fuel: estFuel,
        aircraft: aircraftCode
      };
    }
    window.calculateCustomRoute = calculateCustomRoute;
    
    function showGenerateTraining() {
      const content = document.getElementById('trainingContent');
      const hasPPL = S.pilot.certificates.includes('private');
      
      // Build aircraft selector
      // Before PPL: Use flight school aircraft (C172 Skyhawk)
      // After PPL: Use player's fleet for proficiency flights
      let aircraftOptions = '';
      if (!hasPPL) {
        // Pre-PPL: Flight school provides aircraft
        aircraftOptions = '<option value="C172_SKYHAWK">Cessna 172 Skyhawk â€” Flight School</option>';
      } else {
        // Post-PPL with fleet: Use owned aircraft (not grounded)
        const flyable = getFlyableAircraft();
        if (flyable.length > 0) {
          flyable.forEach(code => {
            const ac = AIRCRAFT[code];
            if (ac) {
              aircraftOptions += `<option value="${code}">${ac.name}</option>`;
            }
          });
        } else if (S.fleet.length > 0) {
          // Has aircraft but all grounded
          content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
                <h2 style="margin: 0; font-size: 16px;">Auto-Generate Proficiency Flight</h2>
              </div>
              <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 16px; text-align: center;">
              <div style="font-size: 14px; margin-bottom: 8px;">All Aircraft Grounded</div>
              <div style="font-size: 12px; color: var(--muted);">All your aircraft are currently in maintenance or grounded. Check Fleet â†’ Maintenance.</div>
            </div>
          `;
          return;
        } else {
          // Post-PPL but no fleet: Can't do proficiency flights
          content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
                <h2 style="margin: 0; font-size: 16px;">Auto-Generate Proficiency Flight</h2>
              </div>
              <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 16px; text-align: center;">
              <div style="font-size: 14px; margin-bottom: 8px;">No Aircraft Available</div>
              <div style="font-size: 12px; color: var(--muted);">You need to own or lease an aircraft to schedule proficiency flights.</div>
            </div>
          `;
          return;
        }
      }
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <button onclick="openTrainingModal()" style="background: none; border: none; color: var(--muted); cursor: pointer;">â†</button>
            <h2 style="margin: 0; font-size: 16px;">Auto-Generate Training Flight</h2>
          </div>
          <button onclick="closeTrainingModal()" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Aircraft</label>
          <select id="genAircraft" onchange="generateTrainingPreview(); updateIfrAvailability('gen')" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px;">
            ${aircraftOptions}
          </select>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">How long do you want to fly?</label>
          <select id="genDuration" onchange="generateTrainingPreview()" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px;">
            <option value="1.0">1.0 hours</option>
            <option value="1.5">1.5 hours</option>
            <option value="2.0" selected>2.0 hours</option>
            <option value="2.5">2.5 hours</option>
            <option value="3.0">3.0 hours</option>
          </select>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Training Conditions</label>
          <div style="display: flex; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
              <input type="checkbox" id="genNight" style="cursor: pointer;">
              <span>ðŸŒ™ Night Flight</span>
            </label>
            <label id="genIfrLabel" style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
              <input type="checkbox" id="genIfr" style="cursor: pointer;">
              <span>â˜ï¸ IFR Conditions</span>
            </label>
          </div>
          <div id="genIfrNote" style="font-size: 10px; color: var(--muted); margin-top: 4px; display: none;">IFR requires GPS or IFR-equipped aircraft</div>
        </div>
        
        <div id="genPreview" style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">GENERATING ROUTE...</div>
        </div>
        
        <button onclick="generateTrainingPreview()" class="btn" style="width: 100%; margin-bottom: 8px;">
          ðŸ”„ Generate New Route
        </button>
        
        <button id="genScheduleBtn" onclick="scheduleGeneratedTraining()" class="btn" 
                style="width: 100%; background: var(--success); color: var(--bg); border-color: var(--success); padding: 10px;">
          Schedule This Flight
        </button>
      `;
      
      generateTrainingPreview();
      updateIfrAvailability('gen');
    }
    window.showGenerateTraining = showGenerateTraining;
    
    function generateTrainingPreview() {
      const aircraftCode = document.getElementById('genAircraft').value;
      const duration = parseFloat(document.getElementById('genDuration').value);
      const aircraft = getAircraft(aircraftCode);
      const cruiseSpeed = aircraft?.cruise_speed || 120;
      const fuelBurn = aircraft?.fuel_burn_rate || 10;
      
      debugLog('S.bases.primary:', S.bases.primary);
      debugLog('Total airports in database:', Object.keys(AIRPORTS).length);
      
      const homeAirport = getAirport(S.bases.primary);
      debugLog('Home airport (normalized):', homeAirport);
      
      if (!homeAirport || !homeAirport.latitude || !homeAirport.longitude) {
        // Show what keys the airport object actually has
        const rawApt = AIRPORTS[S.bases.primary];
        const keys = rawApt ? Object.keys(rawApt).join(', ') : 'null';
        document.getElementById('genPreview').innerHTML = `<div style="color: var(--danger);">Error: Home airport (${S.bases.primary}) missing coordinates.<br>Available keys: ${keys}</div>`;
        document.getElementById('genScheduleBtn').disabled = true;
        return;
      }
      
      // Target distance based on duration
      const targetDist = Math.round(cruiseSpeed * duration);
      
      // Find ALL nearby airports with distances using normalized coordinates
      // Filter: paved surface only, no heliports, min 2500ft runway
      const allNearbyAirports = Object.keys(AIRPORTS).map(icao => getAirport(icao)).filter(apt => {
        if (!apt || apt.icao === S.bases.primary) return false;
        if (!apt.latitude || !apt.longitude) return false;
        // No heliports or closed airports
        if (apt.type === 'heliport' || apt.type === 'closed') return false;
        // Check runway requirements
        const runway = apt.runways && apt.runways[0];
        if (!runway) return false;
        const runwayLength = runway.length || runway.lengthFt || 0;
        if (runwayLength < 2500) return false;
        // Must be paved
        const surface = normalizeSurface(runway.surface);
        if (surface !== 'paved') return false;
        // Distance check
        const dist = calculateDistance(homeAirport.latitude, homeAirport.longitude, apt.latitude, apt.longitude);
        return dist >= 10 && dist <= 200; // Wider range
      }).map(apt => ({
        ...apt,
        dist: Math.round(calculateDistance(homeAirport.latitude, homeAirport.longitude, apt.latitude, apt.longitude))
      })).sort((a, b) => a.dist - b.dist); // Sort by distance
      
      debugLog('Found ' + allNearbyAirports.length + ' nearby airports');
      if (allNearbyAirports.length > 0) {
        debugLog('First 5 nearby airports:', allNearbyAirports.slice(0, 5).map(a => a.icao + ' (' + a.dist + 'nm)'));
      }
      
      if (allNearbyAirports.length === 0) {
        document.getElementById('genPreview').innerHTML = '<div style="color: var(--danger);">No nearby airports found. Try Custom route instead.</div>';
        document.getElementById('genScheduleBtn').disabled = true;
        return;
      }
      
      // Shuffle a copy for variety while keeping sorted original for fallback
      const shuffledAirports = [...allNearbyAirports].sort(() => Math.random() - 0.5);
      
      // Build route with 1-3 stops
      const numStops = duration <= 1.5 ? 1 : (duration <= 2.5 ? 2 : 3);
      const targetLegDist = targetDist / (numStops + 1);
      
      let route = [S.bases.primary];
      let usedIcaos = new Set([S.bases.primary]);
      let totalDist = 0;
      let lastApt = homeAirport;
      
      for (let i = 0; i < numStops; i++) {
        // Try to find airport at appropriate distance
        let candidates = shuffledAirports.filter(apt => {
          if (usedIcaos.has(apt.icao)) return false;
          const distFromLast = calculateDistance(lastApt.latitude, lastApt.longitude, apt.latitude, apt.longitude);
          return distFromLast >= targetLegDist * 0.3 && distFromLast <= targetLegDist * 2.0;
        });
        
        // Fallback: just take any unused airport
        if (candidates.length === 0) {
          candidates = allNearbyAirports.filter(apt => !usedIcaos.has(apt.icao));
        }
        
        if (candidates.length > 0) {
          // Pick from first few candidates for some randomness
          const pickFrom = candidates.slice(0, Math.min(5, candidates.length));
          const chosen = pickFrom[Math.floor(Math.random() * pickFrom.length)];
          const legDist = Math.round(calculateDistance(lastApt.latitude, lastApt.longitude, chosen.latitude, chosen.longitude));
          route.push(chosen.icao);
          usedIcaos.add(chosen.icao);
          totalDist += legDist;
          lastApt = chosen;
        }
      }
      
      // Ensure we have at least one destination
      if (route.length === 1 && allNearbyAirports.length > 0) {
        const fallback = allNearbyAirports[0];
        route.push(fallback.icao);
        totalDist += fallback.dist;
        lastApt = fallback;
      }
      
      // Add return leg
      if (route.length > 1 && lastApt.icao !== S.bases.primary) {
        const returnDist = Math.round(calculateDistance(lastApt.latitude, lastApt.longitude, homeAirport.latitude, homeAirport.longitude));
        totalDist += returnDist;
      }
      route.push(S.bases.primary);
      
      // If route is still too short, add a practice waypoint
      window._genWaypoint = null;
      if (totalDist < targetDist * 0.6) {
        const bearing = Math.random() * 360;
        const wpDist = Math.min(targetLegDist, 50);
        const wpLat = homeAirport.latitude + (wpDist / 60) * Math.cos(bearing * Math.PI / 180);
        const wpLon = homeAirport.longitude + (wpDist / 60) * Math.sin(bearing * Math.PI / 180) / Math.cos(homeAirport.latitude * Math.PI / 180);
        
        window._genWaypoint = {
          lat: wpLat.toFixed(4),
          lon: wpLon.toFixed(4),
          dist: Math.round(wpDist)
        };
        
        totalDist += Math.round(wpDist * 2);
      }
      
      // Ensure reasonable distance for duration
      if (totalDist < targetDist * 0.5) {
        totalDist = Math.round(targetDist * 0.8);
      }
      
      const estTime = (totalDist / cruiseSpeed).toFixed(1);
      const estFuel = Math.ceil(parseFloat(estTime) * fuelBurn * 1.2);
      
      // Build briefing
      const stopNames = route.slice(1, -1).map(icao => {
        const apt = AIRPORTS[icao];
        return apt ? `${apt.name} (${icao})` : icao;
      });
      
      let briefing = `Training flight from ${homeAirport.name}. `;
      if (stopNames.length > 0) {
        briefing += `Full stop or touch-and-go at ${stopNames.join(', ')}. `;
      }
      if (window._genWaypoint) {
        briefing += `Practice maneuvers at waypoint (${window._genWaypoint.lat}Â°N, ${Math.abs(parseFloat(window._genWaypoint.lon)).toFixed(4)}Â°W). `;
      }
      briefing += `Return to ${homeAirport.name} for final landing.`;
      
      // Store for scheduling
      window._generatedTraining = {
        route: route,
        distance: totalDist,
        time: parseFloat(estTime),
        fuel: estFuel,
        aircraft: aircraftCode,
        briefing: briefing,
        waypoint: window._genWaypoint
      };
      
      // Build route display
      let routeDisplay = route.join(' â†’ ');
      if (window._genWaypoint) {
        routeDisplay += `<br><span style="font-size: 11px; color: var(--muted);">+ Practice area: ${window._genWaypoint.lat}Â°N, ${Math.abs(parseFloat(window._genWaypoint.lon)).toFixed(4)}Â°W</span>`;
      }
      
      document.getElementById('genPreview').innerHTML = `
        <div style="font-size: 11px; color: var(--success); margin-bottom: 6px;">âœ“ ROUTE GENERATED</div>
        <div style="font-family: monospace; font-size: 12px; color: var(--accent); margin-bottom: 8px;">${routeDisplay}</div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">${briefing}</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; font-size: 11px;">
          <div>Distance: <strong>${totalDist} nm</strong></div>
          <div>Est. Time: <strong>${estTime} hrs</strong></div>
          <div>Fuel: <strong>${estFuel} gal</strong></div>
        </div>
      `;
      document.getElementById('genScheduleBtn').disabled = false;
    }
    window.generateTrainingPreview = generateTrainingPreview;
    
    // Check if aircraft has IFR-capable avionics
    function updateIfrAvailability(prefix) {
      const aircraftSelect = document.getElementById(prefix + 'Aircraft');
      const ifrCheckbox = document.getElementById(prefix + 'Ifr');
      const ifrLabel = document.getElementById(prefix + 'IfrLabel');
      const ifrNote = document.getElementById(prefix + 'IfrNote');
      
      if (!aircraftSelect || !ifrCheckbox) return;
      
      const aircraftCode = aircraftSelect.value;
      const aircraft = getAircraft(aircraftCode);
      const avionics = aircraft?.avionics || 'VFR';
      
      // GPS or IFR avionics can do IFR training
      const canDoIfr = avionics === 'GPS' || avionics === 'IFR';
      
      ifrCheckbox.disabled = !canDoIfr;
      if (ifrLabel) {
        ifrLabel.style.opacity = canDoIfr ? '1' : '0.5';
        ifrLabel.style.cursor = canDoIfr ? 'pointer' : 'not-allowed';
      }
      if (ifrNote) {
        ifrNote.style.display = canDoIfr ? 'none' : 'block';
      }
      if (!canDoIfr) {
        ifrCheckbox.checked = false;
      }
    }
    window.updateIfrAvailability = updateIfrAvailability;
    
    function scheduleCustomTraining() {
      const data = window._customTrainingRoute;
      if (!data) return;
      
      const isNight = document.getElementById('customNight')?.checked || false;
      const isIfr = document.getElementById('customIfr')?.checked || false;
      
      scheduleTrainingFromData(data.icaos, data.distance, data.time, data.fuel, data.aircraft, 
        `Custom training flight. Navigate the planned route, practicing pattern work at each stop.`, null, isNight, isIfr);
    }
    window.scheduleCustomTraining = scheduleCustomTraining;
    
    function scheduleGeneratedTraining() {
      const data = window._generatedTraining;
      if (!data) return;
      
      const isNight = document.getElementById('genNight')?.checked || false;
      const isIfr = document.getElementById('genIfr')?.checked || false;
      
      scheduleTrainingFromData(data.route, data.distance, data.time, data.fuel, data.aircraft, data.briefing, data.waypoint, isNight, isIfr);
    }
    window.scheduleGeneratedTraining = scheduleGeneratedTraining;
    
    function scheduleTrainingFromData(route, distance, time, fuel, aircraftCode, briefing, waypoint = null, isNight = false, isIfr = false) {
      const aircraft = getAircraft(aircraftCode);
      const homeAirport = getAirport(S.bases.primary);
      
      debugLog('scheduleTrainingFromData called with:', { route, distance, time, fuel, aircraftCode });
      debugLog('homeAirport', homeAirport);
      
      // Schedule for 2 hours from now
      const flightTime = addMinutes(S.gameTime, 120);
      flightTime.minute = 0;
      
      // Adjust time for night flights
      if (isNight && flightTime.hour < 20 && flightTime.hour >= 5) {
        flightTime.hour = 20; // Set to 8 PM for night training
      }
      
      // Check for schedule conflicts
      const cruiseSpeed = aircraft?.cruise_speed || 120;
      const conflict = checkScheduleConflict(flightTime, distance, cruiseSpeed);
      if (conflict) {
        if (!confirm(`âš ï¸ Schedule Conflict Detected\n\nThis flight overlaps with: ${conflict.missionType}\nScheduled: ${formatGameTime(conflict.startTime)}\n\nSchedule anyway?`)) {
          return;
        }
      }
      
      debugLog('flightTime', flightTime);
      
      // Determine weather based on IFR selection
      let weather = 'Clear Skies';
      if (isIfr) {
        const ifrWeatherOptions = ['Overcast', 'Broken Clouds', 'Light Rain'];
        weather = ifrWeatherOptions[Math.floor(Math.random() * ifrWeatherOptions.length)];
      }
      
      // Build flight plan string
      let flightPlan = Array.isArray(route) ? route.join(' â†’ ') : route;
      if (waypoint) {
        flightPlan += ` (via ${waypoint.lat}Â°N ${Math.abs(parseFloat(waypoint.lon)).toFixed(4)}Â°W)`;
      }
      
      // Add conditions to briefing
      let conditionsBriefing = briefing;
      if (isNight || isIfr) {
        const conditions = [];
        if (isNight) conditions.push('Night');
        if (isIfr) conditions.push('IFR');
        conditionsBriefing += ` [${conditions.join('/')} Training]`;
      }
      
      const flightId = uuid();
      
      // Must match structure expected by calendar/preflight
      const scheduledFlight = {
        contractId: flightId,
        isTutorial: true,
        trainingConditions: { isNight, isIfr }, // Track for hour logging
        contract: {
          id: flightId,
          aircraftCode: aircraftCode,
          aircraftName: aircraft?.name || 'Aircraft',
          contractType: 'tutorial',
          missionType: 'Training Flight',
          missionStructure: 'round_trip',
          from: S.bases.primary,
          fromName: homeAirport?.name || S.bases.primary,
          to: Array.isArray(route) ? route[route.length - 1] : S.bases.primary,
          toName: homeAirport?.name || S.bases.primary,
          distance: distance,
          revenueDistance: distance,
          flightPlan: flightPlan,
          briefing: conditionsBriefing,
          payment: 0,
          startTime: flightTime,
          scheduleBy: addMinutes(flightTime, -30),
          weather: weather,
          isNight: isNight,
          passengers: 0,
          cargoLbs: 0,
          blockTime: time,
          fuelRequired: fuel,
          waypoint: waypoint,
          acceptedAt: { ...S.gameTime }
        }
      };
      
      debugLog('scheduledFlight', scheduledFlight);
      debugLog('S.scheduledFlights before push:', S.scheduledFlights.length);
      
      S.scheduledFlights.push(scheduledFlight);
      
      debugLog('S.scheduledFlights after push:', S.scheduledFlights.length);
      
      saveState();
      closeTrainingModal();
      render();
      switchTab('calendar');
      
      // Show confirmation
      const conditionsText = (isNight || isIfr) ? `\nConditions: ${[isNight ? 'Night' : '', isIfr ? 'IFR' : ''].filter(Boolean).join(', ')}` : '';
      setTimeout(() => {
        alert(`Training flight scheduled!\n\nRoute: ${flightPlan}\nDistance: ${distance} nm\nEst. Time: ${time} hrs${conditionsText}\n\nAdvance time to ${String(flightTime.hour).padStart(2, '0')}:00 to begin.`);
      }, 100);
    }
    
    function generateTutorialWelcomeEmail() {
      const pilotName = S.pilot.name || 'Pilot';
      const homeAirport = getAirport(S.bases.primary);
      const homeName = homeAirport?.name || S.bases.primary;
      const currentHours = S.totalHoursFlown.toFixed(1);
      const hoursNeeded = Math.max(0, CERT_REQUIREMENTS.private.hoursTotal - S.totalHoursFlown).toFixed(1);
      
      // Dynamic status message based on starting hours
      let statusMessage;
      if (S.totalHoursFlown < 1) {
        statusMessage = `You're starting fresh with your flight training. Complete ${CERT_REQUIREMENTS.private.hoursTotal} hours of flight time to qualify for your Private Pilot checkride.`;
      } else if (S.totalHoursFlown < 30) {
        statusMessage = `You have ${currentHours} hours logged and are making progress through your training. ${hoursNeeded} more hours until your checkride.`;
      } else {
        statusMessage = `You're almost there with ${currentHours} hours logged! Just ${hoursNeeded} more hours until you qualify for your PPL checkride.`;
      }
      
      return {
        id: uuid(),
        type: 'tutorial-welcome',
        isTutorial: true,
        subject: `Welcome to Skylift, ${pilotName}!`,
        from: 'Skylift Operations',
        company: 'Skylift Aviation',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        status: 'read',
        statusMessage: statusMessage,
        currentHours: currentHours,
        hoursNeeded: hoursNeeded,
        homeName: homeName
      };
    }
    window.generateTutorialWelcomeEmail = generateTutorialWelcomeEmail;
    
    function generateBusinessWelcomeEmail() {
      const pilotName = S.pilot.name || 'Pilot';
      const homeAirport = getAirport(S.bases.primary);
      const homeName = homeAirport?.name || S.bases.primary;
      const homeCity = homeAirport?.city || '';
      const homeState = homeAirport?.state || '';
      
      // Get fleet info
      const fleetAircraft = S.fleet.map(code => getAircraft(code)?.name || code).join(', ') || 'Cessna 172 Skyhawk';
      
      // Generate suggested company name
      const suggestedName = generateCompanyName();
      
      return {
        id: uuid(),
        type: 'business-welcome',
        subject: `Congratulations, Captain â€” Time to Build Your Business`,
        from: 'Skylift Operations',
        company: 'Skylift Aviation',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        // Data for rendering
        pilotName: pilotName,
        suggestedName: suggestedName,
        homeBase: S.bases.primary,
        homeName: homeName,
        homeCity: homeCity,
        homeState: homeState,
        fleet: fleetAircraft,
        startingCash: S.cash
      };
    }
    window.generateBusinessWelcomeEmail = generateBusinessWelcomeEmail;
    
    function generateReputationIntroEmail() {
      const companyName = S.companyName || 'your company';
      
      return {
        id: uuid(),
        type: 'notification',
        from: 'Skylift Operations',
        company: 'Business Advisory',
        subject: 'Building Your Reputation',
        body: `Welcome to commercial aviation!\n\n` +
              `As you begin flying for clients, your reputation will become one of your most valuable assets. Here's what you should know:\n\n` +
              `CUSTOMER REVIEWS\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `Clients may leave reviews after flights based on your timing, their comfort during the flight (reflected in your self-assessment), and whether any damage occurred. These reviews affect your public rating, which you can view in the Company tab.\n\n` +
              `BUILDING EXPERIENCE\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `Every flight you complete builds your professional experience. As you gain experience, you'll unlock access to more specialized missions â€” executive transport, medical flights, and other high-value contracts that clients only trust to seasoned pilots.\n\n` +
              `Contract pilot jobs (flying someone else's aircraft) build your reputation faster than flights in your own plane â€” clients notice when other operators trust you with their equipment.\n\n` +
              `BETTER PAY WITH EXPERIENCE\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `New pilots typically earn less than market rate as they prove themselves. As your experience grows, you'll command premium rates â€” experienced pilots can earn significantly more than beginners for the same work.\n\n` +
              `Focus on safe, on-time service and your reputation will grow naturally.\n\n` +
              `Blue skies,\n` +
              `Skylift Operations`,
        receivedAt: addMinutes(S.gameTime, 60), // 1 hour after business welcome
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year
      };
    }
    window.generateReputationIntroEmail = generateReputationIntroEmail;
    
    function generateCommercialWelcomeEmail() {
      const homeAirport = getAirport(S.bases.primary);
      const homeName = homeAirport?.name || S.bases.primary;
      const companyName = S.companyName || 'Your Company';
      const fleetCount = S.fleet.length;
      const hoursToAtp = Math.max(0, CERT_REQUIREMENTS.atp.hoursTotal - S.totalHoursFlown).toFixed(1);
      
      // Build reputation display
      let repDisplay = 'No reviews yet';
      if (S.reputation && S.reputation.totalReviews > 0) {
        repDisplay = `${'â˜…'.repeat(Math.floor(S.reputation.stars))}${'â˜†'.repeat(5 - Math.floor(S.reputation.stars))} (${S.reputation.totalReviews} reviews)`;
      }
      
      return {
        id: uuid(),
        type: 'commercial-welcome',
        subject: `Full Commercial Operations Now Authorized`,
        from: 'Skylift Operations',
        company: 'Skylift Aviation',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        // Data for rendering
        companyName: companyName,
        homeBase: S.bases.primary,
        homeName: homeName,
        fleetCount: fleetCount,
        totalHours: S.totalHoursFlown.toFixed(1),
        hoursToAtp: hoursToAtp,
        reputation: repDisplay
      };
    }
    window.generateCommercialWelcomeEmail = generateCommercialWelcomeEmail;
    
    function generateFinanceIntroEmail() {
      const loc = S.lineOfCredit || { limit: 25000, apr: 0.12 };
      const tierTerms = getLenderTierTerms();
      
      return {
        id: uuid(),
        type: 'notification',
        from: 'First Sky Bank',
        company: 'Business Lending',
        subject: 'Your Line of Credit is Ready',
        body: `Congratulations on starting your aviation business!\n\n` +
              `We're pleased to offer you a revolving line of credit to help manage cash flow and seize opportunities.\n\n` +
              `YOUR CREDIT LINE\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `Available Credit: ${formatCurrency(loc.limit)}\n` +
              `Interest Rate: ${(loc.apr * 100).toFixed(1)}% APR\n` +
              `Minimum Payment: 5% of balance (monthly)\n\n` +
              `HOW IT WORKS\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `â€¢ Draw funds anytime from the Ledger tab\n` +
              `â€¢ Interest accrues monthly on your balance\n` +
              `â€¢ Pay down anytime â€” no prepayment penalties\n` +
              `â€¢ Minimum payment due on the 1st of each month\n\n` +
              `SMART USES FOR YOUR LOC\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `âœ“ Cover operating expenses during slow periods\n` +
              `âœ“ Fund unexpected maintenance or repairs\n` +
              `âœ“ Bridge cash flow gaps while waiting for payment\n` +
              `âœ“ Make a down payment on aircraft financing\n\n` +
              `BUILDING BETTER TERMS\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `Your current tier: ${tierTerms.name}\n\n` +
              `As your business grows, you'll qualify for better financing terms:\n` +
              `â€¢ Lower interest rates (down to 5% APR)\n` +
              `â€¢ Smaller down payments on aircraft (down to 10%)\n` +
              `â€¢ Higher maximum financing limits\n\n` +
              `We evaluate your financial health monthly based on cash flow, leverage, and payment history.\n\n` +
              `TIP: PRICING YOUR SERVICES\n` +
              `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
              `When customers request quotes, you'll use the Quote Calculator to estimate costs and set your price. ` +
              `If you prefer simpler pricing, you can enable "Fixed Price Mode" in Pilot â†’ Preferences â†’ Finances ` +
              `to accept contracts at market rate without negotiation.\n\n` +
              `Fly safe and build smart,\n` +
              `First Sky Bank Business Lending`,
        status: 'unread',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day
      };
    }
    window.generateFinanceIntroEmail = generateFinanceIntroEmail;
    
    function saveCompanyName(emailId) {
      const input = document.getElementById('companyNameInput');
      if (!input) return;
      
      const name = input.value.trim();
      if (!name) {
        alert('Please enter a company name');
        return;
      }
      
      S.companyName = name;
      
      // Mark email as actioned (remove the input, show confirmed name)
      const email = S.emails.find(e => e.id === emailId);
      if (email) {
        email.companyNameSaved = true;
        email.savedCompanyName = name;
      }
      
      saveState();
      render();
      
      // Show the company banner
      updateCompanyBanner();
      
      // Trigger confetti celebration!
      triggerConfetti();
      
      // Show success message after a brief delay
      setTimeout(() => {
        showToast('ðŸŽ‰ Congratulations!', `The paperwork to form ${name} has been filed. Your aviation business is officially in operation.`, 'success');
      }, 500);
    }
    window.saveCompanyName = saveCompanyName;
    
    function updateCompanyBanner() {
      const banner = document.getElementById('companyBanner');
      const nameEl = document.getElementById('companyBannerName');
      if (banner && nameEl && S.companyName) {
        nameEl.textContent = S.companyName;
        banner.style.display = 'flex';
      } else if (banner) {
        banner.style.display = 'none';
      }
    }
    
    function triggerConfetti() {
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);
      
      const colors = ['#58a6ff', '#3fb950', '#d29922', '#f85149', '#a371f7', '#f778ba', '#79c0ff', '#56d364'];
      const shapes = ['square', 'circle'];
      
      // Create 150 confetti pieces
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        
        const color = colors[Math.floor(Math.random() * colors.length)];
        const shape = shapes[Math.floor(Math.random() * shapes.length)];
        const size = Math.random() * 10 + 5;
        const left = Math.random() * 100;
        const delay = Math.random() * 2;
        const duration = Math.random() * 2 + 2;
        
        confetti.style.cssText = `
          left: ${left}%;
          width: ${size}px;
          height: ${size}px;
          background: ${color};
          border-radius: ${shape === 'circle' ? '50%' : '2px'};
          animation-delay: ${delay}s;
          animation-duration: ${duration}s;
        `;
        
        container.appendChild(confetti);
      }
      
      // Remove container after animation
      setTimeout(() => {
        container.remove();
      }, 5000);
    }
    window.triggerConfetti = triggerConfetti;
    
    function generateCommercialWelcomeEmail() {
      const companyName = S.companyName || 'Your Company';
      const homeAirport = getAirport(S.bases.primary);
      const homeName = homeAirport?.name || S.bases.primary;
      const fleetCount = S.fleet.length;
      const totalHours = S.totalHoursFlown.toFixed(1);
      const hoursToAtp = Math.max(0, CERT_REQUIREMENTS.atp.hoursTotal - S.totalHoursFlown).toFixed(1);
      
      // Format reputation
      let reputationText;
      if (S.reputation.stars > 0) {
        const stars = 'â˜…'.repeat(Math.floor(S.reputation.stars)) + (S.reputation.stars % 1 >= 0.5 ? 'Â½' : '');
        reputationText = `${stars} (${S.reputation.totalReviews} reviews)`;
      } else {
        reputationText = 'No reviews yet';
      }
      
      return {
        id: uuid(),
        type: 'commercial-welcome',
        subject: 'Full Commercial Operations Now Authorized',
        from: 'Skylift Operations',
        company: 'Skylift Aviation',
        receivedAt: { ...S.gameTime },
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        // Data for rendering
        companyName: companyName,
        homeBase: S.bases.primary,
        homeName: homeName,
        fleetCount: fleetCount,
        totalHours: totalHours,
        hoursToAtp: hoursToAtp,
        reputation: reputationText
      };
    }
    window.generateCommercialWelcomeEmail = generateCommercialWelcomeEmail;
    
    function generateEmailForDay(day) {
      // Generate an email with receivedAt at a business hour, never in the future
      const receivedAt = generateRandomBusinessHourTime();
      
      // Flight starts 12-72 hours from now
      const hoursAhead = randomInt(12, 72);
      
      return generateMissionEmail(S.gameTime, hoursAhead, receivedAt, S.gameTime);
    }
    
    function generateEmail() {
      return generateMissionEmail(S.gameTime, randomInt(12, 72), generateRandomBusinessHourTime(), S.gameTime);
    }
    
    // Core mission generation function
    function generateMissionEmail(baseTime, hoursAhead, receivedAt, generatedDay) {
      const ownedRatio = S.difficultySettings?.ownedMissionRatio ?? 0.6;
      
      // Use flyable fleet for owned aircraft missions (exclude grounded)
      const flyableFleet = getFlyableAircraft();
      
      // PPL-only pilots normally can only use owned aircraft (no contract pilot work)
      // BUT if they have no fleet, they need contract work to earn money for a plane
      const hasPPL = S.pilot.certificates.includes('private');
      const hasCommercial = S.pilot.certificates.includes('commercial') || S.pilot.certificates.includes('atp');
      const pplOnly = S.gameMode === 'career' && hasPPL && !hasCommercial && flyableFleet.length > 0;
      
      // If slider is at 100% owned, never generate contract pilot jobs
      const noContractPilot = ownedRatio >= 1.0;
      
      // Force contract pilot jobs if no flyable fleet (Bootstrap scenario or sold all planes)
      const forceContract = flyableFleet.length === 0 && S.pilot.aircraftCertifications.length > 0;
      
      const useOwned = forceContract ? false : (pplOnly || noContractPilot ? true : (Math.random() < ownedRatio && flyableFleet.length > 0));
      
      // Select aircraft
      let aircraftCode;
      let isContractPilot = false;
      
      if (useOwned) {
        if (flyableFleet.length === 0) {
          return null; // No flyable aircraft = no owned missions
        }
        aircraftCode = randomItem(flyableFleet);
      } else if (S.pilot.aircraftCertifications.length > 0) {
        // For contract pilot jobs, we can fly any aircraft we're certified for
        // Even if we own one, someone else might need a pilot for theirs
        // But prefer aircraft we don't own (more realistic)
        const contractAircraft = S.pilot.aircraftCertifications.filter(code => !S.fleet.includes(code));
        
        if (contractAircraft.length > 0) {
          // We have certifications for aircraft we don't own - use those
          aircraftCode = randomItem(contractAircraft);
          isContractPilot = true;
        } else if (S.fleet.length === 0) {
          // No fleet but have certifications - contract work available
          aircraftCode = randomItem(S.pilot.aircraftCertifications);
          isContractPilot = true;
        } else {
          // All certifications are for owned aircraft - still offer contract work
          // (someone else owns a similar aircraft and needs a pilot)
          aircraftCode = randomItem(S.pilot.aircraftCertifications);
          isContractPilot = true;
        }
      } else if (S.fleet.length > 0) {
        // No certifications but have fleet - fall back to owned missions
        aircraftCode = randomItem(S.fleet);
      } else {
        return null;
      }
      
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return null;
      
      debugLog('Mission Gen - Selected Aircraft:', aircraftCode, aircraft.category);
      
      const homeAirport = getAirport(S.bases.primary);
      if (!homeAirport || !homeAirport.latitude) {
        debugLog('Mission Gen - FAILED: No home airport', { base: S.bases.primary, airport: homeAirport });
        return null;
      }
      
      // Get missions available for this aircraft category and pilot tier
      const categoryMissions = CATEGORY_MISSIONS[aircraft.category] || CATEGORY_MISSIONS.single_piston;
      debugLog('Mission Gen - Category Missions for', aircraft.category, ':', categoryMissions);
      // In sandbox mode, all mission tiers are available
      const tierMissions = S.gameMode === 'sandbox' 
        ? Object.keys(MISSION_TYPES) 
        : getMissionsForTier(S.pilot.experienceTier);
      let availableMissions = categoryMissions.filter(m => tierMissions.includes(m) && MISSION_TYPES[m]);
      
      // Student pilots can ONLY do training and discovery flights
      if (S.gameMode === 'career' && !S.pilot.certificates.includes('private')) {
        const studentMissions = getStudentMissions();
        availableMissions = availableMissions.filter(m => studentMissions.includes(m));
      }
      // PPL without Commercial: limited to expense-sharing missions on owned aircraft only
      // EXCEPTION: If they have no fleet, allow contract work so they can earn money for a plane
      else if (S.gameMode === 'career' && !hasCommercialPrivileges()) {
        const pplMissions = getPPLOnlyMissions();
        availableMissions = availableMissions.filter(m => pplMissions.includes(m));
        // PPL pilots can only fly their own aircraft, not contract work
        // BUT if they have no flyable fleet, they need contract work to bootstrap
        const flyable = getFlyableAircraft();
        if (isContractPilot && flyable.length > 0) {
          return null; // No contract pilot jobs for PPL-only WITH aircraft
        }
        // If no flyable fleet, allow contract work with PPL missions
      }
      
      // Personal service missions only available on owned aircraft
      // These involve direct customer interaction using YOUR aircraft
      // (Sightseeing Tour can be contract - charter companies do tours)
      const ownedOnlyMissions = ['Training Flight', 'Discovery Flight'];
      if (isContractPilot) {
        availableMissions = availableMissions.filter(m => !ownedOnlyMissions.includes(m));
      }
      
      // Filter by player's mission preferences
      availableMissions = availableMissions.filter(m => 
        S.missionPreferences[m] !== false
      );
      
      // Filter out passenger-only missions for cargo-only aircraft (0 passengers)
      if (aircraft.max_passengers === 0) {
        availableMissions = availableMissions.filter(m => {
          const mDef = MISSION_TYPES[m];
          return mDef && mDef.payload !== 'passengers';
        });
      }
      
      if (availableMissions.length === 0) return null;
      
      const missionType = randomItem(availableMissions);
      const missionDef = MISSION_TYPES[missionType];
      if (!missionDef) return null;
      
      // Ferry flights are ALWAYS contract pilot jobs - you're repositioning someone else's aircraft
      // Skip ferry flights entirely if user has 100% owned missions selected
      if (missionType === 'Ferry Flight') {
        const ownedRatioCheck = S.difficultySettings?.ownedMissionRatio ?? 0.6;
        if (ownedRatioCheck >= 1.0) {
          return null; // Don't generate contract pilot jobs when slider is at 100% owned
        }
        if (!isContractPilot) {
          // Need to switch to contract mode - pick an aircraft from certifications
          if (S.pilot.aircraftCertifications.length > 0) {
            const contractAircraft = S.pilot.aircraftCertifications.filter(code => !S.fleet.includes(code));
            if (contractAircraft.length > 0) {
              aircraftCode = randomItem(contractAircraft);
            } else {
              aircraftCode = randomItem(S.pilot.aircraftCertifications);
            }
            isContractPilot = true;
          } else {
            // No certifications for contract work - skip this ferry flight
            return null;
          }
        }
      }
      
      // Generate appropriate weather for this mission and aircraft
      // Use regional weather patterns based on home base and month
      const departureRegion = getAirportRegion(S.bases.primary);
      const currentMonth = S.gameTime?.month || 5;
      const latitude = homeAirport?.lat || homeAirport?.latitude || 40;
      
      // Get regional weather weighted by season and latitude
      let weather = getRegionalWeather(departureRegion, currentMonth, latitude);
      
      // Filter to VFR-only if pilot lacks instrument rating
      if (S.gameMode === 'career' && !S.pilot.ratings.includes('instrument')) {
        const ifrConditions = ['Overcast', 'Light Rain', 'Light Snow', 'Rain Showers', 'Thunderstorms', 'Heavy Snow', 'Fog'];
        if (ifrConditions.includes(weather)) {
          // Force VFR weather
          weather = randomItem(WEATHER_CATEGORIES.VFR);
        }
      }
      
      // Also respect mission type weather restrictions
      if (missionDef?.weather === 'VFR') {
        const vfrConditions = WEATHER_CATEGORIES.VFR;
        if (!vfrConditions.includes(weather)) {
          weather = randomItem(vfrConditions);
        }
      }
      
      // Generate start time respecting mission time restrictions
      // But force daytime if pilot lacks night rating
      let startTime = generateMissionStartTime(missionType, baseTime, hoursAhead);
      if (S.gameMode === 'career' && !S.pilot.ratings.includes('night')) {
        // Force daytime (7:00 - 18:00)
        if (startTime.hour >= 20 || startTime.hour < 7) {
          startTime.hour = 7 + randomInt(0, 10); // 7:00 - 17:00
        }
      }
      let scheduleBy = roundToHour(addMinutes(startTime, -60));
      
      // Ensure scheduleBy is at least 2 hours after receivedAt (so email isn't expired on arrival)
      const minScheduleBy = addMinutes(receivedAt, 2 * 60);
      if (compareGameTime(scheduleBy, minScheduleBy) < 0) {
        scheduleBy = minScheduleBy;
      }
      
      // Check if this is a night mission
      const isNight = startTime.hour >= 20 || startTime.hour < 5;
      
      // Build mission based on structure type
      // For contract pilot jobs, limit range to 200nm from home base
      const maxContractRange = isContractPilot ? 200 : null;
      let missionData;
      
      switch (missionDef.structure) {
        case 'round_trip':
          missionData = generateRoundTripMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'out_and_back':
          missionData = generateOutAndBackMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'point_to_point':
          missionData = generatePointToPointMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'waypoint':
          missionData = generateWaypointMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'ferry':
          missionData = generateFerryMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'heli_transfer':
          missionData = generateHeliTransferMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'heli_scene':
          missionData = generateHeliSceneMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        case 'heli_connect':
          missionData = generateHeliConnectMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
          break;
        default:
          missionData = generatePointToPointMission(aircraft, homeAirport, missionDef, missionType, maxContractRange);
      }
      
      if (!missionData) return null;
      
      // Enforce 1-hour minimum for all missions
      if (missionData.estimatedMinutes && missionData.estimatedMinutes < 60) {
        missionData.estimatedMinutes = 60;
        missionData.minimumBooking = true; // Flag that this was extended to minimum
      }
      
      // Generate payload
      let passengers = 0;
      let cargoLbs = 0;
      
      if (missionDef.payload === 'passengers' || missionDef.payload === 'both') {
        const maxPax = aircraft.max_passengers || 1;
        passengers = randomInt(1, Math.max(1, maxPax));
        
        // Cap passengers by mission type - some missions only need 1-2 people
        const paxLimits = {
          'Aerial Photography': 2,  // Photographer + maybe assistant
          'Aerial Survey': 2,       // Surveyor + equipment operator
          'Discovery Flight': 3     // Student + maybe family
        };
        if (paxLimits[missionType]) {
          passengers = Math.min(passengers, paxLimits[missionType]);
        }
      }
      if (missionDef.payload === 'cargo' || missionDef.payload === 'both') {
        const maxCargo = missionDef.maxCargoLbs || aircraft.max_cargo_lbs || 500;
        cargoLbs = randomInt(50, Math.max(50, maxCargo));
      }
      
      // Get client (pass aircraft category to avoid mismatches like Rotorwing for fixed-wing)
      const tierRoll = Math.random();
      const clientTier = tierRoll < 0.3 ? 'budget' : (tierRoll < 0.8 ? 'regional' : 'corporate');
      const client = getRandomClient(clientTier, aircraft.category);
      const contact = clientTier === 'budget' ? client.name : generateContactName();
      
      // Generate client personality traits
      const clientTraits = generateClientTraits();
      
      // Calculate bid info for owned aircraft
      const bidInfo = calculateSuggestedBid({
        ...missionData,
        missionType,
        passengers,
        cargoLbs,
        weather,
        isNight
      }, aircraft);
      
      // Build email object with backward compatibility fields
      const baseEmail = {
        id: uuid(),
        aircraftCode: aircraftCode,
        aircraftName: aircraft.name,
        missionType: missionType,
        missionStructure: missionDef.structure,
        weather: weather,
        passengers: passengers,
        cargoLbs: cargoLbs,
        startTime: startTime,
        scheduleBy: scheduleBy,
        isNight: isNight,
        isEmergency: missionDef.isEmergency || false,
        status: "pending",
        generatedDay: generatedDay.day,
        generatedMonth: generatedDay.month,
        generatedYear: generatedDay.year,
        receivedAt: receivedAt,
        ...missionData,
        // Backward compatibility aliases for rendering
        fromIcao: missionData.originIcao || missionData.pickupIcao || S.bases.primary,
        fromName: missionData.originName || missionData.pickupName || 'Origin',
        toIcao: missionData.destinationIcao || missionData.deliveryIcao || missionData.originIcao,
        toName: missionData.destinationName || missionData.deliveryName || missionData.originName || 'Destination'
      };
      
      if (!isContractPilot) {
        // Customer inquiry - needs bid (owned aircraft)
        return {
          ...baseEmail,
          type: "inquiry",
          from: contact,
          company: client.name,
          companyTier: client.tier,
          clientTraits: clientTraits,
          payModifier: client.payModifier || 1.0,
          subject: generateMissionSubject(missionType, missionData, missionDef),
          suggestedBid: bidInfo.suggested,
          minimumBid: bidInfo.minimum,
          bidBreakdown: bidInfo,
          playerBid: null,
          customerResponse: null,
          counterOffer: null
        };
      } else {
        // Contract pilot offer - use realistic hourly rates based on aircraft category
        const category = aircraft.category || 'single_piston';
        const rateInfo = CONTRACT_PILOT_RATES[category] || CONTRACT_PILOT_RATES.single_piston;
        
        // Calculate rate within range, modified by client pay modifier
        const baseRate = rateInfo.typical;
        const contractRate = Math.round(baseRate * (client.payModifier || 1.0));
        
        const cruiseSpeed = aircraft.cruise_speed || 120;
        const totalDist = missionData.distance || 100;
        const rawHours = totalDist / cruiseSpeed;
        
        // Minimum 1 hour for contract jobs - nobody takes a contract for less
        const estimatedHours = Math.max(1.0, rawHours);
        const payment = Math.round(contractRate * estimatedHours);
        
        // For contract subject, just use the location/destination part
        const missionSubject = generateMissionSubject(missionType, missionData, missionDef);
        
        return {
          ...baseEmail,
          type: "contract",
          from: client.name,
          company: client.name,
          companyTier: client.tier,
          clientTraits: clientTraits,
          payModifier: client.payModifier || 1.0,
          subject: `Contract Pilot - ${missionSubject}`,
          payment: payment,
          contractRate: contractRate,
          estimatedHours: estimatedHours
        };
      }
    }
    
    // Generate subject line based on mission type
    function generateMissionSubject(missionType, missionData, missionDef) {
      if (missionDef.structure === 'round_trip') {
        return `${missionType} Request - ${missionData.originName}`;
      } else if (missionDef.structure === 'waypoint') {
        // For tours, use simple city name; for destination flights, use landmark name
        if (missionData.waypoint?.landmark?.isTour) {
          return `${missionType} - ${missionData.waypoint.landmark.cityName || missionData.originName} Area`;
        } else if (missionData.waypoint?.landmark?.name) {
          return `${missionType} - ${missionData.waypoint.landmark.name}`;
        }
        return `${missionType} - ${missionData.originName}`;
      } else if (missionDef.structure === 'ferry') {
        return `Ferry Flight - ${missionData.pickupIcao} to ${missionData.deliveryIcao}`;
      } else {
        return `${missionType} - ${missionData.originName} to ${missionData.destinationName}`;
      }
    }
    
    // Calculate appropriate min/max distances based on aircraft capabilities
    // Ensures missions scale to aircraft range (no 50nm hops in a 787)
    function getDistanceRangeForAircraft(aircraft) {
      const range = aircraft.range || 500;
      const category = aircraft.category || 'single_piston';
      
      // Airliners: min 250nm, max 2500nm (US/Canada domestic cap)
      if (['airliner', 'military_cargo'].includes(category)) {
        return { min: 250, max: 2500, sweet: [500, 1500] };
      }
      
      // Light jets: min 150nm
      if (category === 'light_jet') {
        return { min: 150, max: Math.min(range * 0.5, 2000), sweet: [200, 800] };
      }
      
      // Turboprops: min 75nm  
      if (category === 'turboprop') {
        return { min: 75, max: Math.min(range * 0.5, 1200), sweet: [100, 500] };
      }
      
      // Multi-engine piston: min 40nm
      if (category === 'multi_piston') {
        return { min: 40, max: Math.min(range * 0.45, 600), sweet: [60, 300] };
      }
      
      // Helicopters: very short ranges
      if (category === 'helicopter') {
        return { min: 5, max: Math.min(range * 0.4, 100), sweet: [10, 50] };
      }
      
      // Small singles, bush, etc: min 20nm
      return { min: 20, max: Math.min(range * 0.4, 400), sweet: [30, 150] };
    }
    
    // Select a distance weighted toward the "sweet spot" for an aircraft
    function selectMissionDistance(distanceRange, availableAirports) {
      if (!availableAirports || availableAirports.length === 0) return null;
      
      const { min, max, sweet } = distanceRange;
      
      // Filter airports to those in range
      const inRange = availableAirports.filter(a => a.dist >= min && a.dist <= max);
      if (inRange.length === 0) return null;
      
      // Weight toward sweet spot: 60% chance of sweet spot, 40% anywhere in range
      if (Math.random() < 0.6) {
        const sweetSpot = inRange.filter(a => a.dist >= sweet[0] && a.dist <= sweet[1]);
        if (sweetSpot.length > 0) {
          return randomItem(sweetSpot);
        }
      }
      
      return randomItem(inRange);
    }
    
    // Round-trip mission (sightseeing, training, thrill, etc.)
    function generateRoundTripMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      // Start and end at home base
      const baseMinutes = missionDef.baseMinutes || 60;
      const nominalDistance = Math.round((baseMinutes / 60) * (aircraft.cruise_speed || 120) * 0.8);
      
      return {
        originIcao: S.bases.primary,
        originName: `${homeAirport.city}, ${homeAirport.state}`,
        destinationIcao: S.bases.primary,
        destinationName: `${homeAirport.city}, ${homeAirport.state}`,
        distance: nominalDistance,
        revenueDistance: nominalDistance,
        estimatedMinutes: baseMinutes,
        legs: [
          { type: 'activity', from: S.bases.primary, to: S.bases.primary, distance: nominalDistance }
        ]
      };
    }
    
    // Out-and-back mission (mail run, etc.)
    function generateOutAndBackMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      // Get appropriate distance range for this aircraft
      const distRange = getDistanceRangeForAircraft(aircraft);
      let maxRange = distRange.max;
      let minRange = distRange.min;
      
      // Override with mission-specific distance range if defined
      if (missionDef.distanceRange) {
        minRange = Math.max(minRange, missionDef.distanceRange[0]);
        maxRange = Math.min(maxRange, missionDef.distanceRange[1]);
      }
      
      if (maxContractRange) maxRange = Math.min(maxRange, maxContractRange);
      
      // Find airports and attach distances
      const allAirports = findSuitableAirports(aircraft, homeAirport, missionDef, minRange, maxRange);
      if (allAirports.length === 0) return null;
      
      // Add distance to each airport for weighted selection
      const airportsWithDist = allAirports.map(apt => ({
        ...apt,
        dist: calculateDistance(homeAirport.lat, homeAirport.lon, apt.lat, apt.lon)
      }));
      
      // Select using weighted distance preference
      const destination = selectMissionDistance(distRange, airportsWithDist) || randomItem(airportsWithDist);
      const distance = Math.round(destination.dist);
      
      return {
        originIcao: S.bases.primary,
        originName: `${homeAirport.city}, ${homeAirport.state}`,
        destinationIcao: destination.icao,
        destinationName: `${destination.city}, ${destination.state}`,
        distance: distance * 2, // Round trip
        revenueDistance: distance, // Only outbound is revenue
        legs: [
          { type: 'outbound', from: S.bases.primary, to: destination.icao, distance: distance, payload: true },
          { type: 'return', from: destination.icao, to: S.bases.primary, distance: distance, payload: false }
        ]
      };
    }
    
    // Point-to-point mission (charter, cargo, medevac, etc.)
    function generatePointToPointMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      // Get appropriate distance range for this aircraft
      const distRange = getDistanceRangeForAircraft(aircraft);
      let maxRange = distRange.max;
      let minRange = distRange.min;
      
      // Override with mission-specific distance range if defined
      if (missionDef.distanceRange) {
        minRange = Math.max(minRange, missionDef.distanceRange[0]);
        maxRange = Math.min(maxRange, missionDef.distanceRange[1]);
      }
      
      if (maxContractRange) maxRange = Math.min(maxRange, maxContractRange);
      
      // Find suitable airports within range of home base
      let suitableAirports = findSuitableAirports(aircraft, homeAirport, missionDef, minRange, maxRange);
      if (suitableAirports.length < 2) return null;
      
      // For contract pilot jobs on large aircraft, filter pickup to major airports only
      const isContractJob = maxContractRange !== null;
      const requiresMajorAirport = ['airliner', 'light_jet', 'heavy_jet', 'military_cargo'].includes(aircraft.category);
      
      let pickupCandidates = suitableAirports;
      if (isContractJob && requiresMajorAirport) {
        // Filter to large/medium airports for airliner pickups
        pickupCandidates = suitableAirports.filter(apt => 
          apt.type === 'large_airport' || apt.type === 'medium_airport'
        );
        // Fall back to all suitable if no major airports in range
        if (pickupCandidates.length === 0) return null;
      }
      
      // Pick a pickup point
      const pickup = randomItem(pickupCandidates);
      
      // For delivery, also require major airport for large aircraft
      let deliveryCandidates = suitableAirports;
      if (requiresMajorAirport) {
        deliveryCandidates = suitableAirports.filter(apt => 
          apt.type === 'large_airport' || apt.type === 'medium_airport'
        );
        if (deliveryCandidates.length < 2) return null;
      }
      
      // Find delivery options with revenue leg distance appropriate for aircraft
      const deliveryOptions = deliveryCandidates
        .filter(a => a.icao !== pickup.icao)
        .map(a => ({
          ...a,
          dist: calculateDistance(pickup.lat, pickup.lon, a.lat, a.lon)
        }))
        .filter(a => a.dist >= minRange && a.dist <= maxRange);
      
      if (deliveryOptions.length === 0) return null;
      
      // Select delivery using weighted distance preference
      const delivery = selectMissionDistance(distRange, deliveryOptions) || randomItem(deliveryOptions);
      
      const positioningDist = Math.round(calculateDistance(homeAirport.lat, homeAirport.lon, pickup.lat, pickup.lon));
      const revenueDist = Math.round(delivery.dist);
      const returnDist = Math.round(calculateDistance(delivery.lat, delivery.lon, homeAirport.lat, homeAirport.lon));
      
      return {
        originIcao: pickup.icao,
        originName: `${pickup.city}, ${pickup.state}`,
        destinationIcao: delivery.icao,
        destinationName: `${delivery.city}, ${delivery.state}`,
        distance: positioningDist + revenueDist + returnDist,
        revenueDistance: revenueDist,
        positioningDistance: positioningDist,
        returnDistance: returnDist,
        legs: [
          { type: 'positioning', from: S.bases.primary, to: pickup.icao, distance: positioningDist, payload: false },
          { type: 'revenue', from: pickup.icao, to: delivery.icao, distance: revenueDist, payload: true },
          { type: 'return', from: delivery.icao, to: S.bases.primary, distance: returnDist, payload: false }
        ]
      };
    }
    
    // Waypoint mission (photography, survey, SAR, etc.)
    function generateWaypointMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      let maxRange = aircraft.range * 0.35; // Conservative for waypoint missions
      if (maxContractRange) maxRange = Math.min(maxRange, maxContractRange);
      
      // Limit sightseeing-type missions to 90 minutes max total (out + on-site + back)
      // On-site is typically 10-15 min, so cap one-way flight to ~40 min
      const sightseeingMissions = ['Sightseeing Tour', 'Discovery Flight', 'Heli Tour'];
      if (sightseeingMissions.includes(missionType)) {
        const cruiseSpeed = aircraft.cruise_speed || 120;
        const maxOneWayMinutes = 40; // 40 out + 10-15 on-site + 40 back = ~90-95 min total
        const maxOneWayDistance = Math.round((cruiseSpeed * maxOneWayMinutes) / 60);
        maxRange = Math.min(maxRange, maxOneWayDistance);
      }
      
      // Sightseeing can use nearby landmarks (local city tours), other missions need more distance
      const minRange = sightseeingMissions.includes(missionType) ? 3 : 15;
      
      // Try to find a real landmark for sightseeing missions
      let waypoint = null;
      let description = null;
      let landmarkData = null;
      
      // Sightseeing and photography missions should try to use real landmarks
      const landmarkMissions = ['Sightseeing Tour', 'Aerial Photography', 'Discovery Flight', 'Heli Tour'];
      const useLandmark = landmarkMissions.includes(missionType) && Object.keys(LANDMARKS).length > 0;
      
      debugLog('Waypoint Mission -', missionType, 'useLandmark:', useLandmark, 'LANDMARKS count:', Object.keys(LANDMARKS).length);
      
      if (useLandmark) {
        // Get landmarks near home airport
        debugLog('Searching landmarks near', homeAirport.lat, homeAirport.lon, 'maxRange:', maxRange);
        const nearbyLandmarks = getLandmarksNear(homeAirport.lat, homeAirport.lon, maxRange, 30);
        debugLog('Found', nearbyLandmarks.length, 'landmarks within', maxRange, 'nm');
        
        // Filter to those within our min/max range
        const validLandmarks = nearbyLandmarks.filter(lm => lm.distance >= minRange && lm.distance <= maxRange);
        
        // Prefer certain types for sightseeing
        const sightseeingTypes = ['national_park', 'natural', 'waterfall', 'mountain', 'lake', 'monument', 'landmark', 'skyline'];
        let preferred = validLandmarks.filter(lm => sightseeingTypes.includes(lm.type));
        
        // If no preferred types, use any valid landmark
        if (preferred.length === 0) preferred = validLandmarks;
        
        if (preferred.length > 0) {
          // Pick a random landmark from candidates
          landmarkData = randomItem(preferred);
          debugLog('Selected landmark:', landmarkData.name, 'at', landmarkData.distance, 'nm');
          
          // Check if this is a close landmark - if so, build a multi-stop tour
          if (landmarkData.distance < 25 && sightseeingMissions.includes(missionType)) {
            // Local city tour - grab multiple landmarks for a 45-min loop
            // Shuffle available landmarks to vary the tour stops each time
            const availableTourStops = nearbyLandmarks
              .filter(lm => lm.distance <= 30 && lm.code !== landmarkData.code);
            
            // Shuffle the array for variety
            for (let i = availableTourStops.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [availableTourStops[i], availableTourStops[j]] = [availableTourStops[j], availableTourStops[i]];
            }
            
            // Take up to 4 random stops
            const tourLandmarks = availableTourStops.slice(0, 4);
            
            // Build tour with primary + additional landmarks
            const allTourStops = [landmarkData, ...tourLandmarks];
            const tourNames = allTourStops.map(lm => lm.name);
            
            // Use primary landmark coords as waypoint, but mark as tour
            waypoint = {
              lat: landmarkData.lat,
              lon: landmarkData.lon,
              distance: 20, // Approximate tour distance for a loop
              bearing: Math.round(Math.atan2(
                Math.sin((landmarkData.lon - homeAirport.lon) * Math.PI / 180) * Math.cos(landmarkData.lat * Math.PI / 180),
                Math.cos(homeAirport.lat * Math.PI / 180) * Math.sin(landmarkData.lat * Math.PI / 180) -
                Math.sin(homeAirport.lat * Math.PI / 180) * Math.cos(landmarkData.lat * Math.PI / 180) * Math.cos((landmarkData.lon - homeAirport.lon) * Math.PI / 180)
              ) * 180 / Math.PI + 360) % 360,
              isTour: true,
              tourStops: allTourStops
            };
            
            // Build description listing all stops
            const cityName = homeAirport.city || 'the local area';
            description = `Scenic aerial tour of ${cityName} featuring ${tourNames.join(', ')}.`;
            
            // Mark landmarkData as a tour for action text
            landmarkData = {
              ...landmarkData,
              isTour: true,
              tourNames: tourNames,
              cityName: cityName
            };
          } else {
            // Standard single-destination flight
            waypoint = {
              lat: landmarkData.lat,
              lon: landmarkData.lon,
              distance: landmarkData.distance,
              bearing: Math.round(Math.atan2(
                Math.sin((landmarkData.lon - homeAirport.lon) * Math.PI / 180) * Math.cos(landmarkData.lat * Math.PI / 180),
                Math.cos(homeAirport.lat * Math.PI / 180) * Math.sin(landmarkData.lat * Math.PI / 180) -
                Math.sin(homeAirport.lat * Math.PI / 180) * Math.cos(landmarkData.lat * Math.PI / 180) * Math.cos((landmarkData.lon - homeAirport.lon) * Math.PI / 180)
              ) * 180 / Math.PI + 360) % 360
            };
            
            // Generate description based on landmark
            description = generateLandmarkDescription(landmarkData, missionType);
          }
        }
      }
      
      // Fall back to random waypoint if no landmark found
      if (!waypoint) {
        debugLog('No landmark found within', maxRange, 'nm');
        
        // For sightseeing missions, check if we're just time-limited or truly remote
        if (sightseeingMissions.includes(missionType)) {
          // Check if there are landmarks within a larger range (150nm)
          const extendedLandmarks = getLandmarksNear(homeAirport.lat, homeAirport.lon, 150, 10);
          
          if (extendedLandmarks.length > 0) {
            // Landmarks exist but are too far for our time limit - skip this mission
            debugLog('Landmarks exist but outside time limit, skipping sightseeing mission');
            return null;
          }
          
          // Truly remote area - generate "local scenic" flight (pilot's choice)
          debugLog('Remote area - generating local scenic flight');
          const scenicDistance = randomInt(minRange, Math.min(maxRange, 40));
          waypoint = generateWaypoint(homeAirport.lat, homeAirport.lon, minRange, scenicDistance);
          description = "Local scenic flight over the surrounding terrain. Route and highlights at pilot's discretion based on local knowledge.";
          
          // Create a pseudo-landmark for display
          landmarkData = {
            name: "Local Scenic Area",
            type: "scenic",
            desc: "Pilot's choice - explore local terrain, waterways, and points of interest",
            alt: null
          };
        } else {
          // Non-sightseeing waypoint missions can use random coordinates
          waypoint = generateWaypoint(homeAirport.lat, homeAirport.lon, minRange, maxRange);
          description = generateWaypointDescription(missionType);
        }
      }
      
      const profile = missionDef.waypointProfile || {
        altitudeAGL: 1000,
        speedMin: 80,
        speedMax: 120,
        pattern: 'orbit',
        durationMinutes: 10
      };
      
      // Ensure speeds are safe for aircraft
      const safeSpeedMin = Math.max(profile.speedMin, (aircraft.cruise_speed || 100) * 0.5);
      const safeSpeedMax = Math.min(profile.speedMax, (aircraft.cruise_speed || 120) * 0.9);
      
      // Customize action text based on whether we have a landmark and its distance
      let actionText;
      
      // Calculate natural flight duration
      const cruiseSpeed = aircraft.cruise_speed || 120;
      const flightMinutes = Math.round((waypoint.distance * 2) / cruiseSpeed * 60);
      const effectiveOnSiteMinutes = landmarkData?.isTour ? 35 : (missionDef.onSiteMinutes || 15);
      const naturalDuration = flightMinutes + effectiveOnSiteMinutes;
      
      // Sightseeing missions have 1-hour minimum
      const isSightseeing = sightseeingMissions.includes(missionType);
      const isShortFlight = isSightseeing && naturalDuration < 60;
      const finalDuration = isShortFlight ? 60 : naturalDuration;
      
      // Build pilot discretion suffix for short flights
      const discretionSuffix = isShortFlight 
        ? ` Client requests a 1-hour flight. After visiting the destination, explore the surrounding area at pilot's discretion.`
        : '';
      
      if (landmarkData && landmarkData.type === 'scenic') {
        // Local scenic flight - pilot's choice (truly remote area)
        actionText = `Scenic flight around the local area. Explore terrain, waterways, and points of interest at ${profile.altitudeAGL} ft AGL. Route at pilot's discretion. ATC coordination complete - cleared through all restricted airspace.`;
      } else if (landmarkData && landmarkData.isTour) {
        // Multi-stop local city tour
        const tourDuration = isShortFlight ? '1 hour' : '45 minutes';
        actionText = `Scenic tour of the ${landmarkData.cityName} area featuring ${landmarkData.tourNames.join(', ')}. ${tourDuration} at ${profile.altitudeAGL} ft AGL. Route at pilot's discretion. ATC coordination complete - cleared through all restricted airspace.`;
      } else if (landmarkData) {
        // Destination flight - distant landmark
        const altitudeHint = landmarkData.alt ? ` (${landmarkData.alt} ft MSL)` : '';
        actionText = `Navigate to vicinity of ${landmarkData.name}${altitudeHint}. Locate visually, then ${profile.pattern === 'orbit' ? 'orbit' : 'circle'} at ${profile.altitudeAGL} ft AGL for ${profile.durationMinutes} minutes.${discretionSuffix} ATC coordination complete - cleared through all restricted airspace.`;
      } else {
        actionText = profile.action || 
          `${profile.pattern === 'orbit' ? 'Orbit' : profile.pattern === 'grid' ? 'Fly grid pattern at' : 'Proceed to'} waypoint at ${profile.altitudeAGL} ft AGL, ${safeSpeedMin}-${safeSpeedMax} knots, for ${profile.durationMinutes} minutes`;
      }
      
      // For tours, use "City Tour" as destination name, otherwise use landmark name
      const destName = landmarkData?.isTour 
        ? `${landmarkData.cityName} Tour` 
        : (landmarkData ? landmarkData.name : 'Waypoint');
      
      return {
        originIcao: S.bases.primary,
        originName: `${homeAirport.city}, ${homeAirport.state}`,
        destinationIcao: null,
        destinationName: destName,
        waypoint: {
          lat: waypoint.lat,
          lon: waypoint.lon,
          bearing: waypoint.bearing,
          distance: waypoint.distance,
          landmark: landmarkData ? {
            code: landmarkData.code,
            name: landmarkData.isTour ? destName : landmarkData.name,
            type: landmarkData.isTour ? 'tour' : landmarkData.type,
            desc: landmarkData.desc,
            alt: landmarkData.alt,
            isTour: landmarkData.isTour || false,
            cityName: landmarkData.cityName || null,
            tourStops: waypoint.tourStops || null
          } : null
        },
        waypointDescription: description,
        waypointAction: actionText,
        waypointProfile: {
          ...profile,
          speedMin: safeSpeedMin,
          speedMax: safeSpeedMax
        },
        distance: waypoint.distance * 2,
        revenueDistance: waypoint.distance * 2,
        onSiteMinutes: effectiveOnSiteMinutes,
        estimatedMinutes: finalDuration,
        legs: [
          { type: 'outbound', from: S.bases.primary, to: landmarkData ? landmarkData.name : 'waypoint', distance: waypoint.distance },
          { type: 'on_site', duration: missionDef.onSiteMinutes || 15 },
          { type: 'return', from: landmarkData ? landmarkData.name : 'waypoint', to: S.bases.primary, distance: waypoint.distance }
        ]
      };
    }
    
    function generateLandmarkDescription(landmark, missionType) {
      const typeDescriptions = {
        national_park: [
          `Scenic flight over ${landmark.name}`,
          `National Park tour - ${landmark.desc}`,
          `Aerial sightseeing at ${landmark.name}`
        ],
        natural: [
          `Natural wonder flyover - ${landmark.name}`,
          `Scenic tour of ${landmark.desc}`,
          `${landmark.name} aerial experience`
        ],
        waterfall: [
          `Waterfall aerial tour - ${landmark.name}`,
          `Scenic flight to ${landmark.name}`,
          `${landmark.name} photography opportunity`
        ],
        mountain: [
          `Mountain peak tour - ${landmark.name}`,
          `High altitude scenic flight`,
          `${landmark.name} summit flyover`
        ],
        lake: [
          `Lake aerial tour - ${landmark.name}`,
          `Scenic water flyover`,
          `${landmark.name} shoreline tour`
        ],
        monument: [
          `Historic monument tour - ${landmark.name}`,
          `${landmark.name} aerial photography`,
          `Landmark flyover - ${landmark.desc}`
        ],
        skyline: [
          `City skyline tour - ${landmark.name}`,
          `Downtown aerial sightseeing`,
          `${landmark.name} city lights tour`
        ],
        stadium: [
          `Stadium flyover - ${landmark.name}`,
          `Sports venue aerial tour`,
          `${landmark.name} event flyover`
        ],
        lighthouse: [
          `Coastal lighthouse tour - ${landmark.name}`,
          `${landmark.name} scenic flight`,
          `Historic lighthouse photography`
        ],
        bridge: [
          `Bridge aerial tour - ${landmark.name}`,
          `${landmark.name} photography flight`,
          `Iconic bridge flyover`
        ]
      };
      
      // Get options for this type, or use generic
      const options = typeDescriptions[landmark.type] || [
        `Aerial tour of ${landmark.name}`,
        `Scenic flight - ${landmark.desc}`,
        `${landmark.name} sightseeing`
      ];
      
      return randomItem(options);
    }
    
    // Ferry mission
    function generateFerryMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      // Get appropriate distance range for this aircraft
      const distRange = getDistanceRangeForAircraft(aircraft);
      
      let maxPickupDist = missionDef.maxPickupDistance || 200;
      if (maxContractRange) maxPickupDist = Math.min(maxPickupDist, maxContractRange);
      
      // Find pickup airport within range of home base
      const pickupAirports = Object.values(AIRPORTS).filter(apt => {
        if (apt.icao === S.bases.primary) return false;
        const dist = calculateDistance(homeAirport.lat, homeAirport.lon, apt.lat, apt.lon);
        if (dist > maxPickupDist || dist < 20) return false;
        return isAirportSuitable(apt, aircraft, missionType);
      });
      
      if (pickupAirports.length === 0) return null;
      const pickup = randomItem(pickupAirports);
      
      // Find delivery airport - use aircraft-appropriate distances
      const minFerryDist = distRange.min;
      const maxFerryDist = distRange.max;
      
      const deliveryAirports = Object.values(AIRPORTS)
        .filter(apt => {
          if (apt.icao === pickup.icao || apt.icao === S.bases.primary) return false;
          return isAirportSuitable(apt, aircraft, missionType);
        })
        .map(apt => ({
          ...apt,
          dist: calculateDistance(pickup.lat, pickup.lon, apt.lat, apt.lon)
        }))
        .filter(apt => apt.dist >= minFerryDist && apt.dist <= maxFerryDist);
      
      if (deliveryAirports.length === 0) return null;
      
      // Select using weighted distance preference
      const delivery = selectMissionDistance(distRange, deliveryAirports) || randomItem(deliveryAirports);
      
      const pickupDist = Math.round(calculateDistance(homeAirport.lat, homeAirport.lon, pickup.lat, pickup.lon));
      const ferryDist = Math.round(calculateDistance(pickup.lat, pickup.lon, delivery.lat, delivery.lon));
      
      return {
        originIcao: pickup.icao,
        originName: `${pickup.city}, ${pickup.state}`,
        pickupIcao: pickup.icao,
        pickupName: `${pickup.city}, ${pickup.state}`,
        pickupDistance: pickupDist,
        deliveryIcao: delivery.icao,
        deliveryName: `${delivery.city}, ${delivery.state}`,
        destinationIcao: delivery.icao,
        destinationName: `${delivery.city}, ${delivery.state}`,
        distance: ferryDist,
        revenueDistance: ferryDist,
        isFerry: true,
        ferryNote: "Travel to pickup location is at pilot's discretion. You may fly positioning legs or arrange ground transport.",
        legs: [
          { type: 'ferry', from: pickup.icao, to: delivery.icao, distance: ferryDist, payload: false }
        ]
      };
    }
    
    // Find airports suitable for aircraft and mission
    function findSuitableAirports(aircraft, homeAirport, missionDef, minDist, maxDist) {
      // Destination types that allow unpaved surfaces
      const unpavedDestTypes = ['short_field', 'remote', 'bush'];
      const requiresPaved = !unpavedDestTypes.includes(missionDef.destType);
      
      return Object.values(AIRPORTS).filter(apt => {
        if (apt.icao === S.bases.primary) return false;
        
        // Skip closed airports and heliports (unless destType is heliport)
        if (apt.type === 'closed') return false;
        if (apt.type === 'heliport' && missionDef.destType !== 'heliport') return false;
        
        const dist = calculateDistance(homeAirport.lat, homeAirport.lon, apt.lat, apt.lon);
        if (dist < minDist || dist > maxDist) return false;
        
        // Check runway exists
        const runway = apt.runways && apt.runways[0];
        if (!runway && apt.type !== 'heliport') return false;
        
        const surface = runway ? normalizeSurface(runway.surface) : 'paved';
        
        // Paved surface requirement for most missions
        if (requiresPaved && surface !== 'paved') {
          return false;
        }
        
        // Check airport suitability for aircraft
        if (!isAirportSuitable(apt, aircraft, missionDef.destType === 'short_field' ? 'Bush Resupply' : 'Charter Flight')) {
          return false;
        }
        
        // Special destination type requirements
        if (missionDef.destType === 'short_field') {
          if (!runway || runway.length > 3000) return false; // Prefer shorter strips
          if (!['grass', 'gravel', 'dirt'].includes(surface)) return false;
        }
        
        if (missionDef.destType === 'water') {
          if (surface !== 'water') return false;
        }
        
        return true;
      });
    }
    
    // Categorize heliport by name to determine type (medical, corporate, etc.)
    function categorizeHeliport(heliport) {
      const name = (heliport.name || '').toLowerCase();
      
      // Medical facilities
      if (name.includes('hospital') || name.includes('medical') || 
          name.includes('health') || name.includes('trauma') ||
          name.includes('mercy') || name.includes('memorial') ||
          name.includes('clinic') || name.includes('emergency') ||
          name.includes('regional med') || name.includes('community health') ||
          name.includes('children') || name.includes('presbyterian') ||
          name.includes('methodist') || name.includes('baptist') ||
          name.includes('catholic') || name.includes('lutheran') ||
          name.includes('st.') || name.includes('saint') ||
          name.includes('va ') || name.includes('veterans')) {
        return 'medical';
      }
      
      // Corporate/Downtown
      if (name.includes('downtown') || name.includes('corporate') ||
          name.includes('tower') || name.includes('plaza') ||
          name.includes('center') || name.includes('building') ||
          name.includes('office') || name.includes('executive') ||
          name.includes('bank') || name.includes('financial')) {
        return 'corporate';
      }
      
      // Police/Fire/Government
      if (name.includes('police') || name.includes('sheriff') ||
          name.includes('fire') || name.includes('county') ||
          name.includes('state') || name.includes('federal') ||
          name.includes('pd ') || name.includes('fd ')) {
        return 'government';
      }
      
      // News/Media
      if (name.includes('news') || name.includes('tv') || name.includes('radio') ||
          name.includes('media') || name.includes('broadcast')) {
        return 'media';
      }
      
      // Default
      return 'general';
    }
    
    // Find heliports near a location, optionally filtered by category
    function findHeliportsNear(origin, minDist, maxDist, category = null) {
      const results = [];
      
      for (const [icao, apt] of Object.entries(AIRPORTS)) {
        if (apt.type !== 'heliport') continue;
        if (icao === S.bases.primary) continue;
        
        const dist = calculateDistance(origin.lat, origin.lon, apt.lat, apt.lon);
        if (dist < minDist || dist > maxDist) continue;
        
        const heliCategory = categorizeHeliport(apt);
        
        // If category specified, filter (but allow 'general' as fallback)
        if (category && heliCategory !== category && heliCategory !== 'general') continue;
        
        results.push({ 
          ...apt, 
          icao, 
          distance: Math.round(dist), 
          category: heliCategory 
        });
      }
      
      results.sort((a, b) => a.distance - b.distance);
      return results;
    }
    
    // Find commercial airports (medium/large) near a location
    function findCommercialAirportsNear(origin, minDist, maxDist) {
      const results = [];
      
      for (const [icao, apt] of Object.entries(AIRPORTS)) {
        if (apt.type !== 'medium_airport' && apt.type !== 'large_airport') continue;
        if (icao === S.bases.primary) continue;
        
        const dist = calculateDistance(origin.lat, origin.lon, apt.lat, apt.lon);
        if (dist < minDist || dist > maxDist) continue;
        
        results.push({ ...apt, icao, distance: Math.round(dist) });
      }
      
      results.sort((a, b) => a.distance - b.distance);
      return results;
    }
    
    // Helicopter transfer mission (Hospital Transfer, Executive Shuttle)
    function generateHeliTransferMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      const minRange = missionDef.distanceRange ? missionDef.distanceRange[0] : 10;
      let maxRange = missionDef.distanceRange ? missionDef.distanceRange[1] : 60;
      maxRange = Math.min(maxRange, aircraft.range * 0.4);
      if (maxContractRange) maxRange = Math.min(maxRange, maxContractRange);
      
      // Determine heliport category from destType
      const targetCategory = missionDef.destType.replace('heliport_', '');
      const heliports = findHeliportsNear(homeAirport, minRange, maxRange, targetCategory);
      
      if (heliports.length === 0) {
        debugLog('No heliports found for', missionType, 'category:', targetCategory);
        return null;
      }
      
      // Pick a random destination
      const destination = randomItem(heliports);
      const distance = destination.distance;
      
      // Select briefing template
      const briefing = missionDef.briefingTemplates 
        ? randomItem(missionDef.briefingTemplates).replace('{destination}', destination.name)
        : `Transport to ${destination.name}`;
      
      return {
        originIcao: S.bases.primary,
        originName: `${homeAirport.city}, ${homeAirport.state}`,
        destinationIcao: destination.icao,
        destinationName: destination.name,
        destinationType: destination.category,
        distance: Math.round(distance * 2), // Round trip
        revenueDistance: Math.round(distance), // One-way revenue
        heliBriefing: briefing,
        legs: [
          { type: 'outbound', from: S.bases.primary, to: destination.icao, 
            distance: Math.round(distance), payload: true },
          { type: 'reposition', from: destination.icao, to: S.bases.primary, 
            distance: Math.round(distance), payload: false }
        ]
      };
    }
    
    // Helicopter scene response mission (Heli EMS)
    function generateHeliSceneMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      const minRange = missionDef.distanceRange ? missionDef.distanceRange[0] : 5;
      let maxSceneDist = Math.min(25, missionDef.distanceRange ? missionDef.distanceRange[1] : 25);
      if (maxContractRange) maxSceneDist = Math.min(maxSceneDist, maxContractRange * 0.3);
      
      // Generate random scene location
      const sceneDist = randomInt(minRange, maxSceneDist);
      const sceneWaypoint = generateWaypoint(homeAirport.lat, homeAirport.lon, minRange, sceneDist);
      
      // Find nearest hospital heliport to scene
      const hospitals = findHeliportsNear(
        { lat: sceneWaypoint.lat, lon: sceneWaypoint.lon }, 
        3, 40, 'medical'
      );
      
      if (hospitals.length === 0) {
        debugLog('No hospital heliports found near scene for', missionType);
        return null;
      }
      
      const hospital = hospitals[0]; // Nearest hospital
      const sceneToHospital = calculateDistance(sceneWaypoint.lat, sceneWaypoint.lon,
                                                 hospital.lat, hospital.lon);
      const hospitalToBase = calculateDistance(hospital.lat, hospital.lon,
                                                homeAirport.lat, homeAirport.lon);
      
      const totalDistance = sceneDist + sceneToHospital + hospitalToBase;
      const onSceneMinutes = missionDef.onSceneMinutes || randomInt(5, 10);
      
      // Select briefing template
      const briefing = missionDef.briefingTemplates 
        ? randomItem(missionDef.briefingTemplates).replace('{destination}', hospital.name)
        : `Respond to scene, transport patient to ${hospital.name}`;
      
      // Format coordinates for display
      const latDir = sceneWaypoint.lat >= 0 ? 'N' : 'S';
      const lonDir = sceneWaypoint.lon >= 0 ? 'E' : 'W';
      const coordsDisplay = `${Math.abs(sceneWaypoint.lat).toFixed(2)}Â°${latDir}, ${Math.abs(sceneWaypoint.lon).toFixed(2)}Â°${lonDir}`;
      
      return {
        originIcao: S.bases.primary,
        originName: `${homeAirport.city}, ${homeAirport.state}`,
        destinationIcao: hospital.icao,
        destinationName: hospital.name,
        destinationType: 'medical',
        sceneWaypoint: {
          lat: sceneWaypoint.lat,
          lon: sceneWaypoint.lon,
          distance: sceneDist,
          bearing: sceneWaypoint.bearing,
          coordsDisplay: coordsDisplay
        },
        distance: Math.round(totalDistance),
        revenueDistance: Math.round(sceneToHospital), // Patient transport portion
        onSceneMinutes: onSceneMinutes,
        heliBriefing: briefing,
        heliSceneAction: `Respond to scene at ${coordsDisplay}. Land at pilot's discretion within 0.25nm. On-scene time approximately ${onSceneMinutes} minutes for patient loading. Then transport to ${hospital.name}.`,
        legs: [
          { type: 'response', from: S.bases.primary, to: 'Scene', 
            distance: Math.round(sceneDist), payload: false, emergency: true },
          { type: 'on_scene', duration: onSceneMinutes },
          { type: 'transport', from: 'Scene', to: hospital.icao, 
            distance: Math.round(sceneToHospital), payload: true },
          { type: 'reposition', from: hospital.icao, to: S.bases.primary, 
            distance: Math.round(hospitalToBase), payload: false }
        ]
      };
    }
    
    // Helicopter airport connect mission
    function generateHeliConnectMission(aircraft, homeAirport, missionDef, missionType, maxContractRange = null) {
      const minRange = missionDef.distanceRange ? missionDef.distanceRange[0] : 5;
      let maxRange = missionDef.distanceRange ? missionDef.distanceRange[1] : 30;
      maxRange = Math.min(maxRange, aircraft.range * 0.4);
      if (maxContractRange) maxRange = Math.min(maxRange, maxContractRange);
      
      // Find commercial airports in range
      const airports = findCommercialAirportsNear(homeAirport, minRange, maxRange);
      
      // Find heliports (prefer corporate/downtown) in range
      const heliports = findHeliportsNear(homeAirport, minRange, maxRange, 'corporate');
      
      if (airports.length === 0 || heliports.length === 0) {
        debugLog('No airports or heliports found for', missionType);
        return null;
      }
      
      const airport = randomItem(airports);
      const heliport = randomItem(heliports);
      
      // Randomize direction: to airport or from airport
      const toAirport = Math.random() > 0.5;
      const origin = toAirport ? heliport : airport;
      const destination = toAirport ? airport : heliport;
      
      const transportDistance = calculateDistance(origin.lat, origin.lon, destination.lat, destination.lon);
      
      // Calculate positioning legs
      const positionToOrigin = calculateDistance(homeAirport.lat, homeAirport.lon, origin.lat, origin.lon);
      const returnFromDest = calculateDistance(destination.lat, destination.lon, homeAirport.lat, homeAirport.lon);
      
      const totalDistance = positionToOrigin + transportDistance + returnFromDest;
      
      // Select briefing template
      const briefing = missionDef.briefingTemplates 
        ? randomItem(missionDef.briefingTemplates)
            .replace('{origin}', origin.name)
            .replace('{destination}', destination.name)
        : `Transport from ${origin.name} to ${destination.name}`;
      
      return {
        originIcao: origin.icao,
        originName: origin.name,
        destinationIcao: destination.icao,
        destinationName: destination.name,
        pickupType: toAirport ? 'heliport' : 'airport',
        dropoffType: toAirport ? 'airport' : 'heliport',
        homeBase: S.bases.primary,
        distance: Math.round(totalDistance),
        revenueDistance: Math.round(transportDistance),
        heliBriefing: briefing,
        legs: [
          { type: 'position', from: S.bases.primary, to: origin.icao, 
            distance: Math.round(positionToOrigin), payload: false },
          { type: 'transport', from: origin.icao, to: destination.icao, 
            distance: Math.round(transportDistance), payload: true },
          { type: 'reposition', from: destination.icao, to: S.bases.primary, 
            distance: Math.round(returnFromDest), payload: false }
        ]
      };
    }
    
    function generateRandomBusinessHourTime() {
      // Generate a random business hour (8-17) for TODAY
      // Email will be delivered when game time reaches this hour
      return {
        year: S.gameTime.year,
        month: S.gameTime.month,
        day: S.gameTime.day,
        hour: randomInt(8, 17),
        minute: 0
      };
    }
    
    function cleanupExpiredEmails() {
      // Initialize archivedEmails if missing
      if (!S.archivedEmails) S.archivedEmails = [];
      
      const now = S.gameTime;
      const emailsToKeep = [];
      
      S.emails.forEach(email => {
        // Keep complaint emails (they don't expire)
        if (email.type === "complaint") {
          emailsToKeep.push(email);
          return;
        }
        // Keep checkride emails (can't delete them)
        if (email.type === "checkride") {
          emailsToKeep.push(email);
          return;
        }
        
        // Calculate email age in days
        const emailAge = email.receivedAt ? 
          (compareGameTime(now, email.receivedAt) / (24 * 60)) : 0;
        
        // Auto-archive informational emails after 7 days (except financial alerts - those just delete)
        const informationalTypes = ['tutorial-welcome', 'business-welcome', 'commercial-welcome', 'finance-intro', 'notification'];
        if (informationalTypes.includes(email.type) && emailAge > 7) {
          // Financial alerts (low cash warnings) just get deleted, not archived
          if (email.company === 'Financial Alert') {
            return; // Delete
          }
          S.archivedEmails.push(email);
          return; // Don't keep in inbox
        }
        
        // Auto-archive receipt/completion emails after 30 days
        const receiptTypes = ['flight-complete', 'payment-confirmed'];
        if (receiptTypes.includes(email.type) && emailAge > 30) {
          S.archivedEmails.push(email);
          return;
        }
        
        // Auto-archive paid payment-due emails after 7 days
        if (email.type === 'payment-due' && email.status === 'paid' && emailAge > 7) {
          S.archivedEmails.push(email);
          return;
        }
        
        // Delete expired/declined inquiry emails after 24 hours past scheduleBy
        if (email.scheduleBy && (email.status === 'pending' || email.status === 'declined')) {
          const expireTime = addMinutes(email.scheduleBy, 24 * 60); // 24 hours after scheduleBy
          if (compareGameTime(now, expireTime) > 0) {
            return; // Delete (don't keep or archive)
          }
        }
        
        // Keep everything else
        emailsToKeep.push(email);
      });
      
      S.emails = emailsToKeep;
    }
    
    // === CHECKRIDE SYSTEM ===
    
    function generateCheckrideEmail(gateKey) {
      const gate = PROGRESSION_GATES[gateKey];
      if (!gate) {
        console.error('Unknown progression gate:', gateKey);
        return null;
      }
      
      // Pick a random examiner
      const examiner = randomItem(EXAMINERS);
      
      // Calculate fee based on certificate type
      const fees = {
        student: 0,
        night: 400,
        seaplane: 600,
        multiEngine: 700,
        private: 800,
        instrument: 900,
        helicopter: 1000,
        turbine: 850,
        commercial: 1000,
        atp: 1500
      };
      const fee = fees[gateKey] || 500;
      
      // Generate email
      const email = {
        id: uuid(),
        type: "checkride",
        gateKey: gateKey,
        certificateName: gate.name,
        certificateType: gate.type,
        from: examiner.name,
        examiner: examiner,
        company: "FAA Designated Pilot Examiner",
        subject: `ðŸ”´ Checkride Available: ${gate.name}`,
        fee: fee,
        hoursRequired: gate.hours,
        status: "pending",
        priority: "checkride",
        canDelete: false,
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        receivedAt: { ...S.gameTime }
      };
      
      return email;
    }
    
    function sendCheckrideEmail(gateKey) {
      // Check if there's already a pending checkride email for this gate
      const existing = S.emails.find(e => e.type === 'checkride' && e.gateKey === gateKey && e.status === 'pending');
      if (existing) {
        alert(`You already have a pending ${PROGRESSION_GATES[gateKey].name} checkride email.`);
        return;
      }
      
      // Check for 7-day cooldown from failed attempt
      const failedAttempt = S.checkrides?.failed?.find(f => f.gateKey === gateKey);
      if (failedAttempt && failedAttempt.retryAfter && compareGameTime(S.gameTime, failedAttempt.retryAfter) < 0) {
        const daysRemaining = Math.ceil(compareGameTime(failedAttempt.retryAfter, S.gameTime) / (24 * 60));
        alert(`You must wait ${daysRemaining} more day(s) before retaking this checkride.\n\nRetry available: ${formatGameTime(failedAttempt.retryAfter)}`);
        return;
      }
      
      // Check if already passed
      const gate = PROGRESSION_GATES[gateKey];
      if (gate.type === 'certificate' && S.pilot.certificates.includes(gateKey)) {
        alert(`You already have your ${gate.name} certificate.`);
        return;
      }
      if (gate.type === 'rating' && S.pilot.ratings.includes(gateKey)) {
        alert(`You already have your ${gate.name}.`);
        return;
      }
      
      const email = generateCheckrideEmail(gateKey);
      if (email) {
        S.emails.push(email);
        saveState();
        render();
      }
    }
    
    // Direct rating checkride scheduling from Pilot tab (no emails, direct scheduling)
    function scheduleRatingCheckride(ratingId) {
      const gate = PROGRESSION_GATES[ratingId];
      if (!gate || gate.type !== 'rating') {
        alert('Invalid rating');
        return;
      }
      
      // Check if already has rating
      if (S.pilot.ratings.includes(ratingId)) {
        alert(`You already have your ${gate.name}.`);
        return;
      }
      
      // Check for 7-day cooldown from failed attempt
      const failedAttempt = S.checkrides?.failed?.find(f => f.gateKey === ratingId);
      if (failedAttempt && failedAttempt.retryAfter && compareGameTime(S.gameTime, failedAttempt.retryAfter) < 0) {
        const daysRemaining = Math.ceil(compareGameTime(failedAttempt.retryAfter, S.gameTime) / (24 * 60));
        alert(`You must wait ${daysRemaining} more day(s) before retaking this checkride.\n\nRetry available: ${formatGameTime(failedAttempt.retryAfter)}`);
        return;
      }
      
      // Check for already scheduled
      const scheduled = S.checkrides?.scheduled?.find(c => c.gateKey === ratingId);
      if (scheduled) {
        alert(`You already have a ${gate.name} checkride scheduled. Check your Calendar.`);
        return;
      }
      
      // Fee lookup (same as generateCheckrideEmail)
      const fees = {
        night: 400,
        seaplane: 600,
        multiEngine: 700,
        instrument: 900,
        helicopter: 1000,
        turbine: 850
      };
      const fee = fees[ratingId] || 600;
      
      // Pick examiner
      const examiner = randomItem(EXAMINERS);
      
      // Create email entry (needed for confirmCheckrideSchedule to work)
      const checkrideEmail = {
        id: uuid(),
        type: "checkride",
        gateKey: ratingId,
        certificateName: gate.name,
        certificateType: 'rating',
        from: examiner.name,
        examiner: examiner,
        company: "FAA Designated Pilot Examiner",
        subject: `ðŸ”´ Checkride: ${gate.name}`,
        fee: fee,
        status: "pending",
        priority: "checkride",
        canDelete: false,
        generatedDay: S.gameTime.day,
        generatedMonth: S.gameTime.month,
        generatedYear: S.gameTime.year,
        receivedAt: { ...S.gameTime }
      };
      
      // Add to emails so confirmCheckrideSchedule can find it
      S.emails.push(checkrideEmail);
      window._pendingCheckrideEmailId = checkrideEmail.id; // Track for cleanup if cancelled
      saveState();
      
      openCheckrideScheduler(checkrideEmail);
    }
    window.scheduleRatingCheckride = scheduleRatingCheckride;
    window.sendCheckrideEmail = sendCheckrideEmail;
    
    function cancelCheckride(gateKey) {
      if (!confirm(`Cancel the ${PROGRESSION_GATES[gateKey]?.name || gateKey} checkride?\n\nThis will clear any stuck state and allow you to reschedule.`)) {
        return;
      }
      
      // Remove any checkride emails for this gate
      S.emails = S.emails.filter(e => !(e.type === 'checkride' && e.gateKey === gateKey));
      
      // Remove any scheduled entries for this gate
      if (S.checkrides?.scheduled) {
        S.checkrides.scheduled = S.checkrides.scheduled.filter(c => c.gateKey !== gateKey);
      }
      
      // Also clear any failed attempts (removes 7-day cooldown)
      if (S.checkrides?.failed) {
        S.checkrides.failed = S.checkrides.failed.filter(f => f.gateKey !== gateKey);
      }
      
      saveState();
      render();
      
      showToast('Checkride Cancelled', `You can now reschedule your ${PROGRESSION_GATES[gateKey]?.name || gateKey} checkride`, 'info');
    }
    window.cancelCheckride = cancelCheckride;
    
    function handleDevCheckrideSelect() {
      const select = document.getElementById('devCheckrideSelect');
      const gateKey = select.value;
      if (gateKey) {
        sendCheckrideEmail(gateKey);
        select.value = ''; // Reset dropdown
      }
    }
    
    function scheduleCheckride(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      openCheckrideScheduler(email);
    }
    
    // === CHECKRIDE DATA ===
    // Checklist items for each certificate/rating type
    const CHECKRIDE_CHECKLISTS = {
      private: {
        name: 'Private Pilot',
        aircraft: 'C172 or similar single-engine',
        duration: '60-75 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Preflight & Departure',
            sections: [
              {
                name: 'ðŸ“‹ Preflight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/07_afh_ch6.pdf',
                items: [
                  { text: 'Weight & balance within limits' },
                  { text: 'Fuel sufficient for flight + reserve' },
                  { text: 'Runup complete - controls free & correct' },
                  { text: 'Runup complete - engine instruments green' },
                  { text: 'Takeoff - rotate at Vr, climb at Vy' }
                ]
              }
            ]
          },
          {
            name: 'Navigation',
            sections: [
              {
                name: 'ðŸ§­ Cross-Country',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/09_afh_ch8.pdf',
                items: [
                  { text: 'Depart home base, navigate to nearby airport' },
                  { text: 'Identify checkpoints enroute' },
                  { text: 'Enter traffic pattern correctly' },
                  { text: 'Full-stop landing at destination' },
                  { text: 'Taxi back, depart to practice area' }
                ]
              }
            ]
          },
          {
            name: 'Maneuvers',
            sections: [
              {
                name: 'â†©ï¸ Steep Turns',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/11_afh_ch10.pdf',
                items: [
                  { text: 'Clearing turns before maneuver' },
                  { text: '360Â° turn LEFT at 45Â° bank (Â±100 ft, Â±10 kts, Â±10Â°)' },
                  { text: '360Â° turn RIGHT at 45Â° bank (Â±100 ft, Â±10 kts, Â±10Â°)' }
                ]
              },
              {
                name: 'ðŸ¢ Slow Flight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/05_afh_ch4.pdf',
                items: [
                  { text: 'Maintain controlled flight 5-10 kts above stall (Â±100 ft)' },
                  { text: 'Turns, climbs, descents while slow' }
                ]
              },
              {
                name: 'ðŸ“‰ Stalls',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/05_afh_ch4.pdf',
                items: [
                  { text: 'Power-off stall - recognize & recover (min altitude loss)' },
                  { text: 'Power-on stall - recognize & recover (min altitude loss)' }
                ]
              },
              {
                name: 'ðŸŽ¯ Ground Reference',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/08_afh_ch7.pdf',
                items: [
                  { text: 'Turns around a point - maintain constant radius' }
                ]
              },
              {
                name: 'âš ï¸ Emergency Procedures',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/19_afh_ch18.pdf',
                items: [
                  { text: 'Engine failure - establish best glide immediately' },
                  { text: 'Select suitable landing site' },
                  { text: 'Demonstrate ability to make the field' }
                ]
              }
            ]
          },
          {
            name: 'Return & Landings',
            sections: [
              {
                name: 'ðŸ›¬ Landings',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/10_afh_ch9.pdf',
                items: [
                  { text: 'Navigate back to home base' },
                  { text: 'Normal landing - stabilized approach' },
                  { text: 'Short field landing (within 200 ft of point)' },
                  { text: 'Short field takeoff - obstacle clearance' },
                  { text: 'Go-around executed properly (full power, pitch, configure)' }
                ]
              }
            ]
          }
        ]
      },
      commercial: {
        name: 'Commercial Pilot',
        aircraft: 'Complex aircraft (retractable gear, constant-speed prop) or TAA',
        duration: '60-90 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Preflight & Departure',
            sections: [
              {
                name: 'ðŸ“‹ Preflight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/13_afh_ch12.pdf',
                items: [
                  { text: 'Performance calculations complete (takeoff/landing distance)' },
                  { text: 'Weight & balance at or near max gross' },
                  { text: 'Complex aircraft systems check (gear, prop, flaps)' },
                  { text: 'Takeoff - proper Vr/Vy, positive climb' }
                ]
              }
            ]
          },
          {
            name: 'Commercial Maneuvers',
            sections: [
              {
                name: 'â†©ï¸ Steep Turns (50Â° bank)',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/11_afh_ch10.pdf',
                items: [
                  { text: 'Clearing turns before maneuver' },
                  { text: '360Â° turn LEFT at 50Â° bank (Â±50 ft, Â±5 kts, Â±5Â°)' },
                  { text: '360Â° turn RIGHT at 50Â° bank (Â±50 ft, Â±5 kts, Â±5Â°)' }
                ]
              },
              {
                name: 'ðŸŽ­ Chandelles',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/11_afh_ch10.pdf',
                items: [
                  { text: 'Entry at Va or below' },
                  { text: '180Â° climbing turn, max pitch at 90Â° point' },
                  { text: 'Rollout at 180Â° just above stall, wings level' },
                  { text: 'Chandelle in opposite direction' }
                ]
              },
              {
                name: 'âˆž Lazy Eights',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/11_afh_ch10.pdf',
                items: [
                  { text: 'Entry at maneuvering speed' },
                  { text: '45Â° point: max pitch, 15Â° bank' },
                  { text: '90Â° point: level pitch, 30Â° bank, min airspeed' },
                  { text: '180Â° point: level flight, entry altitude/airspeed (Â±100 ft, Â±10 kts)' },
                  { text: 'Maneuver symmetric in opposite direction' }
                ]
              },
              {
                name: 'ðŸŒ€ Steep Spiral',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/11_afh_ch10.pdf',
                items: [
                  { text: 'Select ground reference point' },
                  { text: 'Constant radius maintained while descending (vary bank for wind)' },
                  { text: 'Complete 3 full turns minimum' },
                  { text: 'Recovery at safe altitude' }
                ]
              },
              {
                name: 'ðŸš¨ Emergency Descent',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/19_afh_ch18.pdf',
                items: [
                  { text: 'Reduce power, configure for max descent rate' },
                  { text: 'Maintain Vne/Vno limits' },
                  { text: 'Level off at target altitude' }
                ]
              }
            ]
          },
          {
            name: 'Precision Landings',
            sections: [
              {
                name: 'ðŸŽ¯ Power-Off 180Â°',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/10_afh_ch9.pdf',
                items: [
                  { text: 'Abeam touchdown point, power to idle' },
                  { text: 'Plan and execute glide to runway' },
                  { text: 'Touch down within accuracy zone (within 200 ft)' }
                ]
              },
              {
                name: 'ðŸ›¬ Short Field',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/10_afh_ch9.pdf',
                items: [
                  { text: 'Short field approach - stabilized, on speed' },
                  { text: 'Short field landing (within 100 ft of point)' },
                  { text: 'Short field takeoff - obstacle clearance (Vx to 50 ft, then Vy)' }
                ]
              }
            ]
          }
        ]
      },
      atp: {
        name: 'Airline Transport Pilot',
        aircraft: 'Multi-engine or turbine with IFR capability',
        duration: '60-90 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'IFR Departure',
            sections: [
              {
                name: 'ðŸ“‹ Departure',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_1.pdf',
                items: [
                  { text: 'IFR flight plan reviewed/filed' },
                  { text: 'ATIS/weather obtained' },
                  { text: 'IFR clearance copied correctly' },
                  { text: 'Departure procedure set in avionics' },
                  { text: 'Instrument takeoff - transition to gauges' },
                  { text: 'Fly SID or radar vectors, maintain clearance' }
                ]
              }
            ]
          },
          {
            name: 'Enroute & Holding',
            sections: [
              {
                name: 'âœˆï¸ Enroute',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_2.pdf',
                items: [
                  { text: 'Track airway/GPS route accurately' },
                  { text: 'Altitude maintained (Â±0 ft at assigned - ATP standard)' },
                  { text: 'Heading maintained (Â±5Â°)' }
                ]
              },
              {
                name: 'ðŸ”„ Holding',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_3.pdf',
                items: [
                  { text: 'Identify correct hold entry type (direct/teardrop/parallel)' },
                  { text: 'Execute entry procedure' },
                  { text: 'Maintain hold pattern - 2 circuits minimum (Â±100 ft)' }
                ]
              }
            ]
          },
          {
            name: 'Precision Approach',
            sections: [
              {
                name: 'ðŸ“¡ ILS Approach',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_4.pdf',
                items: [
                  { text: 'Approach briefed (ATIS, plate, minimums)' },
                  { text: 'Cleared for approach, configure aircraft' },
                  { text: 'Localizer intercept and track (within 1 dot)' },
                  { text: 'Glideslope intercept and track (within 1 dot)' },
                  { text: 'Airspeed stabilized on approach (Â±5 kts)' },
                  { text: 'At DA - call "minimums"' },
                  { text: 'Missed approach executed (runway not in sight)' }
                ]
              },
              {
                name: 'ðŸ” Missed Approach',
                items: [
                  { text: 'Immediate power, pitch, configure' },
                  { text: 'Fly published missed procedure' },
                  { text: 'Report missed to ATC' }
                ]
              }
            ]
          },
          {
            name: 'Second Approach & Landing',
            sections: [
              {
                name: 'ðŸ“» Non-Precision Approach',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_4.pdf',
                items: [
                  { text: 'Approach briefed' },
                  { text: 'Step-downs or vertical guidance followed' },
                  { text: 'MDA/DA reached, runway environment in sight' },
                  { text: 'Transition to visual, land' }
                ]
              }
            ]
          },
          {
            name: 'Abnormal Procedures',
            sections: [
              {
                name: 'âš ï¸ Engine Failure (Multi) or Partial Panel (Single)',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/14_afh_ch13.pdf',
                items: [
                  { text: 'Engine failure - identify (dead foot/dead engine)' },
                  { text: 'Verify - throttle confirms failed engine' },
                  { text: 'Feather - secure failed engine' },
                  { text: 'Maintain aircraft control, Vyse (blue line)' },
                  { text: 'Single-engine approach or go-around' }
                ]
              }
            ]
          }
        ]
      },
      night: {
        name: 'Night Rating',
        aircraft: 'Any aircraft with required night lighting',
        duration: '45-60 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Night Preflight',
            sections: [
              {
                name: 'ðŸ”¦ Equipment Check',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/12_afh_ch11.pdf',
                items: [
                  { text: 'Flashlight available (white and red)' },
                  { text: 'Position lights operational (red/green/white)' },
                  { text: 'Anti-collision lights operational' },
                  { text: 'Landing light operational' },
                  { text: 'Cockpit/instrument lighting functional' }
                ]
              }
            ]
          },
          {
            name: 'Night Departure & Navigation',
            sections: [
              {
                name: 'ðŸŒ™ Night Flight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/12_afh_ch11.pdf',
                items: [
                  { text: 'Taxi with landing light' },
                  { text: 'Visual references identified before takeoff' },
                  { text: 'Instrument cross-check during climb' },
                  { text: 'Navigate using ground lights and instruments' },
                  { text: 'Maintain situational awareness (no false horizons)' }
                ]
              }
            ]
          },
          {
            name: 'Night Landings',
            sections: [
              {
                name: 'ðŸ›¬ Landings',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/12_afh_ch11.pdf',
                items: [
                  { text: 'Enter traffic pattern at destination' },
                  { text: 'VASI/PAPI used for glidepath' },
                  { text: 'Night landing #1 - full stop' },
                  { text: 'Night landing #2 - full stop' },
                  { text: 'Night landing #3 - full stop' },
                  { text: 'Return to home base' },
                  { text: 'Final landing at home base' }
                ]
              }
            ]
          },
          {
            name: 'Emergency Procedures',
            sections: [
              {
                name: 'âš ï¸ Night Emergency',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/12_afh_ch11.pdf',
                items: [
                  { text: 'Simulated electrical failure - fly with minimal lighting' },
                  { text: 'Identify suitable emergency landing area at night (look for lit areas)' }
                ]
              }
            ]
          }
        ]
      },
      instrument: {
        name: 'Instrument Rating',
        aircraft: 'IFR-equipped aircraft (GPS or VOR/ILS capable)',
        duration: '60-75 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'IFR Preflight & Departure',
            sections: [
              {
                name: 'ðŸ“‹ IFR Planning',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_1.pdf',
                items: [
                  { text: 'Weather briefing obtained (departure, enroute, destination)' },
                  { text: 'IFR flight plan filed' },
                  { text: 'Approach plates reviewed and available' },
                  { text: 'Alternate identified (if required)' },
                  { text: 'IFR clearance copied and read back correctly' },
                  { text: 'Departure procedure programmed' },
                  { text: 'Instrument takeoff - transition to gauges immediately' }
                ]
              }
            ]
          },
          {
            name: 'Enroute & Holding',
            sections: [
              {
                name: 'âœˆï¸ Enroute',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_2.pdf',
                items: [
                  { text: 'Track VOR radial or GPS course accurately' },
                  { text: 'Altitude maintained (Â±100 ft)' },
                  { text: 'Heading maintained (Â±10Â°)' }
                ]
              },
              {
                name: 'ðŸ”„ Holding',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_3.pdf',
                items: [
                  { text: 'Identify correct entry type (direct/teardrop/parallel)' },
                  { text: 'Execute entry procedure correctly' },
                  { text: 'Maintain holding pattern - 2 circuits minimum' }
                ]
              }
            ]
          },
          {
            name: 'Precision Approach',
            sections: [
              {
                name: 'ðŸ“¡ ILS Approach',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_4.pdf',
                items: [
                  { text: 'Approach briefed (frequencies, courses, minimums)' },
                  { text: 'Localizer intercepted and tracked (Â±1 dot)' },
                  { text: 'Glideslope intercepted and tracked (Â±1 dot)' },
                  { text: 'Airspeed stabilized (Â±10 kts)' },
                  { text: 'Decision altitude - "minimums" call' },
                  { text: 'Missed approach executed' },
                  { text: 'Published missed procedure flown correctly' }
                ]
              }
            ]
          },
          {
            name: 'Non-Precision Approach',
            sections: [
              {
                name: 'ðŸ“» VOR/GPS Approach',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/instrument_procedures_handbook/FAA-H-8083-16B_Chapter_4.pdf',
                items: [
                  { text: 'Approach briefed' },
                  { text: 'Course tracked accurately' },
                  { text: 'Step-downs or CDFA executed correctly' },
                  { text: 'MDA reached, runway in sight' },
                  { text: 'Transition to visual, land' }
                ]
              }
            ]
          },
          {
            name: 'Unusual Attitudes & Partial Panel',
            sections: [
              {
                name: 'ðŸ”§ Partial Panel',
                items: [
                  { text: 'Unusual attitude recovery - nose high' },
                  { text: 'Unusual attitude recovery - nose low' },
                  { text: 'Partial panel flight (AI/HI failed) - maintain control' }
                ]
              }
            ]
          }
        ]
      },
      multiEngine: {
        name: 'Multi-Engine Rating',
        aircraft: 'Multi-engine aircraft (Baron, Seminole, etc.)',
        duration: '45-60 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Multi-Engine Preflight',
            sections: [
              {
                name: 'ðŸ“‹ Systems',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/14_afh_ch13.pdf',
                items: [
                  { text: 'Both engines preflight complete' },
                  { text: 'Propeller systems check (feathering capability)' },
                  { text: 'Fuel system - crossfeed understood' },
                  { text: 'Critical engine and Vmc awareness demonstrated' },
                  { text: 'Normal twin-engine takeoff' }
                ]
              }
            ]
          },
          {
            name: 'Normal Maneuvers',
            sections: [
              {
                name: 'âœˆï¸ Maneuvers',
                items: [
                  { text: 'Steep turns (45Â° bank) - Â±100 ft, Â±10 kts' },
                  { text: 'Slow flight - maintain control (Â±100 ft)' },
                  { text: 'Power-off stall - recognize and recover (min altitude loss)' },
                  { text: 'Power-on stall - recognize and recover (min altitude loss)' }
                ]
              }
            ]
          },
          {
            name: 'Engine Failure Procedures',
            sections: [
              {
                name: 'âš ï¸ Engine Failure',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/14_afh_ch13.pdf',
                items: [
                  { text: 'Engine failure - IDENTIFY (dead foot = dead engine)' },
                  { text: 'Engine failure - VERIFY (throttle to confirm)' },
                  { text: 'Engine failure - FEATHER (secure failed engine)' },
                  { text: 'Maintain directional control throughout' },
                  { text: 'Establish Vyse (blue line)' },
                  { text: 'Single-engine flight - maintain altitude and heading' },
                  { text: 'Vmc demonstration (if safe altitude)' }
                ]
              }
            ]
          },
          {
            name: 'Single-Engine Operations',
            sections: [
              {
                name: 'ðŸ›¬ Single-Engine',
                items: [
                  { text: 'Single-engine approach' },
                  { text: 'Single-engine go-around' },
                  { text: 'Single-engine landing' },
                  { text: 'Or: Engine restart and normal landing' }
                ]
              }
            ]
          }
        ]
      },
      seaplane: {
        name: 'Seaplane Rating',
        aircraft: 'Floatplane (Cessna 172 on floats, de Havilland Beaver, etc.)',
        duration: '45-60 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Seaplane Preflight',
            sections: [
              {
                name: 'ðŸ›Ÿ Preflight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/seaplane_handbook/faa-h-8083-23-3.pdf',
                items: [
                  { text: 'Float/hull inspection - no damage or leaks' },
                  { text: 'Water rudders operational' },
                  { text: 'Bilge check - pumps functional' },
                  { text: 'Tie-down and mooring lines available' },
                  { text: 'Departure water area assessed (obstacles, traffic, wind)' }
                ]
              }
            ]
          },
          {
            name: 'Water Taxi',
            sections: [
              {
                name: 'ðŸŒŠ Taxi',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/seaplane_handbook/faa-h-8083-23-2.pdf',
                items: [
                  { text: 'Idle taxi - water rudders down' },
                  { text: 'Plow taxi - control yoke back' },
                  { text: 'Step taxi - on the step, water rudders up' },
                  { text: 'Crosswind taxi technique' },
                  { text: '360Â° turns while taxiing' }
                ]
              }
            ]
          },
          {
            name: 'Takeoffs',
            sections: [
              {
                name: 'ðŸ›« Water Takeoff',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/seaplane_handbook/faa-h-8083-23-3.pdf',
                items: [
                  { text: 'Normal water takeoff' },
                  { text: 'Crosswind water takeoff' },
                  { text: 'Glassy water takeoff (pitch attitude critical)' },
                  { text: 'Rough water takeoff' }
                ]
              }
            ]
          },
          {
            name: 'Landings',
            sections: [
              {
                name: 'ðŸ›¬ Water Landing',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/seaplane_handbook/faa-h-8083-23-3.pdf',
                items: [
                  { text: 'Normal water landing' },
                  { text: 'Crosswind water landing' },
                  { text: 'Glassy water landing (establish descent rate early)' },
                  { text: 'Confined area water landing' },
                  { text: 'Go-around from water approach' }
                ]
              }
            ]
          },
          {
            name: 'Docking & Beaching',
            sections: [
              {
                name: 'âš“ Docking',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/seaplane_handbook/faa-h-8083-23-2.pdf',
                items: [
                  { text: 'Approach to dock - wind awareness' },
                  { text: 'Docking procedure - engine shutdown timing' },
                  { text: 'Beaching procedure (if applicable)' },
                  { text: 'Securing aircraft' }
                ]
              }
            ]
          }
        ]
      },
      helicopter: {
        name: 'Helicopter Rating',
        aircraft: 'Helicopter (R22, R44, Bell 206, etc.)',
        duration: '45-60 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Preflight & Startup',
            sections: [
              {
                name: 'ðŸš Preflight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch08.pdf',
                items: [
                  { text: 'Rotor system inspection complete' },
                  { text: 'Flight controls - full range of motion, no binding' },
                  { text: 'Engine/transmission inspection' },
                  { text: 'Weight and balance within limits' },
                  { text: 'Startup procedure - proper rotor engagement' }
                ]
              }
            ]
          },
          {
            name: 'Hovering',
            sections: [
              {
                name: 'ðŸŽ¯ Hover',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch09.pdf',
                items: [
                  { text: 'Hover - maintain stable 3-5 ft AGL' },
                  { text: 'Hovering turns - 90Â°, 180Â°, 360Â°' },
                  { text: 'Hover taxi - forward, backward, sideways' },
                  { text: 'Crosswind hover - maintain position' }
                ]
              }
            ]
          },
          {
            name: 'Basic Maneuvers',
            sections: [
              {
                name: 'âœˆï¸ Flight',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch09.pdf',
                items: [
                  { text: 'Normal takeoff to hover' },
                  { text: 'Normal takeoff to forward flight' },
                  { text: 'Straight and level flight' },
                  { text: 'Climbs and descents' },
                  { text: 'Turns - shallow, medium, steep' },
                  { text: 'Traffic pattern entry and departure' }
                ]
              }
            ]
          },
          {
            name: 'Advanced Maneuvers',
            sections: [
              {
                name: 'ðŸ”ï¸ Advanced',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch10.pdf',
                items: [
                  { text: 'Steep approach to hover' },
                  { text: 'Shallow approach to hover' },
                  { text: 'Confined area operations - assess, approach, land' },
                  { text: 'Pinnacle/ridgeline operations (if terrain available)' },
                  { text: 'Slope landing (if terrain available)' }
                ]
              }
            ]
          },
          {
            name: 'Emergency Procedures',
            sections: [
              {
                name: 'âš ï¸ Autorotation',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch11.pdf',
                items: [
                  { text: 'Autorotation entry - immediate recognition' },
                  { text: 'Autorotation - straight ahead, maintain Nr/airspeed' },
                  { text: 'Autorotation - with turn to suitable landing area' },
                  { text: 'Power recovery from autorotation' },
                  { text: 'Simulated tail rotor failure (if safe conditions)' }
                ]
              }
            ]
          },
          {
            name: 'Landings',
            sections: [
              {
                name: 'ðŸ›¬ Landing',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/helicopter_flying_handbook/hfh_ch09.pdf',
                items: [
                  { text: 'Normal approach to hover' },
                  { text: 'Hover to landing' },
                  { text: 'Running landing (if conditions permit)' },
                  { text: 'Engine shutdown procedure' }
                ]
              }
            ]
          }
        ]
      },
      turbine: {
        name: 'Turbine Rating',
        aircraft: 'Turboprop (King Air, TBM, PC-12) or Jet (Citation, Phenom)',
        duration: '45-60 minutes',
        passingScore: 85,
        phases: [
          {
            name: 'Turbine Preflight & Systems',
            sections: [
              {
                name: 'ðŸ”¥ Systems',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/16_afh_ch15.pdf',
                items: [
                  { text: 'Turbine engine inspection - intake, exhaust, no FOD' },
                  { text: 'Fuel system - type, quantity, contamination check' },
                  { text: 'Engine start procedure - proper ITT/N1/N2 monitoring' },
                  { text: 'Hot start recognition and response' },
                  { text: 'Generator/electrical systems online' }
                ]
              }
            ]
          },
          {
            name: 'Turbine Operations',
            sections: [
              {
                name: 'ðŸ›« Operations',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/17_afh_ch16.pdf',
                items: [
                  { text: 'Normal takeoff - proper power setting, rotation' },
                  { text: 'Climb at recommended airspeed' },
                  { text: 'Power management - torque/ITT limits observed' },
                  { text: 'High altitude cruise (if capable)' },
                  { text: 'Descent planning - energy management' },
                  { text: 'Speed brake use (if equipped)' }
                ]
              }
            ]
          },
          {
            name: 'Maneuvers',
            sections: [
              {
                name: 'âœˆï¸ Maneuvers',
                items: [
                  { text: 'Steep turns (45Â° bank) - Â±100 ft, Â±10 kts' },
                  { text: 'Slow flight - approach configuration (Â±100 ft)' },
                  { text: 'Approach to stall - clean configuration' },
                  { text: 'Approach to stall - landing configuration' }
                ]
              }
            ]
          },
          {
            name: 'Approaches & Landings',
            sections: [
              {
                name: 'ðŸ›¬ Landings',
                items: [
                  { text: 'Normal approach - stabilized, proper speed' },
                  { text: 'Normal landing' },
                  { text: 'Short field approach and landing' },
                  { text: 'Go-around - proper power application, configuration' },
                  { text: 'No-flap or partial-flap approach (if appropriate)' }
                ]
              }
            ]
          },
          {
            name: 'Emergency Procedures',
            sections: [
              {
                name: 'âš ï¸ Emergencies',
                link: 'https://www.faa.gov/sites/faa.gov/files/regulations_policies/handbooks_manuals/aviation/airplane_handbook/16_afh_ch15.pdf',
                items: [
                  { text: 'Engine fire on start - identify and respond' },
                  { text: 'Engine failure in flight - secure, troubleshoot' },
                  { text: 'Emergency descent' },
                  { text: 'Electrical failure - load shedding' },
                  { text: 'Engine restart procedure (if applicable)' }
                ]
              }
            ]
          },
          {
            name: 'Shutdown',
            sections: [
              {
                name: 'ðŸ›‘ Shutdown',
                items: [
                  { text: 'Proper cooldown procedure observed' },
                  { text: 'Engine shutdown - correct sequence' },
                  { text: 'Post-flight inspection' }
                ]
              }
            ]
          }
        ]
      }
    };
    
    // === CHECKRIDE SCHEDULING ===
    
    function openCheckrideScheduler(email) {
      const modal = document.getElementById('checkrideModal');
      const content = document.getElementById('checkrideContent');
      
      // Check for 7-day cooldown from failed attempt FIRST
      const failedAttempt = S.checkrides?.failed?.find(f => f.gateKey === email.gateKey);
      if (failedAttempt && failedAttempt.retryAfter && compareGameTime(S.gameTime, failedAttempt.retryAfter) < 0) {
        const daysRemaining = Math.ceil(compareGameTime(failedAttempt.retryAfter, S.gameTime) / (24 * 60));
        alert(`You must wait ${daysRemaining} more day(s) before retaking this checkride.\n\nRetry available: ${formatGameTime(failedAttempt.retryAfter)}`);
        return;
      }
      
      const checklist = CHECKRIDE_CHECKLISTS[email.gateKey];
      if (!checklist) {
        alert('Checkride checklist not available for ' + email.certificateName);
        return;
      }
      
      // Determine checkride conditions based on type
      const isNightCheckride = email.gateKey === 'night';
      const isInstrumentCheckride = email.gateKey === 'instrument';
      
      // Generate time slot options based on checkride type
      const timeSlots = [];
      const minHour = S.gameTime.hour + 2;
      
      for (let d = 0; d < 7; d++) {
        const date = addDays(S.gameTime, d);
        
        if (isNightCheckride) {
          // Night checkride: 20:00-22:00 slots only
          for (let h = 20; h <= 22; h += 2) {
            if (d === 0 && h < minHour) continue;
            timeSlots.push({ ...date, hour: h, minute: 0 });
          }
        } else {
          // Day checkrides: 08:00-16:00
          for (let h = 8; h <= 16; h += 2) {
            if (d === 0 && h < minHour) continue;
            timeSlots.push({ ...date, hour: h, minute: 0 });
          }
        }
      }
      
      // Fallback if no slots
      if (timeSlots.length === 0) {
        const tomorrow = addDays(S.gameTime, 1);
        timeSlots.push({ ...tomorrow, hour: isNightCheckride ? 20 : 8, minute: 0 });
      }
      
      const timeOptions = timeSlots.map((slot, i) => {
        const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][new Date(slot.year, slot.month - 1, slot.day).getDay()];
        return `<option value="${i}">${dayName} ${slot.month}/${slot.day} at ${String(slot.hour).padStart(2, '0')}:00</option>`;
      }).join('');
      
      // Weather/conditions text based on checkride type
      let conditionsText, setupText;
      if (isNightCheckride) {
        conditionsText = 'Conditions: Night (after sunset), clear skies, visibility 10+ miles';
        setupText = 'Load your sim and set up the flight (Night time, VFR weather, appropriate aircraft)';
      } else if (isInstrumentCheckride) {
        conditionsText = 'Conditions: IMC (low ceiling 500-1000ft, visibility 1-3 miles)';
        setupText = 'Load your sim and set up the flight (IFR conditions, IFR-equipped aircraft)';
      } else {
        conditionsText = 'Conditions: Day VFR (clear skies, visibility 10+ miles)';
        setupText = 'Load your sim and set up the flight (VFR conditions, appropriate aircraft)';
      }
      
      // Store time slots for selection
      window._checkrideTimeSlots = timeSlots;
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0; font-size: 18px;">Schedule Checkride: ${email.certificateName}</h2>
          <button onclick="closeCheckrideModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">CHECKRIDE DETAILS</div>
            <div style="background: var(--bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px;">
              <div style="display: grid; gap: 6px;">
                <div><span style="color: var(--muted);">Certificate:</span> <strong>${checklist.name}</strong></div>
                <div><span style="color: var(--muted);">Aircraft:</span> ${checklist.aircraft}</div>
                <div><span style="color: var(--muted);">Duration:</span> ${checklist.duration}</div>
                <div><span style="color: var(--muted);">Fee:</span> <strong style="color: var(--warning);">$${email.fee.toLocaleString()}</strong></div>
              </div>
            </div>
          </div>
          
          <div>
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">YOUR EXAMINER</div>
            <div style="background: var(--bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 2px;">${email.examiner.name}</div>
              <div style="font-size: 11px; color: var(--muted);">Designated Pilot Examiner</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">FAA #${email.examiner.id}</div>
            </div>
          </div>
        </div>
        
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">SELECT DATE & TIME</div>
          <select id="checkrideTimeSelect" style="width: 100%; padding: 8px; background: var(--panel); border: 1px solid var(--border); color: var(--text); border-radius: 4px; font-size: 13px;">
            ${timeOptions}
          </select>
          <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">${conditionsText}</div>
        </div>
        
        <div style="background: rgba(88, 166, 255, 0.08); border: 1px solid var(--accent); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
          <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px; font-size: 12px;">ðŸ“‹ How This Works</div>
          <ol style="margin: 0; padding-left: 16px; color: var(--text); font-size: 12px; line-height: 1.5;">
            <li>Schedule your checkride using the dropdown above</li>
            <li>When it's time, open the checklist by clicking on the scheduled checkride in your Calendar</li>
            <li>${setupText}</li>
            <li>Keep the checklist visible on a second monitor or in the background</li>
            <li>Fly the checkride profile, checking off items as you complete them</li>
            <li>Your self-assessment determines pass/fail</li>
            <li>Pass = Certificate awarded! Fail = 7-day cooldown before retry</li>
          </ol>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="btn" onclick="closeCheckrideModal()">Cancel</button>
          <button class="btn" onclick="confirmCheckrideSchedule('${email.id}')" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">
            Confirm & Schedule
          </button>
        </div>
      `;
      
      modal.style.display = 'flex';
    }
    
    function closeCheckrideModal() {
      document.getElementById('checkrideModal').style.display = 'none';
      
      // Clean up any checkride email that was created but never scheduled
      // (happens when user opens scheduler then cancels)
      if (window._pendingCheckrideEmailId) {
        const email = S.emails.find(e => e.id === window._pendingCheckrideEmailId);
        if (email && email.status === 'pending') {
          // Check if there's no corresponding scheduled entry
          const hasScheduled = S.checkrides?.scheduled?.some(c => c.gateKey === email.gateKey);
          if (!hasScheduled) {
            S.emails = S.emails.filter(e => e.id !== window._pendingCheckrideEmailId);
            saveState();
          }
        }
        window._pendingCheckrideEmailId = null;
      }
    }
    window.closeCheckrideModal = closeCheckrideModal;
    
    function confirmCheckrideSchedule(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      // Get selected time slot
      const select = document.getElementById('checkrideTimeSelect');
      const slotIndex = parseInt(select.value);
      const selectedTime = window._checkrideTimeSlots[slotIndex];
      
      // Mark email as scheduled
      email.status = 'scheduled';
      email.scheduledTime = selectedTime;
      
      // Add to scheduled flights (so it shows on calendar)
      const scheduledCheckride = {
        id: uuid(),
        type: 'checkride',
        emailId: emailId,
        gateKey: email.gateKey,
        certificateName: email.certificateName,
        examiner: email.examiner,
        fee: email.fee,
        scheduledTime: selectedTime,
        status: 'scheduled'
      };
      
      S.checkrides.scheduled.push(scheduledCheckride);
      
      // Clear the pending tracking since it's now scheduled
      window._pendingCheckrideEmailId = null;
      
      closeCheckrideModal();
      saveState();
      render();
      
      alert(`Checkride scheduled!\n\n${email.certificateName}\nTime: ${formatGameTime(selectedTime)}\nExaminer: ${email.examiner.name}\n\nAdvance time to your appointment, then click the checkride on your calendar to begin.`);
    }
    window.confirmCheckrideSchedule = confirmCheckrideSchedule;
    
    // === CHECKRIDE EXECUTION ===
    
    function startCheckride(scheduledId) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
      if (!checklist) return;
      
      // Mark as in progress
      scheduled.status = 'in_progress';
      scheduled.startedAt = { ...S.gameTime };
      
      // Generate flight plan based on checkride type
      scheduled.flightPlan = generateCheckrideFlightPlan(scheduled.gateKey);
      
      // Initialize checklist state (simple - just track checked/unchecked)
      scheduled.checklistState = {
        items: {},
        totalItems: 0,
        checkedItems: 0
      };
      
      // Count items
      checklist.phases.forEach((phase, pi) => {
        phase.sections.forEach((section, si) => {
          section.items.forEach((item, ii) => {
            const key = `${pi}-${si}-${ii}`;
            scheduled.checklistState.items[key] = false;
            scheduled.checklistState.totalItems++;
          });
        });
      });
      
      saveState();
      openCheckrideChecklist(scheduled);
    }
    window.startCheckride = startCheckride;
    
    function generateCheckrideFlightPlan(gateKey) {
      const homeIcao = S.bases.primary || 'KJFK';
      const homeAirport = getAirport(homeIcao) || { name: 'Home Base', icao: homeIcao, latitude: 40.6413, longitude: -73.7781 };
      const homeName = homeAirport.name || homeIcao;
      
      // Helicopter checkride can use heliports, others require airports
      const isHeliCheckride = gateKey === 'helicopter';
      
      // Find nearby airports at appropriate distances
      // Filter: paved surface, no heliports (except for heli checkride), min 2500ft runway
      const nearbyAirports = Object.keys(AIRPORTS).map(icao => getAirport(icao)).filter(apt => {
        if (!apt || apt.icao === homeIcao) return false;
        if (!apt.latitude || !apt.longitude) return false;
        
        // Type filtering
        if (apt.type === 'closed') return false;
        if (apt.type === 'heliport' && !isHeliCheckride) return false;
        
        // For non-helicopter checkrides, require paved and sufficient runway
        if (!isHeliCheckride) {
          const runway = apt.runways && apt.runways[0];
          if (!runway) return false;
          const runwayLength = runway.length || runway.lengthFt || 0;
          if (runwayLength < 2500) return false;
          const surface = normalizeSurface(runway.surface);
          if (surface !== 'paved') return false;
        }
        
        const dist = calculateDistance(
          homeAirport.latitude, homeAirport.longitude,
          apt.latitude, apt.longitude
        );
        return dist >= 15 && dist <= 60;
      }).sort((a, b) => {
        // Prefer airports with longer runways for practice
        const aRwy = a.longestRunway || (a.runways?.[0]?.length) || 3000;
        const bRwy = b.longestRunway || (b.runways?.[0]?.length) || 3000;
        return bRwy - aRwy;
      }).slice(0, 3);
      
      // Name the airports
      const dest1 = nearbyAirports[0] || { icao: 'KABC', name: 'Regional Airport' };
      const dest2 = nearbyAirports[1] || { icao: 'KDEF', name: 'County Airport' };
      const dest3 = nearbyAirports[2] || { icao: 'KGHI', name: 'Municipal Airport' };
      
      const dest1Name = dest1.name || dest1.icao;
      const dest2Name = dest2.name || dest2.icao;
      
      // Generate route based on checkride type
      const plans = {
        private: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${dest2.icao} â†’ ${homeIcao}`,
          briefing: `Day VFR conditions. Depart ${homeName}, navigate cross-country to ${dest1Name} (${dest1.icao}) for pattern work and full-stop landing. Continue to ${dest2Name} (${dest2.icao}) practice area for maneuvers (steep turns, slow flight, stalls, ground reference). Return to ${homeName} for short field and soft field landings.`
        },
        commercial: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${homeIcao}`,
          briefing: `Day VFR conditions. Depart ${homeName}, proceed to ${dest1Name} (${dest1.icao}) practice area for commercial maneuvers: chandelles, lazy eights, steep spiral, eights on pylons. Return to ${homeName} for power-off 180Â° accuracy approach and short field landing.`
        },
        atp: {
          route: `${homeIcao} â†’ ${dest1.icao} (Hold) â†’ ILS â†’ Missed â†’ GPS â†’ ${homeIcao}`,
          briefing: `IFR conditions (ceiling 500-1000ft, visibility 1-3nm). IFR departure from ${homeName}, proceed to ${dest1Name} (${dest1.icao}) for published hold. Execute ILS approach to minimums with missed approach. Vectors to GPS approach, land ${homeName}.`
        },
        night: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${homeIcao}`,
          briefing: `Night conditions (after civil twilight), clear skies. Night departure from ${homeName}, navigate to ${dest1Name} (${dest1.icao}) for 3 full-stop night landings using VASI/PAPI. Return to ${homeName} for final night landing.`
        },
        instrument: {
          route: `${homeIcao} â†’ ${dest1.icao} (Hold) â†’ ILS â†’ VOR â†’ ${homeIcao}`,
          briefing: `IFR conditions (ceiling 500-1000ft, visibility 1-3nm). IFR departure from ${homeName}, proceed to ${dest1Name} (${dest1.icao}) for holding pattern entry. ILS approach with published missed. VOR or GPS approach to landing at ${homeName}.`
        },
        multiEngine: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${homeIcao}`,
          briefing: `Day VFR conditions. Depart ${homeName}, proceed to ${dest1Name} (${dest1.icao}) practice area for Vmc demonstration, engine shutdown/restart, single-engine maneuvers. Return to ${homeName} for single-engine approach and landing.`
        },
        seaplane: {
          route: `Water Base â†’ ${dest1.icao} (Water) â†’ Confined Area â†’ Dock`,
          briefing: `Day VFR conditions. Water taxi and step taxi operations. Normal and crosswind water takeoffs. Proceed to ${dest1Name} water area for glassy water and rough water techniques. Confined area operations. Return for docking and beaching.`
        },
        helicopter: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${homeIcao}`,
          briefing: `Day VFR conditions. Hover work at ${homeName} (IGE/OGE, pedal turns, hover taxi). Proceed to ${dest1Name} (${dest1.icao}) area for steep/shallow approaches, confined area, pinnacle operations. Autorotations. Return to ${homeName}.`
        },
        turbine: {
          route: `${homeIcao} â†’ ${dest1.icao} â†’ ${homeIcao}`,
          briefing: `Day VFR conditions. Turbine start and systems check at ${homeName}. High-performance departure. Proceed to ${dest1Name} (${dest1.icao}) for high-altitude maneuvers, approach to stall, steep turns. Emergency descent. Return to ${homeName} for normal and no-flap landings.`
        }
      };
      
      return plans[gateKey] || plans.private;
    }
    
    function openCheckrideChecklist(scheduled) {
      const modal = document.getElementById('checkrideModal');
      const content = document.getElementById('checkrideContent');
      const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
      
      content.innerHTML = renderCheckrideChecklistHTML(scheduled, checklist);
      modal.style.display = 'flex';
      updateCheckrideProgress(scheduled);
    }
    
    function renderCheckrideChecklistHTML(scheduled, checklist) {
      const passingScore = checklist.passingScore || 85;
      const flightPlan = scheduled.flightPlan || { route: 'TBD', briefing: 'Flight plan will be generated.' };
      
      let html = `
        <div style="position: sticky; top: 0; background: var(--panel); padding: 16px 0; margin: -24px -24px 16px -24px; padding: 16px 24px; border-bottom: 1px solid var(--border); z-index: 10;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 style="margin: 0;">${checklist.name} Checkride</h2>
            <span style="color: var(--muted);">Examiner: ${scheduled.examiner.name}</span>
          </div>
          <div style="background: var(--border); height: 8px; border-radius: 4px; overflow: hidden;">
            <div id="checkrideProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.3s;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 8px;">
            <span><strong id="checkrideCheckedCount">0</strong> / <span id="checkrideTotalCount">${scheduled.checklistState.totalItems}</span> items</span>
            <span><strong id="checkridePercent">0</strong>% complete (${passingScore}% to pass)</span>
          </div>
        </div>
        
        <div style="background: rgba(88, 166, 255, 0.08); border: 1px solid var(--accent); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px; font-size: 13px;">âœˆï¸ FLIGHT PLAN</div>
          <div style="font-family: monospace; font-size: 14px; color: var(--text); margin-bottom: 8px; letter-spacing: 1px;">${flightPlan.route}</div>
          <div style="font-size: 12px; color: var(--muted); line-height: 1.5;">${flightPlan.briefing}</div>
        </div>
      `;
      
      checklist.phases.forEach((phase, pi) => {
        html += `<div class="checkride-phase">${phase.name}<button onclick="checkAllPhase('${scheduled.id}', ${pi})" style="background: rgba(0,0,0,0.2); border: none; color: inherit; padding: 4px 12px; font-size: 11px; border-radius: 4px; cursor: pointer;">Check All</button></div>`;
        
        phase.sections.forEach((section, si) => {
          const linkHtml = section.link ? `<a href="${section.link}" target="_blank" style="color: var(--accent); font-size: 11px; margin-left: 8px;">ðŸ“– Reference</a>` : '';
          html += `<div class="checkride-section">${section.name}${linkHtml}</div>`;
          html += `<div class="checkride-checklist">`;
          
          section.items.forEach((item, ii) => {
            const key = `${pi}-${si}-${ii}`;
            const isChecked = scheduled.checklistState.items[key];
            html += `
              <div class="checkride-item ${isChecked ? 'checked' : ''}" 
                   onclick="toggleCheckrideItem('${scheduled.id}', '${key}')" data-key="${key}">
                <div class="checkride-checkbox"></div>
                <div style="flex: 1;">
                  <div>${item.text}</div>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
        });
      });
      
      // Examiner certification
      html += `
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-top: 24px;">
          <h3 style="font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;">Examiner Certification</h3>
          
          <p style="color: var(--text); line-height: 1.6; margin-bottom: 20px;">
            I certify that I have evaluated the applicant's performance on all checked tasks and that this record accurately reflects the results of this practical test conducted in accordance with the Airman Certification Standards.
          </p>
          
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--panel); border-radius: 6px;">
            <div>
              <div style="font-family: 'Brush Script MT', 'Segoe Script', cursive; font-size: 28px; color: var(--accent);">${scheduled.examiner.name}</div>
              <div style="font-size: 12px; color: var(--muted);">Designated Pilot Examiner â€¢ FAA Certificate #${scheduled.examiner.id}</div>
            </div>
            <div style="text-align: right; color: var(--muted); font-size: 13px;">${formatGameTime(S.gameTime)}</div>
          </div>
          
          <label style="display: flex; align-items: center; gap: 12px; margin-top: 20px; cursor: pointer;">
            <input type="checkbox" id="checkrideAcknowledge" onchange="updateCheckrideCompleteButton('${scheduled.id}')" style="width: 18px; height: 18px;">
            <span style="color: var(--text); font-size: 14px;">I acknowledge this evaluation is complete and accurate</span>
          </label>
        </div>
        
        <div style="text-align: center; padding: 24px 0;">
          <button id="checkrideCompleteBtn" class="btn" onclick="completeCheckride('${scheduled.id}')" disabled style="background: var(--success); color: var(--bg); border-color: var(--success); padding: 12px 32px; font-size: 16px;">
            Complete Checkride
          </button>
          <p id="checkrideCompleteHint" style="color: var(--muted); font-size: 12px; margin-top: 12px;">Check acknowledgment to submit</p>
        </div>
      `;
      
      return html;
    }
    
    function toggleCheckrideItem(scheduledId, key) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      // Toggle
      scheduled.checklistState.items[key] = !scheduled.checklistState.items[key];
      
      // Update count
      if (scheduled.checklistState.items[key]) {
        scheduled.checklistState.checkedItems++;
      } else {
        scheduled.checklistState.checkedItems--;
      }
      
      // Update UI
      const itemEl = document.querySelector(`.checkride-item[data-key="${key}"]`);
      if (itemEl) {
        itemEl.classList.toggle('checked', scheduled.checklistState.items[key]);
      }
      
      updateCheckrideProgress(scheduled);
      saveState();
    }
    window.toggleCheckrideItem = toggleCheckrideItem;
    
    function checkAllPhase(scheduledId, phaseIndex) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
      const phase = checklist.phases[phaseIndex];
      
      // Check if all items in phase are already checked
      let allChecked = true;
      phase.sections.forEach((section, si) => {
        section.items.forEach((item, ii) => {
          const key = `${phaseIndex}-${si}-${ii}`;
          if (!scheduled.checklistState.items[key]) allChecked = false;
        });
      });
      
      // Toggle all items
      phase.sections.forEach((section, si) => {
        section.items.forEach((item, ii) => {
          const key = `${phaseIndex}-${si}-${ii}`;
          const wasChecked = scheduled.checklistState.items[key];
          const newValue = !allChecked;
          
          if (wasChecked !== newValue) {
            scheduled.checklistState.items[key] = newValue;
            if (newValue) {
              scheduled.checklistState.checkedItems++;
            } else {
              scheduled.checklistState.checkedItems--;
            }
          }
          
          const itemEl = document.querySelector(`.checkride-item[data-key="${key}"]`);
          if (itemEl) itemEl.classList.toggle('checked', newValue);
        });
      });
      
      updateCheckrideProgress(scheduled);
      saveState();
    }
    window.checkAllPhase = checkAllPhase;
    
    function updateCheckrideProgress(scheduled) {
      const percent = Math.round((scheduled.checklistState.checkedItems / scheduled.checklistState.totalItems) * 100);
      
      const bar = document.getElementById('checkrideProgressBar');
      const countEl = document.getElementById('checkrideCheckedCount');
      const percentEl = document.getElementById('checkridePercent');
      
      if (bar) bar.style.width = percent + '%';
      if (countEl) countEl.textContent = scheduled.checklistState.checkedItems;
      if (percentEl) percentEl.textContent = percent;
      
      updateCheckrideCompleteButton(scheduled.id);
    }
    
    function updateCheckrideCompleteButton(scheduledId) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
      const passingScore = checklist?.passingScore || 85;
      
      const ackEl = document.getElementById('checkrideAcknowledge');
      const btn = document.getElementById('checkrideCompleteBtn');
      const hint = document.getElementById('checkrideCompleteHint');
      
      if (!ackEl || !btn || !hint) return;
      
      const percent = Math.round((scheduled.checklistState.checkedItems / scheduled.checklistState.totalItems) * 100);
      const acknowledged = ackEl.checked;
      
      // Enable button when acknowledged (can complete even below passing - will just fail)
      if (acknowledged) {
        btn.disabled = false;
        if (percent >= passingScore) {
          hint.textContent = `Ready to complete! (${percent}% - PASS)`;
          hint.style.color = 'var(--success)';
        } else {
          hint.textContent = `Submit as-is (${percent}% - will not pass, need ${passingScore}%)`;
          hint.style.color = 'var(--warning)';
        }
      } else {
        btn.disabled = true;
        hint.textContent = `${percent}% complete â€¢ Check acknowledgment to submit`;
        hint.style.color = 'var(--muted)';
      }
    }
    window.updateCheckrideCompleteButton = updateCheckrideCompleteButton;
    
    // === CHECKRIDE COMPLETION ===
    
    function completeCheckride(scheduledId) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
      const passingScore = checklist?.passingScore || 85;
      
      const state = scheduled.checklistState;
      const percent = (state.checkedItems / state.totalItems) * 100;
      const score = (percent / 20).toFixed(1); // Convert to 5-point scale
      
      // Determine pass/fail - simple percentage
      const passed = percent >= passingScore;
      
      // Remove from scheduled
      S.checkrides.scheduled = S.checkrides.scheduled.filter(c => c.id !== scheduledId);
      
      // Charge fee and record transaction
      S.cash -= scheduled.fee;
      S.transactions.push({
        id: uuid(),
        date: { ...S.gameTime },
        description: `Checkride Fee â€” ${scheduled.certificateName}`,
        amount: -scheduled.fee,
        balanceAfter: S.cash,
        category: 'training'
      });
      
      // Update financials
      if (S.financials) {
        S.financials.expensesThisMonth = (S.financials.expensesThisMonth || 0) + scheduled.fee;
        S.financials.expensesYTD = (S.financials.expensesYTD || 0) + scheduled.fee;
        S.financials.expensesAllTime = (S.financials.expensesAllTime || 0) + scheduled.fee;
      }
      
      // Record result
      const result = {
        id: uuid(),
        gateKey: scheduled.gateKey,
        certificateName: scheduled.certificateName,
        examiner: scheduled.examiner,
        fee: scheduled.fee,
        date: { ...S.gameTime },
        score: parseFloat(score),
        passed: passed,
        percent: Math.round(percent),
        passingScore: passingScore
      };
      
      if (passed) {
        S.checkrides.completed.push(result);
        
        // Award certificate/rating
        const gate = PROGRESSION_GATES[scheduled.gateKey];
        if (gate.type === 'certificate') {
          if (!S.pilot.certificates.includes(scheduled.gateKey)) {
            S.pilot.certificates.push(scheduled.gateKey);
          }
          
          // Generate business welcome email when PPL is earned
          if (scheduled.gateKey === 'private') {
            S.emails.push(generateBusinessWelcomeEmail());
            S.emails.push(generateReputationIntroEmail());
            // Finance intro email will be generated by ensureEmails on next cycle
            S.tutorialComplete = true;
          }
          
          // Generate commercial welcome email when Commercial is earned
          if (scheduled.gateKey === 'commercial') {
            S.emails.push(generateCommercialWelcomeEmail());
          }
        } else {
          if (!S.pilot.ratings.includes(scheduled.gateKey)) {
            S.pilot.ratings.push(scheduled.gateKey);
          }
        }
        
        // Remove the checkride email
        S.emails = S.emails.filter(e => !(e.type === 'checkride' && e.gateKey === scheduled.gateKey));
        
        // Celebration!
        showConfetti(80);
        const certName = PROGRESSION_GATES[scheduled.gateKey]?.name || scheduled.gateKey;
        showToast('ðŸŽ‰ Checkride Passed!', `Congratulations! You've earned your ${certName}.`, 'success', 5000);
        
      } else {
        // Failed - add retry date (7 days)
        result.retryAfter = addMinutes(S.gameTime, 7 * 24 * 60);
        S.checkrides.failed.push(result);
      }
      
      closeCheckrideModal();
      saveState();
      
      // Show result
      showCheckrideResult(result, passed);
    }
    window.completeCheckride = completeCheckride;
    
    function showCheckrideResult(result, passed) {
      const modal = document.getElementById('checkrideModal');
      const content = document.getElementById('checkrideContent');
      
      const stars = 'â˜…'.repeat(Math.floor(result.score)) + (result.score % 1 >= 0.5 ? 'Â½' : '') + 'â˜†'.repeat(5 - Math.ceil(result.score));
      
      let remarks;
      if (passed) {
        if (result.score >= 4.5) {
          remarks = "Outstanding performance. Your preparation was evident throughout. Congratulations!";
        } else if (result.score >= 4.0) {
          remarks = "Solid performance demonstrating the required knowledge and skill. Congratulations!";
        } else {
          remarks = "You've met the standards. Keep practicing to improve your skills. Congratulations!";
        }
      } else {
        remarks = `You scored ${result.percent}% but needed ${result.passingScore}% to pass. Review weak areas and schedule additional practice before retesting.`;
      }
      
      content.innerHTML = `
        <div style="text-align: center; padding: 24px 0;">
          <div style="font-size: 12px; color: var(--muted); letter-spacing: 2px; margin-bottom: 8px;">PRACTICAL TEST RESULTS</div>
          <h2 style="margin: 0 0 24px 0;">${result.certificateName}</h2>
          
          <div style="display: inline-block; padding: 16px 48px; border-radius: 8px; font-size: 28px; font-weight: 700; margin-bottom: 24px; ${passed ? 'background: rgba(63, 185, 80, 0.15); border: 2px solid var(--success); color: var(--success);' : 'background: rgba(248, 81, 73, 0.15); border: 2px solid var(--danger); color: var(--danger);'}">
            ${passed ? 'PASS' : 'FAIL'}
          </div>
          
          <div style="font-size: 48px; font-weight: 700; color: ${passed ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 8px;">${result.score}</div>
          <div style="font-size: 24px; margin-bottom: 8px;">${stars}</div>
          <div style="font-size: 12px; color: var(--muted);">PRACTICAL TEST SCORE</div>
        </div>
        
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin: 24px 0;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
            <div>
              <div style="font-size: 12px; color: var(--muted);">Your Score</div>
              <div style="font-size: 20px; font-weight: 600; color: ${result.percent >= result.passingScore ? 'var(--success)' : 'var(--danger)'};">${result.percent}%</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--muted);">Required</div>
              <div style="font-size: 20px; font-weight: 600;">${result.passingScore}%</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--muted);">Fee Paid</div>
              <div style="font-size: 20px; font-weight: 600;">$${result.fee.toLocaleString()}</div>
            </div>
          </div>
        </div>
        
        <div style="background: var(--bg); border-left: 3px solid ${passed ? 'var(--success)' : 'var(--warning)'}; padding: 16px; margin: 24px 0;">
          <div style="font-style: italic; color: var(--text); margin-bottom: 12px;">"${remarks}"</div>
          <div style="font-size: 12px; color: var(--muted);">â€” ${result.examiner.name}, Designated Pilot Examiner</div>
        </div>
        
        ${passed ? `
          <div class="cert-display">
            <div class="cert-header">UNITED STATES OF AMERICA â€¢ DEPARTMENT OF TRANSPORTATION</div>
            <div class="cert-title">${result.certificateName}</div>
            <div class="cert-pilot">${S.pilot.name || 'Pilot'}</div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 16px;">This certifies that the holder has met all requirements for issuance of this certificate.</div>
            <div style="margin: 16px 0;">
              <div style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: var(--accent);">${result.examiner.name}</div>
              <div style="font-size: 11px; color: var(--muted);">Designated Pilot Examiner</div>
            </div>
            <div class="cert-date">Issued: ${formatGameTime(result.date)}</div>
          </div>
        ` : `
          <div style="background: rgba(248, 81, 73, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 16px; text-align: center;">
            <div style="font-size: 14px; color: var(--danger); margin-bottom: 8px;">Retry available after 7-day waiting period</div>
            <div style="font-size: 12px; color: var(--muted);">A new checkride email will be sent when you're eligible</div>
          </div>
        `}
        
        <div style="text-align: center; padding-top: 24px;">
          <button class="btn" onclick="closeCheckrideModal(); render();" style="padding: 12px 32px;">
            ${passed ? 'View Your Certificate' : 'Return to Inbox'}
          </button>
        </div>
      `;
      
      modal.style.display = 'flex';
    }
    
    // === AUTO-CHECK FOR NEW CHECKRIDES ===
    
    function checkForNewCheckrides() {
      if (S.gameMode !== 'career') return;
      
      const hours = S.totalHoursFlown;
      
      Object.entries(PROGRESSION_GATES).forEach(([gateKey, gate]) => {
        // Skip if already earned
        if (gate.type === 'certificate' && S.pilot.certificates.includes(gateKey)) return;
        if (gate.type === 'rating' && S.pilot.ratings.includes(gateKey)) return;
        
        // Skip student (default)
        if (gateKey === 'student') return;
        
        // Skip if already have pending email
        if (S.emails.some(e => e.type === 'checkride' && e.gateKey === gateKey)) return;
        
        // Skip if already scheduled
        if (S.checkrides.scheduled.some(c => c.gateKey === gateKey)) return;
        
        // Skip if in cooldown from failed attempt
        const failedAttempt = S.checkrides.failed.find(f => f.gateKey === gateKey);
        if (failedAttempt && failedAttempt.retryAfter && compareGameTime(S.gameTime, failedAttempt.retryAfter) < 0) {
          return;
        }
        
        // Check eligibility
        let eligible = false;
        if (gate.type === 'certificate') {
          // Certificates require hours - generate email notification
          eligible = hours >= gate.hours;
        }
        // Ratings are now scheduled directly from Certs & Ratings page - no emails
        
        if (eligible) {
          const email = generateCheckrideEmail(gateKey);
          if (email) {
            S.emails.push(email);
            console.log(`Checkride available: ${gate.name}`);
          }
        }
      });
    }

    // Ensure all owned aircraft are certified
    function ensureOwnedCertified() {
      let changed = false;
      S.fleet.forEach(code => {
        if (!S.pilot.aircraftCertifications.includes(code)) {
          S.pilot.aircraftCertifications.push(code);
          changed = true;
        }
      });
      if (changed) {
        saveState();
      }
    }

    function goToPostFlight() {
      // Get the active contract to check fuel for owned aircraft
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === S.activeContractId);
      if (!scheduled) return;
      
      const contract = scheduled.contract;
      
      // Fuel check for owned aircraft only (contract pilot = owner provides fuel)
      if (contract.contractType === 'owned' || scheduled.isTutorial) {
        const aircraft = getAircraft(contract.aircraftCode);
        if (aircraft) {
          const fleetInfo = S.fleetData[contract.aircraftCode];
          if (fleetInfo) {
            const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed || 120;
            const fuelBurnRate = aircraft.fuel_burn_rate || 10;
            const flightHours = Math.max(1.0, contract.distance / cruiseSpeed);
            const fuelRequired = flightHours * fuelBurnRate;
            const reserve = fuelBurnRate * 0.75; // 45 min reserve
            const minFuelNeeded = fuelRequired + reserve;
            
            // Calculate what we can fly with current fuel (minus reserve)
            const usableFuel = fleetInfo.currentFuel - reserve;
            const rangeWithCurrentFuel = (usableFuel / fuelBurnRate) * cruiseSpeed;
            
            // Need at least 30% of trip distance to be safe for first leg
            const minimumFirstLeg = contract.distance * 0.3;
            
            if (fleetInfo.currentFuel < minFuelNeeded) {
              const shortfall = Math.ceil(minFuelNeeded - fleetInfo.currentFuel);
              
              // Can we at least make a safe first leg?
              if (rangeWithCurrentFuel >= minimumFirstLeg) {
                // Allow with warning - pilot needs to refuel enroute
                const fuelNeededEnroute = Math.ceil(shortfall);
                const confirmed = confirm(
                  `â›½ ENROUTE REFUELING REQUIRED\n\n` +
                  `This flight requires approximately ${Math.ceil(fuelRequired)} gallons.\n` +
                  `With 45-minute reserve, you need ${Math.ceil(minFuelNeeded)} gallons.\n` +
                  `Current fuel: ${Math.round(fleetInfo.currentFuel)} gallons\n\n` +
                  `You'll need to purchase ~${fuelNeededEnroute} gallons enroute.\n` +
                  `Current range: ~${Math.round(rangeWithCurrentFuel)} nm (with reserve)\n\n` +
                  `Plan your fuel stop(s) accordingly.\n\n` +
                  `Continue with flight?`
                );
                if (!confirmed) return;
                
                // Flag that this flight needs enroute refueling
                scheduled.needsEnrouteRefuel = true;
                scheduled.enrouteFuelNeeded = fuelNeededEnroute;
              } else {
                // Not enough fuel for even a safe first leg
                alert(
                  `â›½ INSUFFICIENT FUEL\n\n` +
                  `This flight requires approximately ${Math.ceil(fuelRequired)} gallons.\n` +
                  `With 45-minute reserve, you need ${Math.ceil(minFuelNeeded)} gallons.\n` +
                  `Current fuel: ${Math.round(fleetInfo.currentFuel)} gallons\n\n` +
                  `You are ${shortfall} gallons short!\n\n` +
                  `Refuel your aircraft, or plan fuel stops accordingly.\n` +
                  `(Use the Fleet tab to refuel)`
                );
                return;
              }
            }
          }
        }
      }
      
      // Reset fuel stops for this flight
      window._fuelStops = [];
      
      S.flightStarted = true;
      saveState();
      switchTab('postflight');
      render();
    }
    
    function cancelFlight() {
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === S.activeContractId);
      if (!scheduled) return;
      
      const contract = scheduled.contract;
      const isTutorial = scheduled.isTutorial || contract.contractType === 'tutorial';
      const hoursUntilStart = compareGameTime(contract.startTime, S.gameTime) / 60;
      
      // Tutorial flights don't generate complaints
      if (isTutorial) {
        if (!confirm('Cancel this training flight?')) {
          return;
        }
      } else if (hoursUntilStart < 24) {
        // Check if canceling within 24 hours of start time
        const confirmMessage = `WARNING: Canceling less than 24 hours before the flight will result in a complaint from the customer.\n\nFlight starts in ${Math.floor(hoursUntilStart)} hours.\n\nCancel anyway?`;
        if (!confirm(confirmMessage)) {
          return;
        }
        
        // Generate angry email
        const angryEmail = {
          id: uuid(),
          type: "complaint",
          from: contract.contractType === 'owned' ? "Dissatisfied Customer" : contract.aircraftName + " Charter",
          company: "Late Cancellation",
          subject: `LAST-MINUTE CANCELLATION - ${contract.from} â†’ ${contract.to}`,
          body: `We are extremely disappointed that you cancelled this flight with less than 24 hours notice.\n\nContract: ${contract.missionType}\nScheduled Start: ${formatGameTime(contract.startTime)}\nCancelled: ${formatGameTime(S.gameTime)}\n\nThis is unacceptable and has caused significant disruption to our operations. We will think twice before working with you again.`,
          status: "complaint",
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        };
        S.emails.push(angryEmail);
      } else {
        if (!confirm('Are you sure you want to cancel this flight? This cannot be undone.')) {
          return;
        }
      }
      
      // Remove from scheduled flights
      S.scheduledFlights = S.scheduledFlights.filter(sf => sf.contractId !== S.activeContractId);
      S.activeContractId = null;
      S.flightStarted = false;
      
      saveState();
      render();
      switchTab('calendar');
      
      if (isTutorial) {
        alert('Training flight cancelled.');
      } else {
        alert(hoursUntilStart < 24 ? 'Flight cancelled. Customer complaint recorded.' : 'Flight cancelled.');
      }
    }
    
    function calculateBlockTime(distance, cruiseSpeed) {
      const estimated = (distance / cruiseSpeed).toFixed(1);
      document.getElementById('blockTimeInput').value = estimated;
    }
    
    function calculateFuelRemaining(startingFuel, burnRate) {
      const blockTime = parseFloat(document.getElementById('blockTimeInput').value);
      if (!blockTime || blockTime <= 0) {
        alert('Enter block time first to estimate fuel remaining.');
        return;
      }
      const fuelUsed = burnRate * blockTime;
      const remaining = Math.max(0, startingFuel - fuelUsed).toFixed(1);
      document.getElementById('fuelRemainingInput').value = remaining;
    }
    
    // Enroute refueling management
    window._fuelStops = [];
    
    function addFuelStop() {
      const stopId = uuid();
      window._fuelStops.push({ id: stopId, gallons: 0, location: '' });
      renderFuelStops();
    }
    window.addFuelStop = addFuelStop;
    
    function removeFuelStop(stopId) {
      window._fuelStops = window._fuelStops.filter(s => s.id !== stopId);
      renderFuelStops();
    }
    window.removeFuelStop = removeFuelStop;
    
    function updateFuelStop(stopId, field, value) {
      const stop = window._fuelStops.find(s => s.id === stopId);
      if (stop) {
        stop[field] = field === 'gallons' ? parseFloat(value) || 0 : value;
        updateFuelStopsSummary();
      }
    }
    window.updateFuelStop = updateFuelStop;
    
    function renderFuelStops() {
      const container = document.getElementById('fuelStopsList');
      if (!container) return;
      
      if (window._fuelStops.length === 0) {
        container.innerHTML = '<div style="font-size: 12px; color: var(--muted); font-style: italic;">No fuel stops added</div>';
        document.getElementById('fuelStopsSummary').style.display = 'none';
        return;
      }
      
      let html = '';
      window._fuelStops.forEach((stop, idx) => {
        html += `
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; background: var(--bg); border-radius: 6px;">
            <span style="font-size: 11px; color: var(--muted); width: 50px;">Stop ${idx + 1}:</span>
            <input type="number" step="0.1" min="0" placeholder="Gallons" value="${stop.gallons || ''}" 
                   onchange="updateFuelStop('${stop.id}', 'gallons', this.value)"
                   style="width: 80px; padding: 6px; font-size: 12px;">
            <span style="font-size: 11px; color: var(--muted);">gal @</span>
            <input type="text" placeholder="ICAO (optional)" value="${stop.location || ''}" 
                   onchange="updateFuelStop('${stop.id}', 'location', this.value.toUpperCase())"
                   style="width: 80px; padding: 6px; font-size: 12px; text-transform: uppercase;">
            <button class="btn" onclick="removeFuelStop('${stop.id}')" style="font-size: 10px; padding: 4px 8px; border-color: var(--danger); color: var(--danger);">âœ•</button>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateFuelStopsSummary();
    }
    
    function updateFuelStopsSummary() {
      const summaryEl = document.getElementById('fuelStopsSummary');
      const totalFuelEl = document.getElementById('totalEnrouteFuel');
      const totalCostEl = document.getElementById('totalEnrouteCost');
      
      if (!summaryEl) return;
      
      const totalGallons = window._fuelStops.reduce((sum, s) => sum + (s.gallons || 0), 0);
      const fuelPrice = S.fuelPrices?.avgas || 6.50;
      const totalCost = totalGallons * fuelPrice;
      
      if (totalGallons > 0) {
        summaryEl.style.display = 'block';
        totalFuelEl.textContent = `${totalGallons.toFixed(1)} gal`;
        totalCostEl.textContent = formatCurrency(totalCost);
      } else {
        summaryEl.style.display = 'none';
      }
    }
    
    function getEnrouteFuelTotal() {
      return window._fuelStops.reduce((sum, s) => sum + (s.gallons || 0), 0);
    }
    window.getEnrouteFuelTotal = getEnrouteFuelTotal;

    function recordFlight() {
      const blockTime = parseFloat(document.getElementById('blockTimeInput').value);
      const fuelRemainingInput = document.getElementById('fuelRemainingInput');
      const fuelRemaining = fuelRemainingInput ? parseFloat(fuelRemainingInput.value) : null;
      
      // Get assessment ratings from dropdowns
      const navRating = parseInt(document.getElementById('navRating')?.value || 4);
      const landingRating = parseInt(document.getElementById('landingRating')?.value || 4);
      const proceduresRating = parseInt(document.getElementById('proceduresRating')?.value || 4);
      const comfortEl = document.getElementById('comfortRating');
      const hasComfort = comfortEl !== null;
      const comfortRating = hasComfort ? parseInt(comfortEl.value || 4) : null;
      const timeRating = parseInt(document.getElementById('timeRating')?.value || 4);
      
      // Calculate overall assessment (same logic as updateOverallRating)
      let weighted, minimum;
      if (hasComfort) {
        weighted = (landingRating * 0.25) + (proceduresRating * 0.20) + (navRating * 0.20) + (comfortRating * 0.20) + (timeRating * 0.15);
        minimum = Math.min(navRating, landingRating, proceduresRating, comfortRating, timeRating);
      } else {
        weighted = (landingRating * 0.30) + (proceduresRating * 0.25) + (navRating * 0.25) + (timeRating * 0.20);
        minimum = Math.min(navRating, landingRating, proceduresRating, timeRating);
      }
      let assessment = weighted;
      if (minimum <= 1) {
        assessment = Math.min(assessment, minimum + 1);
      }
      assessment = Math.round(assessment * 10) / 10;
      
      if (!blockTime || blockTime <= 0) {
        alert('Please enter a valid block time in hours.');
        return;
      }
      
      // Find contract in scheduled flights
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === S.activeContractId);
      const contract = scheduled ? scheduled.contract : null;
      
      if (!contract) return;
      
      // Only require fuel for owned aircraft (not contract flights)
      const isContractFlight = contract.contractType !== 'owned' && !scheduled.isTutorial;
      
      if (!isContractFlight && (isNaN(fuelRemaining) || fuelRemaining < 0)) {
        alert('Please enter fuel remaining.');
        return;
      }
      
      const aircraft = getAircraft(contract.aircraftCode);
      const fleetInfo = S.fleetData[contract.aircraftCode];
      
      // Check if player has PPL - everything is free/untracked before PPL
      const hasPPL = S.pilot.certificates.includes('private');
      
      // Get enroute fuel purchased
      const enrouteFuelPurchased = isContractFlight ? 0 : getEnrouteFuelTotal();
      
      // Calculate fuel used (only for owned aircraft)
      // Total available = starting fuel + enroute purchases
      const startingFuel = fleetInfo ? fleetInfo.currentFuel : aircraft.fuel_capacity;
      const totalFuelAvailable = startingFuel + enrouteFuelPurchased;
      const fuelUsed = isContractFlight ? 0 : (totalFuelAvailable - fuelRemaining);
      
      if (!isContractFlight && fuelUsed < 0) {
        alert(`Fuel math doesn't add up.\n\nStarting fuel: ${startingFuel.toFixed(1)} gal\nEnroute purchased: ${enrouteFuelPurchased.toFixed(1)} gal\nTotal available: ${totalFuelAvailable.toFixed(1)} gal\n\nFuel remaining (${fuelRemaining}) cannot exceed total available.`);
        return;
      }
      
      // Validate fuel remaining doesn't exceed tank capacity
      if (!isContractFlight && fuelRemaining > aircraft.fuel_capacity) {
        alert(`Fuel remaining (${fuelRemaining} gal) exceeds aircraft fuel capacity (${aircraft.fuel_capacity} gal).`);
        return;
      }
      
      // Calculate enroute fuel cost with difficulty multiplier
      const fuelPrice = getEffectiveFuelPrice(aircraft.fuel_type || '100LL');
      const enrouteFuelCost = Math.round(enrouteFuelPurchased * fuelPrice);
      
      // Update aircraft fuel (but auto-refuel if no PPL, skip for contract flights)
      if (fleetInfo && !isContractFlight) {
        if (hasPPL) {
          fleetInfo.currentFuel = fuelRemaining;
        } else {
          // Pre-PPL: Auto-refuel to full tank
          fleetInfo.currentFuel = aircraft.fuel_capacity;
        }
      }
      
      // Clear fuel stops for next flight
      window._fuelStops = [];
      
      // Get damage reports - both checkboxes (operational/regulatory) and dynamic incident rows
      const damageChecks = Array.from(document.querySelectorAll('.damage-check:checked')).map(cb => cb.value);
      const reportedIncidents = getReportedIncidents(); // New dynamic incident rows
      const notes = document.getElementById('flightNotes').value.trim();
      
      // Calculate condition impact based on assessment and damage
      // But skip condition tracking before PPL (training aircraft maintained by school)
      let conditionLoss = 0;
      
      if (hasPPL) {
        // Base condition loss from overall assessment (inverted: lower = more damage)
        if (assessment >= 4.5) conditionLoss = 1;
        else if (assessment >= 4.0) conditionLoss = 2;
        else if (assessment >= 3.0) conditionLoss = 5;
        else if (assessment >= 2.0) conditionLoss = 15;
        else if (assessment >= 1.0) conditionLoss = 30;
        else conditionLoss = 50;
        
        // Landing rating specifically affects aircraft condition
        if (landingRating <= 1) conditionLoss += 20; // Hard/crash landing
        else if (landingRating <= 2) conditionLoss += 10;
        else if (landingRating <= 3) conditionLoss += 3;
        
        // Condition impact from operational checkboxes (mostly no damage)
        const checkboxImpact = {
          'go_around': 0,
          'diversion': 0,
          'emergency': 5,
          'airspace_violation': 0,
          'runway_incursion': 0
        };
        
        damageChecks.forEach(dmg => {
          conditionLoss += checkboxImpact[dmg] || 0;
        });
        
        // Process dynamic incident rows - generate squawks with player-selected severity
        reportedIncidents.forEach(incident => {
          // Add condition loss based on player-selected severity
          conditionLoss += incident.conditionImpact;
          
          // Create squawk for this incident
          if (fleetInfo) {
            const mxData = getMxData(contract.aircraftCode);
            const baseCost = mxData?.repairCostPerPercent || 100;
            
            // Calculate cost based on severity
            const costMultipliers = {
              'minor': { min: 1, max: 3 },
              'moderate': { min: 2, max: 6 },
              'serious': { min: 6, max: 15 },
              'critical': { min: 15, max: 40 }
            };
            const range = costMultipliers[incident.severity] || { min: 1, max: 5 };
            const cost = Math.round(baseCost * (range.min + Math.random() * (range.max - range.min)));
            
            // Calculate labor hours for this squawk
            const laborHours = getSquawkLaborHours(incident.severity, incident.type);
            
            // Build description
            const severityLabel = SEVERITY_LEVELS[incident.severity]?.label || incident.severity;
            const description = `${incident.label} (${severityLabel}) - pilot reported`;
            
            // Create the squawk with all required fields
            const squawk = {
              id: 'squawk_dmg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
              category: incident.category,
              severity: incident.severity,
              description: description,
              cost: cost,
              laborHours: laborHours,
              incidentType: incident.type,
              conditionImpact: incident.conditionImpact,
              canDefer: incident.severity !== 'critical' && incident.severity !== 'serious',
              discoveredDate: { ...S.gameTime }
            };
            
            fleetInfo.squawks = fleetInfo.squawks || [];
            fleetInfo.squawks.push(squawk);
          }
        });
        
        if (fleetInfo) {
          fleetInfo.condition = Math.max(0, fleetInfo.condition - conditionLoss);
          // Update book value to reflect new condition
          updateAircraftBookValue(contract.aircraftCode);
          // Update MX status based on new squawks
          fleetInfo.mxStatus = getMxStatus(contract.aircraftCode);
        }
      }
      // Pre-PPL: No condition loss (flight school handles maintenance)
      
      // Get direct ops cost (with difficulty multiplier applied)
      const directOpsRate = getEffectiveDirectOps(aircraft);
      const directOpsCost = Math.round(directOpsRate * blockTime);
      
      // Check if this is a tutorial/training flight
      const isTutorialFlight = scheduled?.isTutorial || contract.contractType === 'tutorial';
      
      // ALL flights before PPL are free (building hours toward certificate)
      // After PPL: proficiency flights cost money, contract flights earn money
      const isProficiencyFlight = isTutorialFlight && hasPPL;
      const isFreeTraining = !hasPPL; // ANY flight before PPL is free
      
      // Calculate costs
      // Fuel cost for this flight = enroute fuel purchased only
      // Pre-flight fuel was already paid for when loaded via Fleet tab refueling
      const fuelPricePerGal = aircraft.fuel_type === '100LL' ? 6.44 : 6.28;
      const fuelCost = enrouteFuelCost;  // Only enroute fuel - tank fuel already paid for
      
      let revenue, maintenancePortion, fuelCosts, totalCosts, netProfit, directOpsCharged;
      
      if (isFreeTraining) {
        // Pre-PPL training flight: No revenue, no costs (building hours toward PPL)
        revenue = 0;
        directOpsCharged = 0;
        maintenancePortion = 0;
        fuelCosts = 0;
        totalCosts = 0;
        netProfit = 0;
      } else if (isProficiencyFlight) {
        // Post-PPL proficiency flight: Pay direct ops and fuel (no MX reserve since no revenue)
        revenue = 0;
        directOpsCharged = directOpsCost;
        maintenancePortion = 0; // No revenue = no MX reserve contribution
        fuelCosts = fuelCost;
        totalCosts = directOpsCharged + fuelCosts;
        netProfit = -totalCosts; // Negative - you're paying
        
      } else if (contract.contractType === "owned") {
        // Owned aircraft: Get revenue, pay direct ops, set aside MX reserve % of revenue
        // Apply owned revenue multiplier from difficulty settings
        revenue = applyRevenueMultiplier(contract.payment, false);
        directOpsCharged = directOpsCost;
        
        // Maintenance reserve is % of revenue (controlled by player's slider)
        const mxRate = (S.mxReserveRate ?? 15) / 100;
        maintenancePortion = Math.round(revenue * mxRate);
        
        fuelCosts = fuelCost;
        totalCosts = directOpsCharged + maintenancePortion + fuelCosts;
        netProfit = revenue - totalCosts;
        
        // Add to maintenance reserve
        S.maintenanceReserve += maintenancePortion;
      } else {
        // Contract/Charter Pilot: Flat fee, no costs (owner pays everything)
        // Apply contract revenue multiplier from difficulty settings
        revenue = applyRevenueMultiplier(Math.round(contract.contractRate * blockTime), true);
        directOpsCharged = 0;
        maintenancePortion = 0;
        fuelCosts = 0;
        totalCosts = 0;
        netProfit = revenue;
      }
      
      S.cash += netProfit;
      
      // Record separate transactions for proper P&L tracking
      const routeDesc = `${contract.from} â†’ ${contract.to}`;
      
      if (isFreeTraining) {
        // No transactions for pre-PPL training
      } else if (isProficiencyFlight) {
        // Proficiency flight: record direct ops and fuel as expenses
        if (directOpsCharged > 0) {
          recordTransaction(`Direct Ops â€” Proficiency Flight`, -directOpsCharged, 'operating');
        }
        if (fuelCosts > 0) {
          recordTransaction(`Fuel â€” Proficiency Flight`, -fuelCosts, 'fuel');
        }
      } else if (contract.contractType === "owned") {
        // Owned aircraft: record revenue and each expense separately
        if (revenue > 0) {
          recordTransaction(`${contract.missionType} â€” ${routeDesc}`, revenue, 'flight_revenue');
        }
        if (directOpsCharged > 0) {
          recordTransaction(`Direct Ops â€” ${routeDesc}`, -directOpsCharged, 'operating');
        }
        if (fuelCosts > 0) {
          recordTransaction(`Fuel â€” ${routeDesc}`, -fuelCosts, 'fuel');
        }
        if (maintenancePortion > 0) {
          recordTransaction(`MX Reserve â€” ${routeDesc}`, -maintenancePortion, 'maintenance');
        }
      } else {
        // Contract pilot: just record income (no expenses for operator)
        if (revenue > 0) {
          recordTransaction(`Contract Pilot â€” ${contract.aircraftName || 'Charter'}`, revenue, 'contract_income');
        }
      }
      
      // Capture hours before update for summary display
      const hoursBefore = S.totalHoursFlown;
      
      // Update pilot totals
      S.totalHoursFlown += blockTime;
      S.totalMilesFlown += contract.distance;
      
      // Update aircraft hours for owned aircraft (including proficiency flights)
      const shouldUpdateAircraftHours = (contract.contractType === 'owned' || isProficiencyFlight) && 
                                        contract.aircraftCode && 
                                        S.fleetData[contract.aircraftCode];
      if (shouldUpdateAircraftHours) {
        S.fleetData[contract.aircraftCode].hours = (S.fleetData[contract.aircraftCode].hours || 0) + blockTime;
        
        // Apply maintenance effects (condition degradation, hours tracking)
        applyFlightMxEffects(contract.aircraftCode, blockTime);
      }
      
      // Recalculate experience tier based on points (not hours/missions anymore)
      // XP is awarded below after conditions are determined
      
      // Track category hours added for summary
      let nightHoursAdded = 0;
      let instrumentHoursAdded = 0;
      
      // Determine flight conditions for XP bonuses and review
      const isNightFlight = contract.isNight || (contract.startTime && (contract.startTime.hour >= 20 || contract.startTime.hour < 5)) || scheduled?.trainingConditions?.isNight;
      const ifrWeather = ['Overcast', 'Light Rain', 'Broken Clouds', 'Fog', 'Low Ceiling'];
      const isIfrFlight = scheduled?.trainingConditions?.isIfr || ifrWeather.includes(contract.weather);
      const isEmergencyMission = MISSION_TYPES[contract.missionType]?.isEmergency || false;
      
      // Award experience points (unless proficiency/training)
      if (!isFreeTraining && !isProficiencyFlight) {
        const xpEarned = awardExperiencePoints(1, {
          isContract: isContractFlight,  // Uses existing declaration from earlier
          isNight: isNightFlight,
          isIFR: isIfrFlight,
          isEmergency: isEmergencyMission,
          missionType: contract.missionType,
          aircraftCode: contract.aircraftCode
        });
        
        // Generate review (maybe)
        // Damage = either old checkbox physical damage OR new dynamic incidents
        const checkboxDamage = damageChecks.some(d => d === 'emergency'); // Only emergency checkbox causes physical damage
        const hasDamage = checkboxDamage || reportedIncidents.length > 0;
        const expectedMinutes = (contract.distance / (aircraft.cruise_speed || 120)) * 60;
        const actualMinutes = blockTime * 60;
        
        const review = maybeGenerateReview({
          clientName: contract.clientName || 'Customer',
          clientTier: contract.clientTier || 'regional',
          missionType: contract.missionType,
          actualMinutes: actualMinutes,
          expectedMinutes: expectedMinutes,
          selfAssessment: assessment >= 4.5 ? 5 : 
                          assessment >= 3.5 ? 4 : 
                          assessment >= 2.5 ? 3 : 2,
          hasDamage: hasDamage,
          isNight: isNightFlight,
          isIFR: isIfrFlight,
          isEmergency: isEmergencyMission,
          origin: contract.from,
          destination: contract.to
        });
        
        if (review) {
          showToast('New Review', `${review.clientName} left a ${review.stars}-star review`, review.stars >= 4 ? 'success' : review.stars <= 2 ? 'warning' : 'info');
        }
        
        // Maybe generate tip for satisfied customers (owned aircraft only, not contract pilot)
        if (contract.contractType === 'owned' && !hasDamage) {
          const tipResult = maybeGenerateTip(review, assessment.overall, revenue, contract.clientTier);
          if (tipResult) {
            S.cash += tipResult.amount;
            recordTransaction(`Tip â€” ${contract.clientName || 'Customer'}`, tipResult.amount, 'tip');
            showToast('Tip Received! ðŸ’µ', `${contract.clientName || 'Customer'} left a ${formatCurrency(tipResult.amount)} tip`, 'success');
          }
        }
      }
      
      // Log hours to categories based on conditions
      if (S.pilot.hoursByCategory) {
        // Check for night conditions
        if (isNightFlight) {
          S.pilot.hoursByCategory.night = (S.pilot.hoursByCategory.night || 0) + blockTime;
          nightHoursAdded = blockTime;
        }
        
        // Check for IFR conditions (already determined above)
        if (isIfrFlight) {
          S.pilot.hoursByCategory.instrument = (S.pilot.hoursByCategory.instrument || 0) + blockTime;
          instrumentHoursAdded = blockTime;
        }
        
        // Log hours by aircraft category
        const aircraftCategory = aircraft.category || 'single_piston';
        if (aircraftCategory.includes('multi')) {
          S.pilot.hoursByCategory.multiEngine = (S.pilot.hoursByCategory.multiEngine || 0) + blockTime;
        }
        if (aircraftCategory === 'helicopter') {
          S.pilot.hoursByCategory.helicopter = (S.pilot.hoursByCategory.helicopter || 0) + blockTime;
        }
        if (aircraftCategory === 'amphibious' || aircraft.surfaces?.includes('water')) {
          S.pilot.hoursByCategory.seaplane = (S.pilot.hoursByCategory.seaplane || 0) + blockTime;
        }
        if (aircraft.fuel_type === 'Jet-A' && (aircraftCategory.includes('turboprop') || aircraftCategory.includes('jet'))) {
          S.pilot.hoursByCategory.turbine = (S.pilot.hoursByCategory.turbine || 0) + blockTime;
        }
      }
      
      // Add to pilot log
      S.pilotLog.push({
        date: { ...S.gameTime },
        aircraft: aircraft.name,
        aircraftCode: contract.aircraftCode,
        from: contract.from,
        to: contract.to,
        distance: contract.distance,
        blockTime: blockTime,
        missionType: contract.missionType,
        revenue: revenue,
        costs: totalCosts,
        profit: netProfit,
        assessment: assessment,
        fuelUsed: fuelUsed,
        enrouteFuelPurchased: enrouteFuelPurchased,
        contractType: contract.contractType,
        isTutorial: scheduled?.isTutorial || false,
        conditions: {
          night: contract.isNight || scheduled?.trainingConditions?.isNight || false,
          ifr: scheduled?.trainingConditions?.isIfr || false
        }
      });
      
      // Update mission counters
      S.pilot.missionsCompleted++;
      if (assessment >= 4.5) {
        S.pilot.missionsPerfect++;
      }
      
      // Advance game time by block time and round to 30 minutes
      const minutesToAdd = Math.round(blockTime * 60);
      S.gameTime = roundToHour(addMinutes(S.gameTime, minutesToAdd));
      
      // Remove from scheduled flights
      S.scheduledFlights = S.scheduledFlights.filter(sf => sf.contractId !== S.activeContractId);
      S.activeContractId = null;
      S.flightStarted = false;
      S.selectedEmailId = null;
      
      cleanupExpiredEmails();
      ensureEmails();
      checkForNewCheckrides();
      
      // Check for pending aircraft reassignment (positioning flight)
      if (S.pendingReassignment && S.pendingReassignment.aircraftCode === contract.aircraftCode) {
        const { aircraftCode: reassignCode, newBaseId } = S.pendingReassignment;
        assignAircraftToBase(reassignCode, newBaseId);
        const newBase = getBase(newBaseId);
        showToast('Aircraft Repositioned', `${reassignCode} now based at ${newBase?.icao}`, 'success');
        delete S.pendingReassignment;
      }
      
      saveState();
      render();
      switchTab('calendar');
      
      // Show post-flight summary modal
      showPostFlightSummary({
        route: `${contract.from} â†’ ${contract.to}`,
        aircraft: aircraft.name,
        missionType: contract.missionType,
        distance: contract.distance,
        blockTime: blockTime,
        fuelUsed: fuelUsed,
        enrouteFuelPurchased: enrouteFuelPurchased,
        aircraftCondition: fleetInfo?.condition,
        
        // Financial data
        revenue: revenue,
        directOpsCost: directOpsCharged,
        maintenancePortion: maintenancePortion,
        fuelCosts: fuelCosts,
        totalCosts: totalCosts,
        netProfit: netProfit,
        contractType: contract.contractType,
        
        // Hours data
        hoursBefore: hoursBefore,
        hoursAfter: S.totalHoursFlown,
        nightHours: nightHoursAdded,
        instrumentHours: instrumentHoursAdded,
        
        // Flight type flags
        isFreeTraining: isFreeTraining,
        isProficiencyFlight: isProficiencyFlight,
        
        // Assessment
        assessment: assessment
      });
    }

    // Status: 80% complete, ~1 minute remaining
    // Building rendering functions...

    function render() {
      // Fix any pilot/mission statuses from old code
      fixStaffMissionStatuses();
      
      checkForMissedFlights();
      checkCashWarnings();
      renderHeader();
      renderInbox();
      renderCalendar();
      renderFleet();
      renderFleetMaintenance();
      renderMarket();
      renderCertifications();
      renderPreflight();
      renderPostflight();
      renderFinancials();
      renderBases();
      renderCompanyOverview();
      renderCompanyReviews();
      renderCompanyInsurance();
      renderReputationSettings();
      renderPilotInfo();
      renderPilotLog();
      renderCertifications();
      renderMissionPreferences();
      renderGameSettings();
      renderFinancesPreferences();
      renderStaff();
      updateCompanyBanner();
      
      // Update game mode button text
      const gameModeBtn = document.getElementById('gameModeBtn');
      if (gameModeBtn) {
        gameModeBtn.textContent = S.gameMode === 'career' ? 'Switch to Sandbox' : 'Switch to Career';
      }
    }
    
    function renderFinancials() {
      const container = document.getElementById('financialsList');
      if (!container) return;
      
      // Calculate totals
      const loc = S.lineOfCredit || { balance: 0, limit: 25000, apr: 0.06 };
      const fin = S.financials || { revenueThisMonth: 0, expensesThisMonth: 0, revenueYTD: 0, expensesYTD: 0, revenueAllTime: 0, expensesAllTime: 0, retainedEarnings: 0, basesPropertyValue: 0 };
      const owner = S.ownerCompensation || { monthlySalary: 4000, ytdDraws: 0 };
      
      // Calculate fleet value using book value (stable, only changes with condition)
      // ONLY count OWNED aircraft - leased aircraft are not assets
      let fleetValue = 0;
      const fleetRows = (S.fleet || []).map(code => {
        const aircraft = AIRCRAFT[code];
        if (!aircraft) return '';
        const data = S.fleetData?.[code] || { condition: 100, year: S.gameTime.year, hours: 0 };
        const condition = data.condition || 100;
        
        // Check if this aircraft is leased (not an asset)
        const isLeased = (S.leases || []).some(l => l.aircraftCode === code);
        
        // Use stored book value, or calculate and store if not present (migration)
        let value = data.bookValue;
        if (value === undefined || value === null) {
          // Calculate for legacy saves that don't have bookValue
          const year = data.year || (S.gameTime.year - 5);
          const hours = data.hours || 0;
          value = calculateListingPrice(code, year, condition, hours, aircraft);
          // Store it so it stays stable going forward
          if (S.fleetData[code]) {
            S.fleetData[code].bookValue = value;
          }
        }
        
        // Only add to fleet value if OWNED (not leased)
        if (!isLeased) {
          fleetValue += value;
        }
        
        const conditionClass = condition >= 80 ? '' : 'warning';
        const leaseTag = isLeased ? '<span style="font-size:9px;color:var(--muted);margin-left:6px;">(LEASED)</span>' : '';
        return `
          <div class="ledger-row">
            <span class="label">
              ${aircraft.name}${leaseTag}
              <span class="ledger-condition-badge ${conditionClass}">${condition}%</span>
            </span>
            <span class="value">${isLeased ? '<span style="color:var(--muted);">â€”</span>' : formatCurrency(value)}</span>
          </div>
        `;
      }).join('');
      
      // Calculate total assets
      const totalCash = S.cash + S.maintenanceReserve;
      const totalAssets = totalCash + fleetValue;
      
      // Calculate liabilities (actual debt only)
      const locBalance = loc.balance || 0;
      let loanBalance = 0;
      
      // Build loan rows with monthly payment and details button
      const loanRows = (S.loans || []).map(loan => {
        loanBalance += loan.remainingBalance || 0;
        const aircraft = AIRCRAFT[loan.aircraftCode];
        const aircraftName = aircraft?.name || loan.aircraftCode;
        return `
          <div class="ledger-row" style="flex-wrap: wrap;">
            <span class="label" style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--accent); color: #000; font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600;">LOAN</span>
              ${aircraftName}
            </span>
            <span class="value negative">${formatCurrency(loan.remainingBalance)}</span>
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding-left: 50px;">
              <span style="font-size: 11px; color: var(--muted);">${formatCurrency(loan.monthlyPayment)}/mo â€¢ ${loan.paymentsRemaining} payments left</span>
              <button onclick="showFinancingDetails('loan', '${loan.id}')" style="font-size: 10px; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; cursor: pointer;">Details</button>
            </div>
          </div>
        `;
      }).join('');
      
      // Build lease rows - shown for reference but NOT as liabilities
      // Operating leases are just monthly expenses, not balance sheet debt
      const leaseRows = (S.leases || []).map(lease => {
        const aircraft = AIRCRAFT[lease.aircraftCode];
        const aircraftName = aircraft?.name || lease.aircraftCode;
        return `
          <div class="ledger-row" style="flex-wrap: wrap;">
            <span class="label" style="display: flex; align-items: center; gap: 8px;">
              <span style="background: var(--warning); color: #000; font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600;">LEASE</span>
              ${aircraftName}
            </span>
            <span class="value" style="color: var(--muted);">${formatCurrency(lease.monthlyPayment)}/mo</span>
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding-left: 50px;">
              <span style="font-size: 11px; color: var(--muted);">${lease.monthsRemaining} months remaining</span>
              <button onclick="showFinancingDetails('lease', '${lease.id}')" style="font-size: 10px; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; cursor: pointer;">Details</button>
            </div>
          </div>
        `;
      }).join('');
      
      // Total liabilities = actual debt only (LOC + loans), NOT operating leases
      const totalLiabilities = locBalance + loanBalance;
      
      // Calculate equity using proper accounting
      // Retained Earnings = cumulative profit (revenue - operating expenses)
      const retainedEarnings = (fin.revenueAllTime || 0) - (fin.expensesAllTime || 0);
      
      // Starting capital (owner's initial investment)
      const startingCapital = fin.startingCapital || 0;
      
      // All-time owner draws (equity distributions, not expenses)
      const allTimeDraws = owner.allTimeDraws || 0;
      
      // Total Equity = Starting Capital + Retained Earnings - Owner Draws
      const calculatedEquity = startingCapital + retainedEarnings - allTimeDraws;
      
      // This should equal Assets - Liabilities (accounting equation check)
      const totalEquity = totalAssets - totalLiabilities;
      
      // Get P&L period data
      const periodData = {
        month: { revenue: fin.revenueThisMonth || 0, expenses: fin.expensesThisMonth || 0 },
        ytd: { revenue: fin.revenueYTD || 0, expenses: fin.expensesYTD || 0 },
        all: { revenue: fin.revenueAllTime || 0, expenses: fin.expensesAllTime || 0 }
      };
      
      // LOC calculations
      const locUsedPct = loc.limit > 0 ? (locBalance / loc.limit) * 100 : 0;
      const locAvailable = loc.limit - locBalance;
      const locMinPayment = Math.max(100, Math.round(locBalance * (loc.minPaymentPct || 0.05)));
      
      // MX Reserve calculations
      const mxTarget = 20000; // Could be dynamic based on fleet
      const mxPct = Math.min(100, (S.maintenanceReserve / mxTarget) * 100);
      
      // Get recent transactions
      const recentTx = (S.transactions || []).slice(-10).reverse();
      
      container.innerHTML = `
        <div class="ledger-dashboard">
          <!-- Balance Sheet -->
          <div class="ledger-card">
            <div class="ledger-card-header">
              <div class="ledger-card-title">Balance Sheet</div>
            </div>
            
            <div class="ledger-section">
              <div class="ledger-section-header">Assets</div>
              <div class="ledger-row" ${S.gameMode === 'sandbox' ? 'style="cursor: pointer;" onclick="sandboxEditCash()"' : ''}>
                <span class="label">Available Cash ${S.gameMode === 'sandbox' ? '<span style="color: var(--accent); font-size: 10px;">âœŽ</span>' : ''}</span>
                <span class="value">${formatCurrency(S.cash)}</span>
              </div>
              <div class="ledger-row restricted" ${S.gameMode === 'sandbox' ? 'style="cursor: pointer;" onclick="sandboxEditMxReserve()"' : ''}>
                <span class="label">
                  Maintenance Reserve
                  ${S.gameMode === 'sandbox' ? '<span style="color: var(--accent); font-size: 10px;">âœŽ</span>' : '<span class="ledger-restricted-badge">ðŸ”’</span>'}
                </span>
                <span class="value">${formatCurrency(S.maintenanceReserve)}</span>
              </div>
              ${fleetRows}
              <div class="ledger-row total">
                <span class="label">Total Assets</span>
                <span class="value">${formatCurrency(totalAssets)}</span>
              </div>
            </div>
            
            <div class="ledger-section">
              <div class="ledger-section-header">Liabilities</div>
              ${locBalance > 0 ? `
                <div class="ledger-row">
                  <span class="label">Line of Credit</span>
                  <span class="value negative">${formatCurrency(locBalance)}</span>
                </div>
              ` : ''}
              ${loanRows}
              ${totalLiabilities === 0 ? '<div class="ledger-row" style="color: var(--muted); font-style: italic;">No liabilities</div>' : ''}
              <div class="ledger-row total">
                <span class="label">Total Liabilities</span>
                <span class="value ${totalLiabilities > 0 ? 'negative' : ''}">${formatCurrency(totalLiabilities)}</span>
              </div>
            </div>
            
            ${leaseRows ? `
            <div class="ledger-section">
              <div class="ledger-section-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Operating Leases</span>
                <span style="font-size: 10px; font-weight: 400; color: var(--muted);">Monthly expense, not debt</span>
              </div>
              ${leaseRows}
            </div>
            ` : ''}
            
            <div class="ledger-section">
              <div class="ledger-section-header">Equity</div>
              ${startingCapital > 0 ? `
                <div class="ledger-row">
                  <span class="label">Starting Capital</span>
                  <span class="value">${formatCurrency(startingCapital)}</span>
                </div>
              ` : ''}
              <div class="ledger-row">
                <span class="label">Retained Earnings</span>
                <span class="value ${retainedEarnings >= 0 ? '' : 'negative'}">${formatCurrency(retainedEarnings)}</span>
              </div>
              ${allTimeDraws > 0 ? `
                <div class="ledger-row">
                  <span class="label">Owner's Draws</span>
                  <span class="value negative">-${formatCurrency(allTimeDraws)}</span>
                </div>
              ` : ''}
              ${fin.basesPropertyValue > 0 ? `
                <div class="ledger-row">
                  <span class="label">Bases & Property</span>
                  <span class="value">${formatCurrency(fin.basesPropertyValue)}</span>
                </div>
              ` : ''}
              <div class="ledger-row total">
                <span class="label">Total Equity</span>
                <span class="value ${totalEquity >= 0 ? 'positive' : 'negative'}">${formatCurrency(totalEquity)}</span>
              </div>
              ${owner.ytdDraws > 0 ? `
                <div style="font-size: 10px; color: var(--muted); margin-top: 4px; padding-left: 4px;">
                  YTD draws: ${formatCurrency(owner.ytdDraws)}
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- P&L Summary -->
          <div class="ledger-card">
            <div class="ledger-card-header">
              <div class="ledger-card-title">Profit & Loss</div>
              <div class="ledger-period-tabs">
                <button class="ledger-period-tab active" onclick="switchLedgerPeriod('month')">This Month</button>
                <button class="ledger-period-tab" onclick="switchLedgerPeriod('ytd')">YTD</button>
                <button class="ledger-period-tab" onclick="switchLedgerPeriod('all')">All Time</button>
              </div>
            </div>
            
            <div class="ledger-summary-grid">
              <div class="ledger-summary-card">
                <div class="ledger-summary-label">Revenue</div>
                <div class="ledger-summary-value positive" id="ledgerRevenue">${formatCurrency(periodData.month.revenue)}</div>
              </div>
              <div class="ledger-summary-card">
                <div class="ledger-summary-label">Expenses</div>
                <div class="ledger-summary-value negative" id="ledgerExpenses">${formatCurrency(periodData.month.expenses)}</div>
              </div>
            </div>
            
            <div class="ledger-summary-card" style="text-align: center;">
              <div class="ledger-summary-label">Net Profit</div>
              <div class="ledger-summary-value ${periodData.month.revenue - periodData.month.expenses >= 0 ? 'positive' : 'negative'}" id="ledgerNet">
                ${formatCurrency(periodData.month.revenue - periodData.month.expenses)}
              </div>
            </div>
            
            <!-- Financial Health Inline -->
            ${renderFinancialHealthInline()}
            
            <!-- Owner Compensation -->
            <div class="ledger-owner-section">
              <div class="ledger-owner-salary">
                <div class="ledger-owner-info">
                  <span style="font-weight: 500;">Owner Salary</span>
                  <span style="font-size: 10px; color: var(--muted); margin-left: 6px;">1st of month</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="ledger-owner-amount">${formatCurrency(owner.monthlySalary)}</div>
                  <div class="ledger-owner-edit" onclick="showAdjustSalaryModal()">Adjust â†—</div>
                </div>
              </div>
            </div>
            
            <!-- Insurance Widget -->
            <div class="ledger-owner-section" style="margin-top: 12px;">
              <div class="ledger-owner-salary">
                <div class="ledger-owner-info">
                  <span style="font-weight: 500;">ðŸ›¡ï¸ Liability Insurance</span>
                  <span style="font-size: 10px; color: var(--muted); margin-left: 6px;">1st of month</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="text-align: right;">
                    <div class="ledger-owner-amount">${formatCurrency(S.insurance?.currentPremium || getEstimatedPremium())}</div>
                    <div style="font-size: 10px; color: var(--muted);">this month</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 14px; color: var(--text-secondary);">${formatCurrency(projectNextMonthPremium())}</div>
                    <div style="font-size: 10px; color: var(--muted);">next (est)</div>
                  </div>
                  <div class="ledger-owner-edit" onclick="showCompanyTab('insurance')">Details â†—</div>
                </div>
              </div>
            </div>
            
            <!-- Staff Payroll Widget -->
            ${(S.staff && S.staff.length > 0) || S.supportStaff?.marketing || S.supportStaff?.accountant ? `
            <div class="ledger-owner-section" style="margin-top: 12px;">
              <div class="ledger-owner-salary">
                <div class="ledger-owner-info">
                  <span style="font-weight: 500;">ðŸ‘¥ Staff Payroll</span>
                  <span style="font-size: 10px; color: var(--muted); margin-left: 6px;">1st of month</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="text-align: right;">
                    <div class="ledger-owner-amount">${formatCurrency(S.staff.reduce((sum, s) => sum + s.salary, 0) + (S.supportStaff?.marketing?.salary || 0) + (S.supportStaff?.accountant?.salary || 0))}</div>
                    <div style="font-size: 10px; color: var(--muted);">${S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0)} employee${(S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0)) !== 1 ? 's' : ''}</div>
                  </div>
                  <div class="ledger-owner-edit" onclick="switchToStaffTab()">Manage â†—</div>
                </div>
              </div>
            </div>
            ` : ''}
            
            <!-- Facility Upkeep Widget -->
            ${(() => {
              const upkeep = calculateMonthlyFacilityUpkeep();
              if (upkeep.total === 0) return '';
              return `
              <div class="ledger-owner-section" style="margin-top: 12px;">
                <div class="ledger-owner-salary">
                  <div class="ledger-owner-info">
                    <span style="font-weight: 500;">ðŸ—ï¸ Facility Upkeep</span>
                    <span style="font-size: 10px; color: var(--muted); margin-left: 6px;">1st of month</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="text-align: right;">
                      <div class="ledger-owner-amount">${formatCurrency(upkeep.total)}</div>
                      <div style="font-size: 10px; color: var(--muted);">${upkeep.hangars} hangar${upkeep.hangars !== 1 ? 's' : ''}, ${upkeep.tanks} tank${upkeep.tanks !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="ledger-owner-edit" onclick="switchToCompanyBasesTab()">Manage â†—</div>
                  </div>
                </div>
              </div>
              `;
            })()}
          </div>
        </div>
        
        <!-- Widgets Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
          <!-- MX Reserve Widget -->
          <div class="ledger-widget">
            <div class="ledger-widget-header">
              <span class="ledger-widget-title">ðŸ”§ Maintenance Reserve</span>
              <span style="font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; color: var(--warning);">${formatCurrency(S.maintenanceReserve)}</span>
            </div>
            <div class="ledger-mx-breakdown" style="margin-top: 8px;">
              <div class="ledger-mx-row" style="margin-bottom: 8px;">
                <span style="color: var(--muted); font-size: 11px;">Contribution Rate:</span>
                <span style="font-size: 12px; font-weight: 600;">${S.mxReserveRate ?? 15}% of revenue</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="range" min="0" max="30" step="1" value="${S.mxReserveRate ?? 15}" 
                       onchange="updateMxReserveRate(this.value)" 
                       style="flex: 1; cursor: pointer;">
                <span style="font-size: 11px; color: var(--muted); width: 35px;">${S.mxReserveRate ?? 15}%</span>
              </div>
              <div style="font-size: 10px; color: var(--muted);">Industry standard: 10-20%. Higher = more saved for repairs.</div>
            </div>
            <div class="ledger-widget-actions" style="margin-top: 8px;">
              <button onclick="tapMaintenanceReserve()" ${S.maintenanceReserve <= 0 ? 'disabled' : ''} 
                      style="background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger);">
                âš ï¸ Tap Reserve (Emergency)
              </button>
            </div>
          </div>
          
          <!-- LOC Widget -->
          <div class="ledger-widget">
            <div class="ledger-widget-header">
              <span class="ledger-widget-title">Line of Credit</span>
              <span class="ledger-widget-rate">${(loc.apr * 100).toFixed(1)}% APR</span>
            </div>
            <div class="ledger-widget-bar">
              <div class="ledger-widget-bar-fill loc" style="width: ${locUsedPct}%;"></div>
            </div>
            <div class="ledger-widget-details">
              <div>
                <span class="label">Used:</span>
                <span class="value">${formatCurrency(locBalance)}</span>
              </div>
              <div>
                <span class="label">Available:</span>
                <span class="value">${formatCurrency(locAvailable)}</span>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
              Limit: ${formatCurrency(loc.limit)} (${getLenderTierTerms().name} tier)${locBalance > 0 ? ` â€¢ Min payment: ${formatCurrency(locMinPayment)}` : ''}
            </div>
            <div class="ledger-widget-actions">
              <button onclick="showLOCModal('draw')" ${locAvailable <= 0 ? 'disabled' : ''}>Draw Funds</button>
              <button class="primary" onclick="showLOCModal('pay')" ${locBalance <= 0 ? 'disabled' : ''}>Make Payment</button>
            </div>
          </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="ledger-card" style="margin-top: 16px;">
          <div class="ledger-card-header">
            <div class="ledger-card-title">Recent Transactions</div>
          </div>
          
          <div class="ledger-tx-list">
            ${recentTx.length === 0 ? `
              <div style="text-align: center; color: var(--muted); padding: 20px;">
                No transactions yet
              </div>
            ` : recentTx.map(tx => `
              <div class="ledger-tx-item">
                <div class="ledger-tx-info">
                  <div class="ledger-tx-title">${tx.description}</div>
                  <div class="ledger-tx-meta">${formatGameTime(tx.date)}</div>
                </div>
                <div>
                  <div class="ledger-tx-amount ${tx.amount >= 0 ? 'income' : 'expense'}">${tx.amount >= 0 ? '+' : ''}${formatCurrency(tx.amount)}</div>
                  <div class="ledger-tx-balance">${formatCurrency(tx.balanceAfter)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      // Store period data for tab switching
      container.dataset.periodData = JSON.stringify(periodData);
    }
    
    function toggleFinancialSliders() {
      const content = document.getElementById('financialSlidersContent');
      const toggle = document.getElementById('financialSlidersToggle');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = 'â–¼';
      } else {
        content.style.display = 'none';
        toggle.textContent = 'â–¶';
      }
    }
    window.toggleFinancialSliders = toggleFinancialSliders;
    
    function renderFinancialSlidersHtml() {
      const ds = S.difficultySettings || {};
      const ownedRev = ds.ownedRevenueMultiplier || 1.0;
      const contractRev = ds.contractRevenueMultiplier || 1.0;
      const fuelCost = ds.fuelCostMultiplier || 1.0;
      const opCost = ds.operatingCostMultiplier || 1.0;
      const interestRate = ds.interestRateMultiplier || 1.0;
      const insuranceCost = ds.insuranceCostMultiplier || 1.0;
      
      const fmtMult = (v) => v === 1.0 ? '1.0Ã—' : v.toFixed(2) + 'Ã—';
      const getColor = (v, invert = false) => {
        if (Math.abs(v - 1.0) < 0.01) return 'var(--muted)';
        if (invert) return v < 1 ? 'var(--success)' : 'var(--danger)';
        return v > 1 ? 'var(--success)' : 'var(--danger)';
      };
      
      return `
        <!-- Owned Aircraft Revenue -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Owned Aircraft Revenue</span>
            <span id="ownedRevValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(ownedRev)};">${fmtMult(ownedRev)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${ownedRev}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('ownedRevenueMultiplier', this.value, 'ownedRevValue')">
        </div>
        
        <!-- Contract Pilot Revenue -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Contract Pilot Revenue</span>
            <span id="contractRevValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(contractRev)};">${fmtMult(contractRev)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${contractRev}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('contractRevenueMultiplier', this.value, 'contractRevValue')">
        </div>
        
        <!-- Fuel Costs -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Fuel Costs</span>
            <span id="fuelCostValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(fuelCost, true)};">${fmtMult(fuelCost)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${fuelCost}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('fuelCostMultiplier', this.value, 'fuelCostValue', true)">
        </div>
        
        <!-- Operating Costs -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Operating Costs</span>
            <span id="opCostValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(opCost, true)};">${fmtMult(opCost)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${opCost}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('operatingCostMultiplier', this.value, 'opCostValue', true)">
        </div>
        
        <!-- Interest Rates -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Interest Rates</span>
            <span id="interestValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(interestRate, true)};">${fmtMult(interestRate)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${interestRate}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('interestRateMultiplier', this.value, 'interestValue', true)">
        </div>
        
        <!-- Insurance Costs -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-size: 12px;">Insurance Costs</span>
            <span id="insuranceValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(insuranceCost, true)};">${fmtMult(insuranceCost)}</span>
          </div>
          <input type="range" min="0.25" max="2" step="0.05" value="${insuranceCost}" 
                 style="width: 100%; accent-color: var(--accent);"
                 oninput="updateFinancialMultiplier('insuranceCostMultiplier', this.value, 'insuranceValue', true)">
        </div>
        
        <div style="text-align: center; padding-top: 8px; border-top: 1px solid var(--border);">
          <button class="btn" onclick="resetFinancialMultipliers(); renderFinancesPreferences();" style="font-size: 11px; padding: 6px 16px;">
            Reset All to Default (1.0Ã—)
          </button>
        </div>
      `;
    }
    
    function renderFinancialHealthInline() {
      // Ensure lenderAssessment exists
      if (!S.lenderAssessment) {
        S.lenderAssessment = { tier: 'startup', monthsInBusiness: 0, onTimePayments: 0, missedPayments: 0 };
      }
      
      const assessment = S.lenderAssessment;
      const tierTerms = getLenderTierTerms(assessment.tier);
      const metrics = calculateLenderMetrics();
      const nextReqs = getNextTierRequirements();
      
      // Tier badge color
      const tierColor = assessment.tier === 'premier' ? 'var(--success)' : 
                        assessment.tier === 'strong' ? '#22c55e' : 
                        assessment.tier === 'established' ? 'var(--accent)' : 
                        assessment.tier === 'developing' ? 'var(--warning)' : 'var(--muted)';
      const tierTextColor = assessment.tier === 'startup' ? 'var(--text)' : '#000';
      
      return `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--muted);">Financial Health</span>
            <span style="background: ${tierColor}; color: ${tierTextColor}; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">${tierTerms.name}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">DSCR:</span>
              <span style="font-weight: 500;">${metrics.dscr === 999 ? 'â€”' : metrics.dscr.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">Leverage:</span>
              <span style="font-weight: 500;">${metrics.leverageRatio === 999 ? 'â€”' : metrics.leverageRatio.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">Cash Reserve:</span>
              <span style="font-weight: 500;">${metrics.cashReserveMonths.toFixed(1)}mo</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">In Business:</span>
              <span style="font-weight: 500;">${assessment.monthsInBusiness}mo</span>
            </div>
          </div>
          
          <div style="background: var(--panel); border-radius: 4px; padding: 8px; font-size: 10px;">
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
              <span><span style="color: var(--muted);">APR:</span> ${(tierTerms.loanApr * 100).toFixed(0)}%</span>
              <span><span style="color: var(--muted);">Down:</span> ${(tierTerms.downPayment * 100).toFixed(0)}%</span>
              <span><span style="color: var(--muted);">Max:</span> ${formatCurrency(tierTerms.maxFinance)}</span>
            </div>
          </div>
          
          ${nextReqs && nextReqs.requirements.length > 0 ? `
            <div style="margin-top: 6px; font-size: 10px; color: var(--muted);">
              Next: ${nextReqs.nextTier} â€” ${nextReqs.requirements[0]}
            </div>
          ` : ''}
        </div>
      `;
    }
    
    function switchLedgerPeriod(period) {
      const container = document.getElementById('financialsList');
      if (!container) return;
      
      // Update active tab
      container.querySelectorAll('.ledger-period-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase().includes(period === 'month' ? 'month' : period === 'ytd' ? 'ytd' : 'all')) {
          tab.classList.add('active');
        }
      });
      
      // Get period data and update values
      const periodData = JSON.parse(container.dataset.periodData || '{}');
      const data = periodData[period] || { revenue: 0, expenses: 0 };
      const net = data.revenue - data.expenses;
      
      document.getElementById('ledgerRevenue').textContent = formatCurrency(data.revenue);
      document.getElementById('ledgerExpenses').textContent = formatCurrency(data.expenses);
      
      const netEl = document.getElementById('ledgerNet');
      netEl.textContent = formatCurrency(net);
      netEl.className = 'ledger-summary-value ' + (net >= 0 ? 'positive' : 'negative');
    }
    window.switchLedgerPeriod = switchLedgerPeriod;
    
    function showLOCModal(mode) {
      const loc = S.lineOfCredit || { balance: 0, limit: 25000 };
      const isDraw = mode === 'draw';
      const maxAmount = isDraw ? (loc.limit - loc.balance) : Math.min(loc.balance, S.cash);
      
      const modal = document.createElement('div');
      modal.className = 'loc-modal open';
      modal.id = 'locModal';
      modal.innerHTML = `
        <div class="loc-modal-content">
          <div class="loc-modal-title">${isDraw ? 'Draw Funds' : 'Make Payment'}</div>
          <div class="loc-modal-info">
            ${isDraw 
              ? `Available credit: ${formatCurrency(loc.limit - loc.balance)}`
              : `Outstanding balance: ${formatCurrency(loc.balance)}<br>Your cash: ${formatCurrency(S.cash)}`
            }
          </div>
          <input type="number" class="loc-modal-input" id="locAmount" placeholder="0" min="0" max="${maxAmount}" value="">
          <div class="loc-modal-actions">
            <button class="cancel" onclick="closeLOCModal()">Cancel</button>
            <button class="confirm" onclick="confirmLOC('${mode}')">${isDraw ? 'Draw Funds' : 'Make Payment'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('locAmount').focus();
    }
    window.showLOCModal = showLOCModal;
    
    function closeLOCModal() {
      const modal = document.getElementById('locModal');
      if (modal) modal.remove();
    }
    window.closeLOCModal = closeLOCModal;
    
    function confirmLOC(mode) {
      const amountInput = document.getElementById('locAmount');
      const amount = parseInt(amountInput.value) || 0;
      
      if (amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      const loc = S.lineOfCredit;
      
      if (mode === 'draw') {
        const available = loc.limit - loc.balance;
        if (amount > available) {
          alert(`Cannot draw more than available credit (${formatCurrency(available)})`);
          return;
        }
        loc.balance += amount;
        S.cash += amount;
        recordTransaction('LOC Draw', amount, 'loc');
        showToast('Funds Drawn', `${formatCurrency(amount)} added to cash`, 'success');
      } else {
        if (amount > S.cash) {
          alert(`Cannot pay more than your cash balance (${formatCurrency(S.cash)})`);
          return;
        }
        if (amount > loc.balance) {
          alert(`Cannot pay more than the outstanding balance (${formatCurrency(loc.balance)})`);
          return;
        }
        loc.balance -= amount;
        S.cash -= amount;
        recordTransaction('LOC Payment', -amount, 'loc');
        showToast('Payment Made', `${formatCurrency(amount)} paid toward LOC`, 'success');
      }
      
      closeLOCModal();
      saveState();
      render();
    }
    window.confirmLOC = confirmLOC;
    
    function showAdjustSalaryModal() {
      const current = S.ownerCompensation?.monthlySalary || 4000;
      const newSalary = prompt(`Enter new monthly salary (current: ${formatCurrency(current)}):`, current);
      if (newSalary !== null) {
        const amount = parseInt(newSalary);
        if (isNaN(amount) || amount < 0) {
          alert('Please enter a valid amount');
          return;
        }
        S.ownerCompensation.monthlySalary = amount;
        saveState();
        render();
        showToast('Salary Updated', `Monthly salary set to ${formatCurrency(amount)}`, 'info');
      }
    }
    window.showAdjustSalaryModal = showAdjustSalaryModal;
    
    function showFinancingDetails(type, id) {
      let content = '';
      
      if (type === 'loan') {
        const loan = (S.loans || []).find(l => l.id === id);
        if (!loan) {
          alert('Loan not found');
          return;
        }
        
        const aircraft = AIRCRAFT[loan.aircraftCode];
        const aircraftName = aircraft?.name || loan.aircraftCode;
        const fleetInfo = S.fleetData[loan.aircraftCode] || {};
        const condition = Math.round(fleetInfo.condition || 100);
        const year = fleetInfo.year || 2020;
        const hours = fleetInfo.hours || 0;
        
        // Calculate current market value and equity
        const marketValue = aircraft ? calculateListingPrice(loan.aircraftCode, year, condition, hours, aircraft) : 0;
        const equity = marketValue - loan.remainingBalance;
        const paidPercent = ((loan.termMonths - loan.paymentsRemaining) / loan.termMonths * 100).toFixed(1);
        const principalPaid = loan.originalAmount - loan.remainingBalance;
        
        content = `
          <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 16px;">Aircraft Loan Details</h3>
              <button onclick="this.closest('.financing-modal').style.display='none'" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
              <span style="background: var(--accent); color: #000; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600;">FINANCED</span>
              <span style="font-size: 15px; font-weight: 600;">${year} ${aircraftName}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">ORIGINAL LOAN</div>
                <div style="font-size: 16px; font-weight: 600;">${formatCurrency(loan.originalAmount)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">REMAINING BALANCE</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--danger);">${formatCurrency(loan.remainingBalance)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">MONTHLY PAYMENT</div>
                <div style="font-size: 16px; font-weight: 600;">${formatCurrency(loan.monthlyPayment)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">INTEREST RATE</div>
                <div style="font-size: 16px; font-weight: 600;">${(loan.interestRate * 100).toFixed(1)}% APR</div>
              </div>
            </div>
            
            <div style="background: var(--bg); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 11px; color: var(--muted);">PAYOFF PROGRESS</span>
                <span style="font-size: 11px; color: var(--muted);">${paidPercent}%</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${paidPercent}%; background: var(--accent); border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                <span><strong>${loan.termMonths - loan.paymentsRemaining}</strong> payments made</span>
                <span><strong>${loan.paymentsRemaining}</strong> remaining</span>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                Principal paid: ${formatCurrency(principalPaid)}
              </div>
            </div>
            
            <div style="background: rgba(63, 185, 80, 0.1); border: 1px solid var(--success); padding: 12px; border-radius: 6px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 10px; color: var(--success); margin-bottom: 4px;">CURRENT EQUITY</div>
                  <div style="font-size: 11px; color: var(--muted);">Market Value âˆ’ Loan Balance</div>
                </div>
                <div style="font-size: 20px; font-weight: 600; color: ${equity >= 0 ? 'var(--success)' : 'var(--danger)'};">
                  ${formatCurrency(equity)}
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
                Market value: ${formatCurrency(marketValue)} (${condition}% condition, ${hours.toLocaleString()} hrs)
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 16px;">
              <button onclick="makeLoanPayment('${id}')" style="flex: 1; padding: 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 13px;">
                ðŸ’µ Make Extra Payment
              </button>
              <button onclick="payoffLoan('${id}')" style="flex: 1; padding: 10px; background: var(--accent); border: 1px solid var(--accent); color: #000; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                âœ“ Pay Off Loan (${formatCurrency(loan.remainingBalance)})
              </button>
            </div>
          </div>
        `;
      } else if (type === 'lease') {
        const lease = (S.leases || []).find(l => l.id === id);
        if (!lease) {
          alert('Lease not found');
          return;
        }
        
        const aircraft = AIRCRAFT[lease.aircraftCode];
        const aircraftName = aircraft?.name || lease.aircraftCode;
        const fleetInfo = S.fleetData[lease.aircraftCode] || {};
        const condition = Math.round(fleetInfo.condition || 100);
        const usedPercent = ((lease.termMonths - lease.monthsRemaining) / lease.termMonths * 100).toFixed(1);
        const conditionOk = condition >= lease.returnCondition;
        const earlyTermFee = Math.min(lease.monthsRemaining, 2) * lease.monthlyPayment;
        const totalRemaining = lease.monthlyPayment * lease.monthsRemaining;
        
        content = `
          <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 16px;">Aircraft Lease Details</h3>
              <button onclick="this.closest('.financing-modal').style.display='none'" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
              <span style="background: var(--warning); color: #000; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600;">LEASED</span>
              <span style="font-size: 15px; font-weight: 600;">${aircraftName}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">MONTHLY PAYMENT</div>
                <div style="font-size: 16px; font-weight: 600;">${formatCurrency(lease.monthlyPayment)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">REMAINING OBLIGATION</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--danger);">${formatCurrency(totalRemaining)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">SECURITY DEPOSIT</div>
                <div style="font-size: 16px; font-weight: 600;">${formatCurrency(lease.securityDeposit)}</div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">LEASE TERM</div>
                <div style="font-size: 16px; font-weight: 600;">${lease.termMonths} months</div>
              </div>
            </div>
            
            <div style="background: var(--bg); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 11px; color: var(--muted);">LEASE PROGRESS</span>
                <span style="font-size: 11px; color: var(--muted);">${usedPercent}%</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${usedPercent}%; background: var(--warning); border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                <span><strong>${lease.termMonths - lease.monthsRemaining}</strong> months used</span>
                <span><strong>${lease.monthsRemaining}</strong> remaining</span>
              </div>
            </div>
            
            <div style="background: ${conditionOk ? 'rgba(63, 185, 80, 0.1)' : 'rgba(248, 81, 73, 0.1)'}; border: 1px solid ${conditionOk ? 'var(--success)' : 'var(--danger)'}; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
              <div style="font-size: 10px; color: ${conditionOk ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 6px;">RETURN CONDITION REQUIREMENT</div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <span style="font-size: 14px;">Current: <strong>${condition}%</strong></span>
                  <span style="margin: 0 8px; color: var(--muted);">â†’</span>
                  <span style="font-size: 14px;">Required: <strong>${lease.returnCondition}%</strong></span>
                </div>
                <span style="font-size: 20px;">${conditionOk ? 'âœ“' : 'âš ï¸'}</span>
              </div>
              ${!conditionOk ? `<div style="margin-top: 8px; font-size: 11px; color: var(--danger);">Aircraft condition is below return requirement. Maintenance needed before lease end.</div>` : ''}
            </div>
            
            <div style="background: rgba(210, 153, 34, 0.1); border: 1px solid var(--warning); padding: 12px; border-radius: 6px;">
              <div style="font-size: 10px; color: var(--warning); margin-bottom: 4px;">EARLY TERMINATION</div>
              <div style="font-size: 12px;">
                Fee: <strong>${formatCurrency(earlyTermFee)}</strong> (2 months payment) + forfeit ${formatCurrency(lease.securityDeposit)} deposit
              </div>
              <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
                Total cost to exit early: ${formatCurrency(earlyTermFee + lease.securityDeposit)}
              </div>
            </div>
            
            <div style="margin-top: 16px;">
              <button onclick="document.getElementById('financingModal').style.display='none'; cancelLease('${id}')" style="width: 100%; padding: 10px; background: var(--danger); border: 1px solid var(--danger); color: white; border-radius: 6px; cursor: pointer; font-size: 13px;">
                âœ— Cancel Lease Early
              </button>
            </div>
          </div>
        `;
      }
      
      // Create modal
      let modal = document.getElementById('financingModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'financingModal';
        modal.className = 'financing-modal';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;';
        modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        document.body.appendChild(modal);
      }
      
      modal.innerHTML = `<div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 480px; width: 90%; max-height: 90vh; overflow-y: auto;">${content}</div>`;
      modal.style.display = 'flex';
    }
    window.showFinancingDetails = showFinancingDetails;
    
    function makeLoanPayment(loanId) {
      const loan = (S.loans || []).find(l => l.id === loanId);
      if (!loan) {
        alert('Loan not found');
        return;
      }
      
      const aircraft = AIRCRAFT[loan.aircraftCode];
      const aircraftName = aircraft?.name || loan.aircraftCode;
      
      const amount = prompt(
        `Make extra payment on ${aircraftName} loan\n\n` +
        `Current Balance: ${formatCurrency(loan.remainingBalance)}\n` +
        `Your Cash: ${formatCurrency(S.cash)}\n\n` +
        `Enter payment amount:`,
        Math.min(S.cash, loan.remainingBalance)
      );
      
      if (amount === null) return;
      
      const payment = parseInt(amount);
      if (isNaN(payment) || payment <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      if (payment > S.cash) {
        alert(`Insufficient funds. You have ${formatCurrency(S.cash)}`);
        return;
      }
      
      if (payment > loan.remainingBalance) {
        alert(`Payment exceeds remaining balance of ${formatCurrency(loan.remainingBalance)}`);
        return;
      }
      
      // Apply payment to principal
      S.cash -= payment;
      loan.remainingBalance -= payment;
      
      // Recalculate payments remaining based on new balance
      if (loan.remainingBalance <= 0) {
        // Loan paid off
        loan.remainingBalance = 0;
        loan.paymentsRemaining = 0;
        S.loans = S.loans.filter(l => l.id !== loanId);
        
        recordTransaction(`Loan Payoff â€” ${aircraftName}`, -payment, 'loan_principal');
        showToast('Loan Paid Off!', `${aircraftName} is now owned free and clear`, 'success');
      } else {
        // Reduce payments remaining proportionally
        const originalBalance = loan.originalAmount || (loan.monthlyPayment * loan.termMonths);
        const paidPercent = 1 - (loan.remainingBalance / originalBalance);
        loan.paymentsRemaining = Math.ceil(loan.termMonths * (1 - paidPercent));
        
        recordTransaction(`Extra Loan Payment â€” ${aircraftName}`, -payment, 'loan_principal');
        showToast('Payment Applied', `${formatCurrency(payment)} applied to principal`, 'success');
      }
      
      // Close modal and refresh
      const modal = document.getElementById('financingModal');
      if (modal) modal.style.display = 'none';
      
      saveState();
      render();
    }
    window.makeLoanPayment = makeLoanPayment;
    
    function payoffLoan(loanId) {
      const loan = (S.loans || []).find(l => l.id === loanId);
      if (!loan) {
        alert('Loan not found');
        return;
      }
      
      const aircraft = AIRCRAFT[loan.aircraftCode];
      const aircraftName = aircraft?.name || loan.aircraftCode;
      
      if (S.cash < loan.remainingBalance) {
        alert(
          `Insufficient funds to pay off loan.\n\n` +
          `Balance Due: ${formatCurrency(loan.remainingBalance)}\n` +
          `Your Cash: ${formatCurrency(S.cash)}\n` +
          `Shortfall: ${formatCurrency(loan.remainingBalance - S.cash)}`
        );
        return;
      }
      
      if (!confirm(
        `Pay off ${aircraftName} loan?\n\n` +
        `Payoff Amount: ${formatCurrency(loan.remainingBalance)}\n` +
        `Cash After: ${formatCurrency(S.cash - loan.remainingBalance)}\n\n` +
        `The aircraft will be owned free and clear.`
      )) {
        return;
      }
      
      // Pay off loan
      S.cash -= loan.remainingBalance;
      recordTransaction(`Loan Payoff â€” ${aircraftName}`, -loan.remainingBalance, 'loan_principal');
      
      // Remove loan
      S.loans = S.loans.filter(l => l.id !== loanId);
      
      // Close modal and refresh
      const modal = document.getElementById('financingModal');
      if (modal) modal.style.display = 'none';
      
      saveState();
      render();
      
      showToast('Loan Paid Off!', `${aircraftName} is now owned free and clear`, 'success');
    }
    window.payoffLoan = payoffLoan;
    
    function recordTransaction(description, amount, category) {
      const tx = {
        id: uuid(),
        date: { ...S.gameTime },
        description: description,
        amount: amount,
        balanceAfter: S.cash,
        category: category || 'general'
      };
      S.transactions.push(tx);
      
      // Keep last 100 transactions
      if (S.transactions.length > 100) {
        S.transactions = S.transactions.slice(-100);
      }
      
      // Update P&L tracking - exclude balance sheet items (LOC, capital, loan principal, internal transfers, owner draws, asset sales)
      // These are cash movements that don't affect profit/loss
      // Owner salary is an equity distribution, not an operating expense
      // Asset sales are balance sheet transactions (converting asset to cash), broker fees are a selling expense
      const balanceSheetCategories = ['loc', 'capital', 'loan_principal', 'transfer', 'salary', 'asset_sale'];
      if (!balanceSheetCategories.includes(category)) {
        if (amount > 0) {
          S.financials.revenueThisMonth += amount;
          S.financials.revenueYTD += amount;
          S.financials.revenueAllTime += amount;
        } else {
          S.financials.expensesThisMonth += Math.abs(amount);
          S.financials.expensesYTD += Math.abs(amount);
          S.financials.expensesAllTime += Math.abs(amount);
        }
      }
    }
    
    function renderBases() {
      renderCompanyBases();
    }
    
    function changeHomeBase() {
      const input = document.getElementById('changeHomeBaseInput');
      const status = document.getElementById('changeHomeBaseStatus');
      const code = input.value.trim().toUpperCase();
      
      if (code.length !== 4) {
        status.textContent = 'ICAO code must be 4 characters';
        status.style.color = 'var(--warning)';
        return;
      }
      
      if (!AIRPORTS[code]) {
        status.textContent = `Airport ${code} not found in database`;
        status.style.color = 'var(--danger)';
        return;
      }
      
      const airport = AIRPORTS[code];
      S.bases.primary = code;
      
      // Create or update primary base in list
      const existingPrimary = S.bases.list.find(b => b.isPrimary);
      if (existingPrimary) {
        existingPrimary.icao = code;
        existingPrimary.name = `${airport.name} Operations`;
      } else {
        const primaryBase = createPrimaryBase(code);
        S.bases.list = [primaryBase];
      }
      
      saveState();
      render();
      
      status.textContent = `Home base changed to ${airport.name}`;
      status.style.color = 'var(--success)';
    }
    
    // === STAFF RENDERING ===
    
    function renderStaff() {
      renderStaffPayrollSummary();
      renderStaffMissions();
      renderStaffRoster();
      updateStaffCount();
    }
    
    function renderStaffMissions() {
      const container = document.getElementById('staffMissionsContainer');
      if (!container) return;
      
      const activeMissions = (S.staffMissions || []).filter(m => m.status === 'in_progress' || m.status === 'scheduled');
      
      if (activeMissions.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      
      let missionsHtml = activeMissions.map(mission => {
        const crewNames = mission.crew.map(c => c.name).join(' & ');
        const isScheduled = mission.status === 'scheduled';
        const timeLabel = isScheduled ? 'Departs' : 'ETA';
        const timeValue = isScheduled ? formatGameTime(mission.departureTime) : formatGameTime(mission.estimatedCompletion);
        const statusText = isScheduled ? 'Scheduled' : 'In Flight';
        const statusColor = isScheduled ? 'var(--warning)' : 'var(--accent)';
        
        return `
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <div style="font-weight: 600; font-size: 13px;">${isScheduled ? 'ðŸ“…' : 'âœˆï¸'} ${mission.route}</div>
                <div style="font-size: 12px; color: var(--muted);">${mission.missionType}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: ${statusColor};">${statusText}</div>
                <div style="font-size: 11px; color: var(--muted);">${timeLabel}: ${timeValue}</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; display: flex; justify-content: space-between; align-items: center;">
              <span>Crew: ${crewNames}</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--success);">${formatCurrency(mission.revenue || 0)}</span>
                <button onclick="cancelStaffMission('${mission.id}')" style="font-size: 10px; padding: 2px 8px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div style="margin-bottom: 16px;">
          <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--accent);">
            âœˆï¸ Active Staff Missions (${activeMissions.length})
          </div>
          ${missionsHtml}
        </div>
      `;
    }
    
    function updateStaffCount() {
      const countEl = document.getElementById('staffCount');
      if (countEl) {
        const count = S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0);
        countEl.textContent = `${count} employee${count !== 1 ? 's' : ''}`;
      }
    }
    
    function renderStaffPayrollSummary() {
      const container = document.getElementById('staffPayrollSummary');
      if (!container) return;
      
      let totalPayroll = S.staff.reduce((sum, s) => sum + s.salary, 0);
      // Add support staff salaries
      if (S.supportStaff?.marketing) totalPayroll += S.supportStaff.marketing.salary;
      if (S.supportStaff?.accountant) totalPayroll += S.supportStaff.accountant.salary;
      
      const totalStaffCount = S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0);
      
      if (totalStaffCount === 0) {
        container.innerHTML = `
          <div>
            <div class="payroll-label">Monthly Payroll</div>
            <div class="payroll-amount">$0</div>
          </div>
          <div style="font-size: 12px; color: var(--muted);">No staff hired yet</div>
        `;
      } else {
        const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const nextMonth = S.gameTime.month + 1 > 12 ? 1 : S.gameTime.month + 1;
        container.innerHTML = `
          <div>
            <div class="payroll-label">Monthly Payroll (${totalStaffCount} staff)</div>
            <div class="payroll-amount">$${totalPayroll.toLocaleString()}</div>
          </div>
          <div style="font-size: 12px; color: var(--muted);">
            Next payroll: ${monthNames[nextMonth]} 1
          </div>
        `;
      }
    }
    
    function renderStaffRoster() {
      const container = document.getElementById('staffRoster');
      if (!container) return;
      
      // Get filter value
      const filterSelect = document.getElementById('staffRosterFilter');
      const roleFilter = filterSelect ? filterSelect.value : '';
      
      // Filter staff
      let filteredStaff = S.staff;
      if (roleFilter) {
        filteredStaff = S.staff.filter(s => s.role === roleFilter);
      }
      
      // Count total including support staff
      const hasSupportStaff = S.supportStaff?.marketing || S.supportStaff?.accountant;
      const totalStaffCount = S.staff.length + (S.supportStaff?.marketing ? 1 : 0) + (S.supportStaff?.accountant ? 1 : 0);
      
      if (totalStaffCount === 0) {
        container.innerHTML = `
          <div class="staff-empty">
            <div class="staff-empty-icon">ðŸ‘¥</div>
            <div style="font-size: 14px; margin-bottom: 8px;">No Staff Hired</div>
            <div style="font-size: 12px;">Hire pilots, mechanics, and support staff to grow your operation.</div>
            <button class="btn primary" onclick="showStaffMarketplace()" style="margin-top: 16px;">Browse Candidates</button>
          </div>
        `;
        return;
      }
      
      // Check if filtered view is empty
      const showMarketing = (!roleFilter || roleFilter === 'marketing') && S.supportStaff?.marketing;
      const showAccountant = (!roleFilter || roleFilter === 'accountant') && S.supportStaff?.accountant;
      
      if (filteredStaff.length === 0 && !showMarketing && !showAccountant) {
        const roleNames = { pilot: 'pilots', mechanic: 'mechanics', opsOfficer: 'operations officers', marketing: 'marketing specialists', accountant: 'accountants' };
        container.innerHTML = `
          <div class="staff-empty" style="padding: 30px;">
            <div style="font-size: 13px; color: var(--muted);">No ${roleNames[roleFilter] || roleFilter} hired</div>
          </div>
        `;
        return;
      }
      
      let html = '';
      const roleOrder = ['pilot', 'mechanic', 'opsOfficer', 'marketing', 'accountant'];
      
      roleOrder.forEach(role => {
        if (roleFilter && role !== roleFilter) return; // Skip if filtering
        
        // Handle support staff separately
        if (role === 'marketing' && S.supportStaff?.marketing) {
          html += renderSupportStaffCard('marketing', S.supportStaff.marketing);
        } else if (role === 'accountant' && S.supportStaff?.accountant) {
          html += renderSupportStaffCard('accountant', S.supportStaff.accountant);
        } else {
          const roleStaff = filteredStaff.filter(s => s.role === role);
          roleStaff.forEach(member => {
            html += renderStaffCard(member);
          });
        }
      });
      
      container.innerHTML = html;
    }
    
    function filterStaffRoster() {
      renderStaffRoster();
    }
    window.filterStaffRoster = filterStaffRoster;
    
    // Render simplified card for support staff (marketing/accountant)
    function renderSupportStaffCard(role, staffData) {
      const roleIcon = getRoleIcon(role);
      const roleName = getRoleDisplayName(role);
      
      let bonusesHtml = '';
      if (role === 'marketing') {
        bonusesHtml = `
          <div class="staff-mechanic-info">
            <div><strong>Active Bonuses:</strong></div>
            <div style="color: var(--success);">â€¢ +15% reputation/experience gains</div>
            <div style="color: var(--success);">â€¢ +5% contract revenue</div>
          </div>
        `;
      } else if (role === 'accountant') {
        bonusesHtml = `
          <div class="staff-mechanic-info">
            <div><strong>Active Bonuses:</strong></div>
            <div style="color: var(--success);">â€¢ +5% contract revenue</div>
            <div style="color: var(--success);">â€¢ 5% off payroll & insurance</div>
            <div style="color: var(--success);">â€¢ -2% LOC interest rate</div>
          </div>
        `;
      }
      
      return `
        <div class="staff-card" data-support-staff="${role}">
          <div class="staff-card-header">
            <div class="staff-identity">
              <div class="staff-icon">${roleIcon}</div>
              <div>
                <div class="staff-name">${staffData.name}</div>
                <div class="staff-age">Support Staff</div>
              </div>
            </div>
            <div class="staff-status available">Active</div>
          </div>
          
          <div class="staff-role-exp">
            <span class="staff-role">${roleName}</span>
            <span class="staff-salary">$${staffData.salary.toLocaleString()}/mo</span>
          </div>
          
          ${bonusesHtml}
          
          <div class="staff-details">
            <div class="staff-quirk">â€¢ ${staffData.background}</div>
          </div>
          
          <div class="staff-card-actions">
            <button class="btn btn-small danger" onclick="confirmTerminateSupportStaff('${role}')">Terminate</button>
          </div>
        </div>
      `;
    }
    
    function confirmTerminateSupportStaff(role) {
      const staffData = S.supportStaff?.[role];
      if (!staffData) return;
      
      const roleName = getRoleDisplayName(role);
      let warningMsg = `Are you sure you want to terminate ${staffData.name}?\n\n`;
      
      if (role === 'marketing') {
        warningMsg += 'You will lose:\nâ€¢ +15% reputation/experience gains\nâ€¢ +5% contract revenue bonus';
      } else if (role === 'accountant') {
        warningMsg += 'You will lose:\nâ€¢ +5% contract revenue\nâ€¢ 5% off payroll & insurance\nâ€¢ -2% LOC interest rate';
      }
      
      warningMsg += '\n\nThis action cannot be undone.';
      
      if (confirm(warningMsg)) {
        terminateSupportStaff(role);
      }
    }
    window.confirmTerminateSupportStaff = confirmTerminateSupportStaff;
    
    function terminateSupportStaff(role) {
      if (!S.supportStaff?.[role]) return;
      
      const staffData = S.supportStaff[role];
      S.supportStaff[role] = null;
      
      // Update payroll cache
      updatePayrollTotal();
      
      showToast('Staff Terminated', `${staffData.name} has left the company`, 'info');
      
      saveState();
      render();
    }
    window.terminateSupportStaff = terminateSupportStaff;
    
    function renderStaffCard(member) {
      const expDisplay = getExperienceLevelDisplay(member.experienceLevel);
      const underpaidClass = member.underpaid ? 'underpaid' : '';
      
      // Check if currently flying
      const isFlying = member.status === 'flying';
      const currentMission = isFlying ? S.staffMissions.find(m => m.id === member.currentMission) : null;
      
      let roleSpecificHtml = '';
      
      if (member.role === 'pilot' && member.pilot) {
        const pilot = member.pilot;
        const certs = pilot.certificates.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ');
        const ratingNames = { instrument: 'IFR', multiEngine: 'ME', turbine: 'Turb', helicopter: 'Helo', seaplane: 'Sea' };
        const ratings = pilot.ratings.length > 0 ? pilot.ratings.map(r => ratingNames[r] || r).join(', ') : 'None';
        const hoursAvailable = 8 - (pilot.hoursToday || 0);
        
        let flyingInfo = '';
        if (isFlying && currentMission) {
          flyingInfo = `<div style="color: var(--accent); margin-top: 4px;">âœˆï¸ Flying: ${currentMission.route}</div>`;
        }
        
        roleSpecificHtml = `
          <div class="staff-pilot-info">
            <div><strong>Certificates:</strong> ${certs}</div>
            <div><strong>Ratings:</strong> ${ratings}</div>
            <div><strong>Total Hours:</strong> ${pilot.flightHours.toLocaleString()}</div>
            <div><strong>Available Today:</strong> ${hoursAvailable.toFixed(1)} / 8 hrs</div>
            ${flyingInfo}
          </div>
        `;
      } else if (member.role === 'mechanic' && member.mechanic) {
        const specs = member.mechanic.specializations.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ');
        const capabilities = MECHANIC_CAPABILITIES[member.experienceLevel] || [];
        const capNames = {
          squawk: 'Squawks',
          inspection: '100-hr Inspections',
          major_service: 'Major Service/HSI',
          overhaul: 'Engine Overhauls'
        };
        const capList = capabilities.map(c => capNames[c] || c).join(', ');
        
        let workingInfo = '';
        if (member.status === 'working' && member.mechanic.currentJob) {
          const job = member.mechanic.currentJob;
          const aircraft = getAircraft(job.aircraftCode);
          workingInfo = `<div style="color: var(--warning); margin-top: 4px;">ðŸ”§ Working on: ${aircraft?.name || job.aircraftCode}</div>`;
        }
        
        roleSpecificHtml = `
          <div class="staff-mechanic-info">
            <div><strong>Specializations:</strong> ${specs}</div>
            <div><strong>Can Perform:</strong> ${capList}</div>
            ${workingInfo}
          </div>
        `;
      }
      
      const isWorking = member.status === 'working';
      const isTraining = member.status === 'training';
      const statusClass = isFlying ? 'flying' : (isWorking ? 'working' : (isTraining ? 'training' : member.status));
      const statusText = isFlying ? 'âœˆï¸ Flying' : (isWorking ? 'ðŸ”§ Working' : (isTraining ? 'ðŸ“š Training' : member.status.charAt(0).toUpperCase() + member.status.slice(1)));
      
      // Get outlier note for bullet point
      const outlierNote = getSkillOutlierNote(member.skill, member.experienceLevel);
      
      // Build bullet points
      let bullets = `<div class="staff-quirk">â€¢ ${member.background}</div>`;
      bullets += `<div class="staff-quirk">â€¢ ${member.quirk}</div>`;
      if (outlierNote) {
        const outlierText = outlierNote.positive 
          ? 'Shows unusual natural talent' 
          : 'Still refining core skills';
        bullets += `<div class="staff-quirk" style="color: ${outlierNote.positive ? 'var(--success)' : 'var(--warning)'};">â€¢ ${outlierText}</div>`;
      }
      
      // Get qualitative skill assessment
      const skillAssessment = getSkillAssessment(member.skill);
      
      // Check if pilot is in training and calculate remaining time
      let trainingInfo = '';
      if (member.role === 'pilot' && member.status === 'training') {
        const training = S.staffTraining?.find(t => t.pilotId === member.id);
        if (training) {
          const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
          const completionDays = (training.completionDate.year * 336) + 
                                 ((training.completionDate.month - 1) * 28) + 
                                 training.completionDate.day;
          const daysRemaining = Math.max(0, completionDays - currentDays);
          trainingInfo = `<div style="color: var(--warning); margin-top: 4px;">ðŸ“š Training: ${training.ratingName} (${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining)</div>`;
        }
      }
      
      return `
        <div class="staff-card ${underpaidClass}" data-staff-id="${member.id}">
          <div class="staff-card-header">
            <div class="staff-identity">
              <div class="staff-icon">${getRoleIcon(member.role)}</div>
              <div>
                <div class="staff-name">${member.name}${member.underpaid ? ' âš ï¸' : ''}</div>
                <div class="staff-age">${member.age} years old</div>
              </div>
            </div>
            <div class="staff-status ${statusClass}">${statusText}</div>
          </div>
          
          <div class="staff-role-exp">
            <span class="staff-role">${getRoleDisplayName(member.role)}</span>
            <span class="staff-salary">$${member.salary.toLocaleString()}/mo</span>
          </div>
          
          <div class="staff-skill-row">
            <span class="staff-skill-label">Skill</span>
            <div class="staff-skill-bar">
              <div class="staff-skill-fill" style="width: ${member.skill}%; background: ${skillAssessment.color};"></div>
            </div>
            <span class="staff-skill-value" style="color: ${skillAssessment.color};">${skillAssessment.label}</span>
          </div>
          
          <div class="staff-details">
            ${bullets}
          </div>
          
          ${roleSpecificHtml}
          ${trainingInfo}
          
          <div class="staff-card-actions">
            ${member.role === 'pilot' ? `<button class="btn btn-small" onclick="showTrainingModal('${member.id}')" style="margin-right: 4px;" ${member.status !== 'available' ? 'disabled title="Pilot must be available"' : ''}>Train</button>` : ''}
            <button class="btn btn-small" onclick="showAdjustSalaryModal('${member.id}')" style="margin-right: 4px;">Adjust Salary</button>
            <button class="btn btn-small danger" onclick="confirmTerminateStaff('${member.id}')" ${isFlying ? 'disabled title="Cannot terminate while flying"' : ''}>Terminate</button>
          </div>
        </div>
      `;
    }
    
    function confirmTerminateStaff(staffId) {
      const member = S.staff.find(s => s.id === staffId);
      if (!member) return;
      
      const severance = member.salary * SEVERANCE_MONTHS;
      const msg = `Are you sure you want to terminate ${member.name}?\n\n` +
                  `Severance payment: ${formatCurrency(severance)} (${SEVERANCE_MONTHS} months salary)\n\n` +
                  `This action cannot be undone.`;
      
      if (confirm(msg)) {
        terminateStaff(staffId);
      }
    }
    window.confirmTerminateStaff = confirmTerminateStaff;
    
    function showAdjustSalaryModal(staffId) {
      const member = S.staff.find(s => s.id === staffId);
      if (!member) return;
      
      const baseSalary = STAFF_SALARIES[member.role][member.experienceLevel];
      const marketLow = Math.round(baseSalary * 0.95 / 100) * 100;
      const marketHigh = Math.round(baseSalary * 1.15 / 100) * 100;
      
      const modalHtml = `
        <div class="modal-overlay" id="adjustSalaryModal">
          <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-header">
              <h3>Adjust Salary</h3>
              <button class="modal-close" onclick="closeAdjustSalaryModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600;">${member.name}</div>
                <div style="font-size: 12px; color: var(--muted);">${getRoleDisplayName(member.role)} Â· ${member.experienceLevel}</div>
              </div>
              
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="color: var(--muted);">Current Salary:</span>
                  <span style="font-weight: 600;">$${member.salary.toLocaleString()}/month</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 11px;">
                  <span style="color: var(--muted);">Market Rate:</span>
                  <span>$${marketLow.toLocaleString()} - $${marketHigh.toLocaleString()}</span>
                </div>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">New Salary</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: var(--muted);">$</span>
                  <input type="number" id="newSalaryInput" value="${member.salary}" min="100" step="100" 
                         style="flex: 1; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 14px;">
                  <span style="color: var(--muted);">/month</span>
                </div>
              </div>
              
              <div id="salaryChangePreview" style="font-size: 12px; color: var(--muted); margin-bottom: 16px;"></div>
              
              <div style="display: flex; gap: 8px;">
                <button class="btn" onclick="closeAdjustSalaryModal()" style="flex: 1;">Cancel</button>
                <button class="btn primary" onclick="confirmAdjustSalary('${staffId}')" style="flex: 1;">Update Salary</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add change listener for preview
      const input = document.getElementById('newSalaryInput');
      const preview = document.getElementById('salaryChangePreview');
      input.addEventListener('input', () => {
        const newSal = parseInt(input.value) || 0;
        const diff = newSal - member.salary;
        if (diff > 0) {
          preview.innerHTML = '<span style="color: var(--success);">+$' + diff.toLocaleString() + '/month increase</span>';
        } else if (diff < 0) {
          preview.innerHTML = '<span style="color: var(--danger);">-$' + Math.abs(diff).toLocaleString() + '/month decrease</span>';
        } else {
          preview.innerHTML = 'No change';
        }
      });
      input.dispatchEvent(new Event('input'));
    }
    window.showAdjustSalaryModal = showAdjustSalaryModal;
    
    function closeAdjustSalaryModal() {
      const modal = document.getElementById('adjustSalaryModal');
      if (modal) modal.remove();
    }
    window.closeAdjustSalaryModal = closeAdjustSalaryModal;
    
    function confirmAdjustSalary(staffId) {
      const member = S.staff.find(s => s.id === staffId);
      if (!member) return;
      
      const input = document.getElementById('newSalaryInput');
      const newSalary = parseInt(input.value) || 0;
      
      if (newSalary < 100) {
        showToast('Invalid Salary', 'Salary must be at least $100/month', 'warning');
        return;
      }
      
      const oldSalary = member.salary;
      member.salary = newSalary;
      
      // Clear underpaid status only if new salary meets minimum for their level (80% of base)
      const baseSalary = STAFF_SALARIES[member.role][member.experienceLevel];
      const minimumForLevel = Math.round(baseSalary * 0.80 / 100) * 100;
      if (newSalary >= minimumForLevel && member.underpaid) {
        delete member.underpaid;
        delete member.raiseDeclinedDate;
        delete member.quitCheckDone;
      }
      
      updatePayrollTotal();
      saveState();
      closeAdjustSalaryModal();
      render();
      
      const diff = newSalary - oldSalary;
      if (diff > 0) {
        showToast('Salary Increased', `${member.name}'s salary increased to $${newSalary.toLocaleString()}/month`, 'success');
      } else if (diff < 0) {
        showToast('Salary Decreased', `${member.name}'s salary decreased to $${newSalary.toLocaleString()}/month`, 'warning');
      } else {
        showToast('No Change', 'Salary unchanged', 'info');
      }
    }
    window.confirmAdjustSalary = confirmAdjustSalary;
    
    // === PILOT TRAINING MODAL ===
    function showTrainingModal(pilotId) {
      const pilot = S.staff.find(s => s.id === pilotId && s.role === 'pilot');
      if (!pilot || !pilot.pilot) return;
      
      if (pilot.status !== 'available') {
        showToast('Pilot Unavailable', `${pilot.name} is currently ${pilot.status}`, 'warning');
        return;
      }
      
      const trainings = getAvailableTraining(pilotId);
      const certCheckrides = getAvailableCertCheckrides(pilotId);
      
      // Build ratings training section
      let trainingOptionsHtml = '';
      if (trainings.length === 0) {
        trainingOptionsHtml = `<div style="text-align: center; color: var(--muted); padding: 12px;">
          ${pilot.name} has all available ratings.
        </div>`;
      } else {
        trainingOptionsHtml = trainings.map(t => {
          const canAfford = S.cash >= t.cost;
          const canTrain = t.meetsHours && canAfford;
          
          let statusText = '';
          if (!t.meetsHours) {
            statusText = `<div style="color: var(--warning); font-size: 11px;">Requires ${t.minHours} flight hours (has ${pilot.pilot.flightHours})</div>`;
          } else if (!canAfford) {
            statusText = `<div style="color: var(--danger); font-size: 11px;">Insufficient funds</div>`;
          }
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; opacity: ${canTrain ? 1 : 0.6};">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${t.name}</div>
                <div style="font-size: 12px; color: var(--muted);">${t.durationDays} days Â· ${t.successChance}% success rate</div>
                ${statusText}
              </div>
              <div style="text-align: right; margin-left: 16px;">
                <div style="font-weight: 600; color: var(--warning);">${formatCurrency(t.cost)}</div>
                <button class="btn btn-small primary" onclick="confirmStartTraining('${pilotId}', '${t.key}')" 
                        ${!canTrain ? 'disabled' : ''} style="margin-top: 4px;">
                  Enroll
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Build certificate checkrides section
      let certOptionsHtml = '';
      if (certCheckrides.length === 0) {
        certOptionsHtml = `<div style="text-align: center; color: var(--muted); padding: 12px;">
          ${pilot.name} has all available certificates.
        </div>`;
      } else {
        certOptionsHtml = certCheckrides.map(c => {
          const canAfford = S.cash >= c.cost;
          const canSchedule = c.meetsHours && c.hasPrereqs && canAfford && !c.cooldownActive;
          
          let statusText = '';
          if (c.cooldownActive) {
            statusText = `<div style="color: var(--warning); font-size: 11px;">Retry available in ${c.cooldownDays} day(s)</div>`;
          } else if (!c.meetsHours) {
            statusText = `<div style="color: var(--warning); font-size: 11px;">Requires ${c.minHours} flight hours (has ${pilot.pilot.flightHours})</div>`;
          } else if (!c.hasPrereqs) {
            statusText = `<div style="color: var(--warning); font-size: 11px;">Requires: ${c.requires.join(', ')}</div>`;
          } else if (!canAfford) {
            statusText = `<div style="color: var(--danger); font-size: 11px;">Insufficient funds</div>`;
          }
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; opacity: ${canSchedule ? 1 : 0.6};">
              <div style="flex: 1;">
                <div style="font-weight: 600;">${c.name}</div>
                <div style="font-size: 12px; color: var(--muted);">Checkride Â· ${c.successChance}% success rate</div>
                ${statusText}
              </div>
              <div style="text-align: right; margin-left: 16px;">
                <div style="font-weight: 600; color: var(--warning);">${formatCurrency(c.cost)}</div>
                <button class="btn btn-small primary" onclick="confirmCertCheckride('${pilotId}', '${c.key}')" 
                        ${!canSchedule ? 'disabled' : ''} style="margin-top: 4px;">
                  Schedule
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="pilotTrainingModal">
          <div class="modal-dialog" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>Pilot Training & Checkrides</h3>
              <button class="modal-close" onclick="closePilotTrainingModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <div style="font-weight: 600; font-size: 16px;">${pilot.name}</div>
                <div style="font-size: 12px; color: var(--muted);">
                  ${pilot.pilot.flightHours.toLocaleString()} flight hours
                </div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                  Certificates: ${(pilot.pilot.certificates || []).map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ') || 'None'}
                </div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 2px;">
                  Ratings: ${(pilot.pilot.ratings || []).map(r => PILOT_TRAINING[r]?.name || r).join(', ') || 'None'}
                </div>
              </div>
              
              <div style="font-weight: 600; margin-bottom: 12px;">ðŸ“œ Certificate Checkrides</div>
              ${certOptionsHtml}
              
              <div style="font-weight: 600; margin-bottom: 12px; margin-top: 20px;">ðŸŽ“ Rating Training Programs</div>
              ${trainingOptionsHtml}
              
              <div style="font-size: 11px; color: var(--muted); margin-top: 16px;">
                Checkrides complete immediately. Training takes days and pilot is unavailable during.
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showTrainingModal = showTrainingModal;
    
    function closePilotTrainingModal() {
      const modal = document.getElementById('pilotTrainingModal');
      if (modal) modal.remove();
    }
    window.closePilotTrainingModal = closePilotTrainingModal;
    
    function closeTrainingModal() {
      const modal = document.getElementById('trainingModal');
      if (modal) modal.remove();
    }
    window.closeTrainingModal = closeTrainingModal;
    
    function confirmStartTraining(pilotId, ratingKey) {
      const pilot = S.staff.find(s => s.id === pilotId);
      const config = PILOT_TRAINING[ratingKey];
      if (!pilot || !config) return;
      
      const trainings = getAvailableTraining(pilotId);
      const training = trainings.find(t => t.key === ratingKey);
      if (!training) return;
      
      const msg = `Enroll ${pilot.name} in ${config.name} training?\n\n` +
                  `Cost: ${formatCurrency(config.cost)}\n` +
                  `Duration: ${config.durationDays} days\n` +
                  `Success chance: ${training.successChance}%\n\n` +
                  `${pilot.name} will be unavailable for missions during training.`;
      
      if (confirm(msg)) {
        closeTrainingModal();
        startPilotTraining(pilotId, ratingKey);
      }
    }
    window.confirmStartTraining = confirmStartTraining;
    
    // Schedule certificate checkride from training modal
    function confirmCertCheckride(pilotId, certKey) {
      const pilot = S.staff.find(s => s.id === pilotId);
      const config = STAFF_CERT_REQUIREMENTS[certKey];
      if (!pilot || !config) return;
      
      const checkrides = getAvailableCertCheckrides(pilotId);
      const checkride = checkrides.find(c => c.key === certKey);
      if (!checkride) return;
      
      const msg = `Schedule ${pilot.name} for ${config.name} checkride?\n\n` +
                  `Fee: ${formatCurrency(config.fee)}\n` +
                  `Success chance: ${checkride.successChance}%\n\n` +
                  `The checkride will be completed immediately.`;
      
      if (!confirm(msg)) return;
      
      // Check funds
      if (S.cash < config.fee) {
        showToast('Insufficient Funds', `Need ${formatCurrency(config.fee)}`, 'error');
        return;
      }
      
      // Deduct fee
      S.cash -= config.fee;
      recordTransaction(`Checkride Fee â€” ${config.name} (${pilot.name})`, -config.fee, 'training');
      
      // Calculate failure chance based on skill
      const skill = pilot.skill || 50;
      const [minFail, maxFail] = config.failureRange;
      const skillFactor = 1 - ((skill - 20) / 80);
      const failureChance = minFail + (maxFail - minFail) * Math.max(0, Math.min(1, skillFactor));
      
      // Roll for pass/fail
      const roll = Math.random();
      const passed = roll >= failureChance;
      
      closeTrainingModal();
      
      if (passed) {
        // Add certificate
        if (!pilot.pilot.certificates) pilot.pilot.certificates = [];
        pilot.pilot.certificates.push(certKey);
        
        // Clear any pending notification flag
        if (pilot.pilot.certNotified) {
          pilot.pilot.certNotified[certKey] = true; // Keep it true so no duplicate emails
        }
        
        // Success email
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'FAA Examiner',
          subject: `âœ“ Checkride Passed â€” ${config.name}`,
          body: `Congratulations! ${pilot.name} has passed their ${config.name} checkride!\n\n` +
                `They are now certified to fly missions requiring this certificate.`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Checkride Passed', `${pilot.name} earned ${config.name}!`, 'success');
      } else {
        // 7-day cooldown
        const cooldownDate = { ...S.gameTime };
        cooldownDate.day += 7;
        while (cooldownDate.day > 28) {
          cooldownDate.day -= 28;
          cooldownDate.month++;
          if (cooldownDate.month > 12) {
            cooldownDate.month = 1;
            cooldownDate.year++;
          }
        }
        
        if (!pilot.pilot.certCooldowns) pilot.pilot.certCooldowns = {};
        pilot.pilot.certCooldowns[certKey] = cooldownDate;
        
        // Reset notification so they can try again from menu after cooldown
        if (pilot.pilot.certNotified) {
          pilot.pilot.certNotified[certKey] = false;
        }
        
        // Failure email
        S.emails.unshift({
          id: uuid(),
          type: 'alert',
          from: 'FAA Examiner',
          subject: `âœ— Checkride Failed â€” ${config.name}`,
          body: `Unfortunately, ${pilot.name} did not pass their ${config.name} checkride.\n\n` +
                `They may reattempt after a 7-day waiting period.\n\n` +
                `Retry available: Month ${cooldownDate.month}, Day ${cooldownDate.day}`,
          status: 'unread',
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Checkride Failed', `${pilot.name} must wait 7 days to retry`, 'warning');
      }
      
      saveState();
      render();
    }
    window.confirmCertCheckride = confirmCertCheckride;
    
    function showStaffMarketplace() {
      if (!S.staffMarketplace || S.staffMarketplace.length === 0) {
        refreshStaffMarketplace();
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="staffMarketplaceModal">
          <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header">
              <h3>Staff Marketplace</h3>
              <button class="modal-close" onclick="closeStaffMarketplace()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="staff-marketplace-filters">
                <select id="staffRoleFilter" onchange="filterStaffMarketplace()">
                  <option value="">All Roles</option>
                  <option value="pilot">Pilots</option>
                  <option value="mechanic">Mechanics</option>
                  <option value="opsOfficer">Ops Officers</option>
                  <option value="marketing">Marketing</option>
                  <option value="accountant">Accountants</option>
                </select>
                <select id="staffExpFilter" onchange="filterStaffMarketplace()">
                  <option value="">All Experience</option>
                  <option value="junior">Junior</option>
                  <option value="mid">Mid-Level</option>
                  <option value="senior">Senior</option>
                  <option value="expert">Expert</option>
                </select>
                <button class="btn" onclick="showCreateCustomEmployee()" style="margin-left: auto; font-size: 11px; padding: 4px 10px;">+ Create Custom</button>
              </div>
              <div class="staff-marketplace-grid" id="staffMarketplaceGrid">
                ${renderStaffMarketplaceList()}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showStaffMarketplace = showStaffMarketplace;
    
    function closeStaffMarketplace() {
      const modal = document.getElementById('staffMarketplaceModal');
      if (modal) modal.remove();
    }
    window.closeStaffMarketplace = closeStaffMarketplace;
    
    function filterStaffMarketplace() {
      const grid = document.getElementById('staffMarketplaceGrid');
      if (grid) grid.innerHTML = renderStaffMarketplaceList();
    }
    window.filterStaffMarketplace = filterStaffMarketplace;
    
    // Custom Employee Creation
    function showCreateCustomEmployee() {
      const modalHtml = `
        <div class="modal-overlay" id="customEmployeeModal" style="z-index: 1001;">
          <div class="modal-dialog" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>Create Custom Employee</h3>
              <button class="modal-close" onclick="closeCustomEmployeeModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
              <!-- Role Selection -->
              <div style="margin-bottom: 16px;">
                <label style="font-weight: 600; font-size: 13px; display: block; margin-bottom: 6px;">Role</label>
                <select id="customRole" onchange="updateCustomEmployeeForm()" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  <option value="pilot">Pilot</option>
                  <option value="mechanic">Mechanic</option>
                </select>
              </div>
              
              <!-- Basic Info -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">First Name</label>
                  <input type="text" id="customFirstName" placeholder="John" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Last Name</label>
                  <input type="text" id="customLastName" placeholder="Smith" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
              </div>
              
              <!-- Vitals -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Age</label>
                  <input type="number" id="customAge" value="35" min="21" max="70" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Gender</label>
                  <select id="customGender" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">State</label>
                  <input type="text" id="customState" placeholder="CA" maxlength="2" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); text-transform: uppercase;">
                </div>
              </div>
              
              <!-- Experience & Skill -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Experience Level</label>
                  <select id="customExpLevel" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                    <option value="junior">Junior</option>
                    <option value="mid" selected>Mid-Level</option>
                    <option value="senior">Senior</option>
                    <option value="expert">Expert</option>
                  </select>
                </div>
                <div>
                  <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Skill (0-100)</label>
                  <input type="number" id="customSkill" value="60" min="0" max="100" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
              </div>
              
              <!-- Salary -->
              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Monthly Salary ($)</label>
                <input type="number" id="customSalary" value="3000" min="1000" max="15000" step="100" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
              
              <!-- Pilot-specific fields -->
              <div id="pilotFields">
                <div style="border-top: 1px solid var(--border); padding-top: 16px; margin-bottom: 16px;">
                  <label style="font-weight: 600; font-size: 13px; display: block; margin-bottom: 8px;">Pilot Details</label>
                  
                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px;">Flight Hours</label>
                    <input type="number" id="customFlightHours" value="500" min="0" max="20000" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                  
                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 8px;">Certificates</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="certPrivate" checked> Private
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="certCommercial"> Commercial
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="certATP"> ATP
                      </label>
                    </div>
                  </div>
                  
                  <div>
                    <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 8px;">Ratings</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="ratingInstrument"> Instrument (IFR)
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="ratingMultiEngine"> Multi-Engine
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="ratingTurbine"> Turbine
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="ratingHelicopter"> Helicopter
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="ratingSeaplane"> Seaplane
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Mechanic-specific fields -->
              <div id="mechanicFields" style="display: none;">
                <div style="border-top: 1px solid var(--border); padding-top: 16px; margin-bottom: 16px;">
                  <label style="font-weight: 600; font-size: 13px; display: block; margin-bottom: 8px;">Mechanic Specializations</label>
                  <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                      <input type="checkbox" id="specPiston" checked> Piston
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                      <input type="checkbox" id="specTurboprop"> Turboprop
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                      <input type="checkbox" id="specJet"> Jet
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Hiring Fee Notice -->
              <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: var(--muted);">
                  Hiring Fee: <span id="customHiringFee" style="color: var(--text); font-weight: 600;">$300</span>
                  <span style="color: var(--muted);"> (10% of monthly salary)</span>
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn" onclick="closeCustomEmployeeModal()">Cancel</button>
                <button class="btn" onclick="hireCustomEmployee()" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">Hire Employee</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add salary change listener for hiring fee update
      document.getElementById('customSalary').addEventListener('input', updateCustomHiringFee);
    }
    window.showCreateCustomEmployee = showCreateCustomEmployee;
    
    function closeCustomEmployeeModal() {
      const modal = document.getElementById('customEmployeeModal');
      if (modal) modal.remove();
    }
    window.closeCustomEmployeeModal = closeCustomEmployeeModal;
    
    function updateCustomEmployeeForm() {
      const role = document.getElementById('customRole').value;
      const pilotFields = document.getElementById('pilotFields');
      const mechanicFields = document.getElementById('mechanicFields');
      
      if (role === 'pilot') {
        pilotFields.style.display = 'block';
        mechanicFields.style.display = 'none';
      } else {
        pilotFields.style.display = 'none';
        mechanicFields.style.display = 'block';
      }
    }
    window.updateCustomEmployeeForm = updateCustomEmployeeForm;
    
    function updateCustomHiringFee() {
      const salary = parseInt(document.getElementById('customSalary').value) || 0;
      const fee = Math.round(salary * 0.10);
      const feeEl = document.getElementById('customHiringFee');
      if (feeEl) feeEl.textContent = formatCurrency(fee);
    }
    
    function hireCustomEmployee() {
      const role = document.getElementById('customRole').value;
      const firstName = document.getElementById('customFirstName').value.trim();
      const lastName = document.getElementById('customLastName').value.trim();
      const age = parseInt(document.getElementById('customAge').value) || 35;
      const gender = document.getElementById('customGender').value;
      const state = document.getElementById('customState').value.trim().toUpperCase() || 'CA';
      const expLevel = document.getElementById('customExpLevel').value;
      const skill = Math.min(100, Math.max(0, parseInt(document.getElementById('customSkill').value) || 50));
      const salary = parseInt(document.getElementById('customSalary').value) || 3000;
      
      // Validation
      if (!firstName || !lastName) {
        showToast('Missing Info', 'Please enter first and last name', 'warning');
        return;
      }
      
      const hiringFee = Math.round(salary * 0.10);
      if (S.cash < hiringFee) {
        showToast('Insufficient Funds', `Need ${formatCurrency(hiringFee)} for hiring fee`, 'warning');
        return;
      }
      
      // Build employee object
      const employee = {
        id: uuid(),
        name: `${firstName} ${lastName}`,
        role: role,
        experienceLevel: expLevel,
        skill: skill,
        salary: salary,
        age: age,
        gender: gender,
        location: { state: state },
        status: 'available',
        hireDate: { ...S.gameTime },
        xp: STAFF_XP_THRESHOLDS[expLevel] || 0,
        assignedBase: S.bases.primary
      };
      
      if (role === 'pilot') {
        const flightHours = parseInt(document.getElementById('customFlightHours').value) || 0;
        
        // Gather certificates
        const certificates = [];
        if (document.getElementById('certPrivate').checked) certificates.push('private');
        if (document.getElementById('certCommercial').checked) certificates.push('commercial');
        if (document.getElementById('certATP').checked) certificates.push('atp');
        
        // Gather ratings
        const ratings = [];
        if (document.getElementById('ratingInstrument').checked) ratings.push('instrument');
        if (document.getElementById('ratingMultiEngine').checked) ratings.push('multi_engine');
        if (document.getElementById('ratingTurbine').checked) ratings.push('turbine');
        if (document.getElementById('ratingHelicopter').checked) ratings.push('helicopter');
        if (document.getElementById('ratingSeaplane').checked) ratings.push('seaplane');
        
        employee.pilot = {
          flightHours: flightHours,
          certificates: certificates,
          ratings: ratings
        };
      } else if (role === 'mechanic') {
        // Gather specializations
        const specializations = [];
        if (document.getElementById('specPiston').checked) specializations.push('piston');
        if (document.getElementById('specTurboprop').checked) specializations.push('turboprop');
        if (document.getElementById('specJet').checked) specializations.push('jet');
        
        employee.mechanic = {
          specializations: specializations
        };
      }
      
      // Deduct hiring fee
      S.cash -= hiringFee;
      recordTransaction(`Hiring fee - ${employee.name}`, -hiringFee, 'staff');
      
      // Add to staff
      S.staff.push(employee);
      
      // Close modal and refresh
      closeCustomEmployeeModal();
      closeStaffMarketplace();
      
      showToast('Employee Hired', `${employee.name} has joined your team`, 'success');
      
      // Send welcome email
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'HR Department',
        subject: `Welcome ${employee.name}!`,
        body: `${employee.name} has joined your team as a ${getRoleDisplayName(role)}.\n\nSalary: ${formatCurrency(salary)}/month\nHiring Fee Paid: ${formatCurrency(hiringFee)}\n\nThey're ready to start work immediately.`,
        status: 'unread',
        receivedAt: { ...S.gameTime }
      });
      
      saveState();
      render();
    }
    window.hireCustomEmployee = hireCustomEmployee;
    
    function renderStaffMarketplaceList() {
      const roleFilter = document.getElementById('staffRoleFilter')?.value || '';
      const expFilter = document.getElementById('staffExpFilter')?.value || '';
      
      let candidates = [...S.staffMarketplace];
      
      // Filter out support staff roles that are already filled
      candidates = candidates.filter(c => {
        if (c.role === 'marketing' && S.supportStaff?.marketing) return false;
        if (c.role === 'accountant' && S.supportStaff?.accountant) return false;
        return true;
      });
      
      if (roleFilter) candidates = candidates.filter(c => c.role === roleFilter);
      if (expFilter) candidates = candidates.filter(c => c.experienceLevel === expFilter);
      
      if (candidates.length === 0) {
        return '<div class="staff-empty"><div style="font-size: 14px;">No candidates match your filters</div></div>';
      }
      
      return candidates.map(candidate => {
        const expDisplay = getExperienceLevelDisplay(candidate.experienceLevel);
        const ratingNames = { instrument: 'IFR', multiEngine: 'ME', turbine: 'Turb', helicopter: 'Helo', seaplane: 'Sea' };
        const outlierNote = getSkillOutlierNote(candidate.skill, candidate.experienceLevel);
        const isSupportStaff = ['marketing', 'accountant'].includes(candidate.role);
        
        let extraInfo = '';
        if (candidate.role === 'pilot' && candidate.pilot) {
          const ratings = candidate.pilot.ratings.length > 0 ? candidate.pilot.ratings.map(r => ratingNames[r] || r).join(', ') : 'None';
          extraInfo = '<div style="font-size: 11px; color: var(--muted);">' + candidate.pilot.flightHours.toLocaleString() + ' hrs â€¢ Ratings: ' + ratings + '</div>';
        } else if (candidate.role === 'mechanic' && candidate.mechanic) {
          const specs = candidate.mechanic.specializations.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ');
          const capabilities = MECHANIC_CAPABILITIES[candidate.experienceLevel] || [];
          const capNames = { squawk: 'Squawks', inspection: '100-hr', major_service: 'HSI', overhaul: 'Overhauls' };
          const capList = capabilities.map(c => capNames[c] || c).join(', ');
          extraInfo = '<div style="font-size: 11px; color: var(--muted);">Specs: ' + specs + '</div>';
          extraInfo += '<div style="font-size: 11px; color: var(--muted);">Can do: ' + capList + '</div>';
        } else if (candidate.role === 'marketing') {
          extraInfo = '<div style="font-size: 11px; color: var(--success);">â€¢ +15% reputation gains</div>';
          extraInfo += '<div style="font-size: 11px; color: var(--success);">â€¢ +5% contract revenue</div>';
        } else if (candidate.role === 'accountant') {
          extraInfo = '<div style="font-size: 11px; color: var(--success);">â€¢ +5% revenue, -5% payroll/insurance</div>';
          extraInfo += '<div style="font-size: 11px; color: var(--success);">â€¢ -2% LOC interest rate</div>';
        }
        
        // Build bullet points
        let bullets = `<div class="staff-quirk">â€¢ ${candidate.background}</div>`;
        if (!isSupportStaff && outlierNote) {
          const outlierText = outlierNote.positive 
            ? 'Shows unusual natural talent' 
            : 'Still refining core skills';
          bullets += `<div class="staff-quirk" style="color: ${outlierNote.positive ? 'var(--success)' : 'var(--warning)'};">â€¢ ${outlierText}</div>`;
        }
        
        // Support staff don't show skill bar
        const skillAssessment = getSkillAssessment(candidate.skill);
        const skillBar = isSupportStaff ? '' : `
            <div class="staff-skill-row">
              <span class="staff-skill-label">Skill</span>
              <div class="staff-skill-bar"><div class="staff-skill-fill" style="width: ${candidate.skill}%; background: ${skillAssessment.color};"></div></div>
              <span class="staff-skill-value" style="color: ${skillAssessment.color};">${skillAssessment.label}</span>
            </div>`;
        
        return `
          <div class="marketplace-candidate" onclick="showHireConfirmation('${candidate.id}')">
            <div class="candidate-header">
              <div class="staff-identity">
                <div class="staff-icon">${getRoleIcon(candidate.role)}</div>
                <div>
                  <div class="staff-name">${candidate.name}, ${candidate.age}</div>
                  <div class="staff-role-exp">
                    <span class="staff-role">${getRoleDisplayName(candidate.role)}</span>
                  </div>
                </div>
              </div>
              <div class="candidate-salary">$${candidate.salary.toLocaleString()}/mo</div>
            </div>
            ${skillBar}
            ${extraInfo}
            <div style="margin-top: 8px;">${bullets}</div>
          </div>
        `;
      }).join('');
    }
    
    function showHireConfirmation(candidateId) {
      const candidate = S.staffMarketplace.find(c => c.id === candidateId);
      if (!candidate) return;
      
      const expDisplay = getExperienceLevelDisplay(candidate.experienceLevel);
      const isSupportStaff = ['marketing', 'accountant'].includes(candidate.role);
      
      // Calculate hiring fee
      const monthlySalary = isSupportStaff ? STAFF_EFFECTS[candidate.role].salary : candidate.salary;
      const hiringFee = Math.round(monthlySalary * HIRING_FEE_PERCENT);
      
      // For support staff, show benefits instead of skill bar
      let middleSection;
      if (candidate.role === 'marketing') {
        middleSection = `
          <div style="text-align: left; margin: 16px 0; padding: 12px; background: var(--panel); border-radius: 8px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Benefits:</div>
            <div style="color: var(--success);">â€¢ +15% reputation/experience gains</div>
            <div style="color: var(--success);">â€¢ +5% contract revenue</div>
          </div>
        `;
      } else if (candidate.role === 'accountant') {
        middleSection = `
          <div style="text-align: left; margin: 16px 0; padding: 12px; background: var(--panel); border-radius: 8px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Benefits:</div>
            <div style="color: var(--success);">â€¢ +5% contract revenue</div>
            <div style="color: var(--success);">â€¢ 5% off payroll & insurance</div>
            <div style="color: var(--success);">â€¢ -2% LOC interest rate</div>
          </div>
        `;
      } else {
        const skillAssessment = getSkillAssessment(candidate.skill);
        middleSection = `
          <div class="staff-skill-row" style="max-width: 200px; margin: 0 auto;">
            <span class="staff-skill-label">Skill</span>
            <div class="staff-skill-bar"><div class="staff-skill-fill" style="width: ${candidate.skill}%; background: ${skillAssessment.color};"></div></div>
            <span class="staff-skill-value" style="color: ${skillAssessment.color};">${skillAssessment.label}</span>
          </div>
        `;
      }
      
      const roleInfo = `${getRoleDisplayName(candidate.role)} â€¢ ${candidate.age} years old`;
      
      const canAfford = S.cash >= hiringFee;
      
      const confirmHtml = `
        <div class="modal-overlay" id="hireConfirmModal" style="z-index: 1001;">
          <div class="modal-dialog" style="max-width: 400px;">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 12px;">${getRoleIcon(candidate.role)}</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${candidate.name}</div>
              <div style="color: var(--muted); margin-bottom: 12px;">
                ${roleInfo}
              </div>
              <div style="font-size: 24px; font-weight: 700; color: var(--warning); margin: 8px 0;">
                $${monthlySalary.toLocaleString()}/month
              </div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 16px;">
                + ${formatCurrency(hiringFee)} hiring fee (one-time)
              </div>
              ${middleSection}
              <div style="margin-top: 16px; font-style: italic; color: var(--muted); font-size: 13px;">"${candidate.background}"</div>
              <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                <button class="btn" onclick="closeHireConfirmation()">Cancel</button>
                <button class="btn primary" onclick="confirmHire('${candidate.id}')" ${!canAfford ? 'disabled title="Insufficient funds"' : ''}>Hire</button>
              </div>
              ${!canAfford ? `<div style="color: var(--danger); font-size: 12px; margin-top: 8px;">Insufficient funds for hiring fee</div>` : ''}
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', confirmHtml);
    }
    window.showHireConfirmation = showHireConfirmation;
    
    function closeHireConfirmation() {
      const modal = document.getElementById('hireConfirmModal');
      if (modal) modal.remove();
    }
    window.closeHireConfirmation = closeHireConfirmation;
    
    function confirmHire(candidateId) {
      closeHireConfirmation();
      if (hireStaff(candidateId)) {
        const grid = document.getElementById('staffMarketplaceGrid');
        if (grid) grid.innerHTML = renderStaffMarketplaceList();
      }
    }
    window.confirmHire = confirmHire;
    
    function renderCompanyOverview() {
      const container = document.getElementById('companyOverview');
      if (!container) return;
      
      const rep = S.reputation || { stars: 0, totalReviews: 0, recentRatings: [], reviewLog: [] };
      const hasReviews = rep.totalReviews > 0;
      
      // Calculate rating distribution
      const distribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
      if (rep.reviewLog && rep.reviewLog.length > 0) {
        rep.reviewLog.forEach(r => {
          if (r.stars >= 1 && r.stars <= 5) distribution[r.stars]++;
        });
      }
      
      const starDisplay = hasReviews ? 
        'â˜…'.repeat(Math.floor(rep.stars)) + (rep.stars % 1 >= 0.5 ? 'Â½' : '') + 'â˜†'.repeat(5 - Math.ceil(rep.stars)) :
        'â˜†â˜†â˜†â˜†â˜†';
      
      container.innerHTML = `
        <div style="display: grid; gap: 16px;">
          <!-- Company Name -->
          <div style="padding: 16px; background: var(--bg); border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Company Name</div>
            <div style="font-size: 20px; font-weight: 600;">${S.companyName || 'Not yet established'}</div>
          </div>
          
          <!-- Customer Rating -->
          <div style="padding: 16px; background: var(--bg); border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Customer Rating</div>
            ${hasReviews ? `
              <div style="font-size: 32px; font-weight: 700; font-family: 'JetBrains Mono', monospace;">${rep.stars.toFixed(1)}</div>
              <div style="font-size: 20px; color: var(--warning); letter-spacing: 3px;">${starDisplay}</div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${rep.totalReviews} review${rep.totalReviews !== 1 ? 's' : ''}</div>
              ${getReputationBadge(rep.stars, rep.totalReviews)}
            ` : `
              <div style="font-size: 18px; color: var(--muted);">No reviews yet</div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Complete flights to receive customer reviews</div>
            `}
          </div>
          
          ${hasReviews ? `
          <!-- Rating Distribution -->
          <div style="padding: 16px; background: var(--bg); border-radius: 8px;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">Rating Distribution</div>
            ${[5, 4, 3, 2, 1].map(stars => {
              const count = distribution[stars];
              const pct = rep.totalReviews > 0 ? Math.round((count / rep.totalReviews) * 100) : 0;
              return `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="width: 24px; font-size: 12px;">${stars}â˜…</span>
                  <div style="flex: 1; height: 6px; background: var(--panel); border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: ${pct}%; background: ${stars >= 4 ? 'var(--success)' : stars === 3 ? 'var(--warning)' : 'var(--danger)'}; border-radius: 3px;"></div>
                  </div>
                  <span style="width: 32px; font-size: 11px; color: var(--muted); text-align: right;">${pct}%</span>
                </div>
              `;
            }).join('')}
          </div>
          ` : ''}
          
          <!-- Recent Reviews Preview -->
          ${hasReviews && rep.reviewLog && rep.reviewLog.length > 0 ? `
          <div style="padding: 16px; background: var(--bg); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 12px; color: var(--muted);">Recent Reviews</span>
              <button class="btn btn-small" onclick="document.querySelector('[data-right-subtab=company-reviews]').click()">View All</button>
            </div>
            ${rep.reviewLog.slice(0, 3).map(review => `
              <div style="padding: 10px; background: var(--panel); border-radius: 6px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 13px; font-weight: 500;">${review.clientName}</span>
                  <span style="font-size: 11px; color: var(--muted);">${formatGameDate(review.date)}</span>
                </div>
                <div style="font-size: 12px; color: var(--warning); margin-bottom: 4px;">${'â˜…'.repeat(review.stars)}${'â˜†'.repeat(5 - review.stars)}</div>
                <div style="font-size: 12px; color: var(--text); font-style: italic;">"${review.comment}"</div>
              </div>
            `).join('')}
          </div>
          ` : ''}
        </div>
      `;
    }
    
    function renderCompanyReviews() {
      const container = document.getElementById('companyReviews');
      if (!container) return;
      
      const rep = S.reputation || { stars: 0, totalReviews: 0, reviewLog: [] };
      
      if (!rep.reviewLog || rep.reviewLog.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">â­</div>
            <div style="font-size: 16px; margin-bottom: 8px;">No reviews yet</div>
            <div style="font-size: 13px;">Complete flights to receive customer reviews</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <select id="reviewFilterRating" onchange="renderCompanyReviews()" style="flex: 1; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
              <option value="">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
            <select id="reviewFilterSort" onchange="renderCompanyReviews()" style="flex: 1; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 12px;">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="highest">Highest Rated</option>
              <option value="lowest">Lowest Rated</option>
            </select>
            <button onclick="addCustomReview()" class="btn btn-small" style="padding: 6px 10px; font-size: 11px;">+ Add Review</button>
          </div>
          <div id="reviewsList"></div>
        </div>
      `;
      
      // Get filter values
      const ratingFilter = document.getElementById('reviewFilterRating')?.value || '';
      const sortFilter = document.getElementById('reviewFilterSort')?.value || 'newest';
      
      // Filter and sort
      let reviews = [...rep.reviewLog];
      if (ratingFilter) {
        reviews = reviews.filter(r => r.stars === parseInt(ratingFilter));
      }
      
      reviews.sort((a, b) => {
        if (sortFilter === 'oldest') return new Date(a.date.year, a.date.month - 1, a.date.day) - new Date(b.date.year, b.date.month - 1, b.date.day);
        if (sortFilter === 'highest') return b.stars - a.stars;
        if (sortFilter === 'lowest') return a.stars - b.stars;
        return new Date(b.date.year, b.date.month - 1, b.date.day) - new Date(a.date.year, a.date.month - 1, a.date.day); // newest
      });
      
      const listContainer = document.getElementById('reviewsList');
      if (!listContainer) return;
      
      if (reviews.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No reviews match this filter</div>';
        return;
      }
      
      listContainer.innerHTML = reviews.map(review => `
        <div style="padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <div>
              <div style="font-size: 13px; font-weight: 600;">${review.clientName}</div>
              <div style="font-size: 11px; color: var(--muted);">${review.missionType}</div>
            </div>
            <div style="text-align: right; display: flex; align-items: flex-start; gap: 8px;">
              <div>
                <div style="font-size: 11px; color: var(--muted);">${formatGameDate(review.date)}</div>
                <div style="font-size: 11px; color: var(--muted);">${review.route || ''}</div>
              </div>
              <button onclick="deleteReview('${review.id}')" style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 0;" title="Delete review">Ã—</button>
            </div>
          </div>
          <div style="font-size: 14px; color: var(--warning); margin-bottom: 6px;">${'â˜…'.repeat(review.stars)}${'â˜†'.repeat(5 - review.stars)}</div>
          <div style="font-size: 13px; color: var(--text); font-style: italic; line-height: 1.4;">"${review.comment}"</div>
        </div>
      `).join('');
    }
    window.renderCompanyReviews = renderCompanyReviews;
    
    function deleteReview(reviewId) {
      if (!confirm('Delete this review?')) return;
      
      const review = S.reputation.reviewLog.find(r => r.id === reviewId);
      if (!review) return;
      
      // Remove from review log
      S.reputation.reviewLog = S.reputation.reviewLog.filter(r => r.id !== reviewId);
      
      // Remove from recent ratings
      const ratingIndex = S.reputation.recentRatings.indexOf(review.stars);
      if (ratingIndex >= 0) {
        S.reputation.recentRatings.splice(ratingIndex, 1);
      }
      
      // Recalculate stats
      S.reputation.totalReviews = Math.max(0, (S.reputation.totalReviews || 0) - 1);
      if (S.reputation.recentRatings.length > 0) {
        const sum = S.reputation.recentRatings.reduce((a, b) => a + b, 0);
        S.reputation.stars = Math.round((sum / S.reputation.recentRatings.length) * 10) / 10;
      } else {
        S.reputation.stars = 0;
      }
      
      saveState();
      render();
      showToast('Review Deleted', 'Review removed from history', 'info');
    }
    window.deleteReview = deleteReview;
    
    function addCustomReview() {
      const stars = parseInt(prompt('Enter star rating (1-5):', '5'));
      if (isNaN(stars) || stars < 1 || stars > 5) {
        alert('Invalid rating. Enter 1-5.');
        return;
      }
      
      const clientName = prompt('Client name:', 'Custom Client') || 'Custom Client';
      const missionType = prompt('Mission type:', 'Charter Flight') || 'Charter Flight';
      const comment = prompt('Review comment:', 'Great service!') || 'Great service!';
      
      const review = {
        id: 'REV-CUSTOM-' + Date.now(),
        date: { ...S.gameTime },
        stars: stars,
        clientName: clientName,
        clientTier: 'regional',
        missionType: missionType,
        route: 'Custom',
        comment: comment
      };
      
      if (!S.reputation.reviewLog) S.reputation.reviewLog = [];
      S.reputation.reviewLog.unshift(review);
      
      if (!S.reputation.recentRatings) S.reputation.recentRatings = [];
      S.reputation.recentRatings.unshift(stars);
      if (S.reputation.recentRatings.length > 20) {
        S.reputation.recentRatings = S.reputation.recentRatings.slice(0, 20);
      }
      
      S.reputation.totalReviews = (S.reputation.totalReviews || 0) + 1;
      const sum = S.reputation.recentRatings.reduce((a, b) => a + b, 0);
      S.reputation.stars = Math.round((sum / S.reputation.recentRatings.length) * 10) / 10;
      
      saveState();
      render();
      showToast('Review Added', `Added ${stars}-star review`, 'success');
    }
    window.addCustomReview = addCustomReview;
    
    // Render Insurance detail page
    function renderCompanyInsurance() {
      const container = document.getElementById('companyInsurance');
      if (!container) return;
      
      const breakdown = getInsuranceBreakdown();
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <!-- Premium Summary -->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <div style="font-size: 14px; color: var(--muted);">Current Monthly Premium</div>
                <div style="font-size: 28px; font-weight: 600; color: var(--warning);">${formatCurrency(breakdown.currentPremium)}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 14px; color: var(--muted);">Next Month (est)</div>
                <div style="font-size: 20px; color: var(--text-secondary);">${formatCurrency(breakdown.projectedPremium)}</div>
              </div>
            </div>
            <div style="font-size: 11px; color: var(--muted); padding: 10px; background: var(--bg); border-radius: 6px;">
              ðŸ’¡ Liability insurance is required for all commercial operations. Premium is charged on the 1st of each month and covers all owned aircraft. Leased aircraft are covered by the lessor.
            </div>
          </div>
          
          <!-- Aircraft Coverage -->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 16px;">
            <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Coverage by Aircraft</div>
            ${breakdown.aircraft.length === 0 ? `
              <div style="color: var(--muted); font-size: 13px;">No owned aircraft to insure.</div>
            ` : breakdown.aircraft.map(a => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: 500;">${a.name}</div>
                  <div style="font-size: 11px; color: var(--muted);">${a.tail} â€¢ ${a.seats} seats â€¢ ${formatCurrency(a.hullValue)} hull value</div>
                </div>
                <div style="font-weight: 500; color: var(--warning);">${formatCurrency(a.premium)}/mo</div>
              </div>
            `).join('')}
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--border); margin-top: 4px;">
              <span style="font-size: 12px; color: var(--muted);">Base Aircraft Premium</span>
              <span style="font-weight: 500;">${formatCurrency(breakdown.totalAircraftPremium)}</span>
            </div>
          </div>
          
          <!-- Premium Factors -->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 16px;">
            <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Premium Factors</div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <!-- Flight Hours -->
              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 13px; color: var(--muted);">Last Month Flight Hours</span>
                  <span style="font-size: 13px; color: var(--warning);">+${formatCurrency(breakdown.hoursPremium)}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${Math.min(breakdown.lastMonthHours / 100 * 100, 100)}%; height: 100%; background: var(--warning); border-radius: 3px;"></div>
                  </div>
                  <span style="font-size: 12px; min-width: 50px; text-align: right;">${breakdown.lastMonthHours.toFixed(1)} hrs</span>
                </div>
              </div>
              
              <!-- Mission Risk -->
              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 13px; color: var(--muted);">Mission Risk Average</span>
                  <span style="font-size: 13px; color: ${breakdown.missionRiskMultiplier > 1.1 ? 'var(--danger)' : breakdown.missionRiskMultiplier > 1 ? 'var(--warning)' : 'var(--success)'};">Ã—${breakdown.missionRiskMultiplier.toFixed(2)}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${Math.min((breakdown.missionRiskMultiplier - 0.8) / 0.8 * 100, 100)}%; height: 100%; background: ${breakdown.missionRiskMultiplier > 1.1 ? 'var(--danger)' : breakdown.missionRiskMultiplier > 1 ? 'var(--warning)' : 'var(--success)'}; border-radius: 3px;"></div>
                  </div>
                  <span style="font-size: 12px; min-width: 50px; text-align: right;">${(breakdown.missionRiskMultiplier * 100).toFixed(0)}%</span>
                </div>
              </div>
              
              <!-- Experience -->
              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 13px; color: var(--muted);">Experience</span>
                  <span style="font-size: 13px; color: ${breakdown.experienceDiscount > 0 ? 'var(--success)' : breakdown.experiencePenalty > 0 ? 'var(--danger)' : 'var(--muted)'};">
                    ${breakdown.experienceDiscount > 0 ? `-${(breakdown.experienceDiscount * 100).toFixed(0)}%` : breakdown.experiencePenalty > 0 ? `+${(breakdown.experiencePenalty * 100).toFixed(0)}%` : 'Â±0%'}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${(1 - breakdown.experienceMultiplier + 0.2) / 0.4 * 100}%; height: 100%; background: ${breakdown.experienceDiscount > 0 ? 'var(--success)' : breakdown.experiencePenalty > 0 ? 'var(--danger)' : 'var(--muted)'}; border-radius: 3px;"></div>
                  </div>
                </div>
              </div>
              
              <!-- Clean Record -->
              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 13px; color: var(--muted);">Clean Record</span>
                  <span style="font-size: 13px; color: ${breakdown.cleanDiscount > 0 ? 'var(--success)' : 'var(--muted)'};">
                    ${breakdown.cleanDiscount > 0 ? `-${(breakdown.cleanDiscount * 100).toFixed(0)}%` : 'Â±0%'}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${Math.min(breakdown.incidentFreeMonths / 10 * 100, 100)}%; height: 100%; background: var(--success); border-radius: 3px;"></div>
                  </div>
                  <span style="font-size: 12px; min-width: 50px; text-align: right;">${breakdown.incidentFreeMonths} mo</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tips -->
          <div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid var(--accent); padding: 12px; border-radius: 0 6px 6px 0;">
            <div style="font-size: 12px; font-weight: 500; margin-bottom: 6px;">ðŸ’¡ Reducing Your Premium</div>
            <ul style="font-size: 11px; color: var(--muted); margin: 0; padding-left: 16px; line-height: 1.6;">
              <li>Gain experience to unlock pilot discounts (up to 20% off)</li>
              <li>Maintain a clean record â€” no damage reports means lower rates</li>
              <li>Higher-risk missions (medical, emergency) increase premiums</li>
              <li>More flight hours = more exposure = higher premium</li>
            </ul>
          </div>
        </div>
      `;
    }
    window.renderCompanyInsurance = renderCompanyInsurance;
    
    // === BASE MANAGEMENT UI ===
    
    function renderCompanyBases() {
      const container = document.getElementById('basesList');
      if (!container) return;
      
      const bases = S.bases.list || [];
      
      // Gather all active construction across all bases
      let activeConstruction = [];
      for (const base of bases) {
        for (const hangar of base.hangars) {
          if (hangar.status === 'constructing') {
            const config = HANGARS[hangar.type];
            // Calculate start date from completion - build days if not stored
            const startDate = hangar.startDate || {
              year: S.gameTime.year,
              month: S.gameTime.month, 
              day: S.gameTime.day
            };
            activeConstruction.push({
              type: config?.name || 'Hangar',
              base: base.icao,
              startDate: startDate,
              completion: hangar.completionDate,
              buildDays: config?.buildDays || 14
            });
          }
        }
        // Fuel tank construction
        for (const fuelType of ['100LL', 'JetA']) {
          for (const tank of (base.fuelStorage[fuelType] || [])) {
            if (tank.status === 'constructing') {
              const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
              const startDate = tank.startDate || { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
              activeConstruction.push({
                type: tierConfig?.name || 'Fuel Tank',
                base: base.icao,
                startDate: startDate,
                completion: tank.completionDate,
                buildDays: tierConfig?.buildDays || 7
              });
            }
          }
        }
        // MX facility construction
        if (base.mxFacility?.status === 'constructing') {
          const config = MX_FACILITIES[base.mxFacility.type];
          const startDate = base.mxFacility.startDate || { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
          activeConstruction.push({
            type: config?.name || 'MX Facility',
            base: base.icao,
            startDate: startDate,
            completion: base.mxFacility.completionDate,
            buildDays: config?.buildDays || 7
          });
        }
        
        // Parts room construction
        if (base.mxFacility?.partsRoomConstructing) {
          const startDate = base.mxFacility.partsRoomConstructing.startDate || { year: S.gameTime.year, month: S.gameTime.month, day: S.gameTime.day };
          activeConstruction.push({
            type: 'Parts Room',
            base: base.icao,
            startDate: startDate,
            completion: base.mxFacility.partsRoomConstructing.completionDate,
            buildDays: MX_PARTS_ROOM.buildDays
          });
        }
      }
      
      let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <div style="font-size: 14px; font-weight: 600;">Your Bases</div>
            <div style="font-size: 12px; color: var(--muted);">${bases.length} location${bases.length !== 1 ? 's' : ''}</div>
          </div>
          <button class="btn btn-small primary" onclick="showEstablishBaseModal()">+ New Base</button>
        </div>
      `;
      
      // Construction box
      if (activeConstruction.length > 0) {
        let constructionHtml = '<div style="background: rgba(210, 153, 34, 0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 12px; margin-bottom: 16px;">';
        constructionHtml += '<div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">ðŸš§ Active Construction</div>';
        
        for (const c of activeConstruction) {
          const startDays = (c.startDate.year * 336) + ((c.startDate.month - 1) * 28) + c.startDate.day;
          const endDays = (c.completion.year * 336) + ((c.completion.month - 1) * 28) + c.completion.day;
          const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
          const totalDays = Math.max(1, endDays - startDays);
          const elapsedDays = currentDays - startDays;
          const progressPct = Math.min(100, Math.max(0, Math.round((elapsedDays / totalDays) * 100)));
          const daysRemaining = Math.max(0, endDays - currentDays);
          
          constructionHtml += '<div style="padding: 6px 0;">';
          constructionHtml += '<div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">';
          constructionHtml += '<span>' + c.type + ' at ' + c.base + '</span>';
          constructionHtml += '<span style="color: var(--muted);">' + daysRemaining + ' day' + (daysRemaining !== 1 ? 's' : '') + ' remaining</span>';
          constructionHtml += '</div>';
          constructionHtml += '<div style="background: var(--bg); border-radius: 4px; height: 8px; overflow: hidden;">';
          constructionHtml += '<div style="background: var(--warning); height: 100%; width: ' + progressPct + '%;"></div>';
          constructionHtml += '</div>';
          constructionHtml += '</div>';
        }
        
        constructionHtml += '</div>';
        html += constructionHtml;
      }
      
      // Facility upkeep summary
      const upkeep = calculateMonthlyFacilityUpkeep();
      if (upkeep.total > 0) {
        html += `
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; font-size: 13px;">ðŸ—ï¸ Monthly Facility Upkeep</div>
                <div style="font-size: 11px; color: var(--muted);">${upkeep.hangars} hangar${upkeep.hangars !== 1 ? 's' : ''}, ${upkeep.tanks} fuel tank${upkeep.tanks !== 1 ? 's' : ''}</div>
              </div>
              <div style="font-weight: 600; font-size: 14px; color: var(--warning);">${formatCurrency(upkeep.total)}/mo</div>
            </div>
          </div>
        `;
      }
      
      // Unit explanation
      html += `
        <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 11px; color: var(--muted);">
          <div style="font-weight: 600; margin-bottom: 6px; color: var(--text);">Aircraft Sizes (hangar units):</div>
          <div>Small (1): Single piston, helicopters, bush planes</div>
          <div>Medium (2): Twin piston, turboprops, amphibious</div>
          <div>Large (4): Light jets, military fighters</div>
          <div>XL (6): Airliners, military cargo</div>
          <div style="margin-top: 6px;">Hangared aircraft degrade 50% slower than aircraft on the ramp.</div>
        </div>
      `;
      
      if (bases.length === 0) {
        html += `<div style="text-align: center; color: var(--muted); padding: 40px;">No bases established yet.</div>`;
      } else {
        html += `<div style="display: flex; flex-direction: column; gap: 12px;">`;
        
        for (const base of bases) {
          const airport = getAirport(base.icao);
          const aircraftCount = getAircraftAtBase(base.id).length;
          const staffCount = getStaffAtBase(base.id).length;
          const operationalHangars = base.hangars.filter(h => h.status === 'operational').length;
          const tankCount = base.fuelStorage['100LL'].length + base.fuelStorage['JetA'].length;
          
          html += `
            <div class="base-card" style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; cursor: pointer;" onclick="showBaseDetail('${base.id}')">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px;">
                    ${base.icao}
                    ${base.isPrimary ? '<span style="background: var(--accent); color: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">PRIMARY</span>' : ''}
                  </div>
                  <div style="font-size: 12px; color: var(--muted);">${airport?.name || base.name}</div>
                </div>
                <div style="text-align: right; font-size: 12px; color: var(--muted);">
                  <div>${aircraftCount} aircraft</div>
                  <div>${staffCount} staff</div>
                </div>
              </div>
              <div style="margin-top: 12px; font-size: 11px; color: var(--muted);">
                <div>ðŸ  Hangars: ${operationalHangars > 0 ? operationalHangars : 'None'}</div>
                <div>ðŸ”§ Maintenance Facilities: ${base.mxFacility?.status === 'operational' ? MX_FACILITIES[base.mxFacility.type]?.name : (base.mxFacility?.status === 'constructing' ? 'Under construction' : 'None')}</div>
                <div>â›½ Fuel Tanks: ${tankCount > 0 ? tankCount : 'None'}</div>
              </div>
            </div>
          `;
        }
        
        html += `</div>`;
      }
      
      container.innerHTML = html;
    }
    window.renderCompanyBases = renderCompanyBases;
    
    function showEstablishBaseModal() {
      const modalHtml = `
        <div class="modal-overlay" id="establishBaseModal" onclick="if(event.target === this) closeEstablishBaseModal()">
          <div class="modal-dialog" style="max-width: 450px;">
            <div class="modal-header">
              <h3>Establish New Base</h3>
              <button class="modal-close" onclick="closeEstablishBaseModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Enter airport ICAO code:</div>
                <input type="text" id="newBaseIcao" placeholder="KLAX" maxlength="4" 
                       style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px; text-transform: uppercase;"
                       oninput="validateNewBase()">
                <div id="newBaseAirportInfo" style="margin-top: 8px; font-size: 12px; color: var(--muted);"></div>
              </div>
              
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="color: var(--muted);">Establishment Fee:</span>
                  <span style="font-weight: 600; color: var(--warning);">${formatCurrency(BASE_ESTABLISHMENT_COST)}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--muted);">Your Cash:</span>
                  <span style="font-weight: 600; ${S.cash < BASE_ESTABLISHMENT_COST ? 'color: var(--danger);' : ''}">${formatCurrency(S.cash)}</span>
                </div>
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeEstablishBaseModal()">Cancel</button>
                <button class="btn primary" id="confirmEstablishBase" onclick="confirmEstablishBase()" disabled>Establish Base</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('newBaseIcao').focus();
    }
    window.showEstablishBaseModal = showEstablishBaseModal;
    
    function closeEstablishBaseModal() {
      const modal = document.getElementById('establishBaseModal');
      if (modal) modal.remove();
    }
    window.closeEstablishBaseModal = closeEstablishBaseModal;
    
    function validateNewBase() {
      const input = document.getElementById('newBaseIcao');
      const info = document.getElementById('newBaseAirportInfo');
      const btn = document.getElementById('confirmEstablishBase');
      
      const code = input.value.toUpperCase().trim();
      
      if (code.length < 3) {
        info.innerHTML = '';
        btn.disabled = true;
        return;
      }
      
      const airport = getAirport(code);
      
      if (!airport) {
        info.innerHTML = `<span style="color: var(--danger);">Airport not found</span>`;
        btn.disabled = true;
        return;
      }
      
      // Check if already have base there
      if (S.bases.list.some(b => b.icao === code)) {
        info.innerHTML = `<span style="color: var(--warning);">You already have a base at ${code}</span>`;
        btn.disabled = true;
        return;
      }
      
      // Check funds
      if (S.cash < BASE_ESTABLISHMENT_COST) {
        info.innerHTML = `<span style="color: var(--success);">${airport.name}</span><br><span style="color: var(--danger);">Insufficient funds</span>`;
        btn.disabled = true;
        return;
      }
      
      info.innerHTML = `<span style="color: var(--success);">${airport.name}</span>`;
      btn.disabled = false;
    }
    window.validateNewBase = validateNewBase;
    
    function confirmEstablishBase() {
      const input = document.getElementById('newBaseIcao');
      const code = input.value.toUpperCase().trim();
      
      if (establishBase(code)) {
        closeEstablishBaseModal();
        renderCompanyBases();
      }
    }
    window.confirmEstablishBase = confirmEstablishBase;
    
    function showBaseDetail(baseId) {
      const base = getBase(baseId);
      if (!base) return;
      
      const airport = getAirport(base.icao);
      const aircraftAtBase = getAircraftAtBase(baseId);
      const staffAtBase = getStaffAtBase(baseId);
      const rampAircraft = getAircraftOnRamp(baseId);
      
      // Build hangars section
      let hangarsHtml = '';
      const operationalHangars = base.hangars.filter(h => h.status === 'operational');
      const constructingHangars = base.hangars.filter(h => h.status === 'constructing');
      
      if (operationalHangars.length === 0 && constructingHangars.length === 0) {
        hangarsHtml = `<div style="color: var(--muted); font-size: 12px; padding: 12px; text-align: center;">No hangars built</div>`;
      } else {
        // Show operational hangars
        hangarsHtml = operationalHangars.map(h => {
          const config = HANGARS[h.type];
          const usedUnits = (h.aircraft || []).reduce((sum, code) => sum + getAircraftSize(code), 0);
          const aircraftList = (h.aircraft || []).map(code => {
            const ac = AIRCRAFT[code];
            return `<span style="background: var(--panel); padding: 2px 6px; border-radius: 4px; font-size: 10px;">${ac?.name || code}</span>`;
          }).join(' ');
          const demoCost = Math.round((config?.buildCost || 50000) * 0.10);
          
          return `
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-weight: 600; font-size: 13px;">${config?.name || 'Hangar'}</div>
                <div style="font-size: 12px; color: var(--muted);">${usedUnits}/${config?.capacity || 0} units</div>
              </div>
              <div style="margin-bottom: 8px; min-height: 20px;">
                ${aircraftList || '<span style="color: var(--muted); font-size: 11px;">Empty</span>'}
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-small" onclick="showHangarAssignModal('${baseId}', '${h.id}')" style="font-size: 11px;">Manage Aircraft</button>
                <button class="btn btn-small" onclick="confirmDismantleHangar('${baseId}', '${h.id}', '${config?.name || 'Hangar'}', ${demoCost})" style="font-size: 11px; color: var(--danger);">Dismantle</button>
              </div>
            </div>
          `;
        }).join('');
        
        // Show constructing hangars
        if (constructingHangars.length > 0) {
          hangarsHtml += constructingHangars.map(h => {
            const config = HANGARS[h.type];
            return `
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; opacity: 0.7;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="font-weight: 600; font-size: 13px;">ðŸš§ ${config?.name || 'Hangar'}</div>
                  <div style="font-size: 11px; color: var(--warning);">Under construction</div>
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  Completion: ${h.completionDate.month}/${h.completionDate.day}/${h.completionDate.year}
                </div>
              </div>
            `;
          }).join('');
        }
      }
      
      // Ramp aircraft (not in hangars)
      let rampHtml = '';
      if (rampAircraft.length > 0) {
        rampHtml = `
          <div style="margin-top: 8px; padding: 8px; background: rgba(210, 153, 34, 0.1); border-radius: 6px; border: 1px solid var(--warning);">
            <div style="font-size: 11px; color: var(--warning); margin-bottom: 4px;">âš ï¸ On Ramp (2x degradation)</div>
            <div style="font-size: 11px; color: var(--muted);">
              ${rampAircraft.map(code => AIRCRAFT[code]?.name || code).join(', ')}
            </div>
          </div>
        `;
      }
      
      // Build hangar button
      const canBuildHangar = base.hangars.length < HANGAR_MAX_PER_BASE;
      const buildHangarBtn = canBuildHangar 
        ? `<button class="btn btn-small primary" onclick="showBuildHangarModal('${baseId}')" style="font-size: 11px;">+ Build Hangar</button>`
        : `<span style="font-size: 11px; color: var(--muted);">Max hangars reached</span>`;
      
      // Build aircraft section
      let aircraftHtml = '';
      if (aircraftAtBase.length === 0) {
        aircraftHtml = `<div style="color: var(--muted); font-size: 12px; padding: 12px; text-align: center;">No aircraft at this base</div>`;
      } else {
        aircraftHtml = aircraftAtBase.map(code => {
          const ac = AIRCRAFT[code];
          const fleetData = S.fleetData?.[code] || {};
          const hangared = isAircraftHangared(code);
          const sizeUnits = getAircraftSize(code);
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg); border-radius: 6px; margin-bottom: 6px;">
              <div>
                <div style="font-weight: 500; font-size: 13px;">
                  ${ac?.name || code}
                  <span style="font-size: 10px; color: var(--muted);">(${sizeUnits} unit${sizeUnits > 1 ? 's' : ''})</span>
                </div>
                <div style="font-size: 11px; color: var(--muted);">
                  ${fleetData.tailNumber || code}
                  ${hangared ? '<span style="color: var(--success);"> â€¢ Hangared</span>' : '<span style="color: var(--warning);"> â€¢ Ramp</span>'}
                </div>
              </div>
              <select onchange="reassignAircraft('${code}', this.value)" style="padding: 4px 8px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 11px;">
                ${S.bases.list.map(b => `<option value="${b.id}" ${b.id === baseId ? 'selected' : ''}>${b.icao}</option>`).join('')}
              </select>
            </div>
          `;
        }).join('');
      }
      
      // Build staff section
      let staffHtml = '';
      if (staffAtBase.length === 0) {
        staffHtml = `<div style="color: var(--muted); font-size: 12px; padding: 12px; text-align: center;">No staff at this base</div>`;
      } else {
        staffHtml = staffAtBase.map(s => {
          const roleName = getRoleDisplayName(s.role);
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg); border-radius: 6px; margin-bottom: 6px;">
              <div>
                <div style="font-weight: 500; font-size: 13px;">${s.name}</div>
                <div style="font-size: 11px; color: var(--muted);">${roleName}</div>
              </div>
              <select onchange="reassignStaff('${s.id}', this.value)" style="padding: 4px 8px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 11px;">
                ${S.bases.list.map(b => `<option value="${b.id}" ${b.icao === s.assignedBase ? 'selected' : ''}>${b.icao}</option>`).join('')}
              </select>
            </div>
          `;
        }).join('');
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="baseDetailModal" onclick="if(event.target === this) closeBaseDetailModal()">
          <div class="modal-dialog" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>${base.icao} ${base.isPrimary ? '(Primary)' : ''}</h3>
              <button class="modal-close" onclick="closeBaseDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <div style="font-size: 14px; font-weight: 600;">${airport?.name || base.name}</div>
                <div style="font-size: 12px; color: var(--muted);">Established: ${base.established.month}/${base.established.day}/${base.established.year}</div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <div style="font-weight: 600; font-size: 13px;">ðŸ  Hangars</div>
                  ${buildHangarBtn}
                </div>
                ${hangarsHtml}
                ${rampHtml}
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">âœˆï¸ Aircraft (${aircraftAtBase.length})</div>
                ${aircraftHtml}
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">ðŸ‘¥ Staff (${staffAtBase.length})</div>
                ${staffHtml}
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <div style="font-weight: 600; font-size: 13px;">ðŸ”§ Maintenance Facilities</div>
                  ${!base.mxFacility || base.mxFacility.status !== 'constructing' ? 
                    `<button class="btn btn-small primary" onclick="showBuildMxFacilityModal('${baseId}')" style="font-size: 11px;">${base.mxFacility?.status === 'operational' ? 'Upgrade' : '+ Build'}</button>` : ''}
                </div>
                ${buildMxFacilityHtml(base, baseId)}
              </div>
              
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <div style="font-weight: 600; font-size: 13px;">â›½ Fuel Tanks</div>
                  <button class="btn btn-small primary" onclick="showBuildFuelTankModal('${baseId}')" style="font-size: 11px;">+ Build Tank</button>
                </div>
                ${buildFuelTanksHtml(base, baseId)}
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeBaseDetailModal()">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showBaseDetail = showBaseDetail;
    
    function closeBaseDetailModal() {
      const modal = document.getElementById('baseDetailModal');
      if (modal) modal.remove();
    }
    window.closeBaseDetailModal = closeBaseDetailModal;
    
    function showBuildHangarModal(baseId) {
      const base = getBase(baseId);
      if (!base) return;
      
      const hangarsHtml = Object.entries(HANGARS).map(([key, config]) => {
        const canAfford = S.cash >= config.buildCost;
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; ${!canAfford ? 'opacity: 0.6;' : ''}">
            <div>
              <div style="font-weight: 600;">${config.name}</div>
              <div style="font-size: 12px; color: var(--muted);">
                Capacity: ${config.capacity} units â€¢ Build time: ${config.buildDays} days â€¢ Upkeep: ${formatCurrency(config.monthly)}/mo
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600; color: var(--warning);">${formatCurrency(config.buildCost)}</div>
              <button class="btn btn-small primary" onclick="confirmBuildHangar('${baseId}', '${key}')" ${!canAfford ? 'disabled' : ''} style="margin-top: 4px;">
                Build
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      const modalHtml = `
        <div class="modal-overlay" id="buildHangarModal" onclick="if(event.target === this) closeBuildHangarModal()">
          <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-header">
              <h3>Build Hangar at ${base.icao}</h3>
              <button class="modal-close" onclick="closeBuildHangarModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted);">
                  <span>Available Cash:</span>
                  <span style="color: var(--text);">${formatCurrency(S.cash)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted);">
                  <span>Hangars at base:</span>
                  <span style="color: var(--text);">${base.hangars.length} / ${HANGAR_MAX_PER_BASE}</span>
                </div>
              </div>
              ${hangarsHtml}
              <div style="font-size: 11px; color: var(--muted); margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px;">
                <div style="margin-bottom: 6px;"><strong>Aircraft Sizes (hangar units):</strong></div>
                <div>Small (1): Single piston, helicopters, bush planes</div>
                <div>Medium (2): Twin piston, turboprops, amphibious</div>
                <div>Large (4): Light jets, military fighters</div>
                <div>XL (6): Airliners, military cargo</div>
                <div style="margin-top: 8px;">Hangared aircraft degrade 50% slower than aircraft on the ramp.</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showBuildHangarModal = showBuildHangarModal;
    
    function closeBuildHangarModal() {
      const modal = document.getElementById('buildHangarModal');
      if (modal) modal.remove();
    }
    window.closeBuildHangarModal = closeBuildHangarModal;
    
    function confirmBuildHangar(baseId, hangarType) {
      const config = HANGARS[hangarType];
      const base = getBase(baseId);
      
      if (confirm(`Build ${config.name} at ${base.icao}?\n\nCost: ${formatCurrency(config.buildCost)}\nBuild time: ${config.buildDays} days\nMonthly upkeep: ${formatCurrency(config.monthly)}`)) {
        closeBuildHangarModal();
        closeBaseDetailModal();
        buildHangar(baseId, hangarType);
      }
    }
    window.confirmBuildHangar = confirmBuildHangar;
    
    function showHangarAssignModal(baseId, hangarId) {
      const base = getBase(baseId);
      const hangar = base?.hangars.find(h => h.id === hangarId);
      if (!base || !hangar) return;
      
      const config = HANGARS[hangar.type];
      const usedUnits = (hangar.aircraft || []).reduce((sum, code) => sum + getAircraftSize(code), 0);
      const availableUnits = config.capacity - usedUnits;
      
      // Get aircraft at this base
      const aircraftAtBase = getAircraftAtBase(baseId);
      
      // Current hangar aircraft
      const hangarAircraft = hangar.aircraft || [];
      
      // Ramp aircraft (available to add)
      const rampAircraft = aircraftAtBase.filter(code => !hangarAircraft.includes(code) && !isAircraftHangared(code));
      
      let currentHtml = '';
      if (hangarAircraft.length === 0) {
        currentHtml = `<div style="color: var(--muted); font-size: 12px; padding: 8px; text-align: center;">Hangar is empty</div>`;
      } else {
        currentHtml = hangarAircraft.map(code => {
          const ac = AIRCRAFT[code];
          const size = getAircraftSize(code);
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--panel); border-radius: 6px; margin-bottom: 4px;">
              <div>
                <span style="font-weight: 500;">${ac?.name || code}</span>
                <span style="font-size: 11px; color: var(--muted);"> (${size} unit${size > 1 ? 's' : ''})</span>
              </div>
              <button class="btn btn-small" onclick="removeAircraftFromHangar('${code}', '${baseId}', '${hangarId}')" style="font-size: 10px;">Remove</button>
            </div>
          `;
        }).join('');
      }
      
      let rampHtml = '';
      if (rampAircraft.length === 0) {
        rampHtml = `<div style="color: var(--muted); font-size: 12px; padding: 8px; text-align: center;">No aircraft on ramp</div>`;
      } else {
        rampHtml = rampAircraft.map(code => {
          const ac = AIRCRAFT[code];
          const size = getAircraftSize(code);
          const fits = size <= availableUnits;
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--panel); border-radius: 6px; margin-bottom: 4px; ${!fits ? 'opacity: 0.5;' : ''}">
              <div>
                <span style="font-weight: 500;">${ac?.name || code}</span>
                <span style="font-size: 11px; color: var(--muted);"> (${size} unit${size > 1 ? 's' : ''})</span>
              </div>
              <button class="btn btn-small primary" onclick="addAircraftToHangar('${code}', '${baseId}', '${hangarId}')" ${!fits ? 'disabled' : ''} style="font-size: 10px;">Add</button>
            </div>
          `;
        }).join('');
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="hangarAssignModal" onclick="if(event.target === this) closeHangarAssignModal()">
          <div class="modal-dialog" style="max-width: 450px;">
            <div class="modal-header">
              <h3>${config.name}</h3>
              <button class="modal-close" onclick="closeHangarAssignModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 13px;">
                <span>Capacity:</span>
                <span><strong>${usedUnits}</strong> / ${config.capacity} units</span>
              </div>
              
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px;">In Hangar</div>
                ${currentHtml}
              </div>
              
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px;">On Ramp (available)</div>
                ${rampHtml}
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeHangarAssignModal()">Done</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showHangarAssignModal = showHangarAssignModal;
    
    function closeHangarAssignModal() {
      const modal = document.getElementById('hangarAssignModal');
      if (modal) modal.remove();
    }
    window.closeHangarAssignModal = closeHangarAssignModal;
    
    function addAircraftToHangar(aircraftCode, baseId, hangarId) {
      if (assignToHangar(aircraftCode, hangarId)) {
        closeHangarAssignModal();
        showHangarAssignModal(baseId, hangarId);
      }
    }
    window.addAircraftToHangar = addAircraftToHangar;
    
    function removeAircraftFromHangar(aircraftCode, baseId, hangarId) {
      removeFromHangar(aircraftCode);
      closeHangarAssignModal();
      showHangarAssignModal(baseId, hangarId);
    }
    window.removeAircraftFromHangar = removeAircraftFromHangar;
    
    function confirmDismantleHangar(baseId, hangarId, hangarName, demoCost) {
      if (confirm(`Dismantle ${hangarName}?\n\nDemolition cost: ${formatCurrency(demoCost)}\n\nAny aircraft in this hangar will be moved to the ramp.\n\nThis cannot be undone.`)) {
        if (dismantleHangar(baseId, hangarId)) {
          closeBaseDetailModal();
          showBaseDetail(baseId);
        }
      }
    }
    window.confirmDismantleHangar = confirmDismantleHangar;
    
    // Build fuel tanks HTML for base detail
    function buildFuelTanksHtml(base, baseId) {
      let html = '';
      
      const allTanks = [
        ...(base.fuelStorage['100LL'] || []).map(t => ({ ...t, fuelType: '100LL' })),
        ...(base.fuelStorage['JetA'] || []).map(t => ({ ...t, fuelType: 'JetA' }))
      ];
      
      const operationalTanks = allTanks.filter(t => t.status === 'operational');
      const constructingTanks = allTanks.filter(t => t.status === 'constructing');
      
      if (operationalTanks.length === 0 && constructingTanks.length === 0) {
        return '<div style="background: var(--bg); border-radius: 8px; padding: 12px; font-size: 12px; color: var(--muted);">No tanks â€” paying FBO rates</div>';
      }
      
      // Operational tanks
      for (const tank of operationalTanks) {
        const tierConfig = FUEL_STORAGE[tank.fuelType]?.tiers[tank.tier];
        const fillPct = Math.round((tank.level / tank.capacity) * 100);
        const demoCost = Math.round((tierConfig?.buildCost || 15000) * 0.10);
        
        html += `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <div style="font-weight: 600; font-size: 13px;">${tierConfig?.name || 'Tank'}</div>
              <div style="font-size: 11px; color: var(--muted);">${tierConfig?.discount ? (tierConfig.discount * 100) + '% discount' : ''}</div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px;">
              <span>${tank.level.toLocaleString()} / ${tank.capacity.toLocaleString()} gal</span>
              <span style="color: var(--muted);">${fillPct}% full</span>
            </div>
            <div style="background: var(--panel); border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
              <div style="background: ${tank.fuelType === '100LL' ? 'var(--accent)' : 'var(--success)'}; height: 100%; width: ${fillPct}%;"></div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-small primary" onclick="showBuyFuelModal('${baseId}', '${tank.id}', '${tank.fuelType}', ${tank.capacity - tank.level})" style="font-size: 11px;">Buy Fuel</button>
              <button class="btn btn-small" onclick="confirmDismantleFuelTank('${baseId}', '${tank.id}', '${tierConfig?.name || 'Tank'}', ${demoCost})" style="font-size: 11px; color: var(--danger);">Dismantle</button>
            </div>
          </div>
        `;
      }
      
      // Constructing tanks
      for (const tank of constructingTanks) {
        const tierConfig = FUEL_STORAGE[tank.fuelType]?.tiers[tank.tier];
        html += `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; opacity: 0.7;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 13px;">ðŸš§ ${tierConfig?.name || 'Tank'}</div>
              <div style="font-size: 11px; color: var(--warning);">Under construction</div>
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
              Completion: ${tank.completionDate.month}/${tank.completionDate.day}/${tank.completionDate.year}
            </div>
          </div>
        `;
      }
      
      return html;
    }
    
    function showBuildFuelTankModal(baseId) {
      const base = getBase(baseId);
      if (!base) return;
      
      const count100LL = base.fuelStorage['100LL']?.length || 0;
      const countJetA = base.fuelStorage['JetA']?.length || 0;
      
      let tanksHtml = '';
      
      // 100LL tanks
      tanksHtml += '<div style="margin-bottom: 16px;"><div style="font-weight: 600; margin-bottom: 8px;">100LL (Avgas)</div>';
      if (count100LL >= FUEL_TANKS_MAX_PER_TYPE) {
        tanksHtml += '<div style="color: var(--muted); font-size: 12px; padding: 8px;">Maximum tanks reached</div>';
      } else {
        for (const [tierKey, tierConfig] of Object.entries(FUEL_STORAGE['100LL'].tiers)) {
          const canAfford = S.cash >= tierConfig.buildCost;
          tanksHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 6px; ${!canAfford ? 'opacity: 0.6;' : ''}">
              <div>
                <div style="font-weight: 500;">${tierConfig.name}</div>
                <div style="font-size: 11px; color: var(--muted);">${tierConfig.capacity.toLocaleString()} gal â€¢ ${tierConfig.buildDays} days â€¢ ${(tierConfig.discount * 100)}% discount</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--warning);">${formatCurrency(tierConfig.buildCost)}</div>
                <button class="btn btn-small primary" onclick="confirmBuildFuelTank('${baseId}', '100LL', '${tierKey}')" ${!canAfford ? 'disabled' : ''} style="margin-top: 4px; font-size: 10px;">Build</button>
              </div>
            </div>
          `;
        }
      }
      tanksHtml += '</div>';
      
      // Jet-A tanks
      tanksHtml += '<div><div style="font-weight: 600; margin-bottom: 8px;">Jet-A</div>';
      if (countJetA >= FUEL_TANKS_MAX_PER_TYPE) {
        tanksHtml += '<div style="color: var(--muted); font-size: 12px; padding: 8px;">Maximum tanks reached</div>';
      } else {
        for (const [tierKey, tierConfig] of Object.entries(FUEL_STORAGE['JetA'].tiers)) {
          const canAfford = S.cash >= tierConfig.buildCost;
          tanksHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 6px; ${!canAfford ? 'opacity: 0.6;' : ''}">
              <div>
                <div style="font-weight: 500;">${tierConfig.name}</div>
                <div style="font-size: 11px; color: var(--muted);">${tierConfig.capacity.toLocaleString()} gal â€¢ ${tierConfig.buildDays} days â€¢ ${(tierConfig.discount * 100)}% discount</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--warning);">${formatCurrency(tierConfig.buildCost)}</div>
                <button class="btn btn-small primary" onclick="confirmBuildFuelTank('${baseId}', 'JetA', '${tierKey}')" ${!canAfford ? 'disabled' : ''} style="margin-top: 4px; font-size: 10px;">Build</button>
              </div>
            </div>
          `;
        }
      }
      tanksHtml += '</div>';
      
      const modalHtml = `
        <div class="modal-overlay" id="buildFuelTankModal" onclick="if(event.target === this) closeBuildFuelTankModal()">
          <div class="modal-dialog" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>Build Fuel Tank at ${base.icao}</h3>
              <button class="modal-close" onclick="closeBuildFuelTankModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 12px; font-size: 12px; color: var(--muted);">
                Available Cash: ${formatCurrency(S.cash)} â€¢ Max ${FUEL_TANKS_MAX_PER_TYPE} per fuel type
              </div>
              ${tanksHtml}
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showBuildFuelTankModal = showBuildFuelTankModal;
    
    function closeBuildFuelTankModal() {
      const modal = document.getElementById('buildFuelTankModal');
      if (modal) modal.remove();
    }
    window.closeBuildFuelTankModal = closeBuildFuelTankModal;
    
    function confirmBuildFuelTank(baseId, fuelType, tierKey) {
      const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tierKey];
      const base = getBase(baseId);
      
      if (confirm(`Build ${tierConfig.name} at ${base.icao}?\n\nCost: ${formatCurrency(tierConfig.buildCost)}\nCapacity: ${tierConfig.capacity.toLocaleString()} gallons\nBuild time: ${tierConfig.buildDays} days\nDiscount: ${(tierConfig.discount * 100)}%`)) {
        closeBuildFuelTankModal();
        closeBaseDetailModal();
        buildFuelTank(baseId, fuelType, tierKey);
      }
    }
    window.confirmBuildFuelTank = confirmBuildFuelTank;
    
    function showBuyFuelModal(baseId, tankId, fuelType, spaceAvailable) {
      const base = getBase(baseId);
      if (!base) return;
      
      const tank = base.fuelStorage[fuelType]?.find(t => t.id === tankId);
      if (!tank) return;
      
      const tierConfig = FUEL_STORAGE[fuelType]?.tiers[tank.tier];
      const basePrice = fuelType === '100LL' ? 6.50 : 6.00;
      const discount = tierConfig?.discount || 0;
      const bulkPrice = basePrice * (1 - discount);
      const minForDiscount = Math.ceil(tank.capacity * 0.5);
      
      const modalHtml = `
        <div class="modal-overlay" id="buyFuelModal" onclick="if(event.target === this) closeBuyFuelModal()">
          <div class="modal-dialog" style="max-width: 400px;">
            <div class="modal-header">
              <h3>Buy ${fuelType} Fuel</h3>
              <button class="modal-close" onclick="closeBuyFuelModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px; font-size: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>Tank:</span>
                  <span>${tierConfig?.name || 'Tank'} (${tank.capacity.toLocaleString()} gal)</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>Space Available:</span>
                  <span>${spaceAvailable.toLocaleString()} gal</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>FBO Price:</span>
                  <span>${formatCurrency(basePrice)}/gal</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span>Bulk Price:</span>
                  <span style="color: var(--success);">${formatCurrency(bulkPrice)}/gal (${(discount * 100)}% off)</span>
                </div>
                <div style="margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 6px; color: var(--muted);">
                  âš ï¸ Bulk discount requires minimum ${minForDiscount.toLocaleString()} gal purchase (50% of tank capacity)
                </div>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px;">Gallons to purchase:</label>
                <input type="number" id="buyFuelGallons" value="${spaceAvailable}" min="100" max="${spaceAvailable}" step="100"
                       style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);"
                       oninput="updateBuyFuelCostWithDiscount(${basePrice}, ${discount}, ${minForDiscount})">
              </div>
              
              <div id="buyFuelPriceInfo" style="display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 14px;">
                <span>Total Cost:</span>
                <span id="buyFuelCost" style="font-weight: 600; color: var(--warning);">${formatCurrency(spaceAvailable >= minForDiscount ? spaceAvailable * bulkPrice : spaceAvailable * basePrice)}</span>
              </div>
              <div id="buyFuelDiscountNote" style="font-size: 11px; color: ${spaceAvailable >= minForDiscount ? 'var(--success)' : 'var(--muted)'}; margin-bottom: 16px;">
                ${spaceAvailable >= minForDiscount ? 'âœ“ Bulk discount applied' : 'âœ— Below minimum for discount'}
              </div>
              
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn" onclick="closeBuyFuelModal()">Cancel</button>
                <button class="btn primary" onclick="executeBuyFuel('${baseId}', '${tankId}')">Purchase</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showBuyFuelModal = showBuyFuelModal;
    
    function closeBuyFuelModal() {
      const modal = document.getElementById('buyFuelModal');
      if (modal) modal.remove();
    }
    window.closeBuyFuelModal = closeBuyFuelModal;
    
    function updateBuyFuelCost(pricePerGallon) {
      const gallons = parseInt(document.getElementById('buyFuelGallons').value) || 0;
      const cost = gallons * pricePerGallon;
      document.getElementById('buyFuelCost').textContent = formatCurrency(cost);
    }
    window.updateBuyFuelCost = updateBuyFuelCost;
    
    function updateBuyFuelCostWithDiscount(basePrice, discount, minForDiscount) {
      const gallons = parseInt(document.getElementById('buyFuelGallons').value) || 0;
      const qualifiesForDiscount = gallons >= minForDiscount;
      const effectivePrice = qualifiesForDiscount ? basePrice * (1 - discount) : basePrice;
      const cost = gallons * effectivePrice;
      
      document.getElementById('buyFuelCost').textContent = formatCurrency(cost);
      
      const noteEl = document.getElementById('buyFuelDiscountNote');
      if (noteEl) {
        noteEl.textContent = qualifiesForDiscount ? 'âœ“ Bulk discount applied' : 'âœ— Below minimum for discount';
        noteEl.style.color = qualifiesForDiscount ? 'var(--success)' : 'var(--muted)';
      }
    }
    window.updateBuyFuelCostWithDiscount = updateBuyFuelCostWithDiscount;
    
    function executeBuyFuel(baseId, tankId) {
      const gallons = parseInt(document.getElementById('buyFuelGallons').value) || 0;
      if (gallons > 0 && buyBulkFuel(baseId, tankId, gallons)) {
        closeBuyFuelModal();
        closeBaseDetailModal();
        showBaseDetail(baseId);
      }
    }
    window.executeBuyFuel = executeBuyFuel;
    
    function confirmDismantleFuelTank(baseId, tankId, tankName, demoCost) {
      if (confirm(`Dismantle ${tankName}?\n\nDemolition cost: ${formatCurrency(demoCost)}\n\nAny fuel remaining in the tank will be lost.\n\nThis cannot be undone.`)) {
        if (dismantleFuelTank(baseId, tankId)) {
          closeBaseDetailModal();
          showBaseDetail(baseId);
        }
      }
    }
    window.confirmDismantleFuelTank = confirmDismantleFuelTank;
    
    // Build MX facility HTML for base detail
    function buildMxFacilityHtml(base, baseId) {
      if (!base.mxFacility) {
        return '<div style="background: var(--bg); border-radius: 8px; padding: 12px; font-size: 12px; color: var(--muted);">None â€” using contract maintenance</div>';
      }
      
      const facility = base.mxFacility;
      const config = MX_FACILITIES[facility.type];
      
      if (facility.status === 'constructing') {
        return `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px; opacity: 0.7;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 13px;">ðŸš§ ${config?.name || 'MX Facility'}</div>
              <div style="font-size: 11px; color: var(--warning);">Under construction</div>
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
              Completion: ${facility.completionDate.month}/${facility.completionDate.day}/${facility.completionDate.year}
            </div>
          </div>
        `;
      }
      
      // Operational facility
      const currentIndex = MX_FACILITY_ORDER.indexOf(facility.type);
      const canUpgrade = currentIndex < MX_FACILITY_ORDER.length - 1;
      const demoCost = Math.round((config?.buildCost || 12500) * 0.10);
      
      let html = `
        <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; font-size: 13px;">${config?.name || 'MX Facility'}</div>
            <div style="font-size: 11px; color: var(--success);">Operational</div>
          </div>
          <div style="font-size: 12px; margin-bottom: 8px;">
            <span style="color: var(--muted);">Capabilities:</span> ${config?.capabilities.join(', ')}
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-small" onclick="confirmDismantleMxFacility('${baseId}', '${config?.name || 'MX Facility'}', ${demoCost})" style="font-size: 11px; color: var(--danger);">Dismantle</button>
          </div>
        </div>
      `;
      
      // Parts room section
      if (facility.partsRoom) {
        html += `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 13px;">Parts Room</div>
              <div style="font-size: 11px; color: var(--success);">-${(MX_PARTS_ROOM.timeReduction * 100)}% MX time</div>
            </div>
          </div>
        `;
      } else if (facility.partsRoomConstructing) {
        html += `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px; opacity: 0.7;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 13px;">ðŸš§ Parts Room</div>
              <div style="font-size: 11px; color: var(--warning);">Under construction</div>
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
              Completion: ${facility.partsRoomConstructing.completionDate.month}/${facility.partsRoomConstructing.completionDate.day}/${facility.partsRoomConstructing.completionDate.year}
            </div>
          </div>
        `;
      } else {
        const canAffordParts = S.cash >= MX_PARTS_ROOM.buildCost;
        html += `
          <div style="background: var(--bg); border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; font-size: 13px;">Parts Room</div>
                <div style="font-size: 11px; color: var(--muted);">-${(MX_PARTS_ROOM.timeReduction * 100)}% MX time â€¢ ${MX_PARTS_ROOM.buildDays} days</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: var(--warning);">${formatCurrency(MX_PARTS_ROOM.buildCost)}</div>
                <button class="btn btn-small primary" onclick="confirmBuildPartsRoom('${baseId}')" ${!canAffordParts ? 'disabled' : ''} style="font-size: 10px; margin-top: 4px;">Build</button>
              </div>
            </div>
          </div>
        `;
      }
      
      return html;
    }
    
    function showBuildMxFacilityModal(baseId) {
      const base = getBase(baseId);
      if (!base) return;
      
      const currentType = base.mxFacility?.type;
      const currentIndex = currentType ? MX_FACILITY_ORDER.indexOf(currentType) : -1;
      const isUpgrade = currentIndex >= 0;
      
      let facilitiesHtml = '';
      
      for (const [tierKey, config] of Object.entries(MX_FACILITIES)) {
        const tierIndex = MX_FACILITY_ORDER.indexOf(tierKey);
        const isCurrentOrLower = tierIndex <= currentIndex;
        const currentConfig = currentType ? MX_FACILITIES[currentType] : null;
        const upgradeCost = isUpgrade && !isCurrentOrLower ? config.buildCost - (currentConfig?.buildCost || 0) : config.buildCost;
        const canAfford = S.cash >= upgradeCost;
        
        facilitiesHtml += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; ${isCurrentOrLower || !canAfford ? 'opacity: 0.6;' : ''}">
            <div>
              <div style="font-weight: 600;">${config.name} ${tierKey === currentType ? '(Current)' : ''}</div>
              <div style="font-size: 11px; color: var(--muted);">
                ${config.capabilities.join(', ')} â€¢ ${config.buildDays} days
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600; color: var(--warning);">${formatCurrency(upgradeCost)}</div>
              <button class="btn btn-small primary" onclick="confirmBuildMxFacility('${baseId}', '${tierKey}')" ${isCurrentOrLower || !canAfford ? 'disabled' : ''} style="margin-top: 4px; font-size: 10px;">
                ${isUpgrade && !isCurrentOrLower ? 'Upgrade' : 'Build'}
              </button>
            </div>
          </div>
        `;
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="buildMxFacilityModal" onclick="if(event.target === this) closeBuildMxFacilityModal()">
          <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-header">
              <h3>${isUpgrade ? 'Upgrade' : 'Build'} MX Facility at ${base.icao}</h3>
              <button class="modal-close" onclick="closeBuildMxFacilityModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 12px; font-size: 12px; color: var(--muted);">
                Available Cash: ${formatCurrency(S.cash)}
              </div>
              ${facilitiesHtml}
              <div style="font-size: 11px; color: var(--muted); margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 6px;">
                <div style="margin-bottom: 4px;"><strong>Capability Levels:</strong></div>
                <div>MX Stand: Squawks only</div>
                <div>MX Shop: Squawks + Inspections</div>
                <div>MX Center: Squawks + Inspections + Overhauls</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.showBuildMxFacilityModal = showBuildMxFacilityModal;
    
    function closeBuildMxFacilityModal() {
      const modal = document.getElementById('buildMxFacilityModal');
      if (modal) modal.remove();
    }
    window.closeBuildMxFacilityModal = closeBuildMxFacilityModal;
    
    function confirmBuildMxFacility(baseId, facilityType) {
      const base = getBase(baseId);
      const config = MX_FACILITIES[facilityType];
      const currentConfig = base.mxFacility?.type ? MX_FACILITIES[base.mxFacility.type] : null;
      const isUpgrade = !!currentConfig;
      const cost = isUpgrade ? config.buildCost - currentConfig.buildCost : config.buildCost;
      
      const action = isUpgrade ? 'Upgrade to' : 'Build';
      if (confirm(`${action} ${config.name} at ${base.icao}?\n\nCost: ${formatCurrency(cost)}\nBuild time: ${config.buildDays} days\nCapabilities: ${config.capabilities.join(', ')}`)) {
        closeBuildMxFacilityModal();
        closeBaseDetailModal();
        buildMxFacility(baseId, facilityType);
      }
    }
    window.confirmBuildMxFacility = confirmBuildMxFacility;
    
    function confirmBuildPartsRoom(baseId) {
      const base = getBase(baseId);
      if (confirm(`Build Parts Room at ${base.icao}?\n\nCost: ${formatCurrency(MX_PARTS_ROOM.buildCost)}\nBuild time: ${MX_PARTS_ROOM.buildDays} days\nBenefit: -${(MX_PARTS_ROOM.timeReduction * 100)}% MX work time`)) {
        closeBaseDetailModal();
        buildPartsRoom(baseId);
        showBaseDetail(baseId);
      }
    }
    window.confirmBuildPartsRoom = confirmBuildPartsRoom;
    
    function confirmDismantleMxFacility(baseId, facilityName, demoCost) {
      if (confirm(`Dismantle ${facilityName}?\n\nDemolition cost: ${formatCurrency(demoCost)}\n\nParts room (if any) will also be removed.\n\nThis cannot be undone.`)) {
        if (dismantleMxFacility(baseId)) {
          closeBaseDetailModal();
          showBaseDetail(baseId);
        }
      }
    }
    window.confirmDismantleMxFacility = confirmDismantleMxFacility;
    
    function reassignAircraft(aircraftCode, newBaseId) {
      const currentBase = getAircraftBase(aircraftCode);
      const newBase = getBase(newBaseId);
      
      // If moving to a different base, offer positioning flight
      if (currentBase && newBase && currentBase.id !== newBaseId) {
        showPositioningFlightPrompt(aircraftCode, currentBase.icao, newBase.icao, newBaseId);
      } else {
        // Same base or no current base - just assign
        assignAircraftToBase(aircraftCode, newBaseId);
        showToast('Aircraft Reassigned', `${aircraftCode} moved to ${newBase?.icao}`, 'success');
        closeBaseDetailModal();
        renderCompanyBases();
      }
    }
    window.reassignAircraft = reassignAircraft;
    
    function showPositioningFlightPrompt(aircraftCode, fromIcao, toIcao, newBaseId) {
      const aircraft = getAircraft(aircraftCode);
      const fromAirport = getAirport(fromIcao);
      const toAirport = getAirport(toIcao);
      
      // Calculate distance
      let distanceInfo = '';
      if (fromAirport?.latitude && toAirport?.latitude) {
        const dist = Math.round(calculateDistance(fromAirport.latitude, fromAirport.longitude, toAirport.latitude, toAirport.longitude));
        const flightTime = (dist / (aircraft?.cruise_speed || 120)).toFixed(1);
        distanceInfo = `<div style="font-size: 12px; color: var(--muted); margin-top: 8px;">Distance: ${dist} nm â€¢ Est. flight time: ${flightTime} hrs</div>`;
      }
      
      const modalHtml = `
        <div class="modal-overlay" id="positioningFlightModal" onclick="if(event.target === this) closePositioningFlightModal()">
          <div class="modal-dialog" style="max-width: 450px;">
            <div class="modal-header">
              <h3>Reposition Aircraft</h3>
              <button class="modal-close" onclick="closePositioningFlightModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="text-align: center; margin-bottom: 16px;">
                <div style="font-size: 14px; margin-bottom: 8px;">${aircraft?.name || aircraftCode}</div>
                <div style="font-size: 18px; font-weight: 600;">
                  ${fromIcao} <span style="color: var(--muted);">â†’</span> ${toIcao}
                </div>
                ${distanceInfo}
              </div>
              
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px;">
                <div style="color: var(--warning); margin-bottom: 8px;">âš ï¸ Ferry Flight Required</div>
                <div style="color: var(--muted);">Moving an aircraft to a new base requires a positioning flight. You can plan this as a custom flight, or teleport instantly (no fuel cost, no flight time logged).</div>
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn primary" onclick="planPositioningFlight('${aircraftCode}', '${fromIcao}', '${toIcao}', '${newBaseId}')" style="width: 100%;">
                  âœˆï¸ Plan Positioning Flight
                </button>
                <button class="btn" onclick="teleportAircraft('${aircraftCode}', '${newBaseId}')" style="width: 100%; color: var(--muted);">
                  âš¡ Teleport (Skip Flight)
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function closePositioningFlightModal() {
      const modal = document.getElementById('positioningFlightModal');
      if (modal) modal.remove();
    }
    window.closePositioningFlightModal = closePositioningFlightModal;
    
    function planPositioningFlight(aircraftCode, fromIcao, toIcao, newBaseId) {
      closePositioningFlightModal();
      closeBaseDetailModal();
      
      // Store pending reassignment to complete after flight
      S.pendingReassignment = { aircraftCode, newBaseId };
      saveState();
      
      // Open custom flight builder with pre-filled values
      openCustomMissionBuilderForPositioning(aircraftCode, fromIcao, toIcao);
    }
    window.planPositioningFlight = planPositioningFlight;
    
    function teleportAircraft(aircraftCode, newBaseId) {
      closePositioningFlightModal();
      closeBaseDetailModal();
      
      assignAircraftToBase(aircraftCode, newBaseId);
      showToast('Aircraft Teleported', `${aircraftCode} moved to ${getBase(newBaseId)?.icao}`, 'success');
      renderCompanyBases();
    }
    window.teleportAircraft = teleportAircraft;
    
    function openCustomMissionBuilderForPositioning(aircraftCode, fromIcao, toIcao) {
      // Open the regular custom flight builder
      openCustomMissionBuilder();
      
      // Pre-fill the fields after a short delay (modal needs to render)
      setTimeout(() => {
        const aircraftSelect = document.getElementById('customFlightAircraft');
        const fromInput = document.getElementById('customFlightFrom');
        const toInput = document.getElementById('customFlightTo');
        const typeSelect = document.getElementById('customFlightType');
        
        if (aircraftSelect) aircraftSelect.value = aircraftCode;
        if (fromInput) fromInput.value = fromIcao;
        if (toInput) toInput.value = toIcao;
        if (typeSelect) typeSelect.value = 'Ferry Flight';
      }, 100);
    }
    window.openCustomMissionBuilderForPositioning = openCustomMissionBuilderForPositioning;
    
    function reassignStaff(staffId, newBaseId) {
      assignStaffToBase(staffId, newBaseId);
      const staff = S.staff.find(s => s.id === staffId);
      showToast('Staff Reassigned', `${staff?.name} moved to ${getBase(newBaseId)?.icao}`, 'success');
      closeBaseDetailModal();
      renderCompanyBases();
    }
    window.reassignStaff = reassignStaff;
    
    // Show Company tab with specific subtab
    function showCompanyTab(subtab) {
      // Switch to Company tab
      document.querySelectorAll('.right-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.right-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('[data-right-tab="company"]')?.classList.add('active');
      document.getElementById('company-tab')?.classList.add('active');
      
      // Switch to specific subtab
      if (subtab) {
        document.querySelectorAll('#company-tab .right-subtab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#company-tab .right-subtab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-right-subtab="company-${subtab}"]`)?.classList.add('active');
        document.getElementById(`company-${subtab}-subtab`)?.classList.add('active');
        
        // Render the subtab content
        if (subtab === 'insurance') {
          renderCompanyInsurance();
        } else if (subtab === 'reviews') {
          renderCompanyReviews();
        } else if (subtab === 'overview') {
          renderCompanyOverview();
        } else if (subtab === 'bases') {
          renderCompanyBases();
        }
      }
    }
    window.showCompanyTab = showCompanyTab;
    
    function switchToStaffTab() {
      // Switch to Staff tab in right sidebar
      document.querySelectorAll('.right-sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.right-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('[data-right-tab="staff"]')?.classList.add('active');
      document.getElementById('staff-tab')?.classList.add('active');
      renderStaff();
    }
    window.switchToStaffTab = switchToStaffTab;
    
    function switchToCompanyBasesTab() {
      // Switch to Company tab, then to Bases sub-tab
      document.querySelectorAll('.right-sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.right-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('[data-right-tab="company"]')?.classList.add('active');
      document.getElementById('company-tab')?.classList.add('active');
      // Switch to bases sub-tab
      document.querySelectorAll('.company-sub-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.company-sub-content').forEach(c => c.classList.remove('active'));
      document.querySelector('[data-company-tab="bases"]')?.classList.add('active');
      document.getElementById('company-bases-content')?.classList.add('active');
      renderCompanyBases();
    }
    window.switchToCompanyBasesTab = switchToCompanyBasesTab;

    function renderPilotInfo() {
      const container = document.getElementById('pilotInfo');
      if (!container) return;
      
      container.innerHTML = `
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <strong>Name:</strong> 
            <span id="pilotNameDisplay">${S.pilot.name || 'Pilot'}</span>
            <button onclick="editPilotName()" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 12px;">âœï¸ Edit</button>
          </div>
          <div><strong>Total Hours:</strong> ${S.totalHoursFlown.toFixed(1)}</div>
          <div><strong>Total Miles:</strong> ${S.totalMilesFlown.toFixed(0)} nm</div>
          <div><strong>Flights Completed:</strong> ${S.pilotLog.length}</div>
        </div>
      `;
    }
    
    function editPilotName() {
      const currentName = S.pilot.name || 'Pilot';
      const newName = prompt('Enter your pilot name:', currentName);
      if (newName && newName.trim()) {
        S.pilot.name = newName.trim();
        saveState();
        renderPilotInfo();
      }
    }
    window.editPilotName = editPilotName;
    
    function renderPilotLog() {
      const container = document.getElementById('pilotLog');
      if (!container) return;
      
      if (S.pilotLog.length === 0) {
        container.innerHTML = '<div class="empty-state">No flights logged yet. Complete your first flight to see it here.</div>';
        return;
      }
      
      let html = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; padding: 12px; background: var(--bg); border-radius: 8px;">
          <div ${S.gameMode === 'sandbox' ? 'style="cursor: pointer;" onclick="sandboxEditHours()"' : ''}>
            <div style="font-size: 12px; color: var(--muted);">Total Hours Flown ${S.gameMode === 'sandbox' ? '<span style="color: var(--accent);">âœŽ</span>' : ''}</div>
            <div style="font-size: 20px; font-weight: 600;">${S.totalHoursFlown.toFixed(1)}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--muted);">Total Miles Flown</div>
            <div style="font-size: 20px; font-weight: 600;">${S.totalMilesFlown.toFixed(0)} nm</div>
          </div>
        </div>
        <div style="display: grid; gap: 12px;">
      `;
      
      S.pilotLog.slice().reverse().forEach(entry => {
        html += `
          <div style="padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
            <div style="font-weight: 600; margin-bottom: 4px;">${entry.aircraft}</div>
            <div style="font-size: 13px; color: var(--muted);">
              ${entry.from} â†’ ${entry.to} (${entry.distance} nm)<br>
              ${formatGameTime(entry.date)} â€¢ ${entry.blockTime.toFixed(1)} hours<br>
              Assessment: ${entry.assessment}/5
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function switchSettingsSection(section) {
      // Update button states
      document.querySelectorAll('.settings-section-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === section);
      });
      
      // Show/hide sections
      document.querySelectorAll('.settings-section').forEach(el => {
        el.style.display = 'none';
      });
      const sectionEl = document.getElementById(`settings-${section}`);
      if (sectionEl) {
        sectionEl.style.display = 'block';
      }
      
      // Render section content
      if (section === 'missions') {
        renderMissionPreferences();
      } else if (section === 'game') {
        renderGameSettings();
      } else if (section === 'finances') {
        renderFinancesPreferences();
      } else if (section === 'maintenance') {
        renderMaintenanceSettings();
      } else if (section === 'reputation') {
        renderReputationSettings();
      }
    }
    window.switchSettingsSection = switchSettingsSection;
    
    function renderFinancesPreferences() {
      // Update fixed price mode toggle state
      const toggle = document.getElementById('fixedPriceModeToggle');
      const slider = document.getElementById('fixedPriceModeSlider');
      const knob = document.getElementById('fixedPriceModeKnob');
      
      if (toggle && slider && knob) {
        const enabled = S.difficultySettings?.fixedPriceMode || false;
        toggle.checked = enabled;
        slider.style.backgroundColor = enabled ? 'var(--success)' : 'var(--border)';
        knob.style.left = enabled ? '22px' : '3px';
      }
      
      // Render financial sliders
      const slidersContainer = document.getElementById('financialSlidersContent');
      if (slidersContainer) {
        slidersContainer.innerHTML = renderFinancialSlidersHtml();
      }
    }
    window.renderFinancesPreferences = renderFinancesPreferences;
    
    function renderReputationSettings() {
      const container = document.getElementById('reputationSettingsContent');
      if (!container) return;
      
      // Get current values with defaults
      const xpRate = S.difficultySettings?.xpMultiplier ?? 1.0;
      const contractBonus = S.difficultySettings?.contractBonus ?? 3;
      const freq = S.difficultySettings?.reviewFrequency || 'normal';
      const freqValue = freq === 'low' ? 0 : freq === 'high' ? 2 : 1;
      const freqLabel = freq === 'low' ? 'Low' : freq === 'high' ? 'High' : 'Normal';
      
      container.innerHTML = `
        <!-- Experience Point Rate -->
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Experience Point Rate</div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
            How quickly you gain experience points. Lower = slower progression, higher = faster.
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--muted); width: 40px;">0.5Ã—</span>
            <input type="range" id="xpRateSlider" min="0.5" max="1.5" step="0.1" value="${xpRate}" 
              onchange="updateXpRate(this.value)"
              style="flex: 1; height: 6px; border-radius: 3px; background: var(--border); outline: none; -webkit-appearance: none;">
            <span style="font-size: 12px; color: var(--muted); width: 40px; text-align: right;">1.5Ã—</span>
          </div>
          <div style="text-align: center; margin-top: 8px;">
            <span id="xpRateValue" style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); background: rgba(88, 166, 255, 0.1); padding: 2px 10px; border-radius: 4px;">
              ${xpRate.toFixed(1)}Ã—
            </span>
          </div>
        </div>
        
        <!-- Contract Flight Bonus -->
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Contract Flight Bonus</div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
            Extra XP earned for contract pilot jobs (flying someone else's aircraft).
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--muted); width: 40px;">+1</span>
            <input type="range" id="contractBonusSlider" min="1" max="5" step="1" value="${contractBonus}" 
              onchange="updateContractBonus(this.value)"
              style="flex: 1; height: 6px; border-radius: 3px; background: var(--border); outline: none; -webkit-appearance: none;">
            <span style="font-size: 12px; color: var(--muted); width: 40px; text-align: right;">+5</span>
          </div>
          <div style="text-align: center; margin-top: 8px;">
            <span id="contractBonusValue" style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); background: rgba(88, 166, 255, 0.1); padding: 2px 10px; border-radius: 4px;">
              +${contractBonus}
            </span>
          </div>
        </div>
        
        <!-- Review Frequency -->
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Review Frequency</div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
            How often customers leave reviews after flights. Higher = more reviews (both good and bad).
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--muted); width: 40px;">Low</span>
            <input type="range" id="reviewFrequencySlider" min="0" max="2" step="1" value="${freqValue}" 
              onchange="updateReviewFrequency(this.value)"
              style="flex: 1; height: 6px; border-radius: 3px; background: var(--border); outline: none; -webkit-appearance: none;">
            <span style="font-size: 12px; color: var(--muted); width: 40px; text-align: right;">High</span>
          </div>
          <div style="text-align: center; margin-top: 8px;">
            <span id="reviewFrequencyValue" style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); background: rgba(88, 166, 255, 0.1); padding: 2px 10px; border-radius: 4px;">
              ${freqLabel}
            </span>
          </div>
        </div>
        
        <!-- Reset Button -->
        <div style="text-align: right;">
          <button onclick="resetReputationSettings()" class="btn" style="font-size: 11px; padding: 6px 16px;">
            Reset to Defaults
          </button>
        </div>
      `;
    }
    window.renderReputationSettings = renderReputationSettings;
    
    function updateXpRate(value) {
      S.difficultySettings.xpMultiplier = parseFloat(value);
      const valueDisplay = document.getElementById('xpRateValue');
      if (valueDisplay) {
        valueDisplay.textContent = parseFloat(value).toFixed(1) + 'Ã—';
      }
      saveState();
    }
    window.updateXpRate = updateXpRate;
    
    function updateContractBonus(value) {
      S.difficultySettings.contractBonus = parseInt(value);
      const valueDisplay = document.getElementById('contractBonusValue');
      if (valueDisplay) {
        valueDisplay.textContent = '+' + value;
      }
      saveState();
    }
    window.updateContractBonus = updateContractBonus;
    
    function updateReviewFrequency(value) {
      const labels = ['low', 'normal', 'high'];
      const displayLabels = ['Low', 'Normal', 'High'];
      S.difficultySettings.reviewFrequency = labels[parseInt(value)] || 'normal';
      
      const valueDisplay = document.getElementById('reviewFrequencyValue');
      if (valueDisplay) {
        valueDisplay.textContent = displayLabels[parseInt(value)] || 'Normal';
      }
      saveState();
    }
    window.updateReviewFrequency = updateReviewFrequency;
    
    function resetReputationSettings() {
      S.difficultySettings.xpMultiplier = 1.0;
      S.difficultySettings.contractBonus = 3;
      S.difficultySettings.reviewFrequency = 'normal';
      saveState();
      renderReputationSettings();
    }
    window.resetReputationSettings = resetReputationSettings;
    
    function renderMaintenanceSettings() {
      const container = document.getElementById('maintenanceSettingsContent');
      if (!container) return;
      
      const ds = S.difficultySettings || {};
      const fmtMult = (v) => v === 1.0 ? '1.0Ã—' : v.toFixed(2) + 'Ã—';
      const getColor = (v) => {
        if (Math.abs(v - 1.0) < 0.01) return 'var(--muted)';
        return v < 1 ? 'var(--success)' : 'var(--danger)';
      };
      
      container.innerHTML = `
        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Maintenance Difficulty</div>
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
            Adjust maintenance costs, squawk frequency, and condition degradation. Left = easier, right = harder.
          </div>
          
          <!-- MX Costs -->
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-size: 12px;">Maintenance Costs</span>
              <span id="mxCostValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(ds.mxCostMultiplier || 1.0)};">${fmtMult(ds.mxCostMultiplier || 1.0)}</span>
            </div>
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 6px;">Scales inspection, repair, and overhaul costs</div>
            <input type="range" min="0.25" max="2" step="0.05" value="${ds.mxCostMultiplier || 1.0}" 
                   style="width: 100%; accent-color: var(--accent);"
                   oninput="updateMxMultiplier('mxCostMultiplier', this.value, 'mxCostValue')">
          </div>
          
          <!-- Squawk Frequency -->
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-size: 12px;">Squawk Frequency</span>
              <span id="squawkFreqValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(ds.squawkFrequencyMultiplier || 1.0)};">${fmtMult(ds.squawkFrequencyMultiplier || 1.0)}</span>
            </div>
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 6px;">Chance of discovering issues during pre-flight</div>
            <input type="range" min="0.25" max="2" step="0.05" value="${ds.squawkFrequencyMultiplier || 1.0}" 
                   style="width: 100%; accent-color: var(--accent);"
                   oninput="updateMxMultiplier('squawkFrequencyMultiplier', this.value, 'squawkFreqValue')">
          </div>
          
          <!-- Condition Degradation -->
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-size: 12px;">Condition Degradation</span>
              <span id="condDegValue" style="font-size: 12px; font-weight: 600; font-family: monospace; color: ${getColor(ds.conditionDegradationMultiplier || 1.0)};">${fmtMult(ds.conditionDegradationMultiplier || 1.0)}</span>
            </div>
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 6px;">How quickly aircraft condition deteriorates per flight hour</div>
            <input type="range" min="0.25" max="2" step="0.05" value="${ds.conditionDegradationMultiplier || 1.0}" 
                   style="width: 100%; accent-color: var(--accent);"
                   oninput="updateMxMultiplier('conditionDegradationMultiplier', this.value, 'condDegValue')">
          </div>
          
          <div style="text-align: center; padding-top: 12px; border-top: 1px solid var(--border);">
            <button class="btn" onclick="resetMxSettings()" style="font-size: 11px; padding: 6px 16px;">
              Reset to Default (1.0Ã—)
            </button>
          </div>
        </div>
      `;
    }
    window.renderMaintenanceSettings = renderMaintenanceSettings;
    
    function updateMxMultiplier(key, value, displayId) {
      if (!S.difficultySettings) S.difficultySettings = {};
      S.difficultySettings[key] = parseFloat(value);
      
      const display = document.getElementById(displayId);
      if (display) {
        const v = parseFloat(value);
        display.textContent = v === 1.0 ? '1.0Ã—' : v.toFixed(2) + 'Ã—';
        display.style.color = Math.abs(v - 1.0) < 0.01 ? 'var(--muted)' : v < 1 ? 'var(--success)' : 'var(--danger)';
      }
      saveState();
    }
    window.updateMxMultiplier = updateMxMultiplier;
    
    function resetMxSettings() {
      S.difficultySettings.mxCostMultiplier = 1.0;
      S.difficultySettings.squawkFrequencyMultiplier = 1.0;
      S.difficultySettings.conditionDegradationMultiplier = 1.0;
      saveState();
      renderMaintenanceSettings();
    }
    window.resetMxSettings = resetMxSettings;

    function renderGameSettings() {
      const container = document.getElementById('gameSettingsContent');
      if (!container) return;
      
      let html = `
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">AUTO-SAVE</h3>
          
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 13px; font-weight: 500;">Automatic Backup Frequency</div>
                <div style="font-size: 11px; color: var(--muted);">Creates rotating backups you can restore from the game menu</div>
              </div>
              <select onchange="setAutoSaveFrequency(this.value)" style="padding: 6px 10px; border-radius: 6px; background: var(--panel); border: 1px solid var(--border); color: var(--text); font-size: 12px;">
                <option value="off" ${S.autoSaveFrequency === 'off' ? 'selected' : ''}>Off</option>
                <option value="weekly" ${S.autoSaveFrequency === 'weekly' ? 'selected' : ''}>Weekly (Sundays)</option>
                <option value="monthly" ${S.autoSaveFrequency === 'monthly' ? 'selected' : ''}>Monthly (1st)</option>
              </select>
            </div>
            <div style="font-size: 10px; color: var(--muted); margin-top: 8px;">
              Last 5 auto-saves are kept. Access via â˜° Menu â†’ Restore Auto-Save
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    function updateFinancialMultiplier(setting, value, displayId, invert = false) {
      if (!S.difficultySettings) S.difficultySettings = {};
      const numValue = parseFloat(value);
      S.difficultySettings[setting] = numValue;
      
      // Update display
      const display = document.getElementById(displayId);
      if (display) {
        const fmtMult = (v) => v === 1.0 ? '1.0Ã—' : v.toFixed(2) + 'Ã—';
        const getColor = (v, inv) => {
          if (Math.abs(v - 1.0) < 0.01) return 'var(--muted)';
          if (inv) return v < 1 ? 'var(--success)' : 'var(--danger)';
          return v > 1 ? 'var(--success)' : 'var(--danger)';
        };
        display.textContent = fmtMult(numValue);
        display.style.color = getColor(numValue, invert);
      }
      
      saveState();
    }
    window.updateFinancialMultiplier = updateFinancialMultiplier;
    
    function resetFinancialMultipliers() {
      if (!S.difficultySettings) S.difficultySettings = {};
      S.difficultySettings.ownedRevenueMultiplier = 1.0;
      S.difficultySettings.contractRevenueMultiplier = 1.0;
      S.difficultySettings.fuelCostMultiplier = 1.0;
      S.difficultySettings.operatingCostMultiplier = 1.0;
      S.difficultySettings.interestRateMultiplier = 1.0;
      S.difficultySettings.insuranceCostMultiplier = 1.0;
      S.difficultySettings.mxCostMultiplier = 1.0;
      S.difficultySettings.squawkFrequencyMultiplier = 1.0;
      S.difficultySettings.conditionDegradationMultiplier = 1.0;
      
      saveState();
      renderGameSettings();
      showToast('Reset', 'All multipliers reset to defaults', 'info');
    }
    window.resetFinancialMultipliers = resetFinancialMultipliers;
    
    function toggleFixedPriceMode(enabled) {
      if (!S.difficultySettings) S.difficultySettings = {};
      S.difficultySettings.fixedPriceMode = enabled;
      
      // Update toggle visual immediately
      const slider = document.getElementById('fixedPriceModeSlider');
      const knob = document.getElementById('fixedPriceModeKnob');
      if (slider && knob) {
        slider.style.backgroundColor = enabled ? 'var(--success)' : 'var(--border)';
        knob.style.left = enabled ? '22px' : '3px';
      }
      
      saveState();
      showToast(enabled ? 'Fixed price mode enabled' : 'Bid calculator mode enabled', 'info');
    }
    window.toggleFixedPriceMode = toggleFixedPriceMode;
    
    function updateOwnedRatioPreview(value) {
      // Slider value is contract percentage, owned is inverse
      const contractPct = parseInt(value);
      const ownedPct = 100 - contractPct;
      const slider = event.target;
      const parent = slider.closest('div');
      if (parent) {
        const labels = parent.querySelectorAll('span');
        if (labels.length >= 2) {
          labels[0].textContent = `Owned ${ownedPct}%`;
          labels[1].textContent = `Contract ${contractPct}%`;
        }
      }
    }
    window.updateOwnedRatioPreview = updateOwnedRatioPreview;
    
    function setOwnedMissionRatio(value) {
      if (!S.difficultySettings) S.difficultySettings = {};
      // Slider value is contract percentage, so owned ratio is inverse
      const contractPct = parseInt(value);
      const newRatio = (100 - contractPct) / 100;
      S.difficultySettings.ownedMissionRatio = newRatio;
      console.log('setOwnedMissionRatio SAVING:', { contractPct, newRatio, fullSettings: JSON.stringify(S.difficultySettings) });
      saveState();
    }
    window.setOwnedMissionRatio = setOwnedMissionRatio;
    
    function toggleCustomMissions(enabled) {
      if (!S.gameSettings) S.gameSettings = {};
      S.gameSettings.allowCustomMissions = enabled;
      saveState();
      renderGameSettings();
    }
    window.toggleCustomMissions = toggleCustomMissions;
    
    function renderMissionPreferences() {
      const container = document.getElementById('missionPreferences');
      if (!container) return;
      
      // Get slider values
      const ownedRatio = S.difficultySettings?.ownedMissionRatio ?? 0.6;
      const ownedPct = Math.round(ownedRatio * 100);
      const contractPct = 100 - ownedPct;
      const allowCustomMissions = S.gameSettings?.allowCustomMissions !== false;
      
      // Group missions by category
      const missionCategories = {
        'Passenger Services': ['Discovery Flight', 'Sightseeing Tour', 'Thrill Flight', 'Charter Flight', 'Executive Transport', 'Island Hopping'],
        'Cargo & Logistics': ['General Cargo', 'Mail Run', 'Freight Haul', 'Bush Resupply', 'Hazmat Transport', 'Part 135 On-Demand'],
        'Aerial Work': ['Aerial Photography', 'Aerial Survey', 'Training Flight'],
        'Medical & Emergency': ['Medical Transfer', 'Air Ambulance', 'Organ Transport', 'CASEVAC', 'Search Support', 'Humanitarian'],
        'Helicopter Operations': ['Heli Tour', 'Heli Charter', 'Heli EMS', 'Heli SAR'],
        'Special Operations': ['Ferry Flight', 'Airshow Aerobatics', 'Airshow Rides', 'Historical Flight']
      };
      
      // Start with mission generation settings
      let html = `
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">MISSION GENERATION</h3>
          
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div>
                <div style="font-size: 13px; font-weight: 500;">Owned vs Contract Missions</div>
                <div style="font-size: 11px; color: var(--muted);">Balance between flying your own aircraft and contract pilot jobs</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <span style="font-size: 11px; color: var(--success); min-width: 60px;">Owned ${ownedPct}%</span>
              <input type="range" min="0" max="100" value="${contractPct}" 
                     style="flex: 1; accent-color: #888;"
                     oninput="updateOwnedRatioPreview(this.value); setOwnedMissionRatio(this.value)">
              <span style="font-size: 11px; color: var(--accent); min-width: 70px; text-align: right;">Contract ${contractPct}%</span>
            </div>
            <div style="font-size: 10px; color: var(--muted); text-align: center;">
              <span style="color: var(--success);">â—€ More customer inquiries for your fleet</span>
              <span style="margin: 0 8px;">|</span>
              <span style="color: var(--accent);">More contract pilot offers â–¶</span>
            </div>
          </div>
          
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 13px; font-weight: 500;">Allow Custom Flights</div>
                <div style="font-size: 11px; color: var(--muted);">Create your own flights with custom routes, payloads, and weather</div>
              </div>
              <label style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                <input type="checkbox" ${allowCustomMissions ? 'checked' : ''} onchange="toggleCustomMissions(this.checked)" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${allowCustomMissions ? 'var(--success)' : 'var(--border)'}; transition: 0.3s; border-radius: 24px;">
                  <span style="position: absolute; content: ''; height: 18px; width: 18px; left: ${allowCustomMissions ? '22px' : '3px'}; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                </span>
              </label>
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">MISSION TYPE PREFERENCES</h3>
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button class="btn" onclick="setAllMissionPreferences(true)">Enable All</button>
            <button class="btn" onclick="setAllMissionPreferences(false)">Disable All</button>
          </div>
        </div>
      `;
      
      Object.entries(missionCategories).forEach(([category, missions]) => {
        html += `
          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 13px; color: var(--muted); margin-bottom: 8px; letter-spacing: 0.5px;">${category.toUpperCase()}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
        `;
        
        missions.forEach(missionType => {
          // Default to enabled if not explicitly disabled
          const isEnabled = S.missionPreferences[missionType] !== false;
          const cardStyle = isEnabled 
            ? 'background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success);'
            : 'background: var(--bg); border: 1px solid var(--border); opacity: 0.6;';
          
          html += `
            <div style="${cardStyle} padding: 10px 12px; border-radius: 6px; cursor: pointer; transition: all 0.15s;"
                 onclick="toggleMissionPreference('${missionType}')"
                 onmouseover="this.style.opacity='0.8'" 
                 onmouseout="this.style.opacity='${isEnabled ? '1' : '0.6'}'">
              <div style="display: flex; align-items: center; gap: 8px;">
                ${isEnabled ? '<span style="color: var(--success);">âœ“</span>' : '<span style="opacity: 0.3;">â—‹</span>'}
                <span style="font-size: 13px;">${missionType}</span>
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
    }
    
    function toggleMissionPreference(missionType) {
      const currentlyEnabled = S.missionPreferences[missionType] !== false;
      S.missionPreferences[missionType] = !currentlyEnabled;
      saveState();
      renderMissionPreferences();
    }
    
    function setAllMissionPreferences(enabled) {
      Object.keys(MISSION_TYPES).forEach(missionType => {
        S.missionPreferences[missionType] = enabled;
      });
      saveState();
      renderMissionPreferences();
    }
    window.toggleMissionPreference = toggleMissionPreference;
    window.setAllMissionPreferences = setAllMissionPreferences;

    // === AIRCRAFT SETTINGS ===
    function openCustomAircraftForm() {
      const formContainer = document.getElementById('customAircraftForm');
      formContainer.style.display = 'block';
      formContainer.innerHTML = `
        <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="font-size: 14px; margin: 0;">Add Custom Aircraft</h3>
            <button onclick="closeCustomAircraftForm()" style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">&times;</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 11px; color: var(--muted);">ID Code * <span style="color: var(--muted); font-weight: normal;">(internal identifier)</span></label>
              <input type="text" id="customAcCode" placeholder="e.g. MY_CESSNA_182" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Name *</label>
              <input type="text" id="customAcName" placeholder="e.g. My Custom Plane" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Category *</label>
              <select id="customAcCategory" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
                <option value="single_piston">Single Engine Piston</option>
                <option value="single_piston_hp">High Performance Piston</option>
                <option value="multi_piston">Multi-Engine Piston</option>
                <option value="turboprop">Turboprop</option>
                <option value="light_jet">Light Jet</option>
                <option value="airliner">Airliner</option>
                <option value="bush">Bush Plane</option>
                <option value="helicopter">Helicopter</option>
                <option value="amphibious">Amphibious</option>
                <option value="aerobatic">Aerobatic</option>
                <option value="warbird">Warbird</option>
                <option value="specialty">Specialty</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Cruise Speed (kts) *</label>
              <input type="number" id="customAcSpeed" placeholder="120" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Max Passengers</label>
              <input type="number" id="customAcPax" placeholder="3" value="3" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Max Cargo (lbs)</label>
              <input type="number" id="customAcCargo" placeholder="500" value="500" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Operating Cost ($/hr) *</label>
              <input type="number" id="customAcCost" placeholder="100" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Range (nm)</label>
              <input type="number" id="customAcRange" placeholder="500" value="500" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Fuel Capacity (gal)</label>
              <input type="number" id="customAcFuel" placeholder="50" value="50" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Fuel Burn (gal/hr)</label>
              <input type="number" id="customAcBurn" placeholder="10" value="10" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Runway Required (ft)</label>
              <input type="number" id="customAcRunway" placeholder="2000" value="2000" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
            </div>
            <div>
              <label style="font-size: 11px; color: var(--muted);">Avionics</label>
              <select id="customAcAvionics" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 12px;">
                <option value="VFR">VFR Only</option>
                <option value="GPS" selected>GPS</option>
                <option value="IFR">Full IFR</option>
              </select>
            </div>
          </div>
          
          <div style="margin-top: 12px;">
            <label style="font-size: 11px; color: var(--muted);">Surfaces (check all that apply)</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 4px;">
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfPaved" checked> Paved</label>
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfGrass"> Grass</label>
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfGravel"> Gravel</label>
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfDirt"> Dirt</label>
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfWater"> Water</label>
              <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="surfHelipad"> Helipad</label>
            </div>
          </div>
          
          <div style="margin-top: 16px; display: flex; gap: 8px;">
            <button class="btn" onclick="saveCustomAircraft()" style="background: var(--success); color: white; border-color: var(--success);">Save Aircraft</button>
            <button class="btn" onclick="closeCustomAircraftForm()">Cancel</button>
          </div>
        </div>
      `;
    }
    
    function closeCustomAircraftForm() {
      document.getElementById('customAircraftForm').style.display = 'none';
    }
    
    function saveCustomAircraft() {
      const code = document.getElementById('customAcCode').value.trim().toUpperCase().replace(/\s+/g, '_');
      const name = document.getElementById('customAcName').value.trim();
      const category = document.getElementById('customAcCategory').value;
      const cruiseSpeed = parseInt(document.getElementById('customAcSpeed').value) || 120;
      const maxPax = parseInt(document.getElementById('customAcPax').value) || 0;
      const maxCargo = parseInt(document.getElementById('customAcCargo').value) || 0;
      const opCost = parseInt(document.getElementById('customAcCost').value) || 100;
      const range = parseInt(document.getElementById('customAcRange').value) || 500;
      const fuelCap = parseInt(document.getElementById('customAcFuel').value) || 50;
      const fuelBurn = parseInt(document.getElementById('customAcBurn').value) || 10;
      const runway = parseInt(document.getElementById('customAcRunway').value) || 2000;
      const avionics = document.getElementById('customAcAvionics').value;
      
      // Build surfaces array
      const surfaces = [];
      if (document.getElementById('surfPaved').checked) surfaces.push('paved');
      if (document.getElementById('surfGrass').checked) surfaces.push('grass');
      if (document.getElementById('surfGravel').checked) surfaces.push('gravel');
      if (document.getElementById('surfDirt').checked) surfaces.push('dirt');
      if (document.getElementById('surfWater').checked) surfaces.push('water');
      if (document.getElementById('surfHelipad').checked) surfaces.push('helipad');
      
      // Validate
      if (!code || !name || !cruiseSpeed || !opCost) {
        alert('Please fill in all required fields (Code, Name, Cruise Speed, Operating Cost)');
        return;
      }
      
      if (AIRCRAFT[code] || S.customAircraft[code]) {
        alert('An aircraft with this code already exists. Please use a unique code.');
        return;
      }
      
      // Create aircraft
      S.customAircraft[code] = {
        name: name,
        category: category,
        fuel_type: category === 'turboprop' || category === 'light_jet' || category === 'airliner' ? 'Jet-A' : '100LL',
        fuel_capacity: fuelCap,
        fuel_burn_rate: fuelBurn,
        cruise_speed: cruiseSpeed,
        range: range,
        operating_cost: opCost,
        max_passengers: maxPax,
        max_cargo_lbs: maxCargo,
        runway_required: runway,
        surfaces: surfaces.length > 0 ? surfaces : ['paved'],
        avionics: avionics
      };
      
      saveState();
      closeCustomAircraftForm();
      renderCertifications();
      alert(`${name} added successfully!`);
    }
    
    function deleteCustomAircraft(code) {
      if (!S.customAircraft[code]) return;
      
      const name = S.customAircraft[code].name;
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
      
      // Remove from custom aircraft
      delete S.customAircraft[code];
      
      // Remove from fleet if owned
      const fleetIdx = S.fleet.indexOf(code);
      if (fleetIdx >= 0) S.fleet.splice(fleetIdx, 1);
      
      // Remove from certifications
      const certIdx = S.pilot.aircraftCertifications.indexOf(code);
      if (certIdx >= 0) S.pilot.aircraftCertifications.splice(certIdx, 1);
      
      saveState();
      renderCertifications();
    }
    
    window.openCustomAircraftForm = openCustomAircraftForm;
    window.closeCustomAircraftForm = closeCustomAircraftForm;
    window.saveCustomAircraft = saveCustomAircraft;
    window.deleteCustomAircraft = deleteCustomAircraft;

    function renderHeader() {
      document.getElementById('timeDisplay').textContent = formatGameTime(S.gameTime);
    }

    function renderCalendar() {
      const container = document.getElementById('calendarContent');
      
      debugLog('renderCalendar - S.scheduledFlights:', S.scheduledFlights);
      debugLog('renderCalendar - S.gameTime:', S.gameTime);
      
      // Initialize calendar view to current game time only if not set
      if (!S.calendarViewDate) {
        S.calendarViewDate = { 
          year: S.gameTime.year, 
          month: S.gameTime.month, 
          day: S.gameTime.day,
          hour: 0,
          minute: 0
        };
      }
      
      // Generate 7 days starting from calendarViewDate
      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const date = addDays(S.calendarViewDate, i);
        weekDays.push(date);
      }
      
      // Time blocks (1-hour increments)
      const timeBlocks = [
        '00:00', '01:00', '02:00', '03:00', '04:00', '05:00',
        '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
        '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
        '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
      ];
      
      // Build navigation - cleaner design
      const hasPPL = S.pilot.certificates.includes('private');
      const trainingLabel = hasPPL ? 'Proficiency Flight' : 'Training Flight';
      const showCustomFlight = S.gameSettings?.allowCustomMissions !== false;
      
      const nav = `
        <div style="margin-bottom: 16px;">
          <!-- Main nav row -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 4px;">
              <button class="btn" onclick="shiftCalendarView(-7)" style="padding: 6px 10px; font-size: 12px;">&laquo;</button>
              <button class="btn" onclick="shiftCalendarView(-1)" style="padding: 6px 10px; font-size: 12px;">&lsaquo;</button>
              <button class="btn" onclick="resetCalendarToToday()" style="padding: 6px 12px; font-size: 12px;">Today</button>
              <button class="btn" onclick="shiftCalendarView(1)" style="padding: 6px 10px; font-size: 12px;">&rsaquo;</button>
              <button class="btn" onclick="shiftCalendarView(7)" style="padding: 6px 10px; font-size: 12px;">&raquo;</button>
            </div>
            <div style="font-size: 15px; font-weight: 600; color: var(--text);">${formatCalendarDate(weekDays[0])} â€” ${formatCalendarDate(weekDays[6])}</div>
            <div style="display: flex; gap: 8px;">
              ${showCustomFlight ? `<button class="btn" onclick="openCustomMissionBuilder()" style="padding: 6px 12px; font-size: 12px; background: var(--accent); color: white; border-color: var(--accent);">+ Custom Flight</button>` : ''}
              <button class="btn" onclick="scheduleTrainingFlight()" style="padding: 6px 12px; font-size: 12px; background: var(--success); color: white; border-color: var(--success);">+ ${trainingLabel}</button>
            </div>
          </div>
        </div>
      `;
      
      // Build week grid
      let grid = '<div style="display: grid; grid-template-columns: 60px repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">';
      
      // Header row (day names + dates)
      grid += '<div style="background: var(--panel); padding: 8px; font-weight: 600; text-align: center;">Time</div>';
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      weekDays.forEach(date => {
        const dayOfWeek = new Date(date.year, date.month - 1, date.day).getDay();
        const isToday = date.year === S.gameTime.year && date.month === S.gameTime.month && date.day === S.gameTime.day;
        grid += `<div style="background: var(--panel); padding: 8px; text-align: center; font-weight: 600; ${isToday ? 'color: var(--accent); border: 2px solid var(--accent);' : ''}">
          ${dayNames[dayOfWeek]}<br>
          <span style="font-size: 12px; color: var(--muted);">${date.month}/${date.day}</span>
        </div>`;
      });
      
      // Time block rows
      timeBlocks.forEach(timeBlock => {
        // Time label column
        grid += `<div style="background: var(--panel); padding: 8px; font-size: 12px; color: var(--muted); text-align: center; border-top: 1px solid var(--border);">${timeBlock}</div>`;
        
        // Day columns
        weekDays.forEach(date => {
          const [hour] = timeBlock.split(':').map(Number);
          
          // Check if this is the current time slot
          const isCurrentSlot = date.year === S.gameTime.year &&
                               date.month === S.gameTime.month &&
                               date.day === S.gameTime.day &&
                               S.gameTime.hour === hour;
          
          // Find flights that START in this time block
          const flightsInBlock = S.scheduledFlights.filter(sf => {
            if (!sf.contract || !sf.contract.startTime) {
              debugLog('Invalid scheduled flight (missing contract or startTime):', sf);
              return false;
            }
            const flight = sf.contract;
            
            // Only show in the START hour
            const sameDay = flight.startTime.year === date.year &&
                   flight.startTime.month === date.month &&
                   flight.startTime.day === date.day;
            const startHour = flight.startTime.hour;
            
            return sameDay && startHour === hour;
          });
          
          // Find staff missions that START in this time block (show duration info)
          const staffMissionsInBlock = (S.staffMissions || []).filter(sm => {
            if (!sm.departureTime) return false;
            if (sm.status !== 'in_progress' && sm.status !== 'scheduled') return false;
            
            // Only show in the START hour
            const sameDay = sm.departureTime.year === date.year &&
                   sm.departureTime.month === date.month &&
                   sm.departureTime.day === date.day;
            const startHour = sm.departureTime.hour;
            
            return sameDay && startHour === hour;
          });
          
          // Find checkrides in this time block
          const checkridesInBlock = S.checkrides.scheduled.filter(cr => {
            const startHour = cr.scheduledTime.hour;
            return cr.scheduledTime.year === date.year &&
                   cr.scheduledTime.month === date.month &&
                   cr.scheduledTime.day === date.day &&
                   startHour === hour;
          });
          
          // Find MX events for this day (show at 8am)
          const mxEventsForDay = hour === 8 ? S.fleet.filter(code => {
            const fleetInfo = S.fleetData[code];
            if (!fleetInfo?.scheduledMx) return false;
            const mx = fleetInfo.scheduledMx;
            // Show on start and completion dates
            return (mx.startDate.year === date.year && mx.startDate.month === date.month && mx.startDate.day === date.day) ||
                   (mx.completionDate.year === date.year && mx.completionDate.month === date.month && mx.completionDate.day === date.day);
          }) : [];
          
          // Render cell
          let cellContent = '';
          
          // Checkrides first (higher priority)
          if (checkridesInBlock.length > 0) {
            const cr = checkridesInBlock[0];
            const isActive = compareGameTime(S.gameTime, cr.scheduledTime) >= 0;
            cellContent = `
              <div style="background: ${isActive ? 'var(--accent)' : 'rgba(88, 166, 255, 0.3)'}; padding: 4px; border-radius: 4px; font-size: 11px; cursor: pointer;" 
                   onclick="openCheckrideFromCalendar('${cr.id}')">
                <div style="font-weight: 600; margin-bottom: 2px;">ðŸ”´ CHECKRIDE</div>
                <div style="opacity: 0.9;">${cr.certificateName}</div>
                <div style="opacity: 0.8;">${cr.examiner.name}</div>
              </div>
            `;
          } else if (mxEventsForDay.length > 0) {
            // Show MX event
            const mxCode = mxEventsForDay[0];
            const fleetInfo = S.fleetData[mxCode];
            const mx = fleetInfo.scheduledMx;
            const aircraft = getAircraft(mxCode);
            const isStart = mx.startDate.year === date.year && mx.startDate.month === date.month && mx.startDate.day === date.day;
            const isComplete = mx.completionDate.year === date.year && mx.completionDate.month === date.month && mx.completionDate.day === date.day;
            
            // Calculate days remaining
            const startDayNum = mx.startDate.day + (mx.startDate.month - 1) * 28 + (mx.startDate.year - 2020) * 336;
            const endDayNum = mx.completionDate.day + (mx.completionDate.month - 1) * 28 + (mx.completionDate.year - 2020) * 336;
            const currentDayNum = date.day + (date.month - 1) * 28 + (date.year - 2020) * 336;
            const totalDays = endDayNum - startDayNum;
            const daysElapsed = currentDayNum - startDayNum;
            const daysRemaining = endDayNum - currentDayNum;
            
            // Show labor hours info
            const laborHours = mx.laborHours || 16;
            const hoursPerDay = mx.use24HrOps ? 24 : SHOP_HOURS.hoursPerDay;
            const hoursCompleted = Math.min(laborHours, daysElapsed * hoursPerDay);
            const hoursRemaining = laborHours - hoursCompleted;
            
            let mxLabel, bgColor;
            if (isComplete) {
              mxLabel = 'MX Complete';
              bgColor = 'var(--success)';
            } else if (isStart) {
              mxLabel = `MX: ${laborHours} hrs`;
              bgColor = 'var(--warning)';
            } else {
              mxLabel = `${Math.round(hoursRemaining)} hrs left`;
              bgColor = 'rgba(210, 153, 34, 0.7)';
            }
            
            cellContent = `
              <div style="background: ${bgColor}; padding: 4px; border-radius: 4px; font-size: 11px; color: #000;">
                <div style="font-weight: 600; margin-bottom: 2px;">ðŸ”§ ${mxLabel}</div>
                <div style="opacity: 0.9;">${aircraft?.name || mxCode}</div>
                <div style="opacity: 0.8;">${mx.type.replace('_', ' ')}${mx.use24HrOps ? ' âš¡' : ''}</div>
              </div>
            `;
          } else if (flightsInBlock.length > 0) {
            const sf = flightsInBlock[0];
            const flight = sf.contract;
            const isActive = compareGameTime(S.gameTime, flight.startTime) === 0;
            const isPast = compareGameTime(S.gameTime, flight.startTime) > 0;
            
            // Calculate duration for visual height
            const aircraft = getAircraft(flight.aircraftCode);
            const cruiseSpeed = aircraft?.cruise_speed || 120;
            const flightHours = (flight.distance || 0) / cruiseSpeed;
            const durationHours = Math.ceil(flightHours + 0.5); // +0.5 for ground ops
            const heightPx = Math.max(32, durationHours * 34);
            
            // For round-trip/out-and-back/waypoint flights, show the destination properly
            let routeDisplay = `${flight.from} â†’ ${flight.to}`;
            if (flight.waypoint && flight.waypoint.landmark) {
              // Waypoint missions - show landmark name
              routeDisplay = `${flight.from} â†” ${flight.waypoint.landmark.name}`;
            } else if ((flight.missionStructure === 'round_trip' || flight.missionStructure === 'out_and_back' || flight.missionStructure === 'waypoint') && 
                flight.legs && flight.legs.length > 0) {
              const outboundLeg = flight.legs.find(l => l.type === 'outbound' || l.type === 'revenue');
              if (outboundLeg && outboundLeg.to) {
                routeDisplay = `${flight.from} â†” ${outboundLeg.to}`;
              }
            }
            
            cellContent = `
              <div style="background: ${isPast ? '#7f1d1d' : (isActive ? 'var(--success)' : '#065f46')}; padding: 4px; border-radius: 4px; font-size: 11px; cursor: pointer; height: ${heightPx}px; position: relative; z-index: 10; overflow: hidden;" 
                   onclick="selectFlightFromCalendar('${sf.contractId}')">
                <div style="font-weight: 600; margin-bottom: 2px;">${flight.missionType}</div>
                <div style="opacity: 0.9;">${routeDisplay}</div>
                <div style="opacity: 0.8;">${formatGameTime(flight.startTime)}</div>
                <div style="opacity: 0.7; font-size: 10px;">${flightHours.toFixed(1)}h flight</div>
              </div>
            `;
          } else if (staffMissionsInBlock.length > 0) {
            const sm = staffMissionsInBlock[0];
            const crewNames = sm.crew?.map(c => c.name.split(' ')[0]).join(' & ') || 'Staff';
            const durationHours = Math.ceil((sm.flightHours || 1) + 0.5); // +0.5 for ground ops
            const heightPx = Math.max(32, durationHours * 34); // 34px per hour slot
            cellContent = `
              <div style="background: rgba(59, 130, 246, 0.6); padding: 4px; border-radius: 4px; font-size: 11px; cursor: pointer; height: ${heightPx}px; position: relative; z-index: 10; overflow: hidden;" 
                   onclick="switchTab('staff')">
                <div style="font-weight: 600; margin-bottom: 2px;">âœˆï¸ STAFF: ${sm.missionType}</div>
                <div style="opacity: 0.9;">${sm.route}</div>
                <div style="opacity: 0.8;">${crewNames}</div>
                <div style="opacity: 0.7; font-size: 10px;">${sm.flightHours?.toFixed(1) || '?'}h flight</div>
              </div>
            `;
          }
          
          const cellStyle = isCurrentSlot 
            ? 'background: rgba(59, 130, 246, 0.2); border: 2px solid var(--accent); margin: -1px;' 
            : 'background: var(--bg); border-top: 1px solid var(--border);';
          
          grid += `<div style="${cellStyle} padding: 2px; min-height: 32px; font-size: 10px;">${cellContent}</div>`;
        });
      });
      
      grid += '</div>';
      
      container.innerHTML = nav + grid;
    }
    
    function formatCalendarDate(date) {
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${monthNames[date.month - 1]} ${date.day}`;
    }
    
    function shiftCalendarView(days) {
      S.calendarViewDate = addDays(S.calendarViewDate, days);
      saveState();
      render();
    }
    
    function resetCalendarToToday() {
      S.calendarViewDate = { ...S.gameTime };
      saveState();
      render();
    }
    
    function openCustomMissionBuilder() {
      // Get available aircraft (fleet + certified)
      const availableAircraft = [...new Set([...S.fleet, ...S.pilot.aircraftCertifications])];
      
      let aircraftOptions = availableAircraft.map(code => {
        const aircraft = getAircraft(code);
        if (!aircraft) return '';
        const isOwned = S.fleet.includes(code);
        return `<option value="${code}">${aircraft.name} ${isOwned ? '(Owned)' : '(Contract)'}</option>`;
      }).join('');
      
      // Get mission types
      let missionOptions = Object.keys(MISSION_TYPES).map(type => 
        `<option value="${type}">${type}</option>`
      ).join('');
      
      const modal = document.createElement('div');
      modal.id = 'customFlightModal';
      modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <h2 style="margin: 0; font-size: 18px;">Create Custom Flight</h2>
              <button onclick="closeCustomFlightBuilder()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
              <div style="display: grid; gap: 16px;">
                <!-- Aircraft -->
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Aircraft *</label>
                  <select id="customFlightAircraft" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                    <option value="">Select aircraft...</option>
                    ${aircraftOptions}
                  </select>
                </div>
                
                <!-- Route -->
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: end;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Departure (ICAO) *</label>
                    <input type="text" id="customFlightFrom" value="${S.bases.primary || ''}" placeholder="ICAO" 
                           style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); text-transform: uppercase;">
                  </div>
                  <div style="padding-bottom: 8px; color: var(--muted);">â†’</div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Destination (ICAO) *</label>
                    <input type="text" id="customFlightTo" placeholder="ICAO"
                           style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); text-transform: uppercase;">
                  </div>
                </div>
                
                <!-- Flight Type & Weather Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Flight Type</label>
                    <select id="customFlightType" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                      <option value="Custom Flight">Custom Flight</option>
                      <option value="Charter Flight">Charter Flight</option>
                      <option value="Sightseeing Tour">Sightseeing Tour</option>
                      <option value="General Cargo">General Cargo</option>
                      <option value="Ferry Flight">Ferry Flight</option>
                      <option value="Training Flight">Training Flight</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Weather</label>
                    <select id="customFlightWeather" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                      <option value="Clear Skies">Clear Skies (VFR)</option>
                      <option value="Few Clouds">Few Clouds (VFR)</option>
                      <option value="Scattered Clouds">Scattered Clouds (VFR)</option>
                      <option value="Broken Clouds">Broken Clouds (MVFR)</option>
                      <option value="Overcast">Overcast (IFR)</option>
                      <option value="Light Rain">Light Rain (IFR)</option>
                      <option value="Fog">Fog (IFR)</option>
                    </select>
                  </div>
                </div>
                
                <!-- Time of Day -->
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Time of Day</label>
                  <div style="display: flex; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightTimeOfDay" value="day" checked>
                      <span style="font-size: 12px;">â˜€ï¸ Day</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightTimeOfDay" value="night">
                      <span style="font-size: 12px;">ðŸŒ™ Night</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightTimeOfDay" value="dusk">
                      <span style="font-size: 12px;">ðŸŒ… Dawn/Dusk</span>
                    </label>
                  </div>
                </div>
                
                <!-- Payload -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Passengers</label>
                    <input type="number" id="customFlightPax" min="0" max="500" value="0"
                           style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Cargo (lbs)</label>
                    <input type="number" id="customFlightCargo" min="0" max="100000" value="0"
                           style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                  </div>
                </div>
                
                <!-- Notes -->
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">Briefing Notes (optional)</label>
                  <textarea id="customFlightNotes" rows="2" placeholder="Special instructions, route notes, etc..."
                            style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); resize: vertical;"></textarea>
                </div>
                
                <!-- Schedule -->
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                  <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">SCHEDULE</div>
                  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightSchedule" value="now" checked>
                      <span style="font-size: 12px;">Fly now</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightSchedule" value="later">
                      <span style="font-size: 12px;">Schedule for later</span>
                    </label>
                  </div>
                  <div id="customFlightScheduleTime" style="display: none; margin-top: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                      <div>
                        <label style="display: block; font-size: 10px; color: var(--muted); margin-bottom: 2px;">Day</label>
                        <select id="customFlightDay" style="width: 100%; padding: 6px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;">
                          <option value="0">Today</option>
                          <option value="1">Tomorrow</option>
                          <option value="2">In 2 days</option>
                          <option value="3">In 3 days</option>
                          <option value="7">In 1 week</option>
                        </select>
                      </div>
                      <div>
                        <label style="display: block; font-size: 10px; color: var(--muted); margin-bottom: 2px;">Hour</label>
                        <select id="customFlightHour" style="width: 100%; padding: 6px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;">
                          ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === 8 ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>`).join('')}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Payment -->
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                  <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">COMPENSATION</div>
                  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightPayment" value="auto" checked>
                      <span style="font-size: 12px;">Calculate payment</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="radio" name="customFlightPayment" value="none">
                      <span style="font-size: 12px;">Personal flight (no pay)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
              <button class="btn" onclick="closeCustomFlightBuilder()">Cancel</button>
              <button class="btn" onclick="createCustomFlight()" style="background: var(--accent); color: white; border-color: var(--accent);">Create Flight</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Toggle schedule time visibility
      document.querySelectorAll('input[name="customFlightSchedule"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          document.getElementById('customFlightScheduleTime').style.display = 
            e.target.value === 'later' ? 'block' : 'none';
        });
      });
    }
    window.openCustomMissionBuilder = openCustomMissionBuilder;
    
    function closeCustomFlightBuilder() {
      const modal = document.getElementById('customFlightModal');
      if (modal) modal.remove();
    }
    window.closeCustomMissionBuilder = closeCustomFlightBuilder;
    window.closeCustomFlightBuilder = closeCustomFlightBuilder;
    
    function createCustomFlight() {
      const aircraftCode = document.getElementById('customFlightAircraft').value;
      const fromIcao = document.getElementById('customFlightFrom').value.toUpperCase() || S.bases.primary;
      const toIcao = document.getElementById('customFlightTo').value.toUpperCase();
      const flightType = document.getElementById('customFlightType').value || 'Custom Flight';
      const weather = document.getElementById('customFlightWeather').value || 'Clear Skies';
      const timeOfDay = document.querySelector('input[name="customFlightTimeOfDay"]:checked')?.value || 'day';
      const passengers = parseInt(document.getElementById('customFlightPax').value) || 0;
      const cargo = parseInt(document.getElementById('customFlightCargo').value) || 0;
      const notes = document.getElementById('customFlightNotes').value;
      const paymentType = document.querySelector('input[name="customFlightPayment"]:checked')?.value || 'auto';
      const scheduleType = document.querySelector('input[name="customFlightSchedule"]:checked')?.value || 'now';
      const scheduleDays = parseInt(document.getElementById('customFlightDay')?.value) || 0;
      const scheduleHour = parseInt(document.getElementById('customFlightHour')?.value) || 8;
      
      // Validation
      if (!aircraftCode) {
        alert('Please select an aircraft.');
        return;
      }
      if (!toIcao) {
        alert('Please enter a destination airport (ICAO code).');
        return;
      }
      
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) {
        alert('Invalid aircraft selected.');
        return;
      }
      
      const fromAirport = getAirport(fromIcao);
      const toAirport = getAirport(toIcao);
      
      if (!fromAirport) {
        alert(`Unknown departure airport: ${fromIcao}\n\nPlease use a valid ICAO code.`);
        return;
      }
      if (!toAirport) {
        alert(`Unknown destination airport: ${toIcao}\n\nPlease use a valid ICAO code.`);
        return;
      }
      
      // Calculate distance
      const distance = Math.round(calculateDistance(
        fromAirport.latitude, fromAirport.longitude,
        toAirport.latitude, toAirport.longitude
      ));
      
      // Determine if night flight
      const isNight = timeOfDay === 'night' || timeOfDay === 'dusk';
      
      // Calculate payment
      const isContractPilot = !S.fleet.includes(aircraftCode);
      let payment = 0;
      let contractRate = 0;
      
      if (paymentType === 'auto') {
        if (isContractPilot) {
          // Contract pilot: hourly rate
          const flightTimeHrs = distance / aircraft.cruise_speed;
          contractRate = Math.round(aircraft.operating_cost * 0.4);
          payment = Math.round(flightTimeHrs * contractRate);
        } else {
          // Owned aircraft: charter rate based on distance and payload
          const passengerMiles = passengers * distance;
          const cargoMiles = cargo * distance;
          const ratePerPaxMile = 0.35;
          const ratePerCargoMile = 0.0008;
          const baseRate = distance * 2;
          payment = Math.round(passengerMiles * ratePerPaxMile + cargoMiles * ratePerCargoMile + baseRate);
          // Minimum payment
          if (payment < 100 && (passengers > 0 || cargo > 0)) payment = 100;
        }
      }
      
      // Calculate flight time
      const flightTimeHrs = distance / aircraft.cruise_speed;
      const flightTimeMin = Math.round(flightTimeHrs * 60);
      
      // Calculate scheduled start time
      let startTime;
      if (scheduleType === 'later') {
        startTime = addDays(S.gameTime, scheduleDays);
        startTime.hour = scheduleHour;
        startTime.minute = 0;
      } else {
        startTime = { ...S.gameTime };
      }
      
      // Create the contract with all fields
      const contract = {
        id: 'custom_' + Date.now(),
        type: 'custom',
        missionType: flightType,
        missionStructure: 'point_to_point',
        aircraftCode: aircraftCode,
        aircraftName: aircraft.name,
        isContractPilot: isContractPilot,
        contractType: isContractPilot ? 'contract' : 'owned',
        
        // Route
        from: fromIcao,
        to: toIcao,
        fromIcao: fromIcao,
        toIcao: toIcao,
        fromName: fromAirport.name,
        toName: toAirport.name,
        originIcao: fromIcao,
        originName: fromAirport.name,
        destinationIcao: toIcao,
        destinationName: toAirport.name,
        distance: distance,
        
        // Conditions
        weather: weather,
        isNight: isNight,
        timeOfDay: timeOfDay,
        
        // Payload
        passengers: passengers,
        cargoLbs: cargo,
        cargo: cargo,
        
        // Payment
        payment: payment,
        contractRate: contractRate,
        
        // Meta
        notes: notes,
        estimatedFlightTime: flightTimeMin,
        status: 'scheduled',
        startTime: startTime,
        scheduleBy: addDays(startTime, 1),
        deadline: addDays(startTime, 7),
        
        // Client info for custom flights
        from: isContractPilot ? 'Contract Operator' : 'Self-Scheduled',
        company: isContractPilot ? 'Contract Job' : S.companyName || 'Personal',
        companyTier: 'regional'
      };
      
      // Add to scheduled flights
      S.scheduledFlights.push({
        contractId: contract.id,
        contract: contract,
        scheduledTime: startTime
      });
      
      // Set as active if starting now
      if (scheduleType === 'now') {
        S.activeContractId = contract.id;
        S.selectedContractId = contract.id;
      }
      
      saveState();
      closeCustomFlightBuilder();
      
      if (scheduleType === 'now') {
        switchTab('preflight');
      } else {
        switchTab('calendar');
      }
      render();
      
      const timeStr = scheduleType === 'later' 
        ? `Scheduled for ${startTime.month}/${startTime.day} at ${startTime.hour.toString().padStart(2, '0')}:00`
        : 'Ready to fly now';
      
      const weatherIcon = weather.includes('Clear') ? 'â˜€ï¸' : weather.includes('Cloud') ? 'â›…' : 'ðŸŒ§ï¸';
      const nightIcon = isNight ? 'ðŸŒ™' : '';
      
      alert(`Custom flight created!\n\n${fromIcao} â†’ ${toIcao}\n${distance} nm â€¢ ${aircraft.name}\n${weatherIcon} ${weather} ${nightIcon}\n${payment > 0 ? '$' + payment.toLocaleString() : 'Personal flight'}\n\n${timeStr}`);
    }
    window.createCustomFlight = createCustomFlight;
    window.createCustomMission = createCustomFlight; // Alias for compatibility
    
    function selectFlightFromCalendar(contractId) {
      S.selectedContractId = contractId;
      S.activeContractId = contractId;
      saveState();
      switchTab('preflight');
      render();
    }
    
    function openCheckrideFromCalendar(scheduledId) {
      const scheduled = S.checkrides.scheduled.find(c => c.id === scheduledId);
      if (!scheduled) return;
      
      // Check if it's time for the checkride
      if (compareGameTime(S.gameTime, scheduled.scheduledTime) >= 0) {
        // It's time or past time
        if (scheduled.status === 'in_progress') {
          // Resume checklist (already in progress)
          openCheckrideChecklist(scheduled);
        } else {
          // Show confirm dialog before starting
          const checklist = CHECKRIDE_CHECKLISTS[scheduled.gateKey];
          if (confirm(`Begin ${scheduled.certificateName} Checkride?\n\nExaminer: ${scheduled.examiner.name}\nFee: $${scheduled.fee.toLocaleString()}\nAircraft: ${checklist ? checklist.aircraft : 'Appropriate category'}\n\nMake sure you have:\nâ€¢ Your sim loaded and ready\nâ€¢ VFR weather conditions set\nâ€¢ The evaluation checklist visible\n\nClick OK to open the checklist.`)) {
            startCheckride(scheduledId);
          }
        }
      } else {
        // Not time yet
        alert(`Checkride scheduled for ${formatGameTime(scheduled.scheduledTime)}.\n\nAdvance time to your appointment to begin.`);
      }
    }
    window.openCheckrideFromCalendar = openCheckrideFromCalendar;
    
    function addDays(date, days) {
      const d = new Date(date.year, date.month - 1, date.day);
      d.setDate(d.getDate() + days);
      return {
        year: d.getFullYear(),
        month: d.getMonth() + 1,
        day: d.getDate(),
        hour: date.hour || 0,
        minute: date.minute || 0
      };
    }

    function startScheduledFlight(contractId) {
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === contractId);
      if (!scheduled) return;
      
      const contract = scheduled.contract;
      const isTutorial = scheduled.isTutorial;
      
      // Check fuel for owned aircraft flights
      if (contract.contractType === 'owned' || isTutorial) {
        const aircraft = getAircraft(contract.aircraftCode);
        if (aircraft) {
          const fleetInfo = S.fleetData[contract.aircraftCode];
          if (fleetInfo) {
            const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed || 120;
            const fuelBurnRate = aircraft.fuel_burn_rate || 10;
            const flightHours = Math.max(1.0, contract.distance / cruiseSpeed);
            const fuelRequired = flightHours * fuelBurnRate;
            const reserve = fuelBurnRate * 0.75; // 45 min reserve
            const minFuelNeeded = fuelRequired + reserve;
            
            if (fleetInfo.currentFuel < minFuelNeeded) {
              const shortfall = Math.ceil(minFuelNeeded - fleetInfo.currentFuel);
              alert(`â›½ INSUFFICIENT FUEL\n\nThis flight requires approximately ${Math.ceil(fuelRequired)} gallons.\nWith 45-minute reserve, you need ${Math.ceil(minFuelNeeded)} gallons.\nCurrent fuel: ${Math.round(fleetInfo.currentFuel)} gallons\n\nYou are ${shortfall} gallons short!\n\nRefuel your aircraft before flying.\n(Use the Fleet tab to refuel)`);
              return;
            }
          }
        }
      }
      
      // Check for MX status and pre-flight squawks (owned aircraft only)
      if (contract.contractType === 'owned') {
        // Check if aircraft is still in fleet (might have been sold)
        if (!S.fleet.includes(contract.aircraftCode)) {
          alert(`âš ï¸ AIRCRAFT NOT AVAILABLE\n\nThe ${getAircraft(contract.aircraftCode)?.name || contract.aircraftCode} is no longer in your fleet.\n\nThis flight has been cancelled.`);
          // Remove from scheduled flights
          S.scheduledFlights = S.scheduledFlights.filter(sf => sf.contractId !== contractId);
          saveState();
          render();
          return;
        }
        
        const fleetInfo = S.fleetData[contract.aircraftCode];
        if (fleetInfo) {
          // Check if aircraft is grounded
          const mxStatus = getMxStatus(contract.aircraftCode);
          if (mxStatus === 'grounded') {
            const mxData = getMxData(contract.aircraftCode);
            const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
            let reason = 'Aircraft is grounded for maintenance.';
            if (hoursUntilInspection <= 0) {
              reason = 'Aircraft is grounded - inspection overdue.';
            } else if (fleetInfo.scheduledMx) {
              reason = `Aircraft is in maintenance (${fleetInfo.scheduledMx.type.replace('_', ' ')}).`;
            } else if (fleetInfo.squawks?.some(s => !s.canDefer)) {
              reason = 'Aircraft is grounded due to critical squawk.';
            }
            alert(`ðŸ”§ AIRCRAFT GROUNDED\n\n${reason}\n\nResolve maintenance issues in Fleet â†’ Maintenance before flying.`);
            return;
          }
          
          // Pre-flight squawk check (random chance based on condition)
          const squawk = checkForSquawk(contract.aircraftCode);
          if (squawk) {
            // Add squawk to aircraft
            if (!fleetInfo.squawks) fleetInfo.squawks = [];
            fleetInfo.squawks.push(squawk);
            fleetInfo.mxStatus = getMxStatus(contract.aircraftCode);
            saveState();
            
            const canDefer = squawk.severity === 'minor' || squawk.severity === 'moderate';
            
            if (!canDefer) {
              // Grounding squawk - flight cancelled
              alert(`ðŸ”§ PRE-FLIGHT SQUAWK DISCOVERED\n\n${squawk.description}\nSeverity: ${squawk.severity.toUpperCase()}\nEstimated repair: ${formatCurrency(squawk.cost)}\n\nâš ï¸ This is a grounding issue - flight cannot proceed.\n\nThe flight has been cancelled. Resolve this issue in Fleet â†’ Maintenance.`);
              
              // Cancel the flight and generate complaint
              processMissedFlight({ contract, contractId });
              return;
            } else {
              // Deferrable squawk - player can choose
              if (!confirm(`âš ï¸ PRE-FLIGHT SQUAWK DISCOVERED\n\n${squawk.description}\nSeverity: ${squawk.severity}\nEstimated repair: ${formatCurrency(squawk.cost)}\nCondition impact: -${squawk.conditionImpact}%\n\nThis issue can be deferred, but flying with known issues:\nâ€¢ May lead to further problems\nâ€¢ Will reduce aircraft condition\n\nClick OK to proceed with flight anyway.\nClick Cancel to abort and schedule repairs.`)) {
                // Player chose to abort
                switchTab('fleet');
                return;
              }
              // Player chose to continue - apply condition impact now
              fleetInfo.condition = Math.max(0, (fleetInfo.condition || 100) - squawk.conditionImpact);
            }
          }
        }
      }
      
      // Check if current time matches start time
      const isStartTime = compareGameTime(S.gameTime, contract.startTime) === 0;
      const isBeforeStart = compareGameTime(S.gameTime, contract.startTime) < 0;
      const isMissed = compareGameTime(S.gameTime, contract.startTime) > 0;
      
      if (!isStartTime) {
        if (isBeforeStart) {
          alert(`Flight hasn't started yet.\n\nStart time: ${formatGameTime(contract.startTime)}\n\nUse "Next Flight" to advance to start time.`);
        } else {
          alert(`Flight was missed.\n\nStart time was: ${formatGameTime(contract.startTime)}`);
          // Process the missed flight
          processMissedFlight(scheduled);
        }
        return;
      }
      
      // Set as active and go to pre-flight
      S.activeContractId = contractId;
      saveState();
      switchTab('preflight');
      render();
    }
    
    function processMissedFlight(scheduled) {
      // Generate complaint email
      const angryEmail = {
        id: uuid(),
        type: "complaint",
        from: scheduled.contract.contractType === 'owned' ? "Dissatisfied Customer" : scheduled.contract.aircraftName + " Charter",
        company: "Missed Flight",
        subject: `MISSED FLIGHT - ${scheduled.contract.from} â†’ ${scheduled.contract.to}`,
        body: `We are extremely disappointed that you failed to start the scheduled flight on time.\n\nContract: ${scheduled.contract.missionType}\nScheduled Start: ${formatGameTime(scheduled.contract.startTime)}\n\nThis is unacceptable and has caused significant disruption to our operations. We will not be working with you again.`,
        status: "complaint",
        generatedDay: S.gameTime.day,
        receivedAt: { ...S.gameTime }
      };
      S.emails.push(angryEmail);
      
      // Remove from scheduled flights
      S.scheduledFlights = S.scheduledFlights.filter(sf => sf.contractId !== scheduled.contractId);
      
      // Reset active contract if it was this one
      if (S.activeContractId === scheduled.contractId) {
        S.activeContractId = null;
        S.flightStarted = false;
      }
      
      saveState();
      render();
    }
    
    function checkCashWarnings() {
      if (!S.cashWarningsSent) {
        S.cashWarningsSent = { ten: false, five: false, one: false };
      }
      
      const loc = S.lineOfCredit || { balance: 0, limit: 25000 };
      const locAvailable = loc.limit - loc.balance;
      
      // Check thresholds and send warnings (only once per threshold)
      if (S.cash < 1000 && !S.cashWarningsSent.one) {
        S.cashWarningsSent.one = true;
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Skylift Operations',
          company: 'Financial Alert',
          subject: 'ðŸš¨ CRITICAL: Cash Below $1,000',
          body: `Your available cash has dropped to ${formatCurrency(S.cash)}. This is critically low.\n\n` +
            (locAvailable > 0 ? `You have ${formatCurrency(locAvailable)} available on your Line of Credit. Consider drawing funds to maintain operations.\n\n` : '') +
            `If you have a Maintenance Reserve, you can tap it in emergencies from the Ledger tab â€” but this is not recommended practice and should be a last resort.\n\n` +
            `Contract pilot jobs are available even without aircraft and can help you recover.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
      } else if (S.cash < 5000 && S.cash >= 1000 && !S.cashWarningsSent.five) {
        S.cashWarningsSent.five = true;
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Skylift Operations',
          company: 'Financial Alert',
          subject: 'âš ï¸ Low Cash Warning: Below $5,000',
          body: `Your available cash has dropped to ${formatCurrency(S.cash)}.\n\n` +
            (locAvailable > 0 ? `Consider drawing from your Line of Credit (${formatCurrency(locAvailable)} available) to maintain a healthy operating buffer.\n\n` : '') +
            `Watch your expenses and ensure you have funds for upcoming loan payments and operating costs.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
      } else if (S.cash < 10000 && S.cash >= 5000 && !S.cashWarningsSent.ten) {
        S.cashWarningsSent.ten = true;
        S.emails.unshift({
          id: uuid(),
          type: 'notification', 
          from: 'Skylift Operations',
          company: 'Financial Alert',
          subject: 'ðŸ“Š Cash Advisory: Below $10,000',
          body: `Your available cash has dropped to ${formatCurrency(S.cash)}.\n\n` +
            `This is a routine advisory. Consider building your cash reserves through additional flights or adjusting expenses.\n\n` +
            (locAvailable > 0 ? `Your Line of Credit has ${formatCurrency(locAvailable)} available if needed.` : ''),
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
      }
      
      // Reset warnings only when cash recovers significantly above thresholds (hysteresis)
      // This prevents repeated warnings from small fluctuations
      if (S.cash >= 15000) S.cashWarningsSent.ten = false;  // Reset $10k warning at $15k
      if (S.cash >= 7500) S.cashWarningsSent.five = false;  // Reset $5k warning at $7.5k
      if (S.cash >= 2500) S.cashWarningsSent.one = false;   // Reset $1k warning at $2.5k
    }
    
    function tapMaintenanceReserve() {
      if (S.maintenanceReserve <= 0) {
        alert('Your Maintenance Reserve is empty.');
        return;
      }
      
      const amount = prompt(
        `âš ï¸ TAP MAINTENANCE RESERVE\n\n` +
        `This is not recommended! Your maintenance reserve protects against unexpected repair costs.\n\n` +
        `Available: ${formatCurrency(S.maintenanceReserve)}\n` +
        `Your Cash: ${formatCurrency(S.cash)}\n\n` +
        `Enter amount to withdraw (or cancel):`,
        Math.min(S.maintenanceReserve, 5000)
      );
      
      if (amount === null) return;
      
      const withdrawal = parseInt(amount);
      if (isNaN(withdrawal) || withdrawal <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      if (withdrawal > S.maintenanceReserve) {
        alert(`Cannot withdraw more than ${formatCurrency(S.maintenanceReserve)}`);
        return;
      }
      
      S.maintenanceReserve -= withdrawal;
      S.cash += withdrawal;
      
      recordTransaction(`MX Reserve Withdrawal (Emergency)`, withdrawal, 'transfer');
      
      showToast('âš ï¸ Reserve Tapped', `${formatCurrency(withdrawal)} moved to cash. Rebuild your reserve when possible.`, 'warning');
      
      saveState();
      render();
    }
    window.tapMaintenanceReserve = tapMaintenanceReserve;
    
    function updateMxReserveRate(rate) {
      S.mxReserveRate = parseInt(rate);
      saveState();
      render();
    }
    window.updateMxReserveRate = updateMxReserveRate;

    function checkForMissedFlights() {
      // Find any scheduled flights that are now past their start time
      const missedFlights = S.scheduledFlights.filter(sf => {
        return compareGameTime(S.gameTime, sf.contract.startTime) > 0;
      });
      
      // Process each missed flight
      missedFlights.forEach(sf => {
        processMissedFlight(sf);
      });
    }

    function cancelScheduledFlight(contractId) {
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === contractId);
      if (!scheduled) return;
      
      if (confirm('Cancel this scheduled flight?')) {
        // Remove from scheduled flights
        S.scheduledFlights = S.scheduledFlights.filter(sf => sf.contractId !== contractId);
        saveState();
        render();
      }
    }

    // Generate condition indicators for email (night, IFR, emergency)
    function getEmailIndicators(email) {
      if (email.type === 'complaint') return '';
      
      // Checkride gets special priority indicator
      if (email.type === 'checkride') {
        return '<span title="Checkride - Cannot delete" style="color: var(--danger);">ðŸ”´</span>';
      }
      
      // Welcome email gets info indicator
      if (email.type === 'tutorial-welcome') {
        return '<span title="Getting Started Guide" style="color: var(--success);">ðŸ“—</span>';
      }
      
      // Business welcome email
      if (email.type === 'business-welcome') {
        return '<span title="Business Launch Guide" style="color: var(--success);">ðŸŽ‰</span>';
      }
      
      // Commercial welcome email
      if (email.type === 'commercial-welcome') {
        return '<span title="Commercial Operations Unlocked" style="color: var(--success);">ðŸ†</span>';
      }
      
      // Training flight email (legacy)
      if (email.type === 'training-flight') {
        return '<span title="Training Flight" style="color: var(--success);">âœˆï¸</span>';
      }
      
      const indicators = [];
      
      // Night indicator
      if (email.isNight || (email.startTime && (email.startTime.hour >= 20 || email.startTime.hour < 5))) {
        indicators.push('<span title="Night flight">ðŸŒ™</span>');
      }
      
      // IFR indicator - check if weather is IFR or LIFR
      const ifrWeather = ['Overcast', 'Light Rain', 'Light Snow', 'Rain Showers', 'Thunderstorms', 'Heavy Snow', 'Fog'];
      if (email.weather && ifrWeather.includes(email.weather)) {
        indicators.push('<span title="IFR conditions">â˜ï¸</span>');
      }
      
      // Emergency indicator
      if (email.isEmergency) {
        indicators.push('<span title="Emergency/Urgent">ðŸš¨</span>');
      }
      
      return indicators.join(' ');
    }

    function renderInbox() {
      const container = document.getElementById('emailsList');
      
      // Initialize archivedEmails if missing (migration)
      if (!S.archivedEmails) S.archivedEmails = [];
      
      // Initialize inbox view state
      if (!S.inboxView) S.inboxView = 'inbox';
      
      const isArchiveView = S.inboxView === 'archive';
      const emailsToShow = isArchiveView ? S.archivedEmails : S.emails;
      
      // Build tabs
      let html = `
        <div class="inbox-tabs">
          <button class="inbox-tab ${!isArchiveView ? 'active' : ''}" onclick="switchInboxView('inbox')">Inbox (${S.emails.length})</button>
          <button class="inbox-tab archive-tab ${isArchiveView ? 'active' : ''}" onclick="switchInboxView('archive')">Archive (${S.archivedEmails.length})</button>
        </div>
      `;
      
      if (emailsToShow.length === 0) {
        if (isArchiveView) {
          html += '<div class="empty-state">No archived emails.</div>';
        } else {
          html += '<div class="empty-state">No emails. Advance time during business hours (08:00 - 18:00) to receive inquiries.</div>';
        }
        container.innerHTML = html;
        return;
      }
      
      const selectedEmail = emailsToShow.find(e => e.id === S.selectedEmailId);
      
      // Sort emails by receivedAt (newest first)
      const sortedEmails = [...emailsToShow].sort((a, b) => {
        if (!a.receivedAt || !b.receivedAt) return 0;
        return compareGameTime(b.receivedAt, a.receivedAt);
      });
      
      // Email list with detail inserted below selected email
      html += '<div class="email-list">';
      sortedEmails.forEach(email => {
        const isSelected = email.id === S.selectedEmailId;
        const timeStr = email.receivedAt ? formatGameTime(email.receivedAt) : '';
        
        // Check if email is expired (past scheduleBy time)
        const isExpired = email.scheduleBy && email.status === 'pending' && 
          compareGameTime(S.gameTime, email.scheduleBy) > 0;
        
        // Build condition indicators
        const indicators = getEmailIndicators(email);
        const expiredTag = isExpired ? '<span style="color: var(--danger); margin-left: 8px;" title="Deadline passed">EXPIRED</span>' : '';
        
        // Build email preview text
        let previewText = '';
        if (email.type === 'complaint') {
          previewText = email.company;
        } else if (email.type === 'checkride') {
          previewText = `FAA Practical Test â€¢ ${email.certificateName}`;
        } else if (email.type === 'tutorial-welcome') {
          previewText = 'Getting Started Guide';
        } else if (email.type === 'business-welcome') {
          previewText = 'Business Launch Guide';
        } else if (email.type === 'commercial-welcome') {
          previewText = 'Commercial Operations Unlocked';
        } else if (email.type === 'training-flight') {
          previewText = `Training â€¢ ${email.flightPlan || 'Scheduled'}`;
        } else if (email.type === 'notification') {
          previewText = email.company || 'System Notification';
        } else if (email.type === 'credit-assessment') {
          const improved = email.tierChange?.improved;
          previewText = `ðŸ“Š ${improved ? 'â–² Upgraded' : 'â–¼ Downgraded'} â€¢ ${email.tierChange?.to || 'Assessment'}`;
        } else if (email.type === 'payment_due') {
          // LOC statement
          previewText = `ðŸ’³ LOC Statement â€¢ Min ${formatCurrency(email.locMinPayment)}`;
        } else if (email.type === 'payment-due') {
          const statusIcon = email.status === 'paid' ? 'âœ“' : email.status === 'skipped' ? 'â­' : 'ðŸ’³';
          previewText = `${statusIcon} ${email.paymentType === 'loan' ? 'Loan' : 'Lease'} â€¢ ${formatCurrency(email.monthlyPayment)}`;
        } else if (email.type === 'alert') {
          // Alert emails (payroll warning, etc)
          previewText = email.subject || 'Alert';
        } else if (email.type === 'staff_raise') {
          // Staff raise request
          const staff = S.staff.find(s => s.id === email.staffId);
          const roleName = staff ? getRoleDisplayName(staff.role) : 'Staff';
          previewText = `${roleName} â€¢ $${email.currentSalary?.toLocaleString() || '?'} â†’ $${email.requestedSalary?.toLocaleString() || '?'}`;
        } else {
          // Mission emails - show route and pax/cargo
          const destName = email.missionStructure === 'waypoint' ? 'Waypoint' : email.toName;
          let details = `${email.company} â€¢ ${email.fromName} â†’ ${destName}`;
          
          // Add passengers/cargo info
          const paxCargo = [];
          if (email.passengers && email.passengers > 0) paxCargo.push(`${email.passengers} pax`);
          if (email.cargoLbs && email.cargoLbs > 0) paxCargo.push(`${email.cargoLbs} lbs`);
          if (paxCargo.length > 0) details += ` (${paxCargo.join(', ')})`;
          
          previewText = details;
        }
        
        // Determine if email can be archived/deleted inline
        const canArchive = !isArchiveView;
        const canDelete = true; // All emails can be deleted
        
        html += `
          <div class="email-item ${isSelected ? 'selected' : ''}${isExpired ? ' expired' : ''}" style="${isExpired ? 'opacity: 0.7;' : ''}">
            <div class="email-header" onclick="selectEmail('${email.id}')" style="cursor: pointer;">
              <div class="email-from" style="display: flex; align-items: center;">
                ${canArchive ? `<button class="email-action-btn archive" onclick="event.stopPropagation(); archiveEmail('${email.id}')" title="Archive" style="margin-right: 6px;">ðŸ“</button>` : ''}
                <span>${email.from}${indicators ? ` <span style="margin-left: 8px;">${indicators}</span>` : ''}${expiredTag}</span>
              </div>
              <div class="email-time" style="display: flex; align-items: center; gap: 8px;">
                ${timeStr}
                <button class="email-action-btn delete" onclick="event.stopPropagation(); deleteEmailInline('${email.id}')" title="Delete">Ã—</button>
              </div>
            </div>
            <div class="email-subject" onclick="selectEmail('${email.id}')" style="cursor: pointer;">Subject: ${email.subject}</div>
            <div class="email-preview" onclick="selectEmail('${email.id}')" style="cursor: pointer;">${previewText}</div>
          </div>
        `;
        
        // Insert email detail immediately after this email if it's selected
        if (isSelected && selectedEmail) {
          html += renderEmailDetail(selectedEmail);
        }
      });
      html += '</div>';
      
      container.innerHTML = html;
    }
    
    function switchInboxView(view) {
      S.inboxView = view;
      S.selectedEmailId = null;
      renderInbox();
    }
    
    function archiveEmail(emailId) {
      const emailIndex = S.emails.findIndex(e => e.id === emailId);
      if (emailIndex === -1) return;
      
      const email = S.emails[emailIndex];
      
      // Move to archive
      S.archivedEmails.push(email);
      S.emails.splice(emailIndex, 1);
      
      if (S.selectedEmailId === emailId) {
        S.selectedEmailId = null;
      }
      
      saveState();
      renderInbox();
    }
    
    function deleteEmailInline(emailId) {
      // Check if in archive view
      const isArchiveView = S.inboxView === 'archive';
      const emailList = isArchiveView ? S.archivedEmails : S.emails;
      
      const email = emailList.find(e => e.id === emailId);
      if (!email) return;
      
      // Check for protected email types
      if (email.type === 'checkride') {
        alert('Checkride emails cannot be deleted. Complete or fail the checkride to remove this email.');
        return;
      }
      
      // Remove from appropriate list
      if (isArchiveView) {
        S.archivedEmails = S.archivedEmails.filter(e => e.id !== emailId);
      } else {
        S.emails = S.emails.filter(e => e.id !== emailId);
      }
      
      if (S.selectedEmailId === emailId) {
        S.selectedEmailId = null;
      }
      
      saveState();
      renderInbox();
    }
    
    function renderEmailDetail(email) {
      // Handle complaint emails (missed flights)
      if (email.type === "complaint") {
        return `
          <div class="email-detail" style="background: rgba(239, 68, 68, 0.05);">
            <div class="email-detail-header" style="border-color: var(--danger);">
              <div style="font-weight: 600; font-size: 16px; color: var(--danger);">From: ${email.from}</div>
              <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
            </div>
            <div class="email-body" style="white-space: pre-wrap;">${email.body}</div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
              <button class="btn" onclick="deleteEmail('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Delete Email</button>
            </div>
          </div>
        `;
      }
      
      // Handle checkride emails
      if (email.type === "tutorial-welcome") {
        const pilotName = S.pilot.name || 'Pilot';
        const currentHours = S.totalHoursFlown.toFixed(1);
        const hoursNeeded = Math.max(0, CERT_REQUIREMENTS.private.hoursTotal - S.totalHoursFlown).toFixed(1);
        
        return `
          <div class="email-detail" style="background: rgba(63, 185, 80, 0.03);">
            <div class="email-detail-header" style="border-color: var(--success);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px;">From: Skylift Operations</div>
                  <div style="color: var(--muted); font-size: 11px;">Welcome to Your Aviation Journey</div>
                </div>
                <div style="font-size: 10px; color: var(--success);">âœˆï¸ GETTING STARTED</div>
              </div>
            </div>
            
            <div class="email-body">
              <p><strong>Welcome to Skylift, ${pilotName}!</strong></p>
              
              <p>You're a student pilot preparing to launch your own aviation business. Before you can accept contracts and start earning, you need to complete your flight training and earn your Private Pilot Certificate.</p>
              
              <p style="font-size: 12px; color: var(--muted);"><em>Note: Until you earn your PPL, acquire your own aircraft, and start your business, training flights will be in aircraft owned by your flight school â€” not your personal aircraft.</em></p>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 8px; margin: 8px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">YOUR TRAINING STATUS</div>
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                  <span>Hours logged: <strong>${currentHours}</strong></span>
                  <span>Required: <strong>${CERT_REQUIREMENTS.private.hoursTotal} hrs</strong></span>
                  <span>Remaining: <strong style="color: var(--warning);">${hoursNeeded} hrs</strong></span>
                </div>
              </div>
              
              <div style="background: rgba(88, 166, 255, 0.08); border: 1px solid var(--accent); border-radius: 4px; padding: 8px; margin: 8px 0;">
                <div style="font-size: 11px; color: var(--accent); margin-bottom: 4px;">HOW SKYLIFT WORKS</div>
                <div style="font-size: 12px; line-height: 1.4;">
                  <p style="margin: 0 0 4px 0;"><strong>Time:</strong> Game time advances when you click +30 Min, +1 Hr, +6 Hr, or +1 Day. A 2-hour flight consumes 2 hours of game time.</p>
                  <p style="margin: 0 0 4px 0;"><strong>Training:</strong> Go to Calendar and click the green <strong>+ Training Flight</strong> button. Choose "Custom" to plan your own route, or "Generate" to auto-build one.</p>
                  <p style="margin: 0;"><strong>Flying:</strong> When departure time arrives, open the flight from Calendar, fly the route in MSFS, then file your report to log hours.</p>
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 8px; margin: 8px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">THE PATH FORWARD</div>
                <div style="font-size: 12px; line-height: 1.4;">
                  <div style="margin-bottom: 2px;">1. Schedule and complete training flights until you reach ${CERT_REQUIREMENTS.private.hoursTotal} hours</div>
                  <div style="margin-bottom: 2px;">2. Pass your Private Pilot checkride</div>
                  <div style="margin-bottom: 2px;">3. Start accepting contracts and building your business</div>
                  <div>4. Earn additional ratings to unlock more aircraft and missions</div>
                </div>
              </div>
              
              <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">During training, focus on building hours. Fuel and operating costs are not tracked during your student phase. Business features like finances and maintenance will activate once you earn your PPL.</p>
            </div>
            
            <div style="padding: 8px 12px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center;">
              <button class="btn" onclick="switchTab('calendar'); setTimeout(openTrainingModal, 100);" style="background: var(--success); color: var(--bg); border-color: var(--success); padding: 8px 16px; font-size: 12px;">ðŸ“š Schedule Your First Flight</button>
              <button class="btn" onclick="deleteEmail('${email.id}')" style="font-size: 12px;">Dismiss</button>
            </div>
          </div>
        `;
      }
      
      if (email.type === "training-flight") {
        // This type is no longer used - flights go directly to calendar
        return `
          <div class="email-detail">
            <div class="email-body">
              <p>Training flights are now scheduled directly from the Calendar tab.</p>
              <p>Click <strong>ðŸ“š Schedule Training</strong> to create a new training flight.</p>
            </div>
          </div>
        `;
      }
      
      if (email.type === "business-welcome") {
        const hoursToCommercial = Math.max(0, CERT_REQUIREMENTS.commercial.hoursTotal - S.totalHoursFlown).toFixed(1);
        const showNameInput = !email.companyNameSaved;
        
        return `
          <div class="email-detail" style="background: rgba(63, 185, 80, 0.03);">
            <div class="email-detail-header" style="border-color: var(--success);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px;">From: Skylift Operations</div>
                  <div style="color: var(--muted); font-size: 11px;">Business Launch Guide</div>
                </div>
                <div style="font-size: 10px; color: var(--success);">ðŸŽ‰ CONGRATULATIONS</div>
              </div>
            </div>
            
            <div class="email-body">
              <p><strong>Congratulations on earning your Private Pilot Certificate!</strong></p>
              
              <p>You've logged your hours, passed your checkride, and earned your wings. Now it's time to turn your passion into a business.</p>
              
              <div style="background: var(--bg); border: 1px solid var(--success); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--success); margin-bottom: 6px;">NAME YOUR COMPANY</div>
                ${showNameInput ? `
                  <div style="margin-bottom: 6px; font-size: 11px; color: var(--muted);">We've suggested a name, but feel free to choose your own:</div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="companyNameInput" value="${email.suggestedName}" style="flex: 1; padding: 8px; font-size: 13px; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                    <button class="btn" onclick="saveCompanyName('${email.id}')" style="background: var(--success); color: var(--bg); border-color: var(--success);">Save</button>
                  </div>
                ` : `
                  <div style="font-size: 16px; font-weight: 600; color: var(--success);">âœ“ ${email.savedCompanyName || S.companyName}</div>
                `}
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">YOUR OPERATION</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <div style="color: var(--muted);">Home Base</div>
                  <div><strong>${email.homeBase}</strong> â€” ${email.homeName}</div>
                  ${S.fleet.length > 0 ? `
                  <div style="color: var(--muted);">Fleet</div>
                  <div><strong>${email.fleet}</strong></div>
                  ` : `
                  <div style="color: var(--muted);">Fleet</div>
                  <div style="color: var(--warning);"><em>None â€” contract pilot work available</em></div>
                  `}
                  <div style="color: var(--muted);">Starting Capital</div>
                  <div><strong>${formatCurrency(email.startingCash)}</strong></div>
                </div>
              </div>
              
              <div style="background: rgba(88, 166, 255, 0.08); border: 1px solid var(--accent); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--accent); margin-bottom: 6px;">NEW FEATURES UNLOCKED</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <div>â€¢ <strong>Finances</strong> â€” Track revenue, expenses, and profit</div>
                  <div>â€¢ <strong>Fleet Management</strong> â€” Monitor aircraft condition, fuel state, and maintenance</div>
                  <div>â€¢ <strong>Flights</strong> â€” Review customer inquiries, negotiate terms, and execute contracts</div>
                  <div>â€¢ <strong>Ratings</strong> â€” Schedule checkrides for Night, Instrument, Multi-Engine, and more</div>
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">Note: Fuel and operating costs are now tracked for all flights.</div>
              </div>
              
              <div style="background: rgba(139, 92, 246, 0.08); border: 1px solid #8b5cf6; border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: #8b5cf6; margin-bottom: 6px;">RATINGS NOW AVAILABLE</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <p style="margin: 0 0 8px 0;">With your PPL, you can now earn additional ratings to expand your capabilities:</p>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px;">
                    <div>ðŸŒ™ Night Rating</div>
                    <div>â˜ï¸ Instrument Rating</div>
                    <div>âœˆï¸ Multi-Engine</div>
                    <div>ðŸš Helicopter</div>
                    <div>ðŸŒŠ Seaplane</div>
                    <div>ðŸ”¥ Turbine</div>
                  </div>
                  <p style="margin: 8px 0 0 0; font-size: 11px; color: var(--muted);">Schedule checkrides from the <strong>Certs & Ratings</strong> tab in your Pilot panel.</p>
                </div>
              </div>
              
              <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--warning); margin-bottom: 6px;">CURRENT LIMITATIONS</div>
                <div style="font-size: 12px; line-height: 1.4;">
                  <p style="margin: 0 0 6px 0;">Until you earn your Commercial Pilot Certificate (${CERT_REQUIREMENTS.commercial.hoursTotal} hours), you're limited to <strong>expense-sharing missions</strong> on your own aircraft:</p>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px 12px;">
                    <div>âœˆï¸ Discovery Flights</div>
                    <div>âœˆï¸ Sightseeing Tours</div>
                    <div>ðŸ“· Aerial Photography</div>
                    <div>ðŸ”„ Ferry Flights</div>
                  </div>
                  <p style="margin: 6px 0 0 0; color: var(--muted);">These missions cover your costs but won't generate significant profit. Think of this phase as building hours and reputation.</p>
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">A NOTE ON REALISM</div>
                <div style="font-size: 11px; color: var(--muted); line-height: 1.4;">
                  Skylift simplifies FAA regulations for gameplay. In reality, Private Pilots cannot fly for compensation, and Commercial certification requires 250 flight hours. We've bent the rules to allow low-revenue and cost-sharing flights with your PPL, and reduced the Commercial requirement to ${CERT_REQUIREMENTS.commercial.hoursTotal} hours to keep things moving. You can adjust all progression requirements â€” including switching to realistic hour minimums â€” in <strong>Settings â†’ Gameplay Preferences</strong>.
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">NEXT STEPS</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <div>1. Name your company above</div>
                  <div>2. Begin advancing game time â€” customer inquiries will arrive in your Inbox</div>
                  <div>3. Review incoming inquiries, negotiate terms, and accept flights while managing your schedule</div>
                  <div>4. Build hours toward your Commercial certificate</div>
                  <div>5. At ${CERT_REQUIREMENTS.commercial.hoursTotal} hours (${hoursToCommercial} remaining), full revenue operations unlock</div>
                </div>
              </div>
              
              <p style="font-size: 13px; margin-top: 10px;">Blue skies ahead, Captain.</p>
              <p style="font-size: 12px; color: var(--muted); margin: 4px 0 0 0;">â€” Skylift Operations</p>
              
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                <button class="btn" onclick="viewCertifications()" style="background: var(--success); color: var(--bg); border-color: var(--success); padding: 8px 16px; font-size: 12px;">View Your Certificate</button>
              </div>
            </div>
          </div>
        `;
      }
      
      if (email.type === "commercial-welcome") {
        return `
          <div class="email-detail" style="background: rgba(63, 185, 80, 0.03);">
            <div class="email-detail-header" style="border-color: var(--success);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px;">From: Skylift Operations</div>
                  <div style="color: var(--muted); font-size: 11px;">Commercial Operations Unlocked</div>
                </div>
                <div style="font-size: 10px; color: var(--success);">ðŸŽ‰ MILESTONE</div>
              </div>
            </div>
            
            <div class="email-body">
              <p><strong>Congratulations, Commercial Pilot!</strong></p>
              
              <p>You've reached a major milestone. With your Commercial Pilot Certificate in hand, you're now authorized to fly for compensation without restrictions.</p>
              
              <div style="background: rgba(88, 166, 255, 0.08); border: 1px solid var(--accent); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--accent); margin-bottom: 6px;">WHAT'S NEW</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <div>â€¢ <strong>All Mission Types</strong> â€” Charter, cargo, medical transport, executive flights, and more</div>
                  <div>â€¢ <strong>Contract Pilot Work</strong> â€” Fly for other operators using their aircraft</div>
                  <div>â€¢ <strong>Higher-Value Contracts</strong> â€” Access to premium clients and longer routes</div>
                  <div>â€¢ <strong>Fleet Expansion</strong> â€” Consider adding aircraft to grow your operation</div>
                </div>
              </div>
              
              <div style="background: rgba(245, 158, 11, 0.08); border: 1px solid var(--warning); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--warning); margin-bottom: 6px;">ðŸ“‹ AIRCRAFT CERTIFICATIONS</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <p style="margin: 0 0 8px 0;">Now that you have your Commercial certificate, you can fly as a <strong>contract pilot</strong> for other operators.</p>
                  <div>â€¢ Go to <strong>Pilot â†’ Certs & Ratings</strong> and scroll down to Aircraft Certifications</div>
                  <div>â€¢ <strong>Owned aircraft</strong> in your fleet are always certified â€” you'll get customer inquiries</div>
                  <div>â€¢ <strong>Certify other aircraft</strong> to receive contract pilot job offers for those types</div>
                  <div>â€¢ Contract work: they provide the aircraft + fuel, you get paid hourly</div>
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">YOUR OPERATION</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <div style="color: var(--muted);">Company</div>
                  <div><strong>${email.companyName}</strong></div>
                  <div style="color: var(--muted);">Home Base</div>
                  <div><strong>${email.homeBase}</strong> â€” ${email.homeName}</div>
                  <div style="color: var(--muted);">Fleet</div>
                  <div><strong>${email.fleetCount} aircraft</strong></div>
                  <div style="color: var(--muted);">Total Hours</div>
                  <div><strong>${email.totalHours}</strong></div>
                  <div style="color: var(--muted);">Reputation</div>
                  <div>${email.reputation}</div>
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">LOOKING AHEAD</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <div>â€¢ <strong>Additional Ratings</strong> â€” Night, Instrument, Multi-Engine unlock more missions and aircraft</div>
                  <div>â€¢ <strong>Fleet Expansion</strong> â€” More aircraft means more simultaneous contracts</div>
                  <div>â€¢ <strong>Hiring Pilots</strong> â€” <em>Coming soon: Bring on employee pilots to fly contracts while you focus on growing the business</em></div>
                </div>
              </div>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin: 10px 0;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 6px;">NEXT STEPS</div>
                <div style="font-size: 12px; line-height: 1.5;">
                  <div>1. Check your inbox â€” you'll notice more variety in available contracts</div>
                  <div>2. Go to <strong>Certs & Ratings â†’ Aircraft Certifications</strong> to choose which aircraft you want contract offers for</div>
                  <div>3. Keep building hours toward ATP (${CERT_REQUIREMENTS.atp.hoursTotal} hours, ${email.hoursToAtp} remaining) for airline-level operations</div>
                </div>
              </div>
              
              <p style="font-size: 13px; margin-top: 10px;">Blue skies, Captain.</p>
              <p style="font-size: 12px; color: var(--muted); margin: 4px 0 0 0;">â€” Skylift Operations</p>
            </div>
          </div>
        `;
      }
      
      if (email.type === "checkride") {
        const gate = PROGRESSION_GATES[email.gateKey];
        const checklist = CHECKRIDE_CHECKLISTS[email.gateKey];
        return `
          <div class="email-detail" style="background: rgba(88, 166, 255, 0.03);">
            <div class="email-detail-header" style="border-color: var(--accent); padding: 10px 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 15px;">From: ${email.from}</div>
                  <div style="color: var(--muted); font-size: 12px;">Designated Pilot Examiner</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 10px; color: var(--muted);">FAA Certificate</div>
                  <div style="font-size: 11px; font-family: monospace;">#${email.examiner.id}</div>
                </div>
              </div>
            </div>
            
            <div class="email-body" style="line-height: 1.4; font-size: 13px; padding: 10px 12px;">
              <p style="margin: 0 0 6px 0;">Dear Applicant,</p>
              <p style="margin: 0 0 8px 0;">Based on your flight experience, you are eligible for your <strong>${email.certificateName}</strong> practical test. I confirm you meet minimum hour requirements.</p>
              
              <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin: 8px 0;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">Practical Test Details</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px;">
                  <div><span style="color: var(--muted);">Certificate:</span> <strong>${email.certificateName}</strong></div>
                  <div><span style="color: var(--muted);">Aircraft:</span> ${checklist ? checklist.aircraft : 'Appropriate category'}</div>
                  <div><span style="color: var(--muted);">Duration:</span> ${checklist ? checklist.duration : '1.5-2 hours'}</div>
                  <div><span style="color: var(--muted);">Fee:</span> <strong style="color: var(--warning);">$${email.fee.toLocaleString()}</strong></div>
                </div>
              </div>
              
              <p style="margin: 0 0 6px 0;"><strong>What to expect:</strong> ${gate.description}.</p>
              
              <p style="margin: 0;">Best regards,</p>
              <div style="font-family: 'Brush Script MT', 'Segoe Script', cursive; font-size: 20px; color: var(--accent); margin-top: 2px;">${email.from}</div>
              <div style="font-size: 10px; color: var(--muted);">FAA Designated Pilot Examiner</div>
            </div>
            
            <div style="margin-top: 8px; padding: 10px 12px; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              ${S.checkrides?.scheduled?.some(c => c.gateKey === email.gateKey) 
                ? `<span style="color: var(--success); font-size: 13px; font-weight: 500;">âœ“ Checkride Scheduled â€” Check your Calendar</span>`
                : `<button class="btn" onclick="scheduleCheckride('${email.id}')" style="background: var(--accent); color: var(--bg); border-color: var(--accent); padding: 8px 20px; font-size: 13px;">ðŸ“… Schedule Checkride</button>`}
              <span style="color: var(--muted); font-size: 11px;">ðŸ”´ Cannot delete until complete</span>
            </div>
          </div>
        `;
      }
      
      // Handle staff checkride eligibility emails
      if (email.type === 'staff_checkride') {
        const staffMember = S.staff.find(s => s.id === email.staffId);
        const isStillEmployed = !!staffMember;
        const config = STAFF_CERT_REQUIREMENTS[email.certKey];
        
        // Check cooldown
        let cooldownActive = false;
        let cooldownDays = 0;
        if (staffMember?.pilot?.certCooldowns?.[email.certKey]) {
          const cooldown = staffMember.pilot.certCooldowns[email.certKey];
          const currentDays = (S.gameTime.year * 336) + ((S.gameTime.month - 1) * 28) + S.gameTime.day;
          const cooldownEndDays = (cooldown.year * 336) + ((cooldown.month - 1) * 28) + cooldown.day;
          if (currentDays < cooldownEndDays) {
            cooldownActive = true;
            cooldownDays = cooldownEndDays - currentDays;
          }
        }
        
        // Check if already has cert
        const alreadyHasCert = staffMember?.pilot?.certificates?.includes(email.certKey);
        
        let actionButton;
        if (!isStillEmployed) {
          actionButton = `<span style="color: var(--danger); font-size: 13px;">Staff member no longer employed</span>`;
        } else if (alreadyHasCert) {
          actionButton = `<span style="color: var(--success); font-size: 13px;">âœ“ ${config?.name || 'Certificate'} Earned</span>`;
        } else if (cooldownActive) {
          actionButton = `<span style="color: var(--warning); font-size: 13px;">â³ Retry available in ${cooldownDays} day(s)</span>`;
        } else {
          actionButton = `<button class="btn" onclick="scheduleStaffCheckride('${email.id}')" style="background: var(--accent); color: var(--bg); border-color: var(--accent); padding: 8px 20px; font-size: 13px;">ðŸ“… Schedule Checkride ($${email.fee?.toLocaleString() || '?'})</button>`;
        }
        
        return `
          <div class="email-detail" style="background: rgba(88, 166, 255, 0.03);">
            <div class="email-detail-header" style="border-color: var(--accent);">
              <div style="font-weight: 600; font-size: 16px;">ðŸŽ“ From: ${email.from}</div>
              <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
            </div>
            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;">${email.body}</div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              ${actionButton}
            </div>
          </div>
        `;
      }
      
      // Handle notification emails (financing, lease, system messages) and alert emails
      if (email.type === 'notification' || email.type === 'alert') {
        // Check if this is a price drop email with a listing link
        const hasListing = email.listingId && email.from === 'Market Alert';
        const isAlert = email.type === 'alert';
        
        return `
          <div class="email-detail" ${isAlert ? 'style="background: rgba(210, 153, 34, 0.05);"' : ''}>
            <div class="email-detail-header" ${isAlert ? 'style="border-color: var(--warning);"' : ''}>
              <div style="font-weight: 600; font-size: 16px;">${isAlert ? 'âš ï¸ ' : ''}From: ${email.from}</div>
              <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
            </div>
            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;">${email.body}</div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
              ${hasListing ? `<button class="btn" onclick="viewMarketListing('${email.listingId}')" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">View Listing</button>` : ''}
              <button class="btn" onclick="deleteEmail('${email.id}')">Delete</button>
            </div>
          </div>
        `;
      }
      
      // Handle staff raise request emails
      if (email.type === 'staff_raise') {
        const staff = S.staff.find(s => s.id === email.staffId);
        const roleName = staff ? getRoleDisplayName(staff.role) : 'Staff Member';
        const isPending = email.status === 'pending';
        const statusText = email.status === 'accepted' ? 'âœ“ Approved' : email.status === 'declined' ? 'âœ— Declined' : 'Pending';
        const statusColor = email.status === 'accepted' ? 'var(--success)' : email.status === 'declined' ? 'var(--danger)' : 'var(--warning)';
        
        return `
          <div class="email-detail" style="background: rgba(88, 166, 255, 0.03);">
            <div class="email-detail-header" style="border-color: var(--accent);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 16px;">From: ${email.from}</div>
                  <div style="color: var(--muted); font-size: 13px;">${roleName}</div>
                </div>
                <div style="font-size: 12px; color: ${statusColor}; font-weight: 600;">${statusText}</div>
              </div>
            </div>
            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;">${email.body}</div>
            
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-top: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: var(--muted);">Current Salary:</span>
                <span>$${email.currentSalary?.toLocaleString() || '?'}/month</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">Requested Salary:</span>
                <span style="font-weight: 600; color: var(--warning);">$${email.requestedSalary?.toLocaleString() || '?'}/month</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                <span style="color: var(--muted);">Increase:</span>
                <span style="color: var(--danger);">+$${((email.requestedSalary || 0) - (email.currentSalary || 0)).toLocaleString()}/month</span>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
              ${isPending ? `
                <button class="btn" onclick="acceptRaise('${email.id}')" style="background: var(--success); color: var(--bg); border-color: var(--success);">Approve Raise</button>
                <button class="btn" onclick="declineRaise('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Decline</button>
              ` : `
                <button class="btn" onclick="deleteEmail('${email.id}')">Delete</button>
              `}
            </div>
          </div>
        `;
      }
      
      // Credit assessment emails (tier changes)
      if (email.type === 'credit-assessment') {
        const improved = email.tierChange?.improved;
        const tierColor = improved ? 'var(--success)' : 'var(--danger)';
        const bgColor = improved ? 'rgba(63, 185, 80, 0.08)' : 'rgba(239, 68, 68, 0.08)';
        
        return `
          <div class="email-detail" style="background: ${bgColor};">
            <div class="email-detail-header" style="border-color: ${tierColor};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 16px;">From: ${email.from}</div>
                  <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
                </div>
                <div style="background: ${tierColor}; color: ${improved ? '#000' : '#fff'}; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                  ${improved ? 'â–² UPGRADED' : 'â–¼ DOWNGRADED'}
                </div>
              </div>
            </div>
            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;">${email.body}</div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
              <button class="btn" onclick="switchTab('financials')" style="background: var(--accent); color: var(--bg); border-color: var(--accent);">View Financial Health</button>
              <button class="btn" onclick="deleteEmail('${email.id}')">Delete</button>
            </div>
          </div>
        `;
      }
      
      // LOC statement emails
      if (email.type === 'payment_due') {
        const minPayment = email.locMinPayment || 100;
        const canAfford = S.cash >= minPayment;
        const locBalance = S.lineOfCredit?.balance || 0;
        
        return `
          <div class="email-detail">
            <div class="email-detail-header">
              <div style="font-weight: 600; font-size: 16px;">From: ${email.from}</div>
              <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
            </div>
            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;">${email.body}</div>
            
            <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-top: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                <div><span style="color: var(--muted);">Minimum Payment:</span></div>
                <div style="text-align: right; font-weight: 600;">${formatCurrency(minPayment)}</div>
                <div><span style="color: var(--muted);">Current Balance:</span></div>
                <div style="text-align: right;">${formatCurrency(locBalance)}</div>
                <div><span style="color: var(--muted);">Your Cash:</span></div>
                <div style="text-align: right; color: ${canAfford ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(S.cash)}</div>
              </div>
            </div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn primary" onclick="showLOCModal('pay')" ${locBalance <= 0 ? 'disabled' : ''} 
                      style="background: var(--success); border-color: var(--success);">
                ðŸ’µ Make Payment
              </button>
              <button class="btn" onclick="switchTab('financials')">Go to Ledger</button>
              <button class="btn" onclick="deleteEmail('${email.id}')">Delete</button>
            </div>
          </div>
        `;
      }
      
      // Payment due emails
      if (email.type === 'payment-due') {
        const isPaid = email.status === 'paid';
        const isSkipped = email.status === 'skipped';
        const canAfford = S.cash >= email.monthlyPayment;
        
        return `
          <div class="email-detail" style="background: ${isPaid ? 'rgba(63, 185, 80, 0.05)' : isSkipped ? 'rgba(239, 68, 68, 0.05)' : 'var(--panel)'};">
            <div class="email-detail-header" style="border-color: ${isPaid ? 'var(--success)' : isSkipped ? 'var(--danger)' : 'var(--warning)'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; font-size: 16px;">From: ${email.from}</div>
                  <div style="color: var(--muted); font-size: 13px;">Subject: ${email.subject}</div>
                </div>
                ${isPaid ? '<span style="color: var(--success); font-weight: 600;">âœ“ PAID</span>' : 
                  isSkipped ? '<span style="color: var(--danger); font-weight: 600;">â­ SKIPPED</span>' : ''}
              </div>
            </div>
            
            <div class="email-body" style="padding: 16px;">
              <p style="margin: 0 0 16px 0;">Your ${email.paymentType === 'loan' ? 'loan' : 'lease'} payment for <strong>${email.aircraftName}</strong> is due.</p>
              
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                  <div><span style="color: var(--muted);">Monthly Payment:</span></div>
                  <div style="text-align: right; font-weight: 600;">${formatCurrency(email.monthlyPayment)}</div>
                  ${email.paymentType === 'loan' ? `
                    <div><span style="color: var(--muted);">Remaining Balance:</span></div>
                    <div style="text-align: right;">${formatCurrency(email.remainingBalance)}</div>
                    <div><span style="color: var(--muted);">Payments Remaining:</span></div>
                    <div style="text-align: right;">${email.paymentsRemaining}</div>
                  ` : `
                    <div><span style="color: var(--muted);">Months Remaining:</span></div>
                    <div style="text-align: right;">${email.monthsRemaining}</div>
                  `}
                  <div><span style="color: var(--muted);">Your Cash:</span></div>
                  <div style="text-align: right; color: ${canAfford ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(S.cash)}</div>
                </div>
              </div>
              
              ${!isPaid && !isSkipped ? `
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button class="btn primary" onclick="makeFinancingPayment('${email.id}')" ${!canAfford ? 'disabled' : ''} 
                          style="flex: 1; min-width: 120px; ${canAfford ? 'background: var(--success); border-color: var(--success);' : ''}">
                    ðŸ’µ Pay ${formatCurrency(email.monthlyPayment)}
                  </button>
                  ${email.paymentType === 'loan' ? `
                    <button class="btn" onclick="makeExtraPayment('${email.id}')" ${!canAfford ? 'disabled' : ''} style="flex: 1; min-width: 120px;">
                      âž• Pay Extra
                    </button>
                  ` : ''}
                  <button class="btn" onclick="skipPayment('${email.id}')" style="flex: 1; min-width: 100px; border-color: var(--danger); color: var(--danger);">
                    â­ Skip
                  </button>
                </div>
                ${!canAfford ? '<div style="margin-top: 8px; font-size: 11px; color: var(--danger);">Insufficient funds. Earn more or draw from LOC.</div>' : ''}
              ` : `
                <div style="margin-top: 8px;">
                  <button class="btn" onclick="deleteEmail('${email.id}')">Delete</button>
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      const aircraft = getAircraft(email.aircraftCode);
      
      if (!aircraft) {
        return `<div class="email-detail"><div style="color: var(--danger);">Error: Aircraft data not found for ${email.aircraftCode}</div></div>`;
      }
      
      if (email.type === "inquiry") {
        // Customer inquiry - player needs to bid
        // Support both snake_case and camelCase property names
        const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed;
        const fuelBurnRate = aircraft.fuel_burn_rate || aircraft.fuelBurnRate;
        const operatingCost = aircraft.operating_cost || aircraft.operatingCost;
        
        const rawTime = email.distance / cruiseSpeed;
        const estimatedTime = Math.max(1.0, rawTime).toFixed(1); // 1 hour minimum
        // Apply fuel and operating cost multipliers for accurate estimate display
        const fuelPrice = getEffectiveFuelPrice(aircraft.fuel_type);
        const effectiveOpCost = getEffectiveOperatingCost(aircraft);
        const fuelCost = Math.round((fuelBurnRate || 0) * estimatedTime * fuelPrice);
        const opCost = Math.round(effectiveOpCost * estimatedTime);
        const suggestedBid = Math.round((opCost + fuelCost) * 1.4); // 40% markup
        
        // Mission-specific opening lines - some are dynamic based on pax/cargo
        const paxText = email.passengers ? `${email.passengers} passenger${email.passengers > 1 ? 's' : ''}` : '';
        const cargoText = email.cargoLbs ? `${email.cargoLbs} lbs of cargo` : '';
        
        const missionOpenings = {
          "Discovery Flight": "I'm interested in booking a discovery flight to experience what flying is like.",
          "Sightseeing Tour": `We'd like to book a scenic flight over the local area${paxText ? ` for ${paxText}` : ''}.`,
          "Training Flight": "I'd like to schedule a training session in your aircraft.",
          "Charter Flight": `We need air transportation${paxText ? ` for ${paxText}` : ' for our party'}.`,
          "General Cargo": `We have ${cargoText || 'a shipment'} that needs air delivery.`,
          "Mail Run": `We have ${cargoText || 'mail and packages'} requiring air transport.`,
          "Aerial Photography": "We need aerial photography coverage of a target location.",
          "Aerial Survey": "We require an aerial survey of the area described below.",
          "Bush Resupply": `We need ${cargoText || 'supplies'} delivered to a remote airstrip.`,
          "Executive Transport": `Our team${paxText ? ` of ${paxText}` : ''} requires discrete air transportation.`,
          "Medical Transfer": "We have a patient requiring non-emergency air transport.",
          "Thrill Flight": "I'm looking to book an aerobatic experience flight.",
          "Heli Tour": `We'd like to book a helicopter sightseeing tour${paxText ? ` for ${paxText}` : ''}.`,
          "Heli Charter": `We need helicopter transportation${paxText ? ` for ${paxText}` : ''}.`,
          "Ferry Flight": "We need an aircraft repositioned between airports.",
          "Air Ambulance": "URGENT: We have a patient requiring emergency air transport.",
          "Organ Transport": "URGENT: Time-critical medical cargo requires immediate transport.",
          "CASEVAC": "URGENT: Casualty evacuation required from remote location.",
          "Heli EMS": "URGENT: Emergency medical response required.",
          "Heli SAR": "URGENT: Search and rescue operation assistance needed.",
          "Search Support": "We need aerial search support for an ongoing operation.",
          "Humanitarian": `We have ${cargoText || 'humanitarian supplies'} requiring air delivery.`,
          "Freight Haul": `We have ${cargoText || 'heavy cargo'} requiring air freight service.`,
          "Island Hopping": `We need transport${paxText ? ` for ${paxText}` : ''} between coastal/island destinations.`,
          "Hazmat Transport": `We have ${cargoText || 'hazardous materials'} requiring certified air transport.`,
          "Airshow Aerobatics": "We're looking for an aerobatic demonstration pilot.",
          "Airshow Rides": "We need a pilot for aerobatic passenger rides at our event.",
          "Historical Flight": "We'd like to book a warbird experience flight.",
          "Part 135 On-Demand": `We need on-demand charter service${paxText ? ` for ${paxText}` : ''}${cargoText ? ` with ${cargoText}` : ''}.`
        };
        
        const opening = missionOpenings[email.missionType] || `We need ${email.missionType} service.`;
        
        // Add minimum booking note if flight was extended to 1-hour minimum
        const minimumBookingNote = email.minimumBooking 
          ? ` We've booked a minimum 1-hour flight. After completing the primary objective, explore the surrounding area at your discretion.`
          : '';
        
        // Determine avionics requirement
        const ifrWeather = ['Overcast', 'Light Rain', 'Light Snow', 'Rain Showers', 'Thunderstorms', 'Heavy Snow', 'Fog'];
        const needsIFR = email.weather && ifrWeather.includes(email.weather);
        
        // Build professional email HTML
        let detailHtml = `
          <div class="email-detail" style="background: var(--panel);">
            <!-- Email Header -->
            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px; color: var(--text);">${email.from}</div>
                  <div style="font-size: 12px; color: var(--muted);">${email.company}</div>
                </div>
                <div style="text-align: right; font-size: 11px; color: var(--muted);">
                  ${formatGameTime(email.receivedAt)}
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 13px; color: var(--text);">
                <strong>Subject:</strong> ${email.subject || `${email.missionType} - ${email.fromName}`}
              </div>
            </div>
            
            <!-- Email Body -->
            <div style="padding: 16px; font-size: 13px; line-height: 1.6; color: var(--text);">
              <p style="margin: 0 0 12px 0;">Good ${getTimeOfDay()},</p>
              
              <p style="margin: 0 0 12px 0;">${opening}${minimumBookingNote}</p>
              
              <!-- Flight Details Box -->
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Flight Details</div>
                ${email.missionStructure === 'heli_scene' && email.sceneWaypoint ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">Base:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">Scene:</span>
                    <a href="https://www.google.com/maps?q=${email.sceneWaypoint.lat},${email.sceneWaypoint.lon}" target="_blank" style="font-family: monospace; color: var(--danger); text-decoration: none;">${email.sceneWaypoint.coordsDisplay} â†—</a>
                    <span style="color: var(--muted);">Hospital:</span>
                    <span style="color: var(--success);">${email.destinationName}</span>
                    <span style="color: var(--muted);">Total Distance:</span>
                    <span>${email.distance} nm</span>
                    <span style="color: var(--muted);">On-scene:</span>
                    <span>~${email.onSceneMinutes} minutes</span>
                    ${email.passengers ? `<span style="color: var(--muted);">Patients:</span><span>${email.passengers}</span>` : ''}
                  </div>
                  ${email.heliSceneAction ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                      <span style="color: var(--muted);">Mission Profile:</span> ${email.heliSceneAction}
                    </div>
                  ` : ''}
                ` : (email.missionStructure === 'heli_transfer') ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">From:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">To:</span>
                    <span>${email.destinationName} (${email.destinationIcao})</span>
                    <span style="color: var(--muted);">One-way:</span>
                    <span>${email.revenueDistance} nm</span>
                    <span style="color: var(--muted);">Round Trip:</span>
                    <span>${email.distance} nm (includes repositioning)</span>
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                  </div>
                  ${email.heliBriefing ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                      <span style="color: var(--muted);">Briefing:</span> ${email.heliBriefing}
                    </div>
                  ` : ''}
                ` : (email.missionStructure === 'heli_connect') ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">Pickup:</span>
                    <span>${email.originName} (${email.originIcao})</span>
                    <span style="color: var(--muted);">Dropoff:</span>
                    <span>${email.destinationName} (${email.destinationIcao})</span>
                    <span style="color: var(--muted);">Transport:</span>
                    <span>${email.revenueDistance} nm</span>
                    <span style="color: var(--muted);">Total:</span>
                    <span>${email.distance} nm (includes positioning)</span>
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                  </div>
                  ${email.heliBriefing ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                      <span style="color: var(--muted);">Briefing:</span> ${email.heliBriefing}
                    </div>
                  ` : ''}
                ` : (email.missionType === 'Sightseeing Tour' || email.missionType === 'Heli Tour' || email.missionType === 'Discovery Flight') && email.waypoint && email.waypoint.landmark ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">Departure:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">Destination:</span>
                    <a href="https://www.google.com/maps?q=${email.waypoint.lat},${email.waypoint.lon}" target="_blank" style="color: var(--accent); font-weight: 500; text-decoration: none;">${email.waypoint.landmark.name} â†—</a>
                    <span style="color: var(--muted);">Coordinates:</span>
                    <a href="https://www.google.com/maps?q=${email.waypoint.lat},${email.waypoint.lon}" target="_blank" style="font-family: monospace; color: var(--text); text-decoration: none;">${Number(email.waypoint.lat).toFixed(2)}Â°N, ${Math.abs(Number(email.waypoint.lon)).toFixed(2)}Â°W</a>
                    <span style="color: var(--muted);">Bearing:</span>
                    <span>${email.waypoint.bearing}Â° at ${email.waypoint.distance} nm</span>
                    <span style="color: var(--muted);">Round Trip:</span>
                    <span>${email.distance} nm</span>
                    <span style="color: var(--muted);">Duration:</span>
                    <span>Approximately ${Math.max(60, Math.round(email.distance / (cruiseSpeed || 120) * 60))} minutes</span>
                    ${email.waypoint.landmark.alt ? `<span style="color: var(--muted);">Terrain:</span><span>${email.waypoint.landmark.alt.toLocaleString()} ft MSL</span>` : ''}
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                  </div>
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                    <span style="color: var(--muted);">Highlight:</span> <span style="font-style: italic;">${email.waypoint.landmark.desc}</span>
                  </div>
                  ${email.waypointAction ? `
                    <div style="margin-top: 8px; font-size: 12px;">
                      <span style="color: var(--muted);">Flight Profile:</span> ${email.waypointAction}
                    </div>
                  ` : ''}
                ` : (email.missionType === 'Sightseeing Tour' || email.missionType === 'Heli Tour') ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">Departure:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">Duration:</span>
                    <span>Approximately ${Math.max(60, Math.round(email.distance / (cruiseSpeed || 120) * 60))} minutes</span>
                    <span style="color: var(--muted);">Total Distance:</span>
                    <span>${email.distance} nm (round trip)</span>
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                  </div>
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted); font-style: italic;">
                    Scenic highlights at pilot's discretion. Consider local terrain features, waterways, landmarks, and points of interest visible from altitude.
                  </div>
                ` : email.missionStructure === 'waypoint' && email.waypoint && email.waypoint.lat != null ? `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">Base:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">Target:</span>
                    <a href="https://www.google.com/maps?q=${email.waypoint.lat},${email.waypoint.lon}" target="_blank" style="font-family: monospace; color: var(--accent); text-decoration: none;">${Number(email.waypoint.lat).toFixed(2)}Â°N, ${Math.abs(Number(email.waypoint.lon)).toFixed(2)}Â°W â†—</a>
                    <span style="color: var(--muted);">Bearing/Distance:</span>
                    <span>${email.waypoint.bearing}Â° / ${email.waypoint.distance} nm</span>
                    <span style="color: var(--muted);">Total Distance:</span>
                    <span>${email.distance} nm (round trip)</span>
                    ${email.onSiteMinutes ? `
                      <span style="color: var(--muted);">On-site Time:</span>
                      <span>${email.onSiteMinutes} minutes</span>
                    ` : ''}
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                    ${email.cargoLbs ? `<span style="color: var(--muted);">Cargo:</span><span>${email.cargoLbs} lbs</span>` : ''}
                  </div>
                  ${email.waypointAction ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                      <span style="color: var(--muted);">Mission Profile:</span> ${email.waypointAction}
                    </div>
                  ` : ''}
                ` : `
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                    <span style="color: var(--muted);">From:</span>
                    <span>${email.fromName} (${email.fromIcao})</span>
                    <span style="color: var(--muted);">To:</span>
                    <span>${email.toName} (${email.toIcao})</span>
                    <span style="color: var(--muted);">Distance:</span>
                    <span>${email.revenueDistance || email.distance} nm</span>
                    ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                    ${email.cargoLbs ? `<span style="color: var(--muted);">Cargo:</span><span>${email.cargoLbs} lbs</span>` : ''}
                  </div>
                `}
              </div>
              
              <!-- Schedule Box -->
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Schedule</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <span style="color: var(--muted);">Departure:</span>
                  <span>${formatGameTime(email.startTime)}${email.isNight ? ' ðŸŒ™' : ''}</span>
                  <span style="color: var(--muted);">Weather:</span>
                  <span>${email.weather || 'VFR'}${needsIFR ? ' â˜ï¸' : ''}</span>
                  <span style="color: var(--muted);">Respond by:</span>
                  <span style="color: var(--warning);">${formatGameTime(email.scheduleBy)}</span>
                </div>
              </div>
              
              <p style="margin: 12px 0 0 0;">Please let me know your availability and rates.</p>
              
              <p style="margin: 12px 0 4px 0;">Best regards,</p>
              <p style="margin: 0; font-weight: 500;">${email.from}</p>
              ${email.from !== email.company ? `<p style="margin: 0; font-size: 12px; color: var(--muted);">${email.company}</p>` : ''}
            </div>
        `;
        
        // Build itinerary HTML for multi-leg missions
        let itineraryHtml = '';
        if (email.legs && email.legs.length > 1) {
          itineraryHtml = `
            <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Flight Itinerary</div>
              <div style="font-size: 12px;">
          `;
          email.legs.forEach((leg, idx) => {
            const legTypeLabel = {
              'positioning': 'âœˆï¸ Positioning',
              'revenue': 'ðŸ“¦ Revenue',
              'return': 'ðŸ  Return',
              'outbound': 'âž¡ï¸ Outbound',
              'ferry': 'ðŸ”„ Ferry',
              'activity': 'ðŸ“ On-site',
              'on_site': 'ðŸ“ On-site'
            }[leg.type] || leg.type;
            
            // Special handling for on_site legs (no from/to, just duration)
            if (leg.type === 'on_site' || leg.type === 'activity') {
              const durationText = leg.duration ? `${leg.duration} min` : '';
              itineraryHtml += `<div style="margin-bottom: 4px; color: var(--accent);">${idx + 1}. ${legTypeLabel}${durationText ? ` (${durationText})` : ''}</div>`;
            } else {
              const fromDisplay = leg.from || 'Base';
              const toDisplay = leg.to || 'Base';
              const distDisplay = leg.distance !== undefined ? `${leg.distance} nm` : '';
              const legStyle = leg.type === 'revenue' || leg.type === 'outbound' ? 'color: var(--success);' : 'color: var(--muted);';
              itineraryHtml += `<div style="margin-bottom: 4px; ${legStyle}">${idx + 1}. ${legTypeLabel}: ${fromDisplay} â†’ ${toDisplay} ${distDisplay ? `(${distDisplay})` : ''}</div>`;
            }
          });
          itineraryHtml += `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px;">
                  <strong>Total:</strong> ${email.distance} nm
                  ${email.revenueDistance && email.revenueDistance !== email.distance ? ` â€¢ <strong>Revenue:</strong> ${email.revenueDistance} nm` : ''}
                </div>
              </div>
            </div>
          `;
        }
        
        if (email.status === "pending") {
          // Check if fixed price mode is enabled
          const fixedPriceMode = S.difficultySettings?.fixedPriceMode;
          
          if (fixedPriceMode) {
            // Fixed price mode - show market rate, accept or decline
            const marketRate = calculateMarketRate(email, aircraft);
            detailHtml += `
              <!-- Fixed Price Section -->
              <div style="padding: 16px; border-top: 1px solid var(--border); background: var(--bg);">
                <div style="font-weight: 600; margin-bottom: 12px;">Contract Offer</div>
                ${itineraryHtml}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div style="background: var(--panel); padding: 12px; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px;">Aircraft</div>
                    <div style="font-size: 13px; font-weight: 500;">${aircraft.name}</div>
                  </div>
                  <div style="background: var(--panel); padding: 12px; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px;">Est. Flight Time</div>
                    <div style="font-size: 13px; font-weight: 500;">${estimatedTime} hours</div>
                  </div>
                </div>
                <div style="background: var(--panel); padding: 16px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid var(--success);">
                  <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px;">Contract Value</div>
                  <div style="font-size: 24px; font-weight: 600; color: var(--success);">${formatCurrency(marketRate.rate)}</div>
                </div>
                <div style="display: flex; gap: 12px;">
                  <button class="btn primary" onclick="acceptFixedPriceContract('${email.id}', ${marketRate.rate})" style="flex: 1; padding: 12px;">Accept Contract</button>
                  <button class="btn" onclick="deleteEmail('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Decline</button>
                </div>
              </div>
            `;
          } else {
            // Full bid calculator mode - calculate preview costs
            const costs = calculateCostBreakdown(email, aircraft);
            const marketRate = calculateMarketRate(email, aircraft);
            const potentialProfit = marketRate.rate - costs.totalCost;
            const marginPct = marketRate.rate > 0 ? Math.round((potentialProfit / marketRate.rate) * 100) : 0;
            const profitColor = potentialProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            detailHtml += `
              <!-- Bid Section -->
              <div style="padding: 16px; border-top: 1px solid var(--border); background: var(--bg);">
                <div style="font-weight: 600; margin-bottom: 12px;">Your Response</div>
                ${itineraryHtml}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div style="background: var(--panel); padding: 12px; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px;">Aircraft</div>
                    <div style="font-size: 13px; font-weight: 500;">${aircraft.name}</div>
                    <div style="font-size: 11px; color: var(--muted);">${aircraft.avionics || 'VFR'} equipped</div>
                  </div>
                  <div style="background: var(--panel); padding: 12px; border-radius: 6px;">
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px;">Est. Flight Time</div>
                    <div style="font-size: 13px; font-weight: 500;">${estimatedTime} hours</div>
                    <div style="font-size: 11px; color: var(--muted);">at ${cruiseSpeed} kts cruise</div>
                  </div>
                </div>
                
                <!-- Financial Preview -->
                <div style="background: var(--panel); padding: 12px; border-radius: 6px; margin-bottom: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                  <div>
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 2px;">Est. Costs</div>
                    <div style="font-size: 14px; font-weight: 600;">~${formatCurrency(costs.totalCost)}</div>
                  </div>
                  <div>
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 2px;">Market Rate</div>
                    <div style="font-size: 14px; font-weight: 600;">~${formatCurrency(marketRate.rate)}</div>
                  </div>
                  <div>
                    <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 2px;">Potential</div>
                    <div style="font-size: 14px; font-weight: 600; color: ${profitColor};">${potentialProfit >= 0 ? '+' : ''}${formatCurrency(potentialProfit)} (${marginPct}%)</div>
                  </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                  <button class="btn primary" onclick="openBidCalculator('${email.id}')" style="flex: 1; padding: 12px;">Open Quote Calculator</button>
                  <button class="btn" onclick="deleteEmail('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Decline</button>
                </div>
              </div>
            `;
          }
        } else if (email.status === "bid_sent") {
          detailHtml += `
            <div style="padding: 16px; border-top: 1px solid var(--border); background: rgba(245, 158, 11, 0.05);">
              <div style="display: flex; align-items: center; gap: 8px; color: var(--warning);">
                <span style="font-size: 18px;">â³</span>
                <span style="font-weight: 600;">Quote Pending</span>
              </div>
              <div style="margin-top: 8px; font-size: 13px; color: var(--muted);">Your quote: ${formatCurrency(email.playerBid)}</div>
            </div>
          `;
        } else if (email.status === "counter_offer") {
          // Counter-offer from client
          detailHtml += `
            <div style="padding: 16px; border-top: 1px solid var(--border); background: rgba(210, 153, 34, 0.1);">
              <div class="counter-offer-box" style="background: transparent; border: none; padding: 0;">
                <div class="counter-offer-header">
                  <span style="font-size: 18px;">ðŸ’¬</span>
                  <span>Counter-Offer Received</span>
                </div>
                <div class="counter-offer-amount">${formatCurrency(email.counterOffer)}</div>
                <div class="counter-offer-message">${email.customerResponse}</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">Your original quote: ${formatCurrency(email.playerBid)}</div>
                <div class="counter-offer-actions">
                  <button class="btn primary" onclick="acceptCounterOffer('${email.id}')">Accept ${formatCurrency(email.counterOffer)}</button>
                  <button class="btn" onclick="openBidCalculator('${email.id}')" style="border-color: var(--accent); color: var(--accent);">Re-bid</button>
                  <button class="btn" onclick="rejectCounterOffer('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Decline</button>
                </div>
              </div>
            </div>
          `;
        } else if (email.status === "accepted") {
          const crewRequired = getCrewRequired(email.aircraftCode);
          const aircraft = getAircraft(email.aircraftCode);
          const flightHours = email.distance / (aircraft?.cruise_speed || 120);
          const crewCheck = checkCrewAvailability(email.aircraftCode, false, email.startTime, flightHours);
          const hasStaffPilots = getStaffByRole('pilot').length > 0;
          
          let crewWarning = '';
          if (crewRequired > 1) {
            crewWarning = `<div style="font-size: 11px; color: var(--warning); margin-top: 4px;">âš ï¸ This aircraft requires ${crewRequired} pilots</div>`;
          }
          
          let staffButton = '';
          if (hasStaffPilots) {
            if (crewCheck.canFly) {
              staffButton = `<button class="btn" onclick="openCrewAssignment('${email.id}')" style="flex: 1; padding: 12px;">Assign to Staff</button>`;
            } else {
              staffButton = `<button class="btn" disabled style="flex: 1; padding: 12px; opacity: 0.5;" title="Need ${crewCheck.staffNeeded} qualified pilot(s), have ${crewCheck.availableCount}">Assign to Staff</button>`;
            }
          }
          
          detailHtml += `
            <div style="padding: 16px; border-top: 1px solid var(--border); background: rgba(34, 197, 94, 0.05);">
              <div style="display: flex; align-items: center; gap: 8px; color: var(--success);">
                <span style="font-size: 18px;">âœ“</span>
                <span style="font-weight: 600;">Quote Accepted</span>
              </div>
              <div style="margin-top: 8px; font-size: 13px;">Contract value: ${formatCurrency(email.playerBid)}</div>
              ${crewWarning}
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn primary" onclick="openFlightOptions('${email.id}')" style="flex: 1; padding: 12px;">Fly This Mission</button>
                ${staffButton}
              </div>
              <button class="btn" onclick="withdrawBid('${email.id}')" style="width: 100%; margin-top: 8px; border-color: var(--warning); color: var(--warning); padding: 8px; font-size: 11px;">Withdraw Contract</button>
            </div>
          `;
        } else if (email.status === "declined") {
          detailHtml += `
            <div style="padding: 16px; border-top: 1px solid var(--border); background: rgba(239, 68, 68, 0.05);">
              <div style="display: flex; align-items: center; gap: 8px; color: var(--danger);">
                <span style="font-size: 18px;">âœ—</span>
                <span style="font-weight: 600;">Quote Declined</span>
              </div>
              <div style="margin-top: 8px; font-size: 13px; color: var(--muted);">${email.customerResponse || 'Customer chose another provider.'}</div>
              <button class="btn" onclick="deleteEmail('${email.id}')" style="margin-top: 12px; border-color: var(--danger); color: var(--danger);">Remove</button>
            </div>
          `;
        } else if (email.status === "staff_dispatched") {
          const staffMission = S.staffMissions.find(m => m.emailId === email.id);
          const crewNames = staffMission?.crew?.map(c => c.name).join(' & ') || 'Staff';
          const eta = staffMission?.estimatedCompletion ? formatGameTime(staffMission.estimatedCompletion) : 'In progress';
          
          detailHtml += `
            <div style="padding: 16px; border-top: 1px solid var(--border); background: rgba(59, 130, 246, 0.05);">
              <div style="display: flex; align-items: center; gap: 8px; color: var(--accent);">
                <span style="font-size: 18px;">âœˆï¸</span>
                <span style="font-weight: 600;">Staff Flying</span>
              </div>
              <div style="margin-top: 8px; font-size: 13px;">
                <div><strong>Crew:</strong> ${crewNames}</div>
                <div><strong>ETA:</strong> ${eta}</div>
                <div><strong>Revenue:</strong> ${formatCurrency(email.playerBid)}</div>
              </div>
              <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
                Mission will complete automatically during time advance.
              </div>
            </div>
          `;
        }
        
        detailHtml += '</div>';
        return detailHtml;
        
      } else {
        // Contract pilot offer - pre-priced
        const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed || 120;
        const rawTime = email.distance / cruiseSpeed;
        const estimatedTime = Math.max(1.0, rawTime).toFixed(1); // 1 hour minimum
        const ifrWeather = ['Overcast', 'Light Rain', 'Light Snow', 'Rain Showers', 'Thunderstorms', 'Heavy Snow', 'Fog'];
        const needsIFR = email.weather && ifrWeather.includes(email.weather);
        
        return `
          <div class="email-detail" style="background: var(--panel);">
            <!-- Email Header -->
            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-weight: 600; font-size: 14px; color: var(--text);">${email.company}</div>
                  <div style="font-size: 12px; color: var(--muted);">Contract Pilot Request</div>
                </div>
                <div style="text-align: right; font-size: 11px; color: var(--muted);">
                  ${formatGameTime(email.receivedAt)}
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 13px; color: var(--text);">
                <strong>Subject:</strong> Contract Pilot - ${email.missionType}
              </div>
            </div>
            
            <!-- Email Body -->
            <div style="padding: 16px; font-size: 13px; line-height: 1.6; color: var(--text);">
              <p style="margin: 0 0 12px 0;">Good ${getTimeOfDay()},</p>
              
              <p style="margin: 0 0 12px 0;">We are seeking a contract pilot to fly our ${aircraft.name} for a ${email.missionType} assignment.</p>
              
              <!-- Flight Details Box -->
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Flight Details</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <span style="color: var(--muted);">Route:</span>
                  ${email.missionStructure === 'heli_scene' && email.sceneWaypoint ? `
                    <span>${email.fromName} â†’ Scene (${email.sceneWaypoint.coordsDisplay}) â†’ ${email.destinationName}</span>
                  ` : email.missionStructure === 'heli_transfer' ? `
                    <span>${email.fromName} (${email.fromIcao}) â†’ ${email.destinationName} (${email.destinationIcao})</span>
                  ` : email.missionStructure === 'heli_connect' ? `
                    <span>${email.originName} â†’ ${email.destinationName}</span>
                  ` : email.missionStructure === 'waypoint' && email.waypoint ? `
                    ${email.waypoint.landmark?.isTour ? `
                      <span>${email.fromName} (${email.fromIcao}) â†’ ${email.waypoint.landmark.name}</span>
                    ` : email.waypoint.landmark?.name ? `
                      <span>${email.fromName} (${email.fromIcao}) â†’ ${email.waypoint.landmark.name}</span>
                    ` : `
                      <span>${email.fromName} (${email.fromIcao}) â†’ Waypoint (${email.waypoint.bearing}Â°/${email.waypoint.distance}nm)</span>
                    `}
                  ` : `
                    <span>${email.fromName} (${email.fromIcao}) â†’ ${email.toName} (${email.toIcao})</span>
                  `}
                  <span style="color: var(--muted);">Distance:</span>
                  <span>${email.distance} nm</span>
                  <span style="color: var(--muted);">Est. Flight Time:</span>
                  <span>${estimatedTime} hours</span>
                  ${email.passengers ? `<span style="color: var(--muted);">Passengers:</span><span>${email.passengers}</span>` : ''}
                  ${email.cargoLbs ? `<span style="color: var(--muted);">Cargo:</span><span>${email.cargoLbs} lbs</span>` : ''}
                </div>
                ${email.heliSceneAction ? `
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                    <span style="color: var(--muted); font-size: 11px;">Mission Profile:</span>
                    <div style="font-size: 12px; margin-top: 4px;">${email.heliSceneAction}</div>
                  </div>
                ` : email.heliBriefing ? `
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                    <span style="color: var(--muted); font-size: 11px;">Briefing:</span>
                    <div style="font-size: 12px; margin-top: 4px;">${email.heliBriefing}</div>
                  </div>
                ` : email.waypointAction ? `
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                    <span style="color: var(--muted); font-size: 11px;">Flight Profile:</span>
                    <div style="font-size: 12px; margin-top: 4px;">${email.waypointAction}</div>
                  </div>
                ` : ''}
              </div>
              
              <!-- Schedule & Conditions -->
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="font-weight: 600; font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Schedule</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <span style="color: var(--muted);">Departure:</span>
                  <span>${formatGameTime(email.startTime)}${email.isNight ? ' ðŸŒ™' : ''}</span>
                  <span style="color: var(--muted);">Weather:</span>
                  <span>${email.weather || 'VFR'}${needsIFR ? ' â˜ï¸' : ''}</span>
                  <span style="color: var(--muted);">Respond by:</span>
                  <span style="color: var(--warning);">${formatGameTime(email.scheduleBy)}</span>
                </div>
              </div>
              
              <!-- Compensation -->
              <div style="background: rgba(34, 197, 94, 0.08); border: 1px solid var(--success); border-radius: 6px; padding: 12px; margin: 12px 0;">
                <div style="font-weight: 600; font-size: 12px; color: var(--success); margin-bottom: 8px; text-transform: uppercase;">Compensation</div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 12px;">
                  <span style="color: var(--muted);">Rate:</span>
                  <span style="font-weight: 500;">${formatCurrency(applyRevenueMultiplier(email.contractRate, true))}/hour</span>
                  <span style="color: var(--muted);">Estimated Payment:</span>
                  <span style="font-weight: 600; color: var(--success);">${formatCurrency(applyRevenueMultiplier(email.payment, true))}</span>
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Aircraft and fuel provided by operator.</div>
              </div>
              
              <p style="margin: 12px 0 0 0;">Please confirm your availability.</p>
              
              <p style="margin: 12px 0 4px 0;">Best regards,</p>
              <p style="margin: 0; font-weight: 500;">${email.company}</p>
            </div>
            
            ${email.status === "pending" ? `
              <!-- Action Buttons -->
              <div style="padding: 16px; border-top: 1px solid var(--border); background: var(--bg);">
                <div style="display: flex; gap: 12px;">
                  <button class="btn primary" onclick="acceptEmailContract('${email.id}')" style="flex: 1; padding: 12px;">Accept Contract</button>
                  <button class="btn" onclick="deleteEmail('${email.id}')" style="border-color: var(--danger); color: var(--danger);">Decline</button>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
    }
    
    function getTimeOfDay() {
      const hour = S.gameTime.hour;
      if (hour < 12) return "morning";
      if (hour < 17) return "afternoon";
      return "evening";
    }
    
    function selectEmail(emailId) {
      // Toggle: if already selected, deselect (close)
      if (S.selectedEmailId === emailId) {
        S.selectedEmailId = null;
      } else {
        S.selectedEmailId = emailId;
      }
      saveState();
      render();
    }
    
    function deleteEmail(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (email && email.type === 'checkride') {
        alert('Checkride emails cannot be deleted. Complete or fail the checkride to remove this email.');
        return;
      }
      // training-flight type is no longer used, but keep check for safety
      if (email && email.type === 'training-flight') {
        alert('Training flight emails cannot be deleted.');
        return;
      }
      // tutorial-welcome can now be dismissed since it's just informational
      S.emails = S.emails.filter(e => e.id !== emailId);
      S.selectedEmailId = null;
      saveState();
      render();
    }
    
    function withdrawBid(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      if (confirm('Withdraw your accepted bid? The customer will be notified and this opportunity will be lost.')) {
        // Remove the email (contract cancelled)
        S.emails = S.emails.filter(e => e.id !== emailId);
        S.selectedEmailId = null;
        saveState();
        render();
        alert('Bid withdrawn. The customer has been notified.');
      }
    }
    window.withdrawBid = withdrawBid;
    
    // Open flight options - check for two-crew requirement
    function openFlightOptions(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      // Check if player has required certifications for this aircraft
      console.log('openFlightOptions - checking certs for:', email.aircraftCode);
      console.log('Player certs:', S.pilot.certificates, 'ratings:', S.pilot.ratings);
      const missingReqs = getMissingRequirements(email.aircraftCode);
      console.log('Missing requirements:', missingReqs);
      
      if (missingReqs) {
        const missingCerts = missingReqs.certificates?.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ') || '';
        const missingRatings = missingReqs.ratings?.map(r => getRatingDisplayName(r)).join(', ') || '';
        let msg = 'âš ï¸ You are not certified to fly this aircraft.\n\n';
        if (missingCerts) msg += `Missing certificates: ${missingCerts}\n`;
        if (missingRatings) msg += `Missing ratings: ${missingRatings}\n`;
        msg += '\nComplete the required training first, or assign this mission to a qualified staff pilot.';
        alert(msg);
        return;
      }
      
      const crewRequired = getCrewRequired(email.aircraftCode);
      
      if (crewRequired > 1) {
        // Need SIC - check availability
        const aircraft = getAircraft(email.aircraftCode);
        const flightHours = email.distance / (aircraft?.cruise_speed || 120);
        const crewCheck = checkCrewAvailability(email.aircraftCode, true, email.startTime, flightHours);
        
        if (!crewCheck.canFly) {
          alert(`âš ï¸ This aircraft requires ${crewRequired} pilots.\n\nYou need ${crewCheck.staffNeeded} staff pilot(s) as SIC, but only ${crewCheck.availableCount} qualified pilot(s) available.\n\nHire more pilots or wait for current pilots to become available.`);
          return;
        }
        
        // Open SIC selection modal
        openSicAssignment(emailId);
      } else {
        // Single pilot - go straight to schedule
        acceptEmailContract(emailId);
      }
    }
    window.openFlightOptions = openFlightOptions;
    
    // Open SIC assignment for player-flown two-crew aircraft
    function openSicAssignment(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const aircraft = getAircraft(email.aircraftCode);
      const crewRequired = getCrewRequired(email.aircraftCode);
      const sicPilots = getQualifiedSICPilots(email.aircraftCode);  // SIC-qualified (lower reqs)
      const autoAssigned = autoAssignCrew(email.aircraftCode, true);
      
      let pilotsHtml = '';
      for (const pilot of sicPilots) {
        const isSelected = autoAssigned.sic?.id === pilot.id;
        const hoursLeft = 8 - (pilot.pilot?.hoursToday || 0);
        const canBePIC = canPilotBePIC(pilot, email.aircraftCode);
        const qualNote = canBePIC ? 'âœ“ PIC qualified' : 'SIC only';
        pilotsHtml += `
          <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border: 1px solid ${isSelected ? 'var(--accent)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
            <input type="radio" name="sicPilot" value="${pilot.id}" ${isSelected ? 'checked' : ''} style="accent-color: var(--accent);">
            <div style="flex: 1;">
              <div style="font-weight: 500;">${pilot.name}</div>
              <div style="font-size: 11px; color: var(--muted);">${pilot.experienceLevel.charAt(0).toUpperCase() + pilot.experienceLevel.slice(1)} â€¢ Skill: ${pilot.skill} â€¢ ${hoursLeft.toFixed(1)} hrs available today</div>
              <div style="font-size: 10px; color: ${canBePIC ? 'var(--success)' : 'var(--warning)'};">${qualNote}</div>
            </div>
          </label>
        `;
      }
      
      const modalHtml = `
        <div class="modal-overlay open" id="sicAssignmentModal" onclick="if(event.target === this) closeSicAssignment()">
          <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
              <h3>Assign Second-in-Command</h3>
              <button class="modal-close" onclick="closeSicAssignment()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Aircraft</div>
                <div style="font-weight: 600;">${aircraft?.name || email.aircraftCode}</div>
                <div style="font-size: 11px; color: var(--warning); margin-top: 4px;">Requires ${crewRequired} pilots</div>
              </div>
              
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">You (PIC) + Select SIC:</div>
              <div id="sicPilotList">
                ${pilotsHtml || '<div style="color: var(--muted); padding: 12px;">No qualified pilots available</div>'}
              </div>
            </div>
            <div class="modal-footer" style="padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
              <button class="btn" onclick="closeSicAssignment()" style="flex: 1;">Cancel</button>
              <button class="btn primary" onclick="confirmSicAndSchedule('${emailId}')" style="flex: 1;" ${sicPilots.length === 0 ? 'disabled' : ''}>Schedule Flight</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.openSicAssignment = openSicAssignment;
    
    function closeSicAssignment() {
      const modal = document.getElementById('sicAssignmentModal');
      if (modal) modal.remove();
    }
    window.closeSicAssignment = closeSicAssignment;
    
    function confirmSicAndSchedule(emailId) {
      const selectedRadio = document.querySelector('input[name="sicPilot"]:checked');
      if (!selectedRadio) {
        alert('Please select a pilot for SIC');
        return;
      }
      
      const sicId = selectedRadio.value;
      const sic = S.staff.find(s => s.id === sicId);
      
      if (!sic) {
        alert('Selected pilot not found');
        return;
      }
      
      // Store SIC assignment on the email for flight processing
      const email = S.emails.find(e => e.id === emailId);
      if (email) {
        email.assignedSic = { id: sic.id, name: sic.name };
      }
      
      closeSicAssignment();
      acceptEmailContract(emailId);
    }
    window.confirmSicAndSchedule = confirmSicAndSchedule;
    
    // Open full crew assignment for staff-flown missions
    function openCrewAssignment(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const aircraft = getAircraft(email.aircraftCode);
      const crewRequired = getCrewRequired(email.aircraftCode);
      const picPilots = getQualifiedPilots(email.aircraftCode);  // PIC-qualified
      const sicPilots = getQualifiedSICPilots(email.aircraftCode);  // SIC-qualified (lower reqs)
      const autoAssigned = autoAssignCrew(email.aircraftCode, false);
      
      // Build PIC selection HTML (only PIC-qualified pilots)
      let picHtml = '<option value="">-- Select PIC --</option>';
      for (const pilot of picPilots) {
        const hoursLeft = 8 - (pilot.pilot?.hoursToday || 0);
        const optionText = `${pilot.name} (${pilot.experienceLevel}, Skill: ${pilot.skill}, ${hoursLeft.toFixed(1)}hrs left)`;
        const isPicSelected = autoAssigned.pic?.id === pilot.id;
        picHtml += `<option value="${pilot.id}" ${isPicSelected ? 'selected' : ''}>${optionText}</option>`;
      }
      
      // Build SIC selection HTML (all SIC-qualified pilots)
      let sicHtml = '<option value="">-- Select SIC --</option>';
      for (const pilot of sicPilots) {
        const hoursLeft = 8 - (pilot.pilot?.hoursToday || 0);
        const canBePIC = canPilotBePIC(pilot, email.aircraftCode);
        const qualNote = canBePIC ? '' : ' [SIC only]';
        const optionText = `${pilot.name} (${pilot.experienceLevel}, Skill: ${pilot.skill}, ${hoursLeft.toFixed(1)}hrs left)${qualNote}`;
        const isSicSelected = autoAssigned.sic?.id === pilot.id;
        sicHtml += `<option value="${pilot.id}" ${isSicSelected ? 'selected' : ''}>${optionText}</option>`;
      }
      
      const flightHours = email.distance / (aircraft?.cruise_speed || 120);
      
      const modalHtml = `
        <div class="modal-overlay open" id="crewAssignmentModal" onclick="if(event.target === this) closeCrewAssignment()">
          <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
              <h3>Assign Crew</h3>
              <button class="modal-close" onclick="closeCrewAssignment()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
              <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <div>
                    <div style="font-size: 12px; color: var(--muted);">Aircraft</div>
                    <div style="font-weight: 600;">${aircraft?.name || email.aircraftCode}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 12px; color: var(--muted);">Crew Required</div>
                    <div style="font-weight: 600;">${crewRequired} pilot${crewRequired > 1 ? 's' : ''}</div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted);">
                  <span>${email.fromIcao} â†’ ${email.toIcao}</span>
                  <span>~${flightHours.toFixed(1)} hrs</span>
                </div>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">
                  Pilot in Command (PIC)
                </label>
                <div style="display: flex; gap: 8px;">
                  <select id="crewPic" style="flex: 1; padding: 10px; border-radius: 6px; background: var(--bg); border: 1px solid var(--border); color: var(--text);">
                    ${picHtml}
                  </select>
                  <button class="btn" onclick="autoAssignPic('${emailId}')" style="padding: 10px 12px; font-size: 11px;">Auto</button>
                </div>
              </div>
              
              ${crewRequired > 1 ? `
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">
                  Second in Command (SIC)
                </label>
                <div style="display: flex; gap: 8px;">
                  <select id="crewSic" style="flex: 1; padding: 10px; border-radius: 6px; background: var(--bg); border: 1px solid var(--border); color: var(--text);">
                    ${sicHtml}
                  </select>
                  <button class="btn" onclick="autoAssignSic('${emailId}')" style="padding: 10px 12px; font-size: 11px;">Auto</button>
                </div>
              </div>
              ` : ''}
              
              <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; font-size: 12px;">
                <div style="font-weight: 500; margin-bottom: 4px;">ðŸ“‹ Mission Summary</div>
                <div style="color: var(--muted);">
                  Revenue: ${formatCurrency(email.playerBid)}<br>
                  The assigned crew will fly this mission during time advance.
                </div>
              </div>
            </div>
            <div class="modal-footer" style="padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
              <button class="btn" onclick="closeCrewAssignment()" style="flex: 1;">Cancel</button>
              <button class="btn primary" onclick="dispatchMission('${emailId}')" style="flex: 1;">Dispatch Mission</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.openCrewAssignment = openCrewAssignment;
    
    function closeCrewAssignment() {
      const modal = document.getElementById('crewAssignmentModal');
      if (modal) modal.remove();
    }
    window.closeCrewAssignment = closeCrewAssignment;
    
    function autoAssignPic(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const autoAssigned = autoAssignCrew(email.aircraftCode, false);
      if (autoAssigned.pic) {
        document.getElementById('crewPic').value = autoAssigned.pic.id;
      }
    }
    window.autoAssignPic = autoAssignPic;
    
    function autoAssignSic(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const autoAssigned = autoAssignCrew(email.aircraftCode, false);
      if (autoAssigned.sic) {
        document.getElementById('crewSic').value = autoAssigned.sic.id;
      }
    }
    window.autoAssignSic = autoAssignSic;
    
    function dispatchMission(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const crewRequired = getCrewRequired(email.aircraftCode);
      const picId = document.getElementById('crewPic')?.value;
      const sicId = crewRequired > 1 ? document.getElementById('crewSic')?.value : null;
      
      if (!picId) {
        alert('Please select a Pilot in Command');
        return;
      }
      
      if (crewRequired > 1 && !sicId) {
        alert('Please select a Second in Command');
        return;
      }
      
      if (crewRequired > 1 && picId === sicId) {
        alert('PIC and SIC must be different pilots');
        return;
      }
      
      // Build crew array
      const crew = [];
      const pic = S.staff.find(s => s.id === picId);
      if (pic) crew.push(pic);
      
      if (sicId) {
        const sic = S.staff.find(s => s.id === sicId);
        if (sic) crew.push(sic);
      }
      
      // Dispatch the mission
      const result = dispatchStaffMission(emailId, crew);
      
      if (result.success) {
        closeCrewAssignment();
        render();
        showToast(`Mission dispatched! ${crew.map(c => c.name).join(' & ')} will fly ${email.fromIcao} â†’ ${email.toIcao}`, 'success');
      } else {
        alert(`Failed to dispatch: ${result.error}`);
      }
    }
    window.dispatchMission = dispatchMission;

    function submitBid(emailId) {
      // Legacy function - redirect to calculator
      openBidCalculator(emailId);
    }
    
    // Accept fixed price contract (simplified mode)
    function acceptFixedPriceContract(emailId, price) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      email.playerBid = price;
      email.status = 'accepted';
      email.customerResponse = 'Contract confirmed at the agreed rate.';
      
      saveState();
      render();
      showToast('Contract accepted! Schedule your flight.', 'success');
    }
    
    // Accept counter-offer from client
    function acceptCounterOffer(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email || !email.counterOffer) return;
      
      email.playerBid = email.counterOffer;
      email.status = 'accepted';
      email.customerResponse = "Great, we have a deal! Looking forward to working with you.";
      
      saveState();
      render();
      showToast('Counter-offer accepted!', 'success');
    }
    
    // Reject counter-offer
    function rejectCounterOffer(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      email.status = 'declined';
      email.customerResponse = 'Unable to reach agreement on pricing.';
      
      saveState();
      render();
      showToast('Counter-offer declined', 'info');
    }
    
    function acceptEmailContract(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const aircraft = getAircraft(email.aircraftCode);
      
      // Check for schedule conflicts
      const conflict = checkScheduleConflict(email.startTime, email.distance, aircraft?.cruise_speed || 120);
      if (conflict) {
        if (!confirm(`âš ï¸ Schedule Conflict Detected\n\nThis flight overlaps with: ${conflict.missionType}\nScheduled: ${formatGameTime(conflict.startTime)}\n\nSchedule anyway?`)) {
          return;
        }
      }
      
      // Create scheduled flight - copy all relevant fields from email
      const scheduledFlight = {
        contractId: email.id,
        contract: {
          id: email.id,
          aircraftCode: email.aircraftCode,
          aircraftName: email.aircraftName,
          contractType: email.type === "inquiry" ? "owned" : "contract",
          missionType: email.missionType,
          missionStructure: email.missionStructure,
          from: email.fromIcao,
          fromName: email.fromName,
          to: email.toIcao,
          toName: email.toName,
          distance: email.distance,
          revenueDistance: email.revenueDistance,
          payment: email.type === "inquiry" ? email.playerBid : email.payment,
          contractRate: email.contractRate || null,
          startTime: email.startTime,
          scheduleBy: email.scheduleBy,
          weather: email.weather,
          isNight: email.isNight,
          passengers: email.passengers || 0,
          cargoLbs: email.cargoLbs || 0,
          legs: email.legs || null,
          waypoint: email.waypoint || null,
          waypointAction: email.waypointAction || null,
          onSiteMinutes: email.onSiteMinutes || null,
          acceptedAt: { ...S.gameTime }
        }
      };
      
      S.scheduledFlights.push(scheduledFlight);
      
      // Remove email from inbox
      S.emails = S.emails.filter(e => e.id !== emailId);
      S.selectedEmailId = null;
      
      saveState();
      render();
      switchTab('calendar');
      
      alert(`Flight scheduled!\n\nCheck your calendar to see the scheduled flight.`);
    }
    
    function checkScheduleConflict(newStartTime, distance, cruiseSpeed) {
      // Estimate flight duration in minutes (with buffer)
      const flightMinutes = Math.ceil((distance / cruiseSpeed) * 60) + 30; // 30 min buffer
      
      // Convert newStartTime to comparable format
      const newStart = new Date(newStartTime.year, newStartTime.month - 1, newStartTime.day, newStartTime.hour, newStartTime.minute);
      const newEnd = new Date(newStart.getTime() + flightMinutes * 60000);
      
      for (const flight of S.scheduledFlights) {
        const contract = flight.contract;
        const existingStart = new Date(contract.startTime.year, contract.startTime.month - 1, contract.startTime.day, contract.startTime.hour, contract.startTime.minute);
        
        // Estimate existing flight duration
        const existingSpeed = getAircraft(contract.aircraftCode)?.cruise_speed || 120;
        const existingMinutes = Math.ceil((contract.distance / existingSpeed) * 60) + 30;
        const existingEnd = new Date(existingStart.getTime() + existingMinutes * 60000);
        
        // Check for overlap
        if (newStart < existingEnd && newEnd > existingStart) {
          return {
            missionType: contract.missionType,
            startTime: contract.startTime
          };
        }
      }
      
      return null; // No conflict
    }
    
    function acceptTutorialFlight(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      // Create scheduled flight for tutorial
      const scheduledFlight = {
        contractId: email.id,
        isTutorial: true,
        contract: {
          id: email.id,
          aircraftCode: email.aircraftCode,
          aircraftName: email.aircraftName,
          contractType: 'tutorial',
          missionType: email.missionType,
          missionStructure: 'round_trip',
          from: email.fromIcao,
          fromName: email.fromName,
          to: email.toIcao,
          toName: email.toName,
          distance: email.distance,
          revenueDistance: email.distance,
          payment: 0, // Tutorial is free
          startTime: email.startTime,
          scheduleBy: email.scheduleBy,
          weather: email.weather,
          isNight: false,
          passengers: 0,
          cargoLbs: 0,
          acceptedAt: { ...S.gameTime }
        }
      };
      
      S.scheduledFlights.push(scheduledFlight);
      
      // Remove email from inbox
      S.emails = S.emails.filter(e => e.id !== emailId);
      S.selectedEmailId = null;
      
      saveState();
      render();
      switchTab('calendar');
      
      alert(`Tutorial flight scheduled!\n\nThis is your final training flight. Complete it in your flight simulator, then return here to file your post-flight report.\n\nAfter that, you'll be ready for your Private Pilot checkride!`);
    }
    window.acceptTutorialFlight = acceptTutorialFlight;

    function renderFleet() {
      const container = document.getElementById('fleetList');
      
      // Header with add aircraft button
      let header = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <div style="font-size: 13px; color: var(--muted);">Fleet: ${S.fleet.length} aircraft</div>
          </div>
          <div style="display: flex; gap: 8px;">
            ${S.gameMode === 'sandbox' ? `<button class="btn" onclick="openAircraftBrowser('sandbox')">+ Add Aircraft (Free)</button>` : ''}

          </div>
        </div>
      `;
      
      if (S.fleet.length === 0) {
        container.innerHTML = header + '<div class="empty-state">No aircraft owned. Use the button above to add aircraft to your fleet.</div>';
        return;
      }
      
      container.innerHTML = header + '<div class="aircraft-grid">' + S.fleet.map(code => {
        const aircraft = getAircraft(code);
        if (!aircraft) return '';
        
        // Initialize fleetData if not present (for older saves)
        if (!S.fleetData[code]) {
          S.fleetData[code] = {
            currentFuel: aircraft.fuel_capacity,
            condition: 100,
            hours: 0
          };
        }
        
        // Ensure year exists
        if (!S.fleetData[code].year) {
          const prodYears = AIRCRAFT_PRODUCTION_YEARS[code] || [2015, 2024];
          S.fleetData[code].year = randomInt(prodYears[0], Math.min(prodYears[1], 2024));
        }
        
        // Ensure hours exists
        if (S.fleetData[code].hours === undefined) {
          S.fleetData[code].hours = 0;
        }
        
        const operatingCost = aircraft.operating_cost || aircraft.operatingCost;
        const fleetInfo = S.fleetData[code];
        const fuelPercent = (fleetInfo.currentFuel / aircraft.fuel_capacity * 100).toFixed(0);
        const conditionColor = fleetInfo.condition >= 80 ? '#10b981' : fleetInfo.condition >= 50 ? '#f59e0b' : '#ef4444';
        const fuelNeeded = aircraft.fuel_capacity - fleetInfo.currentFuel;
        const fuelPrice = getEffectiveFuelPrice(aircraft.fuel_type);
        const refuelCost = Math.round(fuelNeeded * fuelPrice);
        const emoji = getAircraftEmoji(code);
        
        // Check for active loan or lease on this aircraft
        const loan = S.loans?.find(l => l.aircraftCode === code);
        const lease = S.leases?.find(l => l.aircraftCode === code);
        
        let financeHTML = '';
        if (loan) {
          const paidPercent = ((loan.termMonths - loan.paymentsRemaining) / loan.termMonths * 100).toFixed(0);
          financeHTML = `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 11px; color: var(--accent); font-weight: 600;">FINANCED</span>
                <span style="font-size: 11px; color: var(--muted);">${paidPercent}% paid</span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px;">
                <div><span style="color: var(--muted);">Monthly:</span> ${formatCurrency(loan.monthlyPayment)}</div>
                <div><span style="color: var(--muted);">Remaining:</span> ${formatCurrency(loan.remainingBalance)}</div>
                <div><span style="color: var(--muted);">Payments left:</span> ${loan.paymentsRemaining}</div>
                <div><span style="color: var(--muted);">Rate:</span> ${(loan.interestRate * 100).toFixed(1)}%</div>
              </div>
              <div style="margin-top: 6px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; width: ${paidPercent}%; background: var(--accent);"></div>
              </div>
            </div>
          `;
        } else if (lease) {
          const usedPercent = ((lease.termMonths - lease.monthsRemaining) / lease.termMonths * 100).toFixed(0);
          const earlyTermFee = Math.min(lease.monthsRemaining, 2) * lease.monthlyPayment;
          financeHTML = `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 11px; color: var(--warning); font-weight: 600;">LEASED</span>
                <span style="font-size: 11px; color: var(--muted);">${lease.monthsRemaining} mo remaining</span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px;">
                <div><span style="color: var(--muted);">Monthly:</span> ${formatCurrency(lease.monthlyPayment)}</div>
                <div><span style="color: var(--muted);">Deposit:</span> ${formatCurrency(lease.securityDeposit)}</div>
                <div><span style="color: var(--muted);">Return cond.:</span> ${lease.returnCondition}%</div>
                <div><span style="color: var(--muted);">Current cond.:</span> <span style="color: ${fleetInfo.condition >= lease.returnCondition ? 'var(--success)' : 'var(--danger)'};">${Math.round(fleetInfo.condition)}%</span></div>
              </div>
              <div style="margin-top: 6px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; width: ${usedPercent}%; background: var(--warning);"></div>
              </div>
              <button class="btn" onclick="cancelLease('${lease.id}')" style="margin-top: 10px; width: 100%; font-size: 11px; padding: 6px; color: var(--danger); border-color: var(--danger);">
                Cancel Lease (${formatCurrency(earlyTermFee)} fee + forfeit deposit)
              </button>
            </div>
          `;
        }
        
        // Ownership badge
        let ownershipBadge = '';
        if (loan) {
          ownershipBadge = '<span style="font-size: 9px; padding: 2px 6px; background: var(--accent); color: #000; border-radius: 3px; margin-left: 8px;">FINANCED</span>';
        } else if (lease) {
          ownershipBadge = '<span style="font-size: 9px; padding: 2px 6px; background: var(--warning); color: #000; border-radius: 3px; margin-left: 8px;">LEASED</span>';
        } else {
          ownershipBadge = '<span style="font-size: 9px; padding: 2px 6px; background: var(--success); color: #000; border-radius: 3px; margin-left: 8px;">OWNED</span>';
        }
        
        // Use stored book value (stable), or calculate once if missing
        let aircraftValue = fleetInfo.bookValue;
        if (aircraftValue === undefined || aircraftValue === null) {
          aircraftValue = calculateListingPrice(code, fleetInfo.year || S.gameTime.year - 5, fleetInfo.condition || 100, fleetInfo.hours || 0, aircraft);
          S.fleetData[code].bookValue = aircraftValue;
        }
        
        // Build sell button HTML - inline with ownership badge
        let sellButtonHtml = '';
        if (S.gameMode === 'sandbox') {
          sellButtonHtml = `<button class="btn" onclick="removeFromFleet('${code}')" style="padding: 2px 6px; font-size: 11px; color: var(--danger); border-color: var(--danger); margin-left: 8px;">âœ•</button>`;
        } else if (!lease) {
          sellButtonHtml = `<button class="btn" onclick="sellAircraft('${code}')" style="padding: 2px 6px; font-size: 11px; color: var(--success); border-color: var(--success); margin-left: 8px;">Sell</button>`;
        }
        
        return `
          <div class="aircraft-card">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">${emoji}</span>
                <div>
                  <h3 style="display: flex; align-items: center; flex-wrap: wrap;">${fleetInfo.year} ${aircraft.name}${ownershipBadge}${sellButtonHtml}</h3>
                  ${fleetInfo.registration ? `<div style="font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace;">${fleetInfo.registration}</div>` : ''}
                </div>
              </div>
              ${S.gameMode === 'sandbox' ? `<button class="btn" onclick="sandboxEditAircraft('${code}')" style="padding: 4px 8px; font-size: 11px; background: var(--accent)20; border-color: var(--accent); color: var(--accent);">âœï¸ Edit All</button>` : ''}
            </div>
            
            <!-- Fuel Section with Slider -->
            <div style="margin: 12px 0; padding: 10px; background: var(--bg); border-radius: 6px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 12px; font-weight: 600;">â›½ Fuel ${S.gameMode === 'sandbox' ? `<span style="color: var(--accent); font-size: 10px; cursor: pointer;" onclick="sandboxEditFuel('${code}')">âœŽ</span>` : ''}</span>
                <span style="font-size: 12px; font-family: 'JetBrains Mono', monospace;">${fleetInfo.currentFuel.toFixed(1)} / ${aircraft.fuel_capacity} gal</span>
              </div>
              <div style="background: var(--border); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                <div style="height: 100%; background: ${fuelPercent > 25 ? 'var(--success)' : 'var(--danger)'}; width: ${fuelPercent}%; transition: width 0.3s;"></div>
              </div>
              ${fuelNeeded > 1 ? `
                <div id="refuelPanel_${code}">
                  ${(() => {
                    const aircraftBase = getAircraftBase(code);
                    const fuelType = aircraft.fuel_type || '100LL';
                    let tankFuelAvailable = 0;
                    if (aircraftBase) {
                      const tanks = aircraftBase.fuelStorage[fuelType]?.filter(t => t.status === 'operational') || [];
                      tankFuelAvailable = tanks.reduce((sum, t) => sum + t.level, 0);
                    }
                    const fromTank = Math.min(tankFuelAvailable, fuelNeeded);
                    const fromFBO = fuelNeeded - fromTank;
                    const effectiveCost = Math.round(fromFBO * fuelPrice);
                    
                    if (tankFuelAvailable > 0) {
                      return `<div style="font-size: 11px; color: var(--success); margin-bottom: 8px;">â›½ ${Math.round(tankFuelAvailable)} gal available in base tank</div>`;
                    }
                    return '';
                  })()}
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="range" id="refuelSlider_${code}" min="0" max="${fuelNeeded.toFixed(1)}" step="1" value="${fuelNeeded.toFixed(0)}"
                           oninput="updateRefuelPreviewWithTank('${code}', this.value, ${fuelPrice})"
                           style="flex: 1; cursor: pointer;">
                    <span id="refuelAmount_${code}" style="font-size: 11px; width: 50px; text-align: right;">${fuelNeeded.toFixed(0)} gal</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="refuelCost_${code}" style="font-size: 12px; color: var(--muted);">Cost: ${formatCurrency(refuelCost)}</span>
                    <div style="display: flex; gap: 6px;">
                      <button class="btn" onclick="refuelAircraft('${code}', parseFloat(document.getElementById('refuelSlider_${code}').value))" style="padding: 4px 10px; font-size: 11px;">Add Fuel</button>
                      <button class="btn" onclick="refuelAircraft('${code}', ${fuelNeeded})" style="padding: 4px 10px; font-size: 11px; background: var(--accent)20; border-color: var(--accent); color: var(--accent);">Fill Up</button>
                    </div>
                  </div>
                </div>
              ` : `<div style="font-size: 11px; color: var(--success); text-align: center;">âœ“ Tank Full</div>`}
            </div>
            
            <div class="aircraft-specs">
              <div ${S.gameMode === 'sandbox' ? `style="cursor: pointer;" onclick="sandboxEditCondition('${code}')"` : ''}><strong>Condition:</strong> <span style="color: ${conditionColor};">${Math.round(fleetInfo.condition)}%</span> ${S.gameMode === 'sandbox' ? '<span style="color: var(--accent); font-size: 10px;">âœŽ</span>' : ''}</div>
              <div><strong>Value:</strong> <span style="color: var(--success);">${formatCurrency(aircraftValue)}</span></div>
              <div><strong>Category:</strong> ${(aircraft.category || 'unknown').replace(/_/g, ' ')}</div>
              <div><strong>Range:</strong> ${aircraft.range} nm</div>
              <div><strong>Cruise Speed:</strong> ${aircraft.cruise_speed} kts</div>
              <div><strong>Operating cost:</strong> ${formatCurrency(operatingCost)}/hour</div>
              <div><strong>Passengers:</strong> ${aircraft.max_passengers || 0}</div>
              <div><strong>Cargo:</strong> ${aircraft.max_cargo_lbs || 0} lbs</div>
              <div><strong>Total Time:</strong> ${(fleetInfo.hours || 0).toLocaleString()} hrs</div>
            </div>
            
            <!-- MX Status Section -->
            ${(() => {
              const mxData = getMxData(code);
              const mxStatus = getMxStatus(code);
              const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
              const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
              const statusColor = mxStatus === 'airworthy' ? 'var(--success)' : mxStatus === 'needs_attention' ? 'var(--warning)' : 'var(--danger)';
              const statusText = mxStatus === 'airworthy' ? 'Airworthy' : mxStatus === 'needs_attention' ? 'Needs Attention' : 'GROUNDED';
              const squawkCount = (fleetInfo.squawks || []).length;
              
              return `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--muted);">Maintenance</span>
                    <span style="padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">${statusText}</span>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                    <div><span style="color: var(--muted);">Next Insp:</span> <span style="color: ${hoursUntilInspection <= 10 ? 'var(--warning)' : 'var(--text)'};">${hoursUntilInspection.toFixed(0)} hrs</span></div>
                    <div><span style="color: var(--muted);">To TBO:</span> <span style="color: ${hoursUntilOverhaul <= 100 ? 'var(--warning)' : 'var(--text)'};">${hoursUntilOverhaul.toFixed(0)} hrs</span></div>
                    ${squawkCount > 0 ? `<div style="grid-column: span 2; color: var(--warning);">âš ï¸ ${squawkCount} active squawk${squawkCount > 1 ? 's' : ''}</div>` : ''}
                  </div>
                  ${fleetInfo.scheduledMx ? (() => {
                    const mx = fleetInfo.scheduledMx;
                    const laborHours = mx.laborHours || 16;
                    const startDayNum = mx.startDate.day + (mx.startDate.month - 1) * 28 + (mx.startDate.year - 2020) * 336;
                    const endDayNum = mx.completionDate.day + (mx.completionDate.month - 1) * 28 + (mx.completionDate.year - 2020) * 336;
                    const currentDayNum = S.gameTime.day + (S.gameTime.month - 1) * 28 + (S.gameTime.year - 2020) * 336;
                    const hoursPerDay = mx.use24HrOps ? 24 : SHOP_HOURS.hoursPerDay;
                    const daysElapsed = Math.max(0, currentDayNum - startDayNum);
                    const hoursCompleted = Math.min(laborHours, daysElapsed * hoursPerDay);
                    const hoursRemaining = Math.max(0, laborHours - hoursCompleted);
                    return `
                    <div style="margin-top: 8px; padding: 6px; background: var(--accent)20; border-radius: 4px; font-size: 11px;">
                      <span style="color: var(--accent);">ðŸ”§ In Maintenance:</span> ${mx.type.replace('_', ' ')}${mx.use24HrOps ? ' âš¡' : ''}
                      <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">${Math.round(hoursRemaining)} hrs remaining</div>
                    </div>
                    `;
                  })() : ''}
                </div>
              `;
            })()}
            ${financeHTML}
          </div>
        `;
      }).join('') + '</div>';
    }
    
    function renderFleetMaintenance() {
      const container = document.getElementById('fleetMaintenance');
      if (!container) return;
      
      // Calculate fleet-wide MX reserve recommendation
      let maxAge = 0;
      let totalFleetValue = 0;
      for (const code of S.fleet) {
        const age = getAircraftAge(code);
        if (age > maxAge) maxAge = age;
        const fleetInfo = S.fleetData[code];
        totalFleetValue += fleetInfo?.bookValue || 0;
      }
      const recommendedRate = getRecommendedReserveRate(maxAge);
      const currentRate = S.mxReserveRate || 15;
      const rateStatus = currentRate >= recommendedRate ? 'good' : currentRate >= recommendedRate - 5 ? 'caution' : 'warning';
      const rateColor = rateStatus === 'good' ? 'var(--success)' : rateStatus === 'caution' ? 'var(--warning)' : 'var(--danger)';
      
      // Get upcoming maintenance
      const upcoming = getUpcomingMx();
      
      let html = `
        <div style="margin-bottom: 20px;">
          <!-- MX Reserve Status -->
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; font-size: 14px;">ðŸ”§ Maintenance Reserve</h3>
              <span style="font-size: 18px; font-weight: 700; color: var(--success); font-family: 'JetBrains Mono', monospace;">${formatCurrency(S.maintenanceReserve)}</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
              <div>
                <span style="color: var(--muted);">Current Rate:</span>
                <span style="margin-left: 8px; font-weight: 600;">${currentRate}%</span>
              </div>
              <div>
                <span style="color: var(--muted);">Recommended:</span>
                <span style="margin-left: 8px; font-weight: 600; color: ${rateColor};">${recommendedRate}%</span>
                ${currentRate < recommendedRate ? `<span style="font-size: 10px; color: var(--warning);"> (consider increasing)</span>` : ''}
              </div>
            </div>
            ${maxAge >= 25 ? `
              <div style="margin-top: 10px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 4px; font-size: 11px; color: var(--warning);">
                âš ï¸ Older aircraft (${maxAge}+ years) in fleet may require additional maintenance resources.
              </div>
            ` : ''}
          </div>
          
          <!-- In Progress Maintenance -->
          ${(() => {
            const inProgress = S.fleet.filter(code => S.fleetData[code]?.scheduledMx);
            if (inProgress.length === 0) return '';
            
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            return '<div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">' +
              '<h3 style="margin: 0 0 12px 0; font-size: 14px;">ðŸ”§ In Progress</h3>' +
              '<div style="display: flex; flex-direction: column; gap: 10px;">' +
              inProgress.map(code => {
                const fleetInfo = S.fleetData[code];
                const mx = fleetInfo.scheduledMx;
                const aircraft = getAircraft(code);
                
                // Use actual hoursCompleted from mx object
                const laborHours = mx.laborHours || 16;
                const hoursCompleted = mx.hoursCompleted || 0;
                const progressPct = Math.min(100, Math.round((hoursCompleted / laborHours) * 100));
                
                // Format completion date
                const comp = mx.completionDate;
                const completionStr = monthNames[comp.month] + ' ' + comp.day + ' @ 6pm';
                
                const acName = aircraft?.name || code;
                
                // Build item list
                const items = mx.items || [{ description: mx.type.replace(/_/g, ' ') }];
                const itemCount = items.length;
                const itemsDisplay = itemCount === 1 
                  ? items[0].description 
                  : itemCount + ' items';
                
                return '<div style="padding: 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">' +
                  '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                    '<div>' +
                      '<div style="font-size: 13px; font-weight: 600;">' + acName + '</div>' +
                      '<div style="font-size: 11px; color: var(--muted);">' + itemsDisplay + (mx.use24HrOps ? ' âš¡' : '') + '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                      '<div style="font-size: 11px; color: var(--muted);">Est. completion</div>' +
                      '<div style="font-size: 12px; font-weight: 600; color: var(--accent);">' + completionStr + '</div>' +
                    '</div>' +
                  '</div>' +
                  (itemCount > 1 ? '<div style="font-size: 10px; color: var(--muted); margin-bottom: 6px; padding: 4px; background: var(--panel); border-radius: 4px;">' + items.map(i => 'â€¢ ' + i.description).join('<br>') + '</div>' : '') +
                  '<div style="background: var(--panel); border-radius: 4px; height: 8px; overflow: hidden;">' +
                    '<div style="background: var(--accent); height: 100%; width: ' + progressPct + '%; transition: width 0.3s;"></div>' +
                  '</div>' +
                  '<div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 10px; color: var(--muted);">' +
                    '<span>' + Math.round(hoursCompleted) + ' / ' + laborHours + ' labor hrs</span>' +
                    '<span>' + progressPct + '% complete</span>' +
                  '</div>' +
                '</div>';
              }).join('') +
              '</div>' +
            '</div>';
          })()}
          
          <!-- Maintenance Needs -->
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px;">ðŸ“‹ Maintenance Needs</h3>
            ${upcoming.length === 0 ? `
              <div style="text-align: center; padding: 20px; color: var(--muted); font-size: 13px;">
                âœ“ No maintenance items pending
              </div>
            ` : `
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${upcoming.slice(0, 10).map(mx => {
                  const urgencyColor = mx.urgency === 'overdue' ? 'var(--danger)' : 
                                       mx.urgency === 'urgent' ? 'var(--warning)' : 
                                       mx.urgency === 'active' ? 'var(--accent)' : 
                                       mx.urgency === 'deferred' ? 'var(--muted)' : '#888';
                  const urgencyBg = mx.urgency === 'overdue' ? 'rgba(239, 68, 68, 0.1)' : 
                                    mx.urgency === 'urgent' ? 'rgba(245, 158, 11, 0.1)' : 
                                    mx.urgency === 'active' ? 'rgba(0, 212, 255, 0.1)' : 'transparent';
                  return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${urgencyBg}; border-radius: 6px; border: 1px solid var(--border);">
                      <div style="flex: 1;">
                        <div style="font-size: 12px; font-weight: 600;">${mx.name}</div>
                        <div style="font-size: 11px; color: var(--muted);">${mx.description}</div>
                      </div>
                      <div style="text-align: right; margin: 0 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: ${urgencyColor};">${mx.dueIn}</div>
                        ${mx.cost ? `<div style="font-size: 11px; color: var(--muted);">${formatCurrency(mx.cost)}</div>` : ''}
                      </div>
                      ${mx.type !== 'scheduled' ? `
                        <button class="btn" onclick="openMxScheduleModal('${mx.code}', '${mx.type}'${mx.squawkId ? `, '${mx.squawkId}'` : ', null'})" 
                                style="font-size: 10px; padding: 4px 8px;">
                          Schedule
                        </button>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
          
          <!-- Fleet MX Overview -->
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px;">âœˆï¸ Fleet Status</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${S.fleet.length === 0 ? `
                <div style="text-align: center; padding: 20px; color: var(--muted);">No aircraft in fleet</div>
              ` : S.fleet.map(code => {
                const aircraft = getAircraft(code);
                const fleetInfo = S.fleetData[code] || {};
                const mxData = getMxData(code);
                const age = getAircraftAge(code);
                const status = getMxStatus(code);
                
                const condition = Math.round(fleetInfo.condition || 100);
                const conditionColor = condition >= 80 ? 'var(--success)' : condition >= 50 ? 'var(--warning)' : 'var(--danger)';
                
                const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
                const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
                
                const statusColor = status === 'airworthy' ? 'var(--success)' : 
                                    status === 'needs_attention' ? 'var(--warning)' : 'var(--danger)';
                const statusText = status === 'airworthy' ? 'Airworthy' : 
                                   status === 'needs_attention' ? 'Needs Attention' : 'GROUNDED';
                
                return `
                  <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: center; padding: 12px; background: var(--bg); border-radius: 6px;">
                    <div>
                      <div style="font-size: 12px; font-weight: 600;">${aircraft?.name || code}</div>
                      <div style="font-size: 10px; color: var(--muted);">${fleetInfo.year || '?'} Â· ${age} yrs old</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 14px; font-weight: 600; color: ${conditionColor};">${condition}%</div>
                      <div style="font-size: 9px; color: var(--muted);">Condition</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 12px; font-weight: 500; color: ${hoursUntilInspection <= 10 ? 'var(--warning)' : 'var(--text)'};">${hoursUntilInspection.toFixed(0)}</div>
                      <div style="font-size: 9px; color: var(--muted);">Hrs to Insp</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 12px; font-weight: 500; color: ${hoursUntilOverhaul <= 100 ? 'var(--warning)' : 'var(--text)'};">${hoursUntilOverhaul.toFixed(0)}</div>
                      <div style="font-size: 9px; color: var(--muted);">Hrs to TBO</div>
                    </div>
                    <div style="text-align: center;">
                      <span style="display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 600; background: ${statusColor}20; color: ${statusColor};">
                        ${statusText}
                      </span>
                    </div>
                    <div>
                      <button class="btn" onclick="openMxScheduleModal('${code}')" style="font-size: 10px; padding: 4px 10px;">
                        MX
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <!-- MX History Log -->
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 16px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px;">ðŸ“‹ Maintenance History</h3>
            ${(() => {
              // Gather all MX history from all aircraft
              const allHistory = [];
              S.fleet.forEach(code => {
                const fleetInfo = S.fleetData[code];
                const aircraft = getAircraft(code);
                if (fleetInfo?.mxHistory) {
                  fleetInfo.mxHistory.forEach(entry => {
                    allHistory.push({ ...entry, code, aircraftName: aircraft?.name || code });
                  });
                }
              });
              
              if (allHistory.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--muted); font-size: 13px;">No maintenance history yet</div>';
              }
              
              // Sort by date descending
              const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              allHistory.sort((a, b) => {
                const aNum = a.date.day + (a.date.month - 1) * 28 + (a.date.year - 2020) * 336;
                const bNum = b.date.day + (b.date.month - 1) * 28 + (b.date.year - 2020) * 336;
                return bNum - aNum;
              });
              
              // Show last 10 entries
              return '<div style="display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto;">' +
                allHistory.slice(0, 10).map(entry => {
                  const dateStr = monthNames[entry.date.month] + ' ' + entry.date.day + ', ' + entry.date.year;
                  const itemsStr = entry.items?.map(i => i.description || i.type).join(', ') || entry.type.replace(/_/g, ' ');
                  return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px; font-size: 11px;">' +
                    '<div style="flex: 1;">' +
                      '<div style="font-weight: 600;">' + entry.aircraftName + '</div>' +
                      '<div style="color: var(--muted);">' + itemsStr + '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                      '<div style="color: var(--muted);">' + dateStr + '</div>' +
                      '<div>' + formatCurrency(entry.cost) + ' Â· ' + entry.laborHours + ' hrs</div>' +
                    '</div>' +
                  '</div>';
                }).join('') +
              '</div>';
            })()}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    window.renderFleetMaintenance = renderFleetMaintenance;
    
    function openMxScheduleModal(code, preselectedType = null, squawkId = null) {
      const aircraft = getAircraft(code);
      const fleetInfo = S.fleetData[code];
      const mxData = getMxData(code);
      const age = getAircraftAge(code);
      const maxCond = getMaxCondition(age);
      
      if (!aircraft || !fleetInfo) return;
      
      // Check if aircraft already has scheduled maintenance - show status but allow adding more
      const hasExistingMx = !!fleetInfo.scheduledMx;
      
      // Get estimates for each type
      const inspectionEst = getInspectionEstimate(code);
      const majorServiceEst = getMajorServiceEstimate(code);
      const overhaulEst = getOverhaulEstimate(code);
      const repairEst = getRepairEstimate(code, Math.min(80, maxCond));
      
      // Check available funds
      const totalFunds = S.maintenanceReserve + S.cash;
      
      // Get squawks (exclude already scheduled ones)
      const squawks = (fleetInfo.squawks || []).filter(s => !s.scheduled);
      
      const hoursUntilInspection = mxData.inspectionInterval - (fleetInfo.hoursSinceInspection || 0);
      const hoursUntilOverhaul = mxData.tbo - (fleetInfo.hoursSinceOverhaul || 0);
      
      // Calculate if MX is within 80% threshold (available for scheduling)
      const inspectionThreshold = mxData.inspectionInterval * 0.2; // Can schedule when 80% of interval completed
      const overhaulThreshold = mxData.tbo * 0.2;
      const canScheduleInspection = hoursUntilInspection <= inspectionThreshold;
      const canScheduleOverhaul = hoursUntilOverhaul <= overhaulThreshold;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('mxScheduleModal');
      if (existingModal) existingModal.remove();
      
      const modalHTML = `
        <div id="mxScheduleModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 550px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 16px;">ðŸ”§ Schedule Maintenance</h3>
              <button onclick="closeMxScheduleModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div style="padding: 16px; overflow-y: auto; flex: 1;">
              ${hasExistingMx ? `
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(0, 212, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px;">
                  <div style="font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">ðŸ”§ Currently In Maintenance</div>
                  <div style="font-size: 11px; color: var(--muted);">
                    ${fleetInfo.scheduledMx.items?.length || 1} item(s) Â· ${fleetInfo.scheduledMx.laborHours || 0} total hrs Â· ${Math.round(fleetInfo.scheduledMx.hoursCompleted || 0)} completed
                  </div>
                  <div style="font-size: 11px; color: var(--text); margin-top: 4px;">
                    Add more work below to extend the maintenance period.
                  </div>
                </div>
              ` : ''}
              <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                <div style="font-size: 16px; font-weight: 600;">${fleetInfo.year} ${aircraft.name}</div>
                <div style="font-size: 12px; color: var(--muted);">
                  Condition: ${Math.round(fleetInfo.condition)}% Â· Age: ${age} yrs Â· Max for age: ${maxCond.toFixed(0)}%
                </div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  Available: <span style="color: var(--success);">${formatCurrency(totalFunds)}</span> 
                  (Reserve: ${formatCurrency(S.maintenanceReserve)} + Cash: ${formatCurrency(S.cash)})
                </div>
              </div>
              
              <!-- Scheduled MX Options -->
              <div style="display: flex; flex-direction: column; gap: 10px;">
                
                <!-- Inspection -->
                <div class="mx-option" style="padding: 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); cursor: ${canScheduleInspection && totalFunds >= inspectionEst.cost ? 'pointer' : 'not-allowed'}; opacity: ${canScheduleInspection && totalFunds >= inspectionEst.cost ? '1' : '0.5'}; transition: background 0.2s;" 
                     ${canScheduleInspection ? `onmouseover="this.style.background='var(--panel)'" onmouseout="this.style.background='var(--bg)'"` : ''}
                     onclick="${canScheduleInspection && totalFunds >= inspectionEst.cost ? `confirmScheduleMx('${code}', 'inspection')` : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 13px; font-weight: 600;">ðŸ“‹ ${mxData.inspectionInterval}-Hour Inspection</div>
                      <div style="font-size: 11px; color: var(--muted);">${inspectionEst.days} day(s) Â· Restores +2% condition</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 14px; font-weight: 600;">${formatCurrency(inspectionEst.cost)}</div>
                      ${canScheduleInspection 
                        ? `<div style="font-size: 10px; color: ${hoursUntilInspection <= 10 ? 'var(--warning)' : 'var(--muted)'};">Due in ${hoursUntilInspection.toFixed(0)} hrs</div>`
                        : `<div style="font-size: 10px; color: var(--muted);">Available at ${Math.ceil(mxData.inspectionInterval * 0.8)} hrs</div>`
                      }
                    </div>
                  </div>
                </div>
                
                ${majorServiceEst ? `
                  <!-- Major Service -->
                  <div class="mx-option" style="padding: 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); cursor: ${totalFunds >= majorServiceEst.cost ? 'pointer' : 'not-allowed'}; opacity: ${totalFunds >= majorServiceEst.cost ? '1' : '0.5'};"
                       onclick="${totalFunds >= majorServiceEst.cost ? `confirmScheduleMx('${code}', 'major_service')` : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <div style="font-size: 13px; font-weight: 600;">âš™ï¸ Major Service / HSI</div>
                        <div style="font-size: 11px; color: var(--muted);">${majorServiceEst.days} day(s) Â· Restores +15% condition</div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 600;">${formatCurrency(majorServiceEst.cost)}</div>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                <!-- Overhaul -->
                <div class="mx-option" style="padding: 12px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); cursor: ${canScheduleOverhaul && totalFunds >= overhaulEst.cost ? 'pointer' : 'not-allowed'}; opacity: ${canScheduleOverhaul && totalFunds >= overhaulEst.cost ? '1' : '0.5'};"
                     onclick="${canScheduleOverhaul && totalFunds >= overhaulEst.cost ? `confirmScheduleMx('${code}', 'overhaul')` : ''}">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 13px; font-weight: 600;">ðŸ”© Engine Overhaul</div>
                      <div style="font-size: 11px; color: var(--muted);">${overhaulEst.days} day(s) Â· Resets to ${maxCond.toFixed(0)}% condition</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 14px; font-weight: 600;">${formatCurrency(overhaulEst.cost)}</div>
                      ${canScheduleOverhaul 
                        ? `<div style="font-size: 10px; color: ${hoursUntilOverhaul <= 100 ? 'var(--warning)' : 'var(--muted)'};">Due in ${hoursUntilOverhaul.toFixed(0)} hrs</div>`
                        : `<div style="font-size: 10px; color: var(--muted);">Available at ${Math.ceil(mxData.tbo * 0.8)} hrs</div>`
                      }
                    </div>
                  </div>
                </div>
                
                <!-- Repair to Condition -->
                ${fleetInfo.condition < maxCond - 5 ? `
                  <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">ðŸ› ï¸ General Service (Condition Repair)</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input type="range" id="repairTargetSlider" 
                             min="${Math.ceil(fleetInfo.condition)}" 
                             max="${Math.floor(maxCond)}" 
                             value="${Math.min(80, Math.floor(maxCond))}"
                             style="flex: 1;"
                             oninput="updateRepairEstimate('${code}', this.value)">
                      <span id="repairTargetValue" style="font-size: 14px; font-weight: 600; min-width: 40px;">${Math.min(80, Math.floor(maxCond))}%</span>
                    </div>
                    <div id="repairEstimateDisplay" style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px;">
                      <span>Cost: <strong>${formatCurrency(repairEst.cost)}</strong></span>
                      <span>Labor: <strong>${repairEst.laborHours || 0} hrs</strong></span>
                    </div>
                    <button class="btn" id="repairConfirmBtn" onclick="confirmScheduleRepair('${code}')" 
                            style="width: 100%; margin-top: 10px; ${totalFunds >= repairEst.cost ? '' : 'opacity: 0.5; pointer-events: none;'}">
                      Schedule Service
                    </button>
                  </div>
                ` : ''}
                
                <!-- Active Squawks -->
                ${squawks.length > 0 ? (() => {
                  const totalSquawkCost = squawks.reduce((sum, sq) => sum + sq.cost, 0);
                  const totalSquawkHours = squawks.reduce((sum, sq) => sum + (sq.laborHours || getSquawkLaborHours(sq.severity, sq.incidentType || 'other')), 0);
                  return `
                  <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <div style="font-size: 12px; font-weight: 600;">âš ï¸ Active Squawks (${squawks.length})</div>
                      ${squawks.length > 1 ? `
                        <button class="btn" onclick="confirmScheduleAllSquawks('${code}')" 
                                style="font-size: 10px; padding: 4px 8px; ${totalFunds >= totalSquawkCost ? '' : 'opacity: 0.5; pointer-events: none;'}">
                          Fix All (${formatCurrency(totalSquawkCost)} Â· ${totalSquawkHours} hrs)
                        </button>
                      ` : ''}
                    </div>
                    ${squawks.map(sq => {
                      const sevColor = sq.severity === 'critical' ? 'var(--danger)' : 
                                       sq.severity === 'serious' ? 'var(--warning)' : 
                                       sq.severity === 'moderate' ? '#f59e0b80' : 'var(--muted)';
                      const laborHrs = sq.laborHours || getSquawkLaborHours(sq.severity, sq.incidentType || 'other');
                      return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ' + sevColor + ';">' +
                          '<div>' +
                            '<div style="font-size: 12px;">' + sq.description + '</div>' +
                            '<div style="font-size: 10px; color: var(--muted);">' + sq.severity + ' Â· ' + laborHrs + ' hrs Â· -' + sq.conditionImpact + '% cond</div>' +
                          '</div>' +
                          '<div style="text-align: right;">' +
                            '<div style="font-size: 12px; font-weight: 600;">' + formatCurrency(sq.cost) + '</div>' +
                            '<button class="btn" onclick="confirmScheduleMx(\'' + code + '\', \'squawk\', \'' + sq.id + '\')" ' +
                                    'style="font-size: 10px; padding: 2px 6px; margin-top: 4px; ' + (totalFunds >= sq.cost ? '' : 'opacity: 0.5; pointer-events: none;') + '">' +
                              'Fix' +
                            '</button>' +
                          '</div>' +
                        '</div>';
                    }).join('')}
                  </div>
                `; })() : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    window.openMxScheduleModal = openMxScheduleModal;
    
    function closeMxScheduleModal() {
      const modal = document.getElementById('mxScheduleModal');
      if (modal) modal.remove();
    }
    window.closeMxScheduleModal = closeMxScheduleModal;
    
    function updateRepairEstimate(code, targetValue) {
      const target = parseInt(targetValue);
      document.getElementById('repairTargetValue').textContent = target + '%';
      
      const estimate = getRepairEstimate(code, target);
      const totalFunds = S.maintenanceReserve + S.cash;
      
      document.getElementById('repairEstimateDisplay').innerHTML = `
        <span>Cost: <strong>${formatCurrency(estimate.cost)}</strong></span>
        <span>Labor: <strong>${estimate.laborHours || 0} hrs</strong></span>
      `;
      
      const btn = document.getElementById('repairConfirmBtn');
      if (btn) {
        btn.style.opacity = totalFunds >= estimate.cost ? '1' : '0.5';
        btn.style.pointerEvents = totalFunds >= estimate.cost ? 'auto' : 'none';
      }
    }
    window.updateRepairEstimate = updateRepairEstimate;
    
    function confirmScheduleRepair(code) {
      const slider = document.getElementById('repairTargetSlider');
      if (!slider) return;
      
      const target = parseInt(slider.value);
      const fleetInfo = S.fleetData[code];
      const aircraft = getAircraft(code);
      const estimate = getRepairEstimate(code, target);
      const hasExistingMx = fleetInfo?.scheduledMx && fleetInfo.scheduledMx.type !== 'pending';
      
      const estLaborHours = estimate.laborHours || Math.max(4, Math.round((target - (fleetInfo?.condition || 50)) * 0.8));
      const normalDays = calculateMxDays(estLaborHours, false);
      const overtimeDays = calculateMxDays(estLaborHours, true);
      const overtimeCost = Math.round(estimate.cost * SHOP_HOURS.overtimeMultiplier);
      const description = `Repair to ${target}%`;
      
      // If there's existing MX in progress, show simplified "add to existing" modal
      if (hasExistingMx) {
        const existingMx = fleetInfo.scheduledMx;
        const existingMechanicId = existingMx.mechanicId;
        const existingMechanic = existingMechanicId ? S.staff.find(s => s.id === existingMechanicId) : null;
        const isExistingInHouse = existingMechanic !== null;
        
        let addCost = estimate.cost;
        let addHours = estLaborHours;
        
        if (isExistingInHouse) {
          const baseLaborCost = Math.round(estimate.cost * 0.6);
          const basePartsCost = estimate.cost - baseLaborCost;
          const discounted = calculateInHouseMxCost(baseLaborCost, basePartsCost, existingMechanic);
          addCost = discounted.total;
          addHours = calculateMechanicLaborHours(estLaborHours, existingMechanic);
        } else if (existingMx.use24HrOps) {
          addCost = overtimeCost;
        }
        
        closeMxScheduleModal();
        
        const providerInfo = isExistingInHouse 
          ? `<div style="color: var(--success); margin-top: 4px;">In-house: ${existingMechanic.name}</div>`
          : existingMx.use24HrOps 
            ? `<div style="color: var(--warning); margin-top: 4px;">Contract Shop (24-hr)</div>`
            : `<div style="color: var(--muted); margin-top: 4px;">Contract Shop</div>`;
        
        const confirmModalHTML = `
          <div id="mxConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
            <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 420px; width: 90%; padding: 20px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px;">ðŸ”§ Add to Existing Work Order</h3>
              
              <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; font-weight: 600; color: var(--accent);">Current Job In Progress</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  ${existingMx.items?.length || 1} item(s) Â· ${Math.round(existingMx.hoursCompleted || 0)}/${existingMx.laborHours} hrs complete
                </div>
                ${providerInfo}
              </div>
              
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px;">${description}</div>
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                  <span>Additional Cost:</span>
                  <span style="font-weight: 700;">${formatCurrency(addCost)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 4px;">
                  <span>Additional Labor:</span>
                  <span>${Math.round(addHours * 10) / 10} hours</span>
                </div>
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="closeMxConfirmModal()" style="flex: 1; background: var(--panel);">Cancel</button>
                <button class="btn primary" onclick="executeRepairSchedule('${code}', ${target})" style="flex: 1;">Add Work</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
        return;
      }
      
      // Check for available in-house mechanics (repair uses airframe spec)
      const availableMechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.status === 'available' &&
        s.mechanic?.specializations?.includes('airframe') &&
        MECHANIC_CAPABILITIES[s.experienceLevel]?.includes('squawk') // Repair is similar to squawk work
      );
      
      const baseLaborCost = Math.round(estimate.cost * 0.6);
      const basePartsCost = estimate.cost - baseLaborCost;
      
      let mechanicOptionsHTML = '';
      if (availableMechanics.length > 0) {
        mechanicOptionsHTML = `
          <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--success);">ðŸ”§ In-House Mechanic Available</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        let isFirst = true;
        for (const mechanic of availableMechanics) {
          const inHouseCost = calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic);
          const inHouseHours = calculateMechanicLaborHours(estLaborHours, mechanic);
          const inHouseDays = calculateMxDays(inHouseHours, false);
          const savings = estimate.cost - inHouseCost.total;
          const speedBonus = Math.round((1 - inHouseHours / estLaborHours) * 100);
          const isChecked = isFirst ? 'checked' : '';
          const borderColor = isFirst ? 'var(--success)' : 'var(--border)';
          
          mechanicOptionsHTML += `
            <label style="display: block; padding: 10px; background: var(--bg); border-radius: 6px; border: 2px solid ${borderColor}; cursor: pointer;" class="mechanic-option" data-mechanic-id="${mechanic.id}">
              <input type="radio" name="mxMechanic" value="${mechanic.id}" ${isChecked} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
              <div style="display: inline-block; vertical-align: top;">
                <div style="font-weight: 600;">${mechanic.name} <span style="font-weight: normal; color: var(--muted);">(${mechanic.experienceLevel})</span></div>
                <div style="font-size: 11px; color: var(--muted);">
                  Labor: -${Math.round(inHouseCost.laborDiscount * 100)}% Â· Parts: -${Math.round(inHouseCost.partsDiscount * 100)}% Â· Speed: +${speedBonus}%
                </div>
                <div style="font-size: 13px; margin-top: 4px;">
                  <span style="font-weight: 700; color: var(--success);">${formatCurrency(inHouseCost.total)}</span>
                  <span style="font-size: 11px; color: var(--success);">(save ${formatCurrency(savings)})</span>
                  <span style="font-size: 11px; color: var(--muted); margin-left: 8px;">${inHouseDays} day${inHouseDays !== 1 ? 's' : ''}</span>
                </div>
              </div>
            </label>
          `;
          isFirst = false;
        }
        
        mechanicOptionsHTML += `
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Or choose contract shop below:</div>
          </div>
        `;
      }
      
      closeMxScheduleModal();
      
      const confirmModalHTML = `
        <div id="mxConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 480px; width: 90%; padding: 20px; max-height: 85vh; overflow-y: auto;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">ðŸ”§ ${description}</h3>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">${aircraft?.name || code}</div>
            
            ${mechanicOptionsHTML}
            
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Contract Shop Â· Estimated Labor: ${estLaborHours} hours</div>
              
              <div style="display: flex; gap: 12px;">
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid ${availableMechanics.length === 0 ? 'var(--accent)' : 'var(--border)'}; cursor: pointer;" id="normalOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_normal" ${availableMechanics.length === 0 ? 'checked' : ''} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">Normal Ops</div>
                  <div style="font-size: 12px; color: var(--muted);">8am-6pm (10 hrs/day)</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(estimate.cost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${normalDays} day${normalDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
                
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid var(--border); cursor: pointer;" id="overtimeOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_overtime" style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">24-Hour Ops</div>
                  <div style="font-size: 12px; color: var(--warning);">+50% overtime premium</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(overtimeCost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${overtimeDays} day${overtimeDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
              </div>
            </div>
            
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 16px;">
              The aircraft will be grounded during maintenance.
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="closeMxConfirmModal()" style="flex: 1; background: var(--panel);">Cancel</button>
              <button class="btn primary" onclick="executeRepairSchedule('${code}', ${target})" style="flex: 1;">Schedule</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
    }
    window.confirmScheduleRepair = confirmScheduleRepair;
    
    function executeRepairSchedule(code, targetCondition) {
      const selected = document.querySelector('input[name="mxMechanic"]:checked')?.value;
      const fleetInfo = S.fleetData[code];
      const hasExistingMx = fleetInfo?.scheduledMx && fleetInfo.scheduledMx.type !== 'pending';
      
      let use24HrOps = false;
      let mechanicId = null;
      
      if (hasExistingMx) {
        mechanicId = fleetInfo.scheduledMx.mechanicId || null;
        use24HrOps = fleetInfo.scheduledMx.use24HrOps || false;
      } else if (selected === 'contract_overtime') {
        use24HrOps = true;
      } else if (selected && selected !== 'contract_normal') {
        mechanicId = selected;
      }
      
      if (scheduleMaintenance(code, 'repair', { targetCondition, use24HrOps, mechanicId })) {
        closeMxConfirmModal();
        render();
      } else {
        closeMxConfirmModal();
      }
    }
    window.executeRepairSchedule = executeRepairSchedule;
    
    function confirmScheduleMx(code, mxType, squawkId = null) {
      const mxData = getMxData(code);
      const fleetInfo = S.fleetData[code];
      const aircraft = getAircraft(code);
      const hasExistingMx = fleetInfo?.scheduledMx && fleetInfo.scheduledMx.type !== 'pending';
      let estimate, description, laborHoursRange;
      
      if (mxType === 'inspection') {
        estimate = getInspectionEstimate(code);
        description = `${mxData.inspectionInterval}-Hour Inspection`;
        laborHoursRange = mxData.inspectionHoursRange;
      } else if (mxType === 'major_service') {
        estimate = getMajorServiceEstimate(code);
        description = 'Major Service / HSI';
        laborHoursRange = mxData.majorServiceHoursRange;
      } else if (mxType === 'overhaul') {
        estimate = getOverhaulEstimate(code);
        description = 'Engine Overhaul';
        laborHoursRange = mxData.overhaulHoursRange;
      } else if (mxType === 'squawk' && squawkId) {
        const squawk = fleetInfo?.squawks?.find(s => s.id === squawkId);
        if (!squawk) return;
        const laborHrs = squawk.laborHours || getSquawkLaborHours(squawk.severity, squawk.incidentType || 'other');
        estimate = { cost: squawk.cost, days: calculateMxDays(laborHrs, false), laborHours: laborHrs };
        description = `Squawk Repair`;
        laborHoursRange = [laborHrs, laborHrs]; // Fixed for squawks
      } else {
        return;
      }
      
      // Calculate labor hours estimate (midpoint of range for display)
      const estLaborHours = laborHoursRange ? Math.round((laborHoursRange[0] + laborHoursRange[1]) / 2) : estimate.days * 8;
      const normalDays = calculateMxDays(estLaborHours, false);
      const overtimeDays = calculateMxDays(estLaborHours, true);
      const overtimeCost = Math.round(estimate.cost * SHOP_HOURS.overtimeMultiplier);
      
      // If there's existing MX in progress, show simplified "add to existing" modal
      if (hasExistingMx) {
        const existingMx = fleetInfo.scheduledMx;
        const existingMechanicId = existingMx.mechanicId;
        const existingMechanic = existingMechanicId ? S.staff.find(s => s.id === existingMechanicId) : null;
        const isExistingInHouse = existingMechanic !== null;
        
        // Calculate cost based on existing job's provider
        let addCost = estimate.cost;
        let addHours = estLaborHours;
        
        if (isExistingInHouse) {
          const baseLaborCost = Math.round(estimate.cost * 0.6);
          const basePartsCost = estimate.cost - baseLaborCost;
          const discounted = calculateInHouseMxCost(baseLaborCost, basePartsCost, existingMechanic);
          addCost = discounted.total;
          addHours = calculateMechanicLaborHours(estLaborHours, existingMechanic);
        } else if (existingMx.use24HrOps) {
          addCost = overtimeCost;
        }
        
        closeMxScheduleModal();
        
        const providerInfo = isExistingInHouse 
          ? `<div style="color: var(--success); margin-top: 4px;">In-house: ${existingMechanic.name}</div>`
          : existingMx.use24HrOps 
            ? `<div style="color: var(--warning); margin-top: 4px;">Contract Shop (24-hr)</div>`
            : `<div style="color: var(--muted); margin-top: 4px;">Contract Shop</div>`;
        
        const confirmModalHTML = `
          <div id="mxConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
            <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 420px; width: 90%; padding: 20px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px;">ðŸ”§ Add to Existing Work Order</h3>
              
              <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 12px; font-weight: 600; color: var(--accent);">Current Job In Progress</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  ${existingMx.items?.length || 1} item(s) Â· ${Math.round(existingMx.hoursCompleted || 0)}/${existingMx.laborHours} hrs complete
                </div>
                ${providerInfo}
              </div>
              
              <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px;">${description}</div>
                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                  <span>Additional Cost:</span>
                  <span style="font-weight: 700;">${formatCurrency(addCost)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 4px;">
                  <span>Additional Labor:</span>
                  <span>${Math.round(addHours * 10) / 10} hours</span>
                </div>
              </div>
              
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 16px;">
                Work will be added to the current job with the same provider.
              </div>
              
              <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="closeMxConfirmModal()" style="flex: 1; background: var(--panel);">Cancel</button>
                <button class="btn primary" onclick="executeMxSchedule('${code}', '${mxType}', ${squawkId ? `'${squawkId}'` : 'null'})" style="flex: 1;">Add Work</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
        return;
      }
      
      // Check for available in-house mechanics
      const availableMechanics = getAvailableMechanics(code, mxType);
      
      // Calculate in-house costs for each available mechanic
      const baseLaborCost = Math.round(estimate.cost * 0.6);
      const basePartsCost = estimate.cost - baseLaborCost;
      
      let mechanicOptionsHTML = '';
      if (availableMechanics.length > 0) {
        mechanicOptionsHTML = `
          <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--success);">ðŸ”§ In-House Mechanic Available</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        let isFirst = true;
        for (const mechanic of availableMechanics) {
          const inHouseCost = calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic);
          const inHouseHours = calculateMechanicLaborHours(estLaborHours, mechanic);
          const inHouseDays = calculateMxDays(inHouseHours, false);
          const savings = estimate.cost - inHouseCost.total;
          const speedBonus = Math.round((1 - inHouseHours / estLaborHours) * 100);
          const isChecked = isFirst ? 'checked' : '';
          const borderColor = isFirst ? 'var(--success)' : 'var(--border)';
          
          mechanicOptionsHTML += `
            <label style="display: block; padding: 10px; background: var(--bg); border-radius: 6px; border: 2px solid ${borderColor}; cursor: pointer;" class="mechanic-option" data-mechanic-id="${mechanic.id}">
              <input type="radio" name="mxMechanic" value="${mechanic.id}" ${isChecked} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
              <div style="display: inline-block; vertical-align: top;">
                <div style="font-weight: 600;">${mechanic.name} <span style="font-weight: normal; color: var(--muted);">(${mechanic.experienceLevel})</span></div>
                <div style="font-size: 11px; color: var(--muted);">
                  Labor: -${Math.round(inHouseCost.laborDiscount * 100)}% Â· Parts: -${Math.round(inHouseCost.partsDiscount * 100)}% Â· Speed: +${speedBonus}%
                </div>
                <div style="font-size: 13px; margin-top: 4px;">
                  <span style="font-weight: 700; color: var(--success);">${formatCurrency(inHouseCost.total)}</span>
                  <span style="font-size: 11px; color: var(--success);">(save ${formatCurrency(savings)})</span>
                  <span style="font-size: 11px; color: var(--muted); margin-left: 8px;">${inHouseDays} day${inHouseDays !== 1 ? 's' : ''}</span>
                </div>
              </div>
            </label>
          `;
          isFirst = false;
        }
        
        mechanicOptionsHTML += `
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Or choose contract shop below:</div>
          </div>
        `;
      }
      
      // Close the existing modal first
      closeMxScheduleModal();
      
      // Create confirmation modal with 24-hr option and mechanic selection
      const confirmModalHTML = `
        <div id="mxConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 480px; width: 90%; padding: 20px; max-height: 85vh; overflow-y: auto;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">ðŸ”§ Schedule ${description}</h3>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">${aircraft?.name || code}</div>
            
            ${mechanicOptionsHTML}
            
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Contract Shop Â· Estimated Labor: ${estLaborHours} hours</div>
              
              <div style="display: flex; gap: 12px;">
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid ${availableMechanics.length === 0 ? 'var(--accent)' : 'var(--border)'}; cursor: pointer;" id="normalOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_normal" ${availableMechanics.length === 0 ? 'checked' : ''} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">Normal Ops</div>
                  <div style="font-size: 12px; color: var(--muted);">8am-6pm (10 hrs/day)</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(estimate.cost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${normalDays} day${normalDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
                
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid var(--border); cursor: pointer;" id="overtimeOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_overtime" style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">24-Hour Ops</div>
                  <div style="font-size: 12px; color: var(--warning);">+50% overtime premium</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(overtimeCost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${overtimeDays} day${overtimeDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
              </div>
            </div>
            
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 16px;">
              The aircraft will be grounded during maintenance.
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="closeMxConfirmModal()" style="flex: 1; background: var(--panel);">Cancel</button>
              <button class="btn primary" onclick="executeMxSchedule('${code}', '${mxType}', ${squawkId ? `'${squawkId}'` : 'null'})" style="flex: 1;">Schedule</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
    }
    window.confirmScheduleMx = confirmScheduleMx;
    
    function updateMxMechanicDisplay() {
      const selected = document.querySelector('input[name="mxMechanic"]:checked')?.value;
      
      // Update mechanic option borders
      document.querySelectorAll('.mechanic-option').forEach(el => {
        const mechanicId = el.dataset.mechanicId;
        el.style.borderColor = selected === mechanicId ? 'var(--success)' : 'var(--border)';
      });
      
      // Update contract option borders
      const normalLabel = document.getElementById('normalOpsLabel');
      const overtimeLabel = document.getElementById('overtimeOpsLabel');
      if (normalLabel) normalLabel.style.borderColor = selected === 'contract_normal' ? 'var(--accent)' : 'var(--border)';
      if (overtimeLabel) overtimeLabel.style.borderColor = selected === 'contract_overtime' ? 'var(--accent)' : 'var(--border)';
    }
    window.updateMxMechanicDisplay = updateMxMechanicDisplay;
    
    function closeMxConfirmModal() {
      const modal = document.getElementById('mxConfirmModal');
      if (modal) modal.remove();
    }
    window.closeMxConfirmModal = closeMxConfirmModal;
    
    function executeMxSchedule(code, mxType, squawkId) {
      const selected = document.querySelector('input[name="mxMechanic"]:checked')?.value;
      const fleetInfo = S.fleetData[code];
      const hasExistingMx = fleetInfo?.scheduledMx && fleetInfo.scheduledMx.type !== 'pending';
      
      let use24HrOps = false;
      let mechanicId = null;
      
      // If adding to existing MX, use the existing job's provider
      if (hasExistingMx) {
        mechanicId = fleetInfo.scheduledMx.mechanicId || null;
        use24HrOps = fleetInfo.scheduledMx.use24HrOps || false;
      } else if (selected === 'contract_overtime') {
        use24HrOps = true;
      } else if (selected && selected !== 'contract_normal') {
        // In-house mechanic selected
        mechanicId = selected;
      }
      
      if (scheduleMaintenance(code, mxType, { squawkId, use24HrOps, mechanicId })) {
        closeMxConfirmModal();
        render();
      } else {
        // Close modal on failure too (e.g., facility check failed)
        closeMxConfirmModal();
      }
    }
    window.executeMxSchedule = executeMxSchedule;
    
    function confirmScheduleAllSquawks(code) {
      const fleetInfo = S.fleetData[code];
      const aircraft = getAircraft(code);
      if (!fleetInfo || !fleetInfo.squawks || fleetInfo.squawks.length === 0) return;
      
      // Filter out already scheduled squawks
      const squawks = fleetInfo.squawks.filter(s => !s.scheduled);
      if (squawks.length === 0) {
        showToast('No Squawks', 'All squawks are already scheduled for repair.', 'info');
        return;
      }
      const totalCost = squawks.reduce((sum, sq) => sum + sq.cost, 0);
      const totalHours = squawks.reduce((sum, sq) => sum + (sq.laborHours || getSquawkLaborHours(sq.severity, sq.incidentType || 'other')), 0);
      
      const normalDays = calculateMxDays(totalHours, false);
      const overtimeDays = calculateMxDays(totalHours, true);
      const overtimeCost = Math.round(totalCost * SHOP_HOURS.overtimeMultiplier);
      
      // Check for available in-house mechanics (need airframe spec for squawks)
      const availableMechanics = S.staff.filter(s => 
        s.role === 'mechanic' && 
        s.status === 'available' &&
        s.mechanic?.specializations?.includes('airframe') &&
        MECHANIC_CAPABILITIES[s.experienceLevel]?.includes('squawk')
      );
      
      // Calculate in-house costs
      const baseLaborCost = Math.round(totalCost * 0.6);
      const basePartsCost = totalCost - baseLaborCost;
      
      let mechanicOptionsHTML = '';
      if (availableMechanics.length > 0) {
        mechanicOptionsHTML = `
          <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--success);">ðŸ”§ In-House Mechanic Available</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        let isFirst = true;
        for (const mechanic of availableMechanics) {
          const inHouseCost = calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic);
          const inHouseHours = calculateMechanicLaborHours(totalHours, mechanic);
          const inHouseDays = calculateMxDays(inHouseHours, false);
          const savings = totalCost - inHouseCost.total;
          const speedBonus = Math.round((1 - inHouseHours / totalHours) * 100);
          const isChecked = isFirst ? 'checked' : '';
          const borderColor = isFirst ? 'var(--success)' : 'var(--border)';
          
          mechanicOptionsHTML += `
            <label style="display: block; padding: 10px; background: var(--bg); border-radius: 6px; border: 2px solid ${borderColor}; cursor: pointer;" class="mechanic-option" data-mechanic-id="${mechanic.id}">
              <input type="radio" name="mxMechanic" value="${mechanic.id}" ${isChecked} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
              <div style="display: inline-block; vertical-align: top;">
                <div style="font-weight: 600;">${mechanic.name} <span style="font-weight: normal; color: var(--muted);">(${mechanic.experienceLevel})</span></div>
                <div style="font-size: 11px; color: var(--muted);">
                  Labor: -${Math.round(inHouseCost.laborDiscount * 100)}% Â· Parts: -${Math.round(inHouseCost.partsDiscount * 100)}% Â· Speed: +${speedBonus}%
                </div>
                <div style="font-size: 13px; margin-top: 4px;">
                  <span style="font-weight: 700; color: var(--success);">${formatCurrency(inHouseCost.total)}</span>
                  <span style="font-size: 11px; color: var(--success);">(save ${formatCurrency(savings)})</span>
                  <span style="font-size: 11px; color: var(--muted); margin-left: 8px;">${inHouseDays} day${inHouseDays !== 1 ? 's' : ''}</span>
                </div>
              </div>
            </label>
          `;
          isFirst = false;
        }
        
        mechanicOptionsHTML += `
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">Or choose contract shop below:</div>
          </div>
        `;
      }
      
      closeMxScheduleModal();
      
      const confirmModalHTML = `
        <div id="mxConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 480px; width: 90%; padding: 20px; max-height: 85vh; overflow-y: auto;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">ðŸ”§ Fix All Squawks (${squawks.length})</h3>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">${aircraft?.name || code}</div>
            
            <div style="background: var(--bg); border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 11px; max-height: 100px; overflow-y: auto;">
              ${squawks.map(sq => '<div style="margin-bottom: 4px;">â€¢ ' + sq.description + ' <span style="color: var(--muted);">(' + (sq.laborHours || getSquawkLaborHours(sq.severity, sq.incidentType || 'other')) + ' hrs)</span></div>').join('')}
            </div>
            
            ${mechanicOptionsHTML}
            
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Contract Shop Â· Total Labor: ${totalHours} hours</div>
              
              <div style="display: flex; gap: 12px;">
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid ${availableMechanics.length === 0 ? 'var(--accent)' : 'var(--border)'}; cursor: pointer;" id="normalOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_normal" ${availableMechanics.length === 0 ? 'checked' : ''} style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">Normal Ops</div>
                  <div style="font-size: 12px; color: var(--muted);">8am-6pm</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(totalCost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${normalDays} day${normalDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
                
                <label style="flex: 1; display: block; padding: 12px; background: var(--panel); border-radius: 6px; border: 2px solid var(--border); cursor: pointer;" id="overtimeOpsLabel" class="contract-option">
                  <input type="radio" name="mxMechanic" value="contract_overtime" style="margin-right: 8px;" onchange="updateMxMechanicDisplay()">
                  <div style="font-weight: 600;">24-Hour Ops</div>
                  <div style="font-size: 12px; color: var(--warning);">+50% premium</div>
                  <div style="margin-top: 8px;">
                    <div style="font-size: 16px; font-weight: 700;">${formatCurrency(overtimeCost)}</div>
                    <div style="font-size: 11px; color: var(--muted);">${overtimeDays} day${overtimeDays !== 1 ? 's' : ''}</div>
                  </div>
                </label>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn" onclick="closeMxConfirmModal()" style="flex: 1; background: var(--panel);">Cancel</button>
              <button class="btn primary" onclick="executeAllSquawksSchedule('${code}')" style="flex: 1;">Schedule All</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', confirmModalHTML);
    }
    window.confirmScheduleAllSquawks = confirmScheduleAllSquawks;
    
    function executeAllSquawksSchedule(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo || !fleetInfo.squawks || fleetInfo.squawks.length === 0) return;
      
      // Get selected option
      const selected = document.querySelector('input[name="mxMechanic"]:checked')?.value;
      
      let use24HrOps = false;
      let mechanicId = null;
      let isInHouse = false;
      
      if (selected === 'contract_overtime') {
        use24HrOps = true;
      } else if (selected && selected !== 'contract_normal') {
        // In-house mechanic selected
        mechanicId = selected;
        isInHouse = true;
      }
      
      // Filter out already scheduled squawks
      const squawks = fleetInfo.squawks.filter(s => !s.scheduled);
      if (squawks.length === 0) return;
      
      // Calculate base totals
      let totalCost = squawks.reduce((sum, sq) => sum + sq.cost, 0);
      let totalHours = squawks.reduce((sum, sq) => sum + (sq.laborHours || getSquawkLaborHours(sq.severity, sq.incidentType || 'other')), 0);
      const squawkIds = squawks.map(sq => sq.id);
      
      // Get mechanic if in-house
      const mechanic = mechanicId ? S.staff.find(s => s.id === mechanicId) : null;
      
      // Apply in-house discounts if applicable
      if (isInHouse && mechanic) {
        const baseLaborCost = Math.round(totalCost * 0.6);
        const basePartsCost = totalCost - baseLaborCost;
        const discounted = calculateInHouseMxCost(baseLaborCost, basePartsCost, mechanic);
        totalCost = discounted.total;
        totalHours = calculateMechanicLaborHours(totalHours, mechanic);
      }
      
      // Apply overtime multiplier for contract
      const finalCost = (use24HrOps && !isInHouse) ? Math.round(totalCost * SHOP_HOURS.overtimeMultiplier) : totalCost;
      const days = calculateMxDays(totalHours, use24HrOps && !isInHouse);
      
      // Check funds
      const totalFunds = S.maintenanceReserve + S.cash;
      if (totalFunds < finalCost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(finalCost)}, have ${formatCurrency(totalFunds)}`, 'warning');
        return;
      }
      
      // Calculate completion date
      const startDate = { ...S.gameTime };
      const completionDate = calculateMxCompletionDate(totalHours, use24HrOps && !isInHouse, startDate);
      
      // Deduct cost
      let remaining = finalCost;
      const mxCategory = isInHouse ? 'mx_inhouse' : 'mx_reserve';
      const inHouseTag = isInHouse ? ' [In-House]' : '';
      if (S.maintenanceReserve >= remaining) {
        S.maintenanceReserve -= remaining;
        recordTransaction(`Maintenance â€” all squawks (${getAircraft(code)?.name || code})${inHouseTag}`, -remaining, mxCategory);
      } else {
        const fromReserve = S.maintenanceReserve;
        const fromCash = remaining - fromReserve;
        S.maintenanceReserve = 0;
        S.cash -= fromCash;
        if (fromReserve > 0) {
          recordTransaction(`Maintenance â€” all squawks (${getAircraft(code)?.name || code}) [reserve]${inHouseTag}`, -fromReserve, mxCategory);
        }
        recordTransaction(`Maintenance â€” all squawks (${getAircraft(code)?.name || code})${inHouseTag}`, -fromCash, 'expense');
      }
      
      // Mark all squawks as scheduled
      squawks.forEach(sq => sq.scheduled = true);
      
      // Assign mechanic to job if in-house
      let mxJobId = null;
      if (isInHouse && mechanic) {
        mxJobId = `mx_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        assignMechanicToJob(mechanicId, mxJobId, code);
      }
      
      // Schedule the maintenance
      fleetInfo.scheduledMx = {
        type: 'squawks_all',
        startDate: startDate,
        completionDate: completionDate,
        cost: finalCost,
        laborHours: totalHours,
        hoursCompleted: 0,
        use24HrOps: use24HrOps && !isInHouse,
        mechanicId: mechanicId,
        mxJobId: mxJobId,
        details: { squawkIds, squawkCount: squawks.length },
        items: squawks.map(sq => ({
          type: 'squawk',
          description: sq.description,
          squawkId: sq.id,
          squawkSeverity: sq.severity,
          mechanicId: mechanicId
        }))
      };
      fleetInfo.mxStatus = 'grounded';
      
      // Send confirmation email
      const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const completionDateStr = `${monthNames[completionDate.month]} ${completionDate.day}`;
      const opsMode = use24HrOps && !isInHouse ? ' (24-hr operations)' : '';
      const mechanicNote = isInHouse && mechanic ? `\n\nAssigned to: ${mechanic.name} (In-House)` : '';
      addEmail({
        subject: `Maintenance Scheduled: ${getAircraft(code)?.name || code}`,
        from: 'Maintenance Department',
        company: 'Skylift Maintenance',
        body: `Your ${getAircraft(code)?.name || code} has been scheduled for ${squawks.length} squawk repairs${opsMode}.\n\n${squawks.map(sq => 'â€¢ ' + sq.description).join('\n')}\n\nTotal Cost: ${formatCurrency(finalCost)}\nTotal Labor: ${Math.round(totalHours * 10) / 10} hours\nExpected completion: ${completionDateStr}${mechanicNote}\n\nThe aircraft is grounded until maintenance is complete.`,
        type: 'notification'
      });
      
      saveState();
      closeMxConfirmModal();
      render();
    }
    window.executeAllSquawksSchedule = executeAllSquawksSchedule;

    function removeFromFleet(code) {
      if (S.gameMode !== 'sandbox') {
        alert('Aircraft can only be removed in Sandbox mode.');
        return;
      }
      
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      const warningMsg = S.fleet.length <= 1 
        ? `Remove ${aircraft.name}? This is your last aircraft - you'll only receive contract pilot jobs until you add another.`
        : `Remove ${aircraft.name} from your fleet?`;
      
      if (confirm(warningMsg)) {
        S.fleet = S.fleet.filter(c => c !== code);
        delete S.fleetData[code];
        saveState();
        render();
      }
    }
    window.removeFromFleet = removeFromFleet;
    
    function sellAircraft(code) {
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      const fleetInfo = S.fleetData[code];
      
      // Check if this is an inherited aircraft with sale restriction
      if (fleetInfo?.inheritedDate) {
        const inheritedTime = fleetInfo.inheritedDate;
        const currentTime = S.gameTime;
        const monthsSinceInheritance = (currentTime.year - inheritedTime.year) * 12 + (currentTime.month - inheritedTime.month);
        
        if (monthsSinceInheritance < 12) {
          const monthsRemaining = 12 - monthsSinceInheritance;
          alert(`This aircraft was inherited and cannot be sold for one year.\n\n${monthsRemaining} month${monthsRemaining !== 1 ? 's' : ''} remaining until you can sell.`);
          return;
        }
      }
      
      // Calculate values
      const condition = fleetInfo?.condition || 100;
      const year = fleetInfo?.year || (S.gameTime.year - 5);
      const hours = fleetInfo?.hours || 0;
      const marketValue = calculateListingPrice(code, year, condition, hours, aircraft);
      const brokerFee = Math.round(marketValue * 0.15); // 15% broker fee
      const saleProceeds = marketValue - brokerFee;
      
      // Check for loan
      const loan = S.loans?.find(l => l.aircraftCode === code);
      const loanPayoff = loan ? loan.remainingBalance : 0;
      const netToPlayer = saleProceeds - loanPayoff;
      const isUnderwater = netToPlayer < 0;
      const cashNeeded = isUnderwater ? Math.abs(netToPlayer) : 0;
      const canAfford = !isUnderwater || S.cash >= cashNeeded;
      
      const isLastAircraft = S.fleet.length <= 1;
      
      // Build modal
      const modal = document.createElement('div');
      modal.id = 'sellAircraftModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      modal.innerHTML = `
        <div style="background: var(--panel); border-radius: 12px; padding: 24px; max-width: 420px; width: 90%;">
          <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
            <span>Sell Aircraft</span>
            ${loan ? '<span style="font-size: 11px; padding: 3px 8px; background: var(--accent); color: #000; border-radius: 4px;">FINANCED</span>' : ''}
          </h3>
          
          <div style="background: var(--bg); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${year} ${aircraft.name}</div>
            ${fleetInfo?.registration ? `<div style="font-size: 12px; color: var(--muted); font-family: monospace; margin-bottom: 12px;">${fleetInfo.registration}</div>` : ''}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px; margin-bottom: 12px;">
              <div><span style="color: var(--muted);">Condition:</span> ${condition}%</div>
              <div><span style="color: var(--muted);">Hours:</span> ${hours.toLocaleString()}</div>
            </div>
            
            <!-- Sale Breakdown -->
            <div style="border-top: 1px solid var(--border); padding-top: 12px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="color: var(--muted);">Market Value</span>
                <span>${formatCurrency(marketValue)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="color: var(--muted);">Broker Fee (15%)</span>
                <span style="color: var(--danger);">-${formatCurrency(brokerFee)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px; padding-top: 6px; border-top: 1px dashed var(--border);">
                <span style="color: var(--muted);">Sale Proceeds</span>
                <span>${formatCurrency(saleProceeds)}</span>
              </div>
              ${loan ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span style="color: var(--muted);">Loan Payoff</span>
                  <span style="color: var(--danger);">-${formatCurrency(loanPayoff)}</span>
                </div>
              ` : ''}
            </div>
            
            <!-- Net Result -->
            <div style="margin-top: 12px; padding: 12px; background: ${isUnderwater ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; border-radius: 6px; text-align: center;">
              <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">
                ${isUnderwater ? 'AMOUNT YOU OWE' : 'NET PROCEEDS'}
              </div>
              <div style="font-size: 24px; font-weight: 700; color: ${isUnderwater ? 'var(--danger)' : 'var(--success)'};">
                ${isUnderwater ? '-' : ''}${formatCurrency(Math.abs(netToPlayer))}
              </div>
              ${isUnderwater ? `
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                  Your cash: ${formatCurrency(S.cash)} ${canAfford ? 'âœ“' : '(insufficient)'}
                </div>
              ` : ''}
            </div>
          </div>
          
          ${isLastAircraft ? `
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 6px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--warning);">
              âš ï¸ This is your last aircraft. You'll only receive contract pilot jobs until you purchase another.
            </div>
          ` : ''}
          
          ${!canAfford ? `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--danger);">
              âŒ Insufficient funds. You need ${formatCurrency(cashNeeded)} to pay off the loan balance.
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 12px;">
            <button class="btn" onclick="document.getElementById('sellAircraftModal').remove()" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="confirmSellAircraft('${code}')" style="flex: 1; background: var(--success); color: #000; border-color: var(--success);" ${!canAfford ? 'disabled' : ''}>
              ${isUnderwater ? `Pay ${formatCurrency(cashNeeded)} & Sell` : `Sell for ${formatCurrency(netToPlayer)}`}
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    window.sellAircraft = sellAircraft;
    
    function confirmSellAircraft(code) {
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      const fleetInfo = S.fleetData[code];
      const condition = fleetInfo?.condition || 100;
      const year = fleetInfo?.year || (S.gameTime.year - 5);
      const hours = fleetInfo?.hours || 0;
      const marketValue = calculateListingPrice(code, year, condition, hours, aircraft);
      const brokerFee = Math.round(marketValue * 0.15);
      const saleProceeds = marketValue - brokerFee;
      
      // Check for loan
      const loan = S.loans?.find(l => l.aircraftCode === code);
      const loanPayoff = loan ? loan.remainingBalance : 0;
      const netToPlayer = saleProceeds - loanPayoff;
      
      // Remove from fleet
      S.fleet = S.fleet.filter(c => c !== code);
      delete S.fleetData[code];
      
      // Handle loan payoff
      if (loan) {
        S.loans = S.loans.filter(l => l.aircraftCode !== code);
        recordTransaction(`Loan Payoff â€” ${aircraft.name}`, -loanPayoff, 'loan_principal');
      }
      
      // Record the sale (gross proceeds)
      recordTransaction(`Aircraft Sale â€” ${aircraft.name}`, saleProceeds, 'asset_sale');
      
      // Record broker fee as expense
      recordTransaction(`Broker Fee â€” ${aircraft.name}`, -brokerFee, 'broker_fee');
      
      // Adjust cash (net effect)
      S.cash += netToPlayer;
      
      // Close modal
      document.getElementById('sellAircraftModal')?.remove();
      
      // Confirmation email
      let emailBody = `Your ${year} ${aircraft.name} has been sold!\n\n`;
      emailBody += `Market Value: ${formatCurrency(marketValue)}\n`;
      emailBody += `Broker Fee (15%): -${formatCurrency(brokerFee)}\n`;
      emailBody += `Sale Proceeds: ${formatCurrency(saleProceeds)}\n`;
      if (loan) {
        emailBody += `Loan Payoff: -${formatCurrency(loanPayoff)}\n`;
      }
      emailBody += `\nNet to You: ${formatCurrency(netToPlayer)}\n`;
      emailBody += `\nFunds have been ${netToPlayer >= 0 ? 'deposited to' : 'deducted from'} your account.`;
      
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Aircraft Sales',
        company: 'Trade-A-Plane',
        subject: `Sale Complete: ${aircraft.name}`,
        body: emailBody,
        status: 'unread',
        generatedDay: S.gameTime.day,
        receivedAt: { ...S.gameTime }
      });
      
      saveState();
      render();
      showToast('Aircraft Sold', `${netToPlayer >= 0 ? '+' : ''}${formatCurrency(netToPlayer)} net proceeds`, netToPlayer >= 0 ? 'success' : 'warning');
    }
    window.confirmSellAircraft = confirmSellAircraft;
    
    function openAircraftBrowser(mode) {
      // mode: 'sandbox' (free add) or 'purchase' (costs money)
      
      // Group aircraft by category (include custom)
      const allAircraft = { ...AIRCRAFT, ...S.customAircraft };
      const grouped = {};
      Object.entries(allAircraft).forEach(([code, aircraft]) => {
        const category = aircraft.category || 'other';
        if (!grouped[category]) grouped[category] = [];
        grouped[category].push({ code, aircraft, isCustom: !!S.customAircraft[code] });
      });
      
      // Sort categories
      const categoryOrder = ['single_piston', 'multi_piston', 'turboprop', 'jet', 'helicopter', 'seaplane', 'bush', 'aerobatic', 'warbird', 'other'];
      const sortedCategories = Object.keys(grouped).sort((a, b) => {
        const aIdx = categoryOrder.indexOf(a);
        const bIdx = categoryOrder.indexOf(b);
        return (aIdx === -1 ? 99 : aIdx) - (bIdx === -1 ? 99 : bIdx);
      });
      
      let html = `
        <div id="aircraftBrowserModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
          <div style="background: var(--panel); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <h2 style="margin: 0;">${mode === 'sandbox' ? 'Add Aircraft (Sandbox)' : 'Purchase Aircraft'}</h2>
              <button onclick="closeAircraftBrowser()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 16px 20px; overflow-y: auto; flex: 1;">
              <div style="margin-bottom: 12px;">
                <input type="text" id="aircraftSearch" placeholder="Search aircraft..." oninput="filterAircraftBrowser()" style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
              <div id="aircraftBrowserList">
      `;
      
      sortedCategories.forEach(category => {
        const items = grouped[category];
        const categoryName = category.replace(/_/g, ' ').toUpperCase();
        
        html += `<div class="browser-category" data-category="${category}">
          <h3 style="font-size: 13px; color: var(--muted); margin: 16px 0 8px 0; letter-spacing: 0.5px;">${categoryName}</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
        `;
        
        items.forEach(({ code, aircraft }) => {
          const isOwned = S.fleet.includes(code);
          const price = aircraft.purchase_price || aircraft.purchasePrice || Math.round((aircraft.operating_cost || 100) * 1000);
          const canAfford = S.cash >= price;
          
          html += `
            <div class="browser-item" data-name="${aircraft.name.toLowerCase()}" data-code="${code}" 
                 style="padding: 10px; background: ${isOwned ? 'rgba(34, 197, 94, 0.1)' : 'var(--bg)'}; border: 1px solid ${isOwned ? 'var(--success)' : 'var(--border)'}; border-radius: 6px;">
              <div style="font-weight: 500; margin-bottom: 4px;">${aircraft.name}</div>
              <div style="font-size: 12px; color: var(--muted);">
                ${aircraft.cruise_speed} kts â€¢ ${aircraft.range} nm â€¢ ${aircraft.max_passengers || 0} pax
              </div>
              <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
                â›½ ${aircraft.fuel_burn_rate} gph â€¢ ðŸ’° ${formatCurrency(aircraft.operating_cost)}/hr
              </div>
              ${isOwned ? `
                <div style="margin-top: 8px; font-size: 12px; color: var(--success);">âœ“ In Fleet</div>
              ` : (mode === 'sandbox' ? `
                <button class="btn" onclick="addToFleetSandbox('${code}')" style="margin-top: 8px; width: 100%; font-size: 12px;">Add to Fleet</button>
              ` : `
                <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 12px; ${canAfford ? 'color: var(--success)' : 'color: var(--danger)'};">${formatCurrency(price)}</span>
                  <button class="btn ${canAfford ? 'primary' : ''}" onclick="purchaseAircraft('${code}', ${price})" ${!canAfford ? 'disabled' : ''} style="font-size: 11px; padding: 4px 8px;">Buy</button>
                </div>
              `)}
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      html += `
              </div>
            </div>
            <div style="padding: 12px 20px; border-top: 1px solid var(--border); text-align: right;">
              <span style="color: var(--muted); font-size: 13px; margin-right: 16px;">Cash: ${formatCurrency(S.cash)}</span>
              <button class="btn" onclick="closeAircraftBrowser()">Close</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', html);
    }
    window.openAircraftBrowser = openAircraftBrowser;
    
    function closeAircraftBrowser() {
      const modal = document.getElementById('aircraftBrowserModal');
      if (modal) modal.remove();
    }
    window.closeAircraftBrowser = closeAircraftBrowser;
    
    function filterAircraftBrowser() {
      const search = document.getElementById('aircraftSearch').value.toLowerCase();
      document.querySelectorAll('.browser-item').forEach(item => {
        const name = item.dataset.name;
        item.style.display = name.includes(search) ? 'block' : 'none';
      });
    }
    window.filterAircraftBrowser = filterAircraftBrowser;
    
    function addToFleetSandbox(code) {
      if (S.gameMode !== 'sandbox') {
        alert('Free aircraft only available in Sandbox mode.');
        return;
      }
      
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      if (S.fleet.includes(code)) {
        alert(`${aircraft.name} is already in your fleet.`);
        return;
      }
      
      S.fleet.push(code);
      S.fleetData[code] = {
        currentFuel: aircraft.fuel_capacity,
        condition: 100,
        year: S.gameTime.year,
        hours: 0,
        bookValue: 0, // Free sandbox aircraft have no book value
        acquisitionDate: { ...S.gameTime }
      };
      
      // Also add certification
      if (!S.pilot.aircraftCertifications.includes(code)) {
        S.pilot.aircraftCertifications.push(code);
      }
      
      saveState();
      closeAircraftBrowser();
      render();
      alert(`${aircraft.name} added to your fleet!`);
    }
    window.addToFleetSandbox = addToFleetSandbox;
    
    function purchaseAircraft(code, price) {
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      if (S.fleet.includes(code)) {
        alert(`${aircraft.name} is already in your fleet.`);
        return;
      }
      
      if (S.cash < price) {
        alert(`Not enough cash. Need ${formatCurrency(price)}, have ${formatCurrency(S.cash)}`);
        return;
      }
      
      if (!confirm(`Purchase ${aircraft.name} for ${formatCurrency(price)}?`)) {
        return;
      }
      
      S.cash -= price;
      S.fleet.push(code);
      S.fleetData[code] = {
        currentFuel: aircraft.fuel_capacity,
        condition: 100,
        year: S.gameTime.year,
        hours: 0,
        bookValue: price, // Book value = purchase price
        acquisitionDate: { ...S.gameTime }
      };
      
      // Also add certification
      if (!S.pilot.aircraftCertifications.includes(code)) {
        S.pilot.aircraftCertifications.push(code);
      }
      
      saveState();
      closeAircraftBrowser();
      render();
      alert(`Congratulations! ${aircraft.name} has been added to your fleet.`);
    }
    window.purchaseAircraft = purchaseAircraft;
    
    function refuelAircraft(code, gallonsToAdd) {
      const aircraft = getAircraft(code);
      const fleetInfo = S.fleetData[code];
      const maxFuelToAdd = aircraft.fuel_capacity - fleetInfo.currentFuel;
      
      if (maxFuelToAdd < 0.1) {
        showToast('Tank Full', 'Aircraft is already full.', 'info');
        return;
      }
      
      if (!gallonsToAdd || gallonsToAdd <= 0) {
        showToast('Invalid Amount', 'Please select an amount to add.', 'warning');
        return;
      }
      
      // Cap at available space
      gallonsToAdd = Math.min(gallonsToAdd, maxFuelToAdd);
      
      const fuelType = aircraft.fuel_type || '100LL';
      const fuelPrice = getEffectiveFuelPrice(fuelType);
      
      // Check if aircraft is at home base with fuel tanks
      const aircraftBase = getAircraftBase(code);
      let fromTank = 0;
      let fromFBO = gallonsToAdd;
      
      if (aircraftBase) {
        // Draw from base fuel tanks first
        const tankFuel = drawFuelFromTank(aircraftBase.id, fuelType, gallonsToAdd);
        fromTank = tankFuel;
        fromFBO = gallonsToAdd - tankFuel;
      }
      
      // Calculate cost (only pay for FBO fuel)
      const cost = Math.round(fromFBO * fuelPrice);
      
      if (S.cash < cost) {
        showToast('Insufficient Funds', `Need ${formatCurrency(cost)}, have ${formatCurrency(S.cash)}`, 'error');
        return;
      }
      
      // Deduct cost for FBO fuel only
      if (cost > 0) {
        S.cash -= cost;
        recordTransaction(`Fuel â€” ${aircraft.name}`, -cost, 'fuel');
      }
      
      fleetInfo.currentFuel += gallonsToAdd;
      
      // Cap at capacity (safety check)
      if (fleetInfo.currentFuel > aircraft.fuel_capacity) {
        fleetInfo.currentFuel = aircraft.fuel_capacity;
      }
      
      saveState();
      render();
      
      // Show toast with tank/FBO breakdown
      if (fromTank > 0 && fromFBO > 0) {
        showToast('Refueled', `+${gallonsToAdd.toFixed(1)} gal (${fromTank.toFixed(1)} from tank, ${fromFBO.toFixed(1)} @ FBO)`, 'success');
      } else if (fromTank > 0) {
        showToast('Refueled', `+${gallonsToAdd.toFixed(1)} gal from tank (free)`, 'success');
      } else {
        showToast('Refueled', `+${gallonsToAdd.toFixed(1)} gal for ${formatCurrency(cost)}`, 'success');
      }
    }
    
    function updateRefuelPreview(code, gallons, fuelPrice) {
      const amountEl = document.getElementById(`refuelAmount_${code}`);
      const costEl = document.getElementById(`refuelCost_${code}`);
      
      if (amountEl) amountEl.textContent = `${parseFloat(gallons).toFixed(0)} gal`;
      if (costEl) costEl.textContent = `Cost: ${formatCurrency(Math.round(gallons * fuelPrice))}`;
    }
    window.updateRefuelPreview = updateRefuelPreview;
    
    function updateRefuelPreviewWithTank(code, gallons, fuelPrice) {
      const amountEl = document.getElementById(`refuelAmount_${code}`);
      const costEl = document.getElementById(`refuelCost_${code}`);
      
      gallons = parseFloat(gallons);
      
      // Check tank fuel available
      const aircraft = getAircraft(code);
      const fuelType = aircraft?.fuel_type || '100LL';
      const aircraftBase = getAircraftBase(code);
      let tankFuelAvailable = 0;
      
      if (aircraftBase) {
        const tanks = aircraftBase.fuelStorage[fuelType]?.filter(t => t.status === 'operational') || [];
        tankFuelAvailable = tanks.reduce((sum, t) => sum + t.level, 0);
      }
      
      const fromTank = Math.min(tankFuelAvailable, gallons);
      const fromFBO = gallons - fromTank;
      const cost = Math.round(fromFBO * fuelPrice);
      
      if (amountEl) amountEl.textContent = `${gallons.toFixed(0)} gal`;
      
      if (costEl) {
        if (fromTank > 0 && fromFBO > 0) {
          costEl.innerHTML = `<span style="color: var(--success);">${fromTank.toFixed(0)} free</span> + ${formatCurrency(cost)}`;
        } else if (fromTank > 0) {
          costEl.innerHTML = `<span style="color: var(--success);">Free (from tank)</span>`;
        } else {
          costEl.textContent = `Cost: ${formatCurrency(cost)}`;
        }
      }
    }
    window.updateRefuelPreviewWithTank = updateRefuelPreviewWithTank;

    // ========== AIRCRAFT MARKET SYSTEM ==========
    
    // Generate a unique ID
    function generateListingId() {
      return 'listing_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // Generate tail number
    function generateTailNumber() {
      const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
      const nums = Math.floor(Math.random() * 900) + 100;
      const suffix = letters[Math.floor(Math.random() * letters.length)] + letters[Math.floor(Math.random() * letters.length)];
      return `N${nums}${suffix}`;
    }
    
    // Calculate listing price based on year and condition
    function calculateListingPrice(aircraftCode, year, condition, totalHours, aircraft) {
      const basePrice = AIRCRAFT_BASE_PRICES[aircraftCode];
      if (!basePrice) {
        console.warn('No base price for', aircraftCode);
        return 100000;
      }
      
      const currentYear = S.gameTime.year;
      const age = Math.max(0, currentYear - year);
      const segment = getPricingSegment(aircraftCode);
      
      let price = basePrice;
      
      // === SEGMENT-SPECIFIC DEPRECIATION ===
      
      if (segment === 'small') {
        // SMALL PLANES: -8% Y1, -5% Y2, -4% Y3, -2%/yr after, floor 65%
        let depreciation = 0;
        for (let y = 1; y <= age; y++) {
          if (y === 1) depreciation += 0.08;
          else if (y === 2) depreciation += 0.05;
          else if (y === 3) depreciation += 0.04;
          else depreciation += 0.02;
        }
        depreciation = Math.min(0.35, depreciation); // Floor at 65% (trainer scarcity premium)
        price = basePrice * (1 - depreciation);
        
        // Hours impact (piston TBO concerns) - reduced penalty, trainers expected to have hours
        if (totalHours <= 500) { /* no adjustment */ }
        else if (totalHours <= 1000) price *= 0.98;
        else if (totalHours <= 1500) price *= 0.96;
        else if (totalHours <= 2000) price *= 0.93;
        else price *= 0.90; // Cap at -10% (was -15%)
        
        // Condition: 60% = -12%, 80% = -5%, 90% = baseline, 100% = +3%
        // Linear interpolation: -12% at 60, 0% at 90, +3% at 100
        let conditionFactor;
        if (condition < 90) {
          conditionFactor = 1 - (0.12 * (90 - condition) / 30);
        } else {
          conditionFactor = 1 + (0.03 * (condition - 90) / 10);
        }
        price *= conditionFactor;
        
      } else if (segment === 'turbine') {
        // TURBINE: -5% Y1, -3% Y2-5, -2% Y6-10, -1% after, floor 40%
        let depreciation = 0;
        for (let y = 1; y <= age; y++) {
          if (y === 1) depreciation += 0.05;
          else if (y <= 5) depreciation += 0.03;
          else if (y <= 10) depreciation += 0.02;
          else depreciation += 0.01;
        }
        depreciation = Math.min(0.60, depreciation); // Floor at 40%
        price = basePrice * (1 - depreciation);
        
        // Hours: minimal impact for turbines
        // Condition: Â±5% range
        const conditionFactor = 0.95 + (condition - 60) * 0.00125;
        price *= conditionFactor;
        
      } else if (segment === 'big') {
        // BIG PLANES: -8% Y1-5, -6% Y6-15, -4% Y16-25, -2% Y26+, floor 20%
        let depreciation = 0;
        for (let y = 1; y <= age; y++) {
          if (y <= 5) depreciation += 0.08;
          else if (y <= 15) depreciation += 0.06;
          else if (y <= 25) depreciation += 0.04;
          else depreciation += 0.02;
        }
        depreciation = Math.min(0.80, depreciation); // Floor at 20%
        price = basePrice * (1 - depreciation);
        
        // Hours impact for big planes
        if (totalHours < 30000) { /* no adjustment */ }
        else if (totalHours < 50000) price *= 0.95;
        else price *= 0.90;
        
        // Condition: Â±5% range (commercial maintenance standards)
        const conditionFactor = 0.95 + (condition - 60) * 0.00125;
        price *= conditionFactor;
        
      } else if (segment === 'classic') {
        // CLASSIC: No depreciation - these are collectibles
        // Base price IS the current market value
        
        // Hours INVERTED: low time = premium
        if (totalHours < 500) price *= 1.15;
        else if (totalHours < 1500) price *= 1.05;
        else if (totalHours < 3000) { /* baseline */ }
        else if (totalHours < 5000) price *= 0.90;
        else price *= 0.80;
        
        // Condition is HUGE for classics
        // 60% = -35%, 70% = -20%, 80% = -10%, 90% = +5%, 95%+ = +20%
        let conditionFactor;
        if (condition < 70) {
          conditionFactor = 0.65 + (condition - 60) * 0.015; // 0.65 to 0.80
        } else if (condition < 80) {
          conditionFactor = 0.80 + (condition - 70) * 0.01; // 0.80 to 0.90
        } else if (condition < 90) {
          conditionFactor = 0.90 + (condition - 80) * 0.015; // 0.90 to 1.05
        } else if (condition < 95) {
          conditionFactor = 1.05 + (condition - 90) * 0.03; // 1.05 to 1.20
        } else {
          conditionFactor = 1.20; // Show quality
        }
        price *= conditionFactor;
      }
      
      // Small variance (Â±3%)
      price *= (0.97 + Math.random() * 0.06);
      
      return Math.round(price);
    }
    
    // Generate a single market listing
    function generateMarketListing(preferredCategories = null, forceCategory = null) {
      // Military aircraft that should NEVER appear in market (L39 is okay - civilian trainer)
      const EXCLUDED_MILITARY = ['C17', 'A400M', 'FA18E', 'A10'];
      
      // Get all aircraft codes, EXCLUDING military
      const allCodes = Object.keys(AIRCRAFT_BASE_PRICES).filter(code => {
        if (EXCLUDED_MILITARY.includes(code)) return false;
        const aircraft = getAircraft(code);
        return aircraft && !aircraft.category?.startsWith('military');
      });
      
      let availableCodes = allCodes;
      
      // Force a specific category if requested (but not military)
      if (forceCategory && !forceCategory.startsWith('military')) {
        availableCodes = allCodes.filter(code => {
          const aircraft = getAircraft(code);
          return aircraft && aircraft.category === forceCategory;
        });
        if (availableCodes.length === 0) availableCodes = allCodes;
      }
      // Filter by preferred categories if specified
      else if (preferredCategories && preferredCategories.length > 0) {
        const validCategories = preferredCategories.filter(c => !c.startsWith('military'));
        availableCodes = allCodes.filter(code => {
          const aircraft = getAircraft(code);
          return aircraft && validCategories.includes(aircraft.category);
        });
        if (availableCodes.length === 0) availableCodes = allCodes;
      }
      
      // Weight towards common aircraft types (no military)
      const weights = {
        single_piston: 4,
        bush: 2.5,
        multi_piston: 2,
        turboprop: 1.5,
        light_jet: 1,
        helicopter: 1.5,
        amphibious: 1,
        aerobatic: 1,
        airliner: 0.5,
        cargo: 0.3,
        warbird: 0.5
      };
      
      // Weighted random selection
      const weightedCodes = [];
      availableCodes.forEach(code => {
        const aircraft = getAircraft(code);
        const cat = aircraft?.category || 'single_piston';
        const weight = weights[cat] || 1;
        for (let i = 0; i < Math.ceil(weight * 10); i++) {
          weightedCodes.push(code);
        }
      });
      
      if (weightedCodes.length === 0) return null;
      
      const aircraftCode = weightedCodes[Math.floor(Math.random() * weightedCodes.length)];
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return null;
      
      // Double-check not excluded military
      if (EXCLUDED_MILITARY.includes(aircraftCode) || aircraft.category?.startsWith('military_')) return null;
      
      const category = aircraft.category || 'single_piston';
      const currentYear = S.gameTime.year;
      
      // Generate year - bias toward recent
      const prodYears = AIRCRAFT_PRODUCTION_YEARS[aircraftCode] || [2000, 2024];
      const prodStart = prodYears[0];
      const prodEnd = Math.min(prodYears[1], currentYear);
      
      let year;
      const recentStart = Math.max(prodStart, prodEnd - 12);
      if (Math.random() < 0.6 && recentStart < prodEnd) {
        year = randomInt(recentStart, prodEnd);
      } else {
        year = randomInt(prodStart, prodEnd);
      }
      
      const age = Math.max(0, currentYear - year);
      
      // Condition based on age
      let condition;
      if (age <= 3) condition = randomInt(90, 98);
      else if (age <= 10) condition = randomInt(80, 94);
      else if (age <= 25) condition = randomInt(70, 88);
      else condition = randomInt(65, 85);
      
      // HOURS - category-based calculation with physical limits
      let hoursPerYear, maxHours;
      
      switch (category) {
        case 'airliner':
        case 'cargo':
        case 'military_cargo':
          hoursPerYear = randomInt(2500, 3800);
          maxHours = 75000;
          break;
        case 'turboprop':
        case 'light_jet':
          hoursPerYear = randomInt(300, 600);
          maxHours = 15000;
          break;
        case 'helicopter':
          hoursPerYear = randomInt(200, 400);
          maxHours = 12000;
          break;
        case 'multi_piston':
          hoursPerYear = randomInt(100, 250);
          maxHours = 8000;
          break;
        default: // single_piston, bush, aerobatic, amphibious, warbird
          hoursPerYear = randomInt(50, 120);
          maxHours = 5500;
      }
      
      // Calculate base hours
      let totalHours = age * hoursPerYear;
      
      // Add variance Â±30%
      totalHours = Math.round(totalHours * (0.7 + Math.random() * 0.6));
      
      // PHYSICAL SANITY CHECK: No aircraft can exceed 4,500 hours/year (highest airline utilization ever recorded)
      const physicalMax = Math.max(50, age * 4500);
      totalHours = Math.min(physicalMax, totalHours);
      
      // Also cap at category lifetime max
      totalHours = Math.min(maxHours, totalHours);
      
      // Minimum based on age (at least some use)
      totalHours = Math.max(age * 20, totalHours);
      
      // New/demo aircraft
      if (age === 0) totalHours = randomInt(5, 80);
      
      // Debug log for first few listings
      if (S.marketListings && S.marketListings.length < 5) {
        console.log(`Generated listing: ${year} ${aircraftCode}, age=${age}, hours=${totalHours}, category=${category}`);
      }
      
      // Calculate price
      const price = calculateListingPrice(aircraftCode, year, condition, totalHours, aircraft);
      
      // Set listing duration
      const isHotDeal = Math.random() < 0.08;
      const daysListed = isHotDeal ? randomInt(7, 14) : randomInt(20, 30);
      
      const listedDate = new Date(currentYear, S.gameTime.month - 1, S.gameTime.day);
      const expiresDate = new Date(listedDate);
      expiresDate.setDate(expiresDate.getDate() + daysListed);
      
      // Calculate hours since overhaul (random 20-80% of TBO for used aircraft)
      const mxData = getMxData(aircraftCode);
      let hoursSinceOverhaul = 0;
      if (age > 0 && mxData.tbo) {
        // Random position in TBO cycle, biased toward middle
        hoursSinceOverhaul = Math.floor(mxData.tbo * (0.2 + Math.random() * 0.6));
        // Can't exceed total hours
        hoursSinceOverhaul = Math.min(hoursSinceOverhaul, totalHours);
      }
      const hoursUntilOverhaul = mxData.tbo - hoursSinceOverhaul;
      
      return {
        id: generateListingId(),
        aircraftCode,
        year,
        condition,
        totalHours,
        hoursSinceOverhaul,
        hoursUntilOverhaul,
        price,
        originalPrice: isHotDeal ? Math.round(price * 1.12) : price,
        listedDate: listedDate.toISOString().split('T')[0],
        expiresDate: expiresDate.toISOString().split('T')[0],
        isHotDeal,
        priceDrops: 0,
        registration: generateTailNumber()
      };
    }
    
    // Initialize market listings
    function initializeMarketListings() {
      if (!S.marketListings) S.marketListings = [];
      if (!S.marketLastRefresh) S.marketLastRefresh = null;
      if (!S.loans) S.loans = [];
      if (!S.leases) S.leases = [];
      
      // Only initialize if empty
      if (S.marketListings.length === 0) {
        // Generate initial 75-85 listings, weighted toward smaller aircraft (~50% more than before)
        const targetCount = randomInt(75, 85);
        
        // === GUARANTEED AFFORDABLE 4-SEAT GA PLANE ===
        // Ensure at least one financable option for new players
        const affordableGA = ['C172_SKYHAWK', 'C172_G1000', 'DA40_NG', 'DA40_TDI'];
        const guaranteedCode = affordableGA[Math.floor(Math.random() * affordableGA.length)];
        const guaranteedAircraft = getAircraft(guaranteedCode);
        if (guaranteedAircraft) {
          const condition = randomInt(70, 85);
          const conditionMultiplier = 0.5 + (condition / 100) * 0.5;
          const basePrice = AIRCRAFT_BASE_PRICES[guaranteedCode] || guaranteedAircraft.price || 150000;
          S.marketListings.push({
            id: uuid(),
            code: guaranteedCode,
            name: guaranteedAircraft.name,
            category: guaranteedAircraft.category || 'single_piston',
            condition: condition,
            hours: randomInt(1500, 3000),
            year: randomInt(2005, 2018),
            price: Math.round(basePrice * conditionMultiplier),
            listedDate: `${S.gameTime.year}-${String(S.gameTime.month).padStart(2,'0')}-${String(S.gameTime.day).padStart(2,'0')}`,
            daysOnMarket: 0
          });
        }
        
        // === FORCE SMALL AIRCRAFT (bulk of inventory) ===
        
        // 8-10 single piston
        for (let i = 0; i < randomInt(8, 10); i++) {
          const listing = generateMarketListing(null, 'single_piston');
          if (listing) S.marketListings.push(listing);
        }
        
        // 4-5 bush planes
        for (let i = 0; i < randomInt(4, 5); i++) {
          const listing = generateMarketListing(null, 'bush');
          if (listing) S.marketListings.push(listing);
        }
        
        // 3-4 multi piston
        for (let i = 0; i < randomInt(3, 4); i++) {
          const listing = generateMarketListing(null, 'multi_piston');
          if (listing) S.marketListings.push(listing);
        }
        
        // 5-6 turboprops
        for (let i = 0; i < randomInt(5, 6); i++) {
          const listing = generateMarketListing(null, 'turboprop');
          if (listing) S.marketListings.push(listing);
        }
        
        // 2-3 helicopters
        for (let i = 0; i < randomInt(2, 3); i++) {
          const listing = generateMarketListing(null, 'helicopter');
          if (listing) S.marketListings.push(listing);
        }
        
        // 2-3 aerobatic
        for (let i = 0; i < randomInt(2, 3); i++) {
          const listing = generateMarketListing(null, 'aerobatic');
          if (listing) S.marketListings.push(listing);
        }
        
        // === ASPIRATIONAL AIRCRAFT (fewer) ===
        
        // 1-2 airliners
        for (let i = 0; i < randomInt(1, 2); i++) {
          const listing = generateMarketListing(null, 'airliner');
          if (listing) S.marketListings.push(listing);
        }
        
        // 1 cargo
        const cargoListing = generateMarketListing(null, 'cargo');
        if (cargoListing) S.marketListings.push(cargoListing);
        
        // 1-2 light jets
        for (let i = 0; i < randomInt(1, 2); i++) {
          const listing = generateMarketListing(null, 'light_jet');
          if (listing) S.marketListings.push(listing);
        }
        
        // === FILL REMAINDER WITH WEIGHTED RANDOM ===
        const remainingCount = targetCount - S.marketListings.length;
        let preferredCategories = ['single_piston', 'bush', 'aerobatic', 'multi_piston', 'turboprop', 'helicopter', 'amphibious'];
        
        for (let i = 0; i < remainingCount; i++) {
          const listing = generateMarketListing(preferredCategories);
          if (listing) S.marketListings.push(listing);
        }
        
        S.marketLastRefresh = `${S.gameTime.year}-${String(S.gameTime.month).padStart(2,'0')}-${String(S.gameTime.day).padStart(2,'0')}`;
        saveState();
      }
    }
    
    // Refresh market - called on time advance
    function refreshMarketListings() {
      const currentDate = new Date(S.gameTime.year, S.gameTime.month - 1, S.gameTime.day);
      const currentDateStr = currentDate.toISOString().split('T')[0];
      
      // AI buyers purchase some listings (simulate market activity)
      const purchaseCount = randomInt(2, 5);
      const purchasedIndices = [];
      
      for (let i = 0; i < purchaseCount && S.marketListings.length > 10; i++) {
        // AI prefers good deals - listings with price drops or good condition/price ratio
        const eligibleListings = S.marketListings
          .map((l, idx) => ({ listing: l, index: idx }))
          .filter(({ listing, index }) => !purchasedIndices.includes(index));
        
        if (eligibleListings.length === 0) break;
        
        // Weight towards deals
        const weighted = eligibleListings.map(({ listing, index }) => {
          let weight = 1;
          if (listing.priceDrops > 0) weight += listing.priceDrops;
          if (listing.condition >= 90) weight += 1;
          if (listing.isHotDeal) weight += 2;
          return { listing, index, weight };
        });
        
        // Random weighted selection
        const totalWeight = weighted.reduce((sum, w) => sum + w.weight, 0);
        let roll = Math.random() * totalWeight;
        let selected = weighted[0];
        for (const w of weighted) {
          roll -= w.weight;
          if (roll <= 0) {
            selected = w;
            break;
          }
        }
        
        purchasedIndices.push(selected.index);
      }
      
      // Remove purchased listings
      S.marketListings = S.marketListings.filter((_, idx) => !purchasedIndices.includes(idx));
      
      // Check for expired listings
      const expired = [];
      const remaining = [];
      
      S.marketListings.forEach(listing => {
        if (listing.expiresDate <= currentDateStr) {
          expired.push(listing);
        } else {
          remaining.push(listing);
        }
      });
      
      // Process expired listings
      expired.forEach(listing => {
        // 30% chance to relist with price drop
        if (listing.priceDrops < 3 && Math.random() < 0.3) {
          // Price drop 5-15%
          const dropPercent = 0.05 + Math.random() * 0.1;
          listing.price = Math.round(listing.price * (1 - dropPercent));
          listing.priceDrops++;
          listing.isHotDeal = false;
          
          // New expiration
          const newExpires = new Date(currentDate);
          newExpires.setDate(newExpires.getDate() + randomInt(15, 25));
          listing.expiresDate = newExpires.toISOString().split('T')[0];
          listing.listedDate = currentDateStr;
          
          remaining.push(listing);
          
          // Maybe send deal email
          if (listing.priceDrops >= 2 || (listing.originalPrice - listing.price) / listing.originalPrice > 0.15) {
            sendPriceDropEmail(listing);
          }
        }
      });
      
      S.marketListings = remaining;
      
      // Add new listings to maintain target count
      const targetCount = randomInt(55, 65);
      const toAdd = Math.max(0, targetCount - S.marketListings.length);
      
      for (let i = 0; i < toAdd; i++) {
        const listing = generateMarketListing();
        if (listing) {
          S.marketListings.push(listing);
          
          // 10% chance to send a hot deal alert for new exceptional listings
          if (Math.random() < 0.10 && listing.condition >= 85 && listing.price < calculateListingPrice(listing.aircraftCode, listing.year, 100, listing.totalHours, getAircraft(listing.aircraftCode)) * 0.9) {
            sendHotDealEmail(listing);
          }
        }
      }
      
      S.marketLastRefresh = currentDateStr;
      saveState();
      renderMarket();
    }
    
    // Send hot deal email for new exceptional listings
    function sendHotDealEmail(listing) {
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return;
      
      const marketValue = calculateListingPrice(listing.aircraftCode, listing.year, 100, listing.totalHours, aircraft);
      const discount = Math.round((1 - listing.price / marketValue) * 100);
      
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Market Alert',
        company: 'Trade-A-Plane',
        listingId: listing.id,
        subject: `ðŸ”¥ Hot Deal: ${listing.year} ${aircraft.name} - Below Market!`,
        body: `A ${listing.year} ${aircraft.name} just listed at an exceptional price!\n\n${listing.year} ${aircraft.name} (${listing.registration})\nCondition: ${listing.condition}%\nTotal Time: ${listing.totalHours.toLocaleString()} hours\n\nAsking Price: ${formatCurrency(listing.price)}\nEstimated Market Value: ${formatCurrency(marketValue)}\nYou Save: ~${discount}%\n\nGood deals go fast - check the Market tab now!`,
        status: 'unread',
        generatedDay: S.gameTime.day,
        receivedAt: { ...S.gameTime }
      });
    }
    
    // Daily micro-refresh: small market activity to spread hot deals throughout month
    function microRefreshMarket() {
      if (!S.marketListings || S.marketListings.length === 0) return;
      
      // 1-2 AI purchases per day
      const purchaseCount = randomInt(0, 2);
      for (let i = 0; i < purchaseCount && S.marketListings.length > 15; i++) {
        const removeIdx = Math.floor(Math.random() * S.marketListings.length);
        S.marketListings.splice(removeIdx, 1);
      }
      
      // 1-3 new listings trickle in per day
      const newCount = randomInt(1, 3);
      for (let i = 0; i < newCount; i++) {
        const listing = generateMarketListing();
        if (listing) {
          S.marketListings.push(listing);
          
          // 15% chance for hot deal email on exceptional new listings
          if (Math.random() < 0.15 && listing.condition >= 85) {
            const aircraft = getAircraft(listing.aircraftCode);
            const marketValue = calculateListingPrice(listing.aircraftCode, listing.year, 100, listing.totalHours, aircraft);
            if (listing.price < marketValue * 0.88) {
              sendHotDealEmail(listing);
            }
          }
        }
      }
      
      saveState();
    }
    
    // Queue price drop email for delivery spread throughout the month
    function sendPriceDropEmail(listing) {
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return;
      
      const savings = listing.originalPrice - listing.price;
      const savingsPercent = Math.round((savings / listing.originalPrice) * 100);
      
      // Queue for delivery 1-25 days from now (spread throughout month)
      const daysAhead = randomInt(1, 25);
      const deliveryTime = addMinutes(S.gameTime, daysAhead * 24 * 60 + randomInt(480, 1080)); // Random business hours
      
      const email = {
        id: uuid(),
        type: 'notification',
        from: 'Market Alert',
        company: 'Trade-A-Plane',
        subject: `Price Drop: ${listing.year} ${aircraft.name} now ${formatCurrency(listing.price)}`,
        body: `Great news! A listing you might be interested in just dropped in price.\n\n${listing.year} ${aircraft.name} (${listing.registration})\nCondition: ${listing.condition}%\nTotal Time: ${listing.totalHours.toLocaleString()} hours\n\nOriginal Price: ${formatCurrency(listing.originalPrice)}\nNew Price: ${formatCurrency(listing.price)}\nYou Save: ${formatCurrency(savings)} (${savingsPercent}% off)\n\nThis aircraft won't last long at this price!`,
        status: 'unread',
        generatedDay: S.gameTime.day,
        receivedAt: deliveryTime,
        listingId: listing.id // Track which listing this is for
      };
      
      // Add to pending emails for future delivery
      S.pendingEmails.push(email);
    }
    
    // View a specific market listing from email link
    function viewMarketListing(listingId) {
      // Find the listing
      const listing = S.marketListings.find(l => l.id === listingId);
      
      if (!listing) {
        showToast('Listing Unavailable', 'This aircraft has been sold or removed from the market.', 'warning');
        return;
      }
      
      // Clear selected email so inbox detail closes
      S.selectedEmailId = null;
      
      // Switch RIGHT SIDEBAR to market tab (market is in right sidebar, not main tabs)
      document.querySelectorAll('.right-sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-right-tab="market"]')?.classList.add('active');
      
      document.querySelectorAll('.right-tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('market-tab')?.classList.add('active');
      
      // Force render to update everything including inbox
      render();
      
      // Force render market content specifically
      renderMarket();
      
      // Scroll to and highlight the listing after render completes
      setTimeout(() => {
        const listingEl = document.querySelector(`[data-listing-id="${listingId}"]`);
        
        if (listingEl) {
          // Scroll the listing into view
          listingEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Add highlight effect
          listingEl.style.transition = 'box-shadow 0.3s, border-color 0.3s';
          listingEl.style.boxShadow = '0 0 0 3px var(--accent)';
          listingEl.style.borderColor = 'var(--accent)';
          
          // Remove highlight after 2 seconds
          setTimeout(() => {
            listingEl.style.boxShadow = '';
            listingEl.style.borderColor = '';
          }, 2000);
        } else {
          // Listing element not found - may be filtered
          const aircraft = getAircraft(listing.aircraftCode);
          showToast('Listing Found', `${aircraft?.name || listing.aircraftCode} - check market listings`, 'info');
        }
      }, 300);
    }
    window.viewMarketListing = viewMarketListing;
    
    // Render market tab
    function renderMarket() {
      // Initialize if needed
      initializeMarketListings();
      
      const container = document.getElementById('marketListings');
      const countEl = document.querySelector('.market-count');
      
      // Get filter values
      const categoryFilter = document.getElementById('marketCategoryFilter')?.value || '';
      const priceFilter = document.getElementById('marketPriceFilter')?.value || '';
      const sortFilter = document.getElementById('marketSortFilter')?.value || 'newest';
      
      // Filter listings
      let listings = [...S.marketListings];
      
      if (categoryFilter) {
        listings = listings.filter(l => {
          const aircraft = getAircraft(l.aircraftCode);
          return aircraft && aircraft.category === categoryFilter;
        });
      }
      
      if (priceFilter) {
        const [min, max] = priceFilter.split('-').map(Number);
        listings = listings.filter(l => l.price >= min && l.price <= max);
      }
      
      // Sort
      switch (sortFilter) {
        case 'price-low':
          listings.sort((a, b) => a.price - b.price);
          break;
        case 'price-high':
          listings.sort((a, b) => b.price - a.price);
          break;
        case 'year-new':
          listings.sort((a, b) => b.year - a.year);
          break;
        case 'year-old':
          listings.sort((a, b) => a.year - b.year);
          break;
        case 'condition-high':
          listings.sort((a, b) => b.condition - a.condition);
          break;
        case 'condition-low':
          listings.sort((a, b) => a.condition - b.condition);
          break;
        case 'hours-low':
          listings.sort((a, b) => a.totalHours - b.totalHours);
          break;
        case 'hours-high':
          listings.sort((a, b) => b.totalHours - a.totalHours);
          break;
        case 'expiring':
          listings.sort((a, b) => a.expiresDate.localeCompare(b.expiresDate));
          break;
        case 'newest':
        default:
          listings.sort((a, b) => b.listedDate.localeCompare(a.listedDate));
      }
      
      // Update count
      if (countEl) {
        countEl.textContent = `${listings.length} listings`;
      }
      
      // Render listings
      if (listings.length === 0) {
        container.innerHTML = '<div class="empty-state">No listings match your filters.</div>';
      } else {
        container.innerHTML = listings.map(listing => renderMarketListing(listing)).join('');
      }
      
      // Render broker request banner
      renderBrokerRequestBanner();
      
      // Render loans/leases
      renderActiveFinancing();
    }
    
    function renderMarketListing(listing) {
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return '';
      
      const emoji = getAircraftEmoji(listing.aircraftCode);
      const isNew = listing.priceDrops === 0 && !listing.isHotDeal;
      const hasDiscount = listing.price < listing.originalPrice;
      
      // Format category
      const categoryNames = {
        'single_piston': 'Single Piston',
        'multi_piston': 'Multi Piston', 
        'turboprop': 'Turboprop',
        'light_jet': 'Light Jet',
        'airliner': 'Airliner',
        'helicopter': 'Helicopter',
        'bush': 'Bush',
        'amphibious': 'Amphibious',
        'aerobatic': 'Aerobatic',
        'warbird': 'Warbird',
        'cargo': 'Cargo',
        'military': 'Military'
      };
      const categoryDisplay = categoryNames[aircraft.category] || aircraft.category?.replace(/_/g, ' ') || 'Aircraft';
      
      // Calculate days until expiration
      const currentDate = new Date(S.gameTime.year, S.gameTime.month - 1, S.gameTime.day);
      const expiresDate = new Date(listing.expiresDate);
      const daysLeft = Math.ceil((expiresDate - currentDate) / (1000 * 60 * 60 * 24));
      
      // Get lender tier terms
      const tierTerms = getLenderTierTerms();
      const financeAmount = listing.price - Math.round(listing.price * tierTerms.downPayment);
      const canFinance = financeAmount <= tierTerms.maxFinance;
      
      // Calculate finance terms preview
      const downPayment = Math.round(listing.price * tierTerms.downPayment);
      const monthlyPayment10yr = Math.round((financeAmount * (1 + tierTerms.loanApr * 10)) / 120);
      
      // Calculate lease terms preview
      const monthlyLease = Math.round(listing.price * 0.015);
      
      // Calculate estimated monthly insurance for this aircraft
      const estimatedInsurance = getEffectiveInsuranceCost(
        calculateAircraftInsurancePremium(listing.aircraftCode, { [listing.aircraftCode]: { bookValue: listing.price } })
      );
      
      return `
        <div class="market-listing ${listing.isBrokerFind ? 'broker-find' : ''}" id="listing-${listing.id}" data-listing-id="${listing.id}" onclick="toggleListingDetails('${listing.id}')">
          <div class="listing-main">
            <div class="listing-icon">${emoji}</div>
            <div class="listing-info">
              <div class="listing-name">
                ${listing.year} ${aircraft.name}
                ${listing.isBrokerFind ? '<span class="listing-badge" style="background: var(--accent); color: #000;">Broker Find</span>' : ''}
                ${listing.isHotDeal ? '<span class="listing-badge hot">Hot Deal</span>' : ''}
                ${hasDiscount && !listing.isHotDeal ? '<span class="listing-badge reduced">Price Reduced</span>' : ''}
                ${isNew && !listing.isBrokerFind ? '<span class="listing-badge new">New</span>' : ''}
              </div>
              <div class="listing-meta">${categoryDisplay} Â· ${listing.registration} Â· ${listing.condition}% Â· ${listing.totalHours.toLocaleString()} hrs${listing.hoursUntilOverhaul ? ` Â· <span style="color: ${listing.hoursUntilOverhaul < 200 ? 'var(--warning)' : 'var(--muted)'};">${listing.hoursUntilOverhaul} to TBO</span>` : ''}</div>
              <div class="listing-specs">
                <span>${aircraft.cruise_speed} ktas</span>
                <span>${aircraft.range} nm</span>
                <span>${aircraft.max_passengers} pax</span>
              </div>
            </div>
            <div class="listing-price">
              <div class="listing-price-current">${formatCurrency(listing.price)}</div>
              ${hasDiscount ? `<div class="listing-price-original">${formatCurrency(listing.originalPrice)}</div>` : ''}
              <div class="listing-expires">${daysLeft} days left</div>
            </div>
          </div>
          
          <div class="listing-details" id="details-${listing.id}">
            <div class="listing-full-specs">
              <div class="listing-spec-item">
                <div class="listing-spec-label">Cruise Speed</div>
                <div class="listing-spec-value">${aircraft.cruise_speed} ktas</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Range</div>
                <div class="listing-spec-value">${aircraft.range} nm</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Fuel Burn</div>
                <div class="listing-spec-value">${aircraft.fuel_burn_rate} gph</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Op Cost</div>
                <div class="listing-spec-value">${formatCurrency(aircraft.operating_cost)}/hr</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Passengers</div>
                <div class="listing-spec-value">${aircraft.max_passengers}</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Cargo</div>
                <div class="listing-spec-value">${aircraft.max_cargo_lbs} lbs</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Runway</div>
                <div class="listing-spec-value">${aircraft.runway_required} ft</div>
              </div>
              <div class="listing-spec-item">
                <div class="listing-spec-label">Insurance</div>
                <div class="listing-spec-value">${formatCurrency(estimatedInsurance)}/mo</div>
              </div>
            </div>
            
            <div class="listing-acquisition">
              <div class="acquisition-option ${S.cash >= listing.price ? '' : 'disabled'}" onclick="event.stopPropagation(); selectAcquisition('${listing.id}', 'cash')">
                <div class="acquisition-title">ðŸ’µ Pay Cash</div>
                <div class="acquisition-desc">${formatCurrency(listing.price)} today</div>
              </div>
              <div class="acquisition-option ${S.cash >= downPayment && canFinance ? '' : 'disabled'}" onclick="event.stopPropagation(); selectAcquisition('${listing.id}', 'finance')">
                <div class="acquisition-title">ðŸ¦ Finance</div>
                <div class="acquisition-desc">${canFinance ? `${formatCurrency(downPayment)} down + ${formatCurrency(monthlyPayment10yr)}/mo` : `Exceeds ${formatCurrency(tierTerms.maxFinance)} limit`}</div>
              </div>
              <div class="acquisition-option ${S.cash >= monthlyLease * 2 ? '' : 'disabled'}" onclick="event.stopPropagation(); selectAcquisition('${listing.id}', 'lease')">
                <div class="acquisition-title">ðŸ“‹ Lease</div>
                <div class="acquisition-desc">${formatCurrency(monthlyLease)}/mo Â· no equity</div>
              </div>
            </div>
            
            <div class="acquisition-terms" id="terms-${listing.id}"></div>
          </div>
        </div>
      `;
    }
    
    function toggleListingDetails(listingId) {
      const card = document.getElementById(`listing-${listingId}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }
    
    function selectAcquisition(listingId, type) {
      const listing = S.marketListings.find(l => l.id === listingId);
      if (!listing) return;
      
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return;
      
      const termsEl = document.getElementById(`terms-${listingId}`);
      if (!termsEl) return;
      
      // Highlight selected option
      const card = document.getElementById(`listing-${listingId}`);
      card.querySelectorAll('.acquisition-option').forEach(opt => opt.classList.remove('selected'));
      event.target.closest('.acquisition-option').classList.add('selected');
      
      termsEl.classList.add('visible');
      
      if (type === 'cash') {
        const canAfford = S.cash >= listing.price;
        termsEl.innerHTML = `
          <div class="term-details">
            <div class="term-row">
              <span class="term-label">Purchase Price</span>
              <span class="term-value">${formatCurrency(listing.price)}</span>
            </div>
            <div class="term-row">
              <span class="term-label">Your Cash</span>
              <span class="term-value">${formatCurrency(S.cash)}</span>
            </div>
            <div class="term-row">
              <span class="term-label">After Purchase</span>
              <span class="term-value ${canAfford ? 'highlight' : ''}">${formatCurrency(S.cash - listing.price)}</span>
            </div>
          </div>
          <button class="confirm-purchase-btn" ${canAfford ? '' : 'disabled'} onclick="event.stopPropagation(); purchaseAircraft('${listingId}', 'cash')">
            ${canAfford ? 'Complete Purchase' : 'Insufficient Funds'}
          </button>
        `;
      } else if (type === 'finance') {
        const tierTerms = getLenderTierTerms();
        const financeAmount = listing.price - Math.round(listing.price * tierTerms.downPayment);
        
        // Check if exceeds max finance
        if (financeAmount > tierTerms.maxFinance) {
          termsEl.innerHTML = `
            <div style="padding: 16px; text-align: center; color: var(--danger);">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">âš ï¸ Exceeds Finance Limit</div>
              <div style="font-size: 12px; color: var(--muted);">
                This aircraft requires financing ${formatCurrency(financeAmount)}, but your ${tierTerms.name} tier only allows up to ${formatCurrency(tierTerms.maxFinance)}.
              </div>
              <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">
                Improve your financial health to unlock higher financing limits.
              </div>
            </div>
          `;
          return;
        }
        
        const terms = [
          { years: 5 },
          { years: 10 },
          { years: 15 }
        ];
        
        termsEl.innerHTML = `
          <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px; text-align: center;">
            Your tier: <strong>${tierTerms.name}</strong> â€¢ ${(tierTerms.downPayment * 100).toFixed(0)}% down â€¢ ${(tierTerms.loanApr * 100).toFixed(1)}% APR
          </div>
          <div class="term-selector">
            ${terms.map((t, i) => `
              <button class="term-btn ${i === 1 ? 'selected' : ''}" onclick="event.stopPropagation(); updateFinanceTerms('${listingId}', ${t.years})">${t.years} years</button>
            `).join('')}
          </div>
          <div id="finance-details-${listingId}"></div>
        `;
        
        updateFinanceTerms(listingId, 10);
      } else if (type === 'lease') {
        const terms = [12, 24, 36, 48];
        
        termsEl.innerHTML = `
          <div class="term-selector">
            ${terms.map((t, i) => `
              <button class="term-btn ${i === 1 ? 'selected' : ''}" onclick="event.stopPropagation(); updateLeaseTerms('${listingId}', ${t})">${t} mo</button>
            `).join('')}
          </div>
          <div id="lease-details-${listingId}"></div>
        `;
        
        updateLeaseTerms(listingId, 24);
      }
    }
    
    function updateFinanceTerms(listingId, years) {
      const listing = S.marketListings.find(l => l.id === listingId);
      if (!listing) return;
      
      const tierTerms = getLenderTierTerms();
      const rate = tierTerms.loanApr;
      
      const downPayment = Math.round(listing.price * tierTerms.downPayment);
      const financeAmount = listing.price - downPayment;
      const months = years * 12;
      const monthlyRate = rate / 12;
      const monthlyPayment = Math.round(financeAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1));
      const totalCost = downPayment + (monthlyPayment * months);
      
      const canAfford = S.cash >= downPayment;
      
      // Update button states
      const termsEl = document.getElementById(`terms-${listingId}`);
      termsEl.querySelectorAll('.term-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent.includes(years));
      });
      
      const detailsEl = document.getElementById(`finance-details-${listingId}`);
      detailsEl.innerHTML = `
        <div class="term-details">
          <div class="term-row">
            <span class="term-label">Down Payment (${(tierTerms.downPayment * 100).toFixed(0)}%)</span>
            <span class="term-value">${formatCurrency(downPayment)}</span>
          </div>
          <div class="term-row">
            <span class="term-label">Financed Amount</span>
            <span class="term-value">${formatCurrency(financeAmount)}</span>
          </div>
          <div class="term-row">
            <span class="term-label">Interest Rate</span>
            <span class="term-value">${(rate * 100).toFixed(1)}% APR</span>
          </div>
          <div class="term-row">
            <span class="term-label">Monthly Payment</span>
            <span class="term-value highlight">${formatCurrency(monthlyPayment)}</span>
          </div>
          <div class="term-row">
            <span class="term-label">Total Cost</span>
            <span class="term-value">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        <div class="term-note">You own the aircraft immediately. Missed payments may result in repossession.</div>
        <button class="confirm-purchase-btn" ${canAfford ? '' : 'disabled'} onclick="event.stopPropagation(); purchaseAircraft('${listingId}', 'finance', ${years}, ${rate})">
          ${canAfford ? 'Purchase with Financing' : 'Insufficient for Down Payment'}
        </button>
      `;
    }
    
    function updateLeaseTerms(listingId, months) {
      const listing = S.marketListings.find(l => l.id === listingId);
      if (!listing) return;
      
      // Shorter leases = higher monthly rate
      const rateMultiplier = months <= 12 ? 0.02 : months <= 24 ? 0.018 : months <= 36 ? 0.016 : 0.015;
      const monthlyPayment = Math.round(listing.price * rateMultiplier);
      const securityDeposit = monthlyPayment * 2;
      const totalCost = securityDeposit + (monthlyPayment * months);
      
      const canAfford = S.cash >= securityDeposit;
      
      // Update button states
      const termsEl = document.getElementById(`terms-${listingId}`);
      termsEl.querySelectorAll('.term-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent.includes(months));
      });
      
      const detailsEl = document.getElementById(`lease-details-${listingId}`);
      detailsEl.innerHTML = `
        <div class="term-details">
          <div class="term-row">
            <span class="term-label">Security Deposit</span>
            <span class="term-value">${formatCurrency(securityDeposit)}</span>
          </div>
          <div class="term-row">
            <span class="term-label">Monthly Payment</span>
            <span class="term-value highlight">${formatCurrency(monthlyPayment)}</span>
          </div>
          <div class="term-row">
            <span class="term-label">Term Length</span>
            <span class="term-value">${months} months</span>
          </div>
          <div class="term-row">
            <span class="term-label">Total Lease Cost</span>
            <span class="term-value">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        <div class="term-note">
          <strong>Lessor covers:</strong> Engine overhauls, major maintenance<br>
          <strong>You cover:</strong> Oil, 100hr inspections, line maintenance<br>
          Deposit returned at lease end if aircraft in good condition.
        </div>
        <button class="confirm-purchase-btn" ${canAfford ? '' : 'disabled'} onclick="event.stopPropagation(); purchaseAircraft('${listingId}', 'lease', ${months})">
          ${canAfford ? 'Start Lease' : 'Insufficient for Deposit'}
        </button>
      `;
    }
    
    function purchaseAircraft(listingId, type, termOrYears = null, rate = null) {
      const listing = S.marketListings.find(l => l.id === listingId);
      if (!listing) return;
      
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return;
      
      if (type === 'cash') {
        if (S.cash < listing.price) {
          alert('Insufficient funds!');
          return;
        }
        
        S.cash -= listing.price;
        addAircraftToFleet(listing, listing.price);
        
        // Confirmation email
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Aircraft Sales',
          company: 'Trade-A-Plane',
          subject: `Purchase Complete: ${listing.year} ${aircraft.name}`,
          body: `Congratulations on your new aircraft!\n\n${listing.year} ${aircraft.name} (${listing.registration})\nPurchase Price: ${formatCurrency(listing.price)}\nCondition: ${listing.condition}%\n\nYour aircraft has been added to your fleet and is ready to fly.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Purchase Complete!', `${aircraft.name} added to your fleet`, 'success');
        
      } else if (type === 'finance') {
        const years = termOrYears;
        const tierTerms = getLenderTierTerms();
        const downPayment = Math.round(listing.price * tierTerms.downPayment);
        
        if (S.cash < downPayment) {
          alert('Insufficient funds for down payment!');
          return;
        }
        
        const financeAmount = listing.price - downPayment;
        
        // Check max finance limit
        if (financeAmount > tierTerms.maxFinance) {
          alert(`This aircraft exceeds your ${tierTerms.name} tier financing limit of ${formatCurrency(tierTerms.maxFinance)}.`);
          return;
        }
        
        const months = years * 12;
        const monthlyRate = rate / 12;
        const monthlyPayment = Math.round(financeAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1));
        
        S.cash -= downPayment;
        addAircraftToFleet(listing, listing.price);
        
        // Create loan
        S.loans.push({
          id: 'loan_' + Date.now().toString(36),
          aircraftCode: listing.aircraftCode,
          registration: listing.registration,
          originalAmount: financeAmount,
          principal: financeAmount,
          remainingBalance: financeAmount,
          interestRate: rate,
          monthlyPayment: monthlyPayment,
          termMonths: months,
          paymentsRemaining: months,
          startDate: `${S.gameTime.year}-${String(S.gameTime.month).padStart(2,'0')}-${String(S.gameTime.day).padStart(2,'0')}`,
          missedPayments: 0
        });
        
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Aviation Finance',
          company: 'First Sky Bank',
          subject: `Financing Approved: ${listing.year} ${aircraft.name}`,
          body: `Your financing has been approved!\n\n${listing.year} ${aircraft.name} (${listing.registration})\nDown Payment: ${formatCurrency(downPayment)}\nFinanced Amount: ${formatCurrency(financeAmount)}\nMonthly Payment: ${formatCurrency(monthlyPayment)}\nTerm: ${years} years at ${(rate * 100).toFixed(1)}% APR\n\nPayments will be automatically deducted on the 1st of each month.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Financing Approved!', `${aircraft.name} added to your fleet`, 'success');
        
      } else if (type === 'lease') {
        const months = termOrYears;
        const rateMultiplier = months <= 12 ? 0.02 : months <= 24 ? 0.018 : months <= 36 ? 0.016 : 0.015;
        const monthlyPayment = Math.round(listing.price * rateMultiplier);
        const securityDeposit = monthlyPayment * 2;
        
        if (S.cash < securityDeposit) {
          alert('Insufficient funds for security deposit!');
          return;
        }
        
        S.cash -= securityDeposit;
        recordTransaction(`Lease Deposit â€” ${aircraft.name}`, -securityDeposit, 'aircraft');
        addAircraftToFleet(listing, 0); // Leased aircraft: book value = 0 (not owned)
        
        // Create lease
        S.leases.push({
          id: 'lease_' + Date.now().toString(36),
          aircraftCode: listing.aircraftCode,
          registration: listing.registration,
          monthlyPayment: monthlyPayment,
          securityDeposit: securityDeposit,
          termMonths: months,
          monthsRemaining: months,
          startDate: `${S.gameTime.year}-${String(S.gameTime.month).padStart(2,'0')}-${String(S.gameTime.day).padStart(2,'0')}`,
          returnCondition: listing.condition,
          missedPayments: 0
        });
        
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Aircraft Leasing',
          company: 'SkyLease Partners',
          subject: `Lease Active: ${listing.year} ${aircraft.name}`,
          body: `Your lease agreement is now active!\n\n${listing.year} ${aircraft.name} (${listing.registration})\nSecurity Deposit: ${formatCurrency(securityDeposit)}\nMonthly Payment: ${formatCurrency(monthlyPayment)}\nTerm: ${months} months\n\nPayments will be automatically deducted on the 1st of each month. Maintain the aircraft above ${listing.condition}% condition to receive your deposit back.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Lease Started!', `${aircraft.name} added to your fleet`, 'success');
      }
      
      // Remove listing from market
      S.marketListings = S.marketListings.filter(l => l.id !== listingId);
      
      saveState();
      render();
    }
    
    function addAircraftToFleet(listing, purchasePrice = null) {
      const aircraft = getAircraft(listing.aircraftCode);
      if (!aircraft) return;
      
      // Add to fleet if not already there
      if (!S.fleet.includes(listing.aircraftCode)) {
        S.fleet.push(listing.aircraftCode);
      }
      
      // Calculate book value: purchase price if bought, or market value if inherited/starting
      const bookValue = purchasePrice !== null 
        ? purchasePrice 
        : calculateListingPrice(listing.aircraftCode, listing.year, listing.condition, listing.totalHours || 0, aircraft);
      
      // Get MX data for initialization
      const mxData = getMxData(listing.aircraftCode);
      const hoursSinceOverhaul = listing.hoursSinceOverhaul !== undefined 
        ? listing.hoursSinceOverhaul 
        : Math.floor(mxData.tbo * (0.2 + Math.random() * 0.4)); // Random if not specified
      
      // Initialize fleet data with listing specifics
      S.fleetData[listing.aircraftCode] = {
        currentFuel: aircraft.fuel_capacity,
        condition: listing.condition,
        registration: listing.registration,
        year: listing.year,
        hours: listing.totalHours || 0,
        bookValue: bookValue,
        acquisitionDate: { ...S.gameTime },
        // MX tracking fields
        hoursSinceInspection: 0,  // Assume recently inspected at sale
        hoursSinceOverhaul: hoursSinceOverhaul,
        hoursSinceMajorService: 0,
        lastInspectionDate: { ...S.gameTime },
        mxStatus: 'airworthy',
        scheduledMx: null,
        squawks: []
      };
      
      // Show MX warning for older aircraft
      const age = S.gameTime.year - listing.year;
      if (age >= 20) {
        const recommendedRate = getRecommendedReserveRate(age);
        const currentRate = S.mxReserveRate || 15;
        if (currentRate < recommendedRate) {
          addEmail({
            subject: `Maintenance Advisory: ${aircraft.name}`,
            from: 'Maintenance Department',
            body: `Your newly acquired ${listing.year} ${aircraft.name} is ${age} years old.\n\nOlder aircraft may require additional maintenance resources. We recommend increasing your MX reserve rate from ${currentRate}% to at least ${recommendedRate}%.\n\nEngine TBO: ${mxData.tbo} hours\nHours until overhaul: ${mxData.tbo - hoursSinceOverhaul} hours\nEstimated overhaul cost: ${formatCurrency(getEffectiveMxCost(mxData.overhaulCost))}\n\nYou can adjust your MX reserve rate in the Ledger tab.`,
            type: 'info'
          });
        }
      }
    }
    
    // Update book value when condition changes (after flights, maintenance, etc.)
    function updateAircraftBookValue(code) {
      const fleetData = S.fleetData?.[code];
      if (!fleetData) return;
      
      // Skip leased aircraft (bookValue = 0, not owned)
      if (fleetData.bookValue === 0) return;
      
      const aircraft = getAircraft(code);
      if (!aircraft) return;
      
      // Recalculate book value based on current condition
      const year = fleetData.year || (S.gameTime.year - 5);
      const hours = fleetData.hours || 0;
      const condition = fleetData.condition || 100;
      
      fleetData.bookValue = calculateListingPrice(code, year, condition, hours, aircraft);
    }
    window.updateAircraftBookValue = updateAircraftBookValue;
    
    // Process monthly loan/lease payments
    // Cancel a lease early
    function cancelLease(leaseId) {
      const lease = S.leases?.find(l => l.id === leaseId);
      if (!lease) {
        alert('Lease not found.');
        return;
      }
      
      const aircraft = getAircraft(lease.aircraftCode);
      const aircraftName = aircraft?.name || lease.aircraftCode;
      
      // Early termination fee: 2 months payment (or remaining months if less)
      const earlyTermFee = Math.min(lease.monthsRemaining, 2) * lease.monthlyPayment;
      const totalCost = earlyTermFee; // Deposit is already paid and forfeited
      
      if (S.cash < earlyTermFee) {
        alert(`Insufficient funds to cancel lease.\n\nEarly termination fee: ${formatCurrency(earlyTermFee)}\nYour cash: ${formatCurrency(S.cash)}`);
        return;
      }
      
      const confirmMsg = `Cancel lease on ${aircraftName}?\n\n` +
        `Early Termination Fee: ${formatCurrency(earlyTermFee)}\n` +
        `Security Deposit Forfeited: ${formatCurrency(lease.securityDeposit)}\n` +
        `Total Loss: ${formatCurrency(earlyTermFee + lease.securityDeposit)}\n\n` +
        `The aircraft will be returned to the lessor.`;
      
      if (!confirm(confirmMsg)) return;
      
      // Deduct fee
      S.cash -= earlyTermFee;
      
      // Remove aircraft from fleet
      S.fleet = S.fleet.filter(c => c !== lease.aircraftCode);
      delete S.fleetData[lease.aircraftCode];
      
      // Remove lease
      S.leases = S.leases.filter(l => l.id !== leaseId);
      
      // Send confirmation email
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Aircraft Leasing',
        company: 'SkyLease Partners',
        subject: `Lease Terminated: ${aircraftName}`,
        body: `Your lease has been terminated early as requested.\n\n` +
          `Aircraft: ${aircraftName} (${lease.registration || 'N/A'})\n` +
          `Early Termination Fee: ${formatCurrency(earlyTermFee)}\n` +
          `Security Deposit Forfeited: ${formatCurrency(lease.securityDeposit)}\n\n` +
          `The aircraft has been returned. Thank you for your business.`,
        status: 'unread',
        generatedDay: S.gameTime.day,
        receivedAt: { ...S.gameTime }
      });
      
      showToast('Lease Cancelled', `${aircraftName} returned to lessor`, 'warning');
      
      saveState();
      render();
    }
    window.cancelLease = cancelLease;
    
    function processMonthlyFinancing() {
      // Check for any unpaid payment-due emails from previous months (process as missed)
      const overduePayments = S.emails.filter(e => 
        e.type === 'payment-due' && 
        e.status !== 'paid' &&
        e.dueMonth !== S.gameTime.month
      );
      
      overduePayments.forEach(email => {
        if (email.paymentType === 'loan') {
          const loan = S.loans.find(l => l.id === email.paymentId);
          if (loan) {
            loan.missedPayments = (loan.missedPayments || 0) + 1;
            
            if (loan.missedPayments >= 2) {
              // Repossess aircraft
              S.fleet = S.fleet.filter(c => c !== loan.aircraftCode);
              delete S.fleetData[loan.aircraftCode];
              
              S.emails.unshift({
                id: uuid(),
                type: 'notification',
                from: 'Aviation Finance',
                company: 'First Sky Bank',
                subject: `âŒ Aircraft Repossessed`,
                body: `Due to missed payments, your ${getAircraft(loan.aircraftCode)?.name || loan.aircraftCode} has been repossessed.\n\nThis has negatively impacted your credit history.`,
                status: 'unread',
                generatedDay: S.gameTime.day,
                receivedAt: { ...S.gameTime }
              });
              
              loan.paymentsRemaining = 0;
              showToast('Aircraft Repossessed', `${getAircraft(loan.aircraftCode)?.name} was repossessed`, 'error');
            }
          }
        } else if (email.paymentType === 'lease') {
          const lease = S.leases.find(l => l.id === email.paymentId);
          if (lease) {
            lease.missedPayments = (lease.missedPayments || 0) + 1;
            
            if (lease.missedPayments >= 2) {
              // Terminate lease
              S.fleet = S.fleet.filter(c => c !== lease.aircraftCode);
              delete S.fleetData[lease.aircraftCode];
              
              S.emails.unshift({
                id: uuid(),
                type: 'notification',
                from: 'Aircraft Leasing',
                company: 'SkyLease Partners',
                subject: `âŒ Lease Terminated`,
                body: `Due to missed payments, your lease for ${getAircraft(lease.aircraftCode)?.name || lease.aircraftCode} has been terminated. Your security deposit has been forfeited.`,
                status: 'unread',
                generatedDay: S.gameTime.day,
                receivedAt: { ...S.gameTime }
              });
              
              lease.monthsRemaining = 0;
              showToast('Lease Terminated', `${getAircraft(lease.aircraftCode)?.name} lease terminated`, 'error');
            }
          }
        }
        
        // Mark the overdue email as processed
        email.status = 'overdue';
        
        // Record missed payment for lender assessment
        recordPayment(email.paymentType, false);
      });
      
      // Remove overdue payment emails
      S.emails = S.emails.filter(e => e.type !== 'payment-due' || e.status === 'paid');
      
      // Clean up completed loans/leases
      S.loans = S.loans.filter(l => l.paymentsRemaining > 0 && l.remainingBalance > 0);
      S.leases = S.leases.filter(l => l.monthsRemaining > 0);
      
      // Send new payment due emails for this month
      let emailsSent = 0;
      
      S.loans.forEach(loan => {
        if (loan.paymentsRemaining > 0) {
          const aircraft = getAircraft(loan.aircraftCode);
          const aircraftName = aircraft?.name || loan.aircraftCode;
          
          S.emails.unshift({
            id: uuid(),
            type: 'payment-due',
            paymentType: 'loan',
            paymentId: loan.id,
            from: 'First Sky Bank',
            company: 'Aviation Finance',
            subject: `ðŸ’³ Loan Payment Due - ${aircraftName}`,
            aircraftCode: loan.aircraftCode,
            aircraftName: aircraftName,
            monthlyPayment: loan.monthlyPayment,
            remainingBalance: loan.remainingBalance,
            paymentsRemaining: loan.paymentsRemaining,
            status: 'unread',
            dueMonth: S.gameTime.month,
            dueYear: S.gameTime.year,
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          });
          emailsSent++;
        }
      });
      
      S.leases.forEach(lease => {
        if (lease.monthsRemaining > 0) {
          const aircraft = getAircraft(lease.aircraftCode);
          const aircraftName = aircraft?.name || lease.aircraftCode;
          
          S.emails.unshift({
            id: uuid(),
            type: 'payment-due',
            paymentType: 'lease',
            paymentId: lease.id,
            from: 'SkyLease Partners',
            company: 'Aircraft Leasing',
            subject: `ðŸ’³ Lease Payment Due - ${aircraftName}`,
            aircraftCode: lease.aircraftCode,
            aircraftName: aircraftName,
            monthlyPayment: lease.monthlyPayment,
            monthsRemaining: lease.monthsRemaining,
            status: 'unread',
            dueMonth: S.gameTime.month,
            dueYear: S.gameTime.year,
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          });
          emailsSent++;
        }
      });
      
      return emailsSent;
    }
    
    function makeFinancingPayment(emailId, extraAmount = 0) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email || email.type !== 'payment-due') return;
      
      const totalPayment = email.monthlyPayment + extraAmount;
      
      if (S.cash < totalPayment) {
        alert(`Insufficient funds.\n\nPayment needed: ${formatCurrency(totalPayment)}\nYour cash: ${formatCurrency(S.cash)}`);
        return;
      }
      
      S.cash -= totalPayment;
      
      if (email.paymentType === 'loan') {
        const loan = S.loans.find(l => l.id === email.paymentId);
        if (loan) {
          // Calculate principal vs interest with difficulty multiplier
          const effectiveRate = getEffectiveInterestRate(loan.interestRate);
          const interestPayment = Math.round(loan.remainingBalance * (effectiveRate / 12));
          const principalPayment = (email.monthlyPayment - interestPayment) + extraAmount;
          loan.remainingBalance = Math.max(0, loan.remainingBalance - principalPayment);
          loan.paymentsRemaining--;
          loan.missedPayments = 0;
          
          recordTransaction(`Loan Payment â€” ${email.aircraftName}`, -totalPayment, 'loan_payment');
          
          if (loan.paymentsRemaining === 0 || loan.remainingBalance <= 0) {
            S.loans = S.loans.filter(l => l.id !== loan.id);
            showToast('Loan Paid Off!', `${email.aircraftName} is now fully owned`, 'success');
          } else {
            showToast('Payment Made', `${formatCurrency(totalPayment)} applied to ${email.aircraftName}`, 'success');
          }
        }
      } else if (email.paymentType === 'lease') {
        const lease = S.leases.find(l => l.id === email.paymentId);
        if (lease) {
          lease.monthsRemaining--;
          lease.missedPayments = 0;
          
          recordTransaction(`Lease Payment â€” ${email.aircraftName}`, -totalPayment, 'lease_payment');
          
          if (lease.monthsRemaining === 0) {
            // Return aircraft, check condition for deposit
            S.fleet = S.fleet.filter(c => c !== lease.aircraftCode);
            const fleetInfo = S.fleetData[lease.aircraftCode];
            const currentCondition = fleetInfo?.condition || 0;
            
            if (currentCondition >= lease.returnCondition) {
              S.cash += lease.securityDeposit;
              showToast('Lease Complete', `${email.aircraftName} returned. Deposit refunded!`, 'success');
            } else {
              showToast('Lease Complete', `${email.aircraftName} returned. Deposit forfeited.`, 'warning');
            }
            
            delete S.fleetData[lease.aircraftCode];
            S.leases = S.leases.filter(l => l.id !== lease.id);
          } else {
            showToast('Payment Made', `${formatCurrency(totalPayment)} applied to ${email.aircraftName} lease`, 'success');
          }
        }
      }
      
      // Mark email as paid
      email.status = 'paid';
      
      // Record on-time payment for lender assessment
      recordPayment(email.paymentType, true);
      
      saveState();
      render();
    }
    window.makeFinancingPayment = makeFinancingPayment;
    
    function makeExtraPayment(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      const maxExtra = email.paymentType === 'loan' 
        ? (S.loans.find(l => l.id === email.paymentId)?.remainingBalance || 0) - email.monthlyPayment
        : 0;
      
      const amount = prompt(
        `Make extra payment on ${email.aircraftName}\n\n` +
        `Regular payment: ${formatCurrency(email.monthlyPayment)}\n` +
        `Your cash: ${formatCurrency(S.cash)}\n` +
        (email.paymentType === 'loan' ? `Remaining balance: ${formatCurrency(email.remainingBalance)}\n` : '') +
        `\nEnter EXTRA amount to add to regular payment:`,
        Math.min(S.cash - email.monthlyPayment, maxExtra > 0 ? maxExtra : 1000)
      );
      
      if (amount === null) return;
      
      const extra = parseInt(amount);
      if (isNaN(extra) || extra < 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      makeFinancingPayment(emailId, extra);
    }
    window.makeExtraPayment = makeExtraPayment;
    
    function skipPayment(emailId) {
      const email = S.emails.find(e => e.id === emailId);
      if (!email) return;
      
      if (!confirm(
        `Skip this month's payment for ${email.aircraftName}?\n\n` +
        `âš ï¸ This will count as a missed payment.\n` +
        `Two missed payments will result in repossession/termination.`
      )) return;
      
      // Mark as skipped (will be processed as overdue next month)
      email.status = 'skipped';
      
      if (email.paymentType === 'loan') {
        const loan = S.loans.find(l => l.id === email.paymentId);
        if (loan) loan.missedPayments = (loan.missedPayments || 0) + 1;
      } else {
        const lease = S.leases.find(l => l.id === email.paymentId);
        if (lease) lease.missedPayments = (lease.missedPayments || 0) + 1;
      }
      
      showToast('Payment Skipped', `This counts as a missed payment`, 'warning');
      
      saveState();
      render();
    }
    window.skipPayment = skipPayment;
    
    function processLOCInterest() {
      const loc = S.lineOfCredit;
      if (!loc || loc.balance <= 0) return 0;
      
      // Calculate monthly interest (APR / 12) with difficulty multiplier
      let effectiveApr = getEffectiveInterestRate(loc.apr || 0.06);
      
      // Apply accountant APR reduction
      const aprReduction = getAccountantLocReduction();
      if (aprReduction > 0) {
        effectiveApr = Math.max(0.01, effectiveApr - aprReduction); // Min 1% APR
      }
      
      const monthlyRate = effectiveApr / 12;
      const interest = Math.round(loc.balance * monthlyRate);
      
      if (interest > 0) {
        loc.balance += interest;
        recordTransaction(`LOC Interest (${(effectiveApr * 100).toFixed(1)}% APR)`, -interest, 'interest');
        
        // Calculate minimum payment
        const minPayment = Math.max(100, Math.round(loc.balance * (loc.minPaymentPct || 0.05)));
        
        // Send payment reminder email
        S.emails.unshift({
          id: uuid(),
          type: 'payment_due',
          from: 'First Sky Bank',
          company: 'Line of Credit',
          subject: `LOC Statement â€” Minimum Payment Due`,
          body: `Your monthly Line of Credit statement is ready.\n\n` +
                `Current Balance: ${formatCurrency(loc.balance)}\n` +
                `Interest Charged: ${formatCurrency(interest)} (${(effectiveApr * 100).toFixed(1)}% APR)\n` +
                `Minimum Payment Due: ${formatCurrency(minPayment)}\n` +
                `Credit Limit: ${formatCurrency(loc.limit)}\n` +
                `Available Credit: ${formatCurrency(Math.max(0, loc.limit - loc.balance))}\n\n` +
                `Please make at least the minimum payment to keep your account in good standing. You can make payments from the Ledger tab.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime },
          locMinPayment: minPayment
        });
        
        // Check if over limit
        if (loc.balance > loc.limit) {
          S.emails.unshift({
            id: uuid(),
            type: 'notification',
            from: 'First Sky Bank',
            company: 'Line of Credit',
            subject: `âš ï¸ Credit Limit Exceeded`,
            body: `Your line of credit balance (${formatCurrency(loc.balance)}) has exceeded your limit (${formatCurrency(loc.limit)}) due to accrued interest.\n\nPlease make a payment immediately to bring your balance below the limit.`,
            status: 'unread',
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          });
        }
      }
      
      return interest;
    }
    
    function processOwnerSalary() {
      const owner = S.ownerCompensation;
      if (!owner || owner.monthlySalary <= 0) return 0;
      
      const salary = owner.monthlySalary;
      
      if (S.cash >= salary) {
        S.cash -= salary;
        owner.ytdDraws = (owner.ytdDraws || 0) + salary;
        owner.allTimeDraws = (owner.allTimeDraws || 0) + salary;
        recordTransaction('Owner Salary', -salary, 'salary');
      } else {
        // Insufficient funds - take what's available or draw from LOC
        const available = S.cash;
        const shortfall = salary - available;
        
        // Try to cover shortfall from LOC
        const loc = S.lineOfCredit;
        const locAvailable = loc ? loc.limit - loc.balance : 0;
        
        if (locAvailable >= shortfall) {
          // Draw from LOC to cover
          loc.balance += shortfall;
          S.cash = 0;
          owner.ytdDraws = (owner.ytdDraws || 0) + salary;
          owner.allTimeDraws = (owner.allTimeDraws || 0) + salary;
          recordTransaction('Owner Salary', -salary, 'salary');
          recordTransaction('LOC Draw (auto - salary coverage)', shortfall, 'loc');
          
          S.emails.unshift({
            id: uuid(),
            type: 'notification',
            from: 'Accounting',
            company: 'Internal',
            subject: `Owner Salary - LOC Draw Required`,
            body: `Your monthly salary of ${formatCurrency(salary)} exceeded available cash.\n\n${formatCurrency(shortfall)} was automatically drawn from your line of credit to cover the shortfall.`,
            status: 'unread',
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          });
        } else {
          // Can't cover - partial payment
          const partialAmount = available + locAvailable;
          S.cash = 0;
          if (loc && locAvailable > 0) {
            loc.balance += locAvailable;
          }
          owner.ytdDraws = (owner.ytdDraws || 0) + partialAmount;
          owner.allTimeDraws = (owner.allTimeDraws || 0) + partialAmount;
          
          if (partialAmount > 0) {
            recordTransaction(`Owner Salary (partial)`, -partialAmount, 'salary');
          }
          
          S.emails.unshift({
            id: uuid(),
            type: 'notification',
            from: 'Accounting',
            company: 'Internal',
            subject: `âš ï¸ Owner Salary - Insufficient Funds`,
            body: `Unable to process full monthly salary of ${formatCurrency(salary)}.\n\nPartial payment: ${formatCurrency(partialAmount)}\nShortfall: ${formatCurrency(salary - partialAmount)}\n\nConsider generating more revenue or adjusting your salary.`,
            status: 'unread',
            generatedDay: S.gameTime.day,
            receivedAt: { ...S.gameTime }
          });
          
          return partialAmount;
        }
      }
      
      return salary;
    }
    
    // === LENDER ASSESSMENT SYSTEM ===
    
    function getLenderTierTerms(tier = null) {
      const currentTier = tier || S.lenderAssessment?.tier || 'startup';
      return LENDER_TIERS[currentTier] || LENDER_TIERS.startup;
    }
    
    function calculateLenderMetrics() {
      // Calculate DSCR (Debt Service Coverage Ratio)
      // DSCR = Monthly Net Operating Income / Monthly Debt Payments
      const monthlyRevenue = S.financials?.revenueThisMonth || 0;
      const monthlyExpenses = S.financials?.expensesThisMonth || 0;
      const monthlyNetIncome = monthlyRevenue - monthlyExpenses;
      
      // Calculate total monthly debt payments
      let monthlyDebtPayments = 0;
      (S.loans || []).forEach(loan => {
        monthlyDebtPayments += loan.monthlyPayment || 0;
      });
      (S.leases || []).forEach(lease => {
        monthlyDebtPayments += lease.monthlyPayment || 0;
      });
      // LOC minimum payment if balance exists
      if (S.lineOfCredit?.balance > 0) {
        const locMinPayment = Math.max(100, S.lineOfCredit.balance * (S.lineOfCredit.minPaymentPct || 0.05));
        monthlyDebtPayments += locMinPayment;
      }
      
      const dscr = monthlyDebtPayments > 0 ? monthlyNetIncome / monthlyDebtPayments : 999;
      
      // Calculate Leverage Ratio (Total Debt / Total Equity)
      // Note: Operating leases are NOT debt - they're just monthly expenses
      let totalDebt = S.lineOfCredit?.balance || 0;
      (S.loans || []).forEach(loan => {
        totalDebt += loan.remainingBalance || 0;
      });
      
      // Calculate total assets (leased aircraft not included - we don't own them)
      let fleetValue = 0;
      (S.fleet || []).forEach(code => {
        const data = S.fleetData?.[code];
        const isLeased = (S.leases || []).some(l => l.aircraftCode === code);
        if (data && data.bookValue && !isLeased) {
          fleetValue += data.bookValue;
        }
      });
      const totalAssets = S.cash + (S.maintenanceReserve || 0) + fleetValue;
      const totalEquity = totalAssets - totalDebt;
      const leverageRatio = totalEquity > 0 ? totalDebt / totalEquity : 999;
      
      // Calculate Cash Reserve (months of operating expenses on hand)
      // Use all-time average if available, otherwise this month, otherwise estimate
      const monthsInBiz = Math.max(1, S.lenderAssessment?.monthsInBusiness || 1);
      const allTimeExpenses = S.financials?.expensesAllTime || 0;
      let avgMonthlyExpenses;
      if (allTimeExpenses > 0 && monthsInBiz > 0) {
        avgMonthlyExpenses = allTimeExpenses / monthsInBiz;
      } else if (monthlyExpenses > 0) {
        avgMonthlyExpenses = monthlyExpenses;
      } else {
        // Estimate based on owner salary + basic ops
        avgMonthlyExpenses = (S.ownerCompensation?.monthlySalary || 4000) + 1000;
      }
      const cashReserveMonths = S.cash / avgMonthlyExpenses;
      
      return {
        dscr: Math.round(dscr * 100) / 100,
        leverageRatio: Math.round(leverageRatio * 100) / 100,
        cashReserveMonths: Math.round(cashReserveMonths * 10) / 10,
        totalDebt,
        totalAssets,
        totalEquity,
        monthlyDebtPayments
      };
    }
    
    function determineLenderTier(metrics, assessment) {
      const months = assessment.monthsInBusiness || 0;
      const missed = assessment.missedPayments || 0;
      const { dscr, leverageRatio } = metrics;
      
      // Check tiers from highest to lowest
      if (months >= 36 && dscr >= 1.75 && leverageRatio <= 1.5 && missed === 0) {
        return 'premier';
      }
      if (months >= 24 && dscr >= 1.5 && leverageRatio <= 2.0) {
        return 'strong';
      }
      if (months >= 12 && dscr >= 1.25 && leverageRatio <= 3.0) {
        return 'established';
      }
      if (months >= 6 && dscr >= 1.0 && missed <= 2) {
        return 'developing';
      }
      return 'startup';
    }
    
    function calculateLenderAssessment() {
      // Initialize if needed
      if (!S.lenderAssessment) {
        S.lenderAssessment = {
          tier: 'startup',
          monthsInBusiness: 0,
          onTimePayments: 0,
          missedPayments: 0,
          lastCalculated: null,
          dscr: 0,
          leverageRatio: 0,
          cashReserveMonths: 0
        };
      }
      
      const oldTier = S.lenderAssessment.tier;
      
      // Calculate metrics
      const metrics = calculateLenderMetrics();
      
      // Update cached metrics
      S.lenderAssessment.dscr = metrics.dscr;
      S.lenderAssessment.leverageRatio = metrics.leverageRatio;
      S.lenderAssessment.cashReserveMonths = metrics.cashReserveMonths;
      S.lenderAssessment.lastCalculated = { ...S.gameTime };
      
      // Determine tier
      const newTier = determineLenderTier(metrics, S.lenderAssessment);
      S.lenderAssessment.tier = newTier;
      
      // Update LOC APR based on tier (limit is set by scenario/collateral, not tier)
      const tierTerms = getLenderTierTerms(newTier);
      S.lineOfCredit.apr = tierTerms.loanApr; // APR improves with tier
      
      // Send email if tier changed
      if (newTier !== oldTier && oldTier) {
        const improved = getTierRank(newTier) > getTierRank(oldTier);
        const oldTerms = LENDER_TIERS[oldTier];
        const newTerms = LENDER_TIERS[newTier];
        
        S.emails.unshift({
          id: uuid(),
          type: 'credit-assessment',
          from: 'First Sky Bank',
          company: 'Business Lending',
          subject: `Credit Assessment ${improved ? 'Upgraded' : 'Downgraded'}: ${newTerms.name}`,
          body: `Your business financial health has been reassessed.\n\n` +
                `Previous Tier: ${oldTerms.name}\n` +
                `Current Tier: ${newTerms.name} ${improved ? 'â–²' : 'â–¼'}\n\n` +
                `Updated Terms:\n` +
                `â€¢ LOC/Loan APR: ${(newTerms.loanApr * 100).toFixed(1)}%\n` +
                `â€¢ Down Payment Required: ${(newTerms.downPayment * 100).toFixed(0)}%\n` +
                `â€¢ Maximum Financing: ${formatCurrency(newTerms.maxFinance)}\n\n` +
                (improved ? 
                  `Congratulations on improving your financial standing!` :
                  `We encourage you to focus on improving your financial metrics to regain better terms.`),
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime },
          tierChange: { from: oldTier, to: newTier, improved }
        });
      }
      
      return { oldTier, newTier, metrics };
    }
    
    function getTierRank(tier) {
      const ranks = { startup: 1, developing: 2, established: 3, strong: 4, premier: 5 };
      return ranks[tier] || 0;
    }
    
    function recordPayment(type, onTime) {
      if (!S.lenderAssessment) {
        S.lenderAssessment = {
          tier: 'startup',
          monthsInBusiness: 0,
          onTimePayments: 0,
          missedPayments: 0
        };
      }
      
      if (onTime) {
        S.lenderAssessment.onTimePayments++;
      } else {
        S.lenderAssessment.missedPayments++;
      }
    }
    
    function getNextTierRequirements() {
      const currentTier = S.lenderAssessment?.tier || 'startup';
      const months = S.lenderAssessment?.monthsInBusiness || 0;
      const missed = S.lenderAssessment?.missedPayments || 0;
      const metrics = calculateLenderMetrics();
      
      const nextTiers = {
        startup: 'developing',
        developing: 'established',
        established: 'strong',
        strong: 'premier',
        premier: null
      };
      
      const nextTier = nextTiers[currentTier];
      if (!nextTier) return null;
      
      const reqs = LENDER_TIERS[nextTier].requirements;
      const requirements = [];
      
      if (reqs.monthsInBusiness && months < reqs.monthsInBusiness) {
        requirements.push(`${reqs.monthsInBusiness - months} more months in business`);
      }
      if (reqs.dscr && metrics.dscr < reqs.dscr) {
        requirements.push(`DSCR of ${reqs.dscr}+ (currently ${metrics.dscr})`);
      }
      if (reqs.leverageMax && metrics.leverageRatio > reqs.leverageMax) {
        requirements.push(`Leverage ratio under ${reqs.leverageMax} (currently ${metrics.leverageRatio})`);
      }
      if (reqs.missedPaymentsMax !== undefined && missed > reqs.missedPaymentsMax) {
        requirements.push(`Max ${reqs.missedPaymentsMax} missed payments (you have ${missed})`);
      }
      
      return {
        nextTier: LENDER_TIERS[nextTier].name,
        requirements
      };
    }
    
    window.getLenderTierTerms = getLenderTierTerms;
    window.calculateLenderAssessment = calculateLenderAssessment;
    window.getNextTierRequirements = getNextTierRequirements;
    
    function renderActiveFinancing() {
      const loansSection = document.getElementById('activeLoansSection');
      const leasesSection = document.getElementById('activeLeasesSection');
      const loansContainer = document.getElementById('activeLoans');
      const leasesContainer = document.getElementById('activeLeases');
      
      if (!loansSection || !leasesSection) return;
      
      // Render loans
      if (S.loans && S.loans.length > 0) {
        loansSection.style.display = 'block';
        loansContainer.innerHTML = S.loans.map(loan => {
          const aircraft = getAircraft(loan.aircraftCode);
          const paidPercent = ((loan.termMonths - loan.paymentsRemaining) / loan.termMonths * 100).toFixed(0);
          
          return `
            <div class="finance-card">
              <div class="finance-card-header">
                <span class="finance-card-aircraft">${aircraft?.name || loan.aircraftCode}</span>
                <span class="finance-card-type">LOAN</span>
              </div>
              <div class="finance-card-details">
                <div class="finance-detail">
                  <span class="finance-detail-label">Monthly</span>
                  <span class="finance-detail-value">${formatCurrency(loan.monthlyPayment)}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Remaining</span>
                  <span class="finance-detail-value">${formatCurrency(loan.remainingBalance)}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Payments Left</span>
                  <span class="finance-detail-value">${loan.paymentsRemaining}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Rate</span>
                  <span class="finance-detail-value">${(loan.interestRate * 100).toFixed(1)}%</span>
                </div>
              </div>
              <div class="finance-progress">
                <div class="finance-progress-bar" style="width: ${paidPercent}%"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        loansSection.style.display = 'none';
      }
      
      // Render leases
      if (S.leases && S.leases.length > 0) {
        leasesSection.style.display = 'block';
        leasesContainer.innerHTML = S.leases.map(lease => {
          const aircraft = getAircraft(lease.aircraftCode);
          const usedPercent = ((lease.termMonths - lease.monthsRemaining) / lease.termMonths * 100).toFixed(0);
          
          return `
            <div class="finance-card">
              <div class="finance-card-header">
                <span class="finance-card-aircraft">${aircraft?.name || lease.aircraftCode}</span>
                <span class="finance-card-type" style="background: var(--warning);">LEASE</span>
              </div>
              <div class="finance-card-details">
                <div class="finance-detail">
                  <span class="finance-detail-label">Monthly</span>
                  <span class="finance-detail-value">${formatCurrency(lease.monthlyPayment)}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Deposit</span>
                  <span class="finance-detail-value">${formatCurrency(lease.securityDeposit)}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Months Left</span>
                  <span class="finance-detail-value">${lease.monthsRemaining}</span>
                </div>
                <div class="finance-detail">
                  <span class="finance-detail-label">Return Cond.</span>
                  <span class="finance-detail-value">${lease.returnCondition}%</span>
                </div>
              </div>
              <div class="finance-progress">
                <div class="finance-progress-bar" style="width: ${usedPercent}%; background: var(--warning);"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        leasesSection.style.display = 'none';
      }
    }
    
    // Custom Aircraft Modal functions
    function showCustomAircraftModal() {
      document.getElementById('customAircraftModal').classList.remove('hidden');
    }
    
    function hideCustomAircraftModal() {
      document.getElementById('customAircraftModal').classList.add('hidden');
      // Clear form
      document.querySelectorAll('#customAircraftModal input').forEach(input => input.value = '');
      document.querySelectorAll('#customAircraftModal input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.id === 'customSurfacePaved';
      });
    }
    
    function saveCustomAircraft() {
      const name = document.getElementById('customName').value.trim();
      if (!name) {
        alert('Please enter an aircraft name.');
        return;
      }
      
      // Generate a code from the name
      const code = 'CUSTOM_' + name.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 20);
      
      // Check for duplicate
      if (AIRCRAFT[code] || S.customAircraft[code]) {
        alert('An aircraft with this name already exists.');
        return;
      }
      
      // Gather surfaces
      const surfaces = [];
      if (document.getElementById('customSurfacePaved').checked) surfaces.push('paved');
      if (document.getElementById('customSurfaceGrass').checked) surfaces.push('grass');
      if (document.getElementById('customSurfaceGravel').checked) surfaces.push('gravel');
      if (document.getElementById('customSurfaceDirt').checked) surfaces.push('dirt');
      if (document.getElementById('customSurfaceWater').checked) surfaces.push('water');
      
      if (surfaces.length === 0) surfaces.push('paved');
      
      // Build aircraft object
      const cruiseSpeed = parseInt(document.getElementById('customCruiseSpeed').value) || 120;
      const fuelBurn = parseFloat(document.getElementById('customFuelBurn').value) || 9;
      
      const aircraft = {
        name: name,
        category: document.getElementById('customCategory').value || 'single_piston',
        fuel_type: document.getElementById('customFuelType').value || '100LL',
        fuel_capacity: parseInt(document.getElementById('customFuelCapacity').value) || 50,
        fuel_burn_rate: fuelBurn,
        cruise_speed: cruiseSpeed,
        range: parseInt(document.getElementById('customRange').value) || 500,
        operating_cost: parseInt(document.getElementById('customOperatingCost').value) || Math.round(fuelBurn * 8 + cruiseSpeed * 0.3),
        max_passengers: parseInt(document.getElementById('customPassengers').value) || 3,
        max_cargo_lbs: parseInt(document.getElementById('customCargo').value) || 200,
        runway_required: parseInt(document.getElementById('customRunway').value) || 1500,
        surfaces: surfaces,
        avionics: document.getElementById('customAvionics').value || 'VFR',
        isCustom: true
      };
      
      // Add to custom aircraft
      S.customAircraft[code] = aircraft;
      
      // Optionally charge if price specified
      const price = parseInt(document.getElementById('customPrice').value);
      let bookValue = 0;
      
      if (price && price > 0 && S.gameMode !== 'sandbox') {
        if (S.cash < price) {
          alert(`Insufficient funds. You need ${formatCurrency(price)}.`);
          delete S.customAircraft[code];
          return;
        }
        S.cash -= price;
        bookValue = price;
      }
      
      // Add to fleet
      S.fleet.push(code);
      S.fleetData[code] = {
        currentFuel: aircraft.fuel_capacity,
        condition: parseInt(document.getElementById('customCondition').value) || 100,
        year: parseInt(document.getElementById('customYear').value) || 2020,
        hours: 0,
        bookValue: bookValue,
        acquisitionDate: { ...S.gameTime }
      };
      
      hideCustomAircraftModal();
      saveState();
      render();
      
      showToast('Aircraft Added!', `${name} has been added to your fleet.`, 'success');
    }
    
    function filterMarketListings() {
      renderMarket();
    }
    
    // Export functions
    window.toggleListingDetails = toggleListingDetails;
    window.selectAcquisition = selectAcquisition;
    window.updateFinanceTerms = updateFinanceTerms;
    window.updateLeaseTerms = updateLeaseTerms;
    window.purchaseAircraft = purchaseAircraft;
    window.showCustomAircraftModal = showCustomAircraftModal;
    window.hideCustomAircraftModal = hideCustomAircraftModal;
    window.saveCustomAircraft = saveCustomAircraft;
    window.filterMarketListings = filterMarketListings;
    window.refreshMarketListings = refreshMarketListings;
    
    // Debug function to force-regenerate market
    window.forceRegenerateMarket = function() {
      console.log('Force regenerating market...');
      S.marketListings = [];
      S.marketLastRefresh = null;
      initializeMarketListings();
      renderMarket();
      saveState();
      console.log('Market regenerated with', S.marketListings.length, 'listings');
      console.log('Sample listings:', S.marketListings.slice(0, 3).map(l => `${l.year} ${l.aircraftCode}: ${l.totalHours} hrs`));
    };

    // ========== AIRCRAFT BROKER SYSTEM ==========
    
    let selectedBrokerAircraft = null;
    
    function showBrokerModal() {
      // Check if there's already an active request
      if (S.brokerRequest) {
        alert('You already have an active broker request. Please wait for it to complete or cancel it.');
        return;
      }
      
      document.getElementById('brokerModal').classList.remove('hidden');
      selectedBrokerAircraft = null;
      document.getElementById('brokerFeePreview').style.display = 'none';
      document.getElementById('brokerSubmitBtn').disabled = true;
      filterBrokerAircraft();
    }
    
    function hideBrokerModal() {
      document.getElementById('brokerModal').classList.add('hidden');
      selectedBrokerAircraft = null;
    }
    
    function filterBrokerAircraft() {
      const categoryFilter = document.getElementById('brokerCategoryFilter').value;
      const grid = document.getElementById('brokerAircraftGrid');
      
      // Get all aircraft with prices, EXCLUDING military
      const aircraftList = Object.keys(AIRCRAFT_BASE_PRICES).map(code => {
        const aircraft = getAircraft(code);
        if (!aircraft) return null;
        if (aircraft.category === 'military') return null; // Exclude military
        return { code, aircraft, basePrice: AIRCRAFT_BASE_PRICES[code] };
      }).filter(a => a !== null);
      
      // Filter by category
      let filtered = aircraftList;
      if (categoryFilter) {
        filtered = aircraftList.filter(a => a.aircraft.category === categoryFilter);
      }
      
      // Sort by price
      filtered.sort((a, b) => a.basePrice - b.basePrice);
      
      // Category display names
      const categoryNames = {
        'single_piston': 'Single Piston',
        'multi_piston': 'Multi Piston',
        'turboprop': 'Turboprop',
        'light_jet': 'Light Jet',
        'airliner': 'Airliner',
        'helicopter': 'Helicopter',
        'bush': 'Bush',
        'amphibious': 'Amphibious',
        'aerobatic': 'Aerobatic',
        'warbird': 'Warbird',
        'cargo': 'Cargo'
      };
      
      // Helper to get price range based on segment
      function getBrokerPriceRange(code, basePrice) {
        const segment = getPricingSegment(code);
        switch (segment) {
          case 'small':   return { min: basePrice * 0.65, max: basePrice * 0.97 };
          case 'turbine': return { min: basePrice * 0.40, max: basePrice * 0.95 };
          case 'big':     return { min: basePrice * 0.20, max: basePrice * 0.92 };
          case 'classic': return { min: basePrice * 0.55, max: basePrice * 1.35 }; // Can exceed base!
          default:        return { min: basePrice * 0.50, max: basePrice * 0.95 };
        }
      }
      
      grid.innerHTML = filtered.map(a => {
        const range = getBrokerPriceRange(a.code, a.basePrice);
        return `
        <div class="broker-aircraft-option ${selectedBrokerAircraft === a.code ? 'selected' : ''}" 
             onclick="selectBrokerAircraft('${a.code}')">
          <div class="broker-aircraft-name">${a.aircraft.name}</div>
          <div class="broker-aircraft-cat">${categoryNames[a.aircraft.category] || a.aircraft.category}</div>
          <div class="broker-aircraft-price">~${formatCurrency(Math.round(range.min))} - ${formatCurrency(Math.round(range.max))}</div>
        </div>
      `}).join('');
    }
    
    function selectBrokerAircraft(code) {
      selectedBrokerAircraft = code;
      const aircraft = getAircraft(code);
      const basePrice = AIRCRAFT_BASE_PRICES[code];
      const segment = getPricingSegment(code);
      
      // Update selection visual
      document.querySelectorAll('.broker-aircraft-option').forEach(el => {
        el.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      // Show fee preview
      const feePreview = document.getElementById('brokerFeePreview');
      feePreview.style.display = 'block';
      
      // Get segment-appropriate price range
      let minPrice, maxPrice;
      switch (segment) {
        case 'small':   minPrice = basePrice * 0.55; maxPrice = basePrice * 0.97; break;
        case 'turbine': minPrice = basePrice * 0.40; maxPrice = basePrice * 0.95; break;
        case 'big':     minPrice = basePrice * 0.20; maxPrice = basePrice * 0.92; break;
        case 'classic': minPrice = basePrice * 0.55; maxPrice = basePrice * 1.35; break;
        default:        minPrice = basePrice * 0.50; maxPrice = basePrice * 0.95;
      }
      
      const avgPrice = Math.round((minPrice + maxPrice) / 2);
      const fee = Math.round(avgPrice * 0.05);
      
      document.getElementById('brokerSelectedName').textContent = aircraft.name;
      document.getElementById('brokerPriceRange').textContent = `${formatCurrency(Math.round(minPrice))} - ${formatCurrency(Math.round(maxPrice))}`;
      document.getElementById('brokerFee').textContent = `~${formatCurrency(fee)}`;
      
      // Enable submit button
      document.getElementById('brokerSubmitBtn').disabled = false;
    }
    
    function submitBrokerRequest() {
      if (!selectedBrokerAircraft) return;
      
      const aircraft = getAircraft(selectedBrokerAircraft);
      const basePrice = AIRCRAFT_BASE_PRICES[selectedBrokerAircraft];
      const avgPrice = Math.round(basePrice * 0.65);
      const fee = Math.round(avgPrice * 0.05);
      
      // Check funds for fee
      if (S.cash < fee) {
        alert(`Insufficient funds for broker fee.\n\nFee: ${formatCurrency(fee)}\nYour cash: ${formatCurrency(S.cash)}`);
        return;
      }
      
      if (!confirm(`Request broker to find a ${aircraft.name}?\n\nBroker Fee: ${formatCurrency(fee)} (paid now)\nETA: 1-3 days\n\nThe broker will search for available aircraft and notify you when one is found.`)) {
        return;
      }
      
      // Deduct fee
      S.cash -= fee;
      
      // Calculate ETA (1-3 days from now)
      const daysToFind = randomInt(1, 3);
      const eta = addDays(S.gameTime, daysToFind);
      
      // Create broker request
      S.brokerRequest = {
        aircraftCode: selectedBrokerAircraft,
        requestedAt: { ...S.gameTime },
        eta: eta,
        feePaid: fee
      };
      
      // Confirmation email
      S.emails.unshift({
        id: uuid(),
        type: 'notification',
        from: 'Aircraft Broker',
        company: 'SkyFind Aviation',
        subject: `Search Started: ${aircraft.name}`,
        body: `We've received your request and our broker network is now searching for a ${aircraft.name}.\n\nBroker Fee Paid: ${formatCurrency(fee)}\nEstimated Delivery: ${daysToFind} day${daysToFind > 1 ? 's' : ''}\n\nWe'll notify you as soon as we locate a suitable aircraft.`,
        status: 'unread',
        generatedDay: S.gameTime.day,
        receivedAt: { ...S.gameTime }
      });
      
      hideBrokerModal();
      showToast('Broker Request Submitted', `Searching for ${aircraft.name}...`, 'info');
      saveState();
      render();
    }
    
    function cancelBrokerRequest() {
      if (!S.brokerRequest) return;
      
      const aircraft = getAircraft(S.brokerRequest.aircraftCode);
      
      // Refund 50% of fee
      const refund = Math.round(S.brokerRequest.feePaid * 0.5);
      
      if (!confirm(`Cancel broker request for ${aircraft?.name || 'aircraft'}?\n\nYou will receive a 50% refund: ${formatCurrency(refund)}`)) {
        return;
      }
      
      S.cash += refund;
      S.brokerRequest = null;
      
      showToast('Request Cancelled', `${formatCurrency(refund)} refunded`, 'warning');
      saveState();
      render();
    }
    
    function processBrokerRequest() {
      if (!S.brokerRequest) return;
      
      // Check if ETA has been reached
      if (compareGameTime(S.gameTime, S.brokerRequest.eta) >= 0) {
        const aircraft = getAircraft(S.brokerRequest.aircraftCode);
        if (!aircraft) {
          S.brokerRequest = null;
          return;
        }
        
        // Generate a listing for this specific aircraft
        const listing = generateMarketListing(null, null);
        
        // Override with the requested aircraft
        const prodYears = AIRCRAFT_PRODUCTION_YEARS[S.brokerRequest.aircraftCode] || [2000, 2024];
        const currentYear = S.gameTime.year;
        
        // Bias toward recent years
        let year;
        const recentStart = Math.max(prodYears[0], currentYear - 12);
        if (Math.random() < 0.65 && recentStart < prodYears[1]) {
          year = randomInt(recentStart, Math.min(prodYears[1], currentYear));
        } else {
          year = randomInt(prodYears[0], Math.min(prodYears[1], currentYear));
        }
        
        const age = Math.max(0, currentYear - year);
        
        // Generate condition
        let condition;
        if (age <= 3) condition = randomInt(90, 98);
        else if (age <= 10) condition = randomInt(80, 94);
        else if (age <= 25) condition = randomInt(70, 88);
        else condition = randomInt(65, 85);
        
        // Generate hours with physical sanity check
        const category = aircraft.category || 'single_piston';
        let totalHours;
        let maxHours;
        
        if (['airliner', 'cargo', 'military_cargo'].includes(category)) {
          totalHours = Math.round(age * randomInt(2000, 3500));
          maxHours = 75000;
        } else if (['turboprop', 'light_jet'].includes(category)) {
          totalHours = Math.round(age * randomInt(250, 550));
          maxHours = 15000;
        } else if (category === 'helicopter') {
          totalHours = Math.round(age * randomInt(150, 400));
          maxHours = 12000;
        } else if (category === 'multi_piston') {
          totalHours = Math.round(age * randomInt(80, 250));
          maxHours = 8000;
        } else {
          totalHours = Math.round(age * randomInt(40, 120));
          maxHours = 5500;
        }
        
        // PHYSICAL SANITY CHECK: max 4500 hrs/year
        const physicalMax = Math.max(50, age * 4500);
        totalHours = Math.min(physicalMax, totalHours);
        totalHours = Math.min(maxHours, totalHours);
        totalHours = Math.max(totalHours, age * 20);
        if (age === 0) totalHours = randomInt(10, 80);
        
        // Calculate price
        const price = calculateListingPrice(S.brokerRequest.aircraftCode, year, condition, totalHours, aircraft);
        
        // Create the broker-found listing
        const brokerListing = {
          id: generateListingId(),
          aircraftCode: S.brokerRequest.aircraftCode,
          year,
          condition,
          totalHours,
          price,
          originalPrice: price,
          listedDate: new Date(currentYear, S.gameTime.month - 1, S.gameTime.day).toISOString().split('T')[0],
          expiresDate: new Date(currentYear, S.gameTime.month - 1, S.gameTime.day + 14).toISOString().split('T')[0],
          isHotDeal: false,
          isBrokerFind: true,
          priceDrops: 0,
          registration: generateTailNumber()
        };
        
        // Add to front of market listings
        S.marketListings.unshift(brokerListing);
        
        // Send notification email
        S.emails.unshift({
          id: uuid(),
          type: 'notification',
          from: 'Aircraft Broker',
          company: 'SkyFind Aviation',
          subject: `âœˆï¸ Found: ${year} ${aircraft.name}`,
          body: `Great news! We've located a ${aircraft.name} matching your criteria.\n\n${year} ${aircraft.name} (${brokerListing.registration})\nCondition: ${condition}%\nTotal Time: ${totalHours.toLocaleString()} hours\nPrice: ${formatCurrency(price)}\n\nThis aircraft has been added to the market and reserved for you for 14 days. Visit the Market tab to complete your purchase.`,
          status: 'unread',
          generatedDay: S.gameTime.day,
          receivedAt: { ...S.gameTime }
        });
        
        showToast('Aircraft Found!', `${aircraft.name} added to market`, 'success');
        
        // Clear the request
        S.brokerRequest = null;
      }
    }
    
    function renderBrokerRequestBanner() {
      const banner = document.getElementById('activeBrokerRequest');
      if (!banner) return;
      
      if (!S.brokerRequest) {
        banner.style.display = 'none';
        return;
      }
      
      const aircraft = getAircraft(S.brokerRequest.aircraftCode);
      const daysLeft = Math.max(0, Math.ceil((gameTimeToMinutes(S.brokerRequest.eta) - gameTimeToMinutes(S.gameTime)) / 1440));
      
      banner.style.display = 'block';
      banner.innerHTML = `
        <div class="broker-status">
          <div>
            <span class="broker-aircraft">ðŸ” Searching: ${aircraft?.name || S.brokerRequest.aircraftCode}</span>
          </div>
          <span class="broker-eta">${daysLeft > 0 ? `~${daysLeft} day${daysLeft > 1 ? 's' : ''} remaining` : 'Any moment now...'}</span>
        </div>
        <button class="btn btn-small" onclick="cancelBrokerRequest()" style="color: var(--danger); border-color: var(--danger);">Cancel Request (50% refund)</button>
      `;
    }
    
    window.showBrokerModal = showBrokerModal;
    window.hideBrokerModal = hideBrokerModal;
    window.filterBrokerAircraft = filterBrokerAircraft;
    window.selectBrokerAircraft = selectBrokerAircraft;
    window.submitBrokerRequest = submitBrokerRequest;
    window.cancelBrokerRequest = cancelBrokerRequest;

    function renderCertifications() {
      const container = document.getElementById('certificationsList');
      
      // === PILOT CERTIFICATES & RATINGS SECTION ===
      const certificateOptions = [
        { id: 'student', name: 'Student Pilot', desc: 'Training flights only, no passengers' },
        { id: 'private', name: 'Private Pilot', desc: 'Passengers, VFR, personal and paid flights' },
        { id: 'commercial', name: 'Commercial Pilot', desc: 'All professional operations' },
        { id: 'atp', name: 'Airline Transport Pilot', desc: 'Airline and heavy aircraft operations' }
      ];
      
      const ratingOptions = [
        { id: 'night', name: 'Night', desc: 'Flight between sunset and sunrise' },
        { id: 'instrument', name: 'Instrument', desc: 'IFR conditions, bad weather, critical missions' },
        { id: 'multiEngine', name: 'Multi-Engine', desc: 'Twin-engine aircraft' },
        { id: 'helicopter', name: 'Helicopter', desc: 'Rotorcraft operations' },
        { id: 'seaplane', name: 'Seaplane', desc: 'Water operations, amphibious aircraft' },
        { id: 'turbine', name: 'Turbine', desc: 'Turboprop and jet aircraft' }
      ];
      
      let html = '';
      
      // Game mode indicator (toggle moved to Game Menu)
      const modeLabel = S.gameMode === 'career' ? 'Career Mode' : 'Sandbox Mode';
      const modeColor = S.gameMode === 'career' ? 'var(--warning)' : 'var(--accent)';
      html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <span style="font-size: 12px; color: ${modeColor}; background: ${modeColor}22; padding: 4px 10px; border-radius: 4px;">${modeLabel}</span>
        ${S.gameMode === 'career' ? `<span style="font-size: 12px; color: var(--muted);">Tier: ${S.pilot.experienceTier.charAt(0).toUpperCase() + S.pilot.experienceTier.slice(1)}</span>` : ''}
      </div>`;
      
      // Certificates section - shows hours progress in career mode
      html += `<div style="margin-bottom: 24px;">
        <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">PILOT CERTIFICATES</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">`;
      
      certificateOptions.forEach(cert => {
        const isHeld = S.pilot.certificates.includes(cert.id);
        const gate = PROGRESSION_GATES[cert.id];
        const hoursNeeded = gate?.hours || 0;
        const hoursHave = S.totalHoursFlown || 0;
        const isEligible = hoursHave >= hoursNeeded && !isHeld;
        const hasPendingCheckride = S.emails?.some(e => e.type === 'checkride' && e.gateKey === cert.id) || 
                                   S.checkrides?.scheduled?.some(c => c.gateKey === cert.id);
        
        if (S.gameMode === 'career') {
          if (isHeld) {
            // Fancy certificate card for earned certificates
            const certIcons = { student: 'ðŸ“œ', private: 'ðŸŽ–ï¸', commercial: 'â­', atp: 'ðŸ‘¨â€âœˆï¸' };
            const certIcon = certIcons[cert.id] || 'âœˆï¸';
            html += `
              <div style="background: linear-gradient(145deg, #1a1f2e 0%, #0d1117 100%); border: 2px solid #c9a227; border-radius: 8px; padding: 16px; text-align: center; position: relative; box-shadow: 0 4px 12px rgba(201, 162, 39, 0.15), inset 0 1px 0 rgba(255,255,255,0.05);">
                <div style="position: absolute; top: -1px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, transparent, #c9a227, transparent); height: 2px; width: 60%;"></div>
                <div style="font-size: 10px; color: #c9a227; letter-spacing: 2px; margin-bottom: 8px;">FEDERAL AVIATION ADMINISTRATION</div>
                <div style="font-size: 28px; margin-bottom: 4px;">${certIcon}</div>
                <div style="font-size: 15px; font-weight: 700; color: #e8d5a3; letter-spacing: 1px; text-transform: uppercase;">${cert.name}</div>
                <div style="font-size: 10px; color: #888; margin-top: 2px; letter-spacing: 1px;">CERTIFICATE</div>
                <div style="margin: 12px 0; border-top: 1px solid #c9a22740; border-bottom: 1px solid #c9a22740; padding: 8px 0;">
                  <div style="font-size: 13px; color: #e8e8e8; font-style: italic;">${S.pilot.name || 'Pilot'}</div>
                </div>
              </div>`;
          } else if (hasPendingCheckride) {
            html += `
              <div style="background: rgba(88, 166, 255, 0.1); border: 1px solid var(--accent); padding: 12px; border-radius: 6px;">
                <div style="font-size: 14px; font-weight: 500; color: var(--accent);">${cert.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin: 4px 0;">${cert.desc}</div>
                <div style="font-size: 11px; color: var(--accent);">ðŸ“‹ Checkride pending</div>
                <button class="btn" style="width: 100%; margin-top: 8px; font-size: 10px; padding: 4px 8px; border-color: var(--danger); color: var(--danger);" 
                        onclick="cancelCheckride('${cert.id}')">
                  Cancel Checkride
                </button>
              </div>`;
          } else if (isEligible) {
            html += `
              <div style="background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 6px;">
                <div style="font-size: 14px; font-weight: 500; color: var(--text);">${cert.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin: 4px 0;">${cert.desc}</div>
                <button class="btn" style="width: 100%; margin-top: 8px; font-size: 11px; padding: 6px;" onclick="sendCheckrideEmail('${cert.id}')">Schedule Checkride</button>
              </div>`;
          } else {
            html += `
              <div style="background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 6px; opacity: 0.6;">
                <div style="font-size: 14px; font-weight: 500; color: var(--text);">${cert.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin: 4px 0;">${cert.desc}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 8px;">${hoursHave.toFixed(0)} / ${hoursNeeded} hours</div>
                <div style="background: var(--border); height: 4px; border-radius: 2px; margin-top: 4px; overflow: hidden;">
                  <div style="height: 100%; background: var(--accent); width: ${Math.min(100, (hoursHave/hoursNeeded)*100)}%;"></div>
                </div>
              </div>`;
          }
        } else {
          // Sandbox mode - clickable toggle with fancy styling when held
          const certIcons = { student: 'ðŸ“œ', private: 'ðŸŽ–ï¸', commercial: 'â­', atp: 'ðŸ‘¨â€âœˆï¸' };
          const certIcon = certIcons[cert.id] || 'âœˆï¸';
          
          if (isHeld) {
            html += `
              <div style="background: linear-gradient(145deg, #1a1f2e 0%, #0d1117 100%); border: 2px solid #c9a227; border-radius: 8px; padding: 16px; text-align: center; position: relative; box-shadow: 0 4px 12px rgba(201, 162, 39, 0.15), inset 0 1px 0 rgba(255,255,255,0.05); cursor: pointer; transition: all 0.15s;"
                   onclick="togglePilotCertificate('${cert.id}')"
                   onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="position: absolute; top: -1px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, transparent, #c9a227, transparent); height: 2px; width: 60%;"></div>
                <div style="font-size: 10px; color: #c9a227; letter-spacing: 2px; margin-bottom: 8px;">FEDERAL AVIATION ADMINISTRATION</div>
                <div style="font-size: 28px; margin-bottom: 4px;">${certIcon}</div>
                <div style="font-size: 15px; font-weight: 700; color: #e8d5a3; letter-spacing: 1px; text-transform: uppercase;">${cert.name}</div>
                <div style="font-size: 10px; color: #888; margin-top: 2px; letter-spacing: 1px;">CERTIFICATE</div>
                <div style="margin: 12px 0; border-top: 1px solid #c9a22740; border-bottom: 1px solid #c9a22740; padding: 8px 0;">
                  <div style="font-size: 13px; color: #e8e8e8; font-style: italic;">${S.pilot.name || 'Pilot'}</div>
                </div>
                <div style="font-size: 10px; color: var(--muted);">Click to remove</div>
              </div>`;
          } else {
            html += `
              <div style="background: var(--bg); border: 1px dashed var(--border); border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s; opacity: 0.6;"
                   onclick="togglePilotCertificate('${cert.id}')"
                   onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.6'">
                <div style="font-size: 28px; margin-bottom: 4px; filter: grayscale(1);">${certIcon}</div>
                <div style="font-size: 14px; font-weight: 500; color: var(--text);">${cert.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${cert.desc}</div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 8px;">Click to add</div>
              </div>`;
          }
        }
      });
      
      html += `</div></div>`;
      
      // Ratings section - requires PPL (or Commercial for turbine)
      const hasPPL = S.pilot.certificates.includes('private');
      const hasCommercial = S.pilot.certificates.includes('commercial');
      
      // Rating icons and requirements
      const ratingDetails = {
        night: { 
          icon: 'ðŸŒ™', 
          color: '#6366f1',
          requirement: { field: 'night', hours: 3, label: 'night hours' }
        },
        instrument: { 
          icon: 'â˜ï¸', 
          color: '#3b82f6',
          requirement: { field: 'instrument', hours: 10, label: 'instrument hours' }
        },
        multiEngine: { 
          icon: 'âœˆï¸', 
          color: '#f59e0b',
          requirement: { field: 'multiEngine', hours: 5, label: 'multi-engine hours' }
        },
        helicopter: { 
          icon: 'ðŸš', 
          color: '#10b981',
          requirement: { field: 'helicopter', hours: 10, label: 'helicopter hours' }
        },
        seaplane: { 
          icon: 'ðŸŒŠ', 
          color: '#06b6d4',
          requirement: { field: 'seaplane', hours: 3, label: 'seaplane hours' }
        },
        turbine: { 
          icon: 'ðŸ”¥', 
          color: '#ef4444',
          requirement: { field: 'turbine', hours: 5, label: 'turbine hours' }
        }
      };
      
      html += `<div style="margin-bottom: 24px;">
        <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">RATINGS</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">`;
      
      ratingOptions.forEach(rating => {
        const isHeld = S.pilot.ratings.includes(rating.id);
        
        // Check for pending checkride (email OR scheduled entry)
        const hasCheckrideEmail = S.emails?.some(e => e.type === 'checkride' && e.gateKey === rating.id);
        const hasScheduledEntry = S.checkrides?.scheduled?.some(c => c.gateKey === rating.id);
        const hasPendingCheckride = hasCheckrideEmail || hasScheduledEntry;
        
        // Check which certificate is required
        const gate = PROGRESSION_GATES[rating.id];
        const requiredCert = gate?.requires || 'private';
        const hasRequiredCert = requiredCert === 'commercial' ? hasCommercial : hasPPL;
        const requiredCertName = requiredCert === 'commercial' ? 'Commercial' : 'PPL';
        
        // Get rating details
        const details = ratingDetails[rating.id] || { icon: 'ðŸ·ï¸', color: '#888', requirement: null };
        
        // Hour tracking is informational only (recommended, not required)
        const hoursByCategory = S.pilot.hoursByCategory || {};
        const reqField = details.requirement?.field;
        const recommendedHours = details.requirement?.hours || 0;
        const currentHours = hoursByCategory[reqField] || 0;
        const meetsRecommended = currentHours >= recommendedHours;
        
        // Eligible if has required certificate (hours are just recommended)
        const isEligible = hasRequiredCert && !isHeld && !hasPendingCheckride;
        
        if (S.gameMode === 'career') {
          if (isHeld) {
            // Fancy certificate card for earned ratings (matches pilot cert style)
            html += `
              <div style="background: linear-gradient(145deg, #1a1f2e 0%, #0d1117 100%); border: 2px solid #c9a227; border-radius: 8px; padding: 16px; text-align: center; position: relative; box-shadow: 0 4px 12px rgba(201, 162, 39, 0.15), inset 0 1px 0 rgba(255,255,255,0.05);">
                <div style="position: absolute; top: -1px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, transparent, #c9a227, transparent); height: 2px; width: 60%;"></div>
                <div style="font-size: 10px; color: #c9a227; letter-spacing: 2px; margin-bottom: 8px;">FEDERAL AVIATION ADMINISTRATION</div>
                <div style="font-size: 32px; margin-bottom: 4px;">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 700; color: #e8d5a3; letter-spacing: 1px; text-transform: uppercase;">${rating.name}</div>
                <div style="font-size: 10px; color: #888; margin-top: 2px; letter-spacing: 1px;">RATING</div>
                <div style="margin: 12px 0; border-top: 1px solid #c9a22740; border-bottom: 1px solid #c9a22740; padding: 8px 0;">
                  <div style="font-size: 13px; color: #e8e8e8; font-style: italic;">${S.pilot.name || 'Pilot'}</div>
                </div>
              </div>`;
          } else if (!hasRequiredCert) {
            // Locked - needs certificate
            html += `
              <div style="background: var(--bg); border: 1px dashed var(--border); border-radius: 12px; padding: 16px; text-align: center; opacity: 0.5;">
                <div style="font-size: 32px; margin-bottom: 8px; filter: grayscale(1);">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 600; color: var(--text);">${rating.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${rating.desc}</div>
                <div style="margin-top: 12px; font-size: 11px; color: var(--warning);">
                  ðŸ”’ Requires ${requiredCertName}
                </div>
              </div>`;
          } else if (hasPendingCheckride) {
            // Checkride scheduled/pending
            html += `
              <div style="background: rgba(88, 166, 255, 0.08); border: 2px solid var(--accent); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 8px;">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 600; color: var(--accent);">${rating.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${rating.desc}</div>
                <div style="margin-top: 12px; padding: 8px; background: var(--accent)20; border-radius: 6px;">
                  <div style="font-size: 11px; color: var(--accent);">ðŸ“‹ Checkride ${hasScheduledEntry ? 'Scheduled' : 'Pending'}</div>
                  <button class="btn" style="margin-top: 8px; font-size: 10px; padding: 4px 8px; border-color: var(--danger); color: var(--danger);" 
                          onclick="cancelCheckride('${rating.id}')">
                    Cancel Checkride
                  </button>
                </div>
              </div>`;
          } else {
            // Eligible for checkride - show recommended hours as simple indicator
            html += `
              <div style="background: var(--bg); border: 2px solid ${details.color}60; border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 32px; margin-bottom: 8px;">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 600; color: var(--text);">${rating.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${rating.desc}</div>
                <div style="margin-top: 12px;">
                  <div style="font-size: 10px; margin-bottom: 8px; ${meetsRecommended ? 'color: var(--success);' : 'color: var(--muted);'}">
                    ${meetsRecommended ? 'âœ“' : 'â—‹'} Recommended: ${recommendedHours} hrs
                  </div>
                  <button class="btn" style="width: 100%; font-size: 11px; padding: 8px; background: ${details.color}; border-color: ${details.color}; color: white;" onclick="scheduleRatingCheckride('${rating.id}')">
                    Schedule Checkride
                  </button>
                </div>
              </div>`;
          }
        } else {
          // Sandbox mode - clickable toggle with fancy styling when held
          if (isHeld) {
            html += `
              <div style="background: linear-gradient(145deg, #1a1f2e 0%, #0d1117 100%); border: 2px solid #c9a227; border-radius: 8px; padding: 16px; text-align: center; position: relative; box-shadow: 0 4px 12px rgba(201, 162, 39, 0.15), inset 0 1px 0 rgba(255,255,255,0.05); cursor: pointer; transition: all 0.15s;"
                   onclick="togglePilotRating('${rating.id}')"
                   onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="position: absolute; top: -1px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, transparent, #c9a227, transparent); height: 2px; width: 60%;"></div>
                <div style="font-size: 10px; color: #c9a227; letter-spacing: 2px; margin-bottom: 8px;">FEDERAL AVIATION ADMINISTRATION</div>
                <div style="font-size: 32px; margin-bottom: 4px;">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 700; color: #e8d5a3; letter-spacing: 1px; text-transform: uppercase;">${rating.name}</div>
                <div style="font-size: 10px; color: #888; margin-top: 2px; letter-spacing: 1px;">RATING</div>
                <div style="margin: 12px 0; border-top: 1px solid #c9a22740; border-bottom: 1px solid #c9a22740; padding: 8px 0;">
                  <div style="font-size: 13px; color: #e8e8e8; font-style: italic;">${S.pilot.name || 'Pilot'}</div>
                </div>
                <div style="font-size: 10px; color: var(--muted);">Click to remove</div>
              </div>`;
          } else {
            html += `
              <div style="background: var(--bg); border: 1px dashed var(--border); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.15s; opacity: 0.6;"
                   onclick="togglePilotRating('${rating.id}')"
                   onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.6'">
                <div style="font-size: 32px; margin-bottom: 8px; filter: grayscale(1);">${details.icon}</div>
                <div style="font-size: 14px; font-weight: 600; color: var(--text);">${rating.name}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${rating.desc}</div>
                <div style="font-size: 10px; color: var(--muted); margin-top: 8px;">Click to add</div>
              </div>`;
          }
        }
      });
      
      html += `</div></div>`;
      
      // === AIRCRAFT CERTIFICATIONS SECTION ===
      html += `<div style="border-top: 1px solid var(--border); margin: 24px 0; padding-top: 24px;"></div>`;
      
      // Get all aircraft including custom ones
      const allAircraft = { ...AIRCRAFT, ...S.customAircraft };
      
      // Group by category
      const grouped = {};
      Object.entries(allAircraft).forEach(([code, aircraft]) => {
        const cat = aircraft.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push({ code, aircraft, isCustom: !!S.customAircraft[code] });
      });
      
      const categoryNames = {
        single_piston: 'Single Engine Piston',
        single_piston_hp: 'High Performance Piston',
        multi_piston: 'Multi-Engine Piston',
        turboprop: 'Turboprop',
        light_jet: 'Light Jet',
        airliner: 'Airliner',
        military_cargo: 'Military Cargo',
        military_fighter: 'Military Fighter',
        bush: 'Bush Plane',
        amphibious: 'Amphibious',
        helicopter: 'Helicopter',
        aerobatic: 'Aerobatic',
        warbird: 'Warbird',
        specialty: 'Specialty',
        other: 'Other'
      };
      
      const totalAircraft = Object.keys(allAircraft).length;
      const certifiedCount = S.pilot.aircraftCertifications.length;
      const customCount = Object.keys(S.customAircraft).length;
      
      html += `
        <div style="margin-bottom: 16px;">
          <h3 style="font-size: 14px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 12px;">AIRCRAFT CERTIFICATIONS</h3>
          <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <p style="font-size: 12px; color: var(--text); margin: 0 0 8px 0;">
              <strong>How it works:</strong> Aircraft certifications determine what aircraft are offered for contract pilot jobs.
            </p>
            <p style="font-size: 11px; color: var(--muted); margin: 0;">
              â€¢ <strong>Owned aircraft</strong> (in your fleet) are always certified â€” you'll receive customer inquiries for these<br>
              â€¢ <strong>Certified aircraft</strong> you don't own will generate contract pilot offers â€” fly their aircraft, get paid hourly<br>
              â€¢ Click any aircraft to toggle certification on/off
              ${S.gameMode === 'sandbox' ? '<br>â€¢ <strong>Sandbox:</strong> Right-click any aircraft to add/remove from your fleet' : ''}
            </p>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
            <div>
              <span style="font-size: 12px; color: var(--muted);">${certifiedCount}/${totalAircraft} certified</span>
              ${customCount > 0 ? `<span style="font-size: 12px; color: var(--accent); margin-left: 8px;">${customCount} custom</span>` : ''}
            </div>
          </div>
        </div>
        
        <div id="customAircraftForm" style="display: none; margin-bottom: 16px;"></div>
      `;
      
      // Sort categories
      const categoryOrder = ['single_piston', 'single_piston_hp', 'bush', 'multi_piston', 'turboprop', 'light_jet', 'airliner', 'military_cargo', 'military_fighter', 'helicopter', 'amphibious', 'aerobatic', 'warbird', 'specialty', 'other'];
      const sortedCategories = Object.keys(grouped).sort((a, b) => {
        return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
      });
      
      sortedCategories.forEach(category => {
        const items = grouped[category];
        const categoryLabel = categoryNames[category] || category.replace(/_/g, ' ').toUpperCase();
        const allCertified = items.every(({ code }) => S.pilot.aircraftCertifications.includes(code));
        const noneCertified = items.every(({ code }) => !S.pilot.aircraftCertifications.includes(code) && !S.fleet.includes(code));
        
        html += `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h4 style="font-size: 13px; color: var(--muted); letter-spacing: 0.5px;">${categoryLabel.toUpperCase()}</h4>
              <div style="display: flex; gap: 6px; align-items: center;">
                <span style="font-size: 11px; color: var(--muted);">${items.length}</span>
                <button class="btn" onclick="certifyAllCategory('${category}')" style="font-size: 10px; padding: 2px 6px;" ${allCertified ? 'disabled' : ''}>Certify All</button>
                <button class="btn" onclick="clearAllCategory('${category}')" style="font-size: 10px; padding: 2px 6px;" ${noneCertified ? 'disabled' : ''}>Clear All</button>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
        `;
        
        items.sort((a, b) => a.aircraft.name.localeCompare(b.aircraft.name)).forEach(({ code, aircraft, isCustom }) => {
          const isOwned = S.fleet.includes(code);
          const isCertified = S.pilot.aircraftCertifications.includes(code);
          
          let borderColor = 'var(--border)';
          let bgColor = 'var(--bg)';
          
          if (isOwned) {
            borderColor = 'var(--success)';
            bgColor = 'rgba(34, 197, 94, 0.1)';
          } else if (isCertified) {
            borderColor = 'var(--accent)';
            bgColor = 'rgba(88, 166, 255, 0.1)';
          }
          
          // Right-click handler for sandbox fleet management
          const rightClickHandler = S.gameMode === 'sandbox' ? `oncontextmenu="event.preventDefault(); toggleFleetAircraft('${code}'); return false;"` : '';
          
          html += `
            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 10px; border-radius: 6px; cursor: pointer; transition: all 0.15s;"
                 onclick="toggleAircraftCertification('${code}')"
                 ${rightClickHandler}
                 onmouseover="this.style.transform='scale(1.02)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                <span style="font-size: 12px; font-weight: 600; color: var(--text);">${aircraft.name}</span>
                <div style="display: flex; gap: 4px;">
                  ${isCustom ? '<span style="font-size: 9px; background: var(--accent); color: white; padding: 1px 4px; border-radius: 3px;">CUSTOM</span>' : ''}
                  ${isOwned ? '<span style="font-size: 9px; background: var(--success); color: white; padding: 1px 4px; border-radius: 3px;">OWNED</span>' : ''}
                </div>
              </div>
              <div style="font-size: 10px; color: var(--muted);">
                Cruise ${aircraft.cruise_speed} kts â€¢ ${aircraft.fuel_burn_rate} gph â€¢ $${aircraft.operating_cost}/hr
              </div>
              <div style="font-size: 10px; color: var(--muted);">
                ${aircraft.max_passengers} pax â€¢ ${aircraft.max_cargo_lbs} lbs
              </div>
              <div style="font-size: 10px; color: ${isOwned ? 'var(--success)' : isCertified ? 'var(--accent)' : 'var(--muted)'}; margin-top: 4px;">
                ${isOwned ? 'âœ“ Owned (always certified)' : isCertified ? 'âœ“ Certified' : 'â—‹ Not certified'}
                ${isCustom ? ` â€¢ <span style="color: var(--error); cursor: pointer;" onclick="event.stopPropagation(); deleteCustomAircraft('${code}')">Delete</span>` : ''}
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
    }
    
    // Toggle between Career and Sandbox mode
    function toggleGameMode() {
      if (S.gameMode === 'career') {
        // Show styled sandbox mode info modal
        showSandboxInfoModal();
      } else {
        // Switching to Career - warn about restrictions
        if (confirm('Switch to Career Mode? Your certificates and ratings will be reset to what you have actually earned. Progress (hours, missions) will be preserved.')) {
          S.gameMode = 'career';
          // Reset to earned certificates based on hours
          if (S.totalHoursFlown < CERT_REQUIREMENTS.private.hoursTotal) {
            S.pilot.certificates = ['student'];
            S.pilot.ratings = [];
          } else if (S.totalHoursFlown < CERT_REQUIREMENTS.commercial.hoursTotal) {
            S.pilot.certificates = ['student', 'private'];
            // Keep night if they have night hours
            S.pilot.ratings = S.pilot.hoursByCategory.night >= 2 ? ['night'] : [];
          }
          // For now, keep aircraft certifications as-is
          saveState();
          render();
        }
      }
    }
    
    function showSandboxInfoModal() {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'sandboxInfoOverlay';
      overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s;
      `;
      
      overlay.innerHTML = `
        <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; max-width: 450px; width: 90%; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ðŸ§ª</div>
            <h2 style="margin: 0; font-size: 20px;">Sandbox Mode</h2>
          </div>
          
          <div style="background: var(--bg); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: var(--text); line-height: 1.6;">
              Sandbox mode gives you full control over your operation. You can:
            </div>
            <ul style="margin: 12px 0 0 0; padding-left: 20px; font-size: 12px; color: var(--muted); line-height: 1.8;">
              <li>Edit <strong>cash balance</strong> and <strong>maintenance reserves</strong></li>
              <li>Modify <strong>aircraft condition</strong> and <strong>fuel levels</strong></li>
              <li>Adjust <strong>pilot hours</strong> and <strong>reputation</strong></li>
              <li>Toggle any <strong>certificates</strong> and <strong>ratings</strong></li>
              <li>Add or remove <strong>aircraft</strong> freely</li>
            </ul>
          </div>
          
          <div style="font-size: 11px; color: var(--warning); text-align: center; margin-bottom: 20px;">
            ðŸ’¡ Look for âœŽ icons to edit values. You can switch back to Career anytime.
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="closeSandboxInfoModal(false)" class="btn" style="flex: 1; padding: 12px;">Cancel</button>
            <button onclick="closeSandboxInfoModal(true)" class="btn" style="flex: 1; padding: 12px; background: var(--accent); color: var(--bg); border-color: var(--accent);">Enter Sandbox</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      requestAnimationFrame(() => overlay.style.opacity = '1');
    }
    window.showSandboxInfoModal = showSandboxInfoModal;
    
    function closeSandboxInfoModal(confirmed) {
      const overlay = document.getElementById('sandboxInfoOverlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 200);
      }
      
      if (confirmed) {
        S.gameMode = 'sandbox';
        S.pilot.certificates = ['student', 'private', 'commercial', 'atp'];
        S.pilot.ratings = ['night', 'instrument', 'multiEngine', 'helicopter', 'seaplane', 'turbine'];
        saveState();
        render();
        showToast('Sandbox Mode', 'All editing features unlocked', 'success');
      }
    }
    window.closeSandboxInfoModal = closeSandboxInfoModal;
    
    // Sandbox edit functions
    function sandboxEditCash() {
      if (S.gameMode !== 'sandbox') return;
      const input = prompt('Enter new cash balance:', Math.round(S.cash));
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val)) {
          S.cash = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditCash = sandboxEditCash;
    
    function sandboxEditMxReserve() {
      if (S.gameMode !== 'sandbox') return;
      const input = prompt('Enter new maintenance reserve:', Math.round(S.maintenanceReserve));
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
          S.maintenanceReserve = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditMxReserve = sandboxEditMxReserve;
    
    function sandboxEditFuel(code) {
      if (S.gameMode !== 'sandbox') return;
      const aircraft = getAircraft(code);
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const input = prompt(`Enter fuel level (0-${aircraft.fuel_capacity}):`, fleetInfo.currentFuel.toFixed(1));
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0 && val <= aircraft.fuel_capacity) {
          fleetInfo.currentFuel = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditFuel = sandboxEditFuel;
    
    function sandboxEditCondition(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const input = prompt('Enter condition (0-100%):', fleetInfo.condition);
      if (input !== null) {
        const val = parseInt(input);
        if (!isNaN(val) && val >= 0 && val <= 100) {
          fleetInfo.condition = val;
          // Update book value to reflect new condition
          updateAircraftBookValue(code);
          saveState();
          render();
        }
      }
    }
    window.sandboxEditCondition = sandboxEditCondition;
    
    function sandboxEditHours() {
      if (S.gameMode !== 'sandbox') return;
      const input = prompt('Enter total flight hours:', S.totalHoursFlown.toFixed(1));
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
          S.totalHoursFlown = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditHours = sandboxEditHours;
    
    function sandboxEditReputation(type) {
      if (S.gameMode !== 'sandbox') return;
      const current = type === 'passenger' ? S.passengerReputation : S.cargoReputation;
      const input = prompt(`Enter ${type} reputation (0-5):`, current.toFixed(1));
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0 && val <= 5) {
          if (type === 'passenger') {
            S.passengerReputation = val;
          } else {
            S.cargoReputation = val;
          }
          saveState();
          render();
        }
      }
    }
    window.sandboxEditReputation = sandboxEditReputation;
    
    // Sandbox: Edit aircraft year
    function sandboxEditYear(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const prodYears = AIRCRAFT_PRODUCTION_YEARS[code] || [1970, 2024];
      const input = prompt(`Enter aircraft year (${prodYears[0]}-${prodYears[1]}):`, fleetInfo.year);
      if (input !== null) {
        const val = parseInt(input);
        if (!isNaN(val) && val >= prodYears[0] && val <= prodYears[1]) {
          fleetInfo.year = val;
          updateAircraftBookValue(code);
          saveState();
          render();
        }
      }
    }
    window.sandboxEditYear = sandboxEditYear;
    
    // Sandbox: Edit aircraft total hours
    function sandboxEditAircraftHours(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const input = prompt('Enter aircraft total hours:', fleetInfo.hours || 0);
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
          fleetInfo.hours = val;
          updateAircraftBookValue(code);
          saveState();
          render();
        }
      }
    }
    window.sandboxEditAircraftHours = sandboxEditAircraftHours;
    
    // Sandbox: Edit hours since inspection
    function sandboxEditHoursSinceInspection(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      const mxData = getMxData(code);
      
      const input = prompt(`Enter hours since inspection (0-${mxData.inspectionInterval}):`, fleetInfo.hoursSinceInspection || 0);
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
          fleetInfo.hoursSinceInspection = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditHoursSinceInspection = sandboxEditHoursSinceInspection;
    
    // Sandbox: Edit hours since overhaul
    function sandboxEditHoursSinceOverhaul(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      const mxData = getMxData(code);
      
      const input = prompt(`Enter hours since overhaul (0-${mxData.tbo}):`, fleetInfo.hoursSinceOverhaul || 0);
      if (input !== null) {
        const val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
          fleetInfo.hoursSinceOverhaul = val;
          saveState();
          render();
        }
      }
    }
    window.sandboxEditHoursSinceOverhaul = sandboxEditHoursSinceOverhaul;
    
    // Sandbox: Edit registration
    function sandboxEditRegistration(code) {
      if (S.gameMode !== 'sandbox') return;
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const input = prompt('Enter registration (e.g., N12345):', fleetInfo.registration || 'N00000');
      if (input !== null && input.trim()) {
        fleetInfo.registration = input.trim().toUpperCase();
        saveState();
        render();
      }
    }
    window.sandboxEditRegistration = sandboxEditRegistration;
    
    // Sandbox: Edit lease details
    function sandboxEditLease(leaseId) {
      if (S.gameMode !== 'sandbox') return;
      const lease = S.leases?.find(l => l.id === leaseId);
      if (!lease) return;
      
      const aircraft = getAircraft(lease.aircraftCode);
      const action = prompt(
        `Edit Lease: ${aircraft?.name || lease.aircraftCode}\n` +
        `Current: $${lease.monthlyPayment}/mo, ${lease.monthsRemaining} months left, $${lease.securityDeposit} deposit\n\n` +
        `Enter option:\n` +
        `1 = Edit monthly payment\n` +
        `2 = Edit months remaining\n` +
        `3 = Edit security deposit\n` +
        `4 = Cancel lease (return aircraft)`,
        '1'
      );
      
      if (action === '1') {
        const val = prompt('Enter new monthly payment:', lease.monthlyPayment);
        if (val !== null) {
          const num = parseFloat(val);
          if (!isNaN(num) && num >= 0) {
            lease.monthlyPayment = Math.round(num);
            saveState();
            render();
          }
        }
      } else if (action === '2') {
        const val = prompt('Enter months remaining:', lease.monthsRemaining);
        if (val !== null) {
          const num = parseInt(val);
          if (!isNaN(num) && num >= 0) {
            lease.monthsRemaining = num;
            saveState();
            render();
          }
        }
      } else if (action === '3') {
        const val = prompt('Enter security deposit:', lease.securityDeposit);
        if (val !== null) {
          const num = parseFloat(val);
          if (!isNaN(num) && num >= 0) {
            lease.securityDeposit = Math.round(num);
            saveState();
            render();
          }
        }
      } else if (action === '4') {
        if (confirm(`Cancel lease and return ${aircraft?.name || lease.aircraftCode}?`)) {
          // Remove from fleet
          S.fleet = S.fleet.filter(c => c !== lease.aircraftCode);
          delete S.fleetData[lease.aircraftCode];
          // Remove lease
          S.leases = S.leases.filter(l => l.id !== leaseId);
          // Refund deposit
          S.cash += lease.securityDeposit;
          showToast('Lease Cancelled', `Deposit of ${formatCurrency(lease.securityDeposit)} refunded`, 'success');
          saveState();
          render();
        }
      }
    }
    window.sandboxEditLease = sandboxEditLease;
    
    // Sandbox: Edit loan details
    function sandboxEditLoan(loanId) {
      if (S.gameMode !== 'sandbox') return;
      const loan = S.loans?.find(l => l.id === loanId);
      if (!loan) return;
      
      const aircraft = getAircraft(loan.aircraftCode);
      const action = prompt(
        `Edit Loan: ${aircraft?.name || loan.aircraftCode}\n` +
        `Current: $${loan.monthlyPayment}/mo, ${loan.paymentsRemaining} payments left, $${loan.remainingBalance} balance\n\n` +
        `Enter option:\n` +
        `1 = Edit monthly payment\n` +
        `2 = Edit payments remaining\n` +
        `3 = Edit remaining balance\n` +
        `4 = Pay off loan\n` +
        `5 = Delete loan (keep aircraft)`,
        '1'
      );
      
      if (action === '1') {
        const val = prompt('Enter new monthly payment:', loan.monthlyPayment);
        if (val !== null) {
          const num = parseFloat(val);
          if (!isNaN(num) && num >= 0) {
            loan.monthlyPayment = Math.round(num);
            saveState();
            render();
          }
        }
      } else if (action === '2') {
        const val = prompt('Enter payments remaining:', loan.paymentsRemaining);
        if (val !== null) {
          const num = parseInt(val);
          if (!isNaN(num) && num >= 0) {
            loan.paymentsRemaining = num;
            saveState();
            render();
          }
        }
      } else if (action === '3') {
        const val = prompt('Enter remaining balance:', loan.remainingBalance);
        if (val !== null) {
          const num = parseFloat(val);
          if (!isNaN(num) && num >= 0) {
            loan.remainingBalance = Math.round(num);
            saveState();
            render();
          }
        }
      } else if (action === '4') {
        if (confirm(`Pay off ${formatCurrency(loan.remainingBalance)} to clear loan?`)) {
          S.cash -= loan.remainingBalance;
          S.loans = S.loans.filter(l => l.id !== loanId);
          showToast('Loan Paid Off', `${aircraft?.name || 'Aircraft'} now owned outright`, 'success');
          saveState();
          render();
        }
      } else if (action === '5') {
        if (confirm(`Delete loan record? Aircraft will remain in fleet as fully owned.`)) {
          S.loans = S.loans.filter(l => l.id !== loanId);
          showToast('Loan Deleted', 'Aircraft now shows as fully owned', 'success');
          saveState();
          render();
        }
      }
    }
    window.sandboxEditLoan = sandboxEditLoan;
    
    // Sandbox: Open aircraft editor modal
    function sandboxEditAircraft(code) {
      if (S.gameMode !== 'sandbox') return;
      const aircraft = getAircraft(code);
      const fleetInfo = S.fleetData[code];
      if (!aircraft || !fleetInfo) return;
      
      const mxData = getMxData(code);
      const loan = S.loans?.find(l => l.aircraftCode === code);
      const lease = S.leases?.find(l => l.aircraftCode === code);
      const prodYears = AIRCRAFT_PRODUCTION_YEARS[code] || [1970, 2024];
      
      const modal = document.createElement('div');
      modal.id = 'sandboxAircraftModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
      
      modal.innerHTML = `
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;padding:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;">âœï¸ Edit Aircraft: ${aircraft.name}</h3>
            <button onclick="document.getElementById('sandboxAircraftModal').remove()" style="background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;">&times;</button>
          </div>
          
          <div style="display:grid;gap:12px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Year (${prodYears[0]}-${prodYears[1]})</label>
              <input type="number" id="sbYear" value="${fleetInfo.year || 2020}" min="${prodYears[0]}" max="${prodYears[1]}" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Registration</label>
              <input type="text" id="sbReg" value="${fleetInfo.registration || 'N00000'}" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Condition (%)</label>
              <input type="number" id="sbCondition" value="${fleetInfo.condition || 100}" min="0" max="100" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Fuel (gal)</label>
              <input type="number" id="sbFuel" value="${fleetInfo.currentFuel?.toFixed(1) || 0}" min="0" max="${aircraft.fuel_capacity}" step="0.1" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Total Hours</label>
              <input type="number" id="sbHours" value="${fleetInfo.hours || 0}" min="0" step="0.1" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Hours Since Inspection</label>
              <input type="number" id="sbInspHours" value="${fleetInfo.hoursSinceInspection || 0}" min="0" step="0.1" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Hours Since Overhaul (TBO: ${mxData.tbo})</label>
              <input type="number" id="sbOverhaulHours" value="${fleetInfo.hoursSinceOverhaul || 0}" min="0" step="0.1" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="font-size:12px;color:var(--muted);">Book Value ($)</label>
              <input type="number" id="sbBookValue" value="${fleetInfo.bookValue || 0}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
            </div>
            
            ${lease ? `
              <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:8px;">
                <div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px;">LEASE DETAILS</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                  <label style="font-size:12px;color:var(--muted);">Monthly Payment</label>
                  <input type="number" id="sbLeasePayment" value="${lease.monthlyPayment}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                  <label style="font-size:12px;color:var(--muted);">Months Remaining</label>
                  <input type="number" id="sbLeaseMonths" value="${lease.monthsRemaining}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                  <label style="font-size:12px;color:var(--muted);">Security Deposit</label>
                  <input type="number" id="sbLeaseDeposit" value="${lease.securityDeposit}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
              </div>
            ` : ''}
            
            ${loan ? `
              <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:8px;">
                <div style="font-size:12px;font-weight:600;color:var(--warning);margin-bottom:8px;">LOAN DETAILS</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                  <label style="font-size:12px;color:var(--muted);">Monthly Payment</label>
                  <input type="number" id="sbLoanPayment" value="${loan.monthlyPayment}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                  <label style="font-size:12px;color:var(--muted);">Payments Remaining</label>
                  <input type="number" id="sbLoanPayments" value="${loan.paymentsRemaining}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                  <label style="font-size:12px;color:var(--muted);">Remaining Balance</label>
                  <input type="number" id="sbLoanBalance" value="${loan.remainingBalance}" min="0" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);">
                </div>
              </div>
            ` : ''}
          </div>
          
          <div style="display:flex;gap:10px;margin-top:20px;">
            <button onclick="document.getElementById('sandboxAircraftModal').remove()" style="flex:1;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">Cancel</button>
            <button onclick="saveSandboxAircraft('${code}')" style="flex:1;padding:10px;background:var(--accent);border:none;border-radius:6px;color:white;cursor:pointer;font-weight:600;">Save Changes</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    window.sandboxEditAircraft = sandboxEditAircraft;
    
    // Save sandbox aircraft edits
    function saveSandboxAircraft(code) {
      const fleetInfo = S.fleetData[code];
      if (!fleetInfo) return;
      
      const lease = S.leases?.find(l => l.aircraftCode === code);
      const loan = S.loans?.find(l => l.aircraftCode === code);
      
      // Update aircraft data
      fleetInfo.year = parseInt(document.getElementById('sbYear').value) || fleetInfo.year;
      fleetInfo.registration = document.getElementById('sbReg').value.toUpperCase() || fleetInfo.registration;
      fleetInfo.condition = parseFloat(document.getElementById('sbCondition').value) || 0;
      fleetInfo.currentFuel = parseFloat(document.getElementById('sbFuel').value) || 0;
      fleetInfo.hours = parseFloat(document.getElementById('sbHours').value) || 0;
      fleetInfo.hoursSinceInspection = parseFloat(document.getElementById('sbInspHours').value) || 0;
      fleetInfo.hoursSinceOverhaul = parseFloat(document.getElementById('sbOverhaulHours').value) || 0;
      fleetInfo.bookValue = parseFloat(document.getElementById('sbBookValue').value) || 0;
      
      // Update lease if present
      if (lease) {
        lease.monthlyPayment = parseInt(document.getElementById('sbLeasePayment').value) || lease.monthlyPayment;
        lease.monthsRemaining = parseInt(document.getElementById('sbLeaseMonths').value) || lease.monthsRemaining;
        lease.securityDeposit = parseInt(document.getElementById('sbLeaseDeposit').value) || lease.securityDeposit;
      }
      
      // Update loan if present
      if (loan) {
        loan.monthlyPayment = parseInt(document.getElementById('sbLoanPayment').value) || loan.monthlyPayment;
        loan.paymentsRemaining = parseInt(document.getElementById('sbLoanPayments').value) || loan.paymentsRemaining;
        loan.remainingBalance = parseInt(document.getElementById('sbLoanBalance').value) || loan.remainingBalance;
      }
      
      document.getElementById('sandboxAircraftModal').remove();
      saveState();
      render();
      showToast('Saved', 'Aircraft data updated', 'success');
    }
    window.saveSandboxAircraft = saveSandboxAircraft;
    
    // Toggle pilot certificate (student, private, commercial)
    function togglePilotCertificate(certId) {
      // Only allow toggling in sandbox mode
      if (S.gameMode !== 'sandbox') {
        alert('Certificate changes are only available in Sandbox mode. In Career mode, earn certificates through checkrides.');
        return;
      }
      
      const idx = S.pilot.certificates.indexOf(certId);
      if (idx === -1) {
        S.pilot.certificates.push(certId);
      } else {
        S.pilot.certificates.splice(idx, 1);
      }
      saveState();
      render();
    }
    
    // Toggle pilot rating (night, instrument, etc.)
    function togglePilotRating(ratingId) {
      // Only allow toggling in sandbox mode
      if (S.gameMode !== 'sandbox') {
        alert('Rating changes are only available in Sandbox mode. In Career mode, earn ratings through checkrides.');
        return;
      }
      
      const idx = S.pilot.ratings.indexOf(ratingId);
      if (idx === -1) {
        S.pilot.ratings.push(ratingId);
      } else {
        S.pilot.ratings.splice(idx, 1);
      }
      saveState();
      render();
    }
    
    // Toggle aircraft certification (replaces old toggleCertification)
    function toggleAircraftCertification(aircraftCode) {
      const idx = S.pilot.aircraftCertifications.indexOf(aircraftCode);
      const isOwned = S.fleet.includes(aircraftCode);
      const aircraft = getAircraft(aircraftCode);
      
      // Owned aircraft are always certified - can't uncertify
      if (isOwned) {
        alert(`${aircraft?.name || 'This aircraft'} is in your fleet and always certified.\n\nSell the aircraft first if you don't want to receive missions for it.`);
        return;
      }
      
      if (idx === -1) {
        // Adding certification - check if qualified in career mode
        if (S.gameMode === 'career' && !pilotCanCertifyAircraft(aircraftCode)) {
          const missing = getMissingRequirements(aircraftCode);
          let requirements = [];
          if (missing?.certificates?.length > 0) {
            const certNames = { student: 'Student', private: 'Private', commercial: 'Commercial', atp: 'ATP' };
            requirements.push('Certificate: ' + missing.certificates.map(c => certNames[c] || c).join(' or '));
          }
          if (missing?.ratings?.length > 0) {
            requirements.push('Rating: ' + missing.ratings.map(r => getRatingDisplayName(r)).join(' and '));
          }
          alert(`Not yet qualified!\n\nTo certify on ${aircraft?.name || 'this aircraft'} you need:\nâ€¢ ${requirements.join('\nâ€¢ ')}\n\nEarn these through checkrides first.`);
          return;
        }
        S.pilot.aircraftCertifications.push(aircraftCode);
      } else {
        S.pilot.aircraftCertifications.splice(idx, 1);
      }
      saveState();
      ensureEmails();
      render();
    }
    
    // Toggle aircraft in fleet (sandbox mode only)
    function toggleFleetAircraft(aircraftCode) {
      if (S.gameMode !== 'sandbox') {
        alert('Fleet management is only available in Sandbox mode.');
        return;
      }
      
      const aircraft = getAircraft(aircraftCode);
      if (!aircraft) return;
      
      const idx = S.fleet.indexOf(aircraftCode);
      if (idx === -1) {
        // Add to fleet
        S.fleet.push(aircraftCode);
        // Also ensure certification
        if (!S.pilot.aircraftCertifications.includes(aircraftCode)) {
          S.pilot.aircraftCertifications.push(aircraftCode);
        }
        alert(`${aircraft.name} added to your fleet.`);
      } else {
        // Remove from fleet
        if (confirm(`Remove ${aircraft.name} from your fleet?`)) {
          S.fleet.splice(idx, 1);
        }
      }
      saveState();
      render();
    }
    window.toggleFleetAircraft = toggleFleetAircraft;
    
    function certifyAllCategory(category) {
      const allAircraft = { ...AIRCRAFT, ...S.customAircraft };
      const categoryAircraft = Object.entries(allAircraft)
        .filter(([code, aircraft]) => (aircraft.category || 'other') === category)
        .map(([code]) => code);
      
      // In career mode, check if pilot can certify each aircraft
      categoryAircraft.forEach(code => {
        if (!S.pilot.aircraftCertifications.includes(code)) {
          if (S.gameMode === 'career' && !pilotCanCertifyAircraft(code)) {
            return; // Skip aircraft pilot isn't qualified for
          }
          S.pilot.aircraftCertifications.push(code);
        }
      });
      
      saveState();
      render();
    }
    window.certifyAllCategory = certifyAllCategory;
    
    function clearAllCategory(category) {
      const allAircraft = { ...AIRCRAFT, ...S.customAircraft };
      const categoryAircraft = Object.entries(allAircraft)
        .filter(([code, aircraft]) => (aircraft.category || 'other') === category)
        .map(([code]) => code);
      
      // Remove certifications for non-owned aircraft in this category
      S.pilot.aircraftCertifications = S.pilot.aircraftCertifications.filter(code => {
        if (!categoryAircraft.includes(code)) return true; // Keep if not in this category
        if (S.fleet.includes(code)) return true; // Keep if owned
        return false; // Remove certification
      });
      
      saveState();
      render();
    }
    window.clearAllCategory = clearAllCategory;

    function renderPreflight() {
      const container = document.getElementById('preflightContent');
      
      if (!S.activeContractId) {
        container.innerHTML = '<div class="empty-state">No active flight. Schedule a contract from Available Contracts or Calendar.</div>';
        return;
      }
      
      // Find contract in scheduled flights
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === S.activeContractId);
      const contract = scheduled ? scheduled.contract : null;
      
      if (!contract) {
        container.innerHTML = '<div class="empty-state">Contract not found.</div>';
        return;
      }
      
      const aircraft = getAircraft(contract.aircraftCode);
      const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed;
      const fleetInfo = S.fleetData[contract.aircraftCode] || { currentFuel: aircraft.fuel_capacity, condition: 100 };
      
      // Check if current time matches the exact start time
      const isStartTime = compareGameTime(S.gameTime, contract.startTime) === 0;
      const isBeforeStart = compareGameTime(S.gameTime, contract.startTime) < 0;
      const isMissed = compareGameTime(S.gameTime, contract.startTime) > 0;
      
      let statusMessage = '';
      if (isMissed) {
        statusMessage = `<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-bottom: 16px; color: var(--danger);">
          âœ— MISSED FLIGHT - You did not start at the scheduled time (${formatGameTime(contract.startTime)})
        </div>`;
      } else if (isBeforeStart) {
        const minutesUntil = compareGameTime(contract.startTime, S.gameTime);
        const hoursUntil = Math.floor(minutesUntil / 60);
        const minsUntil = minutesUntil % 60;
        statusMessage = `<div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 12px; margin-bottom: 16px; color: var(--warning);">
          â° Flight starts in ${hoursUntil}h ${minsUntil}m. Use "Next Flight" to advance to start time.
        </div>`;
      } else if (isStartTime) {
        statusMessage = `<div style="background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); border-radius: 8px; padding: 12px; margin-bottom: 16px; color: var(--success);">
          âœ“ Flight window is ACTIVE. Ready to fly!
        </div>`;
      }
      
      // Weather to MSFS preset mapping
      const msfsWeatherPreset = {
        'Clear Skies': 'Clear Skies',
        'Few Clouds': 'Few Clouds',
        'Fair Weather': 'Few Clouds',
        'Scattered Clouds': 'Scattered Clouds',
        'Broken Clouds': 'Broken Clouds',
        'Haze': 'Haze',
        'Overcast': 'Overcast',
        'Light Rain': 'Rain',
        'Rain Showers': 'Rain',
        'Light Snow': 'Snow',
        'Heavy Snow': 'Snow',
        'Thunderstorms': 'Thunderstorm',
        'Fog': 'Fog'
      }[contract.weather] || contract.weather || 'Clear Skies';
      
      // Format time for MSFS
      const msfsTime = `${String(contract.startTime.hour).padStart(2, '0')}:${String(contract.startTime.minute).padStart(2, '0')} local`;
      
      // Build mission-specific instructions
      const instructions = generatePreflightInstructions(contract, aircraft, msfsWeatherPreset, msfsTime, fleetInfo, scheduled);
      
      // Check if this is a tutorial/training flight
      const isTutorialFlight = scheduled?.isTutorial || contract.contractType === 'tutorial';
      const hasPPLForDisplay = S.pilot.certificates.includes('private');
      const isProficiencyFlight = isTutorialFlight && hasPPLForDisplay;
      
      container.innerHTML = `
        ${statusMessage}
        <div class="detail-grid">
          <div class="detail-label">Mission Type</div>
          <div class="detail-value">${contract.missionType}${isProficiencyFlight ? ' (Proficiency)' : ''}</div>
          
          ${!isTutorialFlight ? `
          <div class="detail-label">Contract Type</div>
          <div class="detail-value">${contract.contractType === 'owned' ? 'YOUR AIRCRAFT' : 'CONTRACT PILOT'}</div>
          ` : ''}
          
          <div class="detail-label">Aircraft</div>
          <div class="detail-value">${aircraft.name}</div>
          
          <div class="detail-label">Cruise Speed</div>
          <div class="detail-value">${cruiseSpeed} knots</div>
          
          <div class="detail-label">Route</div>
          <div class="detail-value">${contract.flightPlan || `${contract.from} â†’ ${contract.to}`}</div>
          
          <div class="detail-label">Distance</div>
          <div class="detail-value">${contract.distance} nm</div>
          
          ${!isTutorialFlight ? `
          <div class="detail-label">Payment</div>
          <div class="detail-value">${formatCurrency(contract.payment)} ${contract.contractType === 'contract' ? `(${formatCurrency(contract.contractRate)}/hour)` : ''}</div>
          ` : ''}
          
          ${isProficiencyFlight ? `
          <div class="detail-label">Est. Cost</div>
          <div class="detail-value" style="color: var(--warning);">~${formatCurrency(Math.round((contract.distance / cruiseSpeed) * ((aircraft.operating_cost || 100) * 0.2 + (aircraft.fuel_burn_rate || 10) * 6.44)))} (fuel + fees)</div>
          ` : ''}
          
          <div class="detail-label">Start Time</div>
          <div class="detail-value">${formatGameTime(contract.startTime)}</div>
          
          <div class="detail-label">Weather</div>
          <div class="detail-value">${contract.weather || 'Clear Skies'}${contract.isNight ? ' | Night' : ''}</div>
          
          ${contract.passengers > 0 ? `
          <div class="detail-label">Passengers</div>
          <div class="detail-value">${contract.passengers} PAX</div>
          ` : ''}
          
          ${contract.cargoLbs > 0 ? `
          <div class="detail-label">Cargo</div>
          <div class="detail-value">${contract.cargoLbs} lbs</div>
          ` : ''}
        </div>
        
        <div style="margin-top: 16px; padding: 12px; background: var(--bg); border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 8px;">Fuel Planning</div>
          <div class="detail-grid" style="gap: 4px 12px;">
            <div class="detail-label">Fuel Capacity</div>
            <div class="detail-value">${aircraft.fuel_capacity || aircraft.fuelCapacity || 'N/A'} gallons</div>
            
            <div class="detail-label">Burn Rate</div>
            <div class="detail-value">${aircraft.fuel_burn_rate || aircraft.fuelBurnRate || 'N/A'} gal/hr</div>
            
            <div class="detail-label">Est. Flight Time</div>
            <div class="detail-value">${Math.max(1.0, contract.distance / cruiseSpeed).toFixed(1)} hours</div>
            
            <div class="detail-label">Est. Fuel Required</div>
            <div class="detail-value">${Math.round(Math.max(1.0, contract.distance / cruiseSpeed) * (aircraft.fuel_burn_rate || aircraft.fuelBurnRate || 10) * 1.2)} gal (incl. 20% reserve)</div>
            
            <div class="detail-label">Range</div>
            <div class="detail-value">${aircraft.range || 'N/A'} nm</div>
          </div>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
          <h3 style="margin-bottom: 8px;">Pre-Flight Instructions</h3>
          <div style="color: var(--muted); font-size: 14px; line-height: 1.8;">
            ${instructions}
          </div>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn primary" onclick="goToPostFlight()" ${!isStartTime || isMissed ? 'disabled' : ''}>Finish Flight</button>
            <button class="btn" onclick="cancelFlight()" ${isMissed ? 'disabled' : ''} style="border-color: var(--danger); color: var(--danger);">Cancel Flight</button>
          </div>
        </div>
      `;
    }
    
    // Generate mission-specific preflight instructions
    function generatePreflightInstructions(contract, aircraft, weatherPreset, timeStr, fleetInfo, scheduled) {
      let instructions = [];
      const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed || 120;
      
      // Aircraft selection
      instructions.push(`<strong>Aircraft:</strong> Select the <strong>${aircraft.name}</strong>`);
      
      // Time and weather setup
      const timeOfDay = contract.isNight ? 'night' : (contract.startTime.hour < 12 ? 'morning' : 'afternoon');
      instructions.push(`<strong>Time:</strong> Set to <strong>${timeStr}</strong> (${timeOfDay})`);
      instructions.push(`<strong>Weather:</strong> Use preset "<strong>${weatherPreset}</strong>"`);
      
      // Weather modifications for MSFS2024
      const weatherMods = getWeatherModifications(contract.weather);
      if (weatherMods) {
        instructions.push(`<strong>Weather Adjustments:</strong> ${weatherMods}`);
      }
      
      // Build route instructions based on mission structure
      if (contract.flightPlan && (scheduled?.isTutorial || contract.contractType === 'tutorial')) {
        // Training flights: Show full flight plan
        instructions.push(`<br><strong>Flight Plan:</strong> ${contract.flightPlan}`);
        if (contract.briefing) {
          instructions.push(`<br><strong>Briefing:</strong> ${contract.briefing}`);
        }
      } else if (contract.legs && contract.legs.length > 1) {
        instructions.push(`<br><strong>Flight Routing:</strong>`);
        contract.legs.forEach((leg, idx) => {
          // Special handling for on_site/activity legs (no from/to)
          if (leg.type === 'on_site' || (leg.type === 'activity' && !leg.from)) {
            const duration = leg.duration || contract.onSiteMinutes || 15;
            // Show waypoint coordinates if available
            if (contract.waypoint && contract.waypoint.lat) {
              instructions.push(`&nbsp;&nbsp;${idx + 1}. <strong>ðŸ“ On-site operations</strong> at ${contract.waypoint.lat.toFixed(2)}Â°N, ${Math.abs(contract.waypoint.lon).toFixed(2)}Â°W (${duration} min) - Orbit/hold at location`);
            } else {
              instructions.push(`&nbsp;&nbsp;${idx + 1}. <strong>ðŸ“ On-site operations</strong> (${duration} min) - Orbit/hold at location`);
            }
          } else {
            const legDesc = {
              'positioning': 'Position empty to pickup',
              'revenue': 'Revenue leg with payload',
              'return': 'Return to base',
              'outbound': 'Outbound leg',
              'ferry': 'Ferry flight',
              'activity': 'Local operation'
            }[leg.type] || leg.type;
            
            // Get coordinates - check if it's an airport or a waypoint destination
            const fromApt = getAirport(leg.from);
            const toApt = getAirport(leg.to);
            
            // From coordinates (usually an airport)
            const fromCoords = fromApt ? ` (${fromApt.lat?.toFixed(2)}Â°N, ${Math.abs(fromApt.lon || fromApt.longitude || 0).toFixed(2)}Â°W)` : '';
            
            // To coordinates - check if it's a waypoint (not an airport)
            let toCoords = '';
            if (toApt) {
              toCoords = ` (${toApt.lat?.toFixed(2)}Â°N, ${Math.abs(toApt.lon || toApt.longitude || 0).toFixed(2)}Â°W)`;
            } else if (contract.waypoint && contract.waypoint.lat && (leg.type === 'outbound' || leg.type === 'activity')) {
              // This is a waypoint destination
              toCoords = ` (${contract.waypoint.lat.toFixed(2)}Â°N, ${Math.abs(contract.waypoint.lon).toFixed(2)}Â°W)`;
            }
            
            instructions.push(`&nbsp;&nbsp;${idx + 1}. <strong>${leg.from}</strong>${fromCoords} â†’ <strong>${leg.to}</strong>${toCoords} (${leg.distance} nm) - ${legDesc}`);
          }
        });
      } else if (contract.waypoint) {
        instructions.push(`<strong>Departure:</strong> <strong>${contract.from}</strong>`);
        instructions.push(`<strong>Waypoint:</strong> ${contract.waypoint.lat}Â°N, ${Math.abs(contract.waypoint.lon)}Â°W (${contract.waypoint.bearing}Â° / ${contract.waypoint.distance} nm)`);
        instructions.push(`<strong>Return:</strong> Back to <strong>${contract.from}</strong>`);
      } else {
        instructions.push(`<strong>Departure:</strong> <strong>${contract.from}</strong>`);
        instructions.push(`<strong>Destination:</strong> <strong>${contract.to}</strong>`);
      }
      
      // Fuel state (only for owned aircraft/training - contract pilot uses operator's fuel)
      if (contract.contractType !== 'contract') {
        const currentFuel = fleetInfo ? fleetInfo.currentFuel : aircraft.fuel_capacity;
        const fuelPercent = Math.round((currentFuel / aircraft.fuel_capacity) * 100);
        instructions.push(`<br><strong>Fuel State:</strong> Set to <strong>${currentFuel.toFixed(1)} gallons</strong> (${fuelPercent}% capacity)`);
      } else {
        instructions.push(`<br><strong>Fuel:</strong> Aircraft will be fueled by operator (set to 75-100% in sim)`);
      }
      
      // Payload instructions
      if (contract.passengers > 0 || contract.cargoLbs > 0) {
        instructions.push(`<br><strong>Payload Setup:</strong>`);
        if (contract.passengers > 0) {
          const paxWeight = contract.passengers * 170; // ~170 lbs per passenger
          const seating = contract.passengers === 1 ? 'front right seat' : 
                          contract.passengers === 2 ? 'front right and rear left seats' :
                          contract.passengers === 3 ? 'front right and both rear seats' :
                          'all passenger seats';
          instructions.push(`&nbsp;&nbsp;â€¢ Load <strong>${contract.passengers} passengers</strong> (~${paxWeight} lbs) in ${seating}`);
        }
        if (contract.cargoLbs > 0) {
          instructions.push(`&nbsp;&nbsp;â€¢ Load <strong>${contract.cargoLbs} lbs cargo</strong> in baggage compartment`);
        }
        instructions.push(`&nbsp;&nbsp;â€¢ Verify weight & balance before departure`);
      }
      
      // Mission-specific notes
      const missionNotes = getMissionNotes(contract.missionType, contract, aircraft);
      if (missionNotes) {
        instructions.push(`<br><strong>Mission Notes:</strong>`);
        // Override for tutorial flights
        if (scheduled?.isTutorial || contract.contractType === 'tutorial') {
          if (!S.pilot.certificates.includes('private')) {
            const hoursRemaining = Math.max(0, CERT_REQUIREMENTS.private.hoursTotal - S.totalHoursFlown - (contract.distance / cruiseSpeed));
            instructions.push(`This is a training flight to build hours toward your Private Pilot certificate. You currently have ${S.totalHoursFlown.toFixed(1)} hours logged. After this flight, you'll need ${hoursRemaining.toFixed(1)} more hours before your PPL checkride.`);
          } else {
            instructions.push(`This is a proficiency flight to maintain currency and build experience. Total hours: ${S.totalHoursFlown.toFixed(1)}.`);
          }
        } else {
          instructions.push(missionNotes);
        }
      }
      
      // Completion instruction
      if (scheduled?.isTutorial || contract.contractType === 'tutorial') {
        instructions.push(`<br>When complete, return here and click <strong>"Finish Flight"</strong> to log your hours.`);
      } else {
        instructions.push(`<br>When complete, return here and click <strong>"Finish Flight"</strong> to log your hours and receive payment.`);
      }
      
      // Add tip about recording real data
      instructions.push(`<br><span style="color: var(--muted); font-size: 11px;">ðŸ’¡ <strong>Tip:</strong> Want accurate stats? Note your actual flight time and fuel remaining in the sim. You can enter these values in post-flight to track real consumption.</span>`);
      
      return instructions.join('<br>');
    }
    
    // Get weather modifications for MSFS2024 presets
    function getWeatherModifications(weather) {
      const mods = {
        'Fog': 'Set visibility to 1/4 - 1 SM in weather settings',
        'Haze': 'Reduce visibility to 3-5 SM',
        'Light Rain': 'Optional: Add light winds 5-10 kts',
        'Rain Showers': 'Set visibility 2-4 SM, winds 10-15 kts gusting',
        'Thunderstorms': 'Set visibility 1-3 SM, winds 15-25 kts gusting, expect turbulence',
        'Light Snow': 'Set visibility 2-4 SM, temperature below freezing',
        'Heavy Snow': 'Set visibility 1/2 - 1 SM, temperature below freezing, winds 10-20 kts',
        'Overcast': 'Set ceiling 1000-2500 ft AGL for IFR conditions',
        'Broken Clouds': 'Set ceiling 2500-4500 ft AGL'
      };
      return mods[weather] || null;
    }
    
    // Get mission-specific flying notes
    function getMissionNotes(missionType, contract, aircraft) {
      const notes = {
        'Sightseeing Tour': `Fly at scenic altitudes (1,500-3,000 ft AGL). Point out landmarks to passengers. Smooth, gentle maneuvers appreciated.`,
        'Discovery Flight': `Let your passenger experience the controls during cruise. Explain basic maneuvers. Keep it smooth and enjoyable.`,
        'Training Flight': `Building flight hours toward your certificate. Practice maneuvers, pattern work, and cross-country navigation. Focus on proficiency.`,
        'Charter Flight': `Professional service expected. Minimize turbulence exposure. Communicate delays promptly.`,
        'General Cargo': `Secure cargo before flight. Monitor CG throughout. Standard cargo handling procedures.`,
        'Mail Run': `Time-sensitive delivery. Efficient routing preferred. Standard mail handling procedures.`,
        'Aerial Photography': `Stable platform required. Coordinate with photographer on altitude and speed. Orbits as requested.`,
        'Aerial Survey': `Fly grid pattern as briefed. Maintain consistent altitude and speed. GPS track recommended.`,
        'Bush Resupply': `Remote strip operations. Check runway conditions. Soft field techniques may be required.`,
        'Executive Transport': `White glove service. Smooth flight priority. Professional demeanor required.`,
        'Medical Transfer': `Patient comfort critical. Smooth flight essential. Coordinate with medical crew on altitude restrictions.`,
        'Thrill Flight': `Aerobatic clearance required. Brief passenger on maneuvers. G-awareness important.`,
        'Air Ambulance': `URGENT: Time-critical patient transport. Expedite all phases of flight. Coordinate with receiving facility.`,
        'Ferry Flight': `Repositioning flight. Pilot-only, no payload. Check destination weather and NOTAMs.`,
        'Search Support': `Coordinate with search command. Fly assigned grid. Report all sightings immediately.`,
        'Heli Tour': `Scenic route as briefed. Stable hover for photos. Narrate points of interest.`,
        'Heli Charter': `Point-to-point transport. Standard helicopter procedures. LZ coordination required.`
      };
      
      return notes[missionType] || null;
    }

    function renderPostflight() {
      const container = document.getElementById('postflightContent');
      
      if (!S.activeContractId || !S.flightStarted) {
        container.innerHTML = '<div class="empty-state">Complete your pre-flight briefing and click "Finish Flight" to record your flight.</div>';
        return;
      }
      
      const scheduled = S.scheduledFlights.find(sf => sf.contractId === S.activeContractId);
      const contract = scheduled ? scheduled.contract : null;
      
      if (!contract) {
        container.innerHTML = '<div class="empty-state">Contract not found.</div>';
        return;
      }
      
      const aircraft = getAircraft(contract.aircraftCode);
      const cruiseSpeed = aircraft.cruise_speed || aircraft.cruiseSpeed;
      const estimatedTime = (contract.distance / cruiseSpeed).toFixed(1);
      const fleetInfo = S.fleetData[contract.aircraftCode];
      const startingFuel = fleetInfo ? fleetInfo.currentFuel : aircraft.fuel_capacity;
      
      // Determine if mission has passengers
      const hasPassengers = contract.passengers > 0;
      
      // Contract pilots don't track fuel - owner provides it
      const isContractFlight = contract.contractType !== 'owned' && !scheduled.isTutorial;
      
      container.innerHTML = `
        <div style="margin-bottom: 20px; padding: 12px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px;">
          <h3 style="margin-bottom: 8px;">${contract.missionType}</h3>
          <div style="color: var(--muted); font-size: 13px;">
            ${contract.from} â†’ ${contract.to} (${contract.distance} nm) â€¢ ${aircraft.name}
          </div>
        </div>
        
        <p style="color: var(--muted); margin-bottom: 20px; font-size: 13px;">
          <strong>Instructions:</strong> Enter the actual results from your flight. Be honest - this is an self-assessment that affects your reputation and aircraft condition.
        </p>
        
        <h3 style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Flight Data</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
          <div class="form-group">
            <label class="form-label">Block Time (hours)</label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="blockTimeInput" step="0.1" min="0.1" value="${estimatedTime}" style="flex: 1;">
              <button class="btn" onclick="document.getElementById('blockTimeInput').value = ${estimatedTime}">Est</button>
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">Expected: ~${estimatedTime} hrs</div>
          </div>
          
          ${!isContractFlight ? `
          <div class="form-group">
            <label class="form-label">Fuel Remaining (gal)</label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="fuelRemainingInput" step="0.1" min="0" max="${aircraft.fuel_capacity}" placeholder="Enter actual" style="flex: 1;">
              <button class="btn" onclick="document.getElementById('fuelRemainingInput').value = ${Math.max(0, startingFuel - (parseFloat(estimatedTime) * (aircraft.fuel_burn_rate || 10))).toFixed(1)}">Estimate</button>
            </div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">Started: ${startingFuel.toFixed(1)} gal â€¢ Use sim fuel gauge if possible</div>
          </div>
          ` : `
          <div class="form-group">
            <label class="form-label">Fuel</label>
            <div style="padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--muted); font-size: 13px;">
              âœ“ Provided by aircraft owner
            </div>
          </div>
          `}
        </div>
        
        ${!isContractFlight ? `
        <!-- Enroute Refueling Section -->
        <div id="enrouteRefuelSection" style="margin-bottom: 24px; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 14px;">Enroute Refueling</h3>
            <button class="btn" onclick="addFuelStop()" style="font-size: 11px; padding: 4px 10px;">+ Add Fuel Stop</button>
          </div>
          
          ${scheduled.needsEnrouteRefuel ? `
          <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid var(--warning); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
            <div style="font-size: 12px; color: var(--warning);">â›½ This flight required enroute refueling</div>
            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">Suggested fuel purchase: ~${scheduled.enrouteFuelNeeded || 0} gallons</div>
          </div>
          ` : `
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
            Did you refuel during this flight? Add fuel stops below.
          </div>
          `}
          
          <div id="fuelStopsList"></div>
          
          <div id="fuelStopsSummary" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
              <span>Total Purchased Enroute:</span>
              <span id="totalEnrouteFuel" style="font-weight: 600;">0.0 gal</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 4px;">
              <span>Estimated Cost:</span>
              <span id="totalEnrouteCost">$0.00</span>
            </div>
          </div>
        </div>
        ` : ''}
        
        <h3 style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Flight Quality Assessment</h3>
        <p style="color: var(--muted); margin-bottom: 16px; font-size: 13px;">Rate each aspect of your flight honestly.</p>
        
        <div style="display: grid; gap: 12px; margin-bottom: 24px;">
          
          <!-- Navigation -->
          <div class="form-group">
            <label class="form-label">Navigation</label>
            <select id="navRating" onchange="updateOverallRating()" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px;">
              <option value="5">5 - Perfect navigation, precise routing throughout</option>
              <option value="4" selected>4 - Good navigation, minor deviations quickly corrected</option>
              <option value="3">3 - Some navigation errors, occasional course corrections needed</option>
              <option value="2">2 - Multiple wrong turns, required significant corrections</option>
              <option value="1">1 - Major navigation errors, got significantly off course</option>
              <option value="0">0 - Got completely lost, failed to reach destination</option>
            </select>
          </div>
          
          <!-- Approach & Landing -->
          <div class="form-group">
            <label class="form-label">Approach & Landing</label>
            <select id="landingRating" onchange="updateOverallRating()" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px;">
              <option value="5">5 - Greased it, perfectly smooth touchdown</option>
              <option value="4" selected>4 - Good landing, slight float or firm but controlled</option>
              <option value="3">3 - Acceptable landing, minor bounce or firm touchdown</option>
              <option value="2">2 - Hard landing, significant bounce, possible stress</option>
              <option value="1">1 - Very hard landing, likely caused damage</option>
              <option value="0">0 - Crashed, gear collapse, or runway excursion</option>
            </select>
          </div>
          
          <!-- Procedures & Checklists -->
          <div class="form-group">
            <label class="form-label">Procedures & Checklists</label>
            <select id="proceduresRating" onchange="updateOverallRating()" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px;">
              <option value="5">5 - By the book, all checklists completed properly</option>
              <option value="4" selected>4 - Good adherence, minor omissions</option>
              <option value="3">3 - Completed most procedures, some items skipped</option>
              <option value="2">2 - Missed several checklist items, rushed procedures</option>
              <option value="1">1 - Skipped most checklists, multiple safety oversights</option>
              <option value="0">0 - Ignored all procedures, dangerous operation</option>
            </select>
          </div>
          
          ${hasPassengers ? `
          <!-- Passenger Comfort (only for passenger missions) -->
          <div class="form-group">
            <label class="form-label">Passenger Comfort</label>
            <select id="comfortRating" onchange="updateOverallRating()" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px;">
              <option value="5">5 - Excellent service, passengers delighted</option>
              <option value="4" selected>4 - Smooth flight, professional service</option>
              <option value="3">3 - Acceptable comfort, some bumps noticed</option>
              <option value="2">2 - Uncomfortable flight, multiple complaints likely</option>
              <option value="1">1 - Very rough flight, passengers sick or scared</option>
              <option value="0">0 - Passengers injured or severely distressed</option>
            </select>
          </div>
          ` : ''}
          
          <!-- Time and Fuel Efficiency -->
          <div class="form-group">
            <label class="form-label">Time & Fuel Efficiency</label>
            <select id="timeRating" onchange="updateOverallRating()" style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px;">
              <option value="5">5 - Perfect timing, optimal fuel management</option>
              <option value="4" selected>4 - On time, good fuel efficiency</option>
              <option value="3">3 - Minor delays, acceptable fuel usage</option>
              <option value="2">2 - Significantly behind schedule, inefficient routing</option>
              <option value="1">1 - Severely late, poor fuel management</option>
              <option value="0">0 - Massive delays or ran critically low on fuel</option>
            </select>
          </div>
          
        </div>
        
        <!-- Overall Rating Display -->
        <div style="padding: 16px; background: var(--panel); border: 2px solid var(--border); border-radius: 8px; margin-bottom: 24px; text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">OVERALL FLIGHT RATING</div>
          <div id="overallRating" style="font-size: 32px; font-weight: 700; color: var(--success);">4.0</div>
          <div id="ratingStars" style="font-size: 24px; margin-top: 4px;">â˜…â˜…â˜…â˜…â˜†</div>
          <div id="ratingDescription" style="font-size: 13px; color: var(--muted); margin-top: 8px;">Good flight with minor issues</div>
        </div>
        
        <h3 style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">Incidents & Issues</h3>
        <p style="color: var(--muted); margin-bottom: 16px; font-size: 13px;">Report any incidents that occurred during the flight.</p>
        
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
          <!-- Operational Events (no penalty) -->
          <div style="background: var(--bg); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase;">Operational Events (no penalty)</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--panel); border-radius: 6px; font-size: 12px;">
                <input type="checkbox" class="damage-check" value="go_around"> Go-around
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--panel); border-radius: 6px; font-size: 12px;">
                <input type="checkbox" class="damage-check" value="diversion"> Diverted to alternate
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--panel); border-radius: 6px; font-size: 12px;">
                <input type="checkbox" class="damage-check" value="emergency"> Emergency declared
              </label>
            </div>
          </div>
          
          <!-- Regulatory Issues -->
          <div style="background: var(--bg); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; color: var(--warning); margin-bottom: 8px; text-transform: uppercase;">âš ï¸ Regulatory Issues</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--panel); border-radius: 6px; font-size: 12px;">
                <input type="checkbox" class="damage-check" value="airspace_violation"> Airspace violation
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--panel); border-radius: 6px; font-size: 12px;">
                <input type="checkbox" class="damage-check" value="runway_incursion"> Runway incursion
              </label>
            </div>
          </div>
          
          <!-- Aircraft Damage - Dynamic Rows -->
          <div style="background: var(--bg); border-radius: 8px; padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-size: 11px; color: var(--danger); text-transform: uppercase;">ðŸ”§ Aircraft Damage (generates squawks)</div>
              <button type="button" onclick="addIncidentRow()" style="background: var(--accent); color: var(--bg); border: none; border-radius: 4px; padding: 4px 10px; font-size: 11px; cursor: pointer;">+ Add Incident</button>
            </div>
            <div id="incidentRows" style="display: flex; flex-direction: column; gap: 8px;">
              <!-- Dynamic incident rows will be added here -->
            </div>
            <div id="noIncidentsMsg" style="color: var(--muted); font-size: 12px; font-style: italic; padding: 8px 0;">No damage incidents reported. Click "Add Incident" if aircraft was damaged.</div>
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 24px;">
          <label class="form-label">Flight Notes (optional)</label>
          <textarea id="flightNotes" rows="2" style="width: 100%; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;" placeholder="Any notes about the flight..."></textarea>
        </div>
        
        <button class="btn primary" onclick="recordFlight()" style="width: 100%; padding: 12px; font-size: 16px;">Complete Flight Report</button>
      `;
      
      // Initialize the overall rating display
      updateOverallRating();
      
      // Initialize fuel stops display (if section exists)
      if (document.getElementById('fuelStopsList')) {
        renderFuelStops();
      }
    }
    
    // Incident type definitions with categories and default severities
    const INCIDENT_TYPES = {
      hard_landing: { label: 'Hard Landing', category: 'gear', defaultSeverity: 'moderate' },
      engine_overstress: { label: 'Engine Overstress', category: 'engine', defaultSeverity: 'serious' },
      prop_strike: { label: 'Prop Strike', category: 'engine', defaultSeverity: 'critical' },
      gear_damage: { label: 'Gear/Tire Damage', category: 'gear', defaultSeverity: 'moderate' },
      structural: { label: 'Structural Damage', category: 'airframe', defaultSeverity: 'serious' },
      bird_strike: { label: 'Bird Strike', category: 'airframe', defaultSeverity: 'moderate' },
      lightning_strike: { label: 'Lightning Strike', category: 'airframe', defaultSeverity: 'moderate' },
      turbulence_damage: { label: 'Turbulence Damage', category: 'airframe', defaultSeverity: 'minor' },
      fod_damage: { label: 'FOD Damage', category: 'airframe', defaultSeverity: 'minor' },
      other: { label: 'Other', category: 'airframe', defaultSeverity: 'minor' }
    };
    
    const SEVERITY_LEVELS = {
      minor: { label: 'Minor', description: 'Cosmetic or very minor damage', conditionImpact: 2, color: 'var(--muted)' },
      moderate: { label: 'Moderate', description: 'Requires inspection, may need repair', conditionImpact: 5, color: 'var(--warning)' },
      serious: { label: 'Serious', description: 'Significant damage, repair required', conditionImpact: 10, color: 'var(--danger)' },
      critical: { label: 'Critical', description: 'Major damage, aircraft may be grounded', conditionImpact: 20, color: '#ff0000' }
    };
    
    let incidentRowCounter = 0;
    
    function addIncidentRow() {
      const container = document.getElementById('incidentRows');
      const noMsg = document.getElementById('noIncidentsMsg');
      if (noMsg) noMsg.style.display = 'none';
      
      const rowId = `incident_${incidentRowCounter++}`;
      
      const typeOptions = Object.entries(INCIDENT_TYPES)
        .map(([key, val]) => `<option value="${key}">${val.label}</option>`)
        .join('');
      
      const severityOptions = Object.entries(SEVERITY_LEVELS)
        .map(([key, val]) => `<option value="${key}">${val.label} - ${val.description}</option>`)
        .join('');
      
      const rowHTML = `
        <div id="${rowId}" class="incident-row" style="display: flex; gap: 8px; align-items: center; padding: 8px; background: var(--panel); border-radius: 6px; border: 1px solid var(--border);">
          <select class="incident-type" onchange="updateIncidentSeverity('${rowId}')" style="flex: 1; padding: 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;">
            <option value="">-- Select Incident --</option>
            ${typeOptions}
          </select>
          <select class="incident-severity" style="flex: 1; padding: 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;">
            <option value="">-- Select Severity --</option>
            ${severityOptions}
          </select>
          <button type="button" onclick="removeIncidentRow('${rowId}')" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer;">âœ•</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', rowHTML);
    }
    window.addIncidentRow = addIncidentRow;
    
    function removeIncidentRow(rowId) {
      const row = document.getElementById(rowId);
      if (row) row.remove();
      
      // Show "no incidents" message if no rows left
      const container = document.getElementById('incidentRows');
      const noMsg = document.getElementById('noIncidentsMsg');
      if (container && container.children.length === 0 && noMsg) {
        noMsg.style.display = 'block';
      }
    }
    window.removeIncidentRow = removeIncidentRow;
    
    function updateIncidentSeverity(rowId) {
      const row = document.getElementById(rowId);
      if (!row) return;
      
      const typeSelect = row.querySelector('.incident-type');
      const severitySelect = row.querySelector('.incident-severity');
      
      if (typeSelect && severitySelect && typeSelect.value) {
        const incidentDef = INCIDENT_TYPES[typeSelect.value];
        if (incidentDef) {
          severitySelect.value = incidentDef.defaultSeverity;
        }
      }
    }
    window.updateIncidentSeverity = updateIncidentSeverity;
    
    function getReportedIncidents() {
      const rows = document.querySelectorAll('.incident-row');
      const incidents = [];
      
      rows.forEach(row => {
        const typeSelect = row.querySelector('.incident-type');
        const severitySelect = row.querySelector('.incident-severity');
        
        if (typeSelect?.value && severitySelect?.value) {
          const incidentDef = INCIDENT_TYPES[typeSelect.value];
          const severityDef = SEVERITY_LEVELS[severitySelect.value];
          
          incidents.push({
            type: typeSelect.value,
            label: incidentDef?.label || typeSelect.value,
            category: incidentDef?.category || 'airframe',
            severity: severitySelect.value,
            conditionImpact: severityDef?.conditionImpact || 5
          });
        }
      });
      
      return incidents;
    }
    
    function updateOverallRating() {
      const nav = parseInt(document.getElementById('navRating')?.value || 4);
      const landing = parseInt(document.getElementById('landingRating')?.value || 4);
      const procedures = parseInt(document.getElementById('proceduresRating')?.value || 4);
      const comfortEl = document.getElementById('comfortRating');
      const hasComfort = comfortEl !== null;
      const comfort = hasComfort ? parseInt(comfortEl.value || 4) : null;
      const time = parseInt(document.getElementById('timeRating')?.value || 4);
      
      // Weighted calculation - adjust if no passenger comfort rating
      let weighted;
      let minimum;
      
      if (hasComfort) {
        // With passengers: Landing 25%, Procedures 20%, Navigation 20%, Comfort 20%, Time 15%
        weighted = (landing * 0.25) + (procedures * 0.20) + (nav * 0.20) + (comfort * 0.20) + (time * 0.15);
        minimum = Math.min(nav, landing, procedures, comfort, time);
      } else {
        // No passengers: Landing 30%, Procedures 25%, Navigation 25%, Time 20%
        weighted = (landing * 0.30) + (procedures * 0.25) + (nav * 0.25) + (time * 0.20);
        minimum = Math.min(nav, landing, procedures, time);
      }
      
      // Apply minimum rule - if any category is 0-1, cap overall at that level + 1
      let overall = weighted;
      if (minimum <= 1) {
        overall = Math.min(overall, minimum + 1);
      }
      
      overall = Math.round(overall * 10) / 10; // Round to 1 decimal
      
      // Update display
      const ratingEl = document.getElementById('overallRating');
      const starsEl = document.getElementById('ratingStars');
      const descEl = document.getElementById('ratingDescription');
      
      if (ratingEl) {
        ratingEl.textContent = overall.toFixed(1);
        
        // Color based on rating
        if (overall >= 4.5) {
          ratingEl.style.color = 'var(--success)';
        } else if (overall >= 3.5) {
          ratingEl.style.color = 'var(--accent)';
        } else if (overall >= 2.5) {
          ratingEl.style.color = 'var(--warning)';
        } else {
          ratingEl.style.color = 'var(--danger)';
        }
      }
      
      if (starsEl) {
        const fullStars = Math.floor(overall);
        const halfStar = (overall - fullStars) >= 0.5;
        let stars = 'â˜…'.repeat(fullStars);
        if (halfStar && fullStars < 5) stars += 'Â½';
        stars += 'â˜†'.repeat(Math.max(0, 5 - fullStars - (halfStar ? 1 : 0)));
        starsEl.textContent = stars;
      }
      
      if (descEl) {
        const descriptions = [
          'Catastrophic failure - Loss of aircraft or serious incident',
          'Dangerous flight - Multiple critical errors',
          'Poor performance - Significant problems',
          'Below average - Notable issues affected the mission',
          'Acceptable flight - Minor deviations from standards',
          'Good flight - Met expectations with minor issues',
          'Very good - Professional execution',
          'Excellent - Above standard performance',
          'Outstanding - Near-perfect execution',
          'Exceptional - Textbook perfect flight',
          'Perfect - Flawless in every aspect'
        ];
        const descIndex = Math.min(10, Math.floor(overall * 2));
        descEl.textContent = descriptions[descIndex];
      }
    }
    
    window.updateOverallRating = updateOverallRating;

    function switchTab(tabName) {
      // Reset calendar view to today when switching to calendar tab
      if (tabName === 'calendar') {
        S.calendarViewDate = { 
          year: S.gameTime.year, 
          month: S.gameTime.month, 
          day: S.gameTime.day,
          hour: 0,
          minute: 0
        };
      }
      
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.toggle('active', tab.id === tabName);
      });
      render();
    }

    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    
    // Right column sidebar tab switching
    document.querySelectorAll('.right-sidebar-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.rightTab;
        
        // Update sidebar buttons
        document.querySelectorAll('.right-sidebar-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.right-tab-content').forEach(c => c.classList.remove('active'));
        const activeTab = document.getElementById(`${tabName}-tab`);
        if (activeTab) {
          activeTab.classList.add('active');
          
          // Activate first subtab in the newly opened tab
          const firstSubtab = activeTab.querySelector('.right-subtab');
          if (firstSubtab) {
            firstSubtab.click();
          }
        }
        
        render();
      });
    });
    
    // Right column subtab switching
    document.querySelectorAll('.right-subtab').forEach(btn => {
      btn.addEventListener('click', () => {
        const subtabName = btn.dataset.rightSubtab;
        const parentTab = btn.closest('.right-tab-content');
        
        // Update subtab buttons within this parent tab only
        parentTab.querySelectorAll('.right-subtab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        // Update subtab content within this parent tab only
        parentTab.querySelectorAll('.right-subtab-content').forEach(c => c.classList.remove('active'));
        const subtabContent = parentTab.querySelector(`#${subtabName}-subtab`);
        if (subtabContent) subtabContent.classList.add('active');
        
        // Render settings content if preferences subtab is activated
        if (subtabName === 'preferences') {
          // Render the active settings section (default is 'game')
          const activeSection = document.querySelector('.settings-section-btn.active');
          const sectionName = activeSection?.dataset.section || 'game';
          switchSettingsSection(sectionName);
        }
        
        // Re-render if needed
        render();
      });
    });
    
    // Game menu modal
    function openGameMenu() {
      document.getElementById('gameMenuModal').classList.add('open');
      // Update mode label
      const modeLabel = document.getElementById('gameModeLabel');
      if (modeLabel) {
        modeLabel.textContent = S.gameMode === 'sandbox' ? 'Switch to Career Mode' : 'Switch to Sandbox Mode';
      }
    }
    window.openGameMenu = openGameMenu;
    
    function closeGameMenu() {
      document.getElementById('gameMenuModal').classList.remove('open');
    }
    window.closeGameMenu = closeGameMenu;
    
    // Close modal when clicking backdrop
    document.getElementById('gameMenuModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('game-menu-modal')) {
        closeGameMenu();
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeGameMenu();
        closeAircraftBrowser();
      }
      // Backtick key toggles debug panel
      if (e.key === '`') {
        const panel = document.getElementById('debugPanel');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          if (panel.style.display === 'block') {
            updateDebugDisplays();
          }
        }
      }
    });

    window.toggleGameMode = toggleGameMode;
    window.togglePilotCertificate = togglePilotCertificate;
    window.togglePilotRating = togglePilotRating;
    window.toggleAircraftCertification = toggleAircraftCertification;
    window.refuelAircraft = refuelAircraft;
    window.recordFlight = recordFlight;
    window.calculateBlockTime = calculateBlockTime;
    window.calculateFuelRemaining = calculateFuelRemaining;
    window.advanceTime = advanceTime;
    window.advanceToNextDay = advanceToNextDay;
    window.advanceToNextFlight = advanceToNextFlight;
    window.resetGame = resetGame;
    
    // Navigate to Certs & Ratings subtab
    function viewCertifications() {
      // Switch to pilot tab (right sidebar)
      const pilotTab = document.querySelector('[data-right-tab="pilot"]');
      if (pilotTab) pilotTab.click();
      
      // Then switch to certifications subtab
      setTimeout(() => {
        const certSubtab = document.querySelector('[data-right-subtab="certifications"]');
        if (certSubtab) certSubtab.click();
      }, 100);
    }
    window.viewCertifications = viewCertifications;
    
    window.confirmHomeBase = confirmHomeBase;
    window.changeHomeBase = changeHomeBase;
    window.clearCacheAndReload = clearCacheAndReload;
    window.startScheduledFlight = startScheduledFlight;
    window.cancelScheduledFlight = cancelScheduledFlight;
    window.goToPostFlight = goToPostFlight;
    window.cancelFlight = cancelFlight;
    window.shiftCalendarView = shiftCalendarView;
    window.resetCalendarToToday = resetCalendarToToday;
    window.selectFlightFromCalendar = selectFlightFromCalendar;
    window.selectEmail = selectEmail;
    window.deleteEmail = deleteEmail;
    window.submitBid = submitBid;
    window.acceptEmailContract = acceptEmailContract;
    window.openBidCalculator = openBidCalculator;
    window.closeBidCalculator = closeBidCalculator;
    window.estimateCost = estimateCost;
    window.updateTotalCost = updateTotalCost;
    window.updateBidSummary = updateBidSummary;
    window.submitBidFromCalculator = submitBidFromCalculator;
    window.acceptFixedPriceContract = acceptFixedPriceContract;
    window.acceptCounterOffer = acceptCounterOffer;
    window.rejectCounterOffer = rejectCounterOffer;
    window.processMissedFlight = processMissedFlight;
    window.scheduleCheckride = scheduleCheckride;
    window.openCheckrideScheduler = openCheckrideScheduler;
    window.handleDevCheckrideSelect = handleDevCheckrideSelect;

    // Status: 95% complete, ~30 seconds remaining
    // Finalizing initialization...

    function startGame() {
      const loadingScreen = document.getElementById('loadingScreen');
      loadingScreen.classList.add('hidden');
      
      S = loadState();
      
      debugLog('startGame - S.bases.primary', S.bases.primary);
      debugLog('startGame - S.scheduledFlights', S.scheduledFlights);
      debugLog('startGame - AIRPORTS count', Object.keys(AIRPORTS).length);
      debugLog('startGame - Sample AIRPORTS[S.bases.primary]', AIRPORTS[S.bases.primary]);
      
      // Check if player needs to select home base
      if (!S.bases.primary) {
        debugLog('No home base - showing selection');
        showHomeBaseSelection();
        return;
      }
      
      debugLog('Home base exists - starting game');
      ensureOwnedCertified();
      ensureEmails();
      saveState();
      render();
    }
    
    function showHomeBaseSelection() {
      // Hide loading screen
      const loadingScreen = document.getElementById('loadingScreen');
      loadingScreen.classList.add('hidden');
      
      // Update time display
      document.getElementById('timeDisplay').textContent = formatGameTime(S.gameTime);
      
      // Hide time controls and nav during setup
      document.querySelector('.time-controls').style.display = 'none';
      document.querySelector('nav').style.display = 'none';
      
      debugLog('showHomeBaseSelection - AIRPORTS keys', Object.keys(AIRPORTS).length);
      debugLog('showHomeBaseSelection - Sample airport KJFK', AIRPORTS['KJFK']);
      
      // Show step 1: Welcome
      showSetupStep1();
    }
    
    // Setup state
    let setupState = {
      step: 1,
      pilotName: '',
      gameMode: 'career',
      startingHours: 38,
      scenario: 'inheritance',
      selectedAircraft: 0,
      customSettings: {
        cash: 25000,
        locLimit: 25000,
        locApr: 6,
        locBalance: 0,
        ownerSalary: 4000
      },
      homeBase: ''
    };
    
    function showSetupStep1() {
      setupState.step = 1;
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 32px; max-width: 500px; text-align: center;">
            <h2 style="margin-bottom: 12px;">âœˆï¸ Welcome to Skylift Ledger</h2>
            <p style="color: var(--muted); margin-bottom: 8px;">A companion app for your flight sim career mode.</p>
            <p style="color: var(--muted); margin-bottom: 24px; font-size: 13px;">Track flights, manage contracts, build your aviation business.</p>
            
            <div style="border-top: 1px solid var(--border); padding-top: 20px;">
              <h3 style="margin-bottom: 10px; font-size: 15px;">What's Your Name, Pilot?</h3>
              <div class="form-group" style="margin-bottom: 24px;">
                <input type="text" id="pilotNameInput" placeholder="Enter your name" maxlength="40" 
                       value="${setupState.pilotName}"
                       style="width: 100%; text-align: center; font-size: 16px;">
              </div>
              
              <h3 style="margin-bottom: 10px; font-size: 15px;">Game Mode</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px;">
                <div id="careerModeCard" class="mode-card ${setupState.gameMode === 'career' ? 'selected' : ''}" onclick="selectSetupGameMode('career')" 
                     style="padding: 12px; border: 2px solid ${setupState.gameMode === 'career' ? 'var(--warning)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; background: ${setupState.gameMode === 'career' ? 'rgba(251, 191, 36, 0.1)' : 'transparent'};">
                  <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px; color: var(--warning);">ðŸŽ¯ Career</div>
                  <div style="font-size: 11px; color: var(--muted);">Choose starting scenario. Realistic progression.</div>
                </div>
                <div id="sandboxModeCard" class="mode-card ${setupState.gameMode === 'sandbox' ? 'selected' : ''}" onclick="selectSetupGameMode('sandbox')"
                     style="padding: 12px; border: 2px solid ${setupState.gameMode === 'sandbox' ? 'var(--accent)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; background: ${setupState.gameMode === 'sandbox' ? 'rgba(96, 165, 250, 0.1)' : 'transparent'};">
                  <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px; color: var(--accent);">âœˆï¸ Sandbox</div>
                  <div style="font-size: 11px; color: var(--muted);">All certificates unlocked. Fly anything.</div>
                </div>
              </div>
              
              <button class="btn primary" id="step1NextBtn" onclick="goToSetupStep2()" disabled style="width: 100%;">
                Next â†’
              </button>
            </div>
          </div>
        </div>
      `;
      
      const nameInput = document.getElementById('pilotNameInput');
      const nextBtn = document.getElementById('step1NextBtn');
      
      function validateStep1() {
        const name = nameInput.value.trim();
        nextBtn.disabled = name.length === 0;
        setupState.pilotName = name;
      }
      
      nameInput.addEventListener('input', validateStep1);
      validateStep1();
    }
    
    function selectSetupGameMode(mode) {
      setupState.gameMode = mode;
      
      const careerCard = document.getElementById('careerModeCard');
      const sandboxCard = document.getElementById('sandboxModeCard');
      
      if (mode === 'career') {
        careerCard.style.border = '2px solid var(--warning)';
        careerCard.style.background = 'rgba(251, 191, 36, 0.1)';
        sandboxCard.style.border = '2px solid var(--border)';
        sandboxCard.style.background = 'transparent';
      } else {
        sandboxCard.style.border = '2px solid var(--accent)';
        sandboxCard.style.background = 'rgba(96, 165, 250, 0.1)';
        careerCard.style.border = '2px solid var(--border)';
        careerCard.style.background = 'transparent';
      }
    }
    window.selectSetupGameMode = selectSetupGameMode;
    
    function goToSetupStep2() {
      setupState.pilotName = document.getElementById('pilotNameInput').value.trim();
      
      if (setupState.gameMode === 'sandbox') {
        // Skip scenario selection for sandbox, go straight to home base
        showSetupStep3();
      } else {
        showSetupStep2();
      }
    }
    window.goToSetupStep2 = goToSetupStep2;
    
    function showSetupStep2() {
      setupState.step = 2;
      const mainContent = document.getElementById('mainContent');
      
      const scenarios = ['inheritance', 'rotorhead', 'bootstrap', 'leveraged'];
      
      mainContent.innerHTML = `
        <div class="scenario-page">
          <div class="scenario-header">
            <h1>âœˆï¸ Start Your Career</h1>
            <p>Choose your starting scenario or build your own</p>
          </div>
          
          <div class="scenarios-grid">
            ${scenarios.map(key => {
              const s = STARTING_SCENARIOS[key];
              return `
                <div class="scenario-card ${setupState.scenario === key ? 'selected' : ''}" onclick="selectScenario('${key}')">
                  <div class="scenario-icon">${s.icon}</div>
                  <div class="scenario-name">${s.name}</div>
                  <div class="scenario-difficulty ${s.difficulty}">${s.difficultyLabel}</div>
                  <div class="scenario-description">${s.description}</div>
                  <div class="scenario-stats">
                    <div class="scenario-stat-row">
                      <span class="label">Starting Cash</span>
                      <span class="value">${formatCurrency(s.cash)}</span>
                    </div>
                    <div class="scenario-stat-row">
                      <span class="label">Line of Credit</span>
                      <span class="value">${formatCurrency(s.locLimit)}</span>
                    </div>
                    <div class="scenario-stat-row">
                      <span class="label">${s.hasLoan ? 'Aircraft Loan' : 'Debt'}</span>
                      <span class="value ${s.hasLoan ? 'negative' : 'positive'}">${s.hasLoan ? 'See below' : '$0'}</span>
                    </div>
                  </div>
                  ${s.hasAircraft && s.aircraftOptions.length > 0 ? `
                    <div class="aircraft-select">
                      <div class="aircraft-select-label">${s.hasLoan ? 'Your Financed Aircraft' : key === 'inheritance' ? 'Choose Your Inheritance' : 'Your Starting Aircraft'}</div>
                      <div class="aircraft-options" id="aircraft-${key}">
                        ${s.aircraftOptions.map((ac, idx) => {
                          const acData = AIRCRAFT[ac.code];
                          const marketValue = acData ? calculateListingPrice(ac.code, ac.year, ac.condition, ac.hours || 0, acData) : 0;
                          const equity = ac.loanAmount ? marketValue - ac.loanAmount : 0;
                          return `
                          <div class="aircraft-option ${setupState.scenario === key && setupState.selectedAircraft === idx ? 'selected' : ''}" 
                               onclick="event.stopPropagation(); selectScenarioAircraft('${key}', ${idx})">
                            <span class="aircraft-radio"></span>
                            <span class="aircraft-name">${ac.name} <span style="color: var(--muted);">(${ac.condition}%)</span></span>
                            ${ac.loanAmount 
                              ? `<span class="aircraft-debt" style="display: flex; gap: 8px;">
                                  <span>${formatCurrency(ac.loanAmount)} loan</span>
                                  <span style="color: var(--success);">${formatCurrency(equity)} equity</span>
                                </span>` 
                              : ''}
                          </div>
                        `}).join('')}
                      </div>
                    </div>
                  ` : !s.hasAircraft ? `
                    <div class="no-aircraft-note">
                      <div class="no-aircraft-icon">ðŸ›’</div>
                      <div class="no-aircraft-text">
                        <strong>No starting aircraft</strong><br>
                        Visit the Aircraft Market after starting to purchase, finance, or lease your first plane.
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
          
          <div class="section-divider">
            <span>Or Build Your Own</span>
          </div>
          
          <!-- Custom Scenario -->
          <div class="scenario-card ${setupState.scenario === 'custom' ? 'selected' : ''}" onclick="selectScenario('custom')" style="max-width: 100%;">
            <div class="custom-scenario-card">
              <div class="custom-intro">
                <div class="scenario-icon">âš™ï¸</div>
                <div class="scenario-name">Custom Scenario</div>
                <div class="scenario-difficulty" style="color: var(--accent);">Your Rules</div>
                <div class="scenario-description">Set every parameter yourself. Build the exact challenge you want.</div>
                
                <div class="custom-assessment" id="customAssessment">
                  ${getCustomAssessmentHTML()}
                </div>
              </div>
              
              <div class="custom-options" onclick="event.stopPropagation();">
                <div class="custom-input-grid">
                  <div class="custom-input-group">
                    <label class="custom-input-label">Starting Cash</label>
                    <input type="text" class="custom-input" id="customCashInput" 
                           value="${setupState.customSettings.cash}" 
                           onchange="updateCustomInput('cash', this.value)"
                           onfocus="this.select()">
                  </div>
                  
                  <div class="custom-input-group">
                    <label class="custom-input-label">Line of Credit Limit</label>
                    <input type="text" class="custom-input" id="customLocInput" 
                           value="${setupState.customSettings.locLimit}"
                           onchange="updateCustomInput('locLimit', this.value)"
                           onfocus="this.select()">
                  </div>
                  
                  <div class="custom-input-group">
                    <label class="custom-input-label">Starting LOC Balance</label>
                    <input type="text" class="custom-input" id="customLocBalInput" 
                           value="${setupState.customSettings.locBalance}"
                           onchange="updateCustomInput('locBalance', this.value)"
                           onfocus="this.select()">
                  </div>
                  
                  <div class="custom-input-group">
                    <label class="custom-input-label">LOC APR (%)</label>
                    <input type="text" class="custom-input" id="customAprInput" 
                           value="${setupState.customSettings.locApr}"
                           onchange="updateCustomInput('locApr', this.value)"
                           onfocus="this.select()">
                  </div>
                  
                  <div class="custom-input-group">
                    <label class="custom-input-label">Owner Monthly Salary</label>
                    <input type="text" class="custom-input" id="customSalaryInput" 
                           value="${setupState.customSettings.ownerSalary}"
                           onchange="updateCustomInput('ownerSalary', this.value)"
                           onfocus="this.select()">
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="scenario-footer">
            <div class="scenario-summary" id="scenarioSummary">
              ${getScenarioSummary()}
            </div>
            <div class="scenario-actions">
              <button class="btn" onclick="showSetupStep1()">â† Back</button>
              <button class="btn primary" onclick="showSetupStep3()">Next: Home Base â†’</button>
            </div>
          </div>
        </div>
      `;
    }
    
    function getScenarioSummary() {
      const s = STARTING_SCENARIOS[setupState.scenario];
      if (setupState.scenario === 'custom') {
        const challenge = getCustomChallengeRating();
        const net = setupState.customSettings.cash - setupState.customSettings.locBalance;
        return `Selected: <strong>Custom</strong> â€” ${formatCurrency(setupState.customSettings.cash)} cash â€¢ ${formatCurrency(setupState.customSettings.locBalance)} debt â€¢ <span style="color: ${net >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(net)} net</span> â€¢ <span class="custom-challenge-badge ${challenge.rating}" style="padding: 2px 8px; font-size: 11px;">${challenge.label}</span>`;
      } else if (s.hasAircraft && s.aircraftOptions.length > 0) {
        const ac = s.aircraftOptions[setupState.selectedAircraft];
        const acData = AIRCRAFT[ac.code];
        const marketValue = acData ? calculateListingPrice(ac.code, ac.year, ac.condition, ac.hours || 0, acData) : 0;
        return `Selected: <strong>${s.name}</strong> â€” ${ac.name} (${formatCurrency(marketValue)}) â€¢ ${formatCurrency(s.cash)} cash â€¢ ${formatCurrency(s.locLimit)} LOC`;
      } else {
        return `Selected: <strong>${s.name}</strong> â€” No aircraft â€¢ ${formatCurrency(s.cash)} cash â€¢ ${formatCurrency(s.locLimit)} LOC`;
      }
    }
    
    function selectScenario(key) {
      setupState.scenario = key;
      setupState.selectedAircraft = 0;
      showSetupStep2(); // Re-render
    }
    window.selectScenario = selectScenario;
    
    function selectScenarioAircraft(scenarioKey, aircraftIdx) {
      setupState.scenario = scenarioKey;
      setupState.selectedAircraft = aircraftIdx;
      showSetupStep2(); // Re-render
    }
    window.selectScenarioAircraft = selectScenarioAircraft;
    
    function getCustomChallengeRating() {
      const { cash, locBalance, ownerSalary } = setupState.customSettings;
      const netPosition = cash - locBalance;
      const runway = ownerSalary > 0 ? cash / ownerSalary : 999;
      
      if (netPosition >= 25000 && runway >= 6) {
        return { rating: 'comfortable', label: 'Comfortable', description: 'Plenty of runway to get started' };
      } else if (netPosition >= 10000 && runway >= 3) {
        return { rating: 'moderate', label: 'Moderate', description: 'Room to breathe, but stay focused' };
      } else if (netPosition >= 0 && runway >= 2) {
        return { rating: 'challenging', label: 'Challenging', description: 'Every flight counts' };
      } else if (netPosition >= -15000 || runway >= 1) {
        return { rating: 'hard', label: 'Hard', description: 'Razor thin margins' };
      } else {
        return { rating: 'brutal', label: 'Brutal', description: 'Good luck, you\'ll need it' };
      }
    }
    
    function getCustomAssessmentHTML() {
      const { cash, locLimit, locBalance, ownerSalary } = setupState.customSettings;
      const netPosition = cash - locBalance;
      const runway = ownerSalary > 0 ? Math.floor(cash / ownerSalary) : 99;
      const challenge = getCustomChallengeRating();
      
      return `
        <div class="custom-assessment-header">Financial Assessment</div>
        <div class="custom-assessment-row">
          <span class="label">Net Position</span>
          <span class="value" style="color: ${netPosition >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(netPosition)}</span>
        </div>
        <div class="custom-assessment-row">
          <span class="label">Available Credit</span>
          <span class="value">${formatCurrency(locLimit - locBalance)}</span>
        </div>
        <div style="text-align: center; margin-top: 12px;">
          <div class="custom-challenge-badge ${challenge.rating}">${challenge.label}</div>
          <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">${challenge.description}</div>
        </div>
      `;
    }
    
    function updateCustomInput(key, rawValue) {
      // Parse the value - strip non-numeric except for decimals
      const cleanValue = rawValue.replace(/[^0-9.]/g, '');
      let value = parseFloat(cleanValue) || 0;
      
      // Apply constraints
      if (key === 'cash') {
        value = Math.max(0, Math.min(10000000, value));
      } else if (key === 'locLimit') {
        value = Math.max(0, Math.min(10000000, value));
        // Ensure balance doesn't exceed new limit
        if (setupState.customSettings.locBalance > value) {
          setupState.customSettings.locBalance = value;
        }
      } else if (key === 'locBalance') {
        value = Math.max(0, Math.min(setupState.customSettings.locLimit, value));
      } else if (key === 'locApr') {
        value = Math.max(0, Math.min(25, value));
      } else if (key === 'ownerSalary') {
        value = Math.max(0, Math.min(50000, value));
      }
      
      setupState.customSettings[key] = value;
      
      // Auto-select custom scenario
      if (setupState.scenario !== 'custom') {
        setupState.scenario = 'custom';
      }
      
      // Update assessment
      const assessmentEl = document.getElementById('customAssessment');
      if (assessmentEl) {
        assessmentEl.innerHTML = getCustomAssessmentHTML();
      }
      
      // Update summary
      const summaryEl = document.getElementById('scenarioSummary');
      if (summaryEl) {
        summaryEl.innerHTML = getScenarioSummary();
      }
      
      // Update the input display (in case we clamped the value)
      const inputEl = document.getElementById(key === 'cash' ? 'customCashInput' : 
                                              key === 'locLimit' ? 'customLocInput' :
                                              key === 'locBalance' ? 'customLocBalInput' :
                                              key === 'locApr' ? 'customAprInput' : 'customSalaryInput');
      if (inputEl) {
        inputEl.value = value;
      }
    }
    window.updateCustomInput = updateCustomInput;
    
    function showSetupStep3() {
      setupState.step = 3;
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
          <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 32px; max-width: 500px; text-align: center;">
            <h2 style="margin-bottom: 12px;">ðŸ“ Choose Your Home Base</h2>
            <p style="color: var(--muted); margin-bottom: 24px; font-size: 13px;">Enter the ICAO code of your home airport. This is where your operations will be based.</p>
            
            <div class="form-group" style="margin-bottom: 12px;">
              <input type="text" id="homeBaseInput" placeholder="e.g., KSEA, KJFK, KMKC" maxlength="4" 
                     value="${setupState.homeBase}"
                     style="width: 100%; text-transform: uppercase; text-align: center; font-size: 24px; font-weight: 600; padding: 16px;">
            </div>
            
            <div id="homeBaseStatus" style="margin-bottom: 24px; min-height: 40px; font-size: 14px;"></div>
            
            <div style="display: flex; gap: 12px;">
              <button class="btn" onclick="${setupState.gameMode === 'career' ? 'showSetupStep2()' : 'showSetupStep1()'}" style="flex: 1;">â† Back</button>
              <button class="btn primary" id="confirmHomeBaseBtn" disabled onclick="confirmHomeBase()" style="flex: 2;">
                Start Flying â†’
              </button>
            </div>
          </div>
        </div>
      `;
      
      const input = document.getElementById('homeBaseInput');
      const status = document.getElementById('homeBaseStatus');
      const btn = document.getElementById('confirmHomeBaseBtn');
      
      function validateHomeBase() {
        const code = input.value.trim().toUpperCase();
        
        if (code.length !== 4) {
          status.innerHTML = '';
          btn.disabled = true;
          return;
        }
        
        if (!AIRPORTS[code]) {
          status.innerHTML = `<span style="color: var(--danger);">Airport ${code} not found in database</span>`;
          btn.disabled = true;
          return;
        }
        
        const airport = AIRPORTS[code];
        status.innerHTML = `<span style="color: var(--success);">${airport.name}</span><br><span style="color: var(--muted);">${airport.city}, ${airport.state}</span>`;
        setupState.homeBase = code;
        btn.disabled = false;
      }
      
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
        validateHomeBase();
      });
      
      if (setupState.homeBase) {
        validateHomeBase();
      }
      
      input.focus();
    }
    window.showSetupStep3 = showSetupStep3;
    
    function selectStartingHours(hours) {
      setupState.startingHours = hours;
    }
    window.selectStartingHours = selectStartingHours;
    
    // Handle game mode selection in initial setup
    function selectGameMode(mode) {
      selectSetupGameMode(mode);
    }
    window.selectGameMode = selectGameMode;
    
    function confirmHomeBase() {
      const code = setupState.homeBase.toUpperCase();
      if (!AIRPORTS[code]) return;
      if (!setupState.pilotName) return;
      
      // Set game time to player's real world date
      const now = new Date();
      S.gameTime = {
        year: now.getFullYear(),
        month: now.getMonth() + 1,  // JS months are 0-indexed
        day: now.getDate(),
        hour: 8,
        minute: 0
      };
      
      S.bases.primary = code;
      
      // Create primary base
      const primaryBase = createPrimaryBase(code);
      S.bases.list = [primaryBase];
      
      S.gameMode = setupState.gameMode;
      S.pilot.name = setupState.pilotName;
      
      // Set up pilot based on mode
      if (setupState.gameMode === 'sandbox') {
        S.pilot.certificates = ['student', 'private', 'commercial', 'atp'];
        S.pilot.ratings = ['night', 'instrument', 'multiEngine', 'helicopter', 'seaplane', 'turbine'];
        S.pilot.aircraftCertifications = ['C172_SKYHAWK', 'PA28_WARRIOR', 'BE36_BONANZA', 'C208_CARAVAN'];
        S.tutorialComplete = true;
        S.totalHoursFlown = 100;
        // Sandbox gets default financials
        S.cash = 50000;
        S.lineOfCredit.limit = 50000;
      } else {
        // Career mode - apply scenario
        S.pilot.certificates = ['student'];
        S.pilot.ratings = [];
        S.totalHoursFlown = 38; // Almost ready for checkride
        S.tutorialComplete = false;
        
        // Apply scenario settings
        applyScenario();
      }
      
      saveState();
      
      // Reload to properly initialize UI with home base set
      location.reload();
    }
    
    function applyScenario() {
      const scenarioKey = setupState.scenario;
      
      if (scenarioKey === 'custom') {
        // Apply custom settings
        S.cash = setupState.customSettings.cash;
        S.lineOfCredit.limit = setupState.customSettings.locLimit;
        S.lineOfCredit.balance = setupState.customSettings.locBalance;
        S.lineOfCredit.apr = setupState.customSettings.locApr / 100;
        S.ownerCompensation.monthlySalary = setupState.customSettings.ownerSalary;
        // No starting aircraft for custom
        S.fleet = [];
        S.fleetData = {};
      } else {
        const s = STARTING_SCENARIOS[scenarioKey];
        
        // Apply financial settings
        S.cash = s.cash;
        S.lineOfCredit.limit = s.locLimit;
        S.lineOfCredit.balance = s.locBalance;
        S.lineOfCredit.apr = s.locApr;
        S.ownerCompensation.monthlySalary = s.ownerSalary;
        
        if (s.hasAircraft && s.aircraftOptions.length > 0) {
          const selectedAc = s.aircraftOptions[setupState.selectedAircraft];
          const aircraftCode = selectedAc.code;
          
          // Add aircraft to fleet
          S.fleet = [aircraftCode];
          S.fleetData = {};
          
          const aircraft = AIRCRAFT[aircraftCode];
          if (aircraft) {
            // Calculate initial book value based on starting condition
            const initialBookValue = calculateListingPrice(
              aircraftCode, 
              selectedAc.year, 
              selectedAc.condition, 
              selectedAc.hours || 0, 
              aircraft
            );
            
            S.fleetData[aircraftCode] = {
              currentFuel: aircraft.fuel_capacity || 50,
              condition: selectedAc.condition,
              year: selectedAc.year,
              hours: selectedAc.hours || 0,
              location: null,
              bookValue: initialBookValue,
              acquisitionDate: { ...S.gameTime },
              // Track if inherited (can't sell for 1 year)
              inheritedDate: scenarioKey === 'inheritance' ? { ...S.gameTime } : null
            };
            
            // Add to pilot certifications
            S.pilot.aircraftCertifications = [aircraftCode];
          }
          
          // Add loan if leveraged scenario
          if (s.hasLoan && selectedAc.loanAmount) {
            const loanAmount = selectedAc.loanAmount;
            const interestRate = 0.08;
            const termMonths = 120;
            // Standard amortization formula
            const monthlyRate = interestRate / 12;
            const monthlyPayment = Math.round(loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1));
            
            S.loans = [{
              id: uuid(),
              aircraftCode: aircraftCode,
              originalAmount: loanAmount,
              remainingBalance: loanAmount,
              interestRate: interestRate,
              termMonths: termMonths,
              monthlyPayment: monthlyPayment,
              paymentsRemaining: termMonths,
              missedPayments: 0,
              startDate: { ...S.gameTime }
            }];
          }
        } else {
          // No starting aircraft (Bootstrap scenario)
          S.fleet = [];
          S.fleetData = {};
          // Even without an aircraft, pilots are trained on something - give C172 cert for contract work
          S.pilot.aircraftCertifications = ['C172_SKYHAWK'];
        }
        
        // Apply scenario-specific pilot attributes
        if (s.startingHours) {
          S.totalHoursFlown = s.startingHours;
        }
        if (s.startingRatings) {
          S.pilot.ratings = [...s.startingRatings];
        }
        if (s.startingCertifications) {
          S.pilot.certificates = [...s.startingCertifications];
        }
      }
      
      // Record initial transaction and set starting capital
      if (S.cash > 0) {
        S.financials.startingCapital = S.cash;
        recordTransaction('Starting Capital', S.cash, 'capital');
      }
    }

    async function initialize() {
      try {
        // Try to load airports from cache (aircraft is now embedded)
        const cachedAirports = await loadFromIndexedDB('airports');
        
        if (cachedAirports) {
          // Cache hit - load airports from IndexedDB
          document.getElementById('loadingText').textContent = 'Loading from cache...';
          AIRPORTS = cachedAirports;
          normalizeAllAirports();
          
          const aircraftCount = Object.keys(AIRCRAFT).length;
          const airportCount = Object.keys(AIRPORTS).length;
          document.getElementById('loadingText').textContent = 
            `Loaded ${airportCount} airports (${aircraftCount} aircraft embedded)`;
          
          await new Promise(resolve => setTimeout(resolve, 500));
          try {
            startGame();
          } catch (gameError) {
            console.error('Error starting game:', gameError);
            document.getElementById('loadingText').innerHTML = `
              <div style="color: var(--danger); max-width: 400px;">
                <h3 style="margin-bottom: 12px;">Startup Error</h3>
                <p>${gameError.message}</p>
                <button class="btn" onclick="resetGame()" style="margin-top: 16px;">Reset Game</button>
              </div>
            `;
          }
        } else {
          // Cache miss - show file picker (only needs airports now)
          showFilePicker();
        }
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loadingText').innerHTML = `
          <div style="color: var(--danger); max-width: 400px;">
            <h3 style="margin-bottom: 12px;">Error</h3>
            <p>${error.message}</p>
            <button class="btn" onclick="location.reload()" style="margin-top: 16px;">Retry</button>
          </div>
        `;
      }
    }

    // Add cache management option
    window.clearCache = async function() {
      if (confirm('Clear database cache? You will need to reload the files next time.')) {
        await clearDatabaseCache();
        alert('Cache cleared. Reload the page to start fresh.');
      }
    };

    // Start the application
    initialize();
  </script>
</body>
</html>
